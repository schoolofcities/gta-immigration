import{b as dp,e as zm,t as ii,a as Ft,n as Ip,c as ns}from"../chunks/Cf1Ji9YY.js";import"../chunks/l3BAmYos.js";import{h as Dm,i as pp,j as fp,n as Rm,o as mp,x as Lm,ak as Fm,ai as Bm,s as Om,y as jm,A as Vm,aq as Ep,F as ls,ap as Ai,L as vt,B as ia,I as cs,Q as Pt,g as te,K as Ne,G as wi,J as Xe,f as Pr,a as os,C as dr,$ as Nm,_ as _o}from"../chunks/BcaDT9qf.js";import{l as Zm,s as vi,d as ah,e as Ap}from"../chunks/BDG1Vv6z.js";import{S as gp,q as Um,i as kp,P as fn,e as na,c as ka,s as Tn,t as sh,u as Aa,C as Vi,F as zp,v as ra,a as Dp,d as Rn,T as $m}from"../chunks/CEKe5COV.js";import{h as Gm}from"../chunks/D6zB2vfb.js";import{i as qm}from"../chunks/B_a6ThXA.js";import{i as Hm,a as Jt,p as th}from"../chunks/D6Lsk_Gr.js";import{o as Cu}from"../chunks/GI9JK1j2.js";import{j as Wm,c as oh,S as Xm,l as rh,m as _p,d as yp,f as Rp}from"../chunks/DAIIW3Ny.js";import{i as an}from"../chunks/EyUDMLWb.js";/* empty css                */function Km(H,ae,oe,he,Ee){var Ae=H,I="",c;Dm(()=>{if(I===(I=ae()??"")){pp&&fp();return}c!==void 0&&(Vm(c),c=void 0),I!==""&&(c=Rm(()=>{if(pp){mp.data;for(var ke=fp(),He=ke;ke!==null&&(ke.nodeType!==8||ke.data!=="");)He=ke,ke=Lm(ke);if(ke===null)throw Fm(),Bm;dp(mp,He),Ae=Om(ke);return}var je=I+"",Qe=zm(je);dp(jm(Qe),Qe.lastChild),Ae.before(Qe)}))})}function Lp(H,ae,oe){if(H.multiple)return Jm(H,ae);for(var he of H.options){var Ee=Zl(he);if(Hm(Ee,ae)){he.selected=!0;return}}(!oe||ae!==void 0)&&(H.selectedIndex=-1)}function Ym(H,ae){Ep(()=>{var oe=new MutationObserver(()=>{var he=H.__value;Lp(H,he)});return oe.observe(H,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{oe.disconnect()}})}function ss(H,ae,oe=ae){var he=!0;Zm(H,"change",Ee=>{var Ae=Ee?"[selected]":":checked",I;if(H.multiple)I=[].map.call(H.querySelectorAll(Ae),Zl);else{var c=H.querySelector(Ae)??H.querySelector("option:not([disabled])");I=c&&Zl(c)}oe(I)}),Ep(()=>{var Ee=ae();if(Lp(H,Ee,he),he&&Ee===void 0){var Ae=H.querySelector(":checked");Ae!==null&&(Ee=Zl(Ae),oe(Ee))}H.__value=Ee,he=!1}),Ym(H)}function Jm(H,ae){for(var oe of H.options)oe.selected=~ae.indexOf(Zl(oe))}function Zl(H){return"__value"in H?H.__value:H.value}function Fp(H){return function(...ae){var oe=ae[0];return oe.preventDefault(),H==null?void 0:H.apply(this,ae)}}const Qm=!0,R_=Object.freeze(Object.defineProperty({__proto__:null,prerender:Qm},Symbol.toStringTag,{value:"Module"}));class vp extends Map{constructor(ae,oe=ig){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:oe}}),ae!=null)for(const[he,Ee]of ae)this.set(he,Ee)}get(ae){return super.get(xp(this,ae))}has(ae){return super.has(xp(this,ae))}set(ae,oe){return super.set(eg(this,ae),oe)}delete(ae){return super.delete(tg(this,ae))}}function xp({_intern:H,_key:ae},oe){const he=ae(oe);return H.has(he)?H.get(he):oe}function eg({_intern:H,_key:ae},oe){const he=ae(oe);return H.has(he)?H.get(he):(H.set(he,oe),oe)}function tg({_intern:H,_key:ae},oe){const he=ae(oe);return H.has(he)&&(oe=H.get(he),H.delete(he)),oe}function ig(H){return H!==null&&typeof H=="object"?H.valueOf():H}function Bp(H,ae,oe){H=+H,ae=+ae,oe=(Ee=arguments.length)<2?(ae=H,H=0,1):Ee<3?1:+oe;for(var he=-1,Ee=Math.max(0,Math.ceil((ae-H)/oe))|0,Ae=new Array(Ee);++he<Ee;)Ae[he]=H+he*oe;return Ae}function rg(H){return H}var bu=1,wu=2,Pu=3,Nl=4,bp=1e-6;function ng(H){return"translate("+H+",0)"}function ag(H){return"translate(0,"+H+")"}function sg(H){return ae=>+H(ae)}function og(H,ae){return ae=Math.max(0,H.bandwidth()-ae*2)/2,H.round()&&(ae=Math.round(ae)),oe=>+H(oe)+ae}function lg(){return!this.__axis}function Op(H,ae){var oe=[],he=null,Ee=null,Ae=6,I=6,c=3,ke=typeof window<"u"&&window.devicePixelRatio>1?0:.5,He=H===bu||H===Nl?-1:1,je=H===Nl||H===wu?"x":"y",Qe=H===bu||H===Pu?ng:ag;function Pe(Y){var Be=he??(ae.ticks?ae.ticks.apply(ae,oe):ae.domain()),st=Ee??(ae.tickFormat?ae.tickFormat.apply(ae,oe):rg),et=Math.max(Ae,0)+c,$e=ae.range(),pt=+$e[0]+ke,jt=+$e[$e.length-1]+ke,Ze=(ae.bandwidth?og:sg)(ae.copy(),ke),wt=Y.selection?Y.selection():Y,tt=wt.selectAll(".domain").data([null]),Ue=wt.selectAll(".tick").data(Be,ae).order(),xt=Ue.exit(),Dt=Ue.enter().append("g").attr("class","tick"),Bt=Ue.select("line"),Rt=Ue.select("text");tt=tt.merge(tt.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),Ue=Ue.merge(Dt),Bt=Bt.merge(Dt.append("line").attr("stroke","currentColor").attr(je+"2",He*Ae)),Rt=Rt.merge(Dt.append("text").attr("fill","currentColor").attr(je,He*et).attr("dy",H===bu?"0em":H===Pu?"0.71em":"0.32em")),Y!==wt&&(tt=tt.transition(Y),Ue=Ue.transition(Y),Bt=Bt.transition(Y),Rt=Rt.transition(Y),xt=xt.transition(Y).attr("opacity",bp).attr("transform",function(bt){return isFinite(bt=Ze(bt))?Qe(bt+ke):this.getAttribute("transform")}),Dt.attr("opacity",bp).attr("transform",function(bt){var kt=this.parentNode.__axis;return Qe((kt&&isFinite(kt=kt(bt))?kt:Ze(bt))+ke)})),xt.remove(),tt.attr("d",H===Nl||H===wu?I?"M"+He*I+","+pt+"H"+ke+"V"+jt+"H"+He*I:"M"+ke+","+pt+"V"+jt:I?"M"+pt+","+He*I+"V"+ke+"H"+jt+"V"+He*I:"M"+pt+","+ke+"H"+jt),Ue.attr("opacity",1).attr("transform",function(bt){return Qe(Ze(bt)+ke)}),Bt.attr(je+"2",He*Ae),Rt.attr(je,He*et).text(st),wt.filter(lg).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",H===wu?"start":H===Nl?"end":"middle"),wt.each(function(){this.__axis=Ze})}return Pe.scale=function(Y){return arguments.length?(ae=Y,Pe):ae},Pe.ticks=function(){return oe=Array.from(arguments),Pe},Pe.tickArguments=function(Y){return arguments.length?(oe=Y==null?[]:Array.from(Y),Pe):oe.slice()},Pe.tickValues=function(Y){return arguments.length?(he=Y==null?null:Array.from(Y),Pe):he&&he.slice()},Pe.tickFormat=function(Y){return arguments.length?(Ee=Y,Pe):Ee},Pe.tickSize=function(Y){return arguments.length?(Ae=I=+Y,Pe):Ae},Pe.tickSizeInner=function(Y){return arguments.length?(Ae=+Y,Pe):Ae},Pe.tickSizeOuter=function(Y){return arguments.length?(I=+Y,Pe):I},Pe.tickPadding=function(Y){return arguments.length?(c=+Y,Pe):c},Pe.offset=function(Y){return arguments.length?(ke=+Y,Pe):ke},Pe}function Iu(H){return Op(Pu,H)}function Eu(H){return Op(Nl,H)}function pn(H){return typeof H=="string"?new gp([[document.querySelector(H)]],[document.documentElement]):new gp([[H]],Um)}const Mu=Math.PI,Su=2*Mu,as=1e-6,cg=Su-as;function jp(H){this._+=H[0];for(let ae=1,oe=H.length;ae<oe;++ae)this._+=arguments[ae]+H[ae]}function hg(H){let ae=Math.floor(H);if(!(ae>=0))throw new Error(`invalid digits: ${H}`);if(ae>15)return jp;const oe=10**ae;return function(he){this._+=he[0];for(let Ee=1,Ae=he.length;Ee<Ae;++Ee)this._+=Math.round(arguments[Ee]*oe)/oe+he[Ee]}}class ug{constructor(ae){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=ae==null?jp:hg(ae)}moveTo(ae,oe){this._append`M${this._x0=this._x1=+ae},${this._y0=this._y1=+oe}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(ae,oe){this._append`L${this._x1=+ae},${this._y1=+oe}`}quadraticCurveTo(ae,oe,he,Ee){this._append`Q${+ae},${+oe},${this._x1=+he},${this._y1=+Ee}`}bezierCurveTo(ae,oe,he,Ee,Ae,I){this._append`C${+ae},${+oe},${+he},${+Ee},${this._x1=+Ae},${this._y1=+I}`}arcTo(ae,oe,he,Ee,Ae){if(ae=+ae,oe=+oe,he=+he,Ee=+Ee,Ae=+Ae,Ae<0)throw new Error(`negative radius: ${Ae}`);let I=this._x1,c=this._y1,ke=he-ae,He=Ee-oe,je=I-ae,Qe=c-oe,Pe=je*je+Qe*Qe;if(this._x1===null)this._append`M${this._x1=ae},${this._y1=oe}`;else if(Pe>as)if(!(Math.abs(Qe*ke-He*je)>as)||!Ae)this._append`L${this._x1=ae},${this._y1=oe}`;else{let Y=he-I,Be=Ee-c,st=ke*ke+He*He,et=Y*Y+Be*Be,$e=Math.sqrt(st),pt=Math.sqrt(Pe),jt=Ae*Math.tan((Mu-Math.acos((st+Pe-et)/(2*$e*pt)))/2),Ze=jt/pt,wt=jt/$e;Math.abs(Ze-1)>as&&this._append`L${ae+Ze*je},${oe+Ze*Qe}`,this._append`A${Ae},${Ae},0,0,${+(Qe*Y>je*Be)},${this._x1=ae+wt*ke},${this._y1=oe+wt*He}`}}arc(ae,oe,he,Ee,Ae,I){if(ae=+ae,oe=+oe,he=+he,I=!!I,he<0)throw new Error(`negative radius: ${he}`);let c=he*Math.cos(Ee),ke=he*Math.sin(Ee),He=ae+c,je=oe+ke,Qe=1^I,Pe=I?Ee-Ae:Ae-Ee;this._x1===null?this._append`M${He},${je}`:(Math.abs(this._x1-He)>as||Math.abs(this._y1-je)>as)&&this._append`L${He},${je}`,he&&(Pe<0&&(Pe=Pe%Su+Su),Pe>cg?this._append`A${he},${he},0,1,${Qe},${ae-c},${oe-ke}A${he},${he},0,1,${Qe},${this._x1=He},${this._y1=je}`:Pe>as&&this._append`A${he},${he},0,${+(Pe>=Mu)},${Qe},${this._x1=ae+he*Math.cos(Ae)},${this._y1=oe+he*Math.sin(Ae)}`)}rect(ae,oe,he,Ee){this._append`M${this._x0=this._x1=+ae},${this._y0=this._y1=+oe}h${he=+he}v${+Ee}h${-he}Z`}toString(){return this._}}const wp=Symbol("implicit");function Vp(){var H=new vp,ae=[],oe=[],he=wp;function Ee(Ae){let I=H.get(Ae);if(I===void 0){if(he!==wp)return he;H.set(Ae,I=ae.push(Ae)-1)}return oe[I%oe.length]}return Ee.domain=function(Ae){if(!arguments.length)return ae.slice();ae=[],H=new vp;for(const I of Ae)H.has(I)||H.set(I,ae.push(I)-1);return Ee},Ee.range=function(Ae){return arguments.length?(oe=Array.from(Ae),Ee):oe.slice()},Ee.unknown=function(Ae){return arguments.length?(he=Ae,Ee):he},Ee.copy=function(){return Vp(ae,oe).unknown(he)},kp.apply(Ee,arguments),Ee}function Np(){var H=Vp().unknown(void 0),ae=H.domain,oe=H.range,he=0,Ee=1,Ae,I,c=!1,ke=0,He=0,je=.5;delete H.unknown;function Qe(){var Pe=ae().length,Y=Ee<he,Be=Y?Ee:he,st=Y?he:Ee;Ae=(st-Be)/Math.max(1,Pe-ke+He*2),c&&(Ae=Math.floor(Ae)),Be+=(st-Be-Ae*(Pe-ke))*je,I=Ae*(1-ke),c&&(Be=Math.round(Be),I=Math.round(I));var et=Bp(Pe).map(function($e){return Be+Ae*$e});return oe(Y?et.reverse():et)}return H.domain=function(Pe){return arguments.length?(ae(Pe),Qe()):ae()},H.range=function(Pe){return arguments.length?([he,Ee]=Pe,he=+he,Ee=+Ee,Qe()):[he,Ee]},H.rangeRound=function(Pe){return[he,Ee]=Pe,he=+he,Ee=+Ee,c=!0,Qe()},H.bandwidth=function(){return I},H.step=function(){return Ae},H.round=function(Pe){return arguments.length?(c=!!Pe,Qe()):c},H.padding=function(Pe){return arguments.length?(ke=Math.min(1,He=+Pe),Qe()):ke},H.paddingInner=function(Pe){return arguments.length?(ke=Math.min(1,Pe),Qe()):ke},H.paddingOuter=function(Pe){return arguments.length?(He=+Pe,Qe()):He},H.align=function(Pe){return arguments.length?(je=Math.max(0,Math.min(1,Pe)),Qe()):je},H.copy=function(){return Np(ae(),[he,Ee]).round(c).paddingInner(ke).paddingOuter(He).align(je)},kp.apply(Qe(),arguments)}function Zp(H){var ae=H.copy;return H.padding=H.paddingOuter,delete H.paddingInner,delete H.paddingOuter,H.copy=function(){return Zp(ae())},H}function Up(){return Zp(Np.apply(null,arguments).paddingInner(1))}function yo(H){return function(){return H}}function dg(H){let ae=3;return H.digits=function(oe){if(!arguments.length)return ae;if(oe==null)ae=null;else{const he=Math.floor(oe);if(!(he>=0))throw new RangeError(`invalid digits: ${oe}`);ae=he}return H},()=>new ug(ae)}function pg(H){return typeof H=="object"&&"length"in H?H:Array.from(H)}function $p(H){this._context=H}$p.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(H,ae){switch(H=+H,ae=+ae,this._point){case 0:this._point=1,this._line?this._context.lineTo(H,ae):this._context.moveTo(H,ae);break;case 1:this._point=2;default:this._context.lineTo(H,ae);break}}};function fg(H){return new $p(H)}function mg(H){return H[0]}function gg(H){return H[1]}function Au(H,ae){var oe=yo(!0),he=null,Ee=fg,Ae=null,I=dg(c);H=typeof H=="function"?H:H===void 0?mg:yo(H),ae=typeof ae=="function"?ae:ae===void 0?gg:yo(ae);function c(ke){var He,je=(ke=pg(ke)).length,Qe,Pe=!1,Y;for(he==null&&(Ae=Ee(Y=I())),He=0;He<=je;++He)!(He<je&&oe(Qe=ke[He],He,ke))===Pe&&((Pe=!Pe)?Ae.lineStart():Ae.lineEnd()),Pe&&Ae.point(+H(Qe,He,ke),+ae(Qe,He,ke));if(Y)return Ae=null,Y+""||null}return c.x=function(ke){return arguments.length?(H=typeof ke=="function"?ke:yo(+ke),c):H},c.y=function(ke){return arguments.length?(ae=typeof ke=="function"?ke:yo(+ke),c):ae},c.defined=function(ke){return arguments.length?(oe=typeof ke=="function"?ke:yo(!!ke),c):oe},c.curve=function(ke){return arguments.length?(Ee=ke,he!=null&&(Ae=Ee(he)),c):Ee},c.context=function(ke){return arguments.length?(ke==null?he=Ae=null:Ae=Ee(he=ke),c):he},c}function Tp(H){return H<0?-1:1}function Pp(H,ae,oe){var he=H._x1-H._x0,Ee=ae-H._x1,Ae=(H._y1-H._y0)/(he||Ee<0&&-0),I=(oe-H._y1)/(Ee||he<0&&-0),c=(Ae*Ee+I*he)/(he+Ee);return(Tp(Ae)+Tp(I))*Math.min(Math.abs(Ae),Math.abs(I),.5*Math.abs(c))||0}function Mp(H,ae){var oe=H._x1-H._x0;return oe?(3*(H._y1-H._y0)/oe-ae)/2:ae}function Tu(H,ae,oe){var he=H._x0,Ee=H._y0,Ae=H._x1,I=H._y1,c=(Ae-he)/3;H._context.bezierCurveTo(he+c,Ee+c*ae,Ae-c,I-c*oe,Ae,I)}function nh(H){this._context=H}nh.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:Tu(this,this._t0,Mp(this,this._t0));break}(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(H,ae){var oe=NaN;if(H=+H,ae=+ae,!(H===this._x1&&ae===this._y1)){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(H,ae):this._context.moveTo(H,ae);break;case 1:this._point=2;break;case 2:this._point=3,Tu(this,Mp(this,oe=Pp(this,H,ae)),oe);break;default:Tu(this,this._t0,oe=Pp(this,H,ae));break}this._x0=this._x1,this._x1=H,this._y0=this._y1,this._y1=ae,this._t0=oe}}};Object.create(nh.prototype).point=function(H,ae){nh.prototype.point.call(this,ae,H)};function Gp(H){return new nh(H)}var _g=ii('<div class="plots-title svelte-1el3qlx"><h4>Ridings with more immigrants are increasingly voting Conservative</h4> <p class="svelte-1el3qlx">Correlation between immigrants (as % of population) and voting Conservative in Ontario provincial elections</p></div> <div class="plots-container svelte-1el3qlx"></div>',1);function yg(H,ae){ls(ae,!0);const oe=[{year:1985,region:"ontario"},{year:1987,region:"ontario"},{year:1990,region:"ontario"},{year:1995,region:"ontario"},{year:1999,region:"ontario"},{year:2003,region:"ontario"},{year:2007,region:"ontario"},{year:2011,region:"ontario"},{year:2014,region:"ontario"},{year:2018,region:"ontario"},{year:2022,region:"ontario"},{year:2025,region:"ontario"}],he="cons1",Ee=fn.find(He=>He.tag===he).propertyTag;let Ae=Ai(Jt([]));Cu(()=>{I()});function I(){const He=oe.map(je=>Promise.all([Wm(`/gta-immigration/data/elections/ont-ed_stats_${je.year}.geojson`),oh("/gta-immigration/data/elections_analysis/ed_corrs.csv")]).then(([Qe,Pe])=>{const Y=Pe.find(st=>st.year===je.year.toString()&&st.region===je.region),Be=Qe.features.map(st=>({x:st.properties.pct_imm,y:st.properties[Ee],geoname:st.properties.geoname}));return{year:je.year,points:Be,correlation:Y?parseFloat(Y[`corr_pct_imm_${he}`]):0}}));Promise.all(He).then(je=>{Pt(Ae,Jt(je.sort((Qe,Pe)=>Qe.year-Pe.year)))}).catch(je=>{console.error("Error loading data:",je)})}var c=_g(),ke=vt(ia(c),2);na(ke,21,()=>te(Ae),ka,(He,je)=>{Xm(He,{get points(){return te(je).points},get correlation(){return te(je).correlation},get year(){return te(je).year},xEnd:70,height:100,plotWidth:100,colorStart:-1.5,colorEnd:.35})}),Ne(ke),Ft(H,c),cs()}function vg(H){return H&&H.__esModule&&Object.prototype.hasOwnProperty.call(H,"default")?H.default:H}var ih={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.2.0/LICENSE.txt
 */var xg=ih.exports,Sp;function bg(){return Sp||(Sp=1,function(H,ae){(function(oe,he){H.exports=he()})(xg,function(){var oe={},he={};function Ee(I,c,ke){if(he[I]=ke,I==="index"){var He="var sharedModule = {}; ("+he.shared+")(sharedModule); ("+he.worker+")(sharedModule);",je={};return he.shared(je),he.index(oe,je),typeof window<"u"&&oe.setWorkerUrl(window.URL.createObjectURL(new Blob([He],{type:"text/javascript"}))),oe}}Ee("shared",["exports"],function(I){function c(r,t,n,a){return new(n||(n=Promise))(function(l,d){function p(v){try{_(a.next(v))}catch(b){d(b)}}function m(v){try{_(a.throw(v))}catch(b){d(b)}}function _(v){var b;v.done?l(v.value):(b=v.value,b instanceof n?b:new n(function(w){w(b)})).then(p,m)}_((a=a.apply(r,t||[])).next())})}function ke(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var He,je;function Qe(){if(je)return He;function r(t,n){this.x=t,this.y=n}return je=1,He=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,n){return this.clone()._rotateAround(t,n)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var n=t.x-this.x,a=t.y-this.y;return n*n+a*a},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,n){return Math.atan2(this.x*n-this.y*t,this.x*t+this.y*n)},_matMult:function(t){var n=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=n,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var n=Math.cos(t),a=Math.sin(t),l=a*this.x+n*this.y;return this.x=n*this.x-a*this.y,this.y=l,this},_rotateAround:function(t,n){var a=Math.cos(t),l=Math.sin(t),d=n.y+l*(this.x-n.x)+a*(this.y-n.y);return this.x=n.x+a*(this.x-n.x)-l*(this.y-n.y),this.y=d,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(t){return t instanceof r?t:Array.isArray(t)?new r(t[0],t[1]):t},He}typeof SuppressedError=="function"&&SuppressedError;var Pe,Y,Be=ke(Qe()),st=function(){if(Y)return Pe;function r(t,n,a,l){this.cx=3*t,this.bx=3*(a-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(l-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=a,this.p2y=l}return Y=1,Pe=r,r.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,n){if(n===void 0&&(n=1e-6),t<0)return 0;if(t>1)return 1;for(var a=t,l=0;l<8;l++){var d=this.sampleCurveX(a)-t;if(Math.abs(d)<n)return a;var p=this.sampleCurveDerivativeX(a);if(Math.abs(p)<1e-6)break;a-=d/p}var m=0,_=1;for(a=t,l=0;l<20&&(d=this.sampleCurveX(a),!(Math.abs(d-t)<n));l++)t>d?m=a:_=a,a=.5*(_-m)+m;return a},solve:function(t,n){return this.sampleCurveY(this.solveCurveX(t,n))}},Pe}(),et=ke(st);let $e,pt;function jt(){return $e==null&&($e=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),$e}function Ze(){if(pt==null&&(pt=!1,jt())){const t=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(t){for(let a=0;a<5*5;a++){const l=4*a;t.fillStyle=`rgb(${l},${l+1},${l+2})`,t.fillRect(a%5,Math.floor(a/5),1,1)}const n=t.getImageData(0,0,5,5).data;for(let a=0;a<5*5*4;a++)if(a%4!=3&&n[a]!==a){pt=!0;break}}}return pt||!1}var wt,tt=1e-6,Ue=typeof Float32Array<"u"?Float32Array:Array;function xt(){var r=new Ue(9);return Ue!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function Dt(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Bt(){var r=new Ue(3);return Ue!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Rt(r,t,n){var a=new Ue(3);return a[0]=r,a[1]=t,a[2]=n,a}function bt(r,t,n){var a=t[0],l=t[1],d=t[2],p=t[3];return r[0]=n[0]*a+n[4]*l+n[8]*d+n[12]*p,r[1]=n[1]*a+n[5]*l+n[9]*d+n[13]*p,r[2]=n[2]*a+n[6]*l+n[10]*d+n[14]*p,r[3]=n[3]*a+n[7]*l+n[11]*d+n[15]*p,r}function kt(){var r=new Ue(4);return Ue!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function gt(){var r=new Ue(2);return Ue!=Float32Array&&(r[0]=0,r[1]=0),r}function Vt(r,t){var n=new Ue(2);return n[0]=r,n[1]=t,n}Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)}),Bt(),wt=new Ue(4),Ue!=Float32Array&&(wt[0]=0,wt[1]=0,wt[2]=0,wt[3]=0),Bt(),Rt(1,0,0),Rt(0,1,0),kt(),kt(),xt(),gt();const Mt=8192;function ai(r,t,n){return t*(Mt/(r.tileSize*Math.pow(2,n-r.tileID.overscaledZ)))}function Li(r,t){return(r%t+t)%t}function Tt(r,t,n){return r*(1-n)+t*n}function Qt(r){if(r<=0)return 0;if(r>=1)return 1;const t=r*r,n=t*r;return 4*(r<.5?n:3*(r-t)+n-.75)}function Ti(r,t,n,a){const l=new et(r,t,n,a);return d=>l.solve(d)}const ei=Ti(.25,.1,.25,1);function Kt(r,t,n){return Math.min(n,Math.max(t,r))}function Wt(r,t,n){const a=n-t,l=((r-t)%a+a)%a+t;return l===t?n:l}function Ge(r,...t){for(const n of t)for(const a in n)r[a]=n[a];return r}let lt=1;function St(r,t,n){const a={};for(const l in r)a[l]=t.call(this,r[l],l,r);return a}function Zt(r,t,n){const a={};for(const l in r)t.call(this,r[l],l,r)&&(a[l]=r[l]);return a}function ti(r){return Array.isArray(r)?r.map(ti):typeof r=="object"&&r?St(r,ti):r}const _r={};function xi(r){_r[r]||(typeof console<"u"&&console.warn(r),_r[r]=!0)}function li(r,t,n){return(n.y-r.y)*(t.x-r.x)>(t.y-r.y)*(n.x-r.x)}function Fi(r){return typeof WorkerGlobalScope<"u"&&r!==void 0&&r instanceof WorkerGlobalScope}let ci=null;function Mr(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap}const qr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function ir(r,t,n,a,l){return c(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const d=new VideoFrame(r,{timestamp:0});try{const p=d==null?void 0:d.format;if(!p||!p.startsWith("BGR")&&!p.startsWith("RGB"))throw new Error(`Unrecognized format ${p}`);const m=p.startsWith("BGR"),_=new Uint8ClampedArray(a*l*4);if(yield d.copyTo(_,function(v,b,w,C,A){const k=4*Math.max(1,0),D=(Math.max(0,w)-w)*C*4+k,B=4*C,U=Math.max(0,b),ee=Math.max(0,w);return{rect:{x:U,y:ee,width:Math.min(v.width,b+C)-U,height:Math.min(v.height,w+A)-ee},layout:[{offset:D,stride:B}]}}(r,t,n,a,l)),m)for(let v=0;v<_.length;v+=4){const b=_[v];_[v]=_[v+2],_[v+2]=b}return _}finally{d.close()}})}let Hr,Rr;function pr(r,t,n,a){return r.addEventListener(t,n,a),{unsubscribe:()=>{r.removeEventListener(t,n,a)}}}function fr(r){return r/Math.PI*180}const Wr="AbortError";function Ve(){return new Error(Wr)}const nt={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Oe(r){return nt.REGISTERED_PROTOCOLS[r.substring(0,r.indexOf("://"))]}const ft="global-dispatcher";class Yt extends Error{constructor(t,n,a,l){super(`AJAXError: ${n} (${t}): ${a}`),this.status=t,this.statusText=n,this.url=a,this.body=l}}const zt=()=>Fi(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Ii=function(r,t){if(/:\/\//.test(r.url)&&!/^https?:|^file:/.test(r.url)){const a=Oe(r.url);if(a)return a(r,t);if(Fi(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:r,targetMapId:ft},t)}if(!(/^file:/.test(n=r.url)||/^file:/.test(zt())&&!/^\w+:/.test(n))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(a,l){return c(this,void 0,void 0,function*(){const d=new Request(a.url,{method:a.method||"GET",body:a.body,credentials:a.credentials,headers:a.headers,cache:a.cache,referrer:zt(),signal:l.signal});let p,m;a.type!=="json"||d.headers.has("Accept")||d.headers.set("Accept","application/json");try{p=yield fetch(d)}catch(v){throw new Yt(0,v.message,a.url,new Blob)}if(!p.ok){const v=yield p.blob();throw new Yt(p.status,p.statusText,a.url,v)}m=a.type==="arrayBuffer"||a.type==="image"?p.arrayBuffer():a.type==="json"?p.json():p.text();const _=yield m;if(l.signal.aborted)throw Ve();return{data:_,cacheControl:p.headers.get("Cache-Control"),expires:p.headers.get("Expires")}})}(r,t);if(Fi(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:r,mustQueue:!0,targetMapId:ft},t)}var n;return function(a,l){return new Promise((d,p)=>{var m;const _=new XMLHttpRequest;_.open(a.method||"GET",a.url,!0),a.type!=="arrayBuffer"&&a.type!=="image"||(_.responseType="arraybuffer");for(const v in a.headers)_.setRequestHeader(v,a.headers[v]);a.type==="json"&&(_.responseType="text",!((m=a.headers)===null||m===void 0)&&m.Accept||_.setRequestHeader("Accept","application/json")),_.withCredentials=a.credentials==="include",_.onerror=()=>{p(new Error(_.statusText))},_.onload=()=>{if(!l.signal.aborted)if((_.status>=200&&_.status<300||_.status===0)&&_.response!==null){let v=_.response;if(a.type==="json")try{v=JSON.parse(_.response)}catch(b){return void p(b)}d({data:v,cacheControl:_.getResponseHeader("Cache-Control"),expires:_.getResponseHeader("Expires")})}else{const v=new Blob([_.response],{type:_.getResponseHeader("Content-Type")});p(new Yt(_.status,_.statusText,a.url,v))}},l.signal.addEventListener("abort",()=>{_.abort(),p(Ve())}),_.send(a.body)})}(r,t)};function ki(r){if(!r||r.indexOf("://")<=0||r.indexOf("data:image/")===0||r.indexOf("blob:")===0)return!0;const t=new URL(r),n=window.location;return t.protocol===n.protocol&&t.host===n.host}function Sr(r,t,n){n[r]&&n[r].indexOf(t)!==-1||(n[r]=n[r]||[],n[r].push(t))}function Lr(r,t,n){if(n&&n[r]){const a=n[r].indexOf(t);a!==-1&&n[r].splice(a,1)}}class mn{constructor(t,n={}){Ge(this,n),this.type=t}}class hi extends mn{constructor(t,n={}){super("error",Ge({error:t},n))}}class se{on(t,n){return this._listeners=this._listeners||{},Sr(t,n,this._listeners),{unsubscribe:()=>{this.off(t,n)}}}off(t,n){return Lr(t,n,this._listeners),Lr(t,n,this._oneTimeListeners),this}once(t,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},Sr(t,n,this._oneTimeListeners),this):new Promise(a=>this.once(t,a))}fire(t,n){typeof t=="string"&&(t=new mn(t,n||{}));const a=t.type;if(this.listens(a)){t.target=this;const l=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const m of l)m.call(this,t);const d=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const m of d)Lr(a,m,this._oneTimeListeners),m.call(this,t);const p=this._eventedParent;p&&(Ge(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),p.fire(t))}else t instanceof hi&&console.error(t.error);return this}listens(t){return this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t)}setEventedParent(t,n){return this._eventedParent=t,this._eventedParentData=n,this}}var P={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const L=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function O(r,t){const n={};for(const a in r)a!=="ref"&&(n[a]=r[a]);return L.forEach(a=>{a in t&&(n[a]=t[a])}),n}function Z(r,t){if(Array.isArray(r)){if(!Array.isArray(t)||r.length!==t.length)return!1;for(let n=0;n<r.length;n++)if(!Z(r[n],t[n]))return!1;return!0}if(typeof r=="object"&&r!==null&&t!==null){if(typeof t!="object"||Object.keys(r).length!==Object.keys(t).length)return!1;for(const n in r)if(!Z(r[n],t[n]))return!1;return!0}return r===t}function K(r,t){r.push(t)}function ne(r,t,n){K(n,{command:"addSource",args:[r,t[r]]})}function ue(r,t,n){K(t,{command:"removeSource",args:[r]}),n[r]=!0}function re(r,t,n,a){ue(r,n,a),ne(r,t,n)}function ye(r,t,n){let a;for(a in r[n])if(Object.prototype.hasOwnProperty.call(r[n],a)&&a!=="data"&&!Z(r[n][a],t[n][a]))return!1;for(a in t[n])if(Object.prototype.hasOwnProperty.call(t[n],a)&&a!=="data"&&!Z(r[n][a],t[n][a]))return!1;return!0}function me(r,t,n,a,l,d){r=r||{},t=t||{};for(const p in r)Object.prototype.hasOwnProperty.call(r,p)&&(Z(r[p],t[p])||n.push({command:d,args:[a,p,t[p],l]}));for(const p in t)Object.prototype.hasOwnProperty.call(t,p)&&!Object.prototype.hasOwnProperty.call(r,p)&&(Z(r[p],t[p])||n.push({command:d,args:[a,p,t[p],l]}))}function le(r){return r.id}function Me(r,t){return r[t.id]=t,r}class ce{constructor(t,n,a,l){this.message=(t?`${t}: `:"")+a,l&&(this.identifier=l),n!=null&&n.__line__&&(this.line=n.__line__)}}function Fe(r,...t){for(const n of t)for(const a in n)r[a]=n[a];return r}class Ke extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}class _t{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[a,l]of n)this.bindings[a]=l}concat(t){return new _t(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const ut={kind:"null"},be={kind:"number"},Je={kind:"string"},We={kind:"boolean"},It={kind:"color"},yt={kind:"projectionDefinition"},Et={kind:"object"},ct={kind:"value"},Ln={kind:"collator"},Bi={kind:"formatted"},Ni={kind:"padding"},pi={kind:"resolvedImage"},hs={kind:"variableAnchorOffsetCollection"};function yr(r,t){return{kind:"array",itemType:r,N:t}}function si(r){if(r.kind==="array"){const t=si(r.itemType);return typeof r.N=="number"?`array<${t}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${t}>`}return r.kind}const Ul=[ut,be,Je,We,It,yt,Bi,Et,yr(ct),Ni,pi,hs];function za(r,t){if(t.kind==="error")return null;if(r.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!za(r.itemType,t.itemType))&&(typeof r.N!="number"||r.N===t.N))return null}else{if(r.kind===t.kind)return null;if(r.kind==="value"){for(const n of Ul)if(!za(n,t))return null}}return`Expected ${si(r)} but found ${si(t)} instead.`}function bo(r,t){return t.some(n=>n.kind===r.kind)}function Pn(r,t){return t.some(n=>n==="null"?r===null:n==="array"?Array.isArray(r):n==="object"?r&&!Array.isArray(r)&&typeof r=="object":n===typeof r)}function aa(r,t){return r.kind==="array"&&t.kind==="array"?r.itemType.kind===t.itemType.kind&&typeof r.N=="number":r.kind===t.kind}const wo=.96422,$l=.82521,Gl=4/29,sa=6/29,ql=3*sa*sa,lh=sa*sa*sa,ch=Math.PI/180,hh=180/Math.PI;function To(r){return(r%=360)<0&&(r+=360),r}function oa([r,t,n,a]){let l,d;const p=Mo((.2225045*(r=Po(r))+.7168786*(t=Po(t))+.0606169*(n=Po(n)))/1);r===t&&t===n?l=d=p:(l=Mo((.4360747*r+.3850649*t+.1430804*n)/wo),d=Mo((.0139322*r+.0971045*t+.7141733*n)/$l));const m=116*p-16;return[m<0?0:m,500*(l-p),200*(p-d),a]}function Po(r){return r<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Mo(r){return r>lh?Math.pow(r,1/3):r/ql+Gl}function la([r,t,n,a]){let l=(r+16)/116,d=isNaN(t)?l:l+t/500,p=isNaN(n)?l:l-n/200;return l=1*Co(l),d=wo*Co(d),p=$l*Co(p),[So(3.1338561*d-1.6168667*l-.4906146*p),So(-.9787684*d+1.9161415*l+.033454*p),So(.0719453*d-.2289914*l+1.4052427*p),a]}function So(r){return(r=r<=.00304?12.92*r:1.055*Math.pow(r,1/2.4)-.055)<0?0:r>1?1:r}function Co(r){return r>sa?r*r*r:ql*(r-Gl)}function us(r){return parseInt(r.padEnd(2,r),16)/255}function Io(r,t){return Fn(t?r/100:r,0,1)}function Fn(r,t,n){return Math.min(Math.max(t,r),n)}function Xr(r){return!r.some(Number.isNaN)}const Ut={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function Cr(r,t,n){return r+n*(t-r)}function Fr(r,t,n){return r.map((a,l)=>Cr(a,t[l],n))}class $t{constructor(t,n,a,l=1,d=!0){this.r=t,this.g=n,this.b=a,this.a=l,d||(this.r*=l,this.g*=l,this.b*=l,l||this.overwriteGetter("rgb",[t,n,a,l]))}static parse(t){if(t instanceof $t)return t;if(typeof t!="string")return;const n=function(a){if((a=a.toLowerCase().trim())==="transparent")return[0,0,0,0];const l=Ut[a];if(l){const[p,m,_]=l;return[p/255,m/255,_/255,1]}if(a.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(a)){const p=a.length<6?1:2;let m=1;return[us(a.slice(m,m+=p)),us(a.slice(m,m+=p)),us(a.slice(m,m+=p)),us(a.slice(m,m+p)||"ff")]}if(a.startsWith("rgb")){const p=a.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(p){const[m,_,v,b,w,C,A,k,D,B,U,ee]=p,G=[b||" ",A||" ",B].join("");if(G==="  "||G==="  /"||G===",,"||G===",,,"){const E=[v,C,D].join(""),F=E==="%%%"?100:E===""?255:0;if(F){const q=[Fn(+_/F,0,1),Fn(+w/F,0,1),Fn(+k/F,0,1),U?Io(+U,ee):1];if(Xr(q))return q}}return}}const d=a.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(d){const[p,m,_,v,b,w,C,A,k]=d,D=[_||" ",b||" ",C].join("");if(D==="  "||D==="  /"||D===",,"||D===",,,"){const B=[+m,Fn(+v,0,100),Fn(+w,0,100),A?Io(+A,k):1];if(Xr(B))return function([U,ee,G,E]){function F(q){const pe=(q+U/30)%12,Se=ee*Math.min(G,1-G);return G-Se*Math.max(-1,Math.min(pe-3,9-pe,1))}return U=To(U),ee/=100,G/=100,[F(0),F(8),F(4),E]}(B)}}}(t);return n?new $t(...n,!1):void 0}get rgb(){const{r:t,g:n,b:a,a:l}=this,d=l||1/0;return this.overwriteGetter("rgb",[t/d,n/d,a/d,l])}get hcl(){return this.overwriteGetter("hcl",function(t){const[n,a,l,d]=oa(t),p=Math.sqrt(a*a+l*l);return[Math.round(1e4*p)?To(Math.atan2(l,a)*hh):NaN,p,n,d]}(this.rgb))}get lab(){return this.overwriteGetter("lab",oa(this.rgb))}overwriteGetter(t,n){return Object.defineProperty(this,t,{value:n}),n}toString(){const[t,n,a,l]=this.rgb;return`rgba(${[t,n,a].map(d=>Math.round(255*d)).join(",")},${l})`}static interpolate(t,n,a,l="rgb"){switch(l){case"rgb":{const[d,p,m,_]=Fr(t.rgb,n.rgb,a);return new $t(d,p,m,_,!1)}case"hcl":{const[d,p,m,_]=t.hcl,[v,b,w,C]=n.hcl;let A,k;if(isNaN(d)||isNaN(v))isNaN(d)?isNaN(v)?A=NaN:(A=v,m!==1&&m!==0||(k=b)):(A=d,w!==1&&w!==0||(k=p));else{let G=v-d;v>d&&G>180?G-=360:v<d&&d-v>180&&(G+=360),A=d+a*G}const[D,B,U,ee]=function([G,E,F,q]){return G=isNaN(G)?0:G*ch,la([F,Math.cos(G)*E,Math.sin(G)*E,q])}([A,k??Cr(p,b,a),Cr(m,w,a),Cr(_,C,a)]);return new $t(D,B,U,ee,!1)}case"lab":{const[d,p,m,_]=la(Fr(t.lab,n.lab,a));return new $t(d,p,m,_,!1)}}}}$t.black=new $t(0,0,0,1),$t.white=new $t(1,1,1,1),$t.transparent=new $t(0,0,0,0),$t.red=new $t(1,0,0,1);class ds{constructor(t,n,a){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=a,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Eo=["bottom","center","top"];class Br{constructor(t,n,a,l,d,p){this.text=t,this.image=n,this.scale=a,this.fontStack=l,this.textColor=d,this.verticalAlign=p}}class rr{constructor(t){this.sections=t}static fromString(t){return new rr([new Br(t,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof rr?t:rr.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}}class Wi{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof Wi)return t;if(typeof t=="number")return new Wi([t,t,t,t]);if(Array.isArray(t)&&!(t.length<1||t.length>4)){for(const n of t)if(typeof n!="number")return;switch(t.length){case 1:t=[t[0],t[0],t[0],t[0]];break;case 2:t=[t[0],t[1],t[0],t[1]];break;case 3:t=[t[0],t[1],t[2],t[1]]}return new Wi(t)}}toString(){return JSON.stringify(this.values)}static interpolate(t,n,a){return new Wi(Fr(t.values,n.values,a))}}class Pi{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const Ao=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Xi{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof Xi)return t;if(Array.isArray(t)&&!(t.length<1)&&t.length%2==0){for(let n=0;n<t.length;n+=2){const a=t[n],l=t[n+1];if(typeof a!="string"||!Ao.has(a)||!Array.isArray(l)||l.length!==2||typeof l[0]!="number"||typeof l[1]!="number")return}return new Xi(t)}}toString(){return JSON.stringify(this.values)}static interpolate(t,n,a){const l=t.values,d=n.values;if(l.length!==d.length)throw new Pi(`Cannot interpolate values of different length. from: ${t.toString()}, to: ${n.toString()}`);const p=[];for(let m=0;m<l.length;m+=2){if(l[m]!==d[m])throw new Pi(`Cannot interpolate values containing mismatched anchors. from[${m}]: ${l[m]}, to[${m}]: ${d[m]}`);p.push(l[m]);const[_,v]=l[m+1],[b,w]=d[m+1];p.push([Cr(_,b,a),Cr(v,w,a)])}return new Xi(p)}}class mr{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new mr({name:t,available:!1}):null}}class vr{constructor(t,n,a){this.from=t,this.to=n,this.transition=a}static interpolate(t,n,a){return new vr(t,n,a)}static parse(t){return t instanceof vr?t:Array.isArray(t)&&t.length===3&&typeof t[0]=="string"&&typeof t[1]=="string"&&typeof t[2]=="number"?new vr(t[0],t[1],t[2]):typeof t=="object"&&typeof t.from=="string"&&typeof t.to=="string"&&typeof t.transition=="number"?new vr(t.from,t.to,t.transition):typeof t=="string"?new vr(t,t,1):void 0}}function ps(r,t,n,a){return typeof r=="number"&&r>=0&&r<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof n=="number"&&n>=0&&n<=255?a===void 0||typeof a=="number"&&a>=0&&a<=1?null:`Invalid rgba value [${[r,t,n,a].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof a=="number"?[r,t,n,a]:[r,t,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Kr(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof vr||r instanceof $t||r instanceof ds||r instanceof rr||r instanceof Wi||r instanceof Xi||r instanceof mr)return!0;if(Array.isArray(r)){for(const t of r)if(!Kr(t))return!1;return!0}if(typeof r=="object"){for(const t in r)if(!Kr(r[t]))return!1;return!0}return!1}function Oi(r){if(r===null)return ut;if(typeof r=="string")return Je;if(typeof r=="boolean")return We;if(typeof r=="number")return be;if(r instanceof $t)return It;if(r instanceof vr)return yt;if(r instanceof ds)return Ln;if(r instanceof rr)return Bi;if(r instanceof Wi)return Ni;if(r instanceof Xi)return hs;if(r instanceof mr)return pi;if(Array.isArray(r)){const t=r.length;let n;for(const a of r){const l=Oi(a);if(n){if(n===l)continue;n=ct;break}n=l}return yr(n||ct,t)}return Et}function Mn(r){const t=typeof r;return r===null?"":t==="string"||t==="number"||t==="boolean"?String(r):r instanceof $t||r instanceof vr||r instanceof rr||r instanceof Wi||r instanceof Xi||r instanceof mr?r.toString():JSON.stringify(r)}class Or{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(t.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Kr(t[1]))return n.error("invalid value");const a=t[1];let l=Oi(a);const d=n.expectedType;return l.kind!=="array"||l.N!==0||!d||d.kind!=="array"||typeof d.N=="number"&&d.N!==0||(l=d),new Or(l,a)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Da={string:Je,number:be,boolean:We,object:Et};class jr{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let a,l=1;const d=t[0];if(d==="array"){let m,_;if(t.length>2){const v=t[1];if(typeof v!="string"||!(v in Da)||v==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);m=Da[v],l++}else m=ct;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return n.error('The length argument to "array" must be a positive integer literal',2);_=t[2],l++}a=yr(m,_)}else{if(!Da[d])throw new Error(`Types doesn't contain name = ${d}`);a=Da[d]}const p=[];for(;l<t.length;l++){const m=n.parse(t[l],l,ct);if(!m)return null;p.push(m)}return new jr(a,p)}evaluate(t){for(let n=0;n<this.args.length;n++){const a=this.args[n].evaluate(t);if(!za(this.type,Oi(a)))return a;if(n===this.args.length-1)throw new Pi(`Expected value to be of type ${si(this.type)}, but found ${si(Oi(a))} instead.`)}throw new Error}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const ko={"to-boolean":We,"to-color":It,"to-number":be,"to-string":Je};class Yr{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const a=t[0];if(!ko[a])throw new Error(`Can't parse ${a} as it is not part of the known types`);if((a==="to-boolean"||a==="to-string")&&t.length!==2)return n.error("Expected one argument.");const l=ko[a],d=[];for(let p=1;p<t.length;p++){const m=n.parse(t[p],p,ct);if(!m)return null;d.push(m)}return new Yr(l,d)}evaluate(t){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(t);case"color":{let n,a;for(const l of this.args){if(n=l.evaluate(t),a=null,n instanceof $t)return n;if(typeof n=="string"){const d=t.parseColor(n);if(d)return d}else if(Array.isArray(n)&&(a=n.length<3||n.length>4?`Invalid rgba value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:ps(n[0],n[1],n[2],n[3]),!a))return new $t(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Pi(a||`Could not parse color from value '${typeof n=="string"?n:JSON.stringify(n)}'`)}case"padding":{let n;for(const a of this.args){n=a.evaluate(t);const l=Wi.parse(n);if(l)return l}throw new Pi(`Could not parse padding from value '${typeof n=="string"?n:JSON.stringify(n)}'`)}case"variableAnchorOffsetCollection":{let n;for(const a of this.args){n=a.evaluate(t);const l=Xi.parse(n);if(l)return l}throw new Pi(`Could not parse variableAnchorOffsetCollection from value '${typeof n=="string"?n:JSON.stringify(n)}'`)}case"number":{let n=null;for(const a of this.args){if(n=a.evaluate(t),n===null)return 0;const l=Number(n);if(!isNaN(l))return l}throw new Pi(`Could not convert ${JSON.stringify(n)} to number.`)}case"formatted":return rr.fromString(Mn(this.args[0].evaluate(t)));case"resolvedImage":return mr.fromString(Mn(this.args[0].evaluate(t)));case"projectionDefinition":return this.args[0].evaluate(t);default:return Mn(this.args[0].evaluate(t))}}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const gi=["Unknown","Point","LineString","Polygon"];class fs{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?gi[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(t){let n=this._parseColorCache[t];return n||(n=this._parseColorCache[t]=$t.parse(t)),n}}class Ot{constructor(t,n,a=[],l,d=new _t,p=[]){this.registry=t,this.path=a,this.key=a.map(m=>`[${m}]`).join(""),this.scope=d,this.errors=p,this.expectedType=l,this._isConstant=n}parse(t,n,a,l,d={}){return n?this.concat(n,a,l)._parse(t,d):this._parse(t,d)}_parse(t,n){function a(l,d,p){return p==="assert"?new jr(d,[l]):p==="coerce"?new Yr(d,[l]):l}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const l=t[0];if(typeof l!="string")return this.error(`Expression name must be a string, but found ${typeof l} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const d=this.registry[l];if(d){let p=d.parse(t,this);if(!p)return null;if(this.expectedType){const m=this.expectedType,_=p.type;if(m.kind!=="string"&&m.kind!=="number"&&m.kind!=="boolean"&&m.kind!=="object"&&m.kind!=="array"||_.kind!=="value")if(m.kind!=="projectionDefinition"||_.kind!=="string"&&_.kind!=="array")if(m.kind!=="color"&&m.kind!=="formatted"&&m.kind!=="resolvedImage"||_.kind!=="value"&&_.kind!=="string")if(m.kind!=="padding"||_.kind!=="value"&&_.kind!=="number"&&_.kind!=="array")if(m.kind!=="variableAnchorOffsetCollection"||_.kind!=="value"&&_.kind!=="array"){if(this.checkSubtype(m,_))return null}else p=a(p,m,n.typeAnnotation||"coerce");else p=a(p,m,n.typeAnnotation||"coerce");else p=a(p,m,n.typeAnnotation||"coerce");else p=a(p,m,n.typeAnnotation||"coerce");else p=a(p,m,n.typeAnnotation||"assert")}if(!(p instanceof Or)&&p.type.kind!=="resolvedImage"&&this._isConstant(p)){const m=new fs;try{p=new Or(p.type,p.evaluate(m))}catch(_){return this.error(_.message),null}}return p}return this.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,n,a){const l=typeof t=="number"?this.path.concat(t):this.path,d=a?this.scope.concat(a):this.scope;return new Ot(this.registry,this._isConstant,l,n||null,d,this.errors)}error(t,...n){const a=`${this.key}${n.map(l=>`[${l}]`).join("")}`;this.errors.push(new Ke(a,t))}checkSubtype(t,n){const a=za(t,n);return a&&this.error(a),a}}class Ct{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const a=[];for(let d=1;d<t.length-1;d+=2){const p=t[d];if(typeof p!="string")return n.error(`Expected string, but found ${typeof p} instead.`,d);if(/[^a-zA-Z0-9_]/.test(p))return n.error("Variable names must contain only alphanumeric characters or '_'.",d);const m=n.parse(t[d+1],d+1);if(!m)return null;a.push([p,m])}const l=n.parse(t[t.length-1],t.length-1,n.expectedType,a);return l?new Ct(a,l):null}outputDefined(){return this.result.outputDefined()}}class ca{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(t.length!==2||typeof t[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");const a=t[1];return n.scope.has(a)?new ca(a,n.scope.get(a)):n.error(`Unknown variable "${a}". Make sure "${a}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}}class Nt{constructor(t,n,a){this.type=t,this.index=n,this.input=a}static parse(t,n){if(t.length!==3)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const a=n.parse(t[1],1,be),l=n.parse(t[2],2,yr(n.expectedType||ct));return a&&l?new Nt(l.type.itemType,a,l):null}evaluate(t){const n=this.index.evaluate(t),a=this.input.evaluate(t);if(n<0)throw new Pi(`Array index out of bounds: ${n} < 0.`);if(n>=a.length)throw new Pi(`Array index out of bounds: ${n} > ${a.length-1}.`);if(n!==Math.floor(n))throw new Pi(`Array index must be an integer, but found ${n} instead.`);return a[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}}class Ra{constructor(t,n){this.type=We,this.needle=t,this.haystack=n}static parse(t,n){if(t.length!==3)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const a=n.parse(t[1],1,ct),l=n.parse(t[2],2,ct);return a&&l?bo(a.type,[We,Je,be,ut,ct])?new Ra(a,l):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${si(a.type)} instead`):null}evaluate(t){const n=this.needle.evaluate(t),a=this.haystack.evaluate(t);if(!a)return!1;if(!Pn(n,["boolean","string","number","null"]))throw new Pi(`Expected first argument to be of type boolean, string, number or null, but found ${si(Oi(n))} instead.`);if(!Pn(a,["string","array"]))throw new Pi(`Expected second argument to be of type array or string, but found ${si(Oi(a))} instead.`);return a.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}}class Vr{constructor(t,n,a){this.type=be,this.needle=t,this.haystack=n,this.fromIndex=a}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const a=n.parse(t[1],1,ct),l=n.parse(t[2],2,ct);if(!a||!l)return null;if(!bo(a.type,[We,Je,be,ut,ct]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${si(a.type)} instead`);if(t.length===4){const d=n.parse(t[3],3,be);return d?new Vr(a,l,d):null}return new Vr(a,l)}evaluate(t){const n=this.needle.evaluate(t),a=this.haystack.evaluate(t);if(!Pn(n,["boolean","string","number","null"]))throw new Pi(`Expected first argument to be of type boolean, string, number or null, but found ${si(Oi(n))} instead.`);let l;if(this.fromIndex&&(l=this.fromIndex.evaluate(t)),Pn(a,["string"])){const d=a.indexOf(n,l);return d===-1?-1:[...a.slice(0,d)].length}if(Pn(a,["array"]))return a.indexOf(n,l);throw new Pi(`Expected second argument to be of type array or string, but found ${si(Oi(a))} instead.`)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}}class La{constructor(t,n,a,l,d,p){this.inputType=t,this.type=n,this.input=a,this.cases=l,this.outputs=d,this.otherwise=p}static parse(t,n){if(t.length<5)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let a,l;n.expectedType&&n.expectedType.kind!=="value"&&(l=n.expectedType);const d={},p=[];for(let v=2;v<t.length-1;v+=2){let b=t[v];const w=t[v+1];Array.isArray(b)||(b=[b]);const C=n.concat(v);if(b.length===0)return C.error("Expected at least one branch label.");for(const k of b){if(typeof k!="number"&&typeof k!="string")return C.error("Branch labels must be numbers or strings.");if(typeof k=="number"&&Math.abs(k)>Number.MAX_SAFE_INTEGER)return C.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof k=="number"&&Math.floor(k)!==k)return C.error("Numeric branch labels must be integer values.");if(a){if(C.checkSubtype(a,Oi(k)))return null}else a=Oi(k);if(d[String(k)]!==void 0)return C.error("Branch labels must be unique.");d[String(k)]=p.length}const A=n.parse(w,v,l);if(!A)return null;l=l||A.type,p.push(A)}const m=n.parse(t[1],1,ct);if(!m)return null;const _=n.parse(t[t.length-1],t.length-1,l);return _?m.type.kind!=="value"&&n.concat(1).checkSubtype(a,m.type)?null:new La(a,l,m,d,p,_):null}evaluate(t){const n=this.input.evaluate(t);return(Oi(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}}class ms{constructor(t,n,a){this.type=t,this.branches=n,this.otherwise=a}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let a;n.expectedType&&n.expectedType.kind!=="value"&&(a=n.expectedType);const l=[];for(let p=1;p<t.length-1;p+=2){const m=n.parse(t[p],p,We);if(!m)return null;const _=n.parse(t[p+1],p+1,a);if(!_)return null;l.push([m,_]),a=a||_.type}const d=n.parse(t[t.length-1],t.length-1,a);if(!d)return null;if(!a)throw new Error("Can't infer output type");return new ms(a,l,d)}evaluate(t){for(const[n,a]of this.branches)if(n.evaluate(t))return a.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,a]of this.branches)t(n),t(a);t(this.otherwise)}outputDefined(){return this.branches.every(([t,n])=>n.outputDefined())&&this.otherwise.outputDefined()}}class Fa{constructor(t,n,a,l){this.type=t,this.input=n,this.beginIndex=a,this.endIndex=l}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const a=n.parse(t[1],1,ct),l=n.parse(t[2],2,be);if(!a||!l)return null;if(!bo(a.type,[yr(ct),Je,ct]))return n.error(`Expected first argument to be of type array or string, but found ${si(a.type)} instead`);if(t.length===4){const d=n.parse(t[3],3,be);return d?new Fa(a.type,a,l,d):null}return new Fa(a.type,a,l)}evaluate(t){const n=this.input.evaluate(t),a=this.beginIndex.evaluate(t);let l;if(this.endIndex&&(l=this.endIndex.evaluate(t)),Pn(n,["string"]))return[...n].slice(a,l).join("");if(Pn(n,["array"]))return n.slice(a,l);throw new Pi(`Expected first argument to be of type array or string, but found ${si(Oi(n))} instead.`)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}}function ha(r,t){const n=r.length-1;let a,l,d=0,p=n,m=0;for(;d<=p;)if(m=Math.floor((d+p)/2),a=r[m],l=r[m+1],a<=t){if(m===n||t<l)return m;d=m+1}else{if(!(a>t))throw new Pi("Input is not a number.");p=m-1}return 0}class ua{constructor(t,n,a){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[l,d]of a)this.labels.push(l),this.outputs.push(d)}static parse(t,n){if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const a=n.parse(t[1],1,be);if(!a)return null;const l=[];let d=null;n.expectedType&&n.expectedType.kind!=="value"&&(d=n.expectedType);for(let p=1;p<t.length;p+=2){const m=p===1?-1/0:t[p],_=t[p+1],v=p,b=p+1;if(typeof m!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',v);if(l.length&&l[l.length-1][0]>=m)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',v);const w=n.parse(_,b,d);if(!w)return null;d=d||w.type,l.push([m,w])}return new ua(d,a,l)}evaluate(t){const n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(t);const l=this.input.evaluate(t);if(l<=n[0])return a[0].evaluate(t);const d=n.length;return l>=n[d-1]?a[d-1].evaluate(t):a[ha(n,l)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function uh(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var gs,zo,Ba=function(){if(zo)return gs;function r(t,n,a,l){this.cx=3*t,this.bx=3*(a-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(l-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=a,this.p2y=l}return zo=1,gs=r,r.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,n){if(n===void 0&&(n=1e-6),t<0)return 0;if(t>1)return 1;for(var a=t,l=0;l<8;l++){var d=this.sampleCurveX(a)-t;if(Math.abs(d)<n)return a;var p=this.sampleCurveDerivativeX(a);if(Math.abs(p)<1e-6)break;a-=d/p}var m=0,_=1;for(a=t,l=0;l<20&&(d=this.sampleCurveX(a),!(Math.abs(d-t)<n));l++)t>d?m=a:_=a,a=.5*(_-m)+m;return a},solve:function(t,n){return this.sampleCurveY(this.solveCurveX(t,n))}},gs}(),lr=uh(Ba);class cr{constructor(t,n,a,l,d){this.type=t,this.operator=n,this.interpolation=a,this.input=l,this.labels=[],this.outputs=[];for(const[p,m]of d)this.labels.push(p),this.outputs.push(m)}static interpolationFactor(t,n,a,l){let d=0;if(t.name==="exponential")d=_s(n,t.base,a,l);else if(t.name==="linear")d=_s(n,1,a,l);else if(t.name==="cubic-bezier"){const p=t.controlPoints;d=new lr(p[0],p[1],p[2],p[3]).solve(_s(n,1,a,l))}return d}static parse(t,n){let[a,l,d,...p]=t;if(!Array.isArray(l)||l.length===0)return n.error("Expected an interpolation type expression.",1);if(l[0]==="linear")l={name:"linear"};else if(l[0]==="exponential"){const v=l[1];if(typeof v!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);l={name:"exponential",base:v}}else{if(l[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(l[0])}`,1,0);{const v=l.slice(1);if(v.length!==4||v.some(b=>typeof b!="number"||b<0||b>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);l={name:"cubic-bezier",controlPoints:v}}}if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(d=n.parse(d,2,be),!d)return null;const m=[];let _=null;a==="interpolate-hcl"||a==="interpolate-lab"?_=It:n.expectedType&&n.expectedType.kind!=="value"&&(_=n.expectedType);for(let v=0;v<p.length;v+=2){const b=p[v],w=p[v+1],C=v+3,A=v+4;if(typeof b!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(m.length&&m[m.length-1][0]>=b)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',C);const k=n.parse(w,A,_);if(!k)return null;_=_||k.type,m.push([b,k])}return aa(_,be)||aa(_,yt)||aa(_,It)||aa(_,Ni)||aa(_,hs)||aa(_,yr(be))?new cr(_,a,l,d,m):n.error(`Type ${si(_)} is not interpolatable.`)}evaluate(t){const n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(t);const l=this.input.evaluate(t);if(l<=n[0])return a[0].evaluate(t);const d=n.length;if(l>=n[d-1])return a[d-1].evaluate(t);const p=ha(n,l),m=cr.interpolationFactor(this.interpolation,l,n[p],n[p+1]),_=a[p].evaluate(t),v=a[p+1].evaluate(t);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return Cr(_,v,m);case"color":return $t.interpolate(_,v,m);case"padding":return Wi.interpolate(_,v,m);case"variableAnchorOffsetCollection":return Xi.interpolate(_,v,m);case"array":return Fr(_,v,m);case"projectionDefinition":return vr.interpolate(_,v,m)}case"interpolate-hcl":return $t.interpolate(_,v,m,"hcl");case"interpolate-lab":return $t.interpolate(_,v,m,"lab")}}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function _s(r,t,n,a){const l=a-n,d=r-n;return l===0?0:t===1?d/l:(Math.pow(t,d)-1)/(Math.pow(t,l)-1)}const Ir={color:$t.interpolate,number:Cr,padding:Wi.interpolate,variableAnchorOffsetCollection:Xi.interpolate,array:Fr};class zi{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let a=null;const l=n.expectedType;l&&l.kind!=="value"&&(a=l);const d=[];for(const m of t.slice(1)){const _=n.parse(m,1+d.length,a,void 0,{typeAnnotation:"omit"});if(!_)return null;a=a||_.type,d.push(_)}if(!a)throw new Error("No output type");const p=l&&d.some(m=>za(l,m.type));return new zi(p?ct:a,d)}evaluate(t){let n,a=null,l=0;for(const d of this.args)if(l++,a=d.evaluate(t),a&&a instanceof mr&&!a.available&&(n||(n=a.name),a=null,l===this.args.length&&(a=n)),a!==null)break;return a}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}function Do(r,t){return r==="=="||r==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function ys(r,t,n,a){return a.compare(t,n)===0}function Bn(r,t,n){const a=r!=="=="&&r!=="!=";return class qp{constructor(d,p,m){this.type=We,this.lhs=d,this.rhs=p,this.collator=m,this.hasUntypedArgument=d.type.kind==="value"||p.type.kind==="value"}static parse(d,p){if(d.length!==3&&d.length!==4)return p.error("Expected two or three arguments.");const m=d[0];let _=p.parse(d[1],1,ct);if(!_)return null;if(!Do(m,_.type))return p.concat(1).error(`"${m}" comparisons are not supported for type '${si(_.type)}'.`);let v=p.parse(d[2],2,ct);if(!v)return null;if(!Do(m,v.type))return p.concat(2).error(`"${m}" comparisons are not supported for type '${si(v.type)}'.`);if(_.type.kind!==v.type.kind&&_.type.kind!=="value"&&v.type.kind!=="value")return p.error(`Cannot compare types '${si(_.type)}' and '${si(v.type)}'.`);a&&(_.type.kind==="value"&&v.type.kind!=="value"?_=new jr(v.type,[_]):_.type.kind!=="value"&&v.type.kind==="value"&&(v=new jr(_.type,[v])));let b=null;if(d.length===4){if(_.type.kind!=="string"&&v.type.kind!=="string"&&_.type.kind!=="value"&&v.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(b=p.parse(d[3],3,Ln),!b)return null}return new qp(_,v,b)}evaluate(d){const p=this.lhs.evaluate(d),m=this.rhs.evaluate(d);if(a&&this.hasUntypedArgument){const _=Oi(p),v=Oi(m);if(_.kind!==v.kind||_.kind!=="string"&&_.kind!=="number")throw new Pi(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${_.kind}, ${v.kind}) instead.`)}if(this.collator&&!a&&this.hasUntypedArgument){const _=Oi(p),v=Oi(m);if(_.kind!=="string"||v.kind!=="string")return t(d,p,m)}return this.collator?n(d,p,m,this.collator.evaluate(d)):t(d,p,m)}eachChild(d){d(this.lhs),d(this.rhs),this.collator&&d(this.collator)}outputDefined(){return!0}}}const dh=Bn("==",function(r,t,n){return t===n},ys),vs=Bn("!=",function(r,t,n){return t!==n},function(r,t,n,a){return!ys(0,t,n,a)}),Ro=Bn("<",function(r,t,n){return t<n},function(r,t,n,a){return a.compare(t,n)<0}),ph=Bn(">",function(r,t,n){return t>n},function(r,t,n,a){return a.compare(t,n)>0}),xs=Bn("<=",function(r,t,n){return t<=n},function(r,t,n,a){return a.compare(t,n)<=0}),bs=Bn(">=",function(r,t,n){return t>=n},function(r,t,n,a){return a.compare(t,n)>=0});class xr{constructor(t,n,a){this.type=Ln,this.locale=a,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(t.length!==2)return n.error("Expected one argument.");const a=t[1];if(typeof a!="object"||Array.isArray(a))return n.error("Collator options argument must be an object.");const l=n.parse(a["case-sensitive"]!==void 0&&a["case-sensitive"],1,We);if(!l)return null;const d=n.parse(a["diacritic-sensitive"]!==void 0&&a["diacritic-sensitive"],1,We);if(!d)return null;let p=null;return a.locale&&(p=n.parse(a.locale,1,Je),!p)?null:new xr(l,d,p)}evaluate(t){return new ds(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}}class ws{constructor(t,n,a,l,d){this.type=Je,this.number=t,this.locale=n,this.currency=a,this.minFractionDigits=l,this.maxFractionDigits=d}static parse(t,n){if(t.length!==3)return n.error("Expected two arguments.");const a=n.parse(t[1],1,be);if(!a)return null;const l=t[2];if(typeof l!="object"||Array.isArray(l))return n.error("NumberFormat options argument must be an object.");let d=null;if(l.locale&&(d=n.parse(l.locale,1,Je),!d))return null;let p=null;if(l.currency&&(p=n.parse(l.currency,1,Je),!p))return null;let m=null;if(l["min-fraction-digits"]&&(m=n.parse(l["min-fraction-digits"],1,be),!m))return null;let _=null;return l["max-fraction-digits"]&&(_=n.parse(l["max-fraction-digits"],1,be),!_)?null:new ws(a,d,p,m,_)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}}class On{constructor(t){this.type=Bi,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const a=t[1];if(!Array.isArray(a)&&typeof a=="object")return n.error("First argument must be an image or text section.");const l=[];let d=!1;for(let p=1;p<=t.length-1;++p){const m=t[p];if(d&&typeof m=="object"&&!Array.isArray(m)){d=!1;let _=null;if(m["font-scale"]&&(_=n.parse(m["font-scale"],1,be),!_))return null;let v=null;if(m["text-font"]&&(v=n.parse(m["text-font"],1,yr(Je)),!v))return null;let b=null;if(m["text-color"]&&(b=n.parse(m["text-color"],1,It),!b))return null;let w=null;if(m["vertical-align"]){if(typeof m["vertical-align"]=="string"&&!Eo.includes(m["vertical-align"]))return n.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${m["vertical-align"]}' instead.`);if(w=n.parse(m["vertical-align"],1,Je),!w)return null}const C=l[l.length-1];C.scale=_,C.font=v,C.textColor=b,C.verticalAlign=w}else{const _=n.parse(t[p],1,ct);if(!_)return null;const v=_.type.kind;if(v!=="string"&&v!=="value"&&v!=="null"&&v!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");d=!0,l.push({content:_,scale:null,font:null,textColor:null,verticalAlign:null})}}return new On(l)}evaluate(t){return new rr(this.sections.map(n=>{const a=n.content.evaluate(t);return Oi(a)===pi?new Br("",a,null,null,null,n.verticalAlign?n.verticalAlign.evaluate(t):null):new Br(Mn(a),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null,n.verticalAlign?n.verticalAlign.evaluate(t):null)}))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor),n.verticalAlign&&t(n.verticalAlign)}outputDefined(){return!1}}class Lo{constructor(t){this.type=pi,this.input=t}static parse(t,n){if(t.length!==2)return n.error("Expected two arguments.");const a=n.parse(t[1],1,Je);return a?new Lo(a):n.error("No image name provided.")}evaluate(t){const n=this.input.evaluate(t),a=mr.fromString(n);return a&&t.availableImages&&(a.available=t.availableImages.indexOf(n)>-1),a}eachChild(t){t(this.input)}outputDefined(){return!1}}class Oa{constructor(t){this.type=be,this.input=t}static parse(t,n){if(t.length!==2)return n.error(`Expected 1 argument, but found ${t.length-1} instead.`);const a=n.parse(t[1],1);return a?a.type.kind!=="array"&&a.type.kind!=="string"&&a.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${si(a.type)} instead.`):new Oa(a):null}evaluate(t){const n=this.input.evaluate(t);if(typeof n=="string")return[...n].length;if(Array.isArray(n))return n.length;throw new Pi(`Expected value to be of type string or array, but found ${si(Oi(n))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}}const sn=8192;function fh(r,t){const n=(180+r[0])/360,a=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,l=Math.pow(2,t.z);return[Math.round(n*l*sn),Math.round(a*l*sn)]}function Fo(r,t){const n=Math.pow(2,t.z);return[(l=(r[0]/sn+t.x)/n,360*l-180),(a=(r[1]/sn+t.y)/n,360/Math.PI*Math.atan(Math.exp((180-360*a)*Math.PI/180))-90)];var a,l}function ja(r,t){r[0]=Math.min(r[0],t[0]),r[1]=Math.min(r[1],t[1]),r[2]=Math.max(r[2],t[0]),r[3]=Math.max(r[3],t[1])}function Sn(r,t){return!(r[0]<=t[0]||r[2]>=t[2]||r[1]<=t[1]||r[3]>=t[3])}function mh(r,t,n){const a=r[0]-t[0],l=r[1]-t[1],d=r[0]-n[0],p=r[1]-n[1];return a*p-d*l==0&&a*d<=0&&l*p<=0}function Va(r,t,n,a){return(l=[a[0]-n[0],a[1]-n[1]])[0]*(d=[t[0]-r[0],t[1]-r[1]])[1]-l[1]*d[0]!=0&&!(!Kl(r,t,n,a)||!Kl(n,a,r,t));var l,d}function Hl(r,t,n){for(const a of n)for(let l=0;l<a.length-1;++l)if(Va(r,t,a[l],a[l+1]))return!0;return!1}function da(r,t,n=!1){let a=!1;for(const m of t)for(let _=0;_<m.length-1;_++){if(mh(r,m[_],m[_+1]))return n;(d=m[_])[1]>(l=r)[1]!=(p=m[_+1])[1]>l[1]&&l[0]<(p[0]-d[0])*(l[1]-d[1])/(p[1]-d[1])+d[0]&&(a=!a)}var l,d,p;return a}function Wl(r,t){for(const n of t)if(da(r,n))return!0;return!1}function Xl(r,t){for(const n of r)if(!da(n,t))return!1;for(let n=0;n<r.length-1;++n)if(Hl(r[n],r[n+1],t))return!1;return!0}function gh(r,t){for(const n of t)if(Xl(r,n))return!0;return!1}function Kl(r,t,n,a){const l=a[0]-n[0],d=a[1]-n[1],p=(r[0]-n[0])*d-l*(r[1]-n[1]),m=(t[0]-n[0])*d-l*(t[1]-n[1]);return p>0&&m<0||p<0&&m>0}function Bo(r,t,n){const a=[];for(let l=0;l<r.length;l++){const d=[];for(let p=0;p<r[l].length;p++){const m=fh(r[l][p],n);ja(t,m),d.push(m)}a.push(d)}return a}function Yl(r,t,n){const a=[];for(let l=0;l<r.length;l++){const d=Bo(r[l],t,n);a.push(d)}return a}function Oo(r,t,n,a){if(r[0]<n[0]||r[0]>n[2]){const l=.5*a;let d=r[0]-n[0]>l?-a:n[0]-r[0]>l?a:0;d===0&&(d=r[0]-n[2]>l?-a:n[2]-r[0]>l?a:0),r[0]+=d}ja(t,r)}function jo(r,t,n,a){const l=Math.pow(2,a.z)*sn,d=[a.x*sn,a.y*sn],p=[];for(const m of r)for(const _ of m){const v=[_.x+d[0],_.y+d[1]];Oo(v,t,n,l),p.push(v)}return p}function Vo(r,t,n,a){const l=Math.pow(2,a.z)*sn,d=[a.x*sn,a.y*sn],p=[];for(const _ of r){const v=[];for(const b of _){const w=[b.x+d[0],b.y+d[1]];ja(t,w),v.push(w)}p.push(v)}if(t[2]-t[0]<=l/2){(m=t)[0]=m[1]=1/0,m[2]=m[3]=-1/0;for(const _ of p)for(const v of _)Oo(v,t,n,l)}var m;return p}class jn{constructor(t,n){this.type=We,this.geojson=t,this.geometries=n}static parse(t,n){if(t.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Kr(t[1])){const a=t[1];if(a.type==="FeatureCollection"){const l=[];for(const d of a.features){const{type:p,coordinates:m}=d.geometry;p==="Polygon"&&l.push(m),p==="MultiPolygon"&&l.push(...m)}if(l.length)return new jn(a,{type:"MultiPolygon",coordinates:l})}else if(a.type==="Feature"){const l=a.geometry.type;if(l==="Polygon"||l==="MultiPolygon")return new jn(a,a.geometry)}else if(a.type==="Polygon"||a.type==="MultiPolygon")return new jn(a,a)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(n,a){const l=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(a.type==="Polygon"){const m=Bo(a.coordinates,d,p),_=jo(n.geometry(),l,d,p);if(!Sn(l,d))return!1;for(const v of _)if(!da(v,m))return!1}if(a.type==="MultiPolygon"){const m=Yl(a.coordinates,d,p),_=jo(n.geometry(),l,d,p);if(!Sn(l,d))return!1;for(const v of _)if(!Wl(v,m))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(n,a){const l=[1/0,1/0,-1/0,-1/0],d=[1/0,1/0,-1/0,-1/0],p=n.canonicalID();if(a.type==="Polygon"){const m=Bo(a.coordinates,d,p),_=Vo(n.geometry(),l,d,p);if(!Sn(l,d))return!1;for(const v of _)if(!Xl(v,m))return!1}if(a.type==="MultiPolygon"){const m=Yl(a.coordinates,d,p),_=Vo(n.geometry(),l,d,p);if(!Sn(l,d))return!1;for(const v of _)if(!gh(v,m))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let Jl=class{constructor(r=[],t=(n,a)=>n<a?-1:n>a?1:0){if(this.data=r,this.length=this.data.length,this.compare=t,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(r){this.data.push(r),this._up(this.length++)}pop(){if(this.length===0)return;const r=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),r}peek(){return this.data[0]}_up(r){const{data:t,compare:n}=this,a=t[r];for(;r>0;){const l=r-1>>1,d=t[l];if(n(a,d)>=0)break;t[r]=d,r=l}t[r]=a}_down(r){const{data:t,compare:n}=this,a=this.length>>1,l=t[r];for(;r<a;){let d=1+(r<<1);const p=d+1;if(p<this.length&&n(t[p],t[d])<0&&(d=p),n(t[d],l)>=0)break;t[r]=t[d],r=d}t[r]=l}};function Ql(r,t,n=0,a=r.length-1,l=_h){for(;a>n;){if(a-n>600){const _=a-n+1,v=t-n+1,b=Math.log(_),w=.5*Math.exp(2*b/3),C=.5*Math.sqrt(b*w*(_-w)/_)*(v-_/2<0?-1:1);Ql(r,t,Math.max(n,Math.floor(t-v*w/_+C)),Math.min(a,Math.floor(t+(_-v)*w/_+C)),l)}const d=r[t];let p=n,m=a;for(Vn(r,n,t),l(r[a],d)>0&&Vn(r,n,a);p<m;){for(Vn(r,p,m),p++,m--;l(r[p],d)<0;)p++;for(;l(r[m],d)>0;)m--}l(r[n],d)===0?Vn(r,n,m):(m++,Vn(r,m,a)),m<=t&&(n=m+1),t<=m&&(a=m-1)}}function Vn(r,t,n){const a=r[t];r[t]=r[n],r[n]=a}function _h(r,t){return r<t?-1:r>t?1:0}function Ts(r,t){if(r.length<=1)return[r];const n=[];let a,l;for(const d of r){const p=ec(d);p!==0&&(d.area=Math.abs(p),l===void 0&&(l=p<0),l===p<0?(a&&n.push(a),a=[d]):a.push(d))}if(a&&n.push(a),t>1)for(let d=0;d<n.length;d++)n[d].length<=t||(Ql(n[d],t,1,n[d].length-1,yh),n[d]=n[d].slice(0,t));return n}function yh(r,t){return t.area-r.area}function ec(r){let t=0;for(let n,a,l=0,d=r.length,p=d-1;l<d;p=l++)n=r[l],a=r[p],t+=(a.x-n.x)*(n.y+a.y);return t}const No=1/298.257223563,tc=No*(2-No),ic=Math.PI/180;class Ps{constructor(t){const n=6378.137*ic*1e3,a=Math.cos(t*ic),l=1/(1-tc*(1-a*a)),d=Math.sqrt(l);this.kx=n*d*a,this.ky=n*d*l*(1-tc)}distance(t,n){const a=this.wrap(t[0]-n[0])*this.kx,l=(t[1]-n[1])*this.ky;return Math.sqrt(a*a+l*l)}pointOnLine(t,n){let a,l,d,p,m=1/0;for(let _=0;_<t.length-1;_++){let v=t[_][0],b=t[_][1],w=this.wrap(t[_+1][0]-v)*this.kx,C=(t[_+1][1]-b)*this.ky,A=0;w===0&&C===0||(A=(this.wrap(n[0]-v)*this.kx*w+(n[1]-b)*this.ky*C)/(w*w+C*C),A>1?(v=t[_+1][0],b=t[_+1][1]):A>0&&(v+=w/this.kx*A,b+=C/this.ky*A)),w=this.wrap(n[0]-v)*this.kx,C=(n[1]-b)*this.ky;const k=w*w+C*C;k<m&&(m=k,a=v,l=b,d=_,p=A)}return{point:[a,l],index:d,t:Math.max(0,Math.min(1,p))}}wrap(t){for(;t<-180;)t+=360;for(;t>180;)t-=360;return t}}function Zo(r,t){return t[0]-r[0]}function Ms(r){return r[1]-r[0]+1}function gn(r,t){return r[1]>=r[0]&&r[1]<t}function Uo(r,t){if(r[0]>r[1])return[null,null];const n=Ms(r);if(t){if(n===2)return[r,null];const l=Math.floor(n/2);return[[r[0],r[0]+l],[r[0]+l,r[1]]]}if(n===1)return[r,null];const a=Math.floor(n/2)-1;return[[r[0],r[0]+a],[r[0]+a+1,r[1]]]}function Ss(r,t){if(!gn(t,r.length))return[1/0,1/0,-1/0,-1/0];const n=[1/0,1/0,-1/0,-1/0];for(let a=t[0];a<=t[1];++a)ja(n,r[a]);return n}function $o(r){const t=[1/0,1/0,-1/0,-1/0];for(const n of r)for(const a of n)ja(t,a);return t}function rc(r){return r[0]!==-1/0&&r[1]!==-1/0&&r[2]!==1/0&&r[3]!==1/0}function Go(r,t,n){if(!rc(r)||!rc(t))return NaN;let a=0,l=0;return r[2]<t[0]&&(a=t[0]-r[2]),r[0]>t[2]&&(a=r[0]-t[2]),r[1]>t[3]&&(l=r[1]-t[3]),r[3]<t[1]&&(l=t[1]-r[3]),n.distance([0,0],[a,l])}function Nn(r,t,n){const a=n.pointOnLine(t,r);return n.distance(r,a.point)}function qt(r,t,n,a,l){const d=Math.min(Nn(r,[n,a],l),Nn(t,[n,a],l)),p=Math.min(Nn(n,[r,t],l),Nn(a,[r,t],l));return Math.min(d,p)}function vh(r,t,n,a,l){if(!gn(t,r.length)||!gn(a,n.length))return 1/0;let d=1/0;for(let p=t[0];p<t[1];++p){const m=r[p],_=r[p+1];for(let v=a[0];v<a[1];++v){const b=n[v],w=n[v+1];if(Va(m,_,b,w))return 0;d=Math.min(d,qt(m,_,b,w,l))}}return d}function xh(r,t,n,a,l){if(!gn(t,r.length)||!gn(a,n.length))return NaN;let d=1/0;for(let p=t[0];p<=t[1];++p)for(let m=a[0];m<=a[1];++m)if(d=Math.min(d,l.distance(r[p],n[m])),d===0)return d;return d}function bh(r,t,n){if(da(r,t,!0))return 0;let a=1/0;for(const l of t){const d=l[0],p=l[l.length-1];if(d!==p&&(a=Math.min(a,Nn(r,[p,d],n)),a===0))return a;const m=n.pointOnLine(l,r);if(a=Math.min(a,n.distance(r,m.point)),a===0)return a}return a}function wh(r,t,n,a){if(!gn(t,r.length))return NaN;for(let d=t[0];d<=t[1];++d)if(da(r[d],n,!0))return 0;let l=1/0;for(let d=t[0];d<t[1];++d){const p=r[d],m=r[d+1];for(const _ of n)for(let v=0,b=_.length,w=b-1;v<b;w=v++){const C=_[w],A=_[v];if(Va(p,m,C,A))return 0;l=Math.min(l,qt(p,m,C,A,a))}}return l}function nc(r,t){for(const n of r)for(const a of n)if(da(a,t,!0))return!0;return!1}function Th(r,t,n,a=1/0){const l=$o(r),d=$o(t);if(a!==1/0&&Go(l,d,n)>=a)return a;if(Sn(l,d)){if(nc(r,t))return 0}else if(nc(t,r))return 0;let p=1/0;for(const m of r)for(let _=0,v=m.length,b=v-1;_<v;b=_++){const w=m[b],C=m[_];for(const A of t)for(let k=0,D=A.length,B=D-1;k<D;B=k++){const U=A[B],ee=A[k];if(Va(w,C,U,ee))return 0;p=Math.min(p,qt(w,C,U,ee,n))}}return p}function ac(r,t,n,a,l,d){if(!d)return;const p=Go(Ss(a,d),l,n);p<t&&r.push([p,d,[0,0]])}function Cs(r,t,n,a,l,d,p){if(!d||!p)return;const m=Go(Ss(a,d),Ss(l,p),n);m<t&&r.push([m,d,p])}function Is(r,t,n,a,l=1/0){let d=Math.min(a.distance(r[0],n[0][0]),l);if(d===0)return d;const p=new Jl([[0,[0,r.length-1],[0,0]]],Zo),m=$o(n);for(;p.length>0;){const _=p.pop();if(_[0]>=d)continue;const v=_[1],b=t?50:100;if(Ms(v)<=b){if(!gn(v,r.length))return NaN;if(t){const w=wh(r,v,n,a);if(isNaN(w)||w===0)return w;d=Math.min(d,w)}else for(let w=v[0];w<=v[1];++w){const C=bh(r[w],n,a);if(d=Math.min(d,C),d===0)return 0}}else{const w=Uo(v,t);ac(p,d,a,r,m,w[0]),ac(p,d,a,r,m,w[1])}}return d}function Es(r,t,n,a,l,d=1/0){let p=Math.min(d,l.distance(r[0],n[0]));if(p===0)return p;const m=new Jl([[0,[0,r.length-1],[0,n.length-1]]],Zo);for(;m.length>0;){const _=m.pop();if(_[0]>=p)continue;const v=_[1],b=_[2],w=t?50:100,C=a?50:100;if(Ms(v)<=w&&Ms(b)<=C){if(!gn(v,r.length)&&gn(b,n.length))return NaN;let A;if(t&&a)A=vh(r,v,n,b,l),p=Math.min(p,A);else if(t&&!a){const k=r.slice(v[0],v[1]+1);for(let D=b[0];D<=b[1];++D)if(A=Nn(n[D],k,l),p=Math.min(p,A),p===0)return p}else if(!t&&a){const k=n.slice(b[0],b[1]+1);for(let D=v[0];D<=v[1];++D)if(A=Nn(r[D],k,l),p=Math.min(p,A),p===0)return p}else A=xh(r,v,n,b,l),p=Math.min(p,A)}else{const A=Uo(v,t),k=Uo(b,a);Cs(m,p,l,r,n,A[0],k[0]),Cs(m,p,l,r,n,A[0],k[1]),Cs(m,p,l,r,n,A[1],k[0]),Cs(m,p,l,r,n,A[1],k[1])}}return p}function qo(r){return r.type==="MultiPolygon"?r.coordinates.map(t=>({type:"Polygon",coordinates:t})):r.type==="MultiLineString"?r.coordinates.map(t=>({type:"LineString",coordinates:t})):r.type==="MultiPoint"?r.coordinates.map(t=>({type:"Point",coordinates:t})):[r]}class Zn{constructor(t,n){this.type=be,this.geojson=t,this.geometries=n}static parse(t,n){if(t.length!==2)return n.error(`'distance' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Kr(t[1])){const a=t[1];if(a.type==="FeatureCollection")return new Zn(a,a.features.map(l=>qo(l.geometry)).flat());if(a.type==="Feature")return new Zn(a,qo(a.geometry));if("type"in a&&"coordinates"in a)return new Zn(a,qo(a))}return n.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(n,a){const l=n.geometry(),d=l.flat().map(_=>Fo([_.x,_.y],n.canonical));if(l.length===0)return NaN;const p=new Ps(d[0][1]);let m=1/0;for(const _ of a){switch(_.type){case"Point":m=Math.min(m,Es(d,!1,[_.coordinates],!1,p,m));break;case"LineString":m=Math.min(m,Es(d,!1,_.coordinates,!0,p,m));break;case"Polygon":m=Math.min(m,Is(d,!1,_.coordinates,p,m))}if(m===0)return m}return m}(t,this.geometries);if(t.geometryType()==="LineString")return function(n,a){const l=n.geometry(),d=l.flat().map(_=>Fo([_.x,_.y],n.canonical));if(l.length===0)return NaN;const p=new Ps(d[0][1]);let m=1/0;for(const _ of a){switch(_.type){case"Point":m=Math.min(m,Es(d,!0,[_.coordinates],!1,p,m));break;case"LineString":m=Math.min(m,Es(d,!0,_.coordinates,!0,p,m));break;case"Polygon":m=Math.min(m,Is(d,!0,_.coordinates,p,m))}if(m===0)return m}return m}(t,this.geometries);if(t.geometryType()==="Polygon")return function(n,a){const l=n.geometry();if(l.length===0||l[0].length===0)return NaN;const d=Ts(l,0).map(_=>_.map(v=>v.map(b=>Fo([b.x,b.y],n.canonical)))),p=new Ps(d[0][0][0][1]);let m=1/0;for(const _ of a)for(const v of d){switch(_.type){case"Point":m=Math.min(m,Is([_.coordinates],!1,v,p,m));break;case"LineString":m=Math.min(m,Is(_.coordinates,!0,v,p,m));break;case"Polygon":m=Math.min(m,Th(v,_.coordinates,p,m))}if(m===0)return m}return m}(t,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const pa={"==":dh,"!=":vs,">":ph,"<":Ro,">=":bs,"<=":xs,array:jr,at:Nt,boolean:jr,case:ms,coalesce:zi,collator:xr,format:On,image:Lo,in:Ra,"index-of":Vr,interpolate:cr,"interpolate-hcl":cr,"interpolate-lab":cr,length:Oa,let:Ct,literal:Or,match:La,number:jr,"number-format":ws,object:jr,slice:Fa,step:ua,string:jr,"to-boolean":Yr,"to-color":Yr,"to-number":Yr,"to-string":Yr,var:ca,within:jn,distance:Zn};class Nr{constructor(t,n,a,l){this.name=t,this.type=n,this._evaluate=a,this.args=l}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}static parse(t,n){const a=t[0],l=Nr.definitions[a];if(!l)return n.error(`Unknown expression "${a}". If you wanted a literal array, use ["literal", [...]].`,0);const d=Array.isArray(l)?l[0]:l.type,p=Array.isArray(l)?[[l[1],l[2]]]:l.overloads,m=p.filter(([v])=>!Array.isArray(v)||v.length===t.length-1);let _=null;for(const[v,b]of m){_=new Ot(n.registry,As,n.path,null,n.scope);const w=[];let C=!1;for(let A=1;A<t.length;A++){const k=t[A],D=Array.isArray(v)?v[A-1]:v.type,B=_.parse(k,1+w.length,D);if(!B){C=!0;break}w.push(B)}if(!C)if(Array.isArray(v)&&v.length!==w.length)_.error(`Expected ${v.length} arguments, but found ${w.length} instead.`);else{for(let A=0;A<w.length;A++){const k=Array.isArray(v)?v[A]:v.type,D=w[A];_.concat(A+1).checkSubtype(k,D.type)}if(_.errors.length===0)return new Nr(a,d,b,w)}}if(m.length===1)n.errors.push(..._.errors);else{const v=(m.length?m:p).map(([w])=>{return C=w,Array.isArray(C)?`(${C.map(si).join(", ")})`:`(${si(C.type)}...)`;var C}).join(" | "),b=[];for(let w=1;w<t.length;w++){const C=n.parse(t[w],1+b.length);if(!C)return null;b.push(si(C.type))}n.error(`Expected arguments of type ${v}, but found (${b.join(", ")}) instead.`)}return null}static register(t,n){Nr.definitions=n;for(const a in n)t[a]=Nr}}function sc(r,[t,n,a,l]){t=t.evaluate(r),n=n.evaluate(r),a=a.evaluate(r);const d=l?l.evaluate(r):1,p=ps(t,n,a,d);if(p)throw new Pi(p);return new $t(t/255,n/255,a/255,d,!1)}function oc(r,t){return r in t}function Ho(r,t){const n=t[r];return n===void 0?null:n}function Un(r){return{type:r}}function As(r){if(r instanceof ca)return As(r.boundExpression);if(r instanceof Nr&&r.name==="error"||r instanceof xr||r instanceof jn||r instanceof Zn)return!1;const t=r instanceof Yr||r instanceof jr;let n=!0;return r.eachChild(a=>{n=t?n&&As(a):n&&a instanceof Or}),!!n&&ks(r)&&zs(r,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function ks(r){if(r instanceof Nr&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof jn||r instanceof Zn)return!1;let t=!0;return r.eachChild(n=>{t&&!ks(n)&&(t=!1)}),t}function Na(r){if(r instanceof Nr&&r.name==="feature-state")return!1;let t=!0;return r.eachChild(n=>{t&&!Na(n)&&(t=!1)}),t}function zs(r,t){if(r instanceof Nr&&t.indexOf(r.name)>=0)return!1;let n=!0;return r.eachChild(a=>{n&&!zs(a,t)&&(n=!1)}),n}function lc(r){return{result:"success",value:r}}function fa(r){return{result:"error",value:r}}function ma(r){return r["property-type"]==="data-driven"||r["property-type"]==="cross-faded-data-driven"}function cc(r){return!!r.expression&&r.expression.parameters.indexOf("zoom")>-1}function Wo(r){return!!r.expression&&r.expression.interpolated}function Gt(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}function Ds(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function Ph(r){return r}function hc(r,t){const n=t.type==="color",a=r.stops&&typeof r.stops[0][0]=="object",l=a||!(a||r.property!==void 0),d=r.type||(Wo(t)?"exponential":"interval");if(n||t.type==="padding"){const b=n?$t.parse:Wi.parse;(r=Fe({},r)).stops&&(r.stops=r.stops.map(w=>[w[0],b(w[1])])),r.default=b(r.default?r.default:t.default)}if(r.colorSpace&&(p=r.colorSpace)!=="rgb"&&p!=="hcl"&&p!=="lab")throw new Error(`Unknown color space: "${r.colorSpace}"`);var p;let m,_,v;if(d==="exponential")m=uc;else if(d==="interval")m=Sh;else if(d==="categorical"){m=Mh,_=Object.create(null);for(const b of r.stops)_[b[0]]=b[1];v=typeof r.stops[0][0]}else{if(d!=="identity")throw new Error(`Unknown function type "${d}"`);m=dc}if(a){const b={},w=[];for(let k=0;k<r.stops.length;k++){const D=r.stops[k],B=D[0].zoom;b[B]===void 0&&(b[B]={zoom:B,type:r.type,property:r.property,default:r.default,stops:[]},w.push(B)),b[B].stops.push([D[0].value,D[1]])}const C=[];for(const k of w)C.push([b[k].zoom,hc(b[k],t)]);const A={name:"linear"};return{kind:"composite",interpolationType:A,interpolationFactor:cr.interpolationFactor.bind(void 0,A),zoomStops:C.map(k=>k[0]),evaluate:({zoom:k},D)=>uc({stops:C,base:r.base},t,k).evaluate(k,D)}}if(l){const b=d==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:b,interpolationFactor:cr.interpolationFactor.bind(void 0,b),zoomStops:r.stops.map(w=>w[0]),evaluate:({zoom:w})=>m(r,t,w,_,v)}}return{kind:"source",evaluate(b,w){const C=w&&w.properties?w.properties[r.property]:void 0;return C===void 0?$n(r.default,t.default):m(r,t,C,_,v)}}}function $n(r,t,n){return r!==void 0?r:t!==void 0?t:n!==void 0?n:void 0}function Mh(r,t,n,a,l){return $n(typeof n===l?a[n]:void 0,r.default,t.default)}function Sh(r,t,n){if(Gt(n)!=="number")return $n(r.default,t.default);const a=r.stops.length;if(a===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[a-1][0])return r.stops[a-1][1];const l=ha(r.stops.map(d=>d[0]),n);return r.stops[l][1]}function uc(r,t,n){const a=r.base!==void 0?r.base:1;if(Gt(n)!=="number")return $n(r.default,t.default);const l=r.stops.length;if(l===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[l-1][0])return r.stops[l-1][1];const d=ha(r.stops.map(b=>b[0]),n),p=function(b,w,C,A){const k=A-C,D=b-C;return k===0?0:w===1?D/k:(Math.pow(w,D)-1)/(Math.pow(w,k)-1)}(n,a,r.stops[d][0],r.stops[d+1][0]),m=r.stops[d][1],_=r.stops[d+1][1],v=Ir[t.type]||Ph;return typeof m.evaluate=="function"?{evaluate(...b){const w=m.evaluate.apply(void 0,b),C=_.evaluate.apply(void 0,b);if(w!==void 0&&C!==void 0)return v(w,C,p,r.colorSpace)}}:v(m,_,p,r.colorSpace)}function dc(r,t,n){switch(t.type){case"color":n=$t.parse(n);break;case"formatted":n=rr.fromString(n.toString());break;case"resolvedImage":n=mr.fromString(n.toString());break;case"padding":n=Wi.parse(n);break;default:Gt(n)===t.type||t.type==="enum"&&t.values[n]||(n=void 0)}return $n(n,r.default,t.default)}Nr.register(pa,{error:[{kind:"error"},[Je],(r,[t])=>{throw new Pi(t.evaluate(r))}],typeof:[Je,[ct],(r,[t])=>si(Oi(t.evaluate(r)))],"to-rgba":[yr(be,4),[It],(r,[t])=>{const[n,a,l,d]=t.evaluate(r).rgb;return[255*n,255*a,255*l,d]}],rgb:[It,[be,be,be],sc],rgba:[It,[be,be,be,be],sc],has:{type:We,overloads:[[[Je],(r,[t])=>oc(t.evaluate(r),r.properties())],[[Je,Et],(r,[t,n])=>oc(t.evaluate(r),n.evaluate(r))]]},get:{type:ct,overloads:[[[Je],(r,[t])=>Ho(t.evaluate(r),r.properties())],[[Je,Et],(r,[t,n])=>Ho(t.evaluate(r),n.evaluate(r))]]},"feature-state":[ct,[Je],(r,[t])=>Ho(t.evaluate(r),r.featureState||{})],properties:[Et,[],r=>r.properties()],"geometry-type":[Je,[],r=>r.geometryType()],id:[ct,[],r=>r.id()],zoom:[be,[],r=>r.globals.zoom],"heatmap-density":[be,[],r=>r.globals.heatmapDensity||0],"line-progress":[be,[],r=>r.globals.lineProgress||0],accumulated:[ct,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[be,Un(be),(r,t)=>{let n=0;for(const a of t)n+=a.evaluate(r);return n}],"*":[be,Un(be),(r,t)=>{let n=1;for(const a of t)n*=a.evaluate(r);return n}],"-":{type:be,overloads:[[[be,be],(r,[t,n])=>t.evaluate(r)-n.evaluate(r)],[[be],(r,[t])=>-t.evaluate(r)]]},"/":[be,[be,be],(r,[t,n])=>t.evaluate(r)/n.evaluate(r)],"%":[be,[be,be],(r,[t,n])=>t.evaluate(r)%n.evaluate(r)],ln2:[be,[],()=>Math.LN2],pi:[be,[],()=>Math.PI],e:[be,[],()=>Math.E],"^":[be,[be,be],(r,[t,n])=>Math.pow(t.evaluate(r),n.evaluate(r))],sqrt:[be,[be],(r,[t])=>Math.sqrt(t.evaluate(r))],log10:[be,[be],(r,[t])=>Math.log(t.evaluate(r))/Math.LN10],ln:[be,[be],(r,[t])=>Math.log(t.evaluate(r))],log2:[be,[be],(r,[t])=>Math.log(t.evaluate(r))/Math.LN2],sin:[be,[be],(r,[t])=>Math.sin(t.evaluate(r))],cos:[be,[be],(r,[t])=>Math.cos(t.evaluate(r))],tan:[be,[be],(r,[t])=>Math.tan(t.evaluate(r))],asin:[be,[be],(r,[t])=>Math.asin(t.evaluate(r))],acos:[be,[be],(r,[t])=>Math.acos(t.evaluate(r))],atan:[be,[be],(r,[t])=>Math.atan(t.evaluate(r))],min:[be,Un(be),(r,t)=>Math.min(...t.map(n=>n.evaluate(r)))],max:[be,Un(be),(r,t)=>Math.max(...t.map(n=>n.evaluate(r)))],abs:[be,[be],(r,[t])=>Math.abs(t.evaluate(r))],round:[be,[be],(r,[t])=>{const n=t.evaluate(r);return n<0?-Math.round(-n):Math.round(n)}],floor:[be,[be],(r,[t])=>Math.floor(t.evaluate(r))],ceil:[be,[be],(r,[t])=>Math.ceil(t.evaluate(r))],"filter-==":[We,[Je,ct],(r,[t,n])=>r.properties()[t.value]===n.value],"filter-id-==":[We,[ct],(r,[t])=>r.id()===t.value],"filter-type-==":[We,[Je],(r,[t])=>r.geometryType()===t.value],"filter-<":[We,[Je,ct],(r,[t,n])=>{const a=r.properties()[t.value],l=n.value;return typeof a==typeof l&&a<l}],"filter-id-<":[We,[ct],(r,[t])=>{const n=r.id(),a=t.value;return typeof n==typeof a&&n<a}],"filter->":[We,[Je,ct],(r,[t,n])=>{const a=r.properties()[t.value],l=n.value;return typeof a==typeof l&&a>l}],"filter-id->":[We,[ct],(r,[t])=>{const n=r.id(),a=t.value;return typeof n==typeof a&&n>a}],"filter-<=":[We,[Je,ct],(r,[t,n])=>{const a=r.properties()[t.value],l=n.value;return typeof a==typeof l&&a<=l}],"filter-id-<=":[We,[ct],(r,[t])=>{const n=r.id(),a=t.value;return typeof n==typeof a&&n<=a}],"filter->=":[We,[Je,ct],(r,[t,n])=>{const a=r.properties()[t.value],l=n.value;return typeof a==typeof l&&a>=l}],"filter-id->=":[We,[ct],(r,[t])=>{const n=r.id(),a=t.value;return typeof n==typeof a&&n>=a}],"filter-has":[We,[ct],(r,[t])=>t.value in r.properties()],"filter-has-id":[We,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[We,[yr(Je)],(r,[t])=>t.value.indexOf(r.geometryType())>=0],"filter-id-in":[We,[yr(ct)],(r,[t])=>t.value.indexOf(r.id())>=0],"filter-in-small":[We,[Je,yr(ct)],(r,[t,n])=>n.value.indexOf(r.properties()[t.value])>=0],"filter-in-large":[We,[Je,yr(ct)],(r,[t,n])=>function(a,l,d,p){for(;d<=p;){const m=d+p>>1;if(l[m]===a)return!0;l[m]>a?p=m-1:d=m+1}return!1}(r.properties()[t.value],n.value,0,n.value.length-1)],all:{type:We,overloads:[[[We,We],(r,[t,n])=>t.evaluate(r)&&n.evaluate(r)],[Un(We),(r,t)=>{for(const n of t)if(!n.evaluate(r))return!1;return!0}]]},any:{type:We,overloads:[[[We,We],(r,[t,n])=>t.evaluate(r)||n.evaluate(r)],[Un(We),(r,t)=>{for(const n of t)if(n.evaluate(r))return!0;return!1}]]},"!":[We,[We],(r,[t])=>!t.evaluate(r)],"is-supported-script":[We,[Je],(r,[t])=>{const n=r.globals&&r.globals.isSupportedScript;return!n||n(t.evaluate(r))}],upcase:[Je,[Je],(r,[t])=>t.evaluate(r).toUpperCase()],downcase:[Je,[Je],(r,[t])=>t.evaluate(r).toLowerCase()],concat:[Je,Un(ct),(r,t)=>t.map(n=>Mn(n.evaluate(r))).join("")],"resolved-locale":[Je,[Ln],(r,[t])=>t.evaluate(r).resolvedLocale()]});class Xo{constructor(t,n){var a;this.expression=t,this._warningHistory={},this._evaluator=new fs,this._defaultValue=n?(a=n).type==="color"&&Ds(a.default)?new $t(0,0,0,0):a.type==="color"?$t.parse(a.default)||null:a.type==="padding"?Wi.parse(a.default)||null:a.type==="variableAnchorOffsetCollection"?Xi.parse(a.default)||null:a.type==="projectionDefinition"?vr.parse(a.default)||null:a.default===void 0?null:a.default:null,this._enumValues=n&&n.type==="enum"?n.values:null}evaluateWithoutErrorHandling(t,n,a,l,d,p){return this._evaluator.globals=t,this._evaluator.feature=n,this._evaluator.featureState=a,this._evaluator.canonical=l,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=p,this.expression.evaluate(this._evaluator)}evaluate(t,n,a,l,d,p){this._evaluator.globals=t,this._evaluator.feature=n||null,this._evaluator.featureState=a||null,this._evaluator.canonical=l,this._evaluator.availableImages=d||null,this._evaluator.formattedSection=p||null;try{const m=this.expression.evaluate(this._evaluator);if(m==null||typeof m=="number"&&m!=m)return this._defaultValue;if(this._enumValues&&!(m in this._enumValues))throw new Pi(`Expected value to be one of ${Object.keys(this._enumValues).map(_=>JSON.stringify(_)).join(", ")}, but found ${JSON.stringify(m)} instead.`);return m}catch(m){return this._warningHistory[m.message]||(this._warningHistory[m.message]=!0,typeof console<"u"&&console.warn(m.message)),this._defaultValue}}}function Rs(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in pa}function Gn(r,t){const n=new Ot(pa,As,[],t?function(l){const d={color:It,string:Je,number:be,enum:Je,boolean:We,formatted:Bi,padding:Ni,projectionDefinition:yt,resolvedImage:pi,variableAnchorOffsetCollection:hs};return l.type==="array"?yr(d[l.value]||ct,l.length):d[l.type]}(t):void 0),a=n.parse(r,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return a?lc(new Xo(a,t)):fa(n.errors)}class Ls{constructor(t,n){this.kind=t,this._styleExpression=n,this.isStateDependent=t!=="constant"&&!Na(n.expression)}evaluateWithoutErrorHandling(t,n,a,l,d,p){return this._styleExpression.evaluateWithoutErrorHandling(t,n,a,l,d,p)}evaluate(t,n,a,l,d,p){return this._styleExpression.evaluate(t,n,a,l,d,p)}}class Ko{constructor(t,n,a,l){this.kind=t,this.zoomStops=a,this._styleExpression=n,this.isStateDependent=t!=="camera"&&!Na(n.expression),this.interpolationType=l}evaluateWithoutErrorHandling(t,n,a,l,d,p){return this._styleExpression.evaluateWithoutErrorHandling(t,n,a,l,d,p)}evaluate(t,n,a,l,d,p){return this._styleExpression.evaluate(t,n,a,l,d,p)}interpolationFactor(t,n,a){return this.interpolationType?cr.interpolationFactor(this.interpolationType,t,n,a):0}}function pc(r,t){const n=Gn(r,t);if(n.result==="error")return n;const a=n.value.expression,l=ks(a);if(!l&&!ma(t))return fa([new Ke("","data expressions not supported")]);const d=zs(a,["zoom"]);if(!d&&!cc(t))return fa([new Ke("","zoom expressions not supported")]);const p=Bs(a);return p||d?p instanceof Ke?fa([p]):p instanceof cr&&!Wo(t)?fa([new Ke("",'"interpolate" expressions cannot be used with this property')]):lc(p?new Ko(l?"camera":"composite",n.value,p.labels,p instanceof cr?p.interpolation:void 0):new Ls(l?"constant":"source",n.value)):fa([new Ke("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Fs{constructor(t,n){this._parameters=t,this._specification=n,Fe(this,hc(this._parameters,this._specification))}static deserialize(t){return new Fs(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Bs(r){let t=null;if(r instanceof Ct)t=Bs(r.result);else if(r instanceof zi){for(const n of r.args)if(t=Bs(n),t)break}else(r instanceof ua||r instanceof cr)&&r.input instanceof Nr&&r.input.name==="zoom"&&(t=r);return t instanceof Ke||r.eachChild(n=>{const a=Bs(n);a instanceof Ke?t=a:!t&&a?t=new Ke("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&a&&t!==a&&(t=new Ke("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function Yo(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const t of r.slice(1))if(!Yo(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}const fc={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Os(r){if(r==null)return{filter:()=>!0,needGeometry:!1};Yo(r)||(r=Za(r));const t=Gn(r,fc);if(t.result==="error")throw new Error(t.value.map(n=>`${n.key}: ${n.message}`).join(", "));return{filter:(n,a,l)=>t.value.evaluate(n,a,{},l),needGeometry:mc(r)}}function Ch(r,t){return r<t?-1:r>t?1:0}function mc(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let t=1;t<r.length;t++)if(mc(r[t]))return!0;return!1}function Za(r){if(!r)return!0;const t=r[0];return r.length<=1?t!=="any":t==="=="?js(r[1],r[2],"=="):t==="!="?ga(js(r[1],r[2],"==")):t==="<"||t===">"||t==="<="||t===">="?js(r[1],r[2],t):t==="any"?(n=r.slice(1),["any"].concat(n.map(Za))):t==="all"?["all"].concat(r.slice(1).map(Za)):t==="none"?["all"].concat(r.slice(1).map(Za).map(ga)):t==="in"?Jo(r[1],r.slice(2)):t==="!in"?ga(Jo(r[1],r.slice(2))):t==="has"?Qo(r[1]):t!=="!has"||ga(Qo(r[1]));var n}function js(r,t,n){switch(r){case"$type":return[`filter-type-${n}`,t];case"$id":return[`filter-id-${n}`,t];default:return[`filter-${n}`,r,t]}}function Jo(r,t){if(t.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(n=>typeof n!=typeof t[0])?["filter-in-large",r,["literal",t.sort(Ch)]]:["filter-in-small",r,["literal",t]]}}function Qo(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function ga(r){return["!",r]}function Ua(r){const t=typeof r;if(t==="number"||t==="boolean"||t==="string"||r==null)return JSON.stringify(r);if(Array.isArray(r)){let l="[";for(const d of r)l+=`${Ua(d)},`;return`${l}]`}const n=Object.keys(r).sort();let a="{";for(let l=0;l<n.length;l++)a+=`${JSON.stringify(n[l])}:${Ua(r[n[l]])},`;return`${a}}`}function el(r){let t="";for(const n of L)t+=`/${Ua(r[n])}`;return t}function $a(r){const t=r.value;return t?[new ce(r.key,t,"constants have been deprecated as of v8")]:[]}function Ei(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function qn(r){if(Array.isArray(r))return r.map(qn);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const t={};for(const n in r)t[n]=qn(r[n]);return t}return Ei(r)}function Zr(r){const t=r.key,n=r.value,a=r.valueSpec||{},l=r.objectElementValidators||{},d=r.style,p=r.styleSpec,m=r.validateSpec;let _=[];const v=Gt(n);if(v!=="object")return[new ce(t,n,`object expected, ${v} found`)];for(const b in n){const w=b.split(".")[0],C=a[w]||a["*"];let A;if(l[w])A=l[w];else if(a[w])A=m;else if(l["*"])A=l["*"];else{if(!a["*"]){_.push(new ce(t,n[b],`unknown property "${b}"`));continue}A=m}_=_.concat(A({key:(t&&`${t}.`)+b,value:n[b],valueSpec:C,style:d,styleSpec:p,object:n,objectKey:b,validateSpec:m},n))}for(const b in a)l[b]||a[b].required&&a[b].default===void 0&&n[b]===void 0&&_.push(new ce(t,n,`missing required property "${b}"`));return _}function tl(r){const t=r.value,n=r.valueSpec,a=r.style,l=r.styleSpec,d=r.key,p=r.arrayElementValidator||r.validateSpec;if(Gt(t)!=="array")return[new ce(d,t,`array expected, ${Gt(t)} found`)];if(n.length&&t.length!==n.length)return[new ce(d,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new ce(d,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let m={type:n.value,values:n.values};l.$version<7&&(m.function=n.function),Gt(n.value)==="object"&&(m=n.value);let _=[];for(let v=0;v<t.length;v++)_=_.concat(p({array:t,arrayIndex:v,value:t[v],valueSpec:m,validateSpec:r.validateSpec,style:a,styleSpec:l,key:`${d}[${v}]`}));return _}function il(r){const t=r.key,n=r.value,a=r.valueSpec;let l=Gt(n);return l==="number"&&n!=n&&(l="NaN"),l!=="number"?[new ce(t,n,`number expected, ${l} found`)]:"minimum"in a&&n<a.minimum?[new ce(t,n,`${n} is less than the minimum value ${a.minimum}`)]:"maximum"in a&&n>a.maximum?[new ce(t,n,`${n} is greater than the maximum value ${a.maximum}`)]:[]}function gc(r){const t=r.valueSpec,n=Ei(r.value.type);let a,l,d,p={};const m=n!=="categorical"&&r.value.property===void 0,_=!m,v=Gt(r.value.stops)==="array"&&Gt(r.value.stops[0])==="array"&&Gt(r.value.stops[0][0])==="object",b=Zr({key:r.key,value:r.value,valueSpec:r.styleSpec.function,validateSpec:r.validateSpec,style:r.style,styleSpec:r.styleSpec,objectElementValidators:{stops:function(A){if(n==="identity")return[new ce(A.key,A.value,'identity function may not have a "stops" property')];let k=[];const D=A.value;return k=k.concat(tl({key:A.key,value:D,valueSpec:A.valueSpec,validateSpec:A.validateSpec,style:A.style,styleSpec:A.styleSpec,arrayElementValidator:w})),Gt(D)==="array"&&D.length===0&&k.push(new ce(A.key,D,"array must have at least one stop")),k},default:function(A){return A.validateSpec({key:A.key,value:A.value,valueSpec:t,validateSpec:A.validateSpec,style:A.style,styleSpec:A.styleSpec})}}});return n==="identity"&&m&&b.push(new ce(r.key,r.value,'missing required property "property"')),n==="identity"||r.value.stops||b.push(new ce(r.key,r.value,'missing required property "stops"')),n==="exponential"&&r.valueSpec.expression&&!Wo(r.valueSpec)&&b.push(new ce(r.key,r.value,"exponential functions not supported")),r.styleSpec.$version>=8&&(_&&!ma(r.valueSpec)?b.push(new ce(r.key,r.value,"property functions not supported")):m&&!cc(r.valueSpec)&&b.push(new ce(r.key,r.value,"zoom functions not supported"))),n!=="categorical"&&!v||r.value.property!==void 0||b.push(new ce(r.key,r.value,'"property" property is required')),b;function w(A){let k=[];const D=A.value,B=A.key;if(Gt(D)!=="array")return[new ce(B,D,`array expected, ${Gt(D)} found`)];if(D.length!==2)return[new ce(B,D,`array length 2 expected, length ${D.length} found`)];if(v){if(Gt(D[0])!=="object")return[new ce(B,D,`object expected, ${Gt(D[0])} found`)];if(D[0].zoom===void 0)return[new ce(B,D,"object stop key must have zoom")];if(D[0].value===void 0)return[new ce(B,D,"object stop key must have value")];if(d&&d>Ei(D[0].zoom))return[new ce(B,D[0].zoom,"stop zoom values must appear in ascending order")];Ei(D[0].zoom)!==d&&(d=Ei(D[0].zoom),l=void 0,p={}),k=k.concat(Zr({key:`${B}[0]`,value:D[0],valueSpec:{zoom:{}},validateSpec:A.validateSpec,style:A.style,styleSpec:A.styleSpec,objectElementValidators:{zoom:il,value:C}}))}else k=k.concat(C({key:`${B}[0]`,value:D[0],validateSpec:A.validateSpec,style:A.style,styleSpec:A.styleSpec},D));return Rs(qn(D[1]))?k.concat([new ce(`${B}[1]`,D[1],"expressions are not allowed in function stops.")]):k.concat(A.validateSpec({key:`${B}[1]`,value:D[1],valueSpec:t,validateSpec:A.validateSpec,style:A.style,styleSpec:A.styleSpec}))}function C(A,k){const D=Gt(A.value),B=Ei(A.value),U=A.value!==null?A.value:k;if(a){if(D!==a)return[new ce(A.key,U,`${D} stop domain type must match previous stop domain type ${a}`)]}else a=D;if(D!=="number"&&D!=="string"&&D!=="boolean")return[new ce(A.key,U,"stop domain value must be a number, string, or boolean")];if(D!=="number"&&n!=="categorical"){let ee=`number expected, ${D} found`;return ma(t)&&n===void 0&&(ee+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ce(A.key,U,ee)]}return n!=="categorical"||D!=="number"||isFinite(B)&&Math.floor(B)===B?n!=="categorical"&&D==="number"&&l!==void 0&&B<l?[new ce(A.key,U,"stop domain values must appear in ascending order")]:(l=B,n==="categorical"&&B in p?[new ce(A.key,U,"stop domain values must be unique")]:(p[B]=!0,[])):[new ce(A.key,U,`integer expected, found ${B}`)]}}function Hn(r){const t=(r.expressionContext==="property"?pc:Gn)(qn(r.value),r.valueSpec);if(t.result==="error")return t.value.map(a=>new ce(`${r.key}${a.key}`,r.value,a.message));const n=t.value.expression||t.value._styleExpression.expression;if(r.expressionContext==="property"&&r.propertyKey==="text-font"&&!n.outputDefined())return[new ce(r.key,r.value,`Invalid data expression for "${r.propertyKey}". Output values must be contained as literals within the expression.`)];if(r.expressionContext==="property"&&r.propertyType==="layout"&&!Na(n))return[new ce(r.key,r.value,'"feature-state" data expressions are not supported with layout properties.')];if(r.expressionContext==="filter"&&!Na(n))return[new ce(r.key,r.value,'"feature-state" data expressions are not supported with filters.')];if(r.expressionContext&&r.expressionContext.indexOf("cluster")===0){if(!zs(n,["zoom","feature-state"]))return[new ce(r.key,r.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(r.expressionContext==="cluster-initial"&&!ks(n))return[new ce(r.key,r.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function _a(r){const t=r.key,n=r.value,a=r.valueSpec,l=[];return Array.isArray(a.values)?a.values.indexOf(Ei(n))===-1&&l.push(new ce(t,n,`expected one of [${a.values.join(", ")}], ${JSON.stringify(n)} found`)):Object.keys(a.values).indexOf(Ei(n))===-1&&l.push(new ce(t,n,`expected one of [${Object.keys(a.values).join(", ")}], ${JSON.stringify(n)} found`)),l}function ya(r){return Yo(qn(r.value))?Hn(Fe({},r,{expressionContext:"filter",valueSpec:{value:"boolean"}})):_c(r)}function _c(r){const t=r.value,n=r.key;if(Gt(t)!=="array")return[new ce(n,t,`array expected, ${Gt(t)} found`)];const a=r.styleSpec;let l,d=[];if(t.length<1)return[new ce(n,t,"filter array must have at least 1 element")];switch(d=d.concat(_a({key:`${n}[0]`,value:t[0],valueSpec:a.filter_operator,style:r.style,styleSpec:r.styleSpec})),Ei(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&Ei(t[1])==="$type"&&d.push(new ce(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&d.push(new ce(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(l=Gt(t[1]),l!=="string"&&d.push(new ce(`${n}[1]`,t[1],`string expected, ${l} found`)));for(let p=2;p<t.length;p++)l=Gt(t[p]),Ei(t[1])==="$type"?d=d.concat(_a({key:`${n}[${p}]`,value:t[p],valueSpec:a.geometry_type,style:r.style,styleSpec:r.styleSpec})):l!=="string"&&l!=="number"&&l!=="boolean"&&d.push(new ce(`${n}[${p}]`,t[p],`string, number, or boolean expected, ${l} found`));break;case"any":case"all":case"none":for(let p=1;p<t.length;p++)d=d.concat(_c({key:`${n}[${p}]`,value:t[p],style:r.style,styleSpec:r.styleSpec}));break;case"has":case"!has":l=Gt(t[1]),t.length!==2?d.push(new ce(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):l!=="string"&&d.push(new ce(`${n}[1]`,t[1],`string expected, ${l} found`))}return d}function rl(r,t){const n=r.key,a=r.validateSpec,l=r.style,d=r.styleSpec,p=r.value,m=r.objectKey,_=d[`${t}_${r.layerType}`];if(!_)return[];const v=m.match(/^(.*)-transition$/);if(t==="paint"&&v&&_[v[1]]&&_[v[1]].transition)return a({key:n,value:p,valueSpec:d.transition,style:l,styleSpec:d});const b=r.valueSpec||_[m];if(!b)return[new ce(n,p,`unknown property "${m}"`)];let w;if(Gt(p)==="string"&&ma(b)&&!b.tokens&&(w=/^{([^}]+)}$/.exec(p)))return[new ce(n,p,`"${m}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(w[1])} }\`.`)];const C=[];return r.layerType==="symbol"&&(m==="text-field"&&l&&!l.glyphs&&C.push(new ce(n,p,'use of "text-field" requires a style "glyphs" property')),m==="text-font"&&Ds(qn(p))&&Ei(p.type)==="identity"&&C.push(new ce(n,p,'"text-font" does not support identity functions'))),C.concat(a({key:r.key,value:p,valueSpec:b,style:l,styleSpec:d,expressionContext:"property",propertyType:t,propertyKey:m}))}function nl(r){return rl(r,"paint")}function yc(r){return rl(r,"layout")}function al(r){let t=[];const n=r.value,a=r.key,l=r.style,d=r.styleSpec;n.type||n.ref||t.push(new ce(a,n,'either "type" or "ref" is required'));let p=Ei(n.type);const m=Ei(n.ref);if(n.id){const _=Ei(n.id);for(let v=0;v<r.arrayIndex;v++){const b=l.layers[v];Ei(b.id)===_&&t.push(new ce(a,n.id,`duplicate layer id "${n.id}", previously used at line ${b.id.__line__}`))}}if("ref"in n){let _;["type","source","source-layer","filter","layout"].forEach(v=>{v in n&&t.push(new ce(a,n[v],`"${v}" is prohibited for ref layers`))}),l.layers.forEach(v=>{Ei(v.id)===m&&(_=v)}),_?_.ref?t.push(new ce(a,n.ref,"ref cannot reference another ref layer")):p=Ei(_.type):t.push(new ce(a,n.ref,`ref layer "${m}" not found`))}else if(p!=="background")if(n.source){const _=l.sources&&l.sources[n.source],v=_&&Ei(_.type);_?v==="vector"&&p==="raster"?t.push(new ce(a,n.source,`layer "${n.id}" requires a raster source`)):v!=="raster-dem"&&p==="hillshade"?t.push(new ce(a,n.source,`layer "${n.id}" requires a raster-dem source`)):v==="raster"&&p!=="raster"?t.push(new ce(a,n.source,`layer "${n.id}" requires a vector source`)):v!=="vector"||n["source-layer"]?v==="raster-dem"&&p!=="hillshade"?t.push(new ce(a,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):p!=="line"||!n.paint||!n.paint["line-gradient"]||v==="geojson"&&_.lineMetrics||t.push(new ce(a,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new ce(a,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new ce(a,n.source,`source "${n.source}" not found`))}else t.push(new ce(a,n,'missing required property "source"'));return t=t.concat(Zr({key:a,value:n,valueSpec:d.layer,style:r.style,styleSpec:r.styleSpec,validateSpec:r.validateSpec,objectElementValidators:{"*":()=>[],type:()=>r.validateSpec({key:`${a}.type`,value:n.type,valueSpec:d.layer.type,style:r.style,styleSpec:r.styleSpec,validateSpec:r.validateSpec,object:n,objectKey:"type"}),filter:ya,layout:_=>Zr({layer:n,key:_.key,value:_.value,style:_.style,styleSpec:_.styleSpec,validateSpec:_.validateSpec,objectElementValidators:{"*":v=>yc(Fe({layerType:p},v))}}),paint:_=>Zr({layer:n,key:_.key,value:_.value,style:_.style,styleSpec:_.styleSpec,validateSpec:_.validateSpec,objectElementValidators:{"*":v=>nl(Fe({layerType:p},v))}})}})),t}function Cn(r){const t=r.value,n=r.key,a=Gt(t);return a!=="string"?[new ce(n,t,`string expected, ${a} found`)]:[]}const va={promoteId:function({key:r,value:t}){if(Gt(t)==="string")return Cn({key:r,value:t});{const n=[];for(const a in t)n.push(...Cn({key:`${r}.${a}`,value:t[a]}));return n}}};function vc(r){const t=r.value,n=r.key,a=r.styleSpec,l=r.style,d=r.validateSpec;if(!t.type)return[new ce(n,t,'"type" is required')];const p=Ei(t.type);let m;switch(p){case"vector":case"raster":return m=Zr({key:n,value:t,valueSpec:a[`source_${p.replace("-","_")}`],style:r.style,styleSpec:a,objectElementValidators:va,validateSpec:d}),m;case"raster-dem":return m=function(_){var v;const b=(v=_.sourceName)!==null&&v!==void 0?v:"",w=_.value,C=_.styleSpec,A=C.source_raster_dem,k=_.style;let D=[];const B=Gt(w);if(w===void 0)return D;if(B!=="object")return D.push(new ce("source_raster_dem",w,`object expected, ${B} found`)),D;const U=Ei(w.encoding)==="custom",ee=["redFactor","greenFactor","blueFactor","baseShift"],G=_.value.encoding?`"${_.value.encoding}"`:"Default";for(const E in w)!U&&ee.includes(E)?D.push(new ce(E,w[E],`In "${b}": "${E}" is only valid when "encoding" is set to "custom". ${G} encoding found`)):A[E]?D=D.concat(_.validateSpec({key:E,value:w[E],valueSpec:A[E],validateSpec:_.validateSpec,style:k,styleSpec:C})):D.push(new ce(E,w[E],`unknown property "${E}"`));return D}({sourceName:n,value:t,style:r.style,styleSpec:a,validateSpec:d}),m;case"geojson":if(m=Zr({key:n,value:t,valueSpec:a.source_geojson,style:l,styleSpec:a,validateSpec:d,objectElementValidators:va}),t.cluster)for(const _ in t.clusterProperties){const[v,b]=t.clusterProperties[_],w=typeof v=="string"?[v,["accumulated"],["get",_]]:v;m.push(...Hn({key:`${n}.${_}.map`,value:b,expressionContext:"cluster-map"})),m.push(...Hn({key:`${n}.${_}.reduce`,value:w,expressionContext:"cluster-reduce"}))}return m;case"video":return Zr({key:n,value:t,valueSpec:a.source_video,style:l,validateSpec:d,styleSpec:a});case"image":return Zr({key:n,value:t,valueSpec:a.source_image,style:l,validateSpec:d,styleSpec:a});case"canvas":return[new ce(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return _a({key:`${n}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function xc(r){const t=r.value,n=r.styleSpec,a=n.light,l=r.style;let d=[];const p=Gt(t);if(t===void 0)return d;if(p!=="object")return d=d.concat([new ce("light",t,`object expected, ${p} found`)]),d;for(const m in t){const _=m.match(/^(.*)-transition$/);d=d.concat(_&&a[_[1]]&&a[_[1]].transition?r.validateSpec({key:m,value:t[m],valueSpec:n.transition,validateSpec:r.validateSpec,style:l,styleSpec:n}):a[m]?r.validateSpec({key:m,value:t[m],valueSpec:a[m],validateSpec:r.validateSpec,style:l,styleSpec:n}):[new ce(m,t[m],`unknown property "${m}"`)])}return d}function bc(r){const t=r.value,n=r.styleSpec,a=n.sky,l=r.style,d=Gt(t);if(t===void 0)return[];if(d!=="object")return[new ce("sky",t,`object expected, ${d} found`)];let p=[];for(const m in t)p=p.concat(a[m]?r.validateSpec({key:m,value:t[m],valueSpec:a[m],style:l,styleSpec:n}):[new ce(m,t[m],`unknown property "${m}"`)]);return p}function wc(r){const t=r.value,n=r.styleSpec,a=n.terrain,l=r.style;let d=[];const p=Gt(t);if(t===void 0)return d;if(p!=="object")return d=d.concat([new ce("terrain",t,`object expected, ${p} found`)]),d;for(const m in t)d=d.concat(a[m]?r.validateSpec({key:m,value:t[m],valueSpec:a[m],validateSpec:r.validateSpec,style:l,styleSpec:n}):[new ce(m,t[m],`unknown property "${m}"`)]);return d}function Tc(r){let t=[];const n=r.value,a=r.key;if(Array.isArray(n)){const l=[],d=[];for(const p in n)n[p].id&&l.includes(n[p].id)&&t.push(new ce(a,n,`all the sprites' ids must be unique, but ${n[p].id} is duplicated`)),l.push(n[p].id),n[p].url&&d.includes(n[p].url)&&t.push(new ce(a,n,`all the sprites' URLs must be unique, but ${n[p].url} is duplicated`)),d.push(n[p].url),t=t.concat(Zr({key:`${a}[${p}]`,value:n[p],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:r.validateSpec}));return t}return Cn({key:a,value:n})}const Pc={"*":()=>[],array:tl,boolean:function(r){const t=r.value,n=r.key,a=Gt(t);return a!=="boolean"?[new ce(n,t,`boolean expected, ${a} found`)]:[]},number:il,color:function(r){const t=r.key,n=r.value,a=Gt(n);return a!=="string"?[new ce(t,n,`color expected, ${a} found`)]:$t.parse(String(n))?[]:[new ce(t,n,`color expected, "${n}" found`)]},constants:$a,enum:_a,filter:ya,function:gc,layer:al,object:Zr,source:vc,light:xc,sky:bc,terrain:wc,projection:function(r){const t=r.value,n=r.styleSpec,a=n.projection,l=r.style,d=Gt(t);if(t===void 0)return[];if(d!=="object")return[new ce("projection",t,`object expected, ${d} found`)];let p=[];for(const m in t)p=p.concat(a[m]?r.validateSpec({key:m,value:t[m],valueSpec:a[m],style:l,styleSpec:n}):[new ce(m,t[m],`unknown property "${m}"`)]);return p},projectionDefinition:function(r){const t=r.key;let n=r.value;n=n instanceof String?n.valueOf():n;const a=Gt(n);return a!=="array"||function(l){return Array.isArray(l)&&l.length===3&&typeof l[0]=="string"&&typeof l[1]=="string"&&typeof l[2]=="number"}(n)||function(l){return!!["interpolate","step","literal"].includes(l[0])}(n)?["array","string"].includes(a)?[]:[new ce(t,n,`projection expected, invalid type "${a}" found`)]:[new ce(t,n,`projection expected, invalid array ${JSON.stringify(n)} found`)]},string:Cn,formatted:function(r){return Cn(r).length===0?[]:Hn(r)},resolvedImage:function(r){return Cn(r).length===0?[]:Hn(r)},padding:function(r){const t=r.key,n=r.value;if(Gt(n)==="array"){if(n.length<1||n.length>4)return[new ce(t,n,`padding requires 1 to 4 values; ${n.length} values found`)];const a={type:"number"};let l=[];for(let d=0;d<n.length;d++)l=l.concat(r.validateSpec({key:`${t}[${d}]`,value:n[d],validateSpec:r.validateSpec,valueSpec:a}));return l}return il({key:t,value:n,valueSpec:{}})},variableAnchorOffsetCollection:function(r){const t=r.key,n=r.value,a=Gt(n),l=r.styleSpec;if(a!=="array"||n.length<1||n.length%2!=0)return[new ce(t,n,"variableAnchorOffsetCollection requires a non-empty array of even length")];let d=[];for(let p=0;p<n.length;p+=2)d=d.concat(_a({key:`${t}[${p}]`,value:n[p],valueSpec:l.layout_symbol["text-anchor"]})),d=d.concat(tl({key:`${t}[${p+1}]`,value:n[p+1],valueSpec:{length:2,value:"number"},validateSpec:r.validateSpec,style:r.style,styleSpec:l}));return d},sprite:Tc};function In(r){const t=r.value,n=r.valueSpec,a=r.styleSpec;return r.validateSpec=In,n.expression&&Ds(Ei(t))?gc(r):n.expression&&Rs(qn(t))?Hn(r):n.type&&Pc[n.type]?Pc[n.type](r):Zr(Fe({},r,{valueSpec:n.type?a[n.type]:n}))}function xa(r){const t=r.value,n=r.key,a=Cn(r);return a.length||(t.indexOf("{fontstack}")===-1&&a.push(new ce(n,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&a.push(new ce(n,t,'"glyphs" url must include a "{range}" token'))),a}function Mi(r,t=P){let n=[];return n=n.concat(In({key:"",value:r,valueSpec:t.$root,styleSpec:t,style:r,validateSpec:In,objectElementValidators:{glyphs:xa,"*":()=>[]}})),r.constants&&(n=n.concat($a({key:"constants",value:r.constants}))),sl(n)}function br(r){return function(t){return r({...t,validateSpec:In})}}function sl(r){return[].concat(r).sort((t,n)=>t.line-n.line)}function on(r){return function(...t){return sl(r.apply(this,t))}}Mi.source=on(br(vc)),Mi.sprite=on(br(Tc)),Mi.glyphs=on(br(xa)),Mi.light=on(br(xc)),Mi.sky=on(br(bc)),Mi.terrain=on(br(wc)),Mi.layer=on(br(al)),Mi.filter=on(br(ya)),Mi.paintProperty=on(br(nl)),Mi.layoutProperty=on(br(yc));const ba=Mi,Ga=ba.light,Mc=ba.sky,ol=ba.paintProperty,Ih=ba.layoutProperty;function Vs(r,t){let n=!1;if(t&&t.length)for(const a of t)r.fire(new hi(new Error(a.message))),n=!0;return n}class qa{constructor(t,n,a){const l=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;const p=new Int32Array(this.arrayBuffer);t=p[0],this.d=(n=p[1])+2*(a=p[2]);for(let _=0;_<this.d*this.d;_++){const v=p[3+_],b=p[3+_+1];l.push(v===b?null:p.subarray(v,b))}const m=p[3+l.length+1];this.keys=p.subarray(p[3+l.length],m),this.bboxes=p.subarray(m),this.insert=this._insertReadonly}else{this.d=n+2*a;for(let p=0;p<this.d*this.d;p++)l.push([]);this.keys=[],this.bboxes=[]}this.n=n,this.extent=t,this.padding=a,this.scale=n/t,this.uid=0;const d=a/n*t;this.min=-d,this.max=t+d}insert(t,n,a,l,d){this._forEachCell(n,a,l,d,this._insertCell,this.uid++,void 0,void 0),this.keys.push(t),this.bboxes.push(n),this.bboxes.push(a),this.bboxes.push(l),this.bboxes.push(d)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(t,n,a,l,d,p){this.cells[d].push(p)}query(t,n,a,l,d){const p=this.min,m=this.max;if(t<=p&&n<=p&&m<=a&&m<=l&&!d)return Array.prototype.slice.call(this.keys);{const _=[];return this._forEachCell(t,n,a,l,this._queryCell,_,{},d),_}}_queryCell(t,n,a,l,d,p,m,_){const v=this.cells[d];if(v!==null){const b=this.keys,w=this.bboxes;for(let C=0;C<v.length;C++){const A=v[C];if(m[A]===void 0){const k=4*A;(_?_(w[k+0],w[k+1],w[k+2],w[k+3]):t<=w[k+2]&&n<=w[k+3]&&a>=w[k+0]&&l>=w[k+1])?(m[A]=!0,p.push(b[A])):m[A]=!1}}}}_forEachCell(t,n,a,l,d,p,m,_){const v=this._convertToCellCoord(t),b=this._convertToCellCoord(n),w=this._convertToCellCoord(a),C=this._convertToCellCoord(l);for(let A=v;A<=w;A++)for(let k=b;k<=C;k++){const D=this.d*k+A;if((!_||_(this._convertFromCellCoord(A),this._convertFromCellCoord(k),this._convertFromCellCoord(A+1),this._convertFromCellCoord(k+1)))&&d.call(this,t,n,a,l,D,p,m,_))return}}_convertFromCellCoord(t){return(t-this.padding)/this.scale}_convertToCellCoord(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const t=this.cells,n=3+this.cells.length+1+1;let a=0;for(let p=0;p<this.cells.length;p++)a+=this.cells[p].length;const l=new Int32Array(n+a+this.keys.length+this.bboxes.length);l[0]=this.extent,l[1]=this.n,l[2]=this.padding;let d=n;for(let p=0;p<t.length;p++){const m=t[p];l[3+p]=d,l.set(m,d),d+=m.length}return l[3+t.length]=d,l.set(this.keys,d),d+=this.keys.length,l[3+t.length+1]=d,l.set(this.bboxes,d),d+=this.bboxes.length,l.buffer}static serialize(t,n){const a=t.toArrayBuffer();return n&&n.push(a),{buffer:a}}static deserialize(t){return new qa(t.buffer)}}const Er={};function qe(r,t,n={}){if(Er[r])throw new Error(`${r} is already registered.`);Object.defineProperty(t,"_classRegistryKey",{value:r,writeable:!1}),Er[r]={klass:t,omit:n.omit||[],shallow:n.shallow||[]}}qe("Object",Object),qe("TransferableGridIndex",qa),qe("Color",$t),qe("Error",Error),qe("AJAXError",Yt),qe("ResolvedImage",mr),qe("StylePropertyFunction",Fs),qe("StyleExpression",Xo,{omit:["_evaluator"]}),qe("ZoomDependentExpression",Ko),qe("ZoomConstantExpression",Ls),qe("CompoundExpression",Nr,{omit:["_evaluate"]});for(const r in pa)pa[r]._classRegistryKey||qe(`Expression_${r}`,pa[r]);function wa(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function ll(r){return r.$name||r.constructor._classRegistryKey}function Sc(r){return!function(t){if(t===null||typeof t!="object")return!1;const n=ll(t);return!(!n||n==="Object")}(r)&&(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||r instanceof Blob||r instanceof Error||wa(r)||Mr(r)||ArrayBuffer.isView(r)||r instanceof ImageData)}function En(r,t){if(Sc(r))return(wa(r)||Mr(r))&&t&&t.push(r),ArrayBuffer.isView(r)&&t&&t.push(r.buffer),r instanceof ImageData&&t&&t.push(r.data.buffer),r;if(Array.isArray(r)){const d=[];for(const p of r)d.push(En(p,t));return d}if(typeof r!="object")throw new Error("can't serialize object of type "+typeof r);const n=ll(r);if(!n)throw new Error(`can't serialize object of unregistered class ${r.constructor.name}`);if(!Er[n])throw new Error(`${n} is not registered.`);const{klass:a}=Er[n],l=a.serialize?a.serialize(r,t):{};if(a.serialize){if(t&&l===t[t.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const d in r){if(!r.hasOwnProperty(d)||Er[n].omit.indexOf(d)>=0)continue;const p=r[d];l[d]=Er[n].shallow.indexOf(d)>=0?p:En(p,t)}r instanceof Error&&(l.message=r.message)}if(l.$name)throw new Error("$name property is reserved for worker serialization logic.");return n!=="Object"&&(l.$name=n),l}function Ha(r){if(Sc(r))return r;if(Array.isArray(r))return r.map(Ha);if(typeof r!="object")throw new Error("can't deserialize object of type "+typeof r);const t=ll(r)||"Object";if(!Er[t])throw new Error(`can't deserialize unregistered class ${t}`);const{klass:n}=Er[t];if(!n)throw new Error(`can't deserialize unregistered class ${t}`);if(n.deserialize)return n.deserialize(r);const a=Object.create(n.prototype);for(const l of Object.keys(r)){if(l==="$name")continue;const d=r[l];a[l]=Er[t].shallow.indexOf(l)>=0?d:Ha(d)}return a}class Ns{constructor(){this.first=!0}update(t,n){const a=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=a,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=a,!0):(this.lastFloorZoom>a?(this.lastIntegerZoom=a+1,this.lastIntegerZoomTime=n):this.lastFloorZoom<a&&(this.lastIntegerZoom=a,this.lastIntegerZoomTime=n),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=a,!0))}}const At={"Latin-1 Supplement":r=>r>=128&&r<=255,"Hangul Jamo":r=>r>=4352&&r<=4607,Khmer:r=>r>=6016&&r<=6143,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Kanbun:r=>r>=12688&&r<=12703,"CJK Strokes":r=>r>=12736&&r<=12783,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Hangul Syllables":r=>r>=44032&&r<=55215,"Private Use Area":r=>r>=57344&&r<=63743,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519};function Zs(r){for(const t of r)if(ul(t.charCodeAt(0)))return!0;return!1}function Cc(r){for(const t of r)if(!cl(t.charCodeAt(0)))return!1;return!0}function Us(r){const t=r.map(n=>{try{return new RegExp(`\\p{sc=${n}}`,"u").source}catch{return null}}).filter(n=>n);return new RegExp(t.join("|"),"u")}const Ic=Us(["Arab","Dupl","Mong","Ougr","Syrc"]);function cl(r){return!Ic.test(String.fromCodePoint(r))}const hl=Us(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function ul(r){return!(r!==746&&r!==747&&(r<4352||!(At["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||At["CJK Compatibility"](r)||At["CJK Strokes"](r)||!(!At["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||At["Enclosed CJK Letters and Months"](r)||At["Ideographic Description Characters"](r)||At.Kanbun(r)||At.Katakana(r)&&r!==12540||!(!At["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!At["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||At["Vertical Forms"](r)||At["Yijing Hexagram Symbols"](r)||new RegExp("\\p{sc=Cans}","u").test(String.fromCodePoint(r))||new RegExp("\\p{sc=Hang}","u").test(String.fromCodePoint(r))||hl.test(String.fromCodePoint(r)))))}function dl(r){return!(ul(r)||function(t){return!!(At["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||At["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||At["Letterlike Symbols"](t)||At["Number Forms"](t)||At["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||At["Control Pictures"](t)&&t!==9251||At["Optical Character Recognition"](t)||At["Enclosed Alphanumerics"](t)||At["Geometric Shapes"](t)||At["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||At["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||At["CJK Symbols and Punctuation"](t)||At.Katakana(t)||At["Private Use Area"](t)||At["CJK Compatibility Forms"](t)||At["Small Form Variants"](t)||At["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(r))}const Eh=Us(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function pl(r){return Eh.test(String.fromCodePoint(r))}function Ec(r,t){return!(!t&&pl(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||At.Khmer(r))}function Ac(r){for(const t of r)if(pl(t.charCodeAt(0)))return!0;return!1}const An=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(r){this.pluginStatus=r.pluginStatus,this.pluginURL=r.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(r){if(An.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=r.applyArabicShaping,this.processBidirectionalText=r.processBidirectionalText,this.processStyledBidirectionalText=r.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(r,t){return c(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(r.pluginStatus!=="loading")return this.setState(r),r;const n=r.pluginURL,a=new Promise(d=>{this.loadScriptResolve=d});t(n);const l=new Promise(d=>setTimeout(()=>d(),this.TIMEOUT));if(yield Promise.race([a,l]),this.isParsed()){const d={pluginStatus:"loaded",pluginURL:n};return this.setState(d),d}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${n}`)})}};class _i{constructor(t,n){this.zoom=t,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.zoomHistory=n.zoomHistory,this.transition=n.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Ns,this.transition={})}isSupportedScript(t){return function(n,a){for(const l of n)if(!Ec(l.charCodeAt(0),a))return!1;return!0}(t,An.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,n=t-Math.floor(t),a=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:n+(1-n)*a}:{fromScale:.5,toScale:1,t:1-(1-a)*n}}}class Wa{constructor(t,n){this.property=t,this.value=n,this.expression=function(a,l){if(Ds(a))return new Fs(a,l);if(Rs(a)){const d=pc(a,l);if(d.result==="error")throw new Error(d.value.map(p=>`${p.key}: ${p.message}`).join(", "));return d.value}{let d=a;return l.type==="color"&&typeof a=="string"?d=$t.parse(a):l.type!=="padding"||typeof a!="number"&&!Array.isArray(a)?l.type==="variableAnchorOffsetCollection"&&Array.isArray(a)?d=Xi.parse(a):l.type==="projectionDefinition"&&typeof a=="string"&&(d=vr.parse(a)):d=Wi.parse(a),{kind:"constant",evaluate:()=>d}}}(n===void 0?t.specification.default:n,t.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,n,a){return this.property.possiblyEvaluate(this,t,n,a)}}class $s{constructor(t){this.property=t,this.value=new Wa(t,void 0)}transitioned(t,n){return new ml(this.property,this.value,n,Ge({},t.transition,this.transition),t.now)}untransitioned(){return new ml(this.property,this.value,null,{},0)}}class fl{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return ti(this._values[t].value.value)}setValue(t,n){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new $s(this._values[t].property)),this._values[t].value=new Wa(this._values[t].property,n===null?void 0:ti(n))}getTransition(t){return ti(this._values[t].transition)}setTransition(t,n){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new $s(this._values[t].property)),this._values[t].transition=ti(n)||void 0}serialize(){const t={};for(const n of Object.keys(this._values)){const a=this.getValue(n);a!==void 0&&(t[n]=a);const l=this.getTransition(n);l!==void 0&&(t[`${n}-transition`]=l)}return t}transitioned(t,n){const a=new Xa(this._properties);for(const l of Object.keys(this._values))a._values[l]=this._values[l].transitioned(t,n._values[l]);return a}untransitioned(){const t=new Xa(this._properties);for(const n of Object.keys(this._values))t._values[n]=this._values[n].untransitioned();return t}}class ml{constructor(t,n,a,l,d){this.property=t,this.value=n,this.begin=d+l.delay||0,this.end=this.begin+l.duration||0,t.specification.transition&&(l.delay||l.duration)&&(this.prior=a)}possiblyEvaluate(t,n,a){const l=t.now||0,d=this.value.possiblyEvaluate(t,n,a),p=this.prior;if(p){if(l>this.end)return this.prior=null,d;if(this.value.isDataDriven())return this.prior=null,d;if(l<this.begin)return p.possiblyEvaluate(t,n,a);{const m=(l-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(t,n,a),d,Qt(m))}}return d}}class Xa{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,n,a){const l=new Gs(this._properties);for(const d of Object.keys(this._values))l._values[d]=this._values[d].possiblyEvaluate(t,n,a);return l}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class Ah{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}hasValue(t){return this._values[t].value!==void 0}getValue(t){return ti(this._values[t].value)}setValue(t,n){this._values[t]=new Wa(this._values[t].property,n===null?void 0:ti(n))}serialize(){const t={};for(const n of Object.keys(this._values)){const a=this.getValue(n);a!==void 0&&(t[n]=a)}return t}possiblyEvaluate(t,n,a){const l=new Gs(this._properties);for(const d of Object.keys(this._values))l._values[d]=this._values[d].possiblyEvaluate(t,n,a);return l}}class Ur{constructor(t,n,a){this.property=t,this.value=n,this.parameters=a}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,n,a,l){return this.property.evaluate(this.value,this.parameters,t,n,a,l)}}class Gs{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class at{constructor(t){this.specification=t}possiblyEvaluate(t,n){if(t.isDataDriven())throw new Error("Value should not be data driven");return t.expression.evaluate(n)}interpolate(t,n,a){const l=Ir[this.specification.type];return l?l(t,n,a):t}}class mt{constructor(t,n){this.specification=t,this.overrides=n}possiblyEvaluate(t,n,a,l){return new Ur(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(n,null,{},a,l)}:t.expression,n)}interpolate(t,n,a){if(t.value.kind!=="constant"||n.value.kind!=="constant")return t;if(t.value.value===void 0||n.value.value===void 0)return new Ur(this,{kind:"constant",value:void 0},t.parameters);const l=Ir[this.specification.type];if(l){const d=l(t.value.value,n.value.value,a);return new Ur(this,{kind:"constant",value:d},t.parameters)}return t}evaluate(t,n,a,l,d,p){return t.kind==="constant"?t.value:t.evaluate(n,a,l,d,p)}}class Ka extends mt{possiblyEvaluate(t,n,a,l){if(t.value===void 0)return new Ur(this,{kind:"constant",value:void 0},n);if(t.expression.kind==="constant"){const d=t.expression.evaluate(n,null,{},a,l),p=t.property.specification.type==="resolvedImage"&&typeof d!="string"?d.name:d,m=this._calculate(p,p,p,n);return new Ur(this,{kind:"constant",value:m},n)}if(t.expression.kind==="camera"){const d=this._calculate(t.expression.evaluate({zoom:n.zoom-1}),t.expression.evaluate({zoom:n.zoom}),t.expression.evaluate({zoom:n.zoom+1}),n);return new Ur(this,{kind:"constant",value:d},n)}return new Ur(this,t.expression,n)}evaluate(t,n,a,l,d,p){if(t.kind==="source"){const m=t.evaluate(n,a,l,d,p);return this._calculate(m,m,m,n)}return t.kind==="composite"?this._calculate(t.evaluate({zoom:Math.floor(n.zoom)-1},a,l),t.evaluate({zoom:Math.floor(n.zoom)},a,l),t.evaluate({zoom:Math.floor(n.zoom)+1},a,l),n):t.value}_calculate(t,n,a,l){return l.zoom>l.zoomHistory.lastIntegerZoom?{from:t,to:n}:{from:a,to:n}}interpolate(t){return t}}class qs{constructor(t){this.specification=t}possiblyEvaluate(t,n,a,l){if(t.value!==void 0){if(t.expression.kind==="constant"){const d=t.expression.evaluate(n,null,{},a,l);return this._calculate(d,d,d,n)}return this._calculate(t.expression.evaluate(new _i(Math.floor(n.zoom-1),n)),t.expression.evaluate(new _i(Math.floor(n.zoom),n)),t.expression.evaluate(new _i(Math.floor(n.zoom+1),n)),n)}}_calculate(t,n,a,l){return l.zoom>l.zoomHistory.lastIntegerZoom?{from:t,to:n}:{from:a,to:n}}interpolate(t){return t}}class gl{constructor(t){this.specification=t}possiblyEvaluate(t,n,a,l){return!!t.expression.evaluate(n,null,{},a,l)}interpolate(){return!1}}class wr{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const n in t){const a=t[n];a.specification.overridable&&this.overridableProperties.push(n);const l=this.defaultPropertyValues[n]=new Wa(a,void 0),d=this.defaultTransitionablePropertyValues[n]=new $s(a);this.defaultTransitioningPropertyValues[n]=d.untransitioned(),this.defaultPossiblyEvaluatedValues[n]=l.possiblyEvaluate({})}}}qe("DataDrivenProperty",mt),qe("DataConstantProperty",at),qe("CrossFadedDataDrivenProperty",Ka),qe("CrossFadedProperty",qs),qe("ColorRampProperty",gl);const kc="-transition";class ln extends se{constructor(t,n){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1},t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),n.layout&&(this._unevaluatedLayout=new Ah(n.layout)),n.paint)){this._transitionablePaint=new fl(n.paint);for(const a in t.paint)this.setPaintProperty(a,t.paint[a],{validate:!1});for(const a in t.layout)this.setLayoutProperty(a,t.layout[a],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Gs(n.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,n,a={}){n!=null&&this._validate(Ih,`layers.${this.id}.layout.${t}`,t,n,a)||(t!=="visibility"?this._unevaluatedLayout.setValue(t,n):this.visibility=n)}getPaintProperty(t){return t.endsWith(kc)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,n,a={}){if(n!=null&&this._validate(ol,`layers.${this.id}.paint.${t}`,t,n,a))return!1;if(t.endsWith(kc))return this._transitionablePaint.setTransition(t.slice(0,-11),n||void 0),!1;{const l=this._transitionablePaint._values[t],d=l.property.specification["property-type"]==="cross-faded-data-driven",p=l.value.isDataDriven(),m=l.value;this._transitionablePaint.setValue(t,n),this._handleSpecialPaintPropertyUpdate(t);const _=this._transitionablePaint._values[t].value;return _.isDataDriven()||p||d||this._handleOverridablePaintPropertyUpdate(t,m,_)}}_handleSpecialPaintPropertyUpdate(t){}_handleOverridablePaintPropertyUpdate(t,n,a){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,n){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,n)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),Zt(t,(n,a)=>!(n===void 0||a==="layout"&&!Object.keys(n).length||a==="paint"&&!Object.keys(n).length))}_validate(t,n,a,l,d={}){return(!d||d.validate!==!1)&&Vs(this,t.call(ba,{key:n,layerType:this.type,objectKey:a,value:l,styleSpec:P,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const n=this.paint.get(t);if(n instanceof Ur&&ma(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}}const kh={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class cn{constructor(t,n){this._structArray=t,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Si{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,n){return t._trim(),n&&(t.isTransferred=!0,n.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const n=Object.create(this.prototype);return n.arrayBuffer=t.arrayBuffer,n.length=t.length,n.capacity=t.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Di(r,t=1){let n=0,a=0;return{members:r.map(l=>{const d=kh[l.type].BYTES_PER_ELEMENT,p=n=zc(n,Math.max(t,d)),m=l.components||1;return a=Math.max(a,d),n+=d*m,{name:l.name,type:l.type,components:m,offset:p}}),size:zc(n,Math.max(a,t)),alignment:t}}function zc(r,t){return Math.ceil(r/t)*t}class Ta extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n){const a=this.length;return this.resize(a+1),this.emplace(a,t,n)}emplace(t,n,a){const l=2*t;return this.int16[l+0]=n,this.int16[l+1]=a,t}}Ta.prototype.bytesPerElement=4,qe("StructArrayLayout2i4",Ta);class Hs extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,a)}emplace(t,n,a,l){const d=3*t;return this.int16[d+0]=n,this.int16[d+1]=a,this.int16[d+2]=l,t}}Hs.prototype.bytesPerElement=6,qe("StructArrayLayout3i6",Hs);class _l extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,a,l)}emplace(t,n,a,l,d){const p=4*t;return this.int16[p+0]=n,this.int16[p+1]=a,this.int16[p+2]=l,this.int16[p+3]=d,t}}_l.prototype.bytesPerElement=8,qe("StructArrayLayout4i8",_l);class _n extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p){const m=this.length;return this.resize(m+1),this.emplace(m,t,n,a,l,d,p)}emplace(t,n,a,l,d,p,m){const _=6*t;return this.int16[_+0]=n,this.int16[_+1]=a,this.int16[_+2]=l,this.int16[_+3]=d,this.int16[_+4]=p,this.int16[_+5]=m,t}}_n.prototype.bytesPerElement=12,qe("StructArrayLayout2i4i12",_n);class Ws extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p){const m=this.length;return this.resize(m+1),this.emplace(m,t,n,a,l,d,p)}emplace(t,n,a,l,d,p,m){const _=4*t,v=8*t;return this.int16[_+0]=n,this.int16[_+1]=a,this.uint8[v+4]=l,this.uint8[v+5]=d,this.uint8[v+6]=p,this.uint8[v+7]=m,t}}Ws.prototype.bytesPerElement=8,qe("StructArrayLayout2i4ub8",Ws);class Wn extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n){const a=this.length;return this.resize(a+1),this.emplace(a,t,n)}emplace(t,n,a){const l=2*t;return this.float32[l+0]=n,this.float32[l+1]=a,t}}Wn.prototype.bytesPerElement=8,qe("StructArrayLayout2f8",Wn);class Xs extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p,m,_,v,b){const w=this.length;return this.resize(w+1),this.emplace(w,t,n,a,l,d,p,m,_,v,b)}emplace(t,n,a,l,d,p,m,_,v,b,w){const C=10*t;return this.uint16[C+0]=n,this.uint16[C+1]=a,this.uint16[C+2]=l,this.uint16[C+3]=d,this.uint16[C+4]=p,this.uint16[C+5]=m,this.uint16[C+6]=_,this.uint16[C+7]=v,this.uint16[C+8]=b,this.uint16[C+9]=w,t}}Xs.prototype.bytesPerElement=20,qe("StructArrayLayout10ui20",Xs);class Ya extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p,m,_,v,b,w,C){const A=this.length;return this.resize(A+1),this.emplace(A,t,n,a,l,d,p,m,_,v,b,w,C)}emplace(t,n,a,l,d,p,m,_,v,b,w,C,A){const k=12*t;return this.int16[k+0]=n,this.int16[k+1]=a,this.int16[k+2]=l,this.int16[k+3]=d,this.uint16[k+4]=p,this.uint16[k+5]=m,this.uint16[k+6]=_,this.uint16[k+7]=v,this.int16[k+8]=b,this.int16[k+9]=w,this.int16[k+10]=C,this.int16[k+11]=A,t}}Ya.prototype.bytesPerElement=24,qe("StructArrayLayout4i4ui4i24",Ya);class yl extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,a)}emplace(t,n,a,l){const d=3*t;return this.float32[d+0]=n,this.float32[d+1]=a,this.float32[d+2]=l,t}}yl.prototype.bytesPerElement=12,qe("StructArrayLayout3f12",yl);class Pa extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint32[1*t+0]=n,t}}Pa.prototype.bytesPerElement=4,qe("StructArrayLayout1ul4",Pa);class Xn extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p,m,_,v){const b=this.length;return this.resize(b+1),this.emplace(b,t,n,a,l,d,p,m,_,v)}emplace(t,n,a,l,d,p,m,_,v,b){const w=10*t,C=5*t;return this.int16[w+0]=n,this.int16[w+1]=a,this.int16[w+2]=l,this.int16[w+3]=d,this.int16[w+4]=p,this.int16[w+5]=m,this.uint32[C+3]=_,this.uint16[w+8]=v,this.uint16[w+9]=b,t}}Xn.prototype.bytesPerElement=20,qe("StructArrayLayout6i1ul2ui20",Xn);class vl extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p){const m=this.length;return this.resize(m+1),this.emplace(m,t,n,a,l,d,p)}emplace(t,n,a,l,d,p,m){const _=6*t;return this.int16[_+0]=n,this.int16[_+1]=a,this.int16[_+2]=l,this.int16[_+3]=d,this.int16[_+4]=p,this.int16[_+5]=m,t}}vl.prototype.bytesPerElement=12,qe("StructArrayLayout2i2i2i12",vl);class Ks extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d){const p=this.length;return this.resize(p+1),this.emplace(p,t,n,a,l,d)}emplace(t,n,a,l,d,p){const m=4*t,_=8*t;return this.float32[m+0]=n,this.float32[m+1]=a,this.float32[m+2]=l,this.int16[_+6]=d,this.int16[_+7]=p,t}}Ks.prototype.bytesPerElement=16,qe("StructArrayLayout2f1f2i16",Ks);class Kn extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p){const m=this.length;return this.resize(m+1),this.emplace(m,t,n,a,l,d,p)}emplace(t,n,a,l,d,p,m){const _=16*t,v=4*t,b=8*t;return this.uint8[_+0]=n,this.uint8[_+1]=a,this.float32[v+1]=l,this.float32[v+2]=d,this.int16[b+6]=p,this.int16[b+7]=m,t}}Kn.prototype.bytesPerElement=16,qe("StructArrayLayout2ub2f2i16",Kn);class Ys extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,a)}emplace(t,n,a,l){const d=3*t;return this.uint16[d+0]=n,this.uint16[d+1]=a,this.uint16[d+2]=l,t}}Ys.prototype.bytesPerElement=6,qe("StructArrayLayout3ui6",Ys);class xl extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U){const ee=this.length;return this.resize(ee+1),this.emplace(ee,t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U)}emplace(t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U,ee){const G=24*t,E=12*t,F=48*t;return this.int16[G+0]=n,this.int16[G+1]=a,this.uint16[G+2]=l,this.uint16[G+3]=d,this.uint32[E+2]=p,this.uint32[E+3]=m,this.uint32[E+4]=_,this.uint16[G+10]=v,this.uint16[G+11]=b,this.uint16[G+12]=w,this.float32[E+7]=C,this.float32[E+8]=A,this.uint8[F+36]=k,this.uint8[F+37]=D,this.uint8[F+38]=B,this.uint32[E+10]=U,this.int16[G+22]=ee,t}}xl.prototype.bytesPerElement=48,qe("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",xl);class Js extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U,ee,G,E,F,q,pe,Se,ge,_e,ze,Ie){const De=this.length;return this.resize(De+1),this.emplace(De,t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U,ee,G,E,F,q,pe,Se,ge,_e,ze,Ie)}emplace(t,n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U,ee,G,E,F,q,pe,Se,ge,_e,ze,Ie,De){const Te=32*t,Ye=16*t;return this.int16[Te+0]=n,this.int16[Te+1]=a,this.int16[Te+2]=l,this.int16[Te+3]=d,this.int16[Te+4]=p,this.int16[Te+5]=m,this.int16[Te+6]=_,this.int16[Te+7]=v,this.uint16[Te+8]=b,this.uint16[Te+9]=w,this.uint16[Te+10]=C,this.uint16[Te+11]=A,this.uint16[Te+12]=k,this.uint16[Te+13]=D,this.uint16[Te+14]=B,this.uint16[Te+15]=U,this.uint16[Te+16]=ee,this.uint16[Te+17]=G,this.uint16[Te+18]=E,this.uint16[Te+19]=F,this.uint16[Te+20]=q,this.uint16[Te+21]=pe,this.uint16[Te+22]=Se,this.uint32[Ye+12]=ge,this.float32[Ye+13]=_e,this.float32[Ye+14]=ze,this.uint16[Te+30]=Ie,this.uint16[Te+31]=De,t}}Js.prototype.bytesPerElement=64,qe("StructArrayLayout8i15ui1ul2f2ui64",Js);class Qs extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.float32[1*t+0]=n,t}}Qs.prototype.bytesPerElement=4,qe("StructArrayLayout1f4",Qs);class h extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,a)}emplace(t,n,a,l){const d=3*t;return this.uint16[6*t+0]=n,this.float32[d+1]=a,this.float32[d+2]=l,t}}h.prototype.bytesPerElement=12,qe("StructArrayLayout1ui2f12",h);class e extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,a)}emplace(t,n,a,l){const d=4*t;return this.uint32[2*t+0]=n,this.uint16[d+2]=a,this.uint16[d+3]=l,t}}e.prototype.bytesPerElement=8,qe("StructArrayLayout1ul2ui8",e);class i extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n){const a=this.length;return this.resize(a+1),this.emplace(a,t,n)}emplace(t,n,a){const l=2*t;return this.uint16[l+0]=n,this.uint16[l+1]=a,t}}i.prototype.bytesPerElement=4,qe("StructArrayLayout2ui4",i);class s extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint16[1*t+0]=n,t}}s.prototype.bytesPerElement=2,qe("StructArrayLayout1ui2",s);class o extends Si{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,a,l){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,a,l)}emplace(t,n,a,l,d){const p=4*t;return this.float32[p+0]=n,this.float32[p+1]=a,this.float32[p+2]=l,this.float32[p+3]=d,t}}o.prototype.bytesPerElement=16,qe("StructArrayLayout4f16",o);class u extends cn{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Be(this.anchorPointX,this.anchorPointY)}}u.prototype.size=20;class f extends Xn{get(t){return new u(this,t)}}qe("CollisionBoxArray",f);class g extends cn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(t){this._structArray.uint8[this._pos1+37]=t}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(t){this._structArray.uint8[this._pos1+38]=t}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(t){this._structArray.uint32[this._pos4+10]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}g.prototype.size=48;class y extends xl{get(t){return new g(this,t)}}qe("PlacedSymbolArray",y);class x extends cn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(t){this._structArray.uint32[this._pos4+12]=t}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}x.prototype.size=64;class T extends Js{get(t){return new x(this,t)}}qe("SymbolInstanceArray",T);class M extends Qs{getoffsetX(t){return this.float32[1*t+0]}}qe("GlyphOffsetArray",M);class S extends Hs{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}qe("SymbolLineVertexArray",S);class z extends cn{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}z.prototype.size=12;class R extends h{get(t){return new z(this,t)}}qe("TextAnchorOffsetArray",R);class V extends cn{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}V.prototype.size=8;class j extends e{get(t){return new V(this,t)}}qe("FeatureIndexArray",j);class N extends Ta{}class $ extends Ta{}class W extends Ta{}class X extends _n{}class J extends Ws{}class ie extends Wn{}class Q extends Xs{}class de extends Ya{}class fe extends yl{}class xe extends Pa{}class we extends vl{}class ve extends Kn{}class Le extends Ys{}class Re extends i{}const Ce=Di([{name:"a_pos",components:2,type:"Int16"}],4),{members:it}=Ce;class ot{constructor(t=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=t}prepareSegment(t,n,a,l){const d=this.segments[this.segments.length-1];return t>ot.MAX_VERTEX_ARRAY_LENGTH&&xi(`Max vertices per segment is ${ot.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${ot.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!d||d.vertexLength+t>ot.MAX_VERTEX_ARRAY_LENGTH||d.sortKey!==l?this.createNewSegment(n,a,l):d}createNewSegment(t,n,a){const l={vertexOffset:t.length,primitiveOffset:n.length,vertexLength:0,primitiveLength:0,vaos:{}};return a!==void 0&&(l.sortKey=a),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(l),l}getOrCreateLatestSegment(t,n,a){return this.prepareSegment(0,t,n,a)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const t of this.segments)for(const n in t.vaos)t.vaos[n].destroy()}static simpleSegment(t,n,a,l){return new ot([{vertexOffset:t,primitiveOffset:n,vertexLength:a,primitiveLength:l,vaos:{},sortKey:0}])}}function Ht(r,t){return 256*(r=Kt(Math.floor(r),0,255))+Kt(Math.floor(t),0,255)}ot.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,qe("SegmentVector",ot);const ui=Di([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var ri,yi,fi,Xt={exports:{}},ni={exports:{}},Ki={exports:{}},Yi=function(){if(fi)return Xt.exports;fi=1;var r=(ri||(ri=1,ni.exports=function(n,a){var l,d,p,m,_,v,b,w;for(d=n.length-(l=3&n.length),p=a,_=3432918353,v=461845907,w=0;w<d;)b=255&n.charCodeAt(w)|(255&n.charCodeAt(++w))<<8|(255&n.charCodeAt(++w))<<16|(255&n.charCodeAt(++w))<<24,++w,p=27492+(65535&(m=5*(65535&(p=(p^=b=(65535&(b=(b=(65535&b)*_+(((b>>>16)*_&65535)<<16)&4294967295)<<15|b>>>17))*v+(((b>>>16)*v&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(m>>>16)&65535)<<16);switch(b=0,l){case 3:b^=(255&n.charCodeAt(w+2))<<16;case 2:b^=(255&n.charCodeAt(w+1))<<8;case 1:p^=b=(65535&(b=(b=(65535&(b^=255&n.charCodeAt(w)))*_+(((b>>>16)*_&65535)<<16)&4294967295)<<15|b>>>17))*v+(((b>>>16)*v&65535)<<16)&4294967295}return p^=n.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0}),ni.exports),t=(yi||(yi=1,Ki.exports=function(n,a){for(var l,d=n.length,p=a^d,m=0;d>=4;)l=1540483477*(65535&(l=255&n.charCodeAt(m)|(255&n.charCodeAt(++m))<<8|(255&n.charCodeAt(++m))<<16|(255&n.charCodeAt(++m))<<24))+((1540483477*(l>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(l=1540483477*(65535&(l^=l>>>24))+((1540483477*(l>>>16)&65535)<<16)),d-=4,++m;switch(d){case 3:p^=(255&n.charCodeAt(m+2))<<16;case 2:p^=(255&n.charCodeAt(m+1))<<8;case 1:p=1540483477*(65535&(p^=255&n.charCodeAt(m)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0}),Ki.exports);return Xt.exports=r,Xt.exports.murmur3=r,Xt.exports.murmur2=t,Xt.exports}(),Zi=ke(Yi);class nr{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,n,a,l){this.ids.push(kn(t)),this.positions.push(n,a,l)}getPositions(t){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const n=kn(t);let a=0,l=this.ids.length-1;for(;a<l;){const p=a+l>>1;this.ids[p]>=n?l=p:a=p+1}const d=[];for(;this.ids[a]===n;)d.push({index:this.positions[3*a],start:this.positions[3*a+1],end:this.positions[3*a+2]}),a++;return d}static serialize(t,n){const a=new Float64Array(t.ids),l=new Uint32Array(t.positions);return yn(a,l,0,a.length-1),n&&n.push(a.buffer,l.buffer),{ids:a,positions:l}}static deserialize(t){const n=new nr;return n.ids=t.ids,n.positions=t.positions,n.indexed=!0,n}}function kn(r){const t=+r;return!isNaN(t)&&t<=Number.MAX_SAFE_INTEGER?t:Zi(String(r))}function yn(r,t,n,a){for(;n<a;){const l=r[n+a>>1];let d=n-1,p=a+1;for(;;){do d++;while(r[d]<l);do p--;while(r[p]>l);if(d>=p)break;hn(r,d,p),hn(t,3*d,3*p),hn(t,3*d+1,3*p+1),hn(t,3*d+2,3*p+2)}p-n<a-p?(yn(r,t,n,p),n=p+1):(yn(r,t,p+1,a),a=p)}}function hn(r,t,n){const a=r[t];r[t]=r[n],r[n]=a}qe("FeaturePositionMap",nr);class $r{constructor(t,n){this.gl=t.gl,this.location=n}}class Yn extends $r{constructor(t,n){super(t,n),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1f(this.location,t))}}class Ja extends $r{constructor(t,n){super(t,n),this.current=[0,0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]&&t[3]===this.current[3]||(this.current=t,this.gl.uniform4f(this.location,t[0],t[1],t[2],t[3]))}}class Jn extends $r{constructor(t,n){super(t,n),this.current=$t.transparent}set(t){t.r===this.current.r&&t.g===this.current.g&&t.b===this.current.b&&t.a===this.current.a||(this.current=t,this.gl.uniform4f(this.location,t.r,t.g,t.b,t.a))}}const Gr=new Float32Array(16);function un(r){return[Ht(255*r.r,255*r.g),Ht(255*r.b,255*r.a)]}class Jr{constructor(t,n,a){this.value=t,this.uniformNames=n.map(l=>`u_${l}`),this.type=a}setUniform(t,n,a){t.set(a.constantOr(this.value))}getBinding(t,n,a){return this.type==="color"?new Jn(t,n):new Yn(t,n)}}class dn{constructor(t,n){this.uniformNames=n.map(a=>`u_${a}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,n){this.pixelRatioFrom=n.pixelRatio,this.pixelRatioTo=t.pixelRatio,this.patternFrom=n.tlbr,this.patternTo=t.tlbr}setUniform(t,n,a,l){const d=l==="u_pattern_to"?this.patternTo:l==="u_pattern_from"?this.patternFrom:l==="u_pixel_ratio_to"?this.pixelRatioTo:l==="u_pixel_ratio_from"?this.pixelRatioFrom:null;d&&t.set(d)}getBinding(t,n,a){return a.substr(0,9)==="u_pattern"?new Ja(t,n):new Yn(t,n)}}class di{constructor(t,n,a,l){this.expression=t,this.type=a,this.maxValue=0,this.paintVertexAttributes=n.map(d=>({name:`a_${d}`,type:"Float32",components:a==="color"?2:1,offset:0})),this.paintVertexArray=new l}populatePaintArray(t,n,a,l,d){const p=this.paintVertexArray.length,m=this.expression.evaluate(new _i(0),n,{},l,[],d);this.paintVertexArray.resize(t),this._setPaintValue(p,t,m)}updatePaintArray(t,n,a,l){const d=this.expression.evaluate({zoom:0},a,l);this._setPaintValue(t,n,d)}_setPaintValue(t,n,a){if(this.type==="color"){const l=un(a);for(let d=t;d<n;d++)this.paintVertexArray.emplace(d,l[0],l[1])}else{for(let l=t;l<n;l++)this.paintVertexArray.emplace(l,a);this.maxValue=Math.max(this.maxValue,Math.abs(a))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class oi{constructor(t,n,a,l,d,p){this.expression=t,this.uniformNames=n.map(m=>`u_${m}_t`),this.type=a,this.useIntegerZoom=l,this.zoom=d,this.maxValue=0,this.paintVertexAttributes=n.map(m=>({name:`a_${m}`,type:"Float32",components:a==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(t,n,a,l,d){const p=this.expression.evaluate(new _i(this.zoom),n,{},l,[],d),m=this.expression.evaluate(new _i(this.zoom+1),n,{},l,[],d),_=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(_,t,p,m)}updatePaintArray(t,n,a,l){const d=this.expression.evaluate({zoom:this.zoom},a,l),p=this.expression.evaluate({zoom:this.zoom+1},a,l);this._setPaintValue(t,n,d,p)}_setPaintValue(t,n,a,l){if(this.type==="color"){const d=un(a),p=un(l);for(let m=t;m<n;m++)this.paintVertexArray.emplace(m,d[0],d[1],p[0],p[1])}else{for(let d=t;d<n;d++)this.paintVertexArray.emplace(d,a,l);this.maxValue=Math.max(this.maxValue,Math.abs(a),Math.abs(l))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,n){const a=this.useIntegerZoom?Math.floor(n.zoom):n.zoom,l=Kt(this.expression.interpolationFactor(a,this.zoom,this.zoom+1),0,1);t.set(l)}getBinding(t,n,a){return new Yn(t,n)}}class Ui{constructor(t,n,a,l,d,p){this.expression=t,this.type=n,this.useIntegerZoom=a,this.zoom=l,this.layerId=p,this.zoomInPaintVertexArray=new d,this.zoomOutPaintVertexArray=new d}populatePaintArray(t,n,a){const l=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(l,t,n.patterns&&n.patterns[this.layerId],a)}updatePaintArray(t,n,a,l,d){this._setPaintValues(t,n,a.patterns&&a.patterns[this.layerId],d)}_setPaintValues(t,n,a,l){if(!l||!a)return;const{min:d,mid:p,max:m}=a,_=l[d],v=l[p],b=l[m];if(_&&v&&b)for(let w=t;w<n;w++)this.zoomInPaintVertexArray.emplace(w,v.tl[0],v.tl[1],v.br[0],v.br[1],_.tl[0],_.tl[1],_.br[0],_.br[1],v.pixelRatio,_.pixelRatio),this.zoomOutPaintVertexArray.emplace(w,v.tl[0],v.tl[1],v.br[0],v.br[1],b.tl[0],b.tl[1],b.br[0],b.br[1],v.pixelRatio,b.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,ui.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,ui.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class $i{constructor(t,n,a){this.binders={},this._buffers=[];const l=[];for(const d in t.paint._values){if(!a(d))continue;const p=t.paint.get(d);if(!(p instanceof Ur&&ma(p.property.specification)))continue;const m=zh(d,t.type),_=p.value,v=p.property.specification.type,b=p.property.useIntegerZoom,w=p.property.specification["property-type"],C=w==="cross-faded"||w==="cross-faded-data-driven";if(_.kind==="constant")this.binders[d]=C?new dn(_.value,m):new Jr(_.value,m,v),l.push(`/u_${d}`);else if(_.kind==="source"||C){const A=Dc(d,v,"source");this.binders[d]=C?new Ui(_,v,b,n,A,t.id):new di(_,m,v,A),l.push(`/a_${d}`)}else{const A=Dc(d,v,"composite");this.binders[d]=new oi(_,m,v,b,n,A),l.push(`/z_${d}`)}}this.cacheKey=l.sort().join("")}getMaxValue(t){const n=this.binders[t];return n instanceof di||n instanceof oi?n.maxValue:0}populatePaintArrays(t,n,a,l,d){for(const p in this.binders){const m=this.binders[p];(m instanceof di||m instanceof oi||m instanceof Ui)&&m.populatePaintArray(t,n,a,l,d)}}setConstantPatternPositions(t,n){for(const a in this.binders){const l=this.binders[a];l instanceof dn&&l.setConstantPatternPositions(t,n)}}updatePaintArrays(t,n,a,l,d){let p=!1;for(const m in t){const _=n.getPositions(m);for(const v of _){const b=a.feature(v.index);for(const w in this.binders){const C=this.binders[w];if((C instanceof di||C instanceof oi||C instanceof Ui)&&C.expression.isStateDependent===!0){const A=l.paint.get(w);C.expression=A.value,C.updatePaintArray(v.start,v.end,b,t[m],d),p=!0}}}}return p}defines(){const t=[];for(const n in this.binders){const a=this.binders[n];(a instanceof Jr||a instanceof dn)&&t.push(...a.uniformNames.map(l=>`#define HAS_UNIFORM_${l}`))}return t}getBinderAttributes(){const t=[];for(const n in this.binders){const a=this.binders[n];if(a instanceof di||a instanceof oi)for(let l=0;l<a.paintVertexAttributes.length;l++)t.push(a.paintVertexAttributes[l].name);else if(a instanceof Ui)for(let l=0;l<ui.members.length;l++)t.push(ui.members[l].name)}return t}getBinderUniforms(){const t=[];for(const n in this.binders){const a=this.binders[n];if(a instanceof Jr||a instanceof dn||a instanceof oi)for(const l of a.uniformNames)t.push(l)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t,n){const a=[];for(const l in this.binders){const d=this.binders[l];if(d instanceof Jr||d instanceof dn||d instanceof oi){for(const p of d.uniformNames)if(n[p]){const m=d.getBinding(t,n[p],p);a.push({name:p,property:l,binding:m})}}}return a}setUniforms(t,n,a,l){for(const{name:d,property:p,binding:m}of n)this.binders[p].setUniform(m,l,a.get(p),d)}updatePaintBuffers(t){this._buffers=[];for(const n in this.binders){const a=this.binders[n];if(t&&a instanceof Ui){const l=t.fromScale===2?a.zoomInPaintVertexBuffer:a.zoomOutPaintVertexBuffer;l&&this._buffers.push(l)}else(a instanceof di||a instanceof oi)&&a.paintVertexBuffer&&this._buffers.push(a.paintVertexBuffer)}}upload(t){for(const n in this.binders){const a=this.binders[n];(a instanceof di||a instanceof oi||a instanceof Ui)&&a.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const n=this.binders[t];(n instanceof di||n instanceof oi||n instanceof Ui)&&n.destroy()}}}class Qn{constructor(t,n,a=()=>!0){this.programConfigurations={};for(const l of t)this.programConfigurations[l.id]=new $i(l,n,a);this.needsUpload=!1,this._featureMap=new nr,this._bufferOffset=0}populatePaintArrays(t,n,a,l,d,p){for(const m in this.programConfigurations)this.programConfigurations[m].populatePaintArrays(t,n,l,d,p);n.id!==void 0&&this._featureMap.add(n.id,a,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,n,a,l){for(const d of a)this.needsUpload=this.programConfigurations[d.id].updatePaintArrays(t,this._featureMap,n,d,l)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const n in this.programConfigurations)this.programConfigurations[n].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}function zh(r,t){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[r]||[r.replace(`${t}-`,"").replace(/-/g,"_")]}function Dc(r,t,n){const a={color:{source:Wn,composite:o},number:{source:Qs,composite:Wn}},l=function(d){return{"line-pattern":{source:Q,composite:Q},"fill-pattern":{source:Q,composite:Q},"fill-extrusion-pattern":{source:Q,composite:Q}}[d]}(r);return l&&l[n]||a[t][n]}qe("ConstantBinder",Jr),qe("CrossFadedConstantBinder",dn),qe("SourceExpressionBinder",di),qe("CrossFadedCompositeBinder",Ui),qe("CompositeExpressionBinder",oi),qe("ProgramConfiguration",$i,{omit:["_buffers"]}),qe("ProgramConfigurationSet",Qn);const bl=Math.pow(2,14)-1,Rc=-bl-1;function ea(r){const t=Mt/r.extent,n=r.loadGeometry();for(let a=0;a<n.length;a++){const l=n[a];for(let d=0;d<l.length;d++){const p=l[d],m=Math.round(p.x*t),_=Math.round(p.y*t);p.x=Kt(m,Rc,bl),p.y=Kt(_,Rc,bl),(m<p.x||m>p.x+1||_<p.y||_>p.y+1)&&xi("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return n}function Ar(r,t){return{type:r.type,id:r.id,properties:r.properties,geometry:t?ea(r):[]}}const wl=-32768;function Lc(r,t,n,a,l){r.emplaceBack(wl+8*t+a,wl+8*n+l)}class eo{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new $,this.indexArray=new Le,this.segments=new ot,this.programConfigurations=new Qn(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,a){const l=this.layers[0],d=[];let p=null,m=!1,_=l.type==="heatmap";if(l.type==="circle"){const b=l;p=b.layout.get("circle-sort-key"),m=!p.isConstant(),_=_||b.paint.get("circle-pitch-alignment")==="map"}const v=_?n.subdivisionGranularity.circle:1;for(const{feature:b,id:w,index:C,sourceLayerIndex:A}of t){const k=this.layers[0]._featureFilter.needGeometry,D=Ar(b,k);if(!this.layers[0]._featureFilter.filter(new _i(this.zoom),D,a))continue;const B=m?p.evaluate(D,{},a):void 0,U={id:w,properties:b.properties,type:b.type,sourceLayerIndex:A,index:C,geometry:k?D.geometry:ea(b),patterns:{},sortKey:B};d.push(U)}m&&d.sort((b,w)=>b.sortKey-w.sortKey);for(const b of d){const{geometry:w,index:C,sourceLayerIndex:A}=b,k=t[C].feature;this.addFeature(b,w,C,a,v),n.featureIndex.insert(k,w,C,A,this.index)}}update(t,n,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,n,this.stateDependentLayers,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,it),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,n,a,l,d=1){let p;switch(d){case 1:p=[0,7];break;case 3:p=[0,2,5,7];break;case 5:p=[0,1,3,4,6,7];break;case 7:p=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${d}; valid values are 1, 3, 5, 7.`)}const m=p.length;for(const _ of n)for(const v of _){const b=v.x,w=v.y;if(b<0||b>=Mt||w<0||w>=Mt)continue;const C=this.segments.prepareSegment(m*m,this.layoutVertexArray,this.indexArray,t.sortKey),A=C.vertexLength;for(let k=0;k<m;k++)for(let D=0;D<m;D++)Lc(this.layoutVertexArray,b,w,p[D],p[k]);for(let k=0;k<m-1;k++)for(let D=0;D<m-1;D++){const B=A+k*m+D,U=A+(k+1)*m+D;this.indexArray.emplaceBack(B,U+1,B+1),this.indexArray.emplaceBack(B,U,U+1)}C.vertexLength+=m*m,C.primitiveLength+=(m-1)*(m-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,a,{},l)}}function to(r,t){for(let n=0;n<r.length;n++)if(ro(t,r[n]))return!0;for(let n=0;n<t.length;n++)if(ro(r,t[n]))return!0;return!!Dh(r,t)}function Fc(r,t,n){return!!ro(r,t)||!!Rh(t,r,n)}function io(r,t){if(r.length===1)return zu(t,r[0]);for(let n=0;n<t.length;n++){const a=t[n];for(let l=0;l<a.length;l++)if(ro(r,a[l]))return!0}for(let n=0;n<r.length;n++)if(zu(t,r[n]))return!0;for(let n=0;n<t.length;n++)if(Dh(r,t[n]))return!0;return!1}function Xp(r,t,n){if(r.length>1){if(Dh(r,t))return!0;for(let a=0;a<t.length;a++)if(Rh(t[a],r,n))return!0}for(let a=0;a<r.length;a++)if(Rh(r[a],t,n))return!0;return!1}function Dh(r,t){if(r.length===0||t.length===0)return!1;for(let n=0;n<r.length-1;n++){const a=r[n],l=r[n+1];for(let d=0;d<t.length-1;d++)if(Kp(a,l,t[d],t[d+1]))return!0}return!1}function Kp(r,t,n,a){return li(r,n,a)!==li(t,n,a)&&li(r,t,n)!==li(r,t,a)}function Rh(r,t,n){const a=n*n;if(t.length===1)return r.distSqr(t[0])<a;for(let l=1;l<t.length;l++)if(ku(r,t[l-1],t[l])<a)return!0;return!1}function ku(r,t,n){const a=t.distSqr(n);if(a===0)return r.distSqr(t);const l=((r.x-t.x)*(n.x-t.x)+(r.y-t.y)*(n.y-t.y))/a;return r.distSqr(l<0?t:l>1?n:n.sub(t)._mult(l)._add(t))}function zu(r,t){let n,a,l,d=!1;for(let p=0;p<r.length;p++){n=r[p];for(let m=0,_=n.length-1;m<n.length;_=m++)a=n[m],l=n[_],a.y>t.y!=l.y>t.y&&t.x<(l.x-a.x)*(t.y-a.y)/(l.y-a.y)+a.x&&(d=!d)}return d}function ro(r,t){let n=!1;for(let a=0,l=r.length-1;a<r.length;l=a++){const d=r[a],p=r[l];d.y>t.y!=p.y>t.y&&t.x<(p.x-d.x)*(t.y-d.y)/(p.y-d.y)+d.x&&(n=!n)}return n}function Yp(r,t,n){const a=n[0],l=n[2];if(r.x<a.x&&t.x<a.x||r.x>l.x&&t.x>l.x||r.y<a.y&&t.y<a.y||r.y>l.y&&t.y>l.y)return!1;const d=li(r,t,n[0]);return d!==li(r,t,n[1])||d!==li(r,t,n[2])||d!==li(r,t,n[3])}function Tl(r,t,n){const a=t.paint.get(r).value;return a.kind==="constant"?a.value:n.programConfigurations.get(t.id).getMaxValue(r)}function Bc(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function Oc(r,t,n,a,l){if(!t[0]&&!t[1])return r;const d=Be.convert(t)._mult(l);n==="viewport"&&d._rotate(-a);const p=[];for(let m=0;m<r.length;m++)p.push(r[m].sub(d));return p}let Du,Ru;qe("CircleBucket",eo,{omit:["layers"]});var Jp={get paint(){return Ru=Ru||new wr({"circle-radius":new mt(P.paint_circle["circle-radius"]),"circle-color":new mt(P.paint_circle["circle-color"]),"circle-blur":new mt(P.paint_circle["circle-blur"]),"circle-opacity":new mt(P.paint_circle["circle-opacity"]),"circle-translate":new at(P.paint_circle["circle-translate"]),"circle-translate-anchor":new at(P.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new at(P.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new at(P.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new mt(P.paint_circle["circle-stroke-width"]),"circle-stroke-color":new mt(P.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new mt(P.paint_circle["circle-stroke-opacity"])})},get layout(){return Du=Du||new wr({"circle-sort-key":new mt(P.layout_circle["circle-sort-key"])})}};class Qp extends ln{constructor(t){super(t,Jp)}createBucket(t){return new eo(t)}queryRadius(t){const n=t;return Tl("circle-radius",this,n)+Tl("circle-stroke-width",this,n)+Bc(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:t,feature:n,featureState:a,geometry:l,transform:d,pixelsToTileUnits:p,pixelPosMatrix:m}){const _=Oc(t,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-d.bearingInRadians,p),v=this.paint.get("circle-radius").evaluate(n,a)+this.paint.get("circle-stroke-width").evaluate(n,a),b=this.paint.get("circle-pitch-alignment")==="map",w=b?_:function(A,k){return A.map(D=>Lu(D,k))}(_,m),C=b?v*p:v;for(const A of l)for(const k of A){const D=b?k:Lu(k,m);let B=C;const U=bt([],[k.x,k.y,0,1],m);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?B*=U[3]/d.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(B*=d.cameraToCenterDistance/U[3]),Fc(w,D,B))return!0}return!1}}function Lu(r,t){const n=bt([],[r.x,r.y,0,1],t);return new Be(n[0]/n[3],n[1]/n[3])}class Fu extends eo{}let Bu;qe("HeatmapBucket",Fu,{omit:["layers"]});var ef={get paint(){return Bu=Bu||new wr({"heatmap-radius":new mt(P.paint_heatmap["heatmap-radius"]),"heatmap-weight":new mt(P.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new at(P.paint_heatmap["heatmap-intensity"]),"heatmap-color":new gl(P.paint_heatmap["heatmap-color"]),"heatmap-opacity":new at(P.paint_heatmap["heatmap-opacity"])})}};function Lh(r,{width:t,height:n},a,l){if(l){if(l instanceof Uint8ClampedArray)l=new Uint8Array(l.buffer);else if(l.length!==t*n*a)throw new RangeError(`mismatched image size. expected: ${l.length} but got: ${t*n*a}`)}else l=new Uint8Array(t*n*a);return r.width=t,r.height=n,r.data=l,r}function Ou(r,{width:t,height:n},a){if(t===r.width&&n===r.height)return;const l=Lh({},{width:t,height:n},a);Fh(r,l,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,t),height:Math.min(r.height,n)},a),r.width=t,r.height=n,r.data=l.data}function Fh(r,t,n,a,l,d){if(l.width===0||l.height===0)return t;if(l.width>r.width||l.height>r.height||n.x>r.width-l.width||n.y>r.height-l.height)throw new RangeError("out of range source coordinates for image copy");if(l.width>t.width||l.height>t.height||a.x>t.width-l.width||a.y>t.height-l.height)throw new RangeError("out of range destination coordinates for image copy");const p=r.data,m=t.data;if(p===m)throw new Error("srcData equals dstData, so image is already copied");for(let _=0;_<l.height;_++){const v=((n.y+_)*r.width+n.x)*d,b=((a.y+_)*t.width+a.x)*d;for(let w=0;w<l.width*d;w++)m[b+w]=p[v+w]}return t}class Pl{constructor(t,n){Lh(this,t,1,n)}resize(t){Ou(this,t,1)}clone(){return new Pl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,a,l,d){Fh(t,n,a,l,d,1)}}class Qr{constructor(t,n){Lh(this,t,4,n)}resize(t){Ou(this,t,4)}replace(t,n){n?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Qr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,a,l,d){Fh(t,n,a,l,d,4)}}function ju(r){const t={},n=r.resolution||256,a=r.clips?r.clips.length:1,l=r.image||new Qr({width:n,height:a});if(Math.log(n)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${n}`);const d=(p,m,_)=>{t[r.evaluationKey]=_;const v=r.expression.evaluate(t);l.data[p+m+0]=Math.floor(255*v.r/v.a),l.data[p+m+1]=Math.floor(255*v.g/v.a),l.data[p+m+2]=Math.floor(255*v.b/v.a),l.data[p+m+3]=Math.floor(255*v.a)};if(r.clips)for(let p=0,m=0;p<a;++p,m+=4*n)for(let _=0,v=0;_<n;_++,v+=4){const b=_/(n-1),{start:w,end:C}=r.clips[p];d(m,v,w*(1-b)+C*b)}else for(let p=0,m=0;p<n;p++,m+=4)d(0,m,p/(n-1));return l}qe("AlphaImage",Pl),qe("RGBAImage",Qr);const Bh="big-fb";class tf extends ln{createBucket(t){return new Fu(t)}constructor(t){super(t,ef),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=ju({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(Bh)&&this.heatmapFbos.delete(Bh)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Vu;var rf={get paint(){return Vu=Vu||new wr({"hillshade-illumination-direction":new at(P.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new at(P.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new at(P.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new at(P.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new at(P.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new at(P.paint_hillshade["hillshade-accent-color"])})}};class nf extends ln{constructor(t){super(t,rf)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const af=Di([{name:"a_pos",components:2,type:"Int16"}],4),{members:sf}=af;function Oh(r,t,n){const a=n.patternDependencies;let l=!1;for(const d of t){const p=d.paint.get(`${r}-pattern`);p.isConstant()||(l=!0);const m=p.constantOr(null);m&&(l=!0,a[m.to]=!0,a[m.from]=!0)}return l}function jh(r,t,n,a,l){const d=l.patternDependencies;for(const p of t){const m=p.paint.get(`${r}-pattern`).value;if(m.kind!=="constant"){let _=m.evaluate({zoom:a-1},n,{},l.availableImages),v=m.evaluate({zoom:a},n,{},l.availableImages),b=m.evaluate({zoom:a+1},n,{},l.availableImages);_=_&&_.name?_.name:_,v=v&&v.name?v.name:v,b=b&&b.name?b.name:b,d[_]=!0,d[v]=!0,d[b]=!0,n.patterns[p.id]={min:_,mid:v,max:b}}}return n}function Nu(r,t,n,a,l){let d;if(l===function(p,m,_,v){let b=0;for(let w=m,C=_-v;w<_;w+=v)b+=(p[C]-p[w])*(p[w+1]+p[C+1]),C=w;return b}(r,t,n,a)>0)for(let p=t;p<n;p+=a)d=Gu(p/a|0,r[p],r[p+1],d);else for(let p=n-a;p>=t;p-=a)d=Gu(p/a|0,r[p],r[p+1],d);return d&&no(d,d.next)&&(Il(d),d=d.next),d}function Qa(r,t){if(!r)return r;t||(t=r);let n,a=r;do if(n=!1,a.steiner||!no(a,a.next)&&Ri(a.prev,a,a.next)!==0)a=a.next;else{if(Il(a),a=t=a.prev,a===a.next)break;n=!0}while(n||a!==t);return t}function Ml(r,t,n,a,l,d,p){if(!r)return;!p&&d&&function(_,v,b,w){let C=_;do C.z===0&&(C.z=Vh(C.x,C.y,v,b,w)),C.prevZ=C.prev,C.nextZ=C.next,C=C.next;while(C!==_);C.prevZ.nextZ=null,C.prevZ=null,function(A){let k,D=1;do{let B,U=A;A=null;let ee=null;for(k=0;U;){k++;let G=U,E=0;for(let q=0;q<D&&(E++,G=G.nextZ,G);q++);let F=D;for(;E>0||F>0&&G;)E!==0&&(F===0||!G||U.z<=G.z)?(B=U,U=U.nextZ,E--):(B=G,G=G.nextZ,F--),ee?ee.nextZ=B:A=B,B.prevZ=ee,ee=B;U=G}ee.nextZ=null,D*=2}while(k>1)}(C)}(r,a,l,d);let m=r;for(;r.prev!==r.next;){const _=r.prev,v=r.next;if(d?lf(r,a,l,d):of(r))t.push(_.i,r.i,v.i),Il(r),r=v.next,m=v.next;else if((r=v)===m){p?p===1?Ml(r=cf(Qa(r),t),t,n,a,l,d,2):p===2&&hf(r,t,n,a,l,d):Ml(Qa(r),t,n,a,l,d,1);break}}}function of(r){const t=r.prev,n=r,a=r.next;if(Ri(t,n,a)>=0)return!1;const l=t.x,d=n.x,p=a.x,m=t.y,_=n.y,v=a.y,b=Math.min(l,d,p),w=Math.min(m,_,v),C=Math.max(l,d,p),A=Math.max(m,_,v);let k=a.next;for(;k!==t;){if(k.x>=b&&k.x<=C&&k.y>=w&&k.y<=A&&Sl(l,m,d,_,p,v,k.x,k.y)&&Ri(k.prev,k,k.next)>=0)return!1;k=k.next}return!0}function lf(r,t,n,a){const l=r.prev,d=r,p=r.next;if(Ri(l,d,p)>=0)return!1;const m=l.x,_=d.x,v=p.x,b=l.y,w=d.y,C=p.y,A=Math.min(m,_,v),k=Math.min(b,w,C),D=Math.max(m,_,v),B=Math.max(b,w,C),U=Vh(A,k,t,n,a),ee=Vh(D,B,t,n,a);let G=r.prevZ,E=r.nextZ;for(;G&&G.z>=U&&E&&E.z<=ee;){if(G.x>=A&&G.x<=D&&G.y>=k&&G.y<=B&&G!==l&&G!==p&&Sl(m,b,_,w,v,C,G.x,G.y)&&Ri(G.prev,G,G.next)>=0||(G=G.prevZ,E.x>=A&&E.x<=D&&E.y>=k&&E.y<=B&&E!==l&&E!==p&&Sl(m,b,_,w,v,C,E.x,E.y)&&Ri(E.prev,E,E.next)>=0))return!1;E=E.nextZ}for(;G&&G.z>=U;){if(G.x>=A&&G.x<=D&&G.y>=k&&G.y<=B&&G!==l&&G!==p&&Sl(m,b,_,w,v,C,G.x,G.y)&&Ri(G.prev,G,G.next)>=0)return!1;G=G.prevZ}for(;E&&E.z<=ee;){if(E.x>=A&&E.x<=D&&E.y>=k&&E.y<=B&&E!==l&&E!==p&&Sl(m,b,_,w,v,C,E.x,E.y)&&Ri(E.prev,E,E.next)>=0)return!1;E=E.nextZ}return!0}function cf(r,t){let n=r;do{const a=n.prev,l=n.next.next;!no(a,l)&&Uu(a,n,n.next,l)&&Cl(a,l)&&Cl(l,a)&&(t.push(a.i,n.i,l.i),Il(n),Il(n.next),n=r=l),n=n.next}while(n!==r);return Qa(n)}function hf(r,t,n,a,l,d){let p=r;do{let m=p.next.next;for(;m!==p.prev;){if(p.i!==m.i&&mf(p,m)){let _=$u(p,m);return p=Qa(p,p.next),_=Qa(_,_.next),Ml(p,t,n,a,l,d,0),void Ml(_,t,n,a,l,d,0)}m=m.next}p=p.next}while(p!==r)}function uf(r,t){let n=r.x-t.x;return n===0&&(n=r.y-t.y,n===0)&&(n=(r.next.y-r.y)/(r.next.x-r.x)-(t.next.y-t.y)/(t.next.x-t.x)),n}function df(r,t){const n=function(l,d){let p=d;const m=l.x,_=l.y;let v,b=-1/0;if(no(l,p))return p;do{if(no(l,p.next))return p.next;if(_<=p.y&&_>=p.next.y&&p.next.y!==p.y){const D=p.x+(_-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(D<=m&&D>b&&(b=D,v=p.x<p.next.x?p:p.next,D===m))return v}p=p.next}while(p!==d);if(!v)return null;const w=v,C=v.x,A=v.y;let k=1/0;p=v;do{if(m>=p.x&&p.x>=C&&m!==p.x&&Zu(_<A?m:b,_,C,A,_<A?b:m,_,p.x,p.y)){const D=Math.abs(_-p.y)/(m-p.x);Cl(p,l)&&(D<k||D===k&&(p.x>v.x||p.x===v.x&&pf(v,p)))&&(v=p,k=D)}p=p.next}while(p!==w);return v}(r,t);if(!n)return t;const a=$u(n,r);return Qa(a,a.next),Qa(n,n.next)}function pf(r,t){return Ri(r.prev,r,t.prev)<0&&Ri(t.next,r,r.next)<0}function Vh(r,t,n,a,l){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-n)*l|0)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-a)*l|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function ff(r){let t=r,n=r;do(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next;while(t!==r);return n}function Zu(r,t,n,a,l,d,p,m){return(l-p)*(t-m)>=(r-p)*(d-m)&&(r-p)*(a-m)>=(n-p)*(t-m)&&(n-p)*(d-m)>=(l-p)*(a-m)}function Sl(r,t,n,a,l,d,p,m){return!(r===p&&t===m)&&Zu(r,t,n,a,l,d,p,m)}function mf(r,t){return r.next.i!==t.i&&r.prev.i!==t.i&&!function(n,a){let l=n;do{if(l.i!==n.i&&l.next.i!==n.i&&l.i!==a.i&&l.next.i!==a.i&&Uu(l,l.next,n,a))return!0;l=l.next}while(l!==n);return!1}(r,t)&&(Cl(r,t)&&Cl(t,r)&&function(n,a){let l=n,d=!1;const p=(n.x+a.x)/2,m=(n.y+a.y)/2;do l.y>m!=l.next.y>m&&l.next.y!==l.y&&p<(l.next.x-l.x)*(m-l.y)/(l.next.y-l.y)+l.x&&(d=!d),l=l.next;while(l!==n);return d}(r,t)&&(Ri(r.prev,r,t.prev)||Ri(r,t.prev,t))||no(r,t)&&Ri(r.prev,r,r.next)>0&&Ri(t.prev,t,t.next)>0)}function Ri(r,t,n){return(t.y-r.y)*(n.x-t.x)-(t.x-r.x)*(n.y-t.y)}function no(r,t){return r.x===t.x&&r.y===t.y}function Uu(r,t,n,a){const l=Vc(Ri(r,t,n)),d=Vc(Ri(r,t,a)),p=Vc(Ri(n,a,r)),m=Vc(Ri(n,a,t));return l!==d&&p!==m||!(l!==0||!jc(r,n,t))||!(d!==0||!jc(r,a,t))||!(p!==0||!jc(n,r,a))||!(m!==0||!jc(n,t,a))}function jc(r,t,n){return t.x<=Math.max(r.x,n.x)&&t.x>=Math.min(r.x,n.x)&&t.y<=Math.max(r.y,n.y)&&t.y>=Math.min(r.y,n.y)}function Vc(r){return r>0?1:r<0?-1:0}function Cl(r,t){return Ri(r.prev,r,r.next)<0?Ri(r,t,r.next)>=0&&Ri(r,r.prev,t)>=0:Ri(r,t,r.prev)<0||Ri(r,r.next,t)<0}function $u(r,t){const n=Nh(r.i,r.x,r.y),a=Nh(t.i,t.x,t.y),l=r.next,d=t.prev;return r.next=t,t.prev=r,n.next=l,l.prev=n,a.next=n,n.prev=a,d.next=a,a.prev=d,a}function Gu(r,t,n,a){const l=Nh(r,t,n);return a?(l.next=a.next,l.prev=a,a.next.prev=l,a.next=l):(l.prev=l,l.next=l),l}function Il(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Nh(r,t,n){return{i:r,x:t,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class ao{constructor(t,n){if(n>t)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=t,this._minGranularity=n}getGranularityForZoomLevel(t){return Math.max(Math.floor(this._baseZoomGranularity/(1<<t)),this._minGranularity,1)}}class Nc{constructor(t){this.fill=t.fill,this.line=t.line,this.tile=t.tile,this.stencil=t.stencil,this.circle=t.circle}}Nc.noSubdivision=new Nc({fill:new ao(0,0),line:new ao(0,0),tile:new ao(0,0),stencil:new ao(0,0),circle:1}),qe("SubdivisionGranularityExpression",ao),qe("SubdivisionGranularitySetting",Nc);const so=-32768,El=32767;class gf{constructor(t,n){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=t,this._granularityCellSize=Mt/t,this._canonical=n}_getKey(t,n){return(t+=32768)<<16|(n+=32768)<<0}_vertexToIndex(t,n){if(t<-32768||n<-32768||t>32767||n>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const a=0|Math.round(t),l=0|Math.round(n),d=this._getKey(a,l);if(this._vertexDictionary.has(d))return this._vertexDictionary.get(d);const p=this._vertexBuffer.length/2;return this._vertexDictionary.set(d,p),this._vertexBuffer.push(a,l),p}_subdivideTrianglesScanline(t){if(this._granularity<2)return function(l,d){const p=[];for(let m=0;m<d.length;m+=3){const _=d[m],v=d[m+1],b=d[m+2],w=l[2*_],C=l[2*_+1];(l[2*v]-w)*(l[2*b+1]-C)-(l[2*v+1]-C)*(l[2*b]-w)>0?(p.push(_),p.push(b),p.push(v)):(p.push(_),p.push(v),p.push(b))}return p}(this._vertexBuffer,t);const n=[],a=t.length;for(let l=0;l<a;l+=3){const d=[t[l+0],t[l+1],t[l+2]],p=[this._vertexBuffer[2*t[l+0]+0],this._vertexBuffer[2*t[l+0]+1],this._vertexBuffer[2*t[l+1]+0],this._vertexBuffer[2*t[l+1]+1],this._vertexBuffer[2*t[l+2]+0],this._vertexBuffer[2*t[l+2]+1]];let m=1/0,_=1/0,v=-1/0,b=-1/0;for(let D=0;D<3;D++){const B=p[2*D],U=p[2*D+1];m=Math.min(m,B),v=Math.max(v,B),_=Math.min(_,U),b=Math.max(b,U)}if(m===v||_===b)continue;const w=Math.floor(m/this._granularityCellSize),C=Math.ceil(v/this._granularityCellSize),A=Math.floor(_/this._granularityCellSize),k=Math.ceil(b/this._granularityCellSize);if(w!==C||A!==k)for(let D=A;D<k;D++){const B=this._scanlineGenerateVertexRingForCellRow(D,p,d);_f(this._vertexBuffer,B,n)}else n.push(...d)}return n}_scanlineGenerateVertexRingForCellRow(t,n,a){const l=t*this._granularityCellSize,d=l+this._granularityCellSize,p=[];for(let m=0;m<3;m++){const _=n[2*m],v=n[2*m+1],b=n[2*(m+1)%6],w=n[(2*(m+1)+1)%6],C=n[2*(m+2)%6],A=n[(2*(m+2)+1)%6],k=b-_,D=w-v,B=k===0,U=D===0,ee=(l-v)/D,G=(d-v)/D,E=Math.min(ee,G),F=Math.max(ee,G);if(!U&&(E>=1||F<=0)||U&&(v<l||v>d)){w>=l&&w<=d&&p.push(a[(m+1)%3]);continue}!U&&E>0&&p.push(this._vertexToIndex(_+k*E,v+D*E));const q=_+k*Math.max(E,0),pe=_+k*Math.min(F,1);B||this._generateIntraEdgeVertices(p,_,v,b,w,q,pe),!U&&F<1&&p.push(this._vertexToIndex(_+k*F,v+D*F)),(U||w>=l&&w<=d)&&p.push(a[(m+1)%3]),!U&&(w<=l||w>=d)&&this._generateInterEdgeVertices(p,_,v,b,w,C,A,pe,l,d)}return p}_generateIntraEdgeVertices(t,n,a,l,d,p,m){const _=l-n,v=d-a,b=v===0,w=b?Math.min(n,l):Math.min(p,m),C=b?Math.max(n,l):Math.max(p,m),A=Math.floor(w/this._granularityCellSize)+1,k=Math.ceil(C/this._granularityCellSize)-1;if(b?n<l:p<m)for(let D=A;D<=k;D++){const B=D*this._granularityCellSize;t.push(this._vertexToIndex(B,a+v*(B-n)/_))}else for(let D=k;D>=A;D--){const B=D*this._granularityCellSize;t.push(this._vertexToIndex(B,a+v*(B-n)/_))}}_generateInterEdgeVertices(t,n,a,l,d,p,m,_,v,b){const w=d-a,C=p-l,A=m-d,k=(v-d)/A,D=(b-d)/A,B=Math.min(k,D),U=Math.max(k,D),ee=l+C*B;let G=Math.floor(Math.min(ee,_)/this._granularityCellSize)+1,E=Math.ceil(Math.max(ee,_)/this._granularityCellSize)-1,F=_<ee;const q=A===0;if(q&&(m===v||m===b))return;if(q||B>=1||U<=0){const Se=a-m,ge=p+(n-p)*Math.min((v-m)/Se,(b-m)/Se);G=Math.floor(Math.min(ge,_)/this._granularityCellSize)+1,E=Math.ceil(Math.max(ge,_)/this._granularityCellSize)-1,F=_<ge}const pe=w>0?b:v;if(F)for(let Se=G;Se<=E;Se++)t.push(this._vertexToIndex(Se*this._granularityCellSize,pe));else for(let Se=E;Se>=G;Se--)t.push(this._vertexToIndex(Se*this._granularityCellSize,pe))}_generateOutline(t){const n=[];for(const a of t){const l=es(a,this._granularity,!0),d=this._pointArrayToIndices(l),p=[];for(let m=1;m<d.length;m++)p.push(d[m-1]),p.push(d[m]);n.push(p)}return n}_handlePoles(t){let n=!1,a=!1;this._canonical&&(this._canonical.y===0&&(n=!0),this._canonical.y===(1<<this._canonical.z)-1&&(a=!0)),(n||a)&&this._fillPoles(t,n,a)}_ensureNoPoleVertices(){const t=this._vertexBuffer;for(let n=0;n<t.length;n+=2){const a=t[n+1];a===so&&(t[n+1]=-32767),a===El&&(t[n+1]=32766)}}_generatePoleQuad(t,n,a,l,d,p){l>d!=(p===so)?(t.push(n),t.push(a),t.push(this._vertexToIndex(l,p)),t.push(a),t.push(this._vertexToIndex(d,p)),t.push(this._vertexToIndex(l,p))):(t.push(a),t.push(n),t.push(this._vertexToIndex(l,p)),t.push(this._vertexToIndex(d,p)),t.push(a),t.push(this._vertexToIndex(l,p)))}_fillPoles(t,n,a){const l=this._vertexBuffer,d=Mt,p=t.length;for(let m=2;m<p;m+=3){const _=t[m-2],v=t[m-1],b=t[m],w=l[2*_],C=l[2*_+1],A=l[2*v],k=l[2*v+1],D=l[2*b],B=l[2*b+1];n&&(C===0&&k===0&&this._generatePoleQuad(t,_,v,w,A,so),k===0&&B===0&&this._generatePoleQuad(t,v,b,A,D,so),B===0&&C===0&&this._generatePoleQuad(t,b,_,D,w,so)),a&&(C===d&&k===d&&this._generatePoleQuad(t,_,v,w,A,El),k===d&&B===d&&this._generatePoleQuad(t,v,b,A,D,El),B===d&&C===d&&this._generatePoleQuad(t,b,_,D,w,El))}}_initializeVertices(t){for(let n=0;n<t.length;n+=2)this._vertexToIndex(t[n],t[n+1])}subdividePolygonInternal(t,n){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:a,holeIndices:l}=function(m){const _=[],v=[];for(const b of m)if(b.length!==0){b!==m[0]&&_.push(v.length/2);for(let w=0;w<b.length;w++)v.push(b[w].x),v.push(b[w].y)}return{flattened:v,holeIndices:_}}(t);let d;this._initializeVertices(a);try{const m=function(v,b,w=2){const C=b&&b.length,A=C?b[0]*w:v.length;let k=Nu(v,0,A,w,!0);const D=[];if(!k||k.next===k.prev)return D;let B,U,ee;if(C&&(k=function(G,E,F,q){const pe=[];for(let Se=0,ge=E.length;Se<ge;Se++){const _e=Nu(G,E[Se]*q,Se<ge-1?E[Se+1]*q:G.length,q,!1);_e===_e.next&&(_e.steiner=!0),pe.push(ff(_e))}pe.sort(uf);for(let Se=0;Se<pe.length;Se++)F=df(pe[Se],F);return F}(v,b,k,w)),v.length>80*w){B=1/0,U=1/0;let G=-1/0,E=-1/0;for(let F=w;F<A;F+=w){const q=v[F],pe=v[F+1];q<B&&(B=q),pe<U&&(U=pe),q>G&&(G=q),pe>E&&(E=pe)}ee=Math.max(G-B,E-U),ee=ee!==0?32767/ee:0}return Ml(k,D,w,B,U,ee,0),D}(a,l),_=this._convertIndices(a,m);d=this._subdivideTrianglesScanline(_)}catch(m){console.error(m)}let p=[];return n&&(p=this._generateOutline(t)),this._ensureNoPoleVertices(),this._handlePoles(d),{verticesFlattened:this._vertexBuffer,indicesTriangles:d,indicesLineList:p}}_convertIndices(t,n){const a=[];for(let l=0;l<n.length;l++)a.push(this._vertexToIndex(t[2*n[l]],t[2*n[l]+1]));return a}_pointArrayToIndices(t){const n=[];for(let a=0;a<t.length;a++){const l=t[a];n.push(this._vertexToIndex(l.x,l.y))}return n}}function qu(r,t,n,a=!0){return new gf(n,t).subdividePolygonInternal(r,a)}function es(r,t,n=!1){if(!r||r.length<1)return[];if(r.length<2)return[];const a=r[0],l=r[r.length-1],d=n&&(a.x!==l.x||a.y!==l.y);if(t<2)return d?[...r,r[0]]:[...r];const p=Math.floor(Mt/t),m=[];m.push(new Be(r[0].x,r[0].y));const _=r.length,v=d?_:_-1;for(let b=0;b<v;b++){const w=r[b],C=b<_-1?r[b+1]:r[0],A=w.x,k=w.y,D=C.x,B=C.y,U=A!==D,ee=k!==B;if(!U&&!ee)continue;const G=D-A,E=B-k,F=Math.abs(G),q=Math.abs(E);let pe=A,Se=k;for(;;){const _e=G>0?(Math.floor(pe/p)+1)*p:(Math.ceil(pe/p)-1)*p,ze=E>0?(Math.floor(Se/p)+1)*p:(Math.ceil(Se/p)-1)*p,Ie=Math.abs(pe-_e),De=Math.abs(Se-ze),Te=Math.abs(pe-D),Ye=Math.abs(Se-B),dt=U?Ie/F:Number.POSITIVE_INFINITY,ht=ee?De/q:Number.POSITIVE_INFINITY;if((Te<=Ie||!U)&&(Ye<=De||!ee))break;if(dt<ht&&U||!ee){pe=_e,Se+=E*dt;const rt=new Be(pe,Math.round(Se));m[m.length-1].x===rt.x&&m[m.length-1].y===rt.y||m.push(rt)}else{pe+=G*ht,Se=ze;const rt=new Be(Math.round(pe),Se);m[m.length-1].x===rt.x&&m[m.length-1].y===rt.y||m.push(rt)}}const ge=new Be(D,B);m[m.length-1].x===ge.x&&m[m.length-1].y===ge.y||m.push(ge)}return m}function _f(r,t,n){if(t.length===0)throw new Error("Subdivision vertex ring is empty.");let a=0,l=r[2*t[0]];for(let _=1;_<t.length;_++){const v=r[2*t[_]];v<l&&(l=v,a=_)}const d=t.length;let p=a,m=(p+1)%d;for(;;){const _=p-1>=0?p-1:d-1,v=(m+1)%d,b=r[2*t[_]],w=r[2*t[v]],C=r[2*t[p]],A=r[2*t[p]+1],k=r[2*t[m]+1];let D=!1;if(b<w)D=!0;else if(b>w)D=!1;else{const B=k-A,U=-(r[2*t[m]]-C),ee=A<k?1:-1;((b-C)*B+(r[2*t[_]+1]-A)*U)*ee>((w-C)*B+(r[2*t[v]+1]-A)*U)*ee&&(D=!0)}if(D){const B=t[_],U=t[p],ee=t[m];B!==U&&B!==ee&&U!==ee&&n.push(ee,U,B),p--,p<0&&(p=d-1)}else{const B=t[v],U=t[p],ee=t[m];B!==U&&B!==ee&&U!==ee&&n.push(ee,U,B),m++,m>=d&&(m=0)}if(_===v)break}}function Hu(r,t,n,a,l,d,p,m,_){const v=l.length/2,b=p&&m&&_;if(v<ot.MAX_VERTEX_ARRAY_LENGTH){const w=t.prepareSegment(v,n,a),C=w.vertexLength;for(let D=0;D<d.length;D+=3)a.emplaceBack(C+d[D],C+d[D+1],C+d[D+2]);let A,k;w.vertexLength+=v,w.primitiveLength+=d.length/3,b&&(k=p.prepareSegment(v,n,m),A=k.vertexLength,k.vertexLength+=v);for(let D=0;D<l.length;D+=2)r(l[D],l[D+1]);if(b)for(let D=0;D<_.length;D++){const B=_[D];for(let U=1;U<B.length;U+=2)m.emplaceBack(A+B[U-1],A+B[U]);k.primitiveLength+=B.length/2}}else(function(w,C,A,k,D,B){const U=[];for(let q=0;q<k.length/2;q++)U.push(-1);const ee={count:0};let G=0,E=w.getOrCreateLatestSegment(C,A),F=E.vertexLength;for(let q=2;q<D.length;q+=3){const pe=D[q-2],Se=D[q-1],ge=D[q];let _e=U[pe]<G,ze=U[Se]<G,Ie=U[ge]<G;E.vertexLength+((_e?1:0)+(ze?1:0)+(Ie?1:0))>ot.MAX_VERTEX_ARRAY_LENGTH&&(E=w.createNewSegment(C,A),G=ee.count,_e=!0,ze=!0,Ie=!0,F=0);const De=Al(U,k,B,ee,pe,_e,E),Te=Al(U,k,B,ee,Se,ze,E),Ye=Al(U,k,B,ee,ge,Ie,E);A.emplaceBack(F+De-G,F+Te-G,F+Ye-G),E.primitiveLength++}})(t,n,a,l,d,r),b&&function(w,C,A,k,D,B){const U=[];for(let q=0;q<k.length/2;q++)U.push(-1);const ee={count:0};let G=0,E=w.getOrCreateLatestSegment(C,A),F=E.vertexLength;for(let q=0;q<D.length;q++){const pe=D[q];for(let Se=1;Se<D[q].length;Se+=2){const ge=pe[Se-1],_e=pe[Se];let ze=U[ge]<G,Ie=U[_e]<G;E.vertexLength+((ze?1:0)+(Ie?1:0))>ot.MAX_VERTEX_ARRAY_LENGTH&&(E=w.createNewSegment(C,A),G=ee.count,ze=!0,Ie=!0,F=0);const De=Al(U,k,B,ee,ge,ze,E),Te=Al(U,k,B,ee,_e,Ie,E);A.emplaceBack(F+De-G,F+Te-G),E.primitiveLength++}}}(p,n,m,l,_,r),t.forceNewSegmentOnNextPrepare(),p==null||p.forceNewSegmentOnNextPrepare()}function Al(r,t,n,a,l,d,p){if(d){const m=a.count;return n(t[2*l],t[2*l+1]),r[l]=a.count,a.count++,p.vertexLength++,m}return r[l]}class Zh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new W,this.indexArray=new Le,this.indexArray2=new Re,this.programConfigurations=new Qn(t.layers,t.zoom),this.segments=new ot,this.segments2=new ot,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,a){this.hasPattern=Oh("fill",this.layers,n);const l=this.layers[0].layout.get("fill-sort-key"),d=!l.isConstant(),p=[];for(const{feature:m,id:_,index:v,sourceLayerIndex:b}of t){const w=this.layers[0]._featureFilter.needGeometry,C=Ar(m,w);if(!this.layers[0]._featureFilter.filter(new _i(this.zoom),C,a))continue;const A=d?l.evaluate(C,{},a,n.availableImages):void 0,k={id:_,properties:m.properties,type:m.type,sourceLayerIndex:b,index:v,geometry:w?C.geometry:ea(m),patterns:{},sortKey:A};p.push(k)}d&&p.sort((m,_)=>m.sortKey-_.sortKey);for(const m of p){const{geometry:_,index:v,sourceLayerIndex:b}=m;if(this.hasPattern){const w=jh("fill",this.layers,m,this.zoom,n);this.patternFeatures.push(w)}else this.addFeature(m,_,v,a,{},n.subdivisionGranularity);n.featureIndex.insert(t[v].feature,_,v,b,this.index)}}update(t,n,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,n,this.stateDependentLayers,a)}addFeatures(t,n,a){for(const l of this.patternFeatures)this.addFeature(l,l.geometry,l.index,n,a,t.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,sf),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,n,a,l,d,p){for(const m of Ts(n,500)){const _=qu(m,l,p.fill.getGranularityForZoomLevel(l.z)),v=this.layoutVertexArray;Hu((b,w)=>{v.emplaceBack(b,w)},this.segments,this.layoutVertexArray,this.indexArray,_.verticesFlattened,_.indicesTriangles,this.segments2,this.indexArray2,_.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,a,d,l)}}let Wu,Xu;qe("FillBucket",Zh,{omit:["layers","patternFeatures"]});var yf={get paint(){return Xu=Xu||new wr({"fill-antialias":new at(P.paint_fill["fill-antialias"]),"fill-opacity":new mt(P.paint_fill["fill-opacity"]),"fill-color":new mt(P.paint_fill["fill-color"]),"fill-outline-color":new mt(P.paint_fill["fill-outline-color"]),"fill-translate":new at(P.paint_fill["fill-translate"]),"fill-translate-anchor":new at(P.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ka(P.paint_fill["fill-pattern"])})},get layout(){return Wu=Wu||new wr({"fill-sort-key":new mt(P.layout_fill["fill-sort-key"])})}};class vf extends ln{constructor(t){super(t,yf)}recalculate(t,n){super.recalculate(t,n);const a=this.paint._values["fill-outline-color"];a.value.kind==="constant"&&a.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new Zh(t)}queryRadius(){return Bc(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:t,geometry:n,transform:a,pixelsToTileUnits:l}){return io(Oc(t,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-a.bearingInRadians,l),n)}isTileClipped(){return!0}}const xf=Di([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),bf=Di([{name:"a_centroid",components:2,type:"Int16"}],4),{members:wf}=xf;var Uh,Ku,$h,Yu,Gh,Ju,Qu,Zc={};function ed(){if(Ku)return Uh;Ku=1;var r=Qe();function t(l,d,p,m,_){this.properties={},this.extent=p,this.type=0,this._pbf=l,this._geometry=-1,this._keys=m,this._values=_,l.readFields(n,this,d)}function n(l,d,p){l==1?d.id=p.readVarint():l==2?function(m,_){for(var v=m.readVarint()+m.pos;m.pos<v;){var b=_._keys[m.readVarint()],w=_._values[m.readVarint()];_.properties[b]=w}}(p,d):l==3?d.type=p.readVarint():l==4&&(d._geometry=p.pos)}function a(l){for(var d,p,m=0,_=0,v=l.length,b=v-1;_<v;b=_++)m+=((p=l[b]).x-(d=l[_]).x)*(d.y+p.y);return m}return Uh=t,t.types=["Unknown","Point","LineString","Polygon"],t.prototype.loadGeometry=function(){var l=this._pbf;l.pos=this._geometry;for(var d,p=l.readVarint()+l.pos,m=1,_=0,v=0,b=0,w=[];l.pos<p;){if(_<=0){var C=l.readVarint();m=7&C,_=C>>3}if(_--,m===1||m===2)v+=l.readSVarint(),b+=l.readSVarint(),m===1&&(d&&w.push(d),d=[]),d.push(new r(v,b));else{if(m!==7)throw new Error("unknown command "+m);d&&d.push(d[0].clone())}}return d&&w.push(d),w},t.prototype.bbox=function(){var l=this._pbf;l.pos=this._geometry;for(var d=l.readVarint()+l.pos,p=1,m=0,_=0,v=0,b=1/0,w=-1/0,C=1/0,A=-1/0;l.pos<d;){if(m<=0){var k=l.readVarint();p=7&k,m=k>>3}if(m--,p===1||p===2)(_+=l.readSVarint())<b&&(b=_),_>w&&(w=_),(v+=l.readSVarint())<C&&(C=v),v>A&&(A=v);else if(p!==7)throw new Error("unknown command "+p)}return[b,C,w,A]},t.prototype.toGeoJSON=function(l,d,p){var m,_,v=this.extent*Math.pow(2,p),b=this.extent*l,w=this.extent*d,C=this.loadGeometry(),A=t.types[this.type];function k(U){for(var ee=0;ee<U.length;ee++){var G=U[ee];U[ee]=[360*(G.x+b)/v-180,360/Math.PI*Math.atan(Math.exp((180-360*(G.y+w)/v)*Math.PI/180))-90]}}switch(this.type){case 1:var D=[];for(m=0;m<C.length;m++)D[m]=C[m][0];k(C=D);break;case 2:for(m=0;m<C.length;m++)k(C[m]);break;case 3:for(C=function(U){var ee=U.length;if(ee<=1)return[U];for(var G,E,F=[],q=0;q<ee;q++){var pe=a(U[q]);pe!==0&&(E===void 0&&(E=pe<0),E===pe<0?(G&&F.push(G),G=[U[q]]):G.push(U[q]))}return G&&F.push(G),F}(C),m=0;m<C.length;m++)for(_=0;_<C[m].length;_++)k(C[m][_])}C.length===1?C=C[0]:A="Multi"+A;var B={type:"Feature",geometry:{type:A,coordinates:C},properties:this.properties};return"id"in this&&(B.id=this.id),B},Uh}function td(){if(Yu)return $h;Yu=1;var r=ed();function t(a,l){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=a,this._keys=[],this._values=[],this._features=[],a.readFields(n,this,l),this.length=this._features.length}function n(a,l,d){a===15?l.version=d.readVarint():a===1?l.name=d.readString():a===5?l.extent=d.readVarint():a===2?l._features.push(d.pos):a===3?l._keys.push(d.readString()):a===4&&l._values.push(function(p){for(var m=null,_=p.readVarint()+p.pos;p.pos<_;){var v=p.readVarint()>>3;m=v===1?p.readString():v===2?p.readFloat():v===3?p.readDouble():v===4?p.readVarint64():v===5?p.readVarint():v===6?p.readSVarint():v===7?p.readBoolean():null}return m}(d))}return $h=t,t.prototype.feature=function(a){if(a<0||a>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[a];var l=this._pbf.readVarint()+this._pbf.pos;return new r(this._pbf,l,this.extent,this._keys,this._values)},$h}function id(){return Qu||(Qu=1,Zc.VectorTile=function(){if(Ju)return Gh;Ju=1;var r=td();function t(n,a,l){if(n===3){var d=new r(l,l.readVarint()+l.pos);d.length&&(a[d.name]=d)}}return Gh=function(n,a){this.layers=n.readFields(t,{},a)},Gh}(),Zc.VectorTileFeature=ed(),Zc.VectorTileLayer=td()),Zc}var kl=ke(id());const Tf=kl.VectorTileFeature.types,qh=Math.pow(2,13);function zl(r,t,n,a,l,d,p,m){r.emplaceBack(t,n,2*Math.floor(a*qh)+p,l*qh*2,d*qh*2,Math.round(m))}class Hh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new X,this.centroidVertexArray=new N,this.indexArray=new Le,this.programConfigurations=new Qn(t.layers,t.zoom),this.segments=new ot,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,a){this.features=[],this.hasPattern=Oh("fill-extrusion",this.layers,n);for(const{feature:l,id:d,index:p,sourceLayerIndex:m}of t){const _=this.layers[0]._featureFilter.needGeometry,v=Ar(l,_);if(!this.layers[0]._featureFilter.filter(new _i(this.zoom),v,a))continue;const b={id:d,sourceLayerIndex:m,index:p,geometry:_?v.geometry:ea(l),properties:l.properties,type:l.type,patterns:{}};this.hasPattern?this.features.push(jh("fill-extrusion",this.layers,b,this.zoom,n)):this.addFeature(b,b.geometry,p,a,{},n.subdivisionGranularity),n.featureIndex.insert(l,b.geometry,p,m,this.index,!0)}}addFeatures(t,n,a){for(const l of this.features){const{geometry:d}=l;this.addFeature(l,d,l.index,n,a,t.subdivisionGranularity)}}update(t,n,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,n,this.stateDependentLayers,a)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,wf),this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,bf.members,!0),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(t,n,a,l,d,p){for(const m of Ts(n,500)){const _={x:0,y:0,sampleCount:0},v=this.layoutVertexArray.length;this.processPolygon(_,l,t,m,p);const b=this.layoutVertexArray.length-v,w=Math.floor(_.x/_.sampleCount),C=Math.floor(_.y/_.sampleCount);for(let A=0;A<b;A++)this.centroidVertexArray.emplaceBack(w,C)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,a,d,l)}processPolygon(t,n,a,l,d){if(l.length<1||rd(l[0]))return;for(const w of l)w.length!==0&&Pf(t,w);const p={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},m=d.fill.getGranularityForZoomLevel(n.z),_=Tf[a.type]==="Polygon";for(const w of l){if(w.length===0||rd(w))continue;const C=es(w,m,_);this._generateSideFaces(C,p)}if(!_)return;const v=qu(l,n,m,!1),b=this.layoutVertexArray;Hu((w,C)=>{zl(b,w,C,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,v.verticesFlattened,v.indicesTriangles)}_generateSideFaces(t,n){let a=0;for(let l=1;l<t.length;l++){const d=t[l],p=t[l-1];if(Mf(d,p))continue;n.segment.vertexLength+4>ot.MAX_VERTEX_ARRAY_LENGTH&&(n.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const m=d.sub(p)._perp()._unit(),_=p.dist(d);a+_>32768&&(a=0),zl(this.layoutVertexArray,d.x,d.y,m.x,m.y,0,0,a),zl(this.layoutVertexArray,d.x,d.y,m.x,m.y,0,1,a),a+=_,zl(this.layoutVertexArray,p.x,p.y,m.x,m.y,0,0,a),zl(this.layoutVertexArray,p.x,p.y,m.x,m.y,0,1,a);const v=n.segment.vertexLength;this.indexArray.emplaceBack(v,v+2,v+1),this.indexArray.emplaceBack(v+1,v+2,v+3),n.segment.vertexLength+=4,n.segment.primitiveLength+=2}}}function Pf(r,t){for(let n=0;n<t.length;n++){const a=t[n];n===t.length-1&&t[0].x===a.x&&t[0].y===a.y||(r.x+=a.x,r.y+=a.y,r.sampleCount++)}}function Mf(r,t){return r.x===t.x&&(r.x<0||r.x>Mt)||r.y===t.y&&(r.y<0||r.y>Mt)}function rd(r){return r.every(t=>t.x<0)||r.every(t=>t.x>Mt)||r.every(t=>t.y<0)||r.every(t=>t.y>Mt)}let nd;qe("FillExtrusionBucket",Hh,{omit:["layers","features"]});var Sf={get paint(){return nd=nd||new wr({"fill-extrusion-opacity":new at(P["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new mt(P["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new at(P["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new at(P["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ka(P["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new mt(P["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new mt(P["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new at(P["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Cf extends ln{constructor(t){super(t,Sf)}createBucket(t){return new Hh(t)}queryRadius(){return Bc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:t,feature:n,featureState:a,geometry:l,transform:d,pixelsToTileUnits:p,pixelPosMatrix:m}){const _=Oc(t,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-d.bearingInRadians,p),v=this.paint.get("fill-extrusion-height").evaluate(n,a),b=this.paint.get("fill-extrusion-base").evaluate(n,a),w=function(A,k,D){const B=[];for(const U of A){const ee=[U.x,U.y,0,1];bt(ee,ee,k),B.push(new Be(ee[0]/ee[3],ee[1]/ee[3]))}return B}(_,m),C=function(A,k,D,B){const U=[],ee=[],G=B[8]*k,E=B[9]*k,F=B[10]*k,q=B[11]*k,pe=B[8]*D,Se=B[9]*D,ge=B[10]*D,_e=B[11]*D;for(const ze of A){const Ie=[],De=[];for(const Te of ze){const Ye=Te.x,dt=Te.y,ht=B[0]*Ye+B[4]*dt+B[12],rt=B[1]*Ye+B[5]*dt+B[13],Lt=B[2]*Ye+B[6]*dt+B[14],Ci=B[3]*Ye+B[7]*dt+B[15],qi=Lt+F,ur=Ci+q,tn=ht+pe,zr=rt+Se,ar=Lt+ge,bi=Ci+_e,Ji=new Be((ht+G)/ur,(rt+E)/ur);Ji.z=qi/ur,Ie.push(Ji);const sr=new Be(tn/bi,zr/bi);sr.z=ar/bi,De.push(sr)}U.push(Ie),ee.push(De)}return[U,ee]}(l,b,v,m);return function(A,k,D){let B=1/0;io(D,k)&&(B=ad(D,k[0]));for(let U=0;U<k.length;U++){const ee=k[U],G=A[U];for(let E=0;E<ee.length-1;E++){const F=ee[E],q=[F,ee[E+1],G[E+1],G[E],F];to(D,q)&&(B=Math.min(B,ad(D,q)))}}return B!==1/0&&B}(C[0],C[1],w)}}function Dl(r,t){return r.x*t.x+r.y*t.y}function ad(r,t){if(r.length===1){let n=0;const a=t[n++];let l;for(;!l||a.equals(l);)if(l=t[n++],!l)return 1/0;for(;n<t.length;n++){const d=t[n],p=r[0],m=l.sub(a),_=d.sub(a),v=p.sub(a),b=Dl(m,m),w=Dl(m,_),C=Dl(_,_),A=Dl(v,m),k=Dl(v,_),D=b*C-w*w,B=(C*A-w*k)/D,U=(b*k-w*A)/D,ee=a.z*(1-B-U)+l.z*B+d.z*U;if(isFinite(ee))return ee}return 1/0}{let n=1/0;for(const a of t)n=Math.min(n,a.z);return n}}const If=Di([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:Ef}=If,Af=Di([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:kf}=Af,zf=kl.VectorTileFeature.types,Df=Math.cos(Math.PI/180*37.5),sd=Math.pow(2,14)/.5;class Wh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new J,this.layoutVertexArray2=new ie,this.indexArray=new Le,this.programConfigurations=new Qn(t.layers,t.zoom),this.segments=new ot,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,a){this.hasPattern=Oh("line",this.layers,n);const l=this.layers[0].layout.get("line-sort-key"),d=!l.isConstant(),p=[];for(const{feature:m,id:_,index:v,sourceLayerIndex:b}of t){const w=this.layers[0]._featureFilter.needGeometry,C=Ar(m,w);if(!this.layers[0]._featureFilter.filter(new _i(this.zoom),C,a))continue;const A=d?l.evaluate(C,{},a):void 0,k={id:_,properties:m.properties,type:m.type,sourceLayerIndex:b,index:v,geometry:w?C.geometry:ea(m),patterns:{},sortKey:A};p.push(k)}d&&p.sort((m,_)=>m.sortKey-_.sortKey);for(const m of p){const{geometry:_,index:v,sourceLayerIndex:b}=m;if(this.hasPattern){const w=jh("line",this.layers,m,this.zoom,n);this.patternFeatures.push(w)}else this.addFeature(m,_,v,a,{},n.subdivisionGranularity);n.featureIndex.insert(t[v].feature,_,v,b,this.index)}}update(t,n,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,n,this.stateDependentLayers,a)}addFeatures(t,n,a){for(const l of this.patternFeatures)this.addFeature(l,l.geometry,l.index,n,a,t.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,kf)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ef),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,n,a,l,d,p){const m=this.layers[0].layout,_=m.get("line-join").evaluate(t,{}),v=m.get("line-cap"),b=m.get("line-miter-limit"),w=m.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const C of n)this.addLine(C,t,_,v,b,w,l,p);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,a,d,l)}addLine(t,n,a,l,d,p,m,_){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,t=es(t,m?_.line.getGranularityForZoomLevel(m.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let G=0;G<t.length-1;G++)this.totalDistance+=t[G].dist(t[G+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const v=zf[n.type]==="Polygon";let b=t.length;for(;b>=2&&t[b-1].equals(t[b-2]);)b--;let w=0;for(;w<b-1&&t[w].equals(t[w+1]);)w++;if(b<(v?3:2))return;a==="bevel"&&(d=1.05);const C=this.overscaling<=16?15*Mt/(512*this.overscaling):0,A=this.segments.prepareSegment(10*b,this.layoutVertexArray,this.indexArray);let k,D,B,U,ee;this.e1=this.e2=-1,v&&(k=t[b-2],ee=t[w].sub(k)._unit()._perp());for(let G=w;G<b;G++){if(B=G===b-1?v?t[w+1]:void 0:t[G+1],B&&t[G].equals(B))continue;ee&&(U=ee),k&&(D=k),k=t[G],ee=B?B.sub(k)._unit()._perp():U,U=U||ee;let E=U.add(ee);E.x===0&&E.y===0||E._unit();const F=U.x*ee.x+U.y*ee.y,q=E.x*ee.x+E.y*ee.y,pe=q!==0?1/q:1/0,Se=2*Math.sqrt(2-2*q),ge=q<Df&&D&&B,_e=U.x*ee.y-U.y*ee.x>0;if(ge&&G>w){const De=k.dist(D);if(De>2*C){const Te=k.sub(k.sub(D)._mult(C/De)._round());this.updateDistance(D,Te),this.addCurrentVertex(Te,U,0,0,A),D=Te}}const ze=D&&B;let Ie=ze?a:v?"butt":l;if(ze&&Ie==="round"&&(pe<p?Ie="miter":pe<=2&&(Ie="fakeround")),Ie==="miter"&&pe>d&&(Ie="bevel"),Ie==="bevel"&&(pe>2&&(Ie="flipbevel"),pe<d&&(Ie="miter")),D&&this.updateDistance(D,k),Ie==="miter")E._mult(pe),this.addCurrentVertex(k,E,0,0,A);else if(Ie==="flipbevel"){if(pe>100)E=ee.mult(-1);else{const De=pe*U.add(ee).mag()/U.sub(ee).mag();E._perp()._mult(De*(_e?-1:1))}this.addCurrentVertex(k,E,0,0,A),this.addCurrentVertex(k,E.mult(-1),0,0,A)}else if(Ie==="bevel"||Ie==="fakeround"){const De=-Math.sqrt(pe*pe-1),Te=_e?De:0,Ye=_e?0:De;if(D&&this.addCurrentVertex(k,U,Te,Ye,A),Ie==="fakeround"){const dt=Math.round(180*Se/Math.PI/20);for(let ht=1;ht<dt;ht++){let rt=ht/dt;if(rt!==.5){const Ci=rt-.5;rt+=rt*Ci*(rt-1)*((1.0904+F*(F*(3.55645-1.43519*F)-3.2452))*Ci*Ci+(.848013+F*(.215638*F-1.06021)))}const Lt=ee.sub(U)._mult(rt)._add(U)._unit()._mult(_e?-1:1);this.addHalfVertex(k,Lt.x,Lt.y,!1,_e,0,A)}}B&&this.addCurrentVertex(k,ee,-Te,-Ye,A)}else if(Ie==="butt")this.addCurrentVertex(k,E,0,0,A);else if(Ie==="square"){const De=D?1:-1;this.addCurrentVertex(k,E,De,De,A)}else Ie==="round"&&(D&&(this.addCurrentVertex(k,U,0,0,A),this.addCurrentVertex(k,U,1,1,A,!0)),B&&(this.addCurrentVertex(k,ee,-1,-1,A,!0),this.addCurrentVertex(k,ee,0,0,A)));if(ge&&G<b-1){const De=k.dist(B);if(De>2*C){const Te=k.add(B.sub(k)._mult(C/De)._round());this.updateDistance(k,Te),this.addCurrentVertex(Te,ee,0,0,A),k=Te}}}}addCurrentVertex(t,n,a,l,d,p=!1){const m=n.y*l-n.x,_=-n.y-n.x*l;this.addHalfVertex(t,n.x+n.y*a,n.y-n.x*a,p,!1,a,d),this.addHalfVertex(t,m,_,p,!0,-l,d),this.distance>sd/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,n,a,l,d,p))}addHalfVertex({x:t,y:n},a,l,d,p,m,_){const v=.5*(this.lineClips?this.scaledDistance*(sd-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((t<<1)+(d?1:0),(n<<1)+(p?1:0),Math.round(63*a)+128,Math.round(63*l)+128,1+(m===0?0:m<0?-1:1)|(63&v)<<2,v>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const b=_.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,b,this.e2),_.primitiveLength++),p?this.e2=b:this.e1=b}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(t,n){this.distance+=t.dist(n),this.updateScaledDistance()}}let od,ld;qe("LineBucket",Wh,{omit:["layers","patternFeatures"]});var cd={get paint(){return ld=ld||new wr({"line-opacity":new mt(P.paint_line["line-opacity"]),"line-color":new mt(P.paint_line["line-color"]),"line-translate":new at(P.paint_line["line-translate"]),"line-translate-anchor":new at(P.paint_line["line-translate-anchor"]),"line-width":new mt(P.paint_line["line-width"]),"line-gap-width":new mt(P.paint_line["line-gap-width"]),"line-offset":new mt(P.paint_line["line-offset"]),"line-blur":new mt(P.paint_line["line-blur"]),"line-dasharray":new qs(P.paint_line["line-dasharray"]),"line-pattern":new Ka(P.paint_line["line-pattern"]),"line-gradient":new gl(P.paint_line["line-gradient"])})},get layout(){return od=od||new wr({"line-cap":new at(P.layout_line["line-cap"]),"line-join":new mt(P.layout_line["line-join"]),"line-miter-limit":new at(P.layout_line["line-miter-limit"]),"line-round-limit":new at(P.layout_line["line-round-limit"]),"line-sort-key":new mt(P.layout_line["line-sort-key"])})}};class Rf extends mt{possiblyEvaluate(t,n){return n=new _i(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,zoomHistory:n.zoomHistory,transition:n.transition}),super.possiblyEvaluate(t,n)}evaluate(t,n,a,l){return n=Ge({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(t,n,a,l)}}let Uc;class Lf extends ln{constructor(t){super(t,cd),this.gradientVersion=0,Uc||(Uc=new Rf(cd.paint.properties["line-width"].specification),Uc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const n=this.gradientExpression();this.stepInterpolant=!!function(a){return a._styleExpression!==void 0}(n)&&n._styleExpression.expression instanceof ua,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(t,n){super.recalculate(t,n),this.paint._values["line-floorwidth"]=Uc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Wh(t)}queryRadius(t){const n=t,a=hd(Tl("line-width",this,n),Tl("line-gap-width",this,n)),l=Tl("line-offset",this,n);return a/2+Math.abs(l)+Bc(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:t,feature:n,featureState:a,geometry:l,transform:d,pixelsToTileUnits:p}){const m=Oc(t,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-d.bearingInRadians,p),_=p/2*hd(this.paint.get("line-width").evaluate(n,a),this.paint.get("line-gap-width").evaluate(n,a)),v=this.paint.get("line-offset").evaluate(n,a);return v&&(l=function(b,w){const C=[];for(let A=0;A<b.length;A++){const k=b[A],D=[];for(let B=0;B<k.length;B++){const U=k[B-1],ee=k[B],G=k[B+1],E=B===0?new Be(0,0):ee.sub(U)._unit()._perp(),F=B===k.length-1?new Be(0,0):G.sub(ee)._unit()._perp(),q=E._add(F)._unit(),pe=q.x*F.x+q.y*F.y;pe!==0&&q._mult(1/pe),D.push(q._mult(w)._add(ee))}C.push(D)}return C}(l,v*p)),function(b,w,C){for(let A=0;A<w.length;A++){const k=w[A];if(b.length>=3){for(let D=0;D<k.length;D++)if(ro(b,k[D]))return!0}if(Xp(b,k,C))return!0}return!1}(m,l,_)}isTileClipped(){return!0}}function hd(r,t){return t>0?t+2*r:r}const Ff=Di([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Bf=Di([{name:"a_projected_pos",components:3,type:"Float32"}],4);Di([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Of=Di([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Di([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const ud=Di([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),jf=Di([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Vf(r,t,n){return r.sections.forEach(a=>{a.text=function(l,d,p){const m=d.layout.get("text-transform").evaluate(p,{});return m==="uppercase"?l=l.toLocaleUpperCase():m==="lowercase"&&(l=l.toLocaleLowerCase()),An.applyArabicShaping&&(l=An.applyArabicShaping(l)),l}(a.text,t,n)}),r}Di([{name:"triangle",components:3,type:"Uint16"}]),Di([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Di([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Di([{type:"Float32",name:"offsetX"}]),Di([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Di([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const Rl={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var dd,Xh,pd,Gi=24,Kh={};function Nf(){return dd||(dd=1,Kh.read=function(r,t,n,a,l){var d,p,m=8*l-a-1,_=(1<<m)-1,v=_>>1,b=-7,w=n?l-1:0,C=n?-1:1,A=r[t+w];for(w+=C,d=A&(1<<-b)-1,A>>=-b,b+=m;b>0;d=256*d+r[t+w],w+=C,b-=8);for(p=d&(1<<-b)-1,d>>=-b,b+=a;b>0;p=256*p+r[t+w],w+=C,b-=8);if(d===0)d=1-v;else{if(d===_)return p?NaN:1/0*(A?-1:1);p+=Math.pow(2,a),d-=v}return(A?-1:1)*p*Math.pow(2,d-a)},Kh.write=function(r,t,n,a,l,d){var p,m,_,v=8*d-l-1,b=(1<<v)-1,w=b>>1,C=l===23?Math.pow(2,-24)-Math.pow(2,-77):0,A=a?0:d-1,k=a?1:-1,D=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(m=isNaN(t)?1:0,p=b):(p=Math.floor(Math.log(t)/Math.LN2),t*(_=Math.pow(2,-p))<1&&(p--,_*=2),(t+=p+w>=1?C/_:C*Math.pow(2,1-w))*_>=2&&(p++,_/=2),p+w>=b?(m=0,p=b):p+w>=1?(m=(t*_-1)*Math.pow(2,l),p+=w):(m=t*Math.pow(2,w-1)*Math.pow(2,l),p=0));l>=8;r[n+A]=255&m,A+=k,m/=256,l-=8);for(p=p<<l|m,v+=l;v>0;r[n+A]=255&p,A+=k,p/=256,v-=8);r[n+A-k]|=128*D}),Kh}function fd(){if(pd)return Xh;pd=1,Xh=t;var r=Nf();function t(E){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(E)?E:new Uint8Array(E||0),this.pos=0,this.type=0,this.length=this.buf.length}t.Varint=0,t.Fixed64=1,t.Bytes=2,t.Fixed32=5;var n=4294967296,a=1/n,l=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function d(E){return E.type===t.Bytes?E.readVarint()+E.pos:E.pos+1}function p(E,F,q){return q?4294967296*F+(E>>>0):4294967296*(F>>>0)+(E>>>0)}function m(E,F,q){var pe=F<=16383?1:F<=2097151?2:F<=268435455?3:Math.floor(Math.log(F)/(7*Math.LN2));q.realloc(pe);for(var Se=q.pos-1;Se>=E;Se--)q.buf[Se+pe]=q.buf[Se]}function _(E,F){for(var q=0;q<E.length;q++)F.writeVarint(E[q])}function v(E,F){for(var q=0;q<E.length;q++)F.writeSVarint(E[q])}function b(E,F){for(var q=0;q<E.length;q++)F.writeFloat(E[q])}function w(E,F){for(var q=0;q<E.length;q++)F.writeDouble(E[q])}function C(E,F){for(var q=0;q<E.length;q++)F.writeBoolean(E[q])}function A(E,F){for(var q=0;q<E.length;q++)F.writeFixed32(E[q])}function k(E,F){for(var q=0;q<E.length;q++)F.writeSFixed32(E[q])}function D(E,F){for(var q=0;q<E.length;q++)F.writeFixed64(E[q])}function B(E,F){for(var q=0;q<E.length;q++)F.writeSFixed64(E[q])}function U(E,F){return(E[F]|E[F+1]<<8|E[F+2]<<16)+16777216*E[F+3]}function ee(E,F,q){E[q]=F,E[q+1]=F>>>8,E[q+2]=F>>>16,E[q+3]=F>>>24}function G(E,F){return(E[F]|E[F+1]<<8|E[F+2]<<16)+(E[F+3]<<24)}return t.prototype={destroy:function(){this.buf=null},readFields:function(E,F,q){for(q=q||this.length;this.pos<q;){var pe=this.readVarint(),Se=pe>>3,ge=this.pos;this.type=7&pe,E(Se,F,this),this.pos===ge&&this.skip(pe)}return F},readMessage:function(E,F){return this.readFields(E,F,this.readVarint()+this.pos)},readFixed32:function(){var E=U(this.buf,this.pos);return this.pos+=4,E},readSFixed32:function(){var E=G(this.buf,this.pos);return this.pos+=4,E},readFixed64:function(){var E=U(this.buf,this.pos)+U(this.buf,this.pos+4)*n;return this.pos+=8,E},readSFixed64:function(){var E=U(this.buf,this.pos)+G(this.buf,this.pos+4)*n;return this.pos+=8,E},readFloat:function(){var E=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,E},readDouble:function(){var E=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,E},readVarint:function(E){var F,q,pe=this.buf;return F=127&(q=pe[this.pos++]),q<128?F:(F|=(127&(q=pe[this.pos++]))<<7,q<128?F:(F|=(127&(q=pe[this.pos++]))<<14,q<128?F:(F|=(127&(q=pe[this.pos++]))<<21,q<128?F:function(Se,ge,_e){var ze,Ie,De=_e.buf;if(ze=(112&(Ie=De[_e.pos++]))>>4,Ie<128||(ze|=(127&(Ie=De[_e.pos++]))<<3,Ie<128)||(ze|=(127&(Ie=De[_e.pos++]))<<10,Ie<128)||(ze|=(127&(Ie=De[_e.pos++]))<<17,Ie<128)||(ze|=(127&(Ie=De[_e.pos++]))<<24,Ie<128)||(ze|=(1&(Ie=De[_e.pos++]))<<31,Ie<128))return p(Se,ze,ge);throw new Error("Expected varint not more than 10 bytes")}(F|=(15&(q=pe[this.pos]))<<28,E,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var E=this.readVarint();return E%2==1?(E+1)/-2:E/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var E=this.readVarint()+this.pos,F=this.pos;return this.pos=E,E-F>=12&&l?function(q,pe,Se){return l.decode(q.subarray(pe,Se))}(this.buf,F,E):function(q,pe,Se){for(var ge="",_e=pe;_e<Se;){var ze,Ie,De,Te=q[_e],Ye=null,dt=Te>239?4:Te>223?3:Te>191?2:1;if(_e+dt>Se)break;dt===1?Te<128&&(Ye=Te):dt===2?(192&(ze=q[_e+1]))==128&&(Ye=(31&Te)<<6|63&ze)<=127&&(Ye=null):dt===3?(Ie=q[_e+2],(192&(ze=q[_e+1]))==128&&(192&Ie)==128&&((Ye=(15&Te)<<12|(63&ze)<<6|63&Ie)<=2047||Ye>=55296&&Ye<=57343)&&(Ye=null)):dt===4&&(Ie=q[_e+2],De=q[_e+3],(192&(ze=q[_e+1]))==128&&(192&Ie)==128&&(192&De)==128&&((Ye=(15&Te)<<18|(63&ze)<<12|(63&Ie)<<6|63&De)<=65535||Ye>=1114112)&&(Ye=null)),Ye===null?(Ye=65533,dt=1):Ye>65535&&(Ye-=65536,ge+=String.fromCharCode(Ye>>>10&1023|55296),Ye=56320|1023&Ye),ge+=String.fromCharCode(Ye),_e+=dt}return ge}(this.buf,F,E)},readBytes:function(){var E=this.readVarint()+this.pos,F=this.buf.subarray(this.pos,E);return this.pos=E,F},readPackedVarint:function(E,F){if(this.type!==t.Bytes)return E.push(this.readVarint(F));var q=d(this);for(E=E||[];this.pos<q;)E.push(this.readVarint(F));return E},readPackedSVarint:function(E){if(this.type!==t.Bytes)return E.push(this.readSVarint());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readSVarint());return E},readPackedBoolean:function(E){if(this.type!==t.Bytes)return E.push(this.readBoolean());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readBoolean());return E},readPackedFloat:function(E){if(this.type!==t.Bytes)return E.push(this.readFloat());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readFloat());return E},readPackedDouble:function(E){if(this.type!==t.Bytes)return E.push(this.readDouble());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readDouble());return E},readPackedFixed32:function(E){if(this.type!==t.Bytes)return E.push(this.readFixed32());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readFixed32());return E},readPackedSFixed32:function(E){if(this.type!==t.Bytes)return E.push(this.readSFixed32());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readSFixed32());return E},readPackedFixed64:function(E){if(this.type!==t.Bytes)return E.push(this.readFixed64());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readFixed64());return E},readPackedSFixed64:function(E){if(this.type!==t.Bytes)return E.push(this.readSFixed64());var F=d(this);for(E=E||[];this.pos<F;)E.push(this.readSFixed64());return E},skip:function(E){var F=7&E;if(F===t.Varint)for(;this.buf[this.pos++]>127;);else if(F===t.Bytes)this.pos=this.readVarint()+this.pos;else if(F===t.Fixed32)this.pos+=4;else{if(F!==t.Fixed64)throw new Error("Unimplemented type: "+F);this.pos+=8}},writeTag:function(E,F){this.writeVarint(E<<3|F)},realloc:function(E){for(var F=this.length||16;F<this.pos+E;)F*=2;if(F!==this.length){var q=new Uint8Array(F);q.set(this.buf),this.buf=q,this.length=F}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(E){this.realloc(4),ee(this.buf,E,this.pos),this.pos+=4},writeSFixed32:function(E){this.realloc(4),ee(this.buf,E,this.pos),this.pos+=4},writeFixed64:function(E){this.realloc(8),ee(this.buf,-1&E,this.pos),ee(this.buf,Math.floor(E*a),this.pos+4),this.pos+=8},writeSFixed64:function(E){this.realloc(8),ee(this.buf,-1&E,this.pos),ee(this.buf,Math.floor(E*a),this.pos+4),this.pos+=8},writeVarint:function(E){(E=+E||0)>268435455||E<0?function(F,q){var pe,Se;if(F>=0?(pe=F%4294967296|0,Se=F/4294967296|0):(Se=~(-F/4294967296),4294967295^(pe=~(-F%4294967296))?pe=pe+1|0:(pe=0,Se=Se+1|0)),F>=18446744073709552e3||F<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");q.realloc(10),function(ge,_e,ze){ze.buf[ze.pos++]=127&ge|128,ge>>>=7,ze.buf[ze.pos++]=127&ge|128,ge>>>=7,ze.buf[ze.pos++]=127&ge|128,ge>>>=7,ze.buf[ze.pos++]=127&ge|128,ze.buf[ze.pos]=127&(ge>>>=7)}(pe,0,q),function(ge,_e){var ze=(7&ge)<<4;_e.buf[_e.pos++]|=ze|((ge>>>=3)?128:0),ge&&(_e.buf[_e.pos++]=127&ge|((ge>>>=7)?128:0),ge&&(_e.buf[_e.pos++]=127&ge|((ge>>>=7)?128:0),ge&&(_e.buf[_e.pos++]=127&ge|((ge>>>=7)?128:0),ge&&(_e.buf[_e.pos++]=127&ge|((ge>>>=7)?128:0),ge&&(_e.buf[_e.pos++]=127&ge)))))}(Se,q)}(E,this):(this.realloc(4),this.buf[this.pos++]=127&E|(E>127?128:0),E<=127||(this.buf[this.pos++]=127&(E>>>=7)|(E>127?128:0),E<=127||(this.buf[this.pos++]=127&(E>>>=7)|(E>127?128:0),E<=127||(this.buf[this.pos++]=E>>>7&127))))},writeSVarint:function(E){this.writeVarint(E<0?2*-E-1:2*E)},writeBoolean:function(E){this.writeVarint(!!E)},writeString:function(E){E=String(E),this.realloc(4*E.length),this.pos++;var F=this.pos;this.pos=function(pe,Se,ge){for(var _e,ze,Ie=0;Ie<Se.length;Ie++){if((_e=Se.charCodeAt(Ie))>55295&&_e<57344){if(!ze){_e>56319||Ie+1===Se.length?(pe[ge++]=239,pe[ge++]=191,pe[ge++]=189):ze=_e;continue}if(_e<56320){pe[ge++]=239,pe[ge++]=191,pe[ge++]=189,ze=_e;continue}_e=ze-55296<<10|_e-56320|65536,ze=null}else ze&&(pe[ge++]=239,pe[ge++]=191,pe[ge++]=189,ze=null);_e<128?pe[ge++]=_e:(_e<2048?pe[ge++]=_e>>6|192:(_e<65536?pe[ge++]=_e>>12|224:(pe[ge++]=_e>>18|240,pe[ge++]=_e>>12&63|128),pe[ge++]=_e>>6&63|128),pe[ge++]=63&_e|128)}return ge}(this.buf,E,this.pos);var q=this.pos-F;q>=128&&m(F,q,this),this.pos=F-1,this.writeVarint(q),this.pos+=q},writeFloat:function(E){this.realloc(4),r.write(this.buf,E,this.pos,!0,23,4),this.pos+=4},writeDouble:function(E){this.realloc(8),r.write(this.buf,E,this.pos,!0,52,8),this.pos+=8},writeBytes:function(E){var F=E.length;this.writeVarint(F),this.realloc(F);for(var q=0;q<F;q++)this.buf[this.pos++]=E[q]},writeRawMessage:function(E,F){this.pos++;var q=this.pos;E(F,this);var pe=this.pos-q;pe>=128&&m(q,pe,this),this.pos=q-1,this.writeVarint(pe),this.pos+=pe},writeMessage:function(E,F,q){this.writeTag(E,t.Bytes),this.writeRawMessage(F,q)},writePackedVarint:function(E,F){F.length&&this.writeMessage(E,_,F)},writePackedSVarint:function(E,F){F.length&&this.writeMessage(E,v,F)},writePackedBoolean:function(E,F){F.length&&this.writeMessage(E,C,F)},writePackedFloat:function(E,F){F.length&&this.writeMessage(E,b,F)},writePackedDouble:function(E,F){F.length&&this.writeMessage(E,w,F)},writePackedFixed32:function(E,F){F.length&&this.writeMessage(E,A,F)},writePackedSFixed32:function(E,F){F.length&&this.writeMessage(E,k,F)},writePackedFixed64:function(E,F){F.length&&this.writeMessage(E,D,F)},writePackedSFixed64:function(E,F){F.length&&this.writeMessage(E,B,F)},writeBytesField:function(E,F){this.writeTag(E,t.Bytes),this.writeBytes(F)},writeFixed32Field:function(E,F){this.writeTag(E,t.Fixed32),this.writeFixed32(F)},writeSFixed32Field:function(E,F){this.writeTag(E,t.Fixed32),this.writeSFixed32(F)},writeFixed64Field:function(E,F){this.writeTag(E,t.Fixed64),this.writeFixed64(F)},writeSFixed64Field:function(E,F){this.writeTag(E,t.Fixed64),this.writeSFixed64(F)},writeVarintField:function(E,F){this.writeTag(E,t.Varint),this.writeVarint(F)},writeSVarintField:function(E,F){this.writeTag(E,t.Varint),this.writeSVarint(F)},writeStringField:function(E,F){this.writeTag(E,t.Bytes),this.writeString(F)},writeFloatField:function(E,F){this.writeTag(E,t.Fixed32),this.writeFloat(F)},writeDoubleField:function(E,F){this.writeTag(E,t.Fixed64),this.writeDouble(F)},writeBooleanField:function(E,F){this.writeVarintField(E,!!F)}},Xh}var Yh=ke(fd());const Jh=3;function Zf(r,t,n){r===1&&n.readMessage(Uf,t)}function Uf(r,t,n){if(r===3){const{id:a,bitmap:l,width:d,height:p,left:m,top:_,advance:v}=n.readMessage($f,{});t.push({id:a,bitmap:new Pl({width:d+2*Jh,height:p+2*Jh},l),metrics:{width:d,height:p,left:m,top:_,advance:v}})}}function $f(r,t,n){r===1?t.id=n.readVarint():r===2?t.bitmap=n.readBytes():r===3?t.width=n.readVarint():r===4?t.height=n.readVarint():r===5?t.left=n.readSVarint():r===6?t.top=n.readSVarint():r===7&&(t.advance=n.readVarint())}const Gf=Jh;function md(r){let t=0,n=0;for(const p of r)t+=p.w*p.h,n=Math.max(n,p.w);r.sort((p,m)=>m.h-p.h);const a=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),n),h:1/0}];let l=0,d=0;for(const p of r)for(let m=a.length-1;m>=0;m--){const _=a[m];if(!(p.w>_.w||p.h>_.h)){if(p.x=_.x,p.y=_.y,d=Math.max(d,p.y+p.h),l=Math.max(l,p.x+p.w),p.w===_.w&&p.h===_.h){const v=a.pop();m<a.length&&(a[m]=v)}else p.h===_.h?(_.x+=p.w,_.w-=p.w):p.w===_.w?(_.y+=p.h,_.h-=p.h):(a.push({x:_.x+p.w,y:_.y,w:_.w-p.w,h:p.h}),_.y+=p.h,_.h-=p.h);break}}return{w:l,h:d,fill:t/(l*d)||0}}const kr=1;class Qh{constructor(t,{pixelRatio:n,version:a,stretchX:l,stretchY:d,content:p,textFitWidth:m,textFitHeight:_}){this.paddedRect=t,this.pixelRatio=n,this.stretchX=l,this.stretchY=d,this.content=p,this.version=a,this.textFitWidth=m,this.textFitHeight=_}get tl(){return[this.paddedRect.x+kr,this.paddedRect.y+kr]}get br(){return[this.paddedRect.x+this.paddedRect.w-kr,this.paddedRect.y+this.paddedRect.h-kr]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*kr)/this.pixelRatio,(this.paddedRect.h-2*kr)/this.pixelRatio]}}class gd{constructor(t,n){const a={},l={};this.haveRenderCallbacks=[];const d=[];this.addImages(t,a,d),this.addImages(n,l,d);const{w:p,h:m}=md(d),_=new Qr({width:p||1,height:m||1});for(const v in t){const b=t[v],w=a[v].paddedRect;Qr.copy(b.data,_,{x:0,y:0},{x:w.x+kr,y:w.y+kr},b.data)}for(const v in n){const b=n[v],w=l[v].paddedRect,C=w.x+kr,A=w.y+kr,k=b.data.width,D=b.data.height;Qr.copy(b.data,_,{x:0,y:0},{x:C,y:A},b.data),Qr.copy(b.data,_,{x:0,y:D-1},{x:C,y:A-1},{width:k,height:1}),Qr.copy(b.data,_,{x:0,y:0},{x:C,y:A+D},{width:k,height:1}),Qr.copy(b.data,_,{x:k-1,y:0},{x:C-1,y:A},{width:1,height:D}),Qr.copy(b.data,_,{x:0,y:0},{x:C+k,y:A},{width:1,height:D})}this.image=_,this.iconPositions=a,this.patternPositions=l}addImages(t,n,a){for(const l in t){const d=t[l],p={x:0,y:0,w:d.data.width+2*kr,h:d.data.height+2*kr};a.push(p),n[l]=new Qh(p,d),d.hasRenderCallback&&this.haveRenderCallbacks.push(l)}}patchUpdatedImages(t,n){t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const a in t.updatedImages)this.patchUpdatedImage(this.iconPositions[a],t.getImage(a),n),this.patchUpdatedImage(this.patternPositions[a],t.getImage(a),n)}patchUpdatedImage(t,n,a){if(!t||!n||t.version===n.version)return;t.version=n.version;const[l,d]=t.tl;a.update(n.data,void 0,{x:l,y:d})}}var Ma;qe("ImagePosition",Qh),qe("ImageAtlas",gd),I.ag=void 0,(Ma=I.ag||(I.ag={}))[Ma.none=0]="none",Ma[Ma.horizontal=1]="horizontal",Ma[Ma.vertical=2]="vertical",Ma[Ma.horizontalOnly=3]="horizontalOnly";const $c=-17;class Ll{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(t,n,a){const l=new Ll;return l.scale=t||1,l.fontStack=n,l.verticalAlign=a||"bottom",l}static forImage(t,n){const a=new Ll;return a.imageName=t,a.verticalAlign=n||"bottom",a}}class oo{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,n){const a=new oo;for(let l=0;l<t.sections.length;l++){const d=t.sections[l];d.image?a.addImageSection(d):a.addTextSection(d,n)}return a}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(){this.text=function(t){let n="";for(let a=0;a<t.length;a++){const l=t.charCodeAt(a+1)||null,d=t.charCodeAt(a-1)||null;n+=l&&dl(l)&&!Rl[t[a+1]]||d&&dl(d)&&!Rl[t[a-1]]||!Rl[t[a]]?t[a]:Rl[t[a]]}return n}(this.text)}trim(){let t=0;for(let a=0;a<this.text.length&&qc[this.text.charCodeAt(a)];a++)t++;let n=this.text.length;for(let a=this.text.length-1;a>=0&&a>=t&&qc[this.text.charCodeAt(a)];a--)n--;this.text=this.text.substring(t,n),this.sectionIndex=this.sectionIndex.slice(t,n)}substring(t,n){const a=new oo;return a.text=this.text.substring(t,n),a.sectionIndex=this.sectionIndex.slice(t,n),a.sections=this.sections,a}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,n)=>Math.max(t,this.sections[n].scale),0)}getMaxImageSize(t){let n=0,a=0;for(let l=0;l<this.length();l++){const d=this.getSection(l);if(d.imageName){const p=t[d.imageName];if(!p)continue;const m=p.displaySize;n=Math.max(n,m[0]),a=Math.max(a,m[1])}}return{maxImageWidth:n,maxImageHeight:a}}addTextSection(t,n){this.text+=t.text,this.sections.push(Ll.forText(t.scale,t.fontStack||n,t.verticalAlign));const a=this.sections.length-1;for(let l=0;l<t.text.length;++l)this.sectionIndex.push(a)}addImageSection(t){const n=t.image?t.image.name:"";if(n.length===0)return void xi("Can't add FormattedSection with an empty image.");const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCharCode(a),this.sections.push(Ll.forImage(n,t.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):xi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Gc(r,t,n,a,l,d,p,m,_,v,b,w,C,A,k){const D=oo.fromFeature(r,l);let B;w===I.ag.vertical&&D.verticalizePunctuation();const{processBidirectionalText:U,processStyledBidirectionalText:ee}=An;if(U&&D.sections.length===1){B=[];const F=U(D.toString(),eu(D,v,d,t,a,A));for(const q of F){const pe=new oo;pe.text=q,pe.sections=D.sections;for(let Se=0;Se<q.length;Se++)pe.sectionIndex.push(0);B.push(pe)}}else if(ee){B=[];const F=ee(D.text,D.sectionIndex,eu(D,v,d,t,a,A));for(const q of F){const pe=new oo;pe.text=q[0],pe.sectionIndex=q[1],pe.sections=D.sections,B.push(pe)}}else B=function(F,q){const pe=[],Se=F.text;let ge=0;for(const _e of q)pe.push(F.substring(ge,_e)),ge=_e;return ge<Se.length&&pe.push(F.substring(ge,Se.length)),pe}(D,eu(D,v,d,t,a,A));const G=[],E={positionedLines:G,text:D.toString(),top:b[1],bottom:b[1],left:b[0],right:b[0],writingMode:w,iconsInText:!1,verticalizable:!1};return function(F,q,pe,Se,ge,_e,ze,Ie,De,Te,Ye,dt){let ht=0,rt=0,Lt=0,Ci=0;const qi=Ie==="right"?1:Ie==="left"?0:.5,ur=Gi/dt;let tn=0;for(const bi of ge){bi.trim();const Ji=bi.getMaxScale(),sr={positionedGlyphs:[],lineOffset:0};F.positionedLines[tn]=sr;const or=sr.positionedGlyphs;let Tr=0;if(!bi.length()){rt+=_e,++tn;continue}const rn=Xf(Se,bi,ur);for(let Dr=0;Dr<bi.length();Dr++){const Hi=bi.getSection(Dr),er=bi.getSectionIndex(Dr),tr=bi.getCharCode(Dr),ji=Kf(De,Ye,tr);let mi;if(Hi.imageName){if(F.iconsInText=!0,Hi.scale=Hi.scale*ur,mi=Jf(Hi,ji,Ji,rn,Se),!mi)continue;Tr=Math.max(Tr,mi.imageOffset)}else if(mi=Yf(Hi,tr,ji,rn,q,pe),!mi)continue;const{rect:vn,metrics:uo,baselineOffset:xn}=mi;or.push({glyph:tr,imageName:Hi.imageName,x:ht,y:rt+xn+$c,vertical:ji,scale:Hi.scale,fontStack:Hi.fontStack,sectionIndex:er,metrics:uo,rect:vn}),ji?(F.verticalizable=!0,ht+=(Hi.imageName?uo.advance:Gi)*Hi.scale+Te):ht+=uo.advance*Hi.scale+Te}or.length!==0&&(Lt=Math.max(ht-Te,Lt),Qf(or,0,or.length-1,qi)),ht=0,sr.lineOffset=Math.max(Tr,(Ji-1)*Gi);const Qi=_e*Ji+Tr;rt+=Qi,Ci=Math.max(Qi,Ci),++tn}const{horizontalAlign:zr,verticalAlign:ar}=tu(ze);(function(bi,Ji,sr,or,Tr,rn,Qi,Dr,Hi){const er=(Ji-sr)*Tr;let tr=0;tr=rn!==Qi?-Dr*or-$c:-or*Hi*Qi+.5*Qi;for(const ji of bi)for(const mi of ji.positionedGlyphs)mi.x+=er,mi.y+=tr})(F.positionedLines,qi,zr,ar,Lt,Ci,_e,rt,ge.length),F.top+=-ar*rt,F.bottom=F.top+rt,F.left+=-zr*Lt,F.right=F.left+Lt}(E,t,n,a,B,p,m,_,w,v,C,k),!function(F){for(const q of F)if(q.positionedGlyphs.length!==0)return!1;return!0}(G)&&E}const qc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},qf={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},Hf={40:!0};function _d(r,t,n,a,l,d){if(t.imageName){const p=a[t.imageName];return p?p.displaySize[0]*t.scale*Gi/d+l:0}{const p=n[t.fontStack],m=p&&p[r];return m?m.metrics.advance*t.scale+l:0}}function yd(r,t,n,a){const l=Math.pow(r-t,2);return a?r<t?l/2:2*l:l+Math.abs(n)*n}function Wf(r,t,n){let a=0;return r===10&&(a-=1e4),n&&(a+=150),r!==40&&r!==65288||(a+=50),t!==41&&t!==65289||(a+=50),a}function vd(r,t,n,a,l,d){let p=null,m=yd(t,n,l,d);for(const _ of a){const v=yd(t-_.x,n,l,d)+_.badness;v<=m&&(p=_,m=v)}return{index:r,x:t,priorBreak:p,badness:m}}function xd(r){return r?xd(r.priorBreak).concat(r.index):[]}function eu(r,t,n,a,l,d){if(!r)return[];const p=[],m=function(w,C,A,k,D,B){let U=0;for(let ee=0;ee<w.length();ee++){const G=w.getSection(ee);U+=_d(w.getCharCode(ee),G,k,D,C,B)}return U/Math.max(1,Math.ceil(U/A))}(r,t,n,a,l,d),_=r.text.indexOf("​")>=0;let v=0;for(let w=0;w<r.length();w++){const C=r.getSection(w),A=r.getCharCode(w);if(qc[A]||(v+=_d(A,C,a,l,t,d)),w<r.length()-1){const k=!((b=A)<11904)&&(!!At["CJK Compatibility Forms"](b)||!!At["CJK Compatibility"](b)||!!At["CJK Strokes"](b)||!!At["CJK Symbols and Punctuation"](b)||!!At["Enclosed CJK Letters and Months"](b)||!!At["Halfwidth and Fullwidth Forms"](b)||!!At["Ideographic Description Characters"](b)||!!At["Vertical Forms"](b)||hl.test(String.fromCodePoint(b)));(qf[A]||k||C.imageName||w!==r.length()-2&&Hf[r.getCharCode(w+1)])&&p.push(vd(w+1,v,m,p,Wf(A,r.getCharCode(w+1),k&&_),!1))}}var b;return xd(vd(r.length(),v,m,p,0,!0))}function tu(r){let t=.5,n=.5;switch(r){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:t,verticalAlign:n}}function Xf(r,t,n){const a=t.getMaxScale()*Gi,{maxImageWidth:l,maxImageHeight:d}=t.getMaxImageSize(r),p=Math.max(a,d*n);return{verticalLineContentWidth:Math.max(a,l*n),horizontalLineContentHeight:p}}function bd(r){switch(r){case"top":return 0;case"center":return .5;default:return 1}}function Kf(r,t,n){return!(r===I.ag.horizontal||!t&&!ul(n)||t&&(qc[n]||(a=n,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(a)))));var a}function Yf(r,t,n,a,l,d){const p=d[r.fontStack],m=function(v,b,w,C){if(v&&v.rect)return v;const A=b[w.fontStack],k=A&&A[C];return k?{rect:null,metrics:k.metrics}:null}(p&&p[t],l,r,t);if(m===null)return null;let _;if(n)_=a.verticalLineContentWidth-r.scale*Gi;else{const v=bd(r.verticalAlign);_=(a.horizontalLineContentHeight-r.scale*Gi)*v}return{rect:m.rect,metrics:m.metrics,baselineOffset:_}}function Jf(r,t,n,a,l){const d=l[r.imageName];if(!d)return null;const p=d.paddedRect,m=d.displaySize,_={width:m[0],height:m[1],left:kr,top:-3,advance:t?m[1]:m[0]};let v;if(t)v=a.verticalLineContentWidth-m[1]*r.scale;else{const b=bd(r.verticalAlign);v=(a.horizontalLineContentHeight-m[1]*r.scale)*b}return{rect:p,metrics:_,baselineOffset:v,imageOffset:(t?m[0]:m[1])*r.scale-Gi*n}}function Qf(r,t,n,a){if(a===0)return;const l=r[n],d=(r[n].x+l.metrics.advance*l.scale)*a;for(let p=t;p<=n;p++)r[p].x-=d}function em(r,t,n){const{horizontalAlign:a,verticalAlign:l}=tu(n),d=t[0]-r.displaySize[0]*a,p=t[1]-r.displaySize[1]*l;return{image:r,top:p,bottom:p+r.displaySize[1],left:d,right:d+r.displaySize[0]}}function wd(r){var t,n;let a=r.left,l=r.top,d=r.right-a,p=r.bottom-l;const m=(t=r.image.textFitWidth)!==null&&t!==void 0?t:"stretchOrShrink",_=(n=r.image.textFitHeight)!==null&&n!==void 0?n:"stretchOrShrink",v=(r.image.content[2]-r.image.content[0])/(r.image.content[3]-r.image.content[1]);if(_==="proportional"){if(m==="stretchOnly"&&d/p<v||m==="proportional"){const b=Math.ceil(p*v);a*=b/d,d=b}}else if(m==="proportional"&&_==="stretchOnly"&&v!==0&&d/p>v){const b=Math.ceil(d/v);l*=b/p,p=b}return{x1:a,y1:l,x2:a+d,y2:l+p}}function Td(r,t,n,a,l,d){const p=r.image;let m;if(p.content){const B=p.content,U=p.pixelRatio||1;m=[B[0]/U,B[1]/U,p.displaySize[0]-B[2]/U,p.displaySize[1]-B[3]/U]}const _=t.left*d,v=t.right*d;let b,w,C,A;n==="width"||n==="both"?(A=l[0]+_-a[3],w=l[0]+v+a[1]):(A=l[0]+(_+v-p.displaySize[0])/2,w=A+p.displaySize[0]);const k=t.top*d,D=t.bottom*d;return n==="height"||n==="both"?(b=l[1]+k-a[0],C=l[1]+D+a[2]):(b=l[1]+(k+D-p.displaySize[1])/2,C=b+p.displaySize[1]),{image:p,top:b,right:w,bottom:C,left:A,collisionPadding:m}}const Fl=255,zn=128,Sa=Fl*zn;function Pd(r,t){const{expression:n}=t;if(n.kind==="constant")return{kind:"constant",layoutSize:n.evaluate(new _i(r+1))};if(n.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:l}=n;let d=0;for(;d<a.length&&a[d]<=r;)d++;d=Math.max(0,d-1);let p=d;for(;p<a.length&&a[p]<r+1;)p++;p=Math.min(a.length-1,p);const m=a[d],_=a[p];return n.kind==="composite"?{kind:"composite",minZoom:m,maxZoom:_,interpolationType:l}:{kind:"camera",minZoom:m,maxZoom:_,minSize:n.evaluate(new _i(m)),maxSize:n.evaluate(new _i(_)),interpolationType:l}}}function iu(r,t,n){let a="never";const l=r.get(t);return l?a=l:r.get(n)&&(a="always"),a}const tm=kl.VectorTileFeature.types,im=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Hc(r,t,n,a,l,d,p,m,_,v,b,w,C){const A=m?Math.min(Sa,Math.round(m[0])):0,k=m?Math.min(Sa,Math.round(m[1])):0;r.emplaceBack(t,n,Math.round(32*a),Math.round(32*l),d,p,(A<<1)+(_?1:0),k,16*v,16*b,256*w,256*C)}function ru(r,t,n){r.emplaceBack(t.x,t.y,n),r.emplaceBack(t.x,t.y,n),r.emplaceBack(t.x,t.y,n),r.emplaceBack(t.x,t.y,n)}function rm(r){for(const t of r.sections)if(Ac(t.text))return!0;return!1}class nu{constructor(t){this.layoutVertexArray=new de,this.indexArray=new Le,this.programConfigurations=t,this.segments=new ot,this.dynamicLayoutVertexArray=new fe,this.opacityVertexArray=new xe,this.hasVisibleVertices=!1,this.placedSymbolArray=new y}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(t,n,a,l){this.isEmpty()||(a&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ff.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Bf.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,im,!0),this.opacityVertexBuffer.itemSize=1),(a||l)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}qe("SymbolBuffers",nu);class au{constructor(t,n,a){this.layoutVertexArray=new t,this.layoutAttributes=n,this.indexArray=new a,this.segments=new ot,this.collisionVertexArray=new ve}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Of.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}qe("CollisionBuffers",au);class lo{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(p=>p.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const n=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Pd(this.zoom,n["text-size"]),this.iconSizeData=Pd(this.zoom,n["icon-size"]);const a=this.layers[0].layout,l=a.get("symbol-sort-key"),d=a.get("symbol-z-order");this.canOverlap=iu(a,"text-overlap","text-allow-overlap")!=="never"||iu(a,"icon-overlap","icon-allow-overlap")!=="never"||a.get("text-ignore-placement")||a.get("icon-ignore-placement"),this.sortFeaturesByKey=d!=="viewport-y"&&!l.isConstant(),this.sortFeaturesByY=(d==="viewport-y"||d==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,a.get("symbol-placement")==="point"&&(this.writingModes=a.get("text-writing-mode").map(p=>I.ag[p])),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=t.sourceID}createArrays(){this.text=new nu(new Qn(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new nu(new Qn(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new M,this.lineVertexArray=new S,this.symbolInstances=new T,this.textAnchorOffsets=new R}calculateGlyphDependencies(t,n,a,l,d){for(let p=0;p<t.length;p++)if(n[t.charCodeAt(p)]=!0,(a||l)&&d){const m=Rl[t.charAt(p)];m&&(n[m.charCodeAt(0)]=!0)}}populate(t,n,a){const l=this.layers[0],d=l.layout,p=d.get("text-font"),m=d.get("text-field"),_=d.get("icon-image"),v=(m.value.kind!=="constant"||m.value.value instanceof rr&&!m.value.value.isEmpty()||m.value.value.toString().length>0)&&(p.value.kind!=="constant"||p.value.value.length>0),b=_.value.kind!=="constant"||!!_.value.value||Object.keys(_.parameters).length>0,w=d.get("symbol-sort-key");if(this.features=[],!v&&!b)return;const C=n.iconDependencies,A=n.glyphDependencies,k=n.availableImages,D=new _i(this.zoom);for(const{feature:B,id:U,index:ee,sourceLayerIndex:G}of t){const E=l._featureFilter.needGeometry,F=Ar(B,E);if(!l._featureFilter.filter(D,F,a))continue;let q,pe;if(E||(F.geometry=ea(B)),v){const ge=l.getValueAndResolveTokens("text-field",F,a,k),_e=rr.factory(ge),ze=this.hasRTLText=this.hasRTLText||rm(_e);(!ze||An.getRTLTextPluginStatus()==="unavailable"||ze&&An.isParsed())&&(q=Vf(_e,l,F))}if(b){const ge=l.getValueAndResolveTokens("icon-image",F,a,k);pe=ge instanceof mr?ge:mr.fromString(ge)}if(!q&&!pe)continue;const Se=this.sortFeaturesByKey?w.evaluate(F,{},a):void 0;if(this.features.push({id:U,text:q,icon:pe,index:ee,sourceLayerIndex:G,geometry:F.geometry,properties:B.properties,type:tm[B.type],sortKey:Se}),pe&&(C[pe.name]=!0),q){const ge=p.evaluate(F,{},a).join(","),_e=d.get("text-rotation-alignment")!=="viewport"&&d.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(I.ag.vertical)>=0;for(const ze of q.sections)if(ze.image)C[ze.image.name]=!0;else{const Ie=Zs(q.toString()),De=ze.fontStack||ge,Te=A[De]=A[De]||{};this.calculateGlyphDependencies(ze.text,Te,_e,this.allowVerticalPlacement,Ie)}}}d.get("symbol-placement")==="line"&&(this.features=function(B){const U={},ee={},G=[];let E=0;function F(ge){G.push(B[ge]),E++}function q(ge,_e,ze){const Ie=ee[ge];return delete ee[ge],ee[_e]=Ie,G[Ie].geometry[0].pop(),G[Ie].geometry[0]=G[Ie].geometry[0].concat(ze[0]),Ie}function pe(ge,_e,ze){const Ie=U[_e];return delete U[_e],U[ge]=Ie,G[Ie].geometry[0].shift(),G[Ie].geometry[0]=ze[0].concat(G[Ie].geometry[0]),Ie}function Se(ge,_e,ze){const Ie=ze?_e[0][_e[0].length-1]:_e[0][0];return`${ge}:${Ie.x}:${Ie.y}`}for(let ge=0;ge<B.length;ge++){const _e=B[ge],ze=_e.geometry,Ie=_e.text?_e.text.toString():null;if(!Ie){F(ge);continue}const De=Se(Ie,ze),Te=Se(Ie,ze,!0);if(De in ee&&Te in U&&ee[De]!==U[Te]){const Ye=pe(De,Te,ze),dt=q(De,Te,G[Ye].geometry);delete U[De],delete ee[Te],ee[Se(Ie,G[dt].geometry,!0)]=dt,G[Ye].geometry=null}else De in ee?q(De,Te,ze):Te in U?pe(De,Te,ze):(F(ge),U[De]=E-1,ee[Te]=E-1)}return G.filter(ge=>ge.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((B,U)=>B.sortKey-U.sortKey)}update(t,n,a){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,n,this.layers,a),this.icon.programConfigurations.updatePaintArrays(t,n,this.layers,a))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,n){const a=this.lineVertexArray.length;if(t.segment!==void 0){let l=t.dist(n[t.segment+1]),d=t.dist(n[t.segment]);const p={};for(let m=t.segment+1;m<n.length;m++)p[m]={x:n[m].x,y:n[m].y,tileUnitDistanceFromAnchor:l},m<n.length-1&&(l+=n[m+1].dist(n[m]));for(let m=t.segment||0;m>=0;m--)p[m]={x:n[m].x,y:n[m].y,tileUnitDistanceFromAnchor:d},m>0&&(d+=n[m-1].dist(n[m]));for(let m=0;m<n.length;m++){const _=p[m];this.lineVertexArray.emplaceBack(_.x,_.y,_.tileUnitDistanceFromAnchor)}}return{lineStartIndex:a,lineLength:this.lineVertexArray.length-a}}addSymbols(t,n,a,l,d,p,m,_,v,b,w,C){const A=t.indexArray,k=t.layoutVertexArray,D=t.segments.prepareSegment(4*n.length,k,A,this.canOverlap?p.sortKey:void 0),B=this.glyphOffsetArray.length,U=D.vertexLength,ee=this.allowVerticalPlacement&&m===I.ag.vertical?Math.PI/2:0,G=p.text&&p.text.sections;for(let E=0;E<n.length;E++){const{tl:F,tr:q,bl:pe,br:Se,tex:ge,pixelOffsetTL:_e,pixelOffsetBR:ze,minFontScaleX:Ie,minFontScaleY:De,glyphOffset:Te,isSDF:Ye,sectionIndex:dt}=n[E],ht=D.vertexLength,rt=Te[1];Hc(k,_.x,_.y,F.x,rt+F.y,ge.x,ge.y,a,Ye,_e.x,_e.y,Ie,De),Hc(k,_.x,_.y,q.x,rt+q.y,ge.x+ge.w,ge.y,a,Ye,ze.x,_e.y,Ie,De),Hc(k,_.x,_.y,pe.x,rt+pe.y,ge.x,ge.y+ge.h,a,Ye,_e.x,ze.y,Ie,De),Hc(k,_.x,_.y,Se.x,rt+Se.y,ge.x+ge.w,ge.y+ge.h,a,Ye,ze.x,ze.y,Ie,De),ru(t.dynamicLayoutVertexArray,_,ee),A.emplaceBack(ht,ht+2,ht+1),A.emplaceBack(ht+1,ht+2,ht+3),D.vertexLength+=4,D.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Te[0]),E!==n.length-1&&dt===n[E+1].sectionIndex||t.programConfigurations.populatePaintArrays(k.length,p,p.index,{},C,G&&G[dt])}t.placedSymbolArray.emplaceBack(_.x,_.y,B,this.glyphOffsetArray.length-B,U,v,b,_.segment,a?a[0]:0,a?a[1]:0,l[0],l[1],m,0,!1,0,w)}_addCollisionDebugVertex(t,n,a,l,d,p){return n.emplaceBack(0,0),t.emplaceBack(a.x,a.y,l,d,Math.round(p.x),Math.round(p.y))}addCollisionDebugVertices(t,n,a,l,d,p,m){const _=d.segments.prepareSegment(4,d.layoutVertexArray,d.indexArray),v=_.vertexLength,b=d.layoutVertexArray,w=d.collisionVertexArray,C=m.anchorX,A=m.anchorY;this._addCollisionDebugVertex(b,w,p,C,A,new Be(t,n)),this._addCollisionDebugVertex(b,w,p,C,A,new Be(a,n)),this._addCollisionDebugVertex(b,w,p,C,A,new Be(a,l)),this._addCollisionDebugVertex(b,w,p,C,A,new Be(t,l)),_.vertexLength+=4;const k=d.indexArray;k.emplaceBack(v,v+1),k.emplaceBack(v+1,v+2),k.emplaceBack(v+2,v+3),k.emplaceBack(v+3,v),_.primitiveLength+=4}addDebugCollisionBoxes(t,n,a,l){for(let d=t;d<n;d++){const p=this.collisionBoxArray.get(d);this.addCollisionDebugVertices(p.x1,p.y1,p.x2,p.y2,l?this.textCollisionBox:this.iconCollisionBox,p.anchorPoint,a)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new au(we,ud.members,Re),this.iconCollisionBox=new au(we,ud.members,Re);for(let t=0;t<this.symbolInstances.length;t++){const n=this.symbolInstances.get(t);this.addDebugCollisionBoxes(n.textBoxStartIndex,n.textBoxEndIndex,n,!0),this.addDebugCollisionBoxes(n.verticalTextBoxStartIndex,n.verticalTextBoxEndIndex,n,!0),this.addDebugCollisionBoxes(n.iconBoxStartIndex,n.iconBoxEndIndex,n,!1),this.addDebugCollisionBoxes(n.verticalIconBoxStartIndex,n.verticalIconBoxEndIndex,n,!1)}}_deserializeCollisionBoxesForSymbol(t,n,a,l,d,p,m,_,v){const b={};for(let w=n;w<a;w++){const C=t.get(w);b.textBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},b.textFeatureIndex=C.featureIndex;break}for(let w=l;w<d;w++){const C=t.get(w);b.verticalTextBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},b.verticalTextFeatureIndex=C.featureIndex;break}for(let w=p;w<m;w++){const C=t.get(w);b.iconBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},b.iconFeatureIndex=C.featureIndex;break}for(let w=_;w<v;w++){const C=t.get(w);b.verticalIconBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},b.verticalIconFeatureIndex=C.featureIndex;break}return b}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){const a=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,a.textBoxStartIndex,a.textBoxEndIndex,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a.iconBoxStartIndex,a.iconBoxEndIndex,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,n){const a=t.placedSymbolArray.get(n),l=a.vertexStartIndex+4*a.numGlyphs;for(let d=a.vertexStartIndex;d<l;d+=4)t.indexArray.emplaceBack(d,d+2,d+1),t.indexArray.emplaceBack(d+1,d+2,d+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const n=Math.sin(t),a=Math.cos(t),l=[],d=[],p=[];for(let m=0;m<this.symbolInstances.length;++m){p.push(m);const _=this.symbolInstances.get(m);l.push(0|Math.round(n*_.anchorX+a*_.anchorY)),d.push(_.featureIndex)}return p.sort((m,_)=>l[m]-l[_]||d[_]-d[m]),p}addToSortKeyRanges(t,n){const a=this.sortKeyRanges[this.sortKeyRanges.length-1];a&&a.sortKey===n?a.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const n of this.symbolInstanceIndexes){const a=this.symbolInstances.get(n);this.featureSortOrder.push(a.featureIndex),[a.rightJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.leftJustifiedTextSymbolIndex].forEach((l,d,p)=>{l>=0&&p.indexOf(l)===d&&this.addIndicesForPlacedSymbol(this.text,l)}),a.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,a.verticalPlacedTextSymbolIndex),a.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,a.placedIconSymbolIndex),a.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,a.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Md,Sd;qe("SymbolBucket",lo,{omit:["layers","collisionBoxArray","features","compareText"]}),lo.MAX_GLYPHS=65535,lo.addDynamicAttributes=ru;var su={get paint(){return Sd=Sd||new wr({"icon-opacity":new mt(P.paint_symbol["icon-opacity"]),"icon-color":new mt(P.paint_symbol["icon-color"]),"icon-halo-color":new mt(P.paint_symbol["icon-halo-color"]),"icon-halo-width":new mt(P.paint_symbol["icon-halo-width"]),"icon-halo-blur":new mt(P.paint_symbol["icon-halo-blur"]),"icon-translate":new at(P.paint_symbol["icon-translate"]),"icon-translate-anchor":new at(P.paint_symbol["icon-translate-anchor"]),"text-opacity":new mt(P.paint_symbol["text-opacity"]),"text-color":new mt(P.paint_symbol["text-color"],{runtimeType:It,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new mt(P.paint_symbol["text-halo-color"]),"text-halo-width":new mt(P.paint_symbol["text-halo-width"]),"text-halo-blur":new mt(P.paint_symbol["text-halo-blur"]),"text-translate":new at(P.paint_symbol["text-translate"]),"text-translate-anchor":new at(P.paint_symbol["text-translate-anchor"])})},get layout(){return Md=Md||new wr({"symbol-placement":new at(P.layout_symbol["symbol-placement"]),"symbol-spacing":new at(P.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new at(P.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new mt(P.layout_symbol["symbol-sort-key"]),"symbol-z-order":new at(P.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new at(P.layout_symbol["icon-allow-overlap"]),"icon-overlap":new at(P.layout_symbol["icon-overlap"]),"icon-ignore-placement":new at(P.layout_symbol["icon-ignore-placement"]),"icon-optional":new at(P.layout_symbol["icon-optional"]),"icon-rotation-alignment":new at(P.layout_symbol["icon-rotation-alignment"]),"icon-size":new mt(P.layout_symbol["icon-size"]),"icon-text-fit":new at(P.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new at(P.layout_symbol["icon-text-fit-padding"]),"icon-image":new mt(P.layout_symbol["icon-image"]),"icon-rotate":new mt(P.layout_symbol["icon-rotate"]),"icon-padding":new mt(P.layout_symbol["icon-padding"]),"icon-keep-upright":new at(P.layout_symbol["icon-keep-upright"]),"icon-offset":new mt(P.layout_symbol["icon-offset"]),"icon-anchor":new mt(P.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new at(P.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new at(P.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new at(P.layout_symbol["text-rotation-alignment"]),"text-field":new mt(P.layout_symbol["text-field"]),"text-font":new mt(P.layout_symbol["text-font"]),"text-size":new mt(P.layout_symbol["text-size"]),"text-max-width":new mt(P.layout_symbol["text-max-width"]),"text-line-height":new at(P.layout_symbol["text-line-height"]),"text-letter-spacing":new mt(P.layout_symbol["text-letter-spacing"]),"text-justify":new mt(P.layout_symbol["text-justify"]),"text-radial-offset":new mt(P.layout_symbol["text-radial-offset"]),"text-variable-anchor":new at(P.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new mt(P.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new mt(P.layout_symbol["text-anchor"]),"text-max-angle":new at(P.layout_symbol["text-max-angle"]),"text-writing-mode":new at(P.layout_symbol["text-writing-mode"]),"text-rotate":new mt(P.layout_symbol["text-rotate"]),"text-padding":new at(P.layout_symbol["text-padding"]),"text-keep-upright":new at(P.layout_symbol["text-keep-upright"]),"text-transform":new mt(P.layout_symbol["text-transform"]),"text-offset":new mt(P.layout_symbol["text-offset"]),"text-allow-overlap":new at(P.layout_symbol["text-allow-overlap"]),"text-overlap":new at(P.layout_symbol["text-overlap"]),"text-ignore-placement":new at(P.layout_symbol["text-ignore-placement"]),"text-optional":new at(P.layout_symbol["text-optional"])})}};class Cd{constructor(t){if(t.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=t.property.overrides?t.property.overrides.runtimeType:ut,this.defaultValue=t}evaluate(t){if(t.formattedSection){const n=this.defaultValue.property.overrides;if(n&&n.hasOverride(t.formattedSection))return n.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}qe("FormatSectionOverride",Cd,{omit:["defaultValue"]});class Wc extends ln{constructor(t){super(t,su)}recalculate(t,n){if(super.recalculate(t,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const a=this.layout.get("text-writing-mode");if(a){const l=[];for(const d of a)l.indexOf(d)<0&&l.push(d);this.layout._values["text-writing-mode"]=l}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(t,n,a,l){const d=this.layout.get(t).evaluate(n,{},a,l),p=this._unevaluatedLayout._values[t];return p.isDataDriven()||Rs(p.value)||!d?d:function(m,_){return _.replace(/{([^{}]+)}/g,(v,b)=>m&&b in m?String(m[b]):"")}(n.properties,d)}createBucket(t){return new lo(t)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const t of su.paint.overridableProperties){if(!Wc.hasPaintOverride(this.layout,t))continue;const n=this.paint.get(t),a=new Cd(n),l=new Xo(a,n.property.specification);let d=null;d=n.value.kind==="constant"||n.value.kind==="source"?new Ls("source",l):new Ko("composite",l,n.value.zoomStops),this.paint._values[t]=new Ur(n.property,d,n.parameters)}}_handleOverridablePaintPropertyUpdate(t,n,a){return!(!this.layout||n.isDataDriven()||a.isDataDriven())&&Wc.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,n){const a=t.get("text-field"),l=su.paint.properties[n];let d=!1;const p=m=>{for(const _ of m)if(l.overrides&&l.overrides.hasOverride(_))return void(d=!0)};if(a.value.kind==="constant"&&a.value.value instanceof rr)p(a.value.value.sections);else if(a.value.kind==="source"){const m=v=>{d||(v instanceof Or&&Oi(v.value)===Bi?p(v.value.sections):v instanceof On?p(v.sections):v.eachChild(m))},_=a.value;_._styleExpression&&m(_._styleExpression.expression)}return d}}let Id;var nm={get paint(){return Id=Id||new wr({"background-color":new at(P.paint_background["background-color"]),"background-pattern":new qs(P.paint_background["background-pattern"]),"background-opacity":new at(P.paint_background["background-opacity"])})}};class am extends ln{constructor(t){super(t,nm)}}let Ed;var sm={get paint(){return Ed=Ed||new wr({"raster-opacity":new at(P.paint_raster["raster-opacity"]),"raster-hue-rotate":new at(P.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new at(P.paint_raster["raster-brightness-min"]),"raster-brightness-max":new at(P.paint_raster["raster-brightness-max"]),"raster-saturation":new at(P.paint_raster["raster-saturation"]),"raster-contrast":new at(P.paint_raster["raster-contrast"]),"raster-resampling":new at(P.paint_raster["raster-resampling"]),"raster-fade-duration":new at(P.paint_raster["raster-fade-duration"])})}};class om extends ln{constructor(t){super(t,sm)}}class lm extends ln{constructor(t){super(t,{}),this.onAdd=n=>{this.implementation.onAdd&&this.implementation.onAdd(n,n.painter.context.gl)},this.onRemove=n=>{this.implementation.onRemove&&this.implementation.onRemove(n,n.painter.context.gl)},this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class cm{constructor(t){this._methodToThrottle=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const hm={once:!0},ou=63710088e-1;class Ca{constructor(t,n){if(isNaN(t)||isNaN(n))throw new Error(`Invalid LngLat object: (${t}, ${n})`);if(this.lng=+t,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ca(Wt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const n=Math.PI/180,a=this.lat*n,l=t.lat*n,d=Math.sin(a)*Math.sin(l)+Math.cos(a)*Math.cos(l)*Math.cos((t.lng-this.lng)*n);return ou*Math.acos(Math.min(d,1))}static convert(t){if(t instanceof Ca)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Ca(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Ca(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Ad=2*Math.PI*ou;function kd(r){return Ad*Math.cos(r*Math.PI/180)}function zd(r){return(180+r)/360}function Dd(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function Rd(r,t){return r/kd(t)}function lu(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Ld(r,t){return r*kd(lu(t))}class Bl{constructor(t,n,a=0){this.x=+t,this.y=+n,this.z=+a}static fromLngLat(t,n=0){const a=Ca.convert(t);return new Bl(zd(a.lng),Dd(a.lat),Rd(n,a.lat))}toLngLat(){return new Ca(360*this.x-180,lu(this.y))}toAltitude(){return Ld(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ad*(t=lu(this.y),1/Math.cos(t*Math.PI/180));var t}}function Fd(r,t,n){var a=2*Math.PI*6378137/256/Math.pow(2,n);return[r*a-2*Math.PI*6378137/2,t*a-2*Math.PI*6378137/2]}class cu{constructor(t,n,a){if(!function(l,d,p){return!(l<0||l>25||p<0||p>=Math.pow(2,l)||d<0||d>=Math.pow(2,l))}(t,n,a))throw new Error(`x=${n}, y=${a}, z=${t} outside of bounds. 0<=x<${Math.pow(2,t)}, 0<=y<${Math.pow(2,t)} 0<=z<=25 `);this.z=t,this.x=n,this.y=a,this.key=co(0,t,t,n,a)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,n,a){const l=(p=this.y,m=this.z,_=Fd(256*(d=this.x),256*(p=Math.pow(2,m)-p-1),m),v=Fd(256*(d+1),256*(p+1),m),_[0]+","+_[1]+","+v[0]+","+v[1]);var d,p,m,_,v;const b=function(w,C,A){let k,D="";for(let B=w;B>0;B--)k=1<<B-1,D+=(C&k?1:0)+(A&k?2:0);return D}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(a==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,n>1?"@2x":"").replace(/{quadkey}/g,b).replace(/{bbox-epsg-3857}/g,l)}isChildOf(t){const n=this.z-t.z;return n>0&&t.x===this.x>>n&&t.y===this.y>>n}getTilePoint(t){const n=Math.pow(2,this.z);return new Be((t.x*n-this.x)*Mt,(t.y*n-this.y)*Mt)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Bd{constructor(t,n){this.wrap=t,this.canonical=n,this.key=co(t,n.z,n.z,n.x,n.y)}}class en{constructor(t,n,a,l,d){if(this.terrainRttPosMatrix32f=null,t<a)throw new Error(`overscaledZ should be >= z; overscaledZ = ${t}; z = ${a}`);this.overscaledZ=t,this.wrap=n,this.canonical=new cu(a,+l,+d),this.key=co(n,t,a,l,d)}clone(){return new en(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const n=this.canonical.z-t;return t>this.canonical.z?new en(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new en(t,this.wrap,t,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(t,n){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const a=this.canonical.z-t;return t>this.canonical.z?co(this.wrap*+n,t,this.canonical.z,this.canonical.x,this.canonical.y):co(this.wrap*+n,t,t,this.canonical.x>>a,this.canonical.y>>a)}isChildOf(t){if(t.wrap!==this.wrap)return!1;const n=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>n&&t.canonical.y===this.canonical.y>>n}children(t){if(this.overscaledZ>=t)return[new en(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const n=this.canonical.z+1,a=2*this.canonical.x,l=2*this.canonical.y;return[new en(n,this.wrap,n,a,l),new en(n,this.wrap,n,a+1,l),new en(n,this.wrap,n,a,l+1),new en(n,this.wrap,n,a+1,l+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new en(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new en(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Bd(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(t){return this.canonical.getTilePoint(new Bl(t.x-this.wrap,t.y))}}function co(r,t,n,a,l){(r*=2)<0&&(r=-1*r-1);const d=1<<n;return(d*d*r+d*l+a).toString(36)+n.toString(36)+t.toString(36)}qe("CanonicalTileID",cu),qe("OverscaledTileID",en,{omit:["terrainRttPosMatrix32f"]});class Od{constructor(t,n,a,l=1,d=1,p=1,m=0){if(this.uid=t,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(a&&!["mapbox","terrarium","custom"].includes(a))return void xi(`"${a}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=n.height;const _=this.dim=n.height-2;switch(this.data=new Uint32Array(n.data.buffer),a){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=l,this.greenFactor=d,this.blueFactor=p,this.baseShift=m;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let v=0;v<_;v++)this.data[this._idx(-1,v)]=this.data[this._idx(0,v)],this.data[this._idx(_,v)]=this.data[this._idx(_-1,v)],this.data[this._idx(v,-1)]=this.data[this._idx(v,0)],this.data[this._idx(v,_)]=this.data[this._idx(v,_-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(_,-1)]=this.data[this._idx(_-1,0)],this.data[this._idx(-1,_)]=this.data[this._idx(0,_-1)],this.data[this._idx(_,_)]=this.data[this._idx(_-1,_-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let v=0;v<_;v++)for(let b=0;b<_;b++){const w=this.get(v,b);w>this.max&&(this.max=w),w<this.min&&(this.min=w)}}get(t,n){const a=new Uint8Array(this.data.buffer),l=4*this._idx(t,n);return this.unpack(a[l],a[l+1],a[l+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(t,n){if(t<-1||t>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(t+1)}unpack(t,n,a){return t*this.redFactor+n*this.greenFactor+a*this.blueFactor-this.baseShift}getPixels(){return new Qr({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(t,n,a){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let l=n*this.dim,d=n*this.dim+this.dim,p=a*this.dim,m=a*this.dim+this.dim;switch(n){case-1:l=d-1;break;case 1:d=l+1}switch(a){case-1:p=m-1;break;case 1:m=p+1}const _=-n*this.dim,v=-a*this.dim;for(let b=p;b<m;b++)for(let w=l;w<d;w++)this.data[this._idx(w,b)]=t.data[this._idx(w+_,b+v)]}}qe("DEMData",Od);class jd{constructor(t){this._stringToNumber={},this._numberToString=[];for(let n=0;n<t.length;n++){const a=t[n];this._stringToNumber[a]=n,this._numberToString[n]=a}}encode(t){return this._stringToNumber[t]}decode(t){if(t>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${t} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[t]}}class Vd{constructor(t,n,a,l,d){this.type="Feature",this._vectorTileFeature=t,t._z=n,t._x=a,t._y=l,this.properties=t.properties,this.id=d}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={geometry:this.geometry};for(const n in this)n!=="_geometry"&&n!=="_vectorTileFeature"&&(t[n]=this[n]);return t}}class Nd{constructor(t,n){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new qa(Mt,16,0),this.grid3D=new qa(Mt,16,0),this.featureIndexArray=new j,this.promoteId=n}insert(t,n,a,l,d,p){const m=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(a,l,d);const _=p?this.grid3D:this.grid;for(let v=0;v<n.length;v++){const b=n[v],w=[1/0,1/0,-1/0,-1/0];for(let C=0;C<b.length;C++){const A=b[C];w[0]=Math.min(w[0],A.x),w[1]=Math.min(w[1],A.y),w[2]=Math.max(w[2],A.x),w[3]=Math.max(w[3],A.y)}w[0]<Mt&&w[1]<Mt&&w[2]>=0&&w[3]>=0&&_.insert(m,w[0],w[1],w[2],w[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new kl.VectorTile(new Yh(this.rawTileData)).layers,this.sourceLayerCoder=new jd(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(t,n,a,l){this.loadVTLayers();const d=t.params,p=Mt/t.tileSize/t.scale,m=Os(d.filter),_=t.queryGeometry,v=t.queryPadding*p,b=Ud(_),w=this.grid.query(b.minX-v,b.minY-v,b.maxX+v,b.maxY+v),C=Ud(t.cameraQueryGeometry),A=this.grid3D.query(C.minX-v,C.minY-v,C.maxX+v,C.maxY+v,(B,U,ee,G)=>function(E,F,q,pe,Se){for(const _e of E)if(F<=_e.x&&q<=_e.y&&pe>=_e.x&&Se>=_e.y)return!0;const ge=[new Be(F,q),new Be(F,Se),new Be(pe,Se),new Be(pe,q)];if(E.length>2){for(const _e of ge)if(ro(E,_e))return!0}for(let _e=0;_e<E.length-1;_e++)if(Yp(E[_e],E[_e+1],ge))return!0;return!1}(t.cameraQueryGeometry,B-v,U-v,ee+v,G+v));for(const B of A)w.push(B);w.sort(um);const k={};let D;for(let B=0;B<w.length;B++){const U=w[B];if(U===D)continue;D=U;const ee=this.featureIndexArray.get(U);let G=null;this.loadMatchingFeature(k,ee.bucketIndex,ee.sourceLayerIndex,ee.featureIndex,m,d.layers,d.availableImages,n,a,l,(E,F,q)=>(G||(G=ea(E)),F.queryIntersectsFeature({queryGeometry:_,feature:E,featureState:q,geometry:G,zoom:this.z,transform:t.transform,pixelsToTileUnits:p,pixelPosMatrix:t.pixelPosMatrix})))}return k}loadMatchingFeature(t,n,a,l,d,p,m,_,v,b,w){const C=this.bucketLayerIDs[n];if(p&&!C.some(B=>p.has(B)))return;const A=this.sourceLayerCoder.decode(a),k=this.vtLayers[A].feature(l);if(d.needGeometry){const B=Ar(k,!0);if(!d.filter(new _i(this.tileID.overscaledZ),B,this.tileID.canonical))return}else if(!d.filter(new _i(this.tileID.overscaledZ),k))return;const D=this.getId(k,A);for(let B=0;B<C.length;B++){const U=C[B];if(p&&!p.has(U))continue;const ee=_[U];if(!ee)continue;let G={};D&&b&&(G=b.getState(ee.sourceLayer||"_geojsonTileLayer",D));const E=Ge({},v[U]);E.paint=Zd(E.paint,ee.paint,k,G,m),E.layout=Zd(E.layout,ee.layout,k,G,m);const F=!w||w(k,ee,G);if(!F)continue;const q=new Vd(k,this.z,this.x,this.y,D);q.layer=E;let pe=t[U];pe===void 0&&(pe=t[U]=[]),pe.push({featureIndex:l,feature:q,intersectionZ:F})}}lookupSymbolFeatures(t,n,a,l,d,p,m,_){const v={};this.loadVTLayers();const b=Os(d);for(const w of t)this.loadMatchingFeature(v,a,l,w,b,p,m,_,n);return v}hasLayer(t){for(const n of this.bucketLayerIDs)for(const a of n)if(t===a)return!0;return!1}getId(t,n){var a;let l=t.id;return this.promoteId&&(l=t.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[n]],typeof l=="boolean"&&(l=Number(l)),l===void 0&&(!((a=t.properties)===null||a===void 0)&&a.cluster)&&this.promoteId&&(l=Number(t.properties.cluster_id))),l}}function Zd(r,t,n,a,l){return St(r,(d,p)=>{const m=t instanceof Gs?t.get(p):null;return m&&m.evaluate?m.evaluate(n,a,l):m})}function Ud(r){let t=1/0,n=1/0,a=-1/0,l=-1/0;for(const d of r)t=Math.min(t,d.x),n=Math.min(n,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y);return{minX:t,minY:n,maxX:a,maxY:l}}function um(r,t){return t-r}function $d(r,t,n,a,l){const d=[];for(let p=0;p<r.length;p++){const m=r[p];let _;for(let v=0;v<m.length-1;v++){let b=m[v],w=m[v+1];b.x<t&&w.x<t||(b.x<t?b=new Be(t,b.y+(t-b.x)/(w.x-b.x)*(w.y-b.y))._round():w.x<t&&(w=new Be(t,b.y+(t-b.x)/(w.x-b.x)*(w.y-b.y))._round()),b.y<n&&w.y<n||(b.y<n?b=new Be(b.x+(n-b.y)/(w.y-b.y)*(w.x-b.x),n)._round():w.y<n&&(w=new Be(b.x+(n-b.y)/(w.y-b.y)*(w.x-b.x),n)._round()),b.x>=a&&w.x>=a||(b.x>=a?b=new Be(a,b.y+(a-b.x)/(w.x-b.x)*(w.y-b.y))._round():w.x>=a&&(w=new Be(a,b.y+(a-b.x)/(w.x-b.x)*(w.y-b.y))._round()),b.y>=l&&w.y>=l||(b.y>=l?b=new Be(b.x+(l-b.y)/(w.y-b.y)*(w.x-b.x),l)._round():w.y>=l&&(w=new Be(b.x+(l-b.y)/(w.y-b.y)*(w.x-b.x),l)._round()),_&&b.equals(_[_.length-1])||(_=[b],d.push(_)),_.push(w)))))}}return d}qe("FeatureIndex",Nd,{omit:["rawTileData","sourceLayerCoder"]});class Ia extends Be{constructor(t,n,a,l){super(t,n),this.angle=a,l!==void 0&&(this.segment=l)}clone(){return new Ia(this.x,this.y,this.angle,this.segment)}}function Gd(r,t,n,a,l){if(t.segment===void 0||n===0)return!0;let d=t,p=t.segment+1,m=0;for(;m>-n/2;){if(p--,p<0)return!1;m-=r[p].dist(d),d=r[p]}m+=r[p].dist(r[p+1]),p++;const _=[];let v=0;for(;m<n/2;){const b=r[p],w=r[p+1];if(!w)return!1;let C=r[p-1].angleTo(b)-b.angleTo(w);for(C=Math.abs((C+3*Math.PI)%(2*Math.PI)-Math.PI),_.push({distance:m,angleDelta:C}),v+=C;m-_[0].distance>a;)v-=_.shift().angleDelta;if(v>l)return!1;p++,m+=b.dist(w)}return!0}function qd(r){let t=0;for(let n=0;n<r.length-1;n++)t+=r[n].dist(r[n+1]);return t}function Hd(r,t,n){return r?.6*t*n:0}function Wd(r,t){return Math.max(r?r.right-r.left:0,t?t.right-t.left:0)}function dm(r,t,n,a,l,d){const p=Hd(n,l,d),m=Wd(n,a)*d;let _=0;const v=qd(r)/2;for(let b=0;b<r.length-1;b++){const w=r[b],C=r[b+1],A=w.dist(C);if(_+A>v){const k=(v-_)/A,D=Ir.number(w.x,C.x,k),B=Ir.number(w.y,C.y,k),U=new Ia(D,B,C.angleTo(w),b);return U._round(),!p||Gd(r,U,m,p,t)?U:void 0}_+=A}}function pm(r,t,n,a,l,d,p,m,_){const v=Hd(a,d,p),b=Wd(a,l),w=b*p,C=r[0].x===0||r[0].x===_||r[0].y===0||r[0].y===_;return t-w<t/4&&(t=w+t/4),Xd(r,C?t/2*m%t:(b/2+2*d)*p*m%t,t,v,n,w,C,!1,_)}function Xd(r,t,n,a,l,d,p,m,_){const v=d/2,b=qd(r);let w=0,C=t-n,A=[];for(let k=0;k<r.length-1;k++){const D=r[k],B=r[k+1],U=D.dist(B),ee=B.angleTo(D);for(;C+n<w+U;){C+=n;const G=(C-w)/U,E=Ir.number(D.x,B.x,G),F=Ir.number(D.y,B.y,G);if(E>=0&&E<_&&F>=0&&F<_&&C-v>=0&&C+v<=b){const q=new Ia(E,F,ee,k);q._round(),a&&!Gd(r,q,d,a,l)||A.push(q)}}w+=U}return m||A.length||p||(A=Xd(r,w/2,n,a,l,d,p,!0,_)),A}qe("Anchor",Ia);const Ol=kr;function Kd(r,t,n,a){const l=[],d=r.image,p=d.pixelRatio,m=d.paddedRect.w-2*Ol,_=d.paddedRect.h-2*Ol;let v={x1:r.left,y1:r.top,x2:r.right,y2:r.bottom};const b=d.stretchX||[[0,m]],w=d.stretchY||[[0,_]],C=(Te,Ye)=>Te+Ye[1]-Ye[0],A=b.reduce(C,0),k=w.reduce(C,0),D=m-A,B=_-k;let U=0,ee=A,G=0,E=k,F=0,q=D,pe=0,Se=B;if(d.content&&a){const Te=d.content,Ye=Te[2]-Te[0],dt=Te[3]-Te[1];(d.textFitWidth||d.textFitHeight)&&(v=wd(r)),U=Xc(b,0,Te[0]),G=Xc(w,0,Te[1]),ee=Xc(b,Te[0],Te[2]),E=Xc(w,Te[1],Te[3]),F=Te[0]-U,pe=Te[1]-G,q=Ye-ee,Se=dt-E}const ge=v.x1,_e=v.y1,ze=v.x2-ge,Ie=v.y2-_e,De=(Te,Ye,dt,ht)=>{const rt=Kc(Te.stretch-U,ee,ze,ge),Lt=Yc(Te.fixed-F,q,Te.stretch,A),Ci=Kc(Ye.stretch-G,E,Ie,_e),qi=Yc(Ye.fixed-pe,Se,Ye.stretch,k),ur=Kc(dt.stretch-U,ee,ze,ge),tn=Yc(dt.fixed-F,q,dt.stretch,A),zr=Kc(ht.stretch-G,E,Ie,_e),ar=Yc(ht.fixed-pe,Se,ht.stretch,k),bi=new Be(rt,Ci),Ji=new Be(ur,Ci),sr=new Be(ur,zr),or=new Be(rt,zr),Tr=new Be(Lt/p,qi/p),rn=new Be(tn/p,ar/p),Qi=t*Math.PI/180;if(Qi){const er=Math.sin(Qi),tr=Math.cos(Qi),ji=[tr,-er,er,tr];bi._matMult(ji),Ji._matMult(ji),or._matMult(ji),sr._matMult(ji)}const Dr=Te.stretch+Te.fixed,Hi=Ye.stretch+Ye.fixed;return{tl:bi,tr:Ji,bl:or,br:sr,tex:{x:d.paddedRect.x+Ol+Dr,y:d.paddedRect.y+Ol+Hi,w:dt.stretch+dt.fixed-Dr,h:ht.stretch+ht.fixed-Hi},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Tr,pixelOffsetBR:rn,minFontScaleX:q/p/ze,minFontScaleY:Se/p/Ie,isSDF:n}};if(a&&(d.stretchX||d.stretchY)){const Te=Yd(b,D,A),Ye=Yd(w,B,k);for(let dt=0;dt<Te.length-1;dt++){const ht=Te[dt],rt=Te[dt+1];for(let Lt=0;Lt<Ye.length-1;Lt++)l.push(De(ht,Ye[Lt],rt,Ye[Lt+1]))}}else l.push(De({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:m+1},{fixed:0,stretch:_+1}));return l}function Xc(r,t,n){let a=0;for(const l of r)a+=Math.max(t,Math.min(n,l[1]))-Math.max(t,Math.min(n,l[0]));return a}function Yd(r,t,n){const a=[{fixed:-1,stretch:0}];for(const[l,d]of r){const p=a[a.length-1];a.push({fixed:l-p.stretch,stretch:p.stretch}),a.push({fixed:l-p.stretch,stretch:p.stretch+(d-l)})}return a.push({fixed:t+Ol,stretch:n}),a}function Kc(r,t,n,a){return r/t*n+a}function Yc(r,t,n,a){return r-t*n/a}class Jc{constructor(t,n,a,l,d,p,m,_,v,b){var w;if(this.boxStartIndex=t.length,v){let C=p.top,A=p.bottom;const k=p.collisionPadding;k&&(C-=k[1],A+=k[3]);let D=A-C;D>0&&(D=Math.max(10,D),this.circleDiameter=D)}else{const C=!((w=p.image)===null||w===void 0)&&w.content&&(p.image.textFitWidth||p.image.textFitHeight)?wd(p):{x1:p.left,y1:p.top,x2:p.right,y2:p.bottom};C.y1=C.y1*m-_[0],C.y2=C.y2*m+_[2],C.x1=C.x1*m-_[3],C.x2=C.x2*m+_[1];const A=p.collisionPadding;if(A&&(C.x1-=A[0]*m,C.y1-=A[1]*m,C.x2+=A[2]*m,C.y2+=A[3]*m),b){const k=new Be(C.x1,C.y1),D=new Be(C.x2,C.y1),B=new Be(C.x1,C.y2),U=new Be(C.x2,C.y2),ee=b*Math.PI/180;k._rotate(ee),D._rotate(ee),B._rotate(ee),U._rotate(ee),C.x1=Math.min(k.x,D.x,B.x,U.x),C.x2=Math.max(k.x,D.x,B.x,U.x),C.y1=Math.min(k.y,D.y,B.y,U.y),C.y2=Math.max(k.y,D.y,B.y,U.y)}t.emplaceBack(n.x,n.y,C.x1,C.y1,C.x2,C.y2,a,l,d)}this.boxEndIndex=t.length}}class fm{constructor(t=[],n=(a,l)=>a<l?-1:a>l?1:0){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let a=(this.length>>1)-1;a>=0;a--)this._down(a)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:n,compare:a}=this,l=n[t];for(;t>0;){const d=t-1>>1,p=n[d];if(a(l,p)>=0)break;n[t]=p,t=d}n[t]=l}_down(t){const{data:n,compare:a}=this,l=this.length>>1,d=n[t];for(;t<l;){let p=1+(t<<1);const m=p+1;if(m<this.length&&a(n[m],n[p])<0&&(p=m),a(n[p],d)>=0)break;n[t]=n[p],t=p}n[t]=d}}function mm(r,t=1,n=!1){let a=1/0,l=1/0,d=-1/0,p=-1/0;const m=r[0];for(let A=0;A<m.length;A++){const k=m[A];(!A||k.x<a)&&(a=k.x),(!A||k.y<l)&&(l=k.y),(!A||k.x>d)&&(d=k.x),(!A||k.y>p)&&(p=k.y)}const _=Math.min(d-a,p-l);let v=_/2;const b=new fm([],gm);if(_===0)return new Be(a,l);for(let A=a;A<d;A+=_)for(let k=l;k<p;k+=_)b.push(new ho(A+v,k+v,v,r));let w=function(A){let k=0,D=0,B=0;const U=A[0];for(let ee=0,G=U.length,E=G-1;ee<G;E=ee++){const F=U[ee],q=U[E],pe=F.x*q.y-q.x*F.y;D+=(F.x+q.x)*pe,B+=(F.y+q.y)*pe,k+=3*pe}return new ho(D/k,B/k,0,A)}(r),C=b.length;for(;b.length;){const A=b.pop();(A.d>w.d||!w.d)&&(w=A,n&&console.log("found best %d after %d probes",Math.round(1e4*A.d)/1e4,C)),A.max-w.d<=t||(v=A.h/2,b.push(new ho(A.p.x-v,A.p.y-v,v,r)),b.push(new ho(A.p.x+v,A.p.y-v,v,r)),b.push(new ho(A.p.x-v,A.p.y+v,v,r)),b.push(new ho(A.p.x+v,A.p.y+v,v,r)),C+=4)}return n&&(console.log(`num probes: ${C}`),console.log(`best distance: ${w.d}`)),w.p}function gm(r,t){return t.max-r.max}function ho(r,t,n,a){this.p=new Be(r,t),this.h=n,this.d=function(l,d){let p=!1,m=1/0;for(let _=0;_<d.length;_++){const v=d[_];for(let b=0,w=v.length,C=w-1;b<w;C=b++){const A=v[b],k=v[C];A.y>l.y!=k.y>l.y&&l.x<(k.x-A.x)*(l.y-A.y)/(k.y-A.y)+A.x&&(p=!p),m=Math.min(m,ku(l,A,k))}}return(p?1:-1)*Math.sqrt(m)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}var hr;I.ax=void 0,(hr=I.ax||(I.ax={}))[hr.center=1]="center",hr[hr.left=2]="left",hr[hr.right=3]="right",hr[hr.top=4]="top",hr[hr.bottom=5]="bottom",hr[hr["top-left"]=6]="top-left",hr[hr["top-right"]=7]="top-right",hr[hr["bottom-left"]=8]="bottom-left",hr[hr["bottom-right"]=9]="bottom-right";const Ea=7,hu=Number.POSITIVE_INFINITY;function Jd(r,t){return t[1]!==hu?function(n,a,l){let d=0,p=0;switch(a=Math.abs(a),l=Math.abs(l),n){case"top-right":case"top-left":case"top":p=l-Ea;break;case"bottom-right":case"bottom-left":case"bottom":p=-l+Ea}switch(n){case"top-right":case"bottom-right":case"right":d=-a;break;case"top-left":case"bottom-left":case"left":d=a}return[d,p]}(r,t[0],t[1]):function(n,a){let l=0,d=0;a<0&&(a=0);const p=a/Math.SQRT2;switch(n){case"top-right":case"top-left":d=p-Ea;break;case"bottom-right":case"bottom-left":d=-p+Ea;break;case"bottom":d=-a+Ea;break;case"top":d=a-Ea}switch(n){case"top-right":case"bottom-right":l=-p;break;case"top-left":case"bottom-left":l=p;break;case"left":l=a;break;case"right":l=-a}return[l,d]}(r,t[0])}function Qd(r,t,n){var a;const l=r.layout,d=(a=l.get("text-variable-anchor-offset"))===null||a===void 0?void 0:a.evaluate(t,{},n);if(d){const m=d.values,_=[];for(let v=0;v<m.length;v+=2){const b=_[v]=m[v],w=m[v+1].map(C=>C*Gi);b.startsWith("top")?w[1]-=Ea:b.startsWith("bottom")&&(w[1]+=Ea),_[v+1]=w}return new Xi(_)}const p=l.get("text-variable-anchor");if(p){let m;m=r._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[l.get("text-radial-offset").evaluate(t,{},n)*Gi,hu]:l.get("text-offset").evaluate(t,{},n).map(v=>v*Gi);const _=[];for(const v of p)_.push(v,Jd(v,m));return new Xi(_)}return null}function uu(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function _m(r,t,n,a,l,d,p,m,_,v,b,w){let C=d.textMaxSize.evaluate(t,{});C===void 0&&(C=p);const A=r.layers[0].layout,k=A.get("icon-offset").evaluate(t,{},b),D=tp(n.horizontal),B=p/24,U=r.tilePixelRatio*B,ee=r.tilePixelRatio*C/24,G=r.tilePixelRatio*m,E=r.tilePixelRatio*A.get("symbol-spacing"),F=A.get("text-padding")*r.tilePixelRatio,q=function(dt,ht,rt,Lt=1){const Ci=dt.get("icon-padding").evaluate(ht,{},rt),qi=Ci&&Ci.values;return[qi[0]*Lt,qi[1]*Lt,qi[2]*Lt,qi[3]*Lt]}(A,t,b,r.tilePixelRatio),pe=A.get("text-max-angle")/180*Math.PI,Se=A.get("text-rotation-alignment")!=="viewport"&&A.get("symbol-placement")!=="point",ge=A.get("icon-rotation-alignment")==="map"&&A.get("symbol-placement")!=="point",_e=A.get("symbol-placement"),ze=E/2,Ie=A.get("icon-text-fit");let De;a&&Ie!=="none"&&(r.allowVerticalPlacement&&n.vertical&&(De=Td(a,n.vertical,Ie,A.get("icon-text-fit-padding"),k,B)),D&&(a=Td(a,D,Ie,A.get("icon-text-fit-padding"),k,B)));const Te=b?w.line.getGranularityForZoomLevel(b.z):1,Ye=(dt,ht)=>{ht.x<0||ht.x>=Mt||ht.y<0||ht.y>=Mt||function(rt,Lt,Ci,qi,ur,tn,zr,ar,bi,Ji,sr,or,Tr,rn,Qi,Dr,Hi,er,tr,ji,mi,vn,uo,xn,xm){const po=rt.addToLineVertexArray(Lt,Ci);let ts,fo,mo,go,ap=0,sp=0,op=0,lp=0,vu=-1,xu=-1;const ta={};let cp=Zi("");if(rt.allowVerticalPlacement&&qi.vertical){const gr=ar.layout.get("text-rotate").evaluate(mi,{},xn)+90;mo=new Jc(bi,Lt,Ji,sr,or,qi.vertical,Tr,rn,Qi,gr),zr&&(go=new Jc(bi,Lt,Ji,sr,or,zr,Hi,er,Qi,gr))}if(ur){const gr=ar.layout.get("icon-rotate").evaluate(mi,{}),nn=ar.layout.get("icon-text-fit")!=="none",is=Kd(ur,gr,uo,nn),wn=zr?Kd(zr,gr,uo,nn):void 0;fo=new Jc(bi,Lt,Ji,sr,or,ur,Hi,er,!1,gr),ap=4*is.length;const rs=rt.iconSizeData;let Dn=null;rs.kind==="source"?(Dn=[zn*ar.layout.get("icon-size").evaluate(mi,{})],Dn[0]>Sa&&xi(`${rt.layerIds[0]}: Value for "icon-size" is >= ${Fl}. Reduce your "icon-size".`)):rs.kind==="composite"&&(Dn=[zn*vn.compositeIconSizes[0].evaluate(mi,{},xn),zn*vn.compositeIconSizes[1].evaluate(mi,{},xn)],(Dn[0]>Sa||Dn[1]>Sa)&&xi(`${rt.layerIds[0]}: Value for "icon-size" is >= ${Fl}. Reduce your "icon-size".`)),rt.addSymbols(rt.icon,is,Dn,ji,tr,mi,I.ag.none,Lt,po.lineStartIndex,po.lineLength,-1,xn),vu=rt.icon.placedSymbolArray.length-1,wn&&(sp=4*wn.length,rt.addSymbols(rt.icon,wn,Dn,ji,tr,mi,I.ag.vertical,Lt,po.lineStartIndex,po.lineLength,-1,xn),xu=rt.icon.placedSymbolArray.length-1)}const hp=Object.keys(qi.horizontal);for(const gr of hp){const nn=qi.horizontal[gr];if(!ts){cp=Zi(nn.text);const wn=ar.layout.get("text-rotate").evaluate(mi,{},xn);ts=new Jc(bi,Lt,Ji,sr,or,nn,Tr,rn,Qi,wn)}const is=nn.positionedLines.length===1;if(op+=ep(rt,Lt,nn,tn,ar,Qi,mi,Dr,po,qi.vertical?I.ag.horizontal:I.ag.horizontalOnly,is?hp:[gr],ta,vu,vn,xn),is)break}qi.vertical&&(lp+=ep(rt,Lt,qi.vertical,tn,ar,Qi,mi,Dr,po,I.ag.vertical,["vertical"],ta,xu,vn,xn));const bm=ts?ts.boxStartIndex:rt.collisionBoxArray.length,wm=ts?ts.boxEndIndex:rt.collisionBoxArray.length,Tm=mo?mo.boxStartIndex:rt.collisionBoxArray.length,Pm=mo?mo.boxEndIndex:rt.collisionBoxArray.length,Mm=fo?fo.boxStartIndex:rt.collisionBoxArray.length,Sm=fo?fo.boxEndIndex:rt.collisionBoxArray.length,Cm=go?go.boxStartIndex:rt.collisionBoxArray.length,Im=go?go.boxEndIndex:rt.collisionBoxArray.length;let bn=-1;const eh=(gr,nn)=>gr&&gr.circleDiameter?Math.max(gr.circleDiameter,nn):nn;bn=eh(ts,bn),bn=eh(mo,bn),bn=eh(fo,bn),bn=eh(go,bn);const up=bn>-1?1:0;up&&(bn*=xm/Gi),rt.glyphOffsetArray.length>=lo.MAX_GLYPHS&&xi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),mi.sortKey!==void 0&&rt.addToSortKeyRanges(rt.symbolInstances.length,mi.sortKey);const Em=Qd(ar,mi,xn),[Am,km]=function(gr,nn){const is=gr.length,wn=nn==null?void 0:nn.values;if((wn==null?void 0:wn.length)>0)for(let rs=0;rs<wn.length;rs+=2){const Dn=wn[rs+1];gr.emplaceBack(I.ax[wn[rs]],Dn[0],Dn[1])}return[is,gr.length]}(rt.textAnchorOffsets,Em);rt.symbolInstances.emplaceBack(Lt.x,Lt.y,ta.right>=0?ta.right:-1,ta.center>=0?ta.center:-1,ta.left>=0?ta.left:-1,ta.vertical||-1,vu,xu,cp,bm,wm,Tm,Pm,Mm,Sm,Cm,Im,Ji,op,lp,ap,sp,up,0,Tr,bn,Am,km)}(r,ht,dt,n,a,l,De,r.layers[0],r.collisionBoxArray,t.index,t.sourceLayerIndex,r.index,U,[F,F,F,F],Se,_,G,q,ge,k,t,d,v,b,p)};if(_e==="line")for(const dt of $d(t.geometry,0,0,Mt,Mt)){const ht=es(dt,Te),rt=pm(ht,E,pe,n.vertical||D,a,24,ee,r.overscaling,Mt);for(const Lt of rt)D&&ym(r,D.text,ze,Lt)||Ye(ht,Lt)}else if(_e==="line-center"){for(const dt of t.geometry)if(dt.length>1){const ht=es(dt,Te),rt=dm(ht,pe,n.vertical||D,a,24,ee);rt&&Ye(ht,rt)}}else if(t.type==="Polygon")for(const dt of Ts(t.geometry,0)){const ht=mm(dt,16);Ye(es(dt[0],Te,!0),new Ia(ht.x,ht.y,0))}else if(t.type==="LineString")for(const dt of t.geometry){const ht=es(dt,Te);Ye(ht,new Ia(ht[0].x,ht[0].y,0))}else if(t.type==="Point")for(const dt of t.geometry)for(const ht of dt)Ye([ht],new Ia(ht.x,ht.y,0))}function ep(r,t,n,a,l,d,p,m,_,v,b,w,C,A,k){const D=function(ee,G,E,F,q,pe,Se,ge){const _e=F.layout.get("text-rotate").evaluate(pe,{})*Math.PI/180,ze=[];for(const Ie of G.positionedLines)for(const De of Ie.positionedGlyphs){if(!De.rect)continue;const Te=De.rect||{};let Ye=Gf+1,dt=!0,ht=1,rt=0;const Lt=(q||ge)&&De.vertical,Ci=De.metrics.advance*De.scale/2;if(ge&&G.verticalizable&&(rt=Ie.lineOffset/2-(De.imageName?-(Gi-De.metrics.width*De.scale)/2:(De.scale-1)*Gi)),De.imageName){const er=Se[De.imageName];dt=er.sdf,ht=er.pixelRatio,Ye=kr/ht}const qi=q?[De.x+Ci,De.y]:[0,0];let ur=q?[0,0]:[De.x+Ci+E[0],De.y+E[1]-rt],tn=[0,0];Lt&&(tn=ur,ur=[0,0]);const zr=De.metrics.isDoubleResolution?2:1,ar=(De.metrics.left-Ye)*De.scale-Ci+ur[0],bi=(-De.metrics.top-Ye)*De.scale+ur[1],Ji=ar+Te.w/zr*De.scale/ht,sr=bi+Te.h/zr*De.scale/ht,or=new Be(ar,bi),Tr=new Be(Ji,bi),rn=new Be(ar,sr),Qi=new Be(Ji,sr);if(Lt){const er=new Be(-Ci,Ci-$c),tr=-Math.PI/2,ji=Gi/2-Ci,mi=new Be(5-$c-ji,-(De.imageName?ji:0)),vn=new Be(...tn);or._rotateAround(tr,er)._add(mi)._add(vn),Tr._rotateAround(tr,er)._add(mi)._add(vn),rn._rotateAround(tr,er)._add(mi)._add(vn),Qi._rotateAround(tr,er)._add(mi)._add(vn)}if(_e){const er=Math.sin(_e),tr=Math.cos(_e),ji=[tr,-er,er,tr];or._matMult(ji),Tr._matMult(ji),rn._matMult(ji),Qi._matMult(ji)}const Dr=new Be(0,0),Hi=new Be(0,0);ze.push({tl:or,tr:Tr,bl:rn,br:Qi,tex:Te,writingMode:G.writingMode,glyphOffset:qi,sectionIndex:De.sectionIndex,isSDF:dt,pixelOffsetTL:Dr,pixelOffsetBR:Hi,minFontScaleX:0,minFontScaleY:0})}return ze}(0,n,m,l,d,p,a,r.allowVerticalPlacement),B=r.textSizeData;let U=null;B.kind==="source"?(U=[zn*l.layout.get("text-size").evaluate(p,{})],U[0]>Sa&&xi(`${r.layerIds[0]}: Value for "text-size" is >= ${Fl}. Reduce your "text-size".`)):B.kind==="composite"&&(U=[zn*A.compositeTextSizes[0].evaluate(p,{},k),zn*A.compositeTextSizes[1].evaluate(p,{},k)],(U[0]>Sa||U[1]>Sa)&&xi(`${r.layerIds[0]}: Value for "text-size" is >= ${Fl}. Reduce your "text-size".`)),r.addSymbols(r.text,D,U,m,d,p,v,t,_.lineStartIndex,_.lineLength,C,k);for(const ee of b)w[ee]=r.text.placedSymbolArray.length-1;return 4*D.length}function tp(r){for(const t in r)return r[t];return null}function ym(r,t,n,a){const l=r.compareText;if(t in l){const d=l[t];for(let p=d.length-1;p>=0;p--)if(a.dist(d[p])<n)return!0}else l[t]=[];return l[t].push(a),!1}const ip=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class du{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,a]=new Uint8Array(t,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");const l=a>>4;if(l!==1)throw new Error(`Got v${l} data when expected v1.`);const d=ip[15&a];if(!d)throw new Error("Unrecognized array type.");const[p]=new Uint16Array(t,2,1),[m]=new Uint32Array(t,4,1);return new du(m,p,d,t)}constructor(t,n=64,a=Float64Array,l){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=a,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const d=ip.indexOf(this.ArrayType),p=2*t*this.ArrayType.BYTES_PER_ELEMENT,m=t*this.IndexArrayType.BYTES_PER_ELEMENT,_=(8-m%8)%8;if(d<0)throw new Error(`Unexpected typed array class: ${a}.`);l&&l instanceof ArrayBuffer?(this.data=l,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+m+_,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+p+m+_),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+m+_,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+d]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=t)}add(t,n){const a=this._pos>>1;return this.ids[a]=a,this.coords[this._pos++]=t,this.coords[this._pos++]=n,a}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return pu(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,n,a,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:d,coords:p,nodeSize:m}=this,_=[0,d.length-1,0],v=[];for(;_.length;){const b=_.pop()||0,w=_.pop()||0,C=_.pop()||0;if(w-C<=m){for(let B=C;B<=w;B++){const U=p[2*B],ee=p[2*B+1];U>=t&&U<=a&&ee>=n&&ee<=l&&v.push(d[B])}continue}const A=C+w>>1,k=p[2*A],D=p[2*A+1];k>=t&&k<=a&&D>=n&&D<=l&&v.push(d[A]),(b===0?t<=k:n<=D)&&(_.push(C),_.push(A-1),_.push(1-b)),(b===0?a>=k:l>=D)&&(_.push(A+1),_.push(w),_.push(1-b))}return v}within(t,n,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:d,nodeSize:p}=this,m=[0,l.length-1,0],_=[],v=a*a;for(;m.length;){const b=m.pop()||0,w=m.pop()||0,C=m.pop()||0;if(w-C<=p){for(let B=C;B<=w;B++)np(d[2*B],d[2*B+1],t,n)<=v&&_.push(l[B]);continue}const A=C+w>>1,k=d[2*A],D=d[2*A+1];np(k,D,t,n)<=v&&_.push(l[A]),(b===0?t-a<=k:n-a<=D)&&(m.push(C),m.push(A-1),m.push(1-b)),(b===0?t+a>=k:n+a>=D)&&(m.push(A+1),m.push(w),m.push(1-b))}return _}}function pu(r,t,n,a,l,d){if(l-a<=n)return;const p=a+l>>1;rp(r,t,p,a,l,d),pu(r,t,n,a,p-1,1-d),pu(r,t,n,p+1,l,1-d)}function rp(r,t,n,a,l,d){for(;l>a;){if(l-a>600){const v=l-a+1,b=n-a+1,w=Math.log(v),C=.5*Math.exp(2*w/3),A=.5*Math.sqrt(w*C*(v-C)/v)*(b-v/2<0?-1:1);rp(r,t,n,Math.max(a,Math.floor(n-b*C/v+A)),Math.min(l,Math.floor(n+(v-b)*C/v+A)),d)}const p=t[2*n+d];let m=a,_=l;for(jl(r,t,a,n),t[2*l+d]>p&&jl(r,t,a,l);m<_;){for(jl(r,t,m,_),m++,_--;t[2*m+d]<p;)m++;for(;t[2*_+d]>p;)_--}t[2*a+d]===p?jl(r,t,a,_):(_++,jl(r,t,_,l)),_<=n&&(a=_+1),n<=_&&(l=_-1)}}function jl(r,t,n,a){fu(r,n,a),fu(t,2*n,2*a),fu(t,2*n+1,2*a+1)}function fu(r,t,n){const a=r[t];r[t]=r[n],r[n]=a}function np(r,t,n,a){const l=r-n,d=t-a;return l*l+d*d}var mu;I.cg=void 0,(mu=I.cg||(I.cg={})).create="create",mu.load="load",mu.fullLoad="fullLoad";let Qc=null,Vl=[];const gu=1e3/60,_u="loadTime",yu="fullLoadTime",vm={mark(r){performance.mark(r)},frame(r){const t=r;Qc!=null&&Vl.push(t-Qc),Qc=t},clearMetrics(){Qc=null,Vl=[],performance.clearMeasures(_u),performance.clearMeasures(yu);for(const r in I.cg)performance.clearMarks(I.cg[r])},getPerformanceMetrics(){performance.measure(_u,I.cg.create,I.cg.load),performance.measure(yu,I.cg.create,I.cg.fullLoad);const r=performance.getEntriesByName(_u)[0].duration,t=performance.getEntriesByName(yu)[0].duration,n=Vl.length,a=1/(Vl.reduce((d,p)=>d+p,0)/n/1e3),l=Vl.filter(d=>d>gu).reduce((d,p)=>d+(p-gu)/gu,0);return{loadTime:r,fullLoadTime:t,fps:a,percentDroppedFrames:l/(n+l)*100,totalFrames:n}}};I.$=Bl,I.A=Ue,I.B=Ir,I.C=_i,I.D=at,I.E=se,I.F=Mc,I.G=function(r){if(ci==null){const t=r.navigator?r.navigator.userAgent:null;ci=!!r.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return ci},I.H=class{constructor(r,t){this.target=r,this.mapId=t,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new cm(()=>this.process()),this.subscription=pr(this.target,"message",n=>this.receive(n),!1),this.globalScope=Fi(self)?r:window}registerMessageHandler(r,t){this.messageHandlers[r]=t}sendAsync(r,t){return new Promise((n,a)=>{const l=Math.round(1e18*Math.random()).toString(36).substring(0,10),d=t?pr(t.signal,"abort",()=>{d==null||d.unsubscribe(),delete this.resolveRejects[l];const _={id:l,type:"<cancel>",origin:location.origin,targetMapId:r.targetMapId,sourceMapId:this.mapId};this.target.postMessage(_)},hm):null;this.resolveRejects[l]={resolve:_=>{d==null||d.unsubscribe(),n(_)},reject:_=>{d==null||d.unsubscribe(),a(_)}};const p=[],m=Object.assign(Object.assign({},r),{id:l,sourceMapId:this.mapId,origin:location.origin,data:En(r.data,p)});this.target.postMessage(m,{transfer:p})})}receive(r){const t=r.data,n=t.id;if(!(t.origin!=="file://"&&location.origin!=="file://"&&t.origin!=="resource://android"&&location.origin!=="resource://android"&&t.origin!==location.origin||t.targetMapId&&this.mapId!==t.targetMapId)){if(t.type==="<cancel>"){delete this.tasks[n];const a=this.abortControllers[n];return delete this.abortControllers[n],void(a&&a.abort())}if(Fi(self)||t.mustQueue)return this.tasks[n]=t,this.taskQueue.push(n),void this.invoker.trigger();this.processTask(n,t)}}process(){if(this.taskQueue.length===0)return;const r=this.taskQueue.shift(),t=this.tasks[r];delete this.tasks[r],this.taskQueue.length>0&&this.invoker.trigger(),t&&this.processTask(r,t)}processTask(r,t){return c(this,void 0,void 0,function*(){if(t.type==="<response>"){const l=this.resolveRejects[r];return delete this.resolveRejects[r],l?void(t.error?l.reject(Ha(t.error)):l.resolve(Ha(t.data))):void 0}if(!this.messageHandlers[t.type])return void this.completeTask(r,new Error(`Could not find a registered handler for ${t.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const n=Ha(t.data),a=new AbortController;this.abortControllers[r]=a;try{const l=yield this.messageHandlers[t.type](t.sourceMapId,n,a);this.completeTask(r,null,l)}catch(l){this.completeTask(r,l)}})}completeTask(r,t,n){const a=[];delete this.abortControllers[r];const l={id:r,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:t?En(t):null,data:En(n,a)};this.target.postMessage(l,{transfer:a})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},I.I=Qh,I.J=ft,I.K=function(){var r=new Ue(16);return Ue!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r},I.L=function(r,t,n){var a,l,d,p,m,_,v,b,w,C,A,k,D=n[0],B=n[1],U=n[2];return t===r?(r[12]=t[0]*D+t[4]*B+t[8]*U+t[12],r[13]=t[1]*D+t[5]*B+t[9]*U+t[13],r[14]=t[2]*D+t[6]*B+t[10]*U+t[14],r[15]=t[3]*D+t[7]*B+t[11]*U+t[15]):(l=t[1],d=t[2],p=t[3],m=t[4],_=t[5],v=t[6],b=t[7],w=t[8],C=t[9],A=t[10],k=t[11],r[0]=a=t[0],r[1]=l,r[2]=d,r[3]=p,r[4]=m,r[5]=_,r[6]=v,r[7]=b,r[8]=w,r[9]=C,r[10]=A,r[11]=k,r[12]=a*D+m*B+w*U+t[12],r[13]=l*D+_*B+C*U+t[13],r[14]=d*D+v*B+A*U+t[14],r[15]=p*D+b*B+k*U+t[15]),r},I.M=function(r,t,n){var a=n[0],l=n[1],d=n[2];return r[0]=t[0]*a,r[1]=t[1]*a,r[2]=t[2]*a,r[3]=t[3]*a,r[4]=t[4]*l,r[5]=t[5]*l,r[6]=t[6]*l,r[7]=t[7]*l,r[8]=t[8]*d,r[9]=t[9]*d,r[10]=t[10]*d,r[11]=t[11]*d,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r},I.N=function(r,t,n){var a=t[0],l=t[1],d=t[2],p=t[3],m=t[4],_=t[5],v=t[6],b=t[7],w=t[8],C=t[9],A=t[10],k=t[11],D=t[12],B=t[13],U=t[14],ee=t[15],G=n[0],E=n[1],F=n[2],q=n[3];return r[0]=G*a+E*m+F*w+q*D,r[1]=G*l+E*_+F*C+q*B,r[2]=G*d+E*v+F*A+q*U,r[3]=G*p+E*b+F*k+q*ee,r[4]=(G=n[4])*a+(E=n[5])*m+(F=n[6])*w+(q=n[7])*D,r[5]=G*l+E*_+F*C+q*B,r[6]=G*d+E*v+F*A+q*U,r[7]=G*p+E*b+F*k+q*ee,r[8]=(G=n[8])*a+(E=n[9])*m+(F=n[10])*w+(q=n[11])*D,r[9]=G*l+E*_+F*C+q*B,r[10]=G*d+E*v+F*A+q*U,r[11]=G*p+E*b+F*k+q*ee,r[12]=(G=n[12])*a+(E=n[13])*m+(F=n[14])*w+(q=n[15])*D,r[13]=G*l+E*_+F*C+q*B,r[14]=G*d+E*v+F*A+q*U,r[15]=G*p+E*b+F*k+q*ee,r},I.O=function(r,t){const n={};for(let a=0;a<t.length;a++){const l=t[a];l in r&&(n[l]=r[l])}return n},I.P=Be,I.Q=Ca,I.R=Qr,I.S=Dd,I.T=fl,I.U=zd,I.V=jt,I.W=Ze,I.X=ir,I.Y=en,I.Z=Mt,I._=c,I.a=nt,I.a$=function(){const r=new Float32Array(16);return Dt(r),r},I.a0=cu,I.a1=r=>{const t=window.document.createElement("video");return t.muted=!0,new Promise(n=>{t.onloadstart=()=>{n(t)};for(const a of r){const l=window.document.createElement("source");ki(a)||(t.crossOrigin="Anonymous"),l.src=a,t.appendChild(l)}})},I.a2=ce,I.a3=function(){return lt++},I.a4=f,I.a5=lo,I.a6=Os,I.a7=Ar,I.a8=Vd,I.a9=function(r){const t={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,a,l,d)=>{const p=l||d;return t[a]=!p||p.toLowerCase(),""}),t["max-age"]){const n=parseInt(t["max-age"],10);isNaN(n)?delete t["max-age"]:t["max-age"]=n}return t},I.aA=tu,I.aB=du,I.aC=Di,I.aD=Nc,I.aE=N,I.aF=ot,I.aG=Le,I.aH=function(r){return Math.pow(2,r)},I.aI=85.051129,I.aJ=Rd,I.aK=Wt,I.aL=fr,I.aM=Ld,I.aN=function(r,t,n){return r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r},I.aO=function(r,t,n){return r[0]=t[0]+n[0],r[1]=t[1]+n[1],r[2]=t[2]+n[2],r},I.aP=function(r){var t=new Ue(3);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t},I.aQ=function(r,t,n){return r[0]=t[0]*n[0],r[1]=t[1]*n[1],r[2]=t[2]*n[2],r[3]=t[3]*n[3],r},I.aR=function(r,t,n){return r[0]=t[0]-n[0],r[1]=t[1]-n[1],r[2]=t[2]-n[2],r},I.aS=function(r,t){var n=t[0],a=t[1],l=t[2],d=n*n+a*a+l*l;return d>0&&(d=1/Math.sqrt(d)),r[0]=t[0]*d,r[1]=t[1]*d,r[2]=t[2]*d,r},I.aT=function(r,t,n){var a=t[0],l=t[1],d=t[2],p=n[0],m=n[1],_=n[2];return r[0]=l*_-d*m,r[1]=d*p-a*_,r[2]=a*m-l*p,r},I.aU=function(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]},I.aV=Bd,I.aW=co,I.aX=function(r,t,n,a,l){var d,p=1/Math.tan(t/2);return r[0]=p/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=p,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,l!=null&&l!==1/0?(r[10]=(l+a)*(d=1/(a-l)),r[14]=2*l*a*d):(r[10]=-1,r[14]=-2*a),r},I.aY=function(r){var t=new Ue(16);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t},I.aZ=function(r,t,n){var a=Math.sin(n),l=Math.cos(n),d=t[0],p=t[1],m=t[2],_=t[3],v=t[4],b=t[5],w=t[6],C=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=d*l+v*a,r[1]=p*l+b*a,r[2]=m*l+w*a,r[3]=_*l+C*a,r[4]=v*l-d*a,r[5]=b*l-p*a,r[6]=w*l-m*a,r[7]=C*l-_*a,r},I.a_=function(r,t,n){var a=Math.sin(n),l=Math.cos(n),d=t[4],p=t[5],m=t[6],_=t[7],v=t[8],b=t[9],w=t[10],C=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=d*l+v*a,r[5]=p*l+b*a,r[6]=m*l+w*a,r[7]=_*l+C*a,r[8]=v*l-d*a,r[9]=b*l-p*a,r[10]=w*l-m*a,r[11]=C*l-_*a,r},I.aa=function(r){return Math.log(r)/Math.LN2},I.ab=function(r){var t=r[0],n=r[1];return t*t+n*n},I.ac=function(r){return r*Math.PI/180},I.ad=Kt,I.ae=function(r,t){const n=[];for(const a in r)a in t||n.push(a);return n},I.af=function(r,t){let n=0,a=0;if(r.kind==="constant")a=r.layoutSize;else if(r.kind!=="source"){const{interpolationType:l,minZoom:d,maxZoom:p}=r,m=l?Kt(cr.interpolationFactor(l,t,d,p),0,1):0;r.kind==="camera"?a=Ir.number(r.minSize,r.maxSize,m):n=m}return{uSizeT:n,uSize:a}},I.ah=function(r,{uSize:t,uSizeT:n},{lowerSize:a,upperSize:l}){return r.kind==="source"?a/zn:r.kind==="composite"?Ir.number(a/zn,l/zn,n):t},I.ai=function(r,t){var n=t[0],a=t[1],l=t[2],d=t[3],p=t[4],m=t[5],_=t[6],v=t[7],b=t[8],w=t[9],C=t[10],A=t[11],k=t[12],D=t[13],B=t[14],U=t[15],ee=n*m-a*p,G=n*_-l*p,E=n*v-d*p,F=a*_-l*m,q=a*v-d*m,pe=l*v-d*_,Se=b*D-w*k,ge=b*B-C*k,_e=b*U-A*k,ze=w*B-C*D,Ie=w*U-A*D,De=C*U-A*B,Te=ee*De-G*Ie+E*ze+F*_e-q*ge+pe*Se;return Te?(r[0]=(m*De-_*Ie+v*ze)*(Te=1/Te),r[1]=(l*Ie-a*De-d*ze)*Te,r[2]=(D*pe-B*q+U*F)*Te,r[3]=(C*q-w*pe-A*F)*Te,r[4]=(_*_e-p*De-v*ge)*Te,r[5]=(n*De-l*_e+d*ge)*Te,r[6]=(B*E-k*pe-U*G)*Te,r[7]=(b*pe-C*E+A*G)*Te,r[8]=(p*Ie-m*_e+v*Se)*Te,r[9]=(a*_e-n*Ie-d*Se)*Te,r[10]=(k*q-D*E+U*ee)*Te,r[11]=(w*E-b*q-A*ee)*Te,r[12]=(m*ge-p*ze-_*Se)*Te,r[13]=(n*ze-a*ge+l*Se)*Te,r[14]=(D*G-k*F-B*ee)*Te,r[15]=(b*F-w*G+C*ee)*Te,r):null},I.aj=gt,I.ak=function(r){return Math.hypot(r[0],r[1])},I.al=function(r){return r[0]=0,r[1]=0,r},I.am=function(r,t,n){return r[0]=t[0]*n,r[1]=t[1]*n,r},I.an=ru,I.ao=bt,I.ap=function(r,t,n,a){const l=t.y-r.y,d=t.x-r.x,p=a.y-n.y,m=a.x-n.x,_=p*d-m*l;if(_===0)return null;const v=(m*(r.y-n.y)-p*(r.x-n.x))/_;return new Be(r.x+v*d,r.y+v*l)},I.aq=$d,I.ar=to,I.as=Dt,I.at=function(r){let t=1/0,n=1/0,a=-1/0,l=-1/0;for(const d of r)t=Math.min(t,d.x),n=Math.min(n,d.y),a=Math.max(a,d.x),l=Math.max(l,d.y);return[t,n,a,l]},I.au=Gi,I.av=ai,I.aw=function(r,t,n,a,l=!1){if(!n[0]&&!n[1])return[0,0];const d=l?a==="map"?-r.bearingInRadians:0:a==="viewport"?r.bearingInRadians:0;if(d){const p=Math.sin(d),m=Math.cos(d);n=[n[0]*m-n[1]*p,n[0]*p+n[1]*m]}return[l?n[0]:ai(t,n[0],r.zoom),l?n[1]:ai(t,n[1],r.zoom)]},I.ay=iu,I.az=uu,I.b=Mr,I.b$=r=>r.type==="circle",I.b0=function(){const r=new Float64Array(16);return Dt(r),r},I.b1=function(){return new Float64Array(16)},I.b2=function(r,t,n){const a=new Float64Array(4);return function(l,d,p,m){var _=.5*Math.PI/180;d*=_,p*=_,m*=_;var v=Math.sin(d),b=Math.cos(d),w=Math.sin(p),C=Math.cos(p),A=Math.sin(m),k=Math.cos(m);l[0]=v*C*k-b*w*A,l[1]=b*w*k+v*C*A,l[2]=b*C*A-v*w*k,l[3]=b*C*k+v*w*A}(a,r,t-90,n),a},I.b3=function(r,t,n,a){var l,d,p,m,_,v=t[0],b=t[1],w=t[2],C=t[3],A=n[0],k=n[1],D=n[2],B=n[3];return(d=v*A+b*k+w*D+C*B)<0&&(d=-d,A=-A,k=-k,D=-D,B=-B),1-d>tt?(l=Math.acos(d),p=Math.sin(l),m=Math.sin((1-a)*l)/p,_=Math.sin(a*l)/p):(m=1-a,_=a),r[0]=m*v+_*A,r[1]=m*b+_*k,r[2]=m*w+_*D,r[3]=m*C+_*B,r},I.b4=function(r){const t=new Float64Array(9);var n,a,l,d,p,m,_,v,b,w,C,A,k,D,B,U,ee,G;w=(l=(a=r)[0])*(_=l+l),C=(d=a[1])*_,k=(p=a[2])*_,D=p*(v=d+d),U=(m=a[3])*_,ee=m*v,G=m*(b=p+p),(n=t)[0]=1-(A=d*v)-(B=p*b),n[3]=C-G,n[6]=k+ee,n[1]=C+G,n[4]=1-w-B,n[7]=D-U,n[2]=k-ee,n[5]=D+U,n[8]=1-w-A;const E=fr(-Math.asin(Kt(t[2],-1,1)));let F,q;return Math.hypot(t[5],t[8])<.001?(F=0,q=-fr(Math.atan2(t[3],t[4]))):(F=fr(t[5]===0&&t[8]===0?0:Math.atan2(t[5],t[8])),q=fr(t[1]===0&&t[0]===0?0:Math.atan2(t[1],t[0]))),{roll:F,pitch:E+90,bearing:q}},I.b5=function(r,t){return r.roll==t.roll&&r.pitch==t.pitch&&r.bearing==t.bearing},I.b6=$t,I.b7=Yn,I.b8=so,I.b9=El,I.bA=function(r){const t=[],n=r.id;return n===void 0&&t.push({message:`layers.${n}: missing required property "id"`}),r.render===void 0&&t.push({message:`layers.${n}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&t.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),t},I.bB=function r(t,n){if(Array.isArray(t)){if(!Array.isArray(n)||t.length!==n.length)return!1;for(let a=0;a<t.length;a++)if(!r(t[a],n[a]))return!1;return!0}if(typeof t=="object"&&t!==null&&n!==null){if(typeof n!="object"||Object.keys(t).length!==Object.keys(n).length)return!1;for(const a in t)if(!r(t[a],n[a]))return!1;return!0}return t===n},I.bC=St,I.bD=Zt,I.bE=class extends $r{constructor(r,t){super(r,t),this.current=0}set(r){this.current!==r&&(this.current=r,this.gl.uniform1i(this.location,r))}},I.bF=Jn,I.bG=class extends $r{constructor(r,t){super(r,t),this.current=Gr}set(r){if(r[12]!==this.current[12]||r[0]!==this.current[0])return this.current=r,void this.gl.uniformMatrix4fv(this.location,!1,r);for(let t=1;t<16;t++)if(r[t]!==this.current[t]){this.current=r,this.gl.uniformMatrix4fv(this.location,!1,r);break}}},I.bH=Ja,I.bI=class extends $r{constructor(r,t){super(r,t),this.current=[0,0,0]}set(r){r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]||(this.current=r,this.gl.uniform3f(this.location,r[0],r[1],r[2]))}},I.bJ=class extends $r{constructor(r,t){super(r,t),this.current=[0,0]}set(r){r[0]===this.current[0]&&r[1]===this.current[1]||(this.current=r,this.gl.uniform2f(this.location,r[0],r[1]))}},I.bK=xt,I.bL=function(r,t){var n=Math.sin(t),a=Math.cos(t);return r[0]=a,r[1]=n,r[2]=0,r[3]=-n,r[4]=a,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},I.bM=function(r,t,n){var a=t[0],l=t[1],d=t[2];return r[0]=a*n[0]+l*n[3]+d*n[6],r[1]=a*n[1]+l*n[4]+d*n[7],r[2]=a*n[2]+l*n[5]+d*n[8],r},I.bN=function(r,t,n,a,l,d,p){var m=1/(t-n),_=1/(a-l),v=1/(d-p);return r[0]=-2*m,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*_,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*v,r[11]=0,r[12]=(t+n)*m,r[13]=(l+a)*_,r[14]=(p+d)*v,r[15]=1,r},I.bO=class extends Ks{},I.bP=jf,I.bQ=class extends Ys{},I.bR=Bh,I.bS=function(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))},I.bT=ju,I.bU=function(r,t,n){var a=t[0],l=t[1],d=t[2],p=n[3]*a+n[7]*l+n[11]*d+n[15];return r[0]=(n[0]*a+n[4]*l+n[8]*d+n[12])/(p=p||1),r[1]=(n[1]*a+n[5]*l+n[9]*d+n[13])/p,r[2]=(n[2]*a+n[6]*l+n[10]*d+n[14])/p,r},I.bV=class extends _l{},I.bW=class extends s{},I.bX=function(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]&&r[4]===t[4]&&r[5]===t[5]&&r[6]===t[6]&&r[7]===t[7]&&r[8]===t[8]&&r[9]===t[9]&&r[10]===t[10]&&r[11]===t[11]&&r[12]===t[12]&&r[13]===t[13]&&r[14]===t[14]&&r[15]===t[15]},I.bY=function(r,t){var n=r[0],a=r[1],l=r[2],d=r[3],p=r[4],m=r[5],_=r[6],v=r[7],b=r[8],w=r[9],C=r[10],A=r[11],k=r[12],D=r[13],B=r[14],U=r[15],ee=t[0],G=t[1],E=t[2],F=t[3],q=t[4],pe=t[5],Se=t[6],ge=t[7],_e=t[8],ze=t[9],Ie=t[10],De=t[11],Te=t[12],Ye=t[13],dt=t[14],ht=t[15];return Math.abs(n-ee)<=tt*Math.max(1,Math.abs(n),Math.abs(ee))&&Math.abs(a-G)<=tt*Math.max(1,Math.abs(a),Math.abs(G))&&Math.abs(l-E)<=tt*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(d-F)<=tt*Math.max(1,Math.abs(d),Math.abs(F))&&Math.abs(p-q)<=tt*Math.max(1,Math.abs(p),Math.abs(q))&&Math.abs(m-pe)<=tt*Math.max(1,Math.abs(m),Math.abs(pe))&&Math.abs(_-Se)<=tt*Math.max(1,Math.abs(_),Math.abs(Se))&&Math.abs(v-ge)<=tt*Math.max(1,Math.abs(v),Math.abs(ge))&&Math.abs(b-_e)<=tt*Math.max(1,Math.abs(b),Math.abs(_e))&&Math.abs(w-ze)<=tt*Math.max(1,Math.abs(w),Math.abs(ze))&&Math.abs(C-Ie)<=tt*Math.max(1,Math.abs(C),Math.abs(Ie))&&Math.abs(A-De)<=tt*Math.max(1,Math.abs(A),Math.abs(De))&&Math.abs(k-Te)<=tt*Math.max(1,Math.abs(k),Math.abs(Te))&&Math.abs(D-Ye)<=tt*Math.max(1,Math.abs(D),Math.abs(Ye))&&Math.abs(B-dt)<=tt*Math.max(1,Math.abs(B),Math.abs(dt))&&Math.abs(U-ht)<=tt*Math.max(1,Math.abs(U),Math.abs(ht))},I.bZ=function(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r},I.b_=r=>r.type==="symbol",I.ba=ao,I.bb=Tt,I.bc=Qt,I.bd=vr,I.be=function(r,t,n,a,l){return Tt(a,l,Kt((r-t)/(n-t),0,1))},I.bf=Li,I.bg=function(){return new Float64Array(4)},I.bh=function(){return new Float64Array(3)},I.bi=function(r,t,n,a){var l=[],d=[];return l[0]=t[0]-n[0],l[1]=t[1]-n[1],l[2]=t[2]-n[2],d[0]=l[0]*Math.cos(a)-l[1]*Math.sin(a),d[1]=l[0]*Math.sin(a)+l[1]*Math.cos(a),d[2]=l[2],r[0]=d[0]+n[0],r[1]=d[1]+n[1],r[2]=d[2]+n[2],r},I.bj=function(r,t,n,a){var l=[],d=[];return l[0]=t[0]-n[0],l[1]=t[1]-n[1],l[2]=t[2]-n[2],d[0]=l[0],d[1]=l[1]*Math.cos(a)-l[2]*Math.sin(a),d[2]=l[1]*Math.sin(a)+l[2]*Math.cos(a),r[0]=d[0]+n[0],r[1]=d[1]+n[1],r[2]=d[2]+n[2],r},I.bk=function(r,t,n,a){var l=[],d=[];return l[0]=t[0]-n[0],l[1]=t[1]-n[1],l[2]=t[2]-n[2],d[0]=l[2]*Math.sin(a)+l[0]*Math.cos(a),d[1]=l[1],d[2]=l[2]*Math.cos(a)-l[0]*Math.sin(a),r[0]=d[0]+n[0],r[1]=d[1]+n[1],r[2]=d[2]+n[2],r},I.bl=function(r,t,n){var a=Math.sin(n),l=Math.cos(n),d=t[0],p=t[1],m=t[2],_=t[3],v=t[8],b=t[9],w=t[10],C=t[11];return t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=d*l-v*a,r[1]=p*l-b*a,r[2]=m*l-w*a,r[3]=_*l-C*a,r[8]=d*a+v*l,r[9]=p*a+b*l,r[10]=m*a+w*l,r[11]=_*a+C*l,r},I.bm=function(r,t){const n=Li(r,360),a=Li(t,360),l=a-n,d=a>n?l-360:l+360;return Math.abs(l)<Math.abs(d)?l:d},I.bn=function(r){return r[0]=0,r[1]=0,r[2]=0,r},I.bo=function(r,t,n,a){const l=Math.sqrt(r*r+t*t),d=Math.sqrt(n*n+a*a);r/=l,t/=l,n/=d,a/=d;const p=Math.acos(r*n+t*a);return-t*n+r*a>0?p:-p},I.bp=function(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]},I.bq=ou,I.br=function(r,t){const n=Li(r,2*Math.PI),a=Li(t,2*Math.PI);return Math.min(Math.abs(n-a),Math.abs(n-a+2*Math.PI),Math.abs(n-a-2*Math.PI))},I.bs=function(r){return Math.hypot(r[0],r[1],r[2])},I.bt=function(){const r={},t=P.$version;for(const n in P.$root){const a=P.$root[n];if(a.required){let l=null;l=n==="version"?t:a.type==="array"?[]:{},l!=null&&(r[n]=l)}}return r},I.bu=Ns,I.bv=zt,I.bw=function(r){r=r.slice();const t=Object.create(null);for(let n=0;n<r.length;n++)t[r[n].id]=r[n];for(let n=0;n<r.length;n++)"ref"in r[n]&&(r[n]=O(r[n],t[r[n].ref]));return r},I.bx=function(r){if(r.type==="custom")return new lm(r);switch(r.type){case"background":return new am(r);case"circle":return new Qp(r);case"fill":return new vf(r);case"fill-extrusion":return new Cf(r);case"heatmap":return new tf(r);case"hillshade":return new nf(r);case"line":return new Lf(r);case"raster":return new om(r);case"symbol":return new Wc(r)}},I.by=ti,I.bz=function(r,t){if(!r)return[{command:"setStyle",args:[t]}];let n=[];try{if(!Z(r.version,t.version))return[{command:"setStyle",args:[t]}];Z(r.center,t.center)||n.push({command:"setCenter",args:[t.center]}),Z(r.centerAltitude,t.centerAltitude)||n.push({command:"setCenterAltitude",args:[t.centerAltitude]}),Z(r.zoom,t.zoom)||n.push({command:"setZoom",args:[t.zoom]}),Z(r.bearing,t.bearing)||n.push({command:"setBearing",args:[t.bearing]}),Z(r.pitch,t.pitch)||n.push({command:"setPitch",args:[t.pitch]}),Z(r.roll,t.roll)||n.push({command:"setRoll",args:[t.roll]}),Z(r.sprite,t.sprite)||n.push({command:"setSprite",args:[t.sprite]}),Z(r.glyphs,t.glyphs)||n.push({command:"setGlyphs",args:[t.glyphs]}),Z(r.transition,t.transition)||n.push({command:"setTransition",args:[t.transition]}),Z(r.light,t.light)||n.push({command:"setLight",args:[t.light]}),Z(r.terrain,t.terrain)||n.push({command:"setTerrain",args:[t.terrain]}),Z(r.sky,t.sky)||n.push({command:"setSky",args:[t.sky]}),Z(r.projection,t.projection)||n.push({command:"setProjection",args:[t.projection]});const a={},l=[];(function(p,m,_,v){let b;for(b in m=m||{},p=p||{})Object.prototype.hasOwnProperty.call(p,b)&&(Object.prototype.hasOwnProperty.call(m,b)||ue(b,_,v));for(b in m)Object.prototype.hasOwnProperty.call(m,b)&&(Object.prototype.hasOwnProperty.call(p,b)?Z(p[b],m[b])||(p[b].type==="geojson"&&m[b].type==="geojson"&&ye(p,m,b)?K(_,{command:"setGeoJSONSourceData",args:[b,m[b].data]}):re(b,m,_,v)):ne(b,m,_))})(r.sources,t.sources,l,a);const d=[];r.layers&&r.layers.forEach(p=>{"source"in p&&a[p.source]?n.push({command:"removeLayer",args:[p.id]}):d.push(p)}),n=n.concat(l),function(p,m,_){m=m||[];const v=(p=p||[]).map(le),b=m.map(le),w=p.reduce(Me,{}),C=m.reduce(Me,{}),A=v.slice(),k=Object.create(null);let D,B,U,ee,G;for(let E=0,F=0;E<v.length;E++)D=v[E],Object.prototype.hasOwnProperty.call(C,D)?F++:(K(_,{command:"removeLayer",args:[D]}),A.splice(A.indexOf(D,F),1));for(let E=0,F=0;E<b.length;E++)D=b[b.length-1-E],A[A.length-1-E]!==D&&(Object.prototype.hasOwnProperty.call(w,D)?(K(_,{command:"removeLayer",args:[D]}),A.splice(A.lastIndexOf(D,A.length-F),1)):F++,ee=A[A.length-E],K(_,{command:"addLayer",args:[C[D],ee]}),A.splice(A.length-E,0,D),k[D]=!0);for(let E=0;E<b.length;E++)if(D=b[E],B=w[D],U=C[D],!k[D]&&!Z(B,U))if(Z(B.source,U.source)&&Z(B["source-layer"],U["source-layer"])&&Z(B.type,U.type)){for(G in me(B.layout,U.layout,_,D,null,"setLayoutProperty"),me(B.paint,U.paint,_,D,null,"setPaintProperty"),Z(B.filter,U.filter)||K(_,{command:"setFilter",args:[D,U.filter]}),Z(B.minzoom,U.minzoom)&&Z(B.maxzoom,U.maxzoom)||K(_,{command:"setLayerZoomRange",args:[D,U.minzoom,U.maxzoom]}),B)Object.prototype.hasOwnProperty.call(B,G)&&G!=="layout"&&G!=="paint"&&G!=="filter"&&G!=="metadata"&&G!=="minzoom"&&G!=="maxzoom"&&(G.indexOf("paint.")===0?me(B[G],U[G],_,D,G.slice(6),"setPaintProperty"):Z(B[G],U[G])||K(_,{command:"setLayerProperty",args:[D,G,U[G]]}));for(G in U)Object.prototype.hasOwnProperty.call(U,G)&&!Object.prototype.hasOwnProperty.call(B,G)&&G!=="layout"&&G!=="paint"&&G!=="filter"&&G!=="metadata"&&G!=="minzoom"&&G!=="maxzoom"&&(G.indexOf("paint.")===0?me(B[G],U[G],_,D,G.slice(6),"setPaintProperty"):Z(B[G],U[G])||K(_,{command:"setLayerProperty",args:[D,G,U[G]]}))}else K(_,{command:"removeLayer",args:[D]}),ee=A[A.lastIndexOf(D)+1],K(_,{command:"addLayer",args:[U,ee]})}(d,t.layers,n)}catch(a){console.warn("Unable to compute style diff:",a),n=[{command:"setStyle",args:[t]}]}return n},I.c=Ve,I.c0=r=>r.type==="heatmap",I.c1=r=>r.type==="line",I.c2=r=>r.type==="fill",I.c3=r=>r.type==="fill-extrusion",I.c4=r=>r.type==="hillshade",I.c5=r=>r.type==="raster",I.c6=r=>r.type==="background",I.c7=r=>r.type==="custom",I.c8=Ti,I.c9=function(r,t,n){const a=Vt(t.x-n.x,t.y-n.y),l=Vt(r.x-n.x,r.y-n.y);var d,p;return fr(Math.atan2(a[0]*l[1]-a[1]*l[0],(d=a)[0]*(p=l)[0]+d[1]*p[1]))},I.cA=Qe,I.cB=id,I.cC=fd,I.cD=Gn,I.cE=An,I.ca=ei,I.cb=function(r,t,n){var a=t[0],l=t[1];return r[0]=n[0]*a+n[4]*l+n[12],r[1]=n[1]*a+n[5]*l+n[13],r},I.cc=function(r,t){const{x:n,y:a}=Bl.fromLngLat(t);return!(r<0||r>25||a<0||a>=1||n<0||n>=1)},I.cd=function(r,t){return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},I.ce=class extends Hs{},I.cf=vm,I.ch=function(r){return r.message===Wr},I.ci=Yt,I.cj=function(r,t){nt.REGISTERED_PROTOCOLS[r]=t},I.ck=function(r){delete nt.REGISTERED_PROTOCOLS[r]},I.cl=function(r,t){const n={};for(let l=0;l<r.length;l++){const d=t&&t[r[l].id]||el(r[l]);t&&(t[r[l].id]=d);let p=n[d];p||(p=n[d]=[]),p.push(r[l])}const a=[];for(const l in n)a.push(n[l]);return a},I.cm=qe,I.cn=jd,I.co=Nd,I.cp=gd,I.cq=function(r){r.bucket.createArrays(),r.bucket.tilePixelRatio=Mt/(512*r.bucket.overscaling),r.bucket.compareText={},r.bucket.iconsNeedLinear=!1;const t=r.bucket.layers[0],n=t.layout,a=t._unevaluatedLayout._values,l={layoutIconSize:a["icon-size"].possiblyEvaluate(new _i(r.bucket.zoom+1),r.canonical),layoutTextSize:a["text-size"].possiblyEvaluate(new _i(r.bucket.zoom+1),r.canonical),textMaxSize:a["text-size"].possiblyEvaluate(new _i(18))};if(r.bucket.textSizeData.kind==="composite"){const{minZoom:v,maxZoom:b}=r.bucket.textSizeData;l.compositeTextSizes=[a["text-size"].possiblyEvaluate(new _i(v),r.canonical),a["text-size"].possiblyEvaluate(new _i(b),r.canonical)]}if(r.bucket.iconSizeData.kind==="composite"){const{minZoom:v,maxZoom:b}=r.bucket.iconSizeData;l.compositeIconSizes=[a["icon-size"].possiblyEvaluate(new _i(v),r.canonical),a["icon-size"].possiblyEvaluate(new _i(b),r.canonical)]}const d=n.get("text-line-height")*Gi,p=n.get("text-rotation-alignment")!=="viewport"&&n.get("symbol-placement")!=="point",m=n.get("text-keep-upright"),_=n.get("text-size");for(const v of r.bucket.features){const b=n.get("text-font").evaluate(v,{},r.canonical).join(","),w=_.evaluate(v,{},r.canonical),C=l.layoutTextSize.evaluate(v,{},r.canonical),A=l.layoutIconSize.evaluate(v,{},r.canonical),k={horizontal:{},vertical:void 0},D=v.text;let B,U=[0,0];if(D){const E=D.toString(),F=n.get("text-letter-spacing").evaluate(v,{},r.canonical)*Gi,q=Cc(E)?F:0,pe=n.get("text-anchor").evaluate(v,{},r.canonical),Se=Qd(t,v,r.canonical);if(!Se){const Ie=n.get("text-radial-offset").evaluate(v,{},r.canonical);U=Ie?Jd(pe,[Ie*Gi,hu]):n.get("text-offset").evaluate(v,{},r.canonical).map(De=>De*Gi)}let ge=p?"center":n.get("text-justify").evaluate(v,{},r.canonical);const _e=n.get("symbol-placement")==="point"?n.get("text-max-width").evaluate(v,{},r.canonical)*Gi:1/0,ze=()=>{r.bucket.allowVerticalPlacement&&Zs(E)&&(k.vertical=Gc(D,r.glyphMap,r.glyphPositions,r.imagePositions,b,_e,d,pe,"left",q,U,I.ag.vertical,!0,C,w))};if(!p&&Se){const Ie=new Set;if(ge==="auto")for(let Te=0;Te<Se.values.length;Te+=2)Ie.add(uu(Se.values[Te]));else Ie.add(ge);let De=!1;for(const Te of Ie)if(!k.horizontal[Te])if(De)k.horizontal[Te]=k.horizontal[0];else{const Ye=Gc(D,r.glyphMap,r.glyphPositions,r.imagePositions,b,_e,d,"center",Te,q,U,I.ag.horizontal,!1,C,w);Ye&&(k.horizontal[Te]=Ye,De=Ye.positionedLines.length===1)}ze()}else{ge==="auto"&&(ge=uu(pe));const Ie=Gc(D,r.glyphMap,r.glyphPositions,r.imagePositions,b,_e,d,pe,ge,q,U,I.ag.horizontal,!1,C,w);Ie&&(k.horizontal[ge]=Ie),ze(),Zs(E)&&p&&m&&(k.vertical=Gc(D,r.glyphMap,r.glyphPositions,r.imagePositions,b,_e,d,pe,ge,q,U,I.ag.vertical,!1,C,w))}}let ee=!1;if(v.icon&&v.icon.name){const E=r.imageMap[v.icon.name];E&&(B=em(r.imagePositions[v.icon.name],n.get("icon-offset").evaluate(v,{},r.canonical),n.get("icon-anchor").evaluate(v,{},r.canonical)),ee=!!E.sdf,r.bucket.sdfIcons===void 0?r.bucket.sdfIcons=ee:r.bucket.sdfIcons!==ee&&xi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(E.pixelRatio!==r.bucket.pixelRatio||n.get("icon-rotate").constantOr(1)!==0)&&(r.bucket.iconsNeedLinear=!0))}const G=tp(k.horizontal)||k.vertical;r.bucket.iconsInText=!!G&&G.iconsInText,(G||B)&&_m(r.bucket,v,k,B,r.imageMap,l,C,A,U,ee,r.canonical,r.subdivisionGranularity)}r.showCollisionBoxes&&r.bucket.generateCollisionDebugBuffers()},I.cr=Wh,I.cs=Zh,I.ct=Hh,I.cu=kl,I.cv=Yh,I.cw=class{constructor(r){this._marks={start:[r.url,"start"].join("#"),end:[r.url,"end"].join("#"),measure:r.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let r=performance.getEntriesByName(this._marks.measure);return r.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),r=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),r}},I.cx=function(r,t,n,a,l){return c(this,void 0,void 0,function*(){if(Ze())try{return yield ir(r,t,n,a,l)}catch{}return function(d,p,m,_,v){const b=d.width,w=d.height;Hr&&Rr||(Hr=new OffscreenCanvas(b,w),Rr=Hr.getContext("2d",{willReadFrequently:!0})),Hr.width=b,Hr.height=w,Rr.drawImage(d,0,0,b,w);const C=Rr.getImageData(p,m,_,v);return Rr.clearRect(0,0,b,w),C.data}(r,t,n,a,l)})},I.cy=Od,I.cz=ke,I.d=ki,I.e=Ge,I.f=r=>c(void 0,void 0,void 0,function*(){if(r.byteLength===0)return createImageBitmap(new ImageData(1,1));const t=new Blob([new Uint8Array(r)],{type:"image/png"});try{return createImageBitmap(t)}catch(n){throw new Error(`Could not load image because of ${n.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),I.g=Oe,I.h=r=>new Promise((t,n)=>{const a=new Image;a.onload=()=>{t(a),URL.revokeObjectURL(a.src),a.onload=null,window.requestAnimationFrame(()=>{a.src=qr})},a.onerror=()=>n(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const l=new Blob([new Uint8Array(r)],{type:"image/png"});a.src=r.byteLength?URL.createObjectURL(l):qr}),I.i=Fi,I.j=(r,t)=>Ii(Ge(r,{type:"json"}),t),I.k=hi,I.l=mn,I.m=Ii,I.n=(r,t)=>Ii(Ge(r,{type:"arrayBuffer"}),t),I.o=function(r){return new Yh(r).readFields(Zf,[])},I.p=md,I.q=Pl,I.r=wr,I.s=pr,I.t=Ga,I.u=At,I.v=P,I.w=xi,I.x=Vs,I.y=ba,I.z=function([r,t,n]){return t+=90,t*=Math.PI/180,n*=Math.PI/180,{x:r*Math.cos(t)*Math.sin(n),y:r*Math.sin(t)*Math.sin(n),z:r*Math.cos(n)}}}),Ee("worker",["./shared"],function(I){class c{constructor(P){this.keyCache={},P&&this.replace(P)}replace(P){this._layerConfigs={},this._layers={},this.update(P,[])}update(P,L){for(const Z of P){this._layerConfigs[Z.id]=Z;const K=this._layers[Z.id]=I.bx(Z);K._featureFilter=I.a6(K.filter),this.keyCache[Z.id]&&delete this.keyCache[Z.id]}for(const Z of L)delete this.keyCache[Z],delete this._layerConfigs[Z],delete this._layers[Z];this.familiesBySource={};const O=I.cl(Object.values(this._layerConfigs),this.keyCache);for(const Z of O){const K=Z.map(le=>this._layers[le.id]),ne=K[0];if(ne.visibility==="none")continue;const ue=ne.source||"";let re=this.familiesBySource[ue];re||(re=this.familiesBySource[ue]={});const ye=ne.sourceLayer||"_geojsonTileLayer";let me=re[ye];me||(me=re[ye]=[]),me.push(K)}}}class ke{constructor(P){const L={},O=[];for(const ue in P){const re=P[ue],ye=L[ue]={};for(const me in re){const le=re[+me];if(!le||le.bitmap.width===0||le.bitmap.height===0)continue;const Me={x:0,y:0,w:le.bitmap.width+2,h:le.bitmap.height+2};O.push(Me),ye[me]={rect:Me,metrics:le.metrics}}}const{w:Z,h:K}=I.p(O),ne=new I.q({width:Z||1,height:K||1});for(const ue in P){const re=P[ue];for(const ye in re){const me=re[+ye];if(!me||me.bitmap.width===0||me.bitmap.height===0)continue;const le=L[ue][ye].rect;I.q.copy(me.bitmap,ne,{x:0,y:0},{x:le.x+1,y:le.y+1},me.bitmap)}}this.image=ne,this.positions=L}}I.cm("GlyphAtlas",ke);class He{constructor(P){this.tileID=new I.Y(P.tileID.overscaledZ,P.tileID.wrap,P.tileID.canonical.z,P.tileID.canonical.x,P.tileID.canonical.y),this.uid=P.uid,this.zoom=P.zoom,this.pixelRatio=P.pixelRatio,this.tileSize=P.tileSize,this.source=P.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=P.showCollisionBoxes,this.collectResourceTiming=!!P.collectResourceTiming,this.returnDependencies=!!P.returnDependencies,this.promoteId=P.promoteId,this.inFlightDependencies=[]}parse(P,L,O,Z,K){return I._(this,void 0,void 0,function*(){this.status="parsing",this.data=P,this.collisionBoxArray=new I.a4;const ne=new I.cn(Object.keys(P.layers).sort()),ue=new I.co(this.tileID,this.promoteId);ue.bucketLayerIDs=[];const re={},ye={featureIndex:ue,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:O,subdivisionGranularity:K},me=L.familiesBySource[this.source];for(const yt in me){const Et=P.layers[yt];if(!Et)continue;Et.version===1&&I.w(`Vector tile source "${this.source}" layer "${yt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ct=ne.encode(yt),Ln=[];for(let Bi=0;Bi<Et.length;Bi++){const Ni=Et.feature(Bi),pi=ue.getId(Ni,yt);Ln.push({feature:Ni,id:pi,index:Bi,sourceLayerIndex:ct})}for(const Bi of me[yt]){const Ni=Bi[0];Ni.source!==this.source&&I.w(`layer.source = ${Ni.source} does not equal this.source = ${this.source}`),Ni.minzoom&&this.zoom<Math.floor(Ni.minzoom)||Ni.maxzoom&&this.zoom>=Ni.maxzoom||Ni.visibility!=="none"&&(je(Bi,this.zoom,O),(re[Ni.id]=Ni.createBucket({index:ue.bucketLayerIDs.length,layers:Bi,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ct,sourceID:this.source})).populate(Ln,ye,this.tileID.canonical),ue.bucketLayerIDs.push(Bi.map(pi=>pi.id)))}}const le=I.bC(ye.glyphDependencies,yt=>Object.keys(yt).map(Number));this.inFlightDependencies.forEach(yt=>yt==null?void 0:yt.abort()),this.inFlightDependencies=[];let Me=Promise.resolve({});if(Object.keys(le).length){const yt=new AbortController;this.inFlightDependencies.push(yt),Me=Z.sendAsync({type:"GG",data:{stacks:le,source:this.source,tileID:this.tileID,type:"glyphs"}},yt)}const ce=Object.keys(ye.iconDependencies);let Fe=Promise.resolve({});if(ce.length){const yt=new AbortController;this.inFlightDependencies.push(yt),Fe=Z.sendAsync({type:"GI",data:{icons:ce,source:this.source,tileID:this.tileID,type:"icons"}},yt)}const Ke=Object.keys(ye.patternDependencies);let _t=Promise.resolve({});if(Ke.length){const yt=new AbortController;this.inFlightDependencies.push(yt),_t=Z.sendAsync({type:"GI",data:{icons:Ke,source:this.source,tileID:this.tileID,type:"patterns"}},yt)}const[ut,be,Je]=yield Promise.all([Me,Fe,_t]),We=new ke(ut),It=new I.cp(be,Je);for(const yt in re){const Et=re[yt];Et instanceof I.a5?(je(Et.layers,this.zoom,O),I.cq({bucket:Et,glyphMap:ut,glyphPositions:We.positions,imageMap:be,imagePositions:It.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:ye.subdivisionGranularity})):Et.hasPattern&&(Et instanceof I.cr||Et instanceof I.cs||Et instanceof I.ct)&&(je(Et.layers,this.zoom,O),Et.addFeatures(ye,this.tileID.canonical,It.patternPositions))}return this.status="done",{buckets:Object.values(re).filter(yt=>!yt.isEmpty()),featureIndex:ue,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:We.image,imageAtlas:It,glyphMap:this.returnDependencies?ut:null,iconMap:this.returnDependencies?be:null,glyphPositions:this.returnDependencies?We.positions:null}})}}function je(se,P,L){const O=new I.C(P);for(const Z of se)Z.recalculate(O,L)}class Qe{constructor(P,L,O){this.actor=P,this.layerIndex=L,this.availableImages=O,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(P,L){return I._(this,void 0,void 0,function*(){const O=yield I.n(P.request,L);try{return{vectorTile:new I.cu.VectorTile(new I.cv(O.data)),rawData:O.data,cacheControl:O.cacheControl,expires:O.expires}}catch(Z){const K=new Uint8Array(O.data);let ne=`Unable to parse the tile at ${P.request.url}, `;throw ne+=K[0]===31&&K[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${Z.message}`,new Error(ne)}})}loadTile(P){return I._(this,void 0,void 0,function*(){const L=P.uid,O=!!(P&&P.request&&P.request.collectResourceTiming)&&new I.cw(P.request),Z=new He(P);this.loading[L]=Z;const K=new AbortController;Z.abort=K;try{const ne=yield this.loadVectorTile(P,K);if(delete this.loading[L],!ne)return null;const ue=ne.rawData,re={};ne.expires&&(re.expires=ne.expires),ne.cacheControl&&(re.cacheControl=ne.cacheControl);const ye={};if(O){const le=O.finish();le&&(ye.resourceTiming=JSON.parse(JSON.stringify(le)))}Z.vectorTile=ne.vectorTile;const me=Z.parse(ne.vectorTile,this.layerIndex,this.availableImages,this.actor,P.subdivisionGranularity);this.loaded[L]=Z,this.fetching[L]={rawTileData:ue,cacheControl:re,resourceTiming:ye};try{const le=yield me;return I.e({rawTileData:ue.slice(0)},le,re,ye)}finally{delete this.fetching[L]}}catch(ne){throw delete this.loading[L],Z.status="done",this.loaded[L]=Z,ne}})}reloadTile(P){return I._(this,void 0,void 0,function*(){const L=P.uid;if(!this.loaded||!this.loaded[L])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const O=this.loaded[L];if(O.showCollisionBoxes=P.showCollisionBoxes,O.status==="parsing"){const Z=yield O.parse(O.vectorTile,this.layerIndex,this.availableImages,this.actor,P.subdivisionGranularity);let K;if(this.fetching[L]){const{rawTileData:ne,cacheControl:ue,resourceTiming:re}=this.fetching[L];delete this.fetching[L],K=I.e({rawTileData:ne.slice(0)},Z,ue,re)}else K=Z;return K}if(O.status==="done"&&O.vectorTile)return O.parse(O.vectorTile,this.layerIndex,this.availableImages,this.actor,P.subdivisionGranularity)})}abortTile(P){return I._(this,void 0,void 0,function*(){const L=this.loading,O=P.uid;L&&L[O]&&L[O].abort&&(L[O].abort.abort(),delete L[O])})}removeTile(P){return I._(this,void 0,void 0,function*(){this.loaded&&this.loaded[P.uid]&&delete this.loaded[P.uid]})}}class Pe{constructor(){this.loaded={}}loadTile(P){return I._(this,void 0,void 0,function*(){const{uid:L,encoding:O,rawImageData:Z,redFactor:K,greenFactor:ne,blueFactor:ue,baseShift:re}=P,ye=Z.width+2,me=Z.height+2,le=I.b(Z)?new I.R({width:ye,height:me},yield I.cx(Z,-1,-1,ye,me)):Z,Me=new I.cy(L,le,O,K,ne,ue,re);return this.loaded=this.loaded||{},this.loaded[L]=Me,Me})}removeTile(P){const L=this.loaded,O=P.uid;L&&L[O]&&delete L[O]}}var Y,Be,st=function(){if(Be)return Y;function se(L,O){if(L.length!==0){P(L[0],O);for(var Z=1;Z<L.length;Z++)P(L[Z],!O)}}function P(L,O){for(var Z=0,K=0,ne=0,ue=L.length,re=ue-1;ne<ue;re=ne++){var ye=(L[ne][0]-L[re][0])*(L[re][1]+L[ne][1]),me=Z+ye;K+=Math.abs(Z)>=Math.abs(ye)?Z-me+ye:ye-me+Z,Z=me}Z+K>=0!=!!O&&L.reverse()}return Be=1,Y=function L(O,Z){var K,ne=O&&O.type;if(ne==="FeatureCollection")for(K=0;K<O.features.length;K++)L(O.features[K],Z);else if(ne==="GeometryCollection")for(K=0;K<O.geometries.length;K++)L(O.geometries[K],Z);else if(ne==="Feature")L(O.geometry,Z);else if(ne==="Polygon")se(O.coordinates,Z);else if(ne==="MultiPolygon")for(K=0;K<O.coordinates.length;K++)se(O.coordinates[K],Z);return O}}(),et=I.cz(st);const $e=I.cu.VectorTileFeature.prototype.toGeoJSON;class pt{constructor(P){this._feature=P,this.extent=I.Z,this.type=P.type,this.properties=P.tags,"id"in P&&!isNaN(P.id)&&(this.id=parseInt(P.id,10))}loadGeometry(){if(this._feature.type===1){const P=[];for(const L of this._feature.geometry)P.push([new I.P(L[0],L[1])]);return P}{const P=[];for(const L of this._feature.geometry){const O=[];for(const Z of L)O.push(new I.P(Z[0],Z[1]));P.push(O)}return P}}toGeoJSON(P,L,O){return $e.call(this,P,L,O)}}class jt{constructor(P){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=I.Z,this.length=P.length,this._features=P}feature(P){return new pt(this._features[P])}}var Ze,wt,tt,Ue={exports:{}},xt=function(){if(tt)return Ue.exports;tt=1;var se=I.cC(),P=function(){if(wt)return Ze;wt=1;var me=I.cA(),le=I.cB().VectorTileFeature;function Me(Fe,Ke){this.options=Ke||{},this.features=Fe,this.length=Fe.length}function ce(Fe,Ke){this.id=typeof Fe.id=="number"?Fe.id:void 0,this.type=Fe.type,this.rawGeometry=Fe.type===1?[Fe.geometry]:Fe.geometry,this.properties=Fe.tags,this.extent=Ke||4096}return Ze=Me,Me.prototype.feature=function(Fe){return new ce(this.features[Fe],this.options.extent)},ce.prototype.loadGeometry=function(){var Fe=this.rawGeometry;this.geometry=[];for(var Ke=0;Ke<Fe.length;Ke++){for(var _t=Fe[Ke],ut=[],be=0;be<_t.length;be++)ut.push(new me(_t[be][0],_t[be][1]));this.geometry.push(ut)}return this.geometry},ce.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Fe=this.geometry,Ke=1/0,_t=-1/0,ut=1/0,be=-1/0,Je=0;Je<Fe.length;Je++)for(var We=Fe[Je],It=0;It<We.length;It++){var yt=We[It];Ke=Math.min(Ke,yt.x),_t=Math.max(_t,yt.x),ut=Math.min(ut,yt.y),be=Math.max(be,yt.y)}return[Ke,ut,_t,be]},ce.prototype.toGeoJSON=le.prototype.toGeoJSON,Ze}();function L(me){var le=new se;return function(Me,ce){for(var Fe in Me.layers)ce.writeMessage(3,O,Me.layers[Fe])}(me,le),le.finish()}function O(me,le){var Me;le.writeVarintField(15,me.version||1),le.writeStringField(1,me.name||""),le.writeVarintField(5,me.extent||4096);var ce={keys:[],values:[],keycache:{},valuecache:{}};for(Me=0;Me<me.length;Me++)ce.feature=me.feature(Me),le.writeMessage(2,Z,ce);var Fe=ce.keys;for(Me=0;Me<Fe.length;Me++)le.writeStringField(3,Fe[Me]);var Ke=ce.values;for(Me=0;Me<Ke.length;Me++)le.writeMessage(4,ye,Ke[Me])}function Z(me,le){var Me=me.feature;Me.id!==void 0&&le.writeVarintField(1,Me.id),le.writeMessage(2,K,me),le.writeVarintField(3,Me.type),le.writeMessage(4,re,Me)}function K(me,le){var Me=me.feature,ce=me.keys,Fe=me.values,Ke=me.keycache,_t=me.valuecache;for(var ut in Me.properties){var be=Me.properties[ut],Je=Ke[ut];if(be!==null){Je===void 0&&(ce.push(ut),Ke[ut]=Je=ce.length-1),le.writeVarint(Je);var We=typeof be;We!=="string"&&We!=="boolean"&&We!=="number"&&(be=JSON.stringify(be));var It=We+":"+be,yt=_t[It];yt===void 0&&(Fe.push(be),_t[It]=yt=Fe.length-1),le.writeVarint(yt)}}}function ne(me,le){return(le<<3)+(7&me)}function ue(me){return me<<1^me>>31}function re(me,le){for(var Me=me.loadGeometry(),ce=me.type,Fe=0,Ke=0,_t=Me.length,ut=0;ut<_t;ut++){var be=Me[ut],Je=1;ce===1&&(Je=be.length),le.writeVarint(ne(1,Je));for(var We=ce===3?be.length-1:be.length,It=0;It<We;It++){It===1&&ce!==1&&le.writeVarint(ne(2,We-1));var yt=be[It].x-Fe,Et=be[It].y-Ke;le.writeVarint(ue(yt)),le.writeVarint(ue(Et)),Fe+=yt,Ke+=Et}ce===3&&le.writeVarint(ne(7,1))}}function ye(me,le){var Me=typeof me;Me==="string"?le.writeStringField(1,me):Me==="boolean"?le.writeBooleanField(7,me):Me==="number"&&(me%1!=0?le.writeDoubleField(3,me):me<0?le.writeSVarintField(6,me):le.writeVarintField(5,me))}return Ue.exports=L,Ue.exports.fromVectorTileJs=L,Ue.exports.fromGeojsonVt=function(me,le){le=le||{};var Me={};for(var ce in me)Me[ce]=new P(me[ce].features,le),Me[ce].name=ce,Me[ce].version=le.version,Me[ce].extent=le.extent;return L({layers:Me})},Ue.exports.GeoJSONWrapper=P,Ue.exports}(),Dt=I.cz(xt);const Bt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:se=>se},Rt=Math.fround||(bt=new Float32Array(1),se=>(bt[0]=+se,bt[0]));var bt;const kt=3,gt=5,Vt=6;class Mt{constructor(P){this.options=Object.assign(Object.create(Bt),P),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(P){const{log:L,minZoom:O,maxZoom:Z}=this.options;L&&console.time("total time");const K=`prepare ${P.length} points`;L&&console.time(K),this.points=P;const ne=[];for(let re=0;re<P.length;re++){const ye=P[re];if(!ye.geometry)continue;const[me,le]=ye.geometry.coordinates,Me=Rt(Tt(me)),ce=Rt(Qt(le));ne.push(Me,ce,1/0,re,-1,1),this.options.reduce&&ne.push(0)}let ue=this.trees[Z+1]=this._createTree(ne);L&&console.timeEnd(K);for(let re=Z;re>=O;re--){const ye=+Date.now();ue=this.trees[re]=this._createTree(this._cluster(ue,re)),L&&console.log("z%d: %d clusters in %dms",re,ue.numItems,+Date.now()-ye)}return L&&console.timeEnd("total time"),this}getClusters(P,L){let O=((P[0]+180)%360+360)%360-180;const Z=Math.max(-90,Math.min(90,P[1]));let K=P[2]===180?180:((P[2]+180)%360+360)%360-180;const ne=Math.max(-90,Math.min(90,P[3]));if(P[2]-P[0]>=360)O=-180,K=180;else if(O>K){const le=this.getClusters([O,Z,180,ne],L),Me=this.getClusters([-180,Z,K,ne],L);return le.concat(Me)}const ue=this.trees[this._limitZoom(L)],re=ue.range(Tt(O),Qt(ne),Tt(K),Qt(Z)),ye=ue.data,me=[];for(const le of re){const Me=this.stride*le;me.push(ye[Me+gt]>1?ai(ye,Me,this.clusterProps):this.points[ye[Me+kt]])}return me}getChildren(P){const L=this._getOriginId(P),O=this._getOriginZoom(P),Z="No cluster with the specified id.",K=this.trees[O];if(!K)throw new Error(Z);const ne=K.data;if(L*this.stride>=ne.length)throw new Error(Z);const ue=this.options.radius/(this.options.extent*Math.pow(2,O-1)),re=K.within(ne[L*this.stride],ne[L*this.stride+1],ue),ye=[];for(const me of re){const le=me*this.stride;ne[le+4]===P&&ye.push(ne[le+gt]>1?ai(ne,le,this.clusterProps):this.points[ne[le+kt]])}if(ye.length===0)throw new Error(Z);return ye}getLeaves(P,L,O){const Z=[];return this._appendLeaves(Z,P,L=L||10,O=O||0,0),Z}getTile(P,L,O){const Z=this.trees[this._limitZoom(P)],K=Math.pow(2,P),{extent:ne,radius:ue}=this.options,re=ue/ne,ye=(O-re)/K,me=(O+1+re)/K,le={features:[]};return this._addTileFeatures(Z.range((L-re)/K,ye,(L+1+re)/K,me),Z.data,L,O,K,le),L===0&&this._addTileFeatures(Z.range(1-re/K,ye,1,me),Z.data,K,O,K,le),L===K-1&&this._addTileFeatures(Z.range(0,ye,re/K,me),Z.data,-1,O,K,le),le.features.length?le:null}getClusterExpansionZoom(P){let L=this._getOriginZoom(P)-1;for(;L<=this.options.maxZoom;){const O=this.getChildren(P);if(L++,O.length!==1)break;P=O[0].properties.cluster_id}return L}_appendLeaves(P,L,O,Z,K){const ne=this.getChildren(L);for(const ue of ne){const re=ue.properties;if(re&&re.cluster?K+re.point_count<=Z?K+=re.point_count:K=this._appendLeaves(P,re.cluster_id,O,Z,K):K<Z?K++:P.push(ue),P.length===O)break}return K}_createTree(P){const L=new I.aB(P.length/this.stride|0,this.options.nodeSize,Float32Array);for(let O=0;O<P.length;O+=this.stride)L.add(P[O],P[O+1]);return L.finish(),L.data=P,L}_addTileFeatures(P,L,O,Z,K,ne){for(const ue of P){const re=ue*this.stride,ye=L[re+gt]>1;let me,le,Me;if(ye)me=Li(L,re,this.clusterProps),le=L[re],Me=L[re+1];else{const Ke=this.points[L[re+kt]];me=Ke.properties;const[_t,ut]=Ke.geometry.coordinates;le=Tt(_t),Me=Qt(ut)}const ce={type:1,geometry:[[Math.round(this.options.extent*(le*K-O)),Math.round(this.options.extent*(Me*K-Z))]],tags:me};let Fe;Fe=ye||this.options.generateId?L[re+kt]:this.points[L[re+kt]].id,Fe!==void 0&&(ce.id=Fe),ne.features.push(ce)}}_limitZoom(P){return Math.max(this.options.minZoom,Math.min(Math.floor(+P),this.options.maxZoom+1))}_cluster(P,L){const{radius:O,extent:Z,reduce:K,minPoints:ne}=this.options,ue=O/(Z*Math.pow(2,L)),re=P.data,ye=[],me=this.stride;for(let le=0;le<re.length;le+=me){if(re[le+2]<=L)continue;re[le+2]=L;const Me=re[le],ce=re[le+1],Fe=P.within(re[le],re[le+1],ue),Ke=re[le+gt];let _t=Ke;for(const ut of Fe){const be=ut*me;re[be+2]>L&&(_t+=re[be+gt])}if(_t>Ke&&_t>=ne){let ut,be=Me*Ke,Je=ce*Ke,We=-1;const It=((le/me|0)<<5)+(L+1)+this.points.length;for(const yt of Fe){const Et=yt*me;if(re[Et+2]<=L)continue;re[Et+2]=L;const ct=re[Et+gt];be+=re[Et]*ct,Je+=re[Et+1]*ct,re[Et+4]=It,K&&(ut||(ut=this._map(re,le,!0),We=this.clusterProps.length,this.clusterProps.push(ut)),K(ut,this._map(re,Et)))}re[le+4]=It,ye.push(be/_t,Je/_t,1/0,It,-1,_t),K&&ye.push(We)}else{for(let ut=0;ut<me;ut++)ye.push(re[le+ut]);if(_t>1)for(const ut of Fe){const be=ut*me;if(!(re[be+2]<=L)){re[be+2]=L;for(let Je=0;Je<me;Je++)ye.push(re[be+Je])}}}}return ye}_getOriginId(P){return P-this.points.length>>5}_getOriginZoom(P){return(P-this.points.length)%32}_map(P,L,O){if(P[L+gt]>1){const ne=this.clusterProps[P[L+Vt]];return O?Object.assign({},ne):ne}const Z=this.points[P[L+kt]].properties,K=this.options.map(Z);return O&&K===Z?Object.assign({},K):K}}function ai(se,P,L){return{type:"Feature",id:se[P+kt],properties:Li(se,P,L),geometry:{type:"Point",coordinates:[(O=se[P],360*(O-.5)),Ti(se[P+1])]}};var O}function Li(se,P,L){const O=se[P+gt],Z=O>=1e4?`${Math.round(O/1e3)}k`:O>=1e3?Math.round(O/100)/10+"k":O,K=se[P+Vt],ne=K===-1?{}:Object.assign({},L[K]);return Object.assign(ne,{cluster:!0,cluster_id:se[P+kt],point_count:O,point_count_abbreviated:Z})}function Tt(se){return se/360+.5}function Qt(se){const P=Math.sin(se*Math.PI/180),L=.5-.25*Math.log((1+P)/(1-P))/Math.PI;return L<0?0:L>1?1:L}function Ti(se){const P=(180-360*se)*Math.PI/180;return 360*Math.atan(Math.exp(P))/Math.PI-90}function ei(se,P,L,O){let Z=O;const K=P+(L-P>>1);let ne,ue=L-P;const re=se[P],ye=se[P+1],me=se[L],le=se[L+1];for(let Me=P+3;Me<L;Me+=3){const ce=Kt(se[Me],se[Me+1],re,ye,me,le);if(ce>Z)ne=Me,Z=ce;else if(ce===Z){const Fe=Math.abs(Me-K);Fe<ue&&(ne=Me,ue=Fe)}}Z>O&&(ne-P>3&&ei(se,P,ne,O),se[ne+2]=Z,L-ne>3&&ei(se,ne,L,O))}function Kt(se,P,L,O,Z,K){let ne=Z-L,ue=K-O;if(ne!==0||ue!==0){const re=((se-L)*ne+(P-O)*ue)/(ne*ne+ue*ue);re>1?(L=Z,O=K):re>0&&(L+=ne*re,O+=ue*re)}return ne=se-L,ue=P-O,ne*ne+ue*ue}function Wt(se,P,L,O){const Z={id:se??null,type:P,geometry:L,tags:O,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(P==="Point"||P==="MultiPoint"||P==="LineString")Ge(Z,L);else if(P==="Polygon")Ge(Z,L[0]);else if(P==="MultiLineString")for(const K of L)Ge(Z,K);else if(P==="MultiPolygon")for(const K of L)Ge(Z,K[0]);return Z}function Ge(se,P){for(let L=0;L<P.length;L+=3)se.minX=Math.min(se.minX,P[L]),se.minY=Math.min(se.minY,P[L+1]),se.maxX=Math.max(se.maxX,P[L]),se.maxY=Math.max(se.maxY,P[L+1])}function lt(se,P,L,O){if(!P.geometry)return;const Z=P.geometry.coordinates;if(Z&&Z.length===0)return;const K=P.geometry.type,ne=Math.pow(L.tolerance/((1<<L.maxZoom)*L.extent),2);let ue=[],re=P.id;if(L.promoteId?re=P.properties[L.promoteId]:L.generateId&&(re=O||0),K==="Point")St(Z,ue);else if(K==="MultiPoint")for(const ye of Z)St(ye,ue);else if(K==="LineString")Zt(Z,ue,ne,!1);else if(K==="MultiLineString"){if(L.lineMetrics){for(const ye of Z)ue=[],Zt(ye,ue,ne,!1),se.push(Wt(re,"LineString",ue,P.properties));return}ti(Z,ue,ne,!1)}else if(K==="Polygon")ti(Z,ue,ne,!0);else{if(K!=="MultiPolygon"){if(K==="GeometryCollection"){for(const ye of P.geometry.geometries)lt(se,{id:re,geometry:ye,properties:P.properties},L,O);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const ye of Z){const me=[];ti(ye,me,ne,!0),ue.push(me)}}se.push(Wt(re,K,ue,P.properties))}function St(se,P){P.push(_r(se[0]),xi(se[1]),0)}function Zt(se,P,L,O){let Z,K,ne=0;for(let re=0;re<se.length;re++){const ye=_r(se[re][0]),me=xi(se[re][1]);P.push(ye,me,0),re>0&&(ne+=O?(Z*me-ye*K)/2:Math.sqrt(Math.pow(ye-Z,2)+Math.pow(me-K,2))),Z=ye,K=me}const ue=P.length-3;P[2]=1,ei(P,0,ue,L),P[ue+2]=1,P.size=Math.abs(ne),P.start=0,P.end=P.size}function ti(se,P,L,O){for(let Z=0;Z<se.length;Z++){const K=[];Zt(se[Z],K,L,O),P.push(K)}}function _r(se){return se/360+.5}function xi(se){const P=Math.sin(se*Math.PI/180),L=.5-.25*Math.log((1+P)/(1-P))/Math.PI;return L<0?0:L>1?1:L}function li(se,P,L,O,Z,K,ne,ue){if(O/=P,K>=(L/=P)&&ne<O)return se;if(ne<L||K>=O)return null;const re=[];for(const ye of se){const me=ye.geometry;let le=ye.type;const Me=Z===0?ye.minX:ye.minY,ce=Z===0?ye.maxX:ye.maxY;if(Me>=L&&ce<O){re.push(ye);continue}if(ce<L||Me>=O)continue;let Fe=[];if(le==="Point"||le==="MultiPoint")Fi(me,Fe,L,O,Z);else if(le==="LineString")ci(me,Fe,L,O,Z,!1,ue.lineMetrics);else if(le==="MultiLineString")qr(me,Fe,L,O,Z,!1);else if(le==="Polygon")qr(me,Fe,L,O,Z,!0);else if(le==="MultiPolygon")for(const Ke of me){const _t=[];qr(Ke,_t,L,O,Z,!0),_t.length&&Fe.push(_t)}if(Fe.length){if(ue.lineMetrics&&le==="LineString"){for(const Ke of Fe)re.push(Wt(ye.id,le,Ke,ye.tags));continue}le!=="LineString"&&le!=="MultiLineString"||(Fe.length===1?(le="LineString",Fe=Fe[0]):le="MultiLineString"),le!=="Point"&&le!=="MultiPoint"||(le=Fe.length===3?"Point":"MultiPoint"),re.push(Wt(ye.id,le,Fe,ye.tags))}}return re.length?re:null}function Fi(se,P,L,O,Z){for(let K=0;K<se.length;K+=3){const ne=se[K+Z];ne>=L&&ne<=O&&ir(P,se[K],se[K+1],se[K+2])}}function ci(se,P,L,O,Z,K,ne){let ue=Mr(se);const re=Z===0?Hr:Rr;let ye,me,le=se.start;for(let _t=0;_t<se.length-3;_t+=3){const ut=se[_t],be=se[_t+1],Je=se[_t+2],We=se[_t+3],It=se[_t+4],yt=Z===0?ut:be,Et=Z===0?We:It;let ct=!1;ne&&(ye=Math.sqrt(Math.pow(ut-We,2)+Math.pow(be-It,2))),yt<L?Et>L&&(me=re(ue,ut,be,We,It,L),ne&&(ue.start=le+ye*me)):yt>O?Et<O&&(me=re(ue,ut,be,We,It,O),ne&&(ue.start=le+ye*me)):ir(ue,ut,be,Je),Et<L&&yt>=L&&(me=re(ue,ut,be,We,It,L),ct=!0),Et>O&&yt<=O&&(me=re(ue,ut,be,We,It,O),ct=!0),!K&&ct&&(ne&&(ue.end=le+ye*me),P.push(ue),ue=Mr(se)),ne&&(le+=ye)}let Me=se.length-3;const ce=se[Me],Fe=se[Me+1],Ke=Z===0?ce:Fe;Ke>=L&&Ke<=O&&ir(ue,ce,Fe,se[Me+2]),Me=ue.length-3,K&&Me>=3&&(ue[Me]!==ue[0]||ue[Me+1]!==ue[1])&&ir(ue,ue[0],ue[1],ue[2]),ue.length&&P.push(ue)}function Mr(se){const P=[];return P.size=se.size,P.start=se.start,P.end=se.end,P}function qr(se,P,L,O,Z,K){for(const ne of se)ci(ne,P,L,O,Z,K,!1)}function ir(se,P,L,O){se.push(P,L,O)}function Hr(se,P,L,O,Z,K){const ne=(K-P)/(O-P);return ir(se,K,L+(Z-L)*ne,1),ne}function Rr(se,P,L,O,Z,K){const ne=(K-L)/(Z-L);return ir(se,P+(O-P)*ne,K,1),ne}function pr(se,P){const L=[];for(let O=0;O<se.length;O++){const Z=se[O],K=Z.type;let ne;if(K==="Point"||K==="MultiPoint"||K==="LineString")ne=fr(Z.geometry,P);else if(K==="MultiLineString"||K==="Polygon"){ne=[];for(const ue of Z.geometry)ne.push(fr(ue,P))}else if(K==="MultiPolygon"){ne=[];for(const ue of Z.geometry){const re=[];for(const ye of ue)re.push(fr(ye,P));ne.push(re)}}L.push(Wt(Z.id,K,ne,Z.tags))}return L}function fr(se,P){const L=[];L.size=se.size,se.start!==void 0&&(L.start=se.start,L.end=se.end);for(let O=0;O<se.length;O+=3)L.push(se[O]+P,se[O+1],se[O+2]);return L}function Wr(se,P){if(se.transformed)return se;const L=1<<se.z,O=se.x,Z=se.y;for(const K of se.features){const ne=K.geometry,ue=K.type;if(K.geometry=[],ue===1)for(let re=0;re<ne.length;re+=2)K.geometry.push(Ve(ne[re],ne[re+1],P,L,O,Z));else for(let re=0;re<ne.length;re++){const ye=[];for(let me=0;me<ne[re].length;me+=2)ye.push(Ve(ne[re][me],ne[re][me+1],P,L,O,Z));K.geometry.push(ye)}}return se.transformed=!0,se}function Ve(se,P,L,O,Z,K){return[Math.round(L*(se*O-Z)),Math.round(L*(P*O-K))]}function nt(se,P,L,O,Z){const K=P===Z.maxZoom?0:Z.tolerance/((1<<P)*Z.extent),ne={features:[],numPoints:0,numSimplified:0,numFeatures:se.length,source:null,x:L,y:O,z:P,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ue of se)Oe(ne,ue,K,Z);return ne}function Oe(se,P,L,O){const Z=P.geometry,K=P.type,ne=[];if(se.minX=Math.min(se.minX,P.minX),se.minY=Math.min(se.minY,P.minY),se.maxX=Math.max(se.maxX,P.maxX),se.maxY=Math.max(se.maxY,P.maxY),K==="Point"||K==="MultiPoint")for(let ue=0;ue<Z.length;ue+=3)ne.push(Z[ue],Z[ue+1]),se.numPoints++,se.numSimplified++;else if(K==="LineString")ft(ne,Z,se,L,!1,!1);else if(K==="MultiLineString"||K==="Polygon")for(let ue=0;ue<Z.length;ue++)ft(ne,Z[ue],se,L,K==="Polygon",ue===0);else if(K==="MultiPolygon")for(let ue=0;ue<Z.length;ue++){const re=Z[ue];for(let ye=0;ye<re.length;ye++)ft(ne,re[ye],se,L,!0,ye===0)}if(ne.length){let ue=P.tags||null;if(K==="LineString"&&O.lineMetrics){ue={};for(const ye in P.tags)ue[ye]=P.tags[ye];ue.mapbox_clip_start=Z.start/Z.size,ue.mapbox_clip_end=Z.end/Z.size}const re={geometry:ne,type:K==="Polygon"||K==="MultiPolygon"?3:K==="LineString"||K==="MultiLineString"?2:1,tags:ue};P.id!==null&&(re.id=P.id),se.features.push(re)}}function ft(se,P,L,O,Z,K){const ne=O*O;if(O>0&&P.size<(Z?ne:O))return void(L.numPoints+=P.length/3);const ue=[];for(let re=0;re<P.length;re+=3)(O===0||P[re+2]>ne)&&(L.numSimplified++,ue.push(P[re],P[re+1])),L.numPoints++;Z&&function(re,ye){let me=0;for(let le=0,Me=re.length,ce=Me-2;le<Me;ce=le,le+=2)me+=(re[le]-re[ce])*(re[le+1]+re[ce+1]);if(me>0===ye)for(let le=0,Me=re.length;le<Me/2;le+=2){const ce=re[le],Fe=re[le+1];re[le]=re[Me-2-le],re[le+1]=re[Me-1-le],re[Me-2-le]=ce,re[Me-1-le]=Fe}}(ue,K),se.push(ue)}const Yt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class zt{constructor(P,L){const O=(L=this.options=function(K,ne){for(const ue in ne)K[ue]=ne[ue];return K}(Object.create(Yt),L)).debug;if(O&&console.time("preprocess data"),L.maxZoom<0||L.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(L.promoteId&&L.generateId)throw new Error("promoteId and generateId cannot be used together.");let Z=function(K,ne){const ue=[];if(K.type==="FeatureCollection")for(let re=0;re<K.features.length;re++)lt(ue,K.features[re],ne,re);else lt(ue,K.type==="Feature"?K:{geometry:K},ne);return ue}(P,L);this.tiles={},this.tileCoords=[],O&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",L.indexMaxZoom,L.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Z=function(K,ne){const ue=ne.buffer/ne.extent;let re=K;const ye=li(K,1,-1-ue,ue,0,-1,2,ne),me=li(K,1,1-ue,2+ue,0,-1,2,ne);return(ye||me)&&(re=li(K,1,-ue,1+ue,0,-1,2,ne)||[],ye&&(re=pr(ye,1).concat(re)),me&&(re=re.concat(pr(me,-1)))),re}(Z,L),Z.length&&this.splitTile(Z,0,0,0),O&&(Z.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(P,L,O,Z,K,ne,ue){const re=[P,L,O,Z],ye=this.options,me=ye.debug;for(;re.length;){Z=re.pop(),O=re.pop(),L=re.pop(),P=re.pop();const le=1<<L,Me=Ii(L,O,Z);let ce=this.tiles[Me];if(!ce&&(me>1&&console.time("creation"),ce=this.tiles[Me]=nt(P,L,O,Z,ye),this.tileCoords.push({z:L,x:O,y:Z}),me)){me>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",L,O,Z,ce.numFeatures,ce.numPoints,ce.numSimplified),console.timeEnd("creation"));const ct=`z${L}`;this.stats[ct]=(this.stats[ct]||0)+1,this.total++}if(ce.source=P,K==null){if(L===ye.indexMaxZoom||ce.numPoints<=ye.indexMaxPoints)continue}else{if(L===ye.maxZoom||L===K)continue;if(K!=null){const ct=K-L;if(O!==ne>>ct||Z!==ue>>ct)continue}}if(ce.source=null,P.length===0)continue;me>1&&console.time("clipping");const Fe=.5*ye.buffer/ye.extent,Ke=.5-Fe,_t=.5+Fe,ut=1+Fe;let be=null,Je=null,We=null,It=null,yt=li(P,le,O-Fe,O+_t,0,ce.minX,ce.maxX,ye),Et=li(P,le,O+Ke,O+ut,0,ce.minX,ce.maxX,ye);P=null,yt&&(be=li(yt,le,Z-Fe,Z+_t,1,ce.minY,ce.maxY,ye),Je=li(yt,le,Z+Ke,Z+ut,1,ce.minY,ce.maxY,ye),yt=null),Et&&(We=li(Et,le,Z-Fe,Z+_t,1,ce.minY,ce.maxY,ye),It=li(Et,le,Z+Ke,Z+ut,1,ce.minY,ce.maxY,ye),Et=null),me>1&&console.timeEnd("clipping"),re.push(be||[],L+1,2*O,2*Z),re.push(Je||[],L+1,2*O,2*Z+1),re.push(We||[],L+1,2*O+1,2*Z),re.push(It||[],L+1,2*O+1,2*Z+1)}}getTile(P,L,O){P=+P,L=+L,O=+O;const Z=this.options,{extent:K,debug:ne}=Z;if(P<0||P>24)return null;const ue=1<<P,re=Ii(P,L=L+ue&ue-1,O);if(this.tiles[re])return Wr(this.tiles[re],K);ne>1&&console.log("drilling down to z%d-%d-%d",P,L,O);let ye,me=P,le=L,Me=O;for(;!ye&&me>0;)me--,le>>=1,Me>>=1,ye=this.tiles[Ii(me,le,Me)];return ye&&ye.source?(ne>1&&(console.log("found parent tile z%d-%d-%d",me,le,Me),console.time("drilling down")),this.splitTile(ye.source,me,le,Me,P,L,O),ne>1&&console.timeEnd("drilling down"),this.tiles[re]?Wr(this.tiles[re],K):null):null}}function Ii(se,P,L){return 32*((1<<se)*L+P)+se}function ki(se,P){return P?se.properties[P]:se.id}function Sr(se,P){if(se==null)return!0;if(se.type==="Feature")return ki(se,P)!=null;if(se.type==="FeatureCollection"){const L=new Set;for(const O of se.features){const Z=ki(O,P);if(Z==null||L.has(Z))return!1;L.add(Z)}return!0}return!1}function Lr(se,P){const L=new Map;if(se!=null)if(se.type==="Feature")L.set(ki(se,P),se);else for(const O of se.features)L.set(ki(O,P),O);return L}class mn extends Qe{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(P,L){return I._(this,void 0,void 0,function*(){const O=P.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const Z=this._geoJSONIndex.getTile(O.z,O.x,O.y);if(!Z)return null;const K=new jt(Z.features);let ne=Dt(K);return ne.byteOffset===0&&ne.byteLength===ne.buffer.byteLength||(ne=new Uint8Array(ne)),{vectorTile:K,rawData:ne.buffer}})}loadData(P){return I._(this,void 0,void 0,function*(){var L;(L=this._pendingRequest)===null||L===void 0||L.abort();const O=!!(P&&P.request&&P.request.collectResourceTiming)&&new I.cw(P.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(P,this._pendingRequest),this._geoJSONIndex=P.cluster?new Mt(function({superclusterOptions:ne,clusterProperties:ue}){if(!ue||!ne)return ne;const re={},ye={},me={accumulated:null,zoom:0},le={properties:null},Me=Object.keys(ue);for(const ce of Me){const[Fe,Ke]=ue[ce],_t=I.cD(Ke),ut=I.cD(typeof Fe=="string"?[Fe,["accumulated"],["get",ce]]:Fe);re[ce]=_t.value,ye[ce]=ut.value}return ne.map=ce=>{le.properties=ce;const Fe={};for(const Ke of Me)Fe[Ke]=re[Ke].evaluate(me,le);return Fe},ne.reduce=(ce,Fe)=>{le.properties=Fe;for(const Ke of Me)me.accumulated=ce[Ke],ce[Ke]=ye[Ke].evaluate(me,le)},ne}(P)).load((yield this._pendingData).features):(Z=yield this._pendingData,new zt(Z,P.geojsonVtOptions)),this.loaded={};const K={};if(O){const ne=O.finish();ne&&(K.resourceTiming={},K.resourceTiming[P.source]=JSON.parse(JSON.stringify(ne)))}return K}catch(K){if(delete this._pendingRequest,I.ch(K))return{abandoned:!0};throw K}var Z})}getData(){return I._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(P){const L=this.loaded;return L&&L[P.uid]?super.reloadTile(P):this.loadTile(P)}loadAndProcessGeoJSON(P,L){return I._(this,void 0,void 0,function*(){let O=yield this.loadGeoJSON(P,L);if(delete this._pendingRequest,typeof O!="object")throw new Error(`Input data given to '${P.source}' is not a valid GeoJSON object.`);if(et(O,!0),P.filter){const Z=I.cD(P.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Z.result==="error")throw new Error(Z.value.map(ne=>`${ne.key}: ${ne.message}`).join(", "));O={type:"FeatureCollection",features:O.features.filter(ne=>Z.value.evaluate({zoom:0},ne))}}return O})}loadGeoJSON(P,L){return I._(this,void 0,void 0,function*(){const{promoteId:O}=P;if(P.request){const Z=yield I.j(P.request,L);return this._dataUpdateable=Sr(Z.data,O)?Lr(Z.data,O):void 0,Z.data}if(typeof P.data=="string")try{const Z=JSON.parse(P.data);return this._dataUpdateable=Sr(Z,O)?Lr(Z,O):void 0,Z}catch{throw new Error(`Input data given to '${P.source}' is not a valid GeoJSON object.`)}if(!P.dataDiff)throw new Error(`Input data given to '${P.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${P.source}`);return function(Z,K,ne){var ue,re,ye,me;if(K.removeAll&&Z.clear(),K.remove)for(const le of K.remove)Z.delete(le);if(K.add)for(const le of K.add){const Me=ki(le,ne);Me!=null&&Z.set(Me,le)}if(K.update)for(const le of K.update){let Me=Z.get(le.id);if(Me==null)continue;const ce=!le.removeAllProperties&&(((ue=le.removeProperties)===null||ue===void 0?void 0:ue.length)>0||((re=le.addOrUpdateProperties)===null||re===void 0?void 0:re.length)>0);if((le.newGeometry||le.removeAllProperties||ce)&&(Me=Object.assign({},Me),Z.set(le.id,Me),ce&&(Me.properties=Object.assign({},Me.properties))),le.newGeometry&&(Me.geometry=le.newGeometry),le.removeAllProperties)Me.properties={};else if(((ye=le.removeProperties)===null||ye===void 0?void 0:ye.length)>0)for(const Fe of le.removeProperties)Object.prototype.hasOwnProperty.call(Me.properties,Fe)&&delete Me.properties[Fe];if(((me=le.addOrUpdateProperties)===null||me===void 0?void 0:me.length)>0)for(const{key:Fe,value:Ke}of le.addOrUpdateProperties)Me.properties[Fe]=Ke}}(this._dataUpdateable,P.dataDiff,O),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(P){return I._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(P){return this._geoJSONIndex.getClusterExpansionZoom(P.clusterId)}getClusterChildren(P){return this._geoJSONIndex.getChildren(P.clusterId)}getClusterLeaves(P){return this._geoJSONIndex.getLeaves(P.clusterId,P.limit,P.offset)}}class hi{constructor(P){this.self=P,this.actor=new I.H(P),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(L,O)=>{if(this.externalWorkerSourceTypes[L])throw new Error(`Worker source with name "${L}" already registered.`);this.externalWorkerSourceTypes[L]=O},this.self.addProtocol=I.cj,this.self.removeProtocol=I.ck,this.self.registerRTLTextPlugin=L=>{I.cE.setMethods(L)},this.actor.registerMessageHandler("LDT",(L,O)=>this._getDEMWorkerSource(L,O.source).loadTile(O)),this.actor.registerMessageHandler("RDT",(L,O)=>I._(this,void 0,void 0,function*(){this._getDEMWorkerSource(L,O.source).removeTile(O)})),this.actor.registerMessageHandler("GCEZ",(L,O)=>I._(this,void 0,void 0,function*(){return this._getWorkerSource(L,O.type,O.source).getClusterExpansionZoom(O)})),this.actor.registerMessageHandler("GCC",(L,O)=>I._(this,void 0,void 0,function*(){return this._getWorkerSource(L,O.type,O.source).getClusterChildren(O)})),this.actor.registerMessageHandler("GCL",(L,O)=>I._(this,void 0,void 0,function*(){return this._getWorkerSource(L,O.type,O.source).getClusterLeaves(O)})),this.actor.registerMessageHandler("LD",(L,O)=>this._getWorkerSource(L,O.type,O.source).loadData(O)),this.actor.registerMessageHandler("GD",(L,O)=>this._getWorkerSource(L,O.type,O.source).getData()),this.actor.registerMessageHandler("LT",(L,O)=>this._getWorkerSource(L,O.type,O.source).loadTile(O)),this.actor.registerMessageHandler("RT",(L,O)=>this._getWorkerSource(L,O.type,O.source).reloadTile(O)),this.actor.registerMessageHandler("AT",(L,O)=>this._getWorkerSource(L,O.type,O.source).abortTile(O)),this.actor.registerMessageHandler("RMT",(L,O)=>this._getWorkerSource(L,O.type,O.source).removeTile(O)),this.actor.registerMessageHandler("RS",(L,O)=>I._(this,void 0,void 0,function*(){if(!this.workerSources[L]||!this.workerSources[L][O.type]||!this.workerSources[L][O.type][O.source])return;const Z=this.workerSources[L][O.type][O.source];delete this.workerSources[L][O.type][O.source],Z.removeSource!==void 0&&Z.removeSource(O)})),this.actor.registerMessageHandler("RM",L=>I._(this,void 0,void 0,function*(){delete this.layerIndexes[L],delete this.availableImages[L],delete this.workerSources[L],delete this.demWorkerSources[L]})),this.actor.registerMessageHandler("SR",(L,O)=>I._(this,void 0,void 0,function*(){this.referrer=O})),this.actor.registerMessageHandler("SRPS",(L,O)=>this._syncRTLPluginState(L,O)),this.actor.registerMessageHandler("IS",(L,O)=>I._(this,void 0,void 0,function*(){this.self.importScripts(O)})),this.actor.registerMessageHandler("SI",(L,O)=>this._setImages(L,O)),this.actor.registerMessageHandler("UL",(L,O)=>I._(this,void 0,void 0,function*(){this._getLayerIndex(L).update(O.layers,O.removedIds)})),this.actor.registerMessageHandler("SL",(L,O)=>I._(this,void 0,void 0,function*(){this._getLayerIndex(L).replace(O)}))}_setImages(P,L){return I._(this,void 0,void 0,function*(){this.availableImages[P]=L;for(const O in this.workerSources[P]){const Z=this.workerSources[P][O];for(const K in Z)Z[K].availableImages=L}})}_syncRTLPluginState(P,L){return I._(this,void 0,void 0,function*(){return yield I.cE.syncState(L,this.self.importScripts)})}_getAvailableImages(P){let L=this.availableImages[P];return L||(L=[]),L}_getLayerIndex(P){let L=this.layerIndexes[P];return L||(L=this.layerIndexes[P]=new c),L}_getWorkerSource(P,L,O){if(this.workerSources[P]||(this.workerSources[P]={}),this.workerSources[P][L]||(this.workerSources[P][L]={}),!this.workerSources[P][L][O]){const Z={sendAsync:(K,ne)=>(K.targetMapId=P,this.actor.sendAsync(K,ne))};switch(L){case"vector":this.workerSources[P][L][O]=new Qe(Z,this._getLayerIndex(P),this._getAvailableImages(P));break;case"geojson":this.workerSources[P][L][O]=new mn(Z,this._getLayerIndex(P),this._getAvailableImages(P));break;default:this.workerSources[P][L][O]=new this.externalWorkerSourceTypes[L](Z,this._getLayerIndex(P),this._getAvailableImages(P))}}return this.workerSources[P][L][O]}_getDEMWorkerSource(P,L){return this.demWorkerSources[P]||(this.demWorkerSources[P]={}),this.demWorkerSources[P][L]||(this.demWorkerSources[P][L]=new Pe),this.demWorkerSources[P][L]}}return I.i(self)&&(self.worker=new hi(self)),hi}),Ee("index",["exports","./shared"],function(I,c){var ke="5.2.0";function He(){var h=new c.A(4);return c.A!=Float32Array&&(h[1]=0,h[2]=0),h[0]=1,h[3]=1,h}let je,Qe;const Pe={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(h,e,i){const s=requestAnimationFrame(u=>{o(),e(u)}),{unsubscribe:o}=c.s(h.signal,"abort",()=>{o(),cancelAnimationFrame(s),i(c.c())},!1)},frameAsync(h){return new Promise((e,i)=>{this.frame(h,e,i)})},getImageData(h,e=0){return this.getImageCanvasContext(h).getImageData(-e,-e,h.width+2*e,h.height+2*e)},getImageCanvasContext(h){const e=window.document.createElement("canvas"),i=e.getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("failed to create canvas 2d context");return e.width=h.width,e.height=h.height,i.drawImage(h,0,0,h.width,h.height),i},resolveURL:h=>(je||(je=document.createElement("a")),je.href=h,je.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(Qe==null&&(Qe=matchMedia("(prefers-reduced-motion: reduce)")),Qe.matches)}};class Y{static testProp(e){if(!Y.docStyle)return e[0];for(let i=0;i<e.length;i++)if(e[i]in Y.docStyle)return e[i];return e[0]}static create(e,i,s){const o=window.document.createElement(e);return i!==void 0&&(o.className=i),s&&s.appendChild(o),o}static createNS(e,i){return window.document.createElementNS(e,i)}static disableDrag(){Y.docStyle&&Y.selectProp&&(Y.userSelect=Y.docStyle[Y.selectProp],Y.docStyle[Y.selectProp]="none")}static enableDrag(){Y.docStyle&&Y.selectProp&&(Y.docStyle[Y.selectProp]=Y.userSelect)}static setTransform(e,i){e.style[Y.transformProp]=i}static addEventListener(e,i,s,o={}){e.addEventListener(i,s,"passive"in o?o:o.capture)}static removeEventListener(e,i,s,o={}){e.removeEventListener(i,s,"passive"in o?o:o.capture)}static suppressClickInternal(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",Y.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",Y.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",Y.suppressClickInternal,!0)},0)}static getScale(e){const i=e.getBoundingClientRect();return{x:i.width/e.offsetWidth||1,y:i.height/e.offsetHeight||1,boundingClientRect:i}}static getPoint(e,i,s){const o=i.boundingClientRect;return new c.P((s.clientX-o.left)/i.x-e.clientLeft,(s.clientY-o.top)/i.y-e.clientTop)}static mousePos(e,i){const s=Y.getScale(e);return Y.getPoint(e,s,i)}static touchPos(e,i){const s=[],o=Y.getScale(e);for(let u=0;u<i.length;u++)s.push(Y.getPoint(e,o,i[u]));return s}static mouseButton(e){return e.button}static remove(e){e.parentNode&&e.parentNode.removeChild(e)}static sanitize(e){const i=new DOMParser().parseFromString(e,"text/html").body||document.createElement("body"),s=i.querySelectorAll("script");for(const o of s)o.remove();return Y.clean(i),i.innerHTML}static isPossiblyDangerous(e,i){const s=i.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(e)||!s.includes("javascript:")&&!s.includes("data:"))||!!e.startsWith("on")||void 0}static clean(e){const i=e.children;for(const s of i)Y.removeAttributes(s),Y.clean(s)}static removeAttributes(e){for(const{name:i,value:s}of e.attributes)Y.isPossiblyDangerous(i,s)&&e.removeAttribute(i)}}Y.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,Y.selectProp=Y.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),Y.transformProp=Y.testProp(["transform","WebkitTransform"]);const Be={supported:!1,testSupport:function(h){!$e&&et&&(pt?jt(h):st=h)}};let st,et,$e=!1,pt=!1;function jt(h){const e=h.createTexture();h.bindTexture(h.TEXTURE_2D,e);try{if(h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,et),h.isContextLost())return;Be.supported=!0}catch{}h.deleteTexture(e),$e=!0}var Ze;typeof document<"u"&&(et=document.createElement("img"),et.onload=()=>{st&&jt(st),st=null,pt=!0},et.onerror=()=>{$e=!0,st=null},et.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(h){let e,i,s,o;h.resetRequestQueue=()=>{e=[],i=0,s=0,o={}},h.addThrottleControl=y=>{const x=s++;return o[x]=y,x},h.removeThrottleControl=y=>{delete o[y],f()},h.getImage=(y,x,T=!0)=>new Promise((M,S)=>{Be.supported&&(y.headers||(y.headers={}),y.headers.accept="image/webp,*/*"),c.e(y,{type:"image"}),e.push({abortController:x,requestParameters:y,supportImageRefresh:T,state:"queued",onError:z=>{S(z)},onSuccess:z=>{M(z)}}),f()});const u=y=>c._(this,void 0,void 0,function*(){y.state="running";const{requestParameters:x,supportImageRefresh:T,onError:M,onSuccess:S,abortController:z}=y,R=T===!1&&!c.i(self)&&!c.g(x.url)&&(!x.headers||Object.keys(x.headers).reduce((N,$)=>N&&$==="accept",!0));i++;const V=R?g(x,z):c.m(x,z);try{const N=yield V;delete y.abortController,y.state="completed",N.data instanceof HTMLImageElement||c.b(N.data)?S(N):N.data&&S({data:yield(j=N.data,typeof createImageBitmap=="function"?c.f(j):c.h(j)),cacheControl:N.cacheControl,expires:N.expires})}catch(N){delete y.abortController,M(N)}finally{i--,f()}var j}),f=()=>{const y=(()=>{for(const x of Object.keys(o))if(o[x]())return!0;return!1})()?c.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:c.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let x=i;x<y&&e.length>0;x++){const T=e.shift();T.abortController.signal.aborted?x--:u(T)}},g=(y,x)=>new Promise((T,M)=>{const S=new Image,z=y.url,R=y.credentials;R&&R==="include"?S.crossOrigin="use-credentials":(R&&R==="same-origin"||!c.d(z))&&(S.crossOrigin="anonymous"),x.signal.addEventListener("abort",()=>{S.src="",M(c.c())}),S.fetchPriority="high",S.onload=()=>{S.onerror=S.onload=null,T({data:S})},S.onerror=()=>{S.onerror=S.onload=null,x.signal.aborted||M(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},S.src=z})}(Ze||(Ze={})),Ze.resetRequestQueue();class wt{constructor(e){this._transformRequestFn=e}transformRequest(e,i){return this._transformRequestFn&&this._transformRequestFn(e,i)||{url:e}}setTransformRequest(e){this._transformRequestFn=e}}function tt(h){const e=[];if(typeof h=="string")e.push({id:"default",url:h});else if(h&&h.length>0){const i=[];for(const{id:s,url:o}of h){const u=`${s}${o}`;i.indexOf(u)===-1&&(i.push(u),e.push({id:s,url:o}))}}return e}function Ue(h,e,i){try{const s=new URL(h);return s.pathname+=`${e}${i}`,s.toString()}catch{throw new Error(`Invalid sprite URL "${h}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}class xt{constructor(e,i,s,o){this.context=e,this.format=s,this.texture=e.gl.createTexture(),this.update(i,o)}update(e,i,s){const{width:o,height:u}=e,f=!(this.size&&this.size[0]===o&&this.size[1]===u||s),{context:g}=this,{gl:y}=g;if(this.useMipmap=!!(i&&i.useMipmap),y.bindTexture(y.TEXTURE_2D,this.texture),g.pixelStoreUnpackFlipY.set(!1),g.pixelStoreUnpack.set(1),g.pixelStoreUnpackPremultiplyAlpha.set(this.format===y.RGBA&&(!i||i.premultiply!==!1)),f)this.size=[o,u],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||c.b(e)?y.texImage2D(y.TEXTURE_2D,0,this.format,this.format,y.UNSIGNED_BYTE,e):y.texImage2D(y.TEXTURE_2D,0,this.format,o,u,0,this.format,y.UNSIGNED_BYTE,e.data);else{const{x,y:T}=s||{x:0,y:0};e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||c.b(e)?y.texSubImage2D(y.TEXTURE_2D,0,x,T,y.RGBA,y.UNSIGNED_BYTE,e):y.texSubImage2D(y.TEXTURE_2D,0,x,T,o,u,y.RGBA,y.UNSIGNED_BYTE,e.data)}this.useMipmap&&this.isSizePowerOfTwo()&&y.generateMipmap(y.TEXTURE_2D)}bind(e,i,s){const{context:o}=this,{gl:u}=o;u.bindTexture(u.TEXTURE_2D,this.texture),s!==u.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(s=u.LINEAR),e!==this.filter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,s||e),this.filter=e),i!==this.wrap&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrap=i)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}function Dt(h){const{userImage:e}=h;return!!(e&&e.render&&e.render())&&(h.data.replace(new Uint8Array(e.data.buffer)),!0)}class Bt extends c.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new c.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(e){if(this.loaded!==e&&(this.loaded=e,e)){for(const{ids:i,promiseResolve:s}of this.requestors)s(this._getImagesForIds(i));this.requestors=[]}}getImage(e){const i=this.images[e];if(i&&!i.data&&i.spriteData){const s=i.spriteData;i.data=new c.R({width:s.width,height:s.height},s.context.getImageData(s.x,s.y,s.width,s.height).data),i.spriteData=null}return i}addImage(e,i){if(this.images[e])throw new Error(`Image id ${e} already exist, use updateImage instead`);this._validate(e,i)&&(this.images[e]=i)}_validate(e,i){let s=!0;const o=i.data||i.spriteData;return this._validateStretch(i.stretchX,o&&o.width)||(this.fire(new c.k(new Error(`Image "${e}" has invalid "stretchX" value`))),s=!1),this._validateStretch(i.stretchY,o&&o.height)||(this.fire(new c.k(new Error(`Image "${e}" has invalid "stretchY" value`))),s=!1),this._validateContent(i.content,i)||(this.fire(new c.k(new Error(`Image "${e}" has invalid "content" value`))),s=!1),s}_validateStretch(e,i){if(!e)return!0;let s=0;for(const o of e){if(o[0]<s||o[1]<o[0]||i<o[1])return!1;s=o[1]}return!0}_validateContent(e,i){if(!e)return!0;if(e.length!==4)return!1;const s=i.spriteData,o=s&&s.width||i.data.width,u=s&&s.height||i.data.height;return!(e[0]<0||o<e[0]||e[1]<0||u<e[1]||e[2]<0||o<e[2]||e[3]<0||u<e[3]||e[2]<e[0]||e[3]<e[1])}updateImage(e,i,s=!0){const o=this.getImage(e);if(s&&(o.data.width!==i.data.width||o.data.height!==i.data.height))throw new Error(`size mismatch between old image (${o.data.width}x${o.data.height}) and new image (${i.data.width}x${i.data.height}).`);i.version=o.version+1,this.images[e]=i,this.updatedImages[e]=!0}removeImage(e){const i=this.images[e];delete this.images[e],delete this.patterns[e],i.userImage&&i.userImage.onRemove&&i.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(e){return new Promise((i,s)=>{let o=!0;if(!this.isLoaded())for(const u of e)this.images[u]||(o=!1);this.isLoaded()||o?i(this._getImagesForIds(e)):this.requestors.push({ids:e,promiseResolve:i})})}_getImagesForIds(e){const i={};for(const s of e){let o=this.getImage(s);o||(this.fire(new c.l("styleimagemissing",{id:s})),o=this.getImage(s)),o?i[s]={data:o.data.clone(),pixelRatio:o.pixelRatio,sdf:o.sdf,version:o.version,stretchX:o.stretchX,stretchY:o.stretchY,content:o.content,textFitWidth:o.textFitWidth,textFitHeight:o.textFitHeight,hasRenderCallback:!!(o.userImage&&o.userImage.render)}:c.w(`Image "${s}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return i}getPixelSize(){const{width:e,height:i}=this.atlasImage;return{width:e,height:i}}getPattern(e){const i=this.patterns[e],s=this.getImage(e);if(!s)return null;if(i&&i.position.version===s.version)return i.position;if(i)i.position.version=s.version;else{const o={w:s.data.width+2,h:s.data.height+2,x:0,y:0},u=new c.I(o,s);this.patterns[e]={bin:o,position:u}}return this._updatePatternAtlas(),this.patterns[e].position}bind(e){const i=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new xt(e,this.atlasImage,i.RGBA),this.atlasTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE)}_updatePatternAtlas(){const e=[];for(const u in this.patterns)e.push(this.patterns[u].bin);const{w:i,h:s}=c.p(e),o=this.atlasImage;o.resize({width:i||1,height:s||1});for(const u in this.patterns){const{bin:f}=this.patterns[u],g=f.x+1,y=f.y+1,x=this.getImage(u).data,T=x.width,M=x.height;c.R.copy(x,o,{x:0,y:0},{x:g,y},{width:T,height:M}),c.R.copy(x,o,{x:0,y:M-1},{x:g,y:y-1},{width:T,height:1}),c.R.copy(x,o,{x:0,y:0},{x:g,y:y+M},{width:T,height:1}),c.R.copy(x,o,{x:T-1,y:0},{x:g-1,y},{width:1,height:M}),c.R.copy(x,o,{x:0,y:0},{x:g+T,y},{width:1,height:M})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(e){for(const i of e){if(this.callbackDispatchedThisFrame[i])continue;this.callbackDispatchedThisFrame[i]=!0;const s=this.getImage(i);s||c.w(`Image with ID: "${i}" was not found`),Dt(s)&&this.updateImage(i,s)}}}const Rt=1e20;function bt(h,e,i,s,o,u,f,g,y){for(let x=e;x<e+s;x++)kt(h,i*u+x,u,o,f,g,y);for(let x=i;x<i+o;x++)kt(h,x*u+e,1,s,f,g,y)}function kt(h,e,i,s,o,u,f){u[0]=0,f[0]=-1e20,f[1]=Rt,o[0]=h[e];for(let g=1,y=0,x=0;g<s;g++){o[g]=h[e+g*i];const T=g*g;do{const M=u[y];x=(o[g]-o[M]+T-M*M)/(g-M)/2}while(x<=f[y]&&--y>-1);y++,u[y]=g,f[y]=x,f[y+1]=Rt}for(let g=0,y=0;g<s;g++){for(;f[y+1]<g;)y++;const x=u[y],T=g-x;h[e+g*i]=o[x]+T*T}}class gt{constructor(e,i){this.requestManager=e,this.localIdeographFontFamily=i,this.entries={}}setURL(e){this.url=e}getGlyphs(e){return c._(this,void 0,void 0,function*(){const i=[];for(const u in e)for(const f of e[u])i.push(this._getAndCacheGlyphsPromise(u,f));const s=yield Promise.all(i),o={};for(const{stack:u,id:f,glyph:g}of s)o[u]||(o[u]={}),o[u][f]=g&&{id:g.id,bitmap:g.bitmap.clone(),metrics:g.metrics};return o})}_getAndCacheGlyphsPromise(e,i){return c._(this,void 0,void 0,function*(){let s=this.entries[e];s||(s=this.entries[e]={glyphs:{},requests:{},ranges:{}});let o=s.glyphs[i];if(o!==void 0)return{stack:e,id:i,glyph:o};if(o=this._tinySDF(s,e,i),o)return s.glyphs[i]=o,{stack:e,id:i,glyph:o};const u=Math.floor(i/256);if(256*u>65535)throw new Error("glyphs > 65535 not supported");if(s.ranges[u])return{stack:e,id:i,glyph:o};if(!this.url)throw new Error("glyphsUrl is not set");if(!s.requests[u]){const g=gt.loadGlyphRange(e,u,this.url,this.requestManager);s.requests[u]=g}const f=yield s.requests[u];for(const g in f)this._doesCharSupportLocalGlyph(+g)||(s.glyphs[+g]=f[+g]);return s.ranges[u]=!0,{stack:e,id:i,glyph:f[i]||null}})}_doesCharSupportLocalGlyph(e){return!!this.localIdeographFontFamily&&(new RegExp("\\p{Ideo}|\\p{sc=Hang}|\\p{sc=Hira}|\\p{sc=Kana}","u").test(String.fromCodePoint(e))||c.u["CJK Unified Ideographs"](e)||c.u["Hangul Syllables"](e)||c.u.Hiragana(e)||c.u.Katakana(e)||c.u["CJK Symbols and Punctuation"](e)||c.u["Halfwidth and Fullwidth Forms"](e))}_tinySDF(e,i,s){const o=this.localIdeographFontFamily;if(!o||!this._doesCharSupportLocalGlyph(s))return;let u=e.tinySDF;if(!u){let g="400";/bold/i.test(i)?g="900":/medium/i.test(i)?g="500":/light/i.test(i)&&(g="200"),u=e.tinySDF=new gt.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:o,fontWeight:g})}const f=u.draw(String.fromCharCode(s));return{id:s,bitmap:new c.q({width:f.width||60,height:f.height||60},f.data),metrics:{width:f.glyphWidth/2||24,height:f.glyphHeight/2||24,left:f.glyphLeft/2+.5||0,top:f.glyphTop/2-27.5||-8,advance:f.glyphAdvance/2||24,isDoubleResolution:!0}}}}gt.loadGlyphRange=function(h,e,i,s){return c._(this,void 0,void 0,function*(){const o=256*e,u=o+255,f=s.transformRequest(i.replace("{fontstack}",h).replace("{range}",`${o}-${u}`),"Glyphs"),g=yield c.n(f,new AbortController);if(!g||!g.data)throw new Error(`Could not load glyph range. range: ${e}, ${o}-${u}`);const y={};for(const x of c.o(g.data))y[x.id]=x;return y})},gt.TinySDF=class{constructor({fontSize:h=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:o="sans-serif",fontWeight:u="normal",fontStyle:f="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;const g=this.size=h+4*e,y=this._createCanvas(g),x=this.ctx=y.getContext("2d",{willReadFrequently:!0});x.font=`${f} ${u} ${h}px ${o}`,x.textBaseline="alphabetic",x.textAlign="left",x.fillStyle="black",this.gridOuter=new Float64Array(g*g),this.gridInner=new Float64Array(g*g),this.f=new Float64Array(g),this.z=new Float64Array(g+1),this.v=new Uint16Array(g)}_createCanvas(h){const e=document.createElement("canvas");return e.width=e.height=h,e}draw(h){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:o,actualBoundingBoxRight:u}=this.ctx.measureText(h),f=Math.ceil(i),g=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-o))),y=Math.min(this.size-this.buffer,f+Math.ceil(s)),x=g+2*this.buffer,T=y+2*this.buffer,M=Math.max(x*T,0),S=new Uint8ClampedArray(M),z={data:S,width:x,height:T,glyphWidth:g,glyphHeight:y,glyphTop:f,glyphLeft:0,glyphAdvance:e};if(g===0||y===0)return z;const{ctx:R,buffer:V,gridInner:j,gridOuter:N}=this;R.clearRect(V,V,g,y),R.fillText(h,V,V+f);const $=R.getImageData(V,V,g,y);N.fill(Rt,0,M),j.fill(0,0,M);for(let W=0;W<y;W++)for(let X=0;X<g;X++){const J=$.data[4*(W*g+X)+3]/255;if(J===0)continue;const ie=(W+V)*x+X+V;if(J===1)N[ie]=0,j[ie]=Rt;else{const Q=.5-J;N[ie]=Q>0?Q*Q:0,j[ie]=Q<0?Q*Q:0}}bt(N,0,0,x,T,x,this.f,this.v,this.z),bt(j,V,V,g,y,x,this.f,this.v,this.z);for(let W=0;W<M;W++){const X=Math.sqrt(N[W])-Math.sqrt(j[W]);S[W]=Math.round(255-255*(X/this.radius+this.cutoff))}return z}};class Vt{constructor(){this.specification=c.v.light.position}possiblyEvaluate(e,i){return c.z(e.expression.evaluate(i))}interpolate(e,i,s){return{x:c.B.number(e.x,i.x,s),y:c.B.number(e.y,i.y,s),z:c.B.number(e.z,i.z,s)}}}let Mt;class ai extends c.E{constructor(e){super(),Mt=Mt||new c.r({anchor:new c.D(c.v.light.anchor),position:new Vt,color:new c.D(c.v.light.color),intensity:new c.D(c.v.light.intensity)}),this._transitionable=new c.T(Mt),this.setLight(e),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,i={}){if(!this._validate(c.t,e,i))for(const s in e){const o=e[s];s.endsWith("-transition")?this._transitionable.setTransition(s.slice(0,-11),o):this._transitionable.setValue(s,o)}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,i,s){return(!s||s.validate!==!1)&&c.x(this,e.call(c.y,{value:i,style:{glyphs:!0,sprite:!0},styleSpec:c.v}))}}const Li=new c.r({"sky-color":new c.D(c.v.sky["sky-color"]),"horizon-color":new c.D(c.v.sky["horizon-color"]),"fog-color":new c.D(c.v.sky["fog-color"]),"fog-ground-blend":new c.D(c.v.sky["fog-ground-blend"]),"horizon-fog-blend":new c.D(c.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new c.D(c.v.sky["sky-horizon-blend"]),"atmosphere-blend":new c.D(c.v.sky["atmosphere-blend"])});class Tt extends c.E{constructor(e){super(),this._transitionable=new c.T(Li),this.setSky(e),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new c.C(0))}setSky(e,i={}){if(!this._validate(c.F,e,i)){e||(e={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const s in e){const o=e[s];s.endsWith("-transition")?this._transitionable.setTransition(s.slice(0,-11),o):this._transitionable.setValue(s,o)}}}getSky(){return this._transitionable.serialize()}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,i,s={}){return(s==null?void 0:s.validate)!==!1&&c.x(this,e.call(c.y,c.e({value:i,style:{glyphs:!0,sprite:!0},styleSpec:c.v})))}calculateFogBlendOpacity(e){return e<60?0:e<70?(e-60)/10:1}}class Qt{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(e,i){const s=e.join(",")+String(i);return this.dashEntry[s]||(this.dashEntry[s]=this.addDash(e,i)),this.dashEntry[s]}getDashRanges(e,i,s){const o=[];let u=e.length%2==1?-e[e.length-1]*s:0,f=e[0]*s,g=!0;o.push({left:u,right:f,isDash:g,zeroLength:e[0]===0});let y=e[0];for(let x=1;x<e.length;x++){g=!g;const T=e[x];u=y*s,y+=T,f=y*s,o.push({left:u,right:f,isDash:g,zeroLength:T===0})}return o}addRoundDash(e,i,s){const o=i/2;for(let u=-s;u<=s;u++){const f=this.width*(this.nextRow+s+u);let g=0,y=e[g];for(let x=0;x<this.width;x++){x/y.right>1&&(y=e[++g]);const T=Math.abs(x-y.left),M=Math.abs(x-y.right),S=Math.min(T,M);let z;const R=u/s*(o+1);if(y.isDash){const V=o-Math.abs(R);z=Math.sqrt(S*S+V*V)}else z=o-Math.sqrt(S*S+R*R);this.data[f+x]=Math.max(0,Math.min(255,z+128))}}}addRegularDash(e){for(let g=e.length-1;g>=0;--g){const y=e[g],x=e[g+1];y.zeroLength?e.splice(g,1):x&&x.isDash===y.isDash&&(x.left=y.left,e.splice(g,1))}const i=e[0],s=e[e.length-1];i.isDash===s.isDash&&(i.left=s.left-this.width,s.right=i.right+this.width);const o=this.width*this.nextRow;let u=0,f=e[u];for(let g=0;g<this.width;g++){g/f.right>1&&(f=e[++u]);const y=Math.abs(g-f.left),x=Math.abs(g-f.right),T=Math.min(y,x);this.data[o+g]=Math.max(0,Math.min(255,(f.isDash?T:-T)+128))}}addDash(e,i){const s=i?7:0,o=2*s+1;if(this.nextRow+o>this.height)return c.w("LineAtlas out of space"),null;let u=0;for(let g=0;g<e.length;g++)u+=e[g];if(u!==0){const g=this.width/u,y=this.getDashRanges(e,this.width,g);i?this.addRoundDash(y,g,s):this.addRegularDash(y)}const f={y:(this.nextRow+s+.5)/this.height,height:2*s/this.height,width:u};return this.nextRow+=o,this.dirty=!0,f}bind(e){const i=e.gl;this.texture?(i.bindTexture(i.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,i.texSubImage2D(i.TEXTURE_2D,0,0,0,this.width,this.height,i.ALPHA,i.UNSIGNED_BYTE,this.data))):(this.texture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,this.width,this.height,0,i.ALPHA,i.UNSIGNED_BYTE,this.data))}}const Ti="maplibre_preloaded_worker_pool";class ei{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<ei.workerCount;)this.workers.push(new Worker(c.a.WORKER_URL));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Ti]}numActive(){return Object.keys(this.active).length}}const Kt=Math.floor(Pe.hardwareConcurrency/2);let Wt,Ge;function lt(){return Wt||(Wt=new ei),Wt}ei.workerCount=c.G(globalThis)?Math.max(Math.min(Kt,3),1):1;class St{constructor(e,i){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=i;const s=this.workerPool.acquire(i);for(let o=0;o<s.length;o++){const u=new c.H(s[o],i);u.name=`Worker ${o}`,this.actors.push(u)}if(!this.actors.length)throw new Error("No actors found")}broadcast(e,i){const s=[];for(const o of this.actors)s.push(o.sendAsync({type:e,data:i}));return Promise.all(s)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(e=!0){this.actors.forEach(i=>{i.remove()}),this.actors=[],e&&this.workerPool.release(this.id)}registerMessageHandler(e,i){for(const s of this.actors)s.registerMessageHandler(e,i)}}function Zt(){return Ge||(Ge=new St(lt(),c.J),Ge.registerMessageHandler("GR",(h,e,i)=>c.m(e,i))),Ge}function ti(h,e){const i=c.K();return c.L(i,i,[1,1,0]),c.M(i,i,[.5*h.width,.5*h.height,1]),h.calculatePosMatrix?c.N(i,i,h.calculatePosMatrix(e.toUnwrapped())):i}function _r(h,e,i,s,o,u){var f;const g=function(M,S,z){if(M)for(const R of M){const V=S[R];if(V&&V.source===z&&V.type==="fill-extrusion")return!0}else for(const R in S){const V=S[R];if(V.source===z&&V.type==="fill-extrusion")return!0}return!1}((f=o==null?void 0:o.layers)!==null&&f!==void 0?f:null,e,h.id),y=u.maxPitchScaleFactor(),x=h.tilesIn(s,y,g);x.sort(xi);const T=[];for(const M of x)T.push({wrappedTileID:M.tileID.wrapped().key,queryResults:M.tile.queryRenderedFeatures(e,i,h._state,M.queryGeometry,M.cameraQueryGeometry,M.scale,o,u,y,ti(h.transform,M.tileID))});return function(M,S){for(const z in M)for(const R of M[z])li(R,S);return M}(function(M){const S={},z={};for(const R of M){const V=R.queryResults,j=R.wrappedTileID,N=z[j]=z[j]||{};for(const $ in V){const W=V[$],X=N[$]=N[$]||{},J=S[$]=S[$]||[];for(const ie of W)X[ie.featureIndex]||(X[ie.featureIndex]=!0,J.push(ie))}}return S}(T),h)}function xi(h,e){const i=h.tileID,s=e.tileID;return i.overscaledZ-s.overscaledZ||i.canonical.y-s.canonical.y||i.wrap-s.wrap||i.canonical.x-s.canonical.x}function li(h,e){const i=h.feature,s=e.getFeatureState(i.layer["source-layer"],i.id);i.source=i.layer.source,i.layer["source-layer"]&&(i.sourceLayer=i.layer["source-layer"]),i.state=s}function Fi(h,e,i){return c._(this,void 0,void 0,function*(){let s=h;if(h.url?s=(yield c.j(e.transformRequest(h.url,"Source"),i)).data:yield Pe.frameAsync(i),!s)return null;const o=c.O(c.e(s,h),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in s&&s.vector_layers&&(o.vectorLayerIds=s.vector_layers.map(u=>u.id)),o})}class ci{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&(e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1])))}setNorthEast(e){return this._ne=e instanceof c.Q?new c.Q(e.lng,e.lat):c.Q.convert(e),this}setSouthWest(e){return this._sw=e instanceof c.Q?new c.Q(e.lng,e.lat):c.Q.convert(e),this}extend(e){const i=this._sw,s=this._ne;let o,u;if(e instanceof c.Q)o=e,u=e;else{if(!(e instanceof ci))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(ci.convert(e)):this.extend(c.Q.convert(e)):e&&("lng"in e||"lon"in e)&&"lat"in e?this.extend(c.Q.convert(e)):this;if(o=e._sw,u=e._ne,!o||!u)return this}return i||s?(i.lng=Math.min(o.lng,i.lng),i.lat=Math.min(o.lat,i.lat),s.lng=Math.max(u.lng,s.lng),s.lat=Math.max(u.lat,s.lat)):(this._sw=new c.Q(o.lng,o.lat),this._ne=new c.Q(u.lng,u.lat)),this}getCenter(){return new c.Q((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new c.Q(this.getWest(),this.getNorth())}getSouthEast(){return new c.Q(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=c.Q.convert(e);let o=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(o=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&o}static convert(e){return e instanceof ci?e:e&&new ci(e)}static fromLngLat(e,i=0){const s=360*i/40075017,o=s/Math.cos(Math.PI/180*e.lat);return new ci(new c.Q(e.lng-o,e.lat-s),new c.Q(e.lng+o,e.lat+s))}adjustAntiMeridian(){const e=new c.Q(this._sw.lng,this._sw.lat),i=new c.Q(this._ne.lng,this._ne.lat);return new ci(e,e.lng>i.lng?new c.Q(i.lng+360,i.lat):i)}}class Mr{constructor(e,i,s){this.bounds=ci.convert(this.validateBounds(e)),this.minzoom=i||0,this.maxzoom=s||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}contains(e){const i=Math.pow(2,e.z),s=Math.floor(c.U(this.bounds.getWest())*i),o=Math.floor(c.S(this.bounds.getNorth())*i),u=Math.ceil(c.U(this.bounds.getEast())*i),f=Math.ceil(c.S(this.bounds.getSouth())*i);return e.x>=s&&e.x<u&&e.y>=o&&e.y<f}}class qr extends c.E{constructor(e,i,s,o){if(super(),this.id=e,this.dispatcher=s,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,c.e(this,c.O(i,["url","scheme","tileSize","promoteId"])),this._options=c.e({type:"vector"},i),this._collectResourceTiming=i.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(o)}load(){return c._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new c.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const e=yield Fi(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),e&&(c.e(this,e),e.bounds&&(this.tileBounds=new Mr(e.bounds,this.minzoom,this.maxzoom)),this.fire(new c.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new c.l("data",{dataType:"source",sourceDataType:"content"})))}catch(e){this._tileJSONRequest=null,this.fire(new c.k(e))}})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}setSourceProperty(e){this._tileJSONRequest&&this._tileJSONRequest.abort(),e(),this.load()}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return c.e({},this._options)}loadTile(e){return c._(this,void 0,void 0,function*(){const i=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),s={request:this.map._requestManager.transformRequest(i,"Tile"),uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};s.request.collectResourceTiming=this._collectResourceTiming;let o="RT";if(e.actor&&e.state!=="expired"){if(e.state==="loading")return new Promise((u,f)=>{e.reloadPromise={resolve:u,reject:f}})}else e.actor=this.dispatcher.getActor(),o="LT";e.abortController=new AbortController;try{const u=yield e.actor.sendAsync({type:o,data:s},e.abortController);if(delete e.abortController,e.aborted)return;this._afterTileLoadWorkerResponse(e,u)}catch(u){if(delete e.abortController,e.aborted)return;if(u&&u.status!==404)throw u;this._afterTileLoadWorkerResponse(e,null)}})}_afterTileLoadWorkerResponse(e,i){if(i&&i.resourceTiming&&(e.resourceTiming=i.resourceTiming),i&&this.map._refreshExpiredTiles&&e.setExpiryData(i),e.loadVectorData(i,this.map.painter),e.reloadPromise){const s=e.reloadPromise;e.reloadPromise=null,this.loadTile(e).then(s.resolve).catch(s.reject)}}abortTile(e){return c._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.actor&&(yield e.actor.sendAsync({type:"AT",data:{uid:e.uid,type:this.type,source:this.id}}))})}unloadTile(e){return c._(this,void 0,void 0,function*(){e.unloadVectorData(),e.actor&&(yield e.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class ir extends c.E{constructor(e,i,s,o){super(),this.id=e,this.dispatcher=s,this.setEventedParent(o),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=c.e({type:"raster"},i),c.e(this,c.O(i,["url","scheme","tileSize"]))}load(){return c._(this,arguments,void 0,function*(e=!1){this._loaded=!1,this.fire(new c.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const i=yield Fi(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,i&&(c.e(this,i),i.bounds&&(this.tileBounds=new Mr(i.bounds,this.minzoom,this.maxzoom)),this.fire(new c.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new c.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:e})))}catch(i){this._tileJSONRequest=null,this.fire(new c.k(i))}})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(e){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),e(),this.load(!0)}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}serialize(){return c.e({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e){return c._(this,void 0,void 0,function*(){const i=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);e.abortController=new AbortController;try{const s=yield Ze.getImage(this.map._requestManager.transformRequest(i,"Tile"),e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(s&&s.data){this.map._refreshExpiredTiles&&s.cacheControl&&s.expires&&e.setExpiryData({cacheControl:s.cacheControl,expires:s.expires});const o=this.map.painter.context,u=o.gl,f=s.data;e.texture=this.map.painter.getTileTexture(f.width),e.texture?e.texture.update(f,{useMipmap:!0}):(e.texture=new xt(o,f,u.RGBA,{useMipmap:!0}),e.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE,u.LINEAR_MIPMAP_NEAREST)),e.state="loaded"}}catch(s){if(delete e.abortController,e.aborted)e.state="unloaded";else if(s)throw e.state="errored",s}})}abortTile(e){return c._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController)})}unloadTile(e){return c._(this,void 0,void 0,function*(){e.texture&&this.map.painter.saveTileTexture(e.texture)})}hasTransition(){return!1}}class Hr extends ir{constructor(e,i,s,o){super(e,i,s,o),this.type="raster-dem",this.maxzoom=22,this._options=c.e({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox",this.redFactor=i.redFactor,this.greenFactor=i.greenFactor,this.blueFactor=i.blueFactor,this.baseShift=i.baseShift}loadTile(e){return c._(this,void 0,void 0,function*(){const i=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),s=this.map._requestManager.transformRequest(i,"Tile");e.neighboringTiles=this._getNeighboringTiles(e.tileID),e.abortController=new AbortController;try{const o=yield Ze.getImage(s,e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(o&&o.data){const u=o.data;this.map._refreshExpiredTiles&&o.cacheControl&&o.expires&&e.setExpiryData({cacheControl:o.cacheControl,expires:o.expires});const f=c.b(u)&&c.V()?u:yield this.readImageNow(u),g={type:this.type,uid:e.uid,source:this.id,rawImageData:f,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!e.actor||e.state==="expired"){e.actor=this.dispatcher.getActor();const y=yield e.actor.sendAsync({type:"LDT",data:g});e.dem=y,e.needsHillshadePrepare=!0,e.needsTerrainPrepare=!0,e.state="loaded"}}}catch(o){if(delete e.abortController,e.aborted)e.state="unloaded";else if(o)throw e.state="errored",o}})}readImageNow(e){return c._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&c.W()){const i=e.width+2,s=e.height+2;try{return new c.R({width:i,height:s},yield c.X(e,-1,-1,i,s))}catch{}}return Pe.getImageData(e,1)})}_getNeighboringTiles(e){const i=e.canonical,s=Math.pow(2,i.z),o=(i.x-1+s)%s,u=i.x===0?e.wrap-1:e.wrap,f=(i.x+1+s)%s,g=i.x+1===s?e.wrap+1:e.wrap,y={};return y[new c.Y(e.overscaledZ,u,i.z,o,i.y).key]={backfilled:!1},y[new c.Y(e.overscaledZ,g,i.z,f,i.y).key]={backfilled:!1},i.y>0&&(y[new c.Y(e.overscaledZ,u,i.z,o,i.y-1).key]={backfilled:!1},y[new c.Y(e.overscaledZ,e.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},y[new c.Y(e.overscaledZ,g,i.z,f,i.y-1).key]={backfilled:!1}),i.y+1<s&&(y[new c.Y(e.overscaledZ,u,i.z,o,i.y+1).key]={backfilled:!1},y[new c.Y(e.overscaledZ,e.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},y[new c.Y(e.overscaledZ,g,i.z,f,i.y+1).key]={backfilled:!1}),y}unloadTile(e){return c._(this,void 0,void 0,function*(){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded",e.actor&&(yield e.actor.sendAsync({type:"RDT",data:{type:this.type,uid:e.uid,source:this.id}}))})}}class Rr extends c.E{constructor(e,i,s,o){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=s.getActor(),this.setEventedParent(o),this._data=i.data,this._options=c.e({},i),this._collectResourceTiming=i.collectResourceTiming,i.maxzoom!==void 0&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId,i.clusterMaxZoom!==void 0&&this.maxzoom<=i.clusterMaxZoom&&c.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${i.clusterMaxZoom}".`),this.workerOptions=c.e({source:this.id,cluster:i.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(i.buffer!==void 0?i.buffer:128),tolerance:this._pixelsToTileUnits(i.tolerance!==void 0?i.tolerance:.375),extent:c.Z,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:i.clusterMaxZoom!==void 0?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:c.Z,radius:this._pixelsToTileUnits(i.clusterRadius||50),log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(e){return e*(c.Z/this.tileSize)}load(){return c._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(e){this.map=e,this.load()}setData(e){return this._data=e,this._updateWorkerData(),this}updateData(e){return this._updateWorkerData(e),this}getData(){return c._(this,void 0,void 0,function*(){const e=c.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:e})})}setClusterOptions(e){return this.workerOptions.cluster=e.cluster,e&&(e.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(e.clusterRadius)),e.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=e.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(e){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:e,source:this.id}})}getClusterChildren(e){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:e,source:this.id}})}getClusterLeaves(e,i,s){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:e,limit:i,offset:s}})}_updateWorkerData(e){return c._(this,void 0,void 0,function*(){const i=c.e({type:this.type},this.workerOptions);e?i.dataDiff=e:typeof this._data=="string"?(i.request=this.map._requestManager.transformRequest(Pe.resolveURL(this._data),"Source"),i.request.collectResourceTiming=this._collectResourceTiming):i.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new c.l("dataloading",{dataType:"source"}));try{const s=yield this.actor.sendAsync({type:"LD",data:i});if(this._pendingLoads--,this._removed||s.abandoned)return void this.fire(new c.l("dataabort",{dataType:"source"}));let o=null;s.resourceTiming&&s.resourceTiming[this.id]&&(o=s.resourceTiming[this.id].slice(0));const u={dataType:"source"};this._collectResourceTiming&&o&&o.length>0&&c.e(u,{resourceTiming:o}),this.fire(new c.l("data",Object.assign(Object.assign({},u),{sourceDataType:"metadata"}))),this.fire(new c.l("data",Object.assign(Object.assign({},u),{sourceDataType:"content"})))}catch(s){if(this._pendingLoads--,this._removed)return void this.fire(new c.l("dataabort",{dataType:"source"}));this.fire(new c.k(s))}})}loaded(){return this._pendingLoads===0}loadTile(e){return c._(this,void 0,void 0,function*(){const i=e.actor?"RT":"LT";e.actor=this.actor;const s={type:this.type,uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};e.abortController=new AbortController;const o=yield this.actor.sendAsync({type:i,data:s},e.abortController);delete e.abortController,e.unloadVectorData(),e.aborted||e.loadVectorData(o,this.map.painter,i==="RT")})}abortTile(e){return c._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.aborted=!0})}unloadTile(e){return c._(this,void 0,void 0,function*(){e.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return c.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class pr extends c.E{constructor(e,i,s,o){super(),this.flippedWindingOrder=!1,this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(o),this.options=i}load(e){return c._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new c.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const i=yield Ze.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,i&&i.data&&(this.image=i.data,e&&(this.coordinates=e),this._finishLoading())}catch(i){this._request=null,this._loaded=!0,this.fire(new c.k(i))}})}loaded(){return this._loaded}updateImage(e){return e.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=e.url,this.load(e.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new c.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(e){this.coordinates=e;const i=e.map(c.$.fromLngLat);var s;return this.tileID=function(o){let u=1/0,f=1/0,g=-1/0,y=-1/0;for(const S of o)u=Math.min(u,S.x),f=Math.min(f,S.y),g=Math.max(g,S.x),y=Math.max(y,S.y);const x=Math.max(g-u,y-f),T=Math.max(0,Math.floor(-Math.log(x)/Math.LN2)),M=Math.pow(2,T);return new c.a0(T,Math.floor((u+g)/2*M),Math.floor((f+y)/2*M))}(i),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=i.map(o=>this.tileID.getTilePoint(o)._round()),this.flippedWindingOrder=((s=this.tileCoords)[1].x-s[0].x)*(s[2].y-s[0].y)-(s[1].y-s[0].y)*(s[2].x-s[0].x)<0,this.fire(new c.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const e=this.map.painter.context,i=e.gl;this.texture||(this.texture=new xt(e,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE));let s=!1;for(const o in this.tiles){const u=this.tiles[o];u.state!=="loaded"&&(u.state="loaded",u.texture=this.texture,s=!0)}s&&this.fire(new c.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(e){return c._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={}):e.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class fr extends pr{constructor(e,i,s,o){super(e,i,s,o),this.roundZoom=!0,this.type="video",this.options=i}load(){return c._(this,void 0,void 0,function*(){this._loaded=!1;const e=this.options;this.urls=[];for(const i of e.urls)this.urls.push(this.map._requestManager.transformRequest(i,"Source").url);try{const i=yield c.a1(this.urls);if(this._loaded=!0,!i)return;this.video=i,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(i){this.fire(new c.k(i))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const i=this.video.seekable;e<i.start(0)||e>i.end(0)?this.fire(new c.k(new c.a2(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const e=this.map.painter.context,i=e.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new xt(e,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE));let s=!1;for(const o in this.tiles){const u=this.tiles[o];u.state!=="loaded"&&(u.state="loaded",u.texture=this.texture,s=!0)}s&&this.fire(new c.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Wr extends pr{constructor(e,i,s,o){super(e,i,s,o),i.coordinates?Array.isArray(i.coordinates)&&i.coordinates.length===4&&!i.coordinates.some(u=>!Array.isArray(u)||u.length!==2||u.some(f=>typeof f!="number"))||this.fire(new c.k(new c.a2(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new c.k(new c.a2(`sources.${e}`,null,'missing required property "coordinates"'))),i.animate&&typeof i.animate!="boolean"&&this.fire(new c.k(new c.a2(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),i.canvas?typeof i.canvas=="string"||i.canvas instanceof HTMLCanvasElement||this.fire(new c.k(new c.a2(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new c.k(new c.a2(`sources.${e}`,null,'missing required property "canvas"'))),this.options=i,this.animate=i.animate===void 0||i.animate}load(){return c._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new c.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const i=this.map.painter.context,s=i.gl;this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new xt(i,this.canvas,s.RGBA,{premultiply:!0});let o=!1;for(const u in this.tiles){const f=this.tiles[u];f.state!=="loaded"&&(f.state="loaded",f.texture=this.texture,o=!0)}o&&this.fire(new c.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}}const Ve={},nt=h=>{switch(h){case"geojson":return Rr;case"image":return pr;case"raster":return ir;case"raster-dem":return Hr;case"vector":return qr;case"video":return fr;case"canvas":return Wr}return Ve[h]},Oe="RTLPluginLoaded";class ft extends c.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Zt()}_syncState(e){return this.status=e,this.dispatcher.broadcast("SRPS",{pluginStatus:e,pluginURL:this.url}).catch(i=>{throw this.status="error",i})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(e){return c._(this,arguments,void 0,function*(i,s=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=Pe.resolveURL(i),!this.url)throw new Error(`requested url ${i} is invalid`);if(this.status==="unavailable"){if(!s)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return c._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new c.l(Oe))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let Yt=null;function zt(){return Yt||(Yt=new ft),Yt}class Ii{constructor(e,i){this.timeAdded=0,this.fadeEndTime=0,this.tileID=e,this.uid=c.a3(),this.uses=0,this.tileSize=i,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(e){const i=e+this.timeAdded;i<this.fadeEndTime||(this.fadeEndTime=i)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(e){this.demTexture&&e.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(e,i,s){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(o,u){const f={};if(!u)return f;for(const g of o){const y=g.layerIds.map(x=>u.getLayer(x)).filter(Boolean);if(y.length!==0){g.layers=y,g.stateDependentLayerIds&&(g.stateDependentLayers=g.stateDependentLayerIds.map(x=>y.filter(T=>T.id===x)[0]));for(const x of y)f[x.id]=g}}return f}(e.buckets,i==null?void 0:i.style),this.hasSymbolBuckets=!1;for(const o in this.buckets){const u=this.buckets[o];if(u instanceof c.a5){if(this.hasSymbolBuckets=!0,!s)break;u.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const o in this.buckets){const u=this.buckets[o];if(u instanceof c.a5&&u.hasRTLText){this.hasRTLText=!0,zt().lazyLoad();break}}this.queryPadding=0;for(const o in this.buckets){const u=this.buckets[o];this.queryPadding=Math.max(this.queryPadding,i.style.getLayer(o).queryRadius(u))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage)}else this.collisionBoxArray=new c.a4}unloadVectorData(){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(e){return this.buckets[e.id]}upload(e){for(const s in this.buckets){const o=this.buckets[s];o.uploadPending()&&o.upload(e)}const i=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new xt(e,this.imageAtlas.image,i.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new xt(e,this.glyphAtlasImage,i.ALPHA),this.glyphAtlasImage=null)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,i,s,o,u,f,g,y,x,T){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:o,cameraQueryGeometry:u,scale:f,tileSize:this.tileSize,pixelPosMatrix:T,transform:y,params:g,queryPadding:this.queryPadding*x},e,i,s):{}}querySourceFeatures(e,i){const s=this.latestFeatureIndex;if(!s||!s.rawTileData)return;const o=s.loadVTLayers(),u=i&&i.sourceLayer?i.sourceLayer:"",f=o._geojsonTileLayer||o[u];if(!f)return;const g=c.a6(i&&i.filter),{z:y,x,y:T}=this.tileID.canonical,M={z:y,x,y:T};for(let S=0;S<f.length;S++){const z=f.feature(S);if(g.needGeometry){const j=c.a7(z,!0);if(!g.filter(new c.C(this.tileID.overscaledZ),j,this.tileID.canonical))continue}else if(!g.filter(new c.C(this.tileID.overscaledZ),z))continue;const R=s.getId(z,u),V=new c.a8(z,y,x,T,R);V.tile=M,e.push(V)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const i=this.expirationTime;if(e.cacheControl){const s=c.a9(e.cacheControl);s["max-age"]&&(this.expirationTime=Date.now()+1e3*s["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const s=Date.now();let o=!1;if(this.expirationTime>s)o=!1;else if(i)if(this.expirationTime<i)o=!0;else{const u=this.expirationTime-i;u?this.expirationTime=s+Math.max(u,3e4):o=!0}else o=!0;o?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,i){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0)return;const s=this.latestFeatureIndex.loadVTLayers();for(const o in this.buckets){if(!i.style.hasLayer(o))continue;const u=this.buckets[o],f=u.layers[0].sourceLayer||"_geojsonTileLayer",g=s[f],y=e[f];if(!g||!y||Object.keys(y).length===0)continue;u.update(y,g,this.imageAtlas&&this.imageAtlas.patternPositions||{});const x=i&&i.style&&i.style.getLayer(o);x&&(this.queryPadding=Math.max(this.queryPadding,x.queryRadius(u)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Pe.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=Pe.now()+e}setDependencies(e,i){const s={};for(const o of i)s[o]=!0;this.dependencies[e]=s}hasDependency(e,i){for(const s of e){const o=this.dependencies[s];if(o){for(const u of i)if(o[u])return!0}}return!1}}class ki{constructor(e,i){this.max=e,this.onRemove=i,this.reset()}reset(){for(const e in this.data)for(const i of this.data[e])i.timeout&&clearTimeout(i.timeout),this.onRemove(i.value);return this.data={},this.order=[],this}add(e,i,s){const o=e.wrapped().key;this.data[o]===void 0&&(this.data[o]=[]);const u={value:i,timeout:void 0};if(s!==void 0&&(u.timeout=setTimeout(()=>{this.remove(e,u)},s)),this.data[o].push(u),this.order.push(o),this.order.length>this.max){const f=this._getAndRemoveByKey(this.order[0]);f&&this.onRemove(f)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const i=this.data[e].shift();return i.timeout&&clearTimeout(i.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),i.value}getByKey(e){const i=this.data[e];return i?i[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,i){if(!this.has(e))return this;const s=e.wrapped().key,o=i===void 0?0:this.data[s].indexOf(i),u=this.data[s][o];return this.data[s].splice(o,1),u.timeout&&clearTimeout(u.timeout),this.data[s].length===0&&delete this.data[s],this.onRemove(u.value),this.order.splice(this.order.indexOf(s),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const i=this._getAndRemoveByKey(this.order[0]);i&&this.onRemove(i)}return this}filter(e){const i=[];for(const s in this.data)for(const o of this.data[s])e(o.value)||i.push(o);for(const s of i)this.remove(s.value.tileID,s)}}class Sr{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,i,s){const o=String(i);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][o]=this.stateChanges[e][o]||{},c.e(this.stateChanges[e][o],s),this.deletedStates[e]===null){this.deletedStates[e]={};for(const u in this.state[e])u!==o&&(this.deletedStates[e][u]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][o]===null){this.deletedStates[e][o]={};for(const u in this.state[e][o])s[u]||(this.deletedStates[e][o][u]=null)}else for(const u in s)this.deletedStates[e]&&this.deletedStates[e][o]&&this.deletedStates[e][o][u]===null&&delete this.deletedStates[e][o][u]}removeFeatureState(e,i,s){if(this.deletedStates[e]===null)return;const o=String(i);if(this.deletedStates[e]=this.deletedStates[e]||{},s&&i!==void 0)this.deletedStates[e][o]!==null&&(this.deletedStates[e][o]=this.deletedStates[e][o]||{},this.deletedStates[e][o][s]=null);else if(i!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][o])for(s in this.deletedStates[e][o]={},this.stateChanges[e][o])this.deletedStates[e][o][s]=null;else this.deletedStates[e][o]=null;else this.deletedStates[e]=null}getState(e,i){const s=String(i),o=c.e({},(this.state[e]||{})[s],(this.stateChanges[e]||{})[s]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const u=this.deletedStates[e][i];if(u===null)return{};for(const f in u)delete o[f]}return o}initializeTileState(e,i){e.setFeatureState(this.state,i)}coalesceChanges(e,i){const s={};for(const o in this.stateChanges){this.state[o]=this.state[o]||{};const u={};for(const f in this.stateChanges[o])this.state[o][f]||(this.state[o][f]={}),c.e(this.state[o][f],this.stateChanges[o][f]),u[f]=this.state[o][f];s[o]=u}for(const o in this.deletedStates){this.state[o]=this.state[o]||{};const u={};if(this.deletedStates[o]===null)for(const f in this.state[o])u[f]={},this.state[o][f]={};else for(const f in this.deletedStates[o]){if(this.deletedStates[o][f]===null)this.state[o][f]={};else for(const g of Object.keys(this.deletedStates[o][f]))delete this.state[o][f][g];u[f]=this.state[o][f]}s[o]=s[o]||{},c.e(s[o],u)}if(this.stateChanges={},this.deletedStates={},Object.keys(s).length!==0)for(const o in e)e[o].setFeatureState(s,i)}}function Lr(h,e,i){const s=e.intersectsFrustum(h);if(!i)return s;const o=e.intersectsPlane(i);return s===0||o===0?0:s===2&&o===2?2:1}function mn(h,e,i,s,o){let u=h;const f=Math.atan(e/i),g=Math.hypot(e,i);return u=h+c.aa(s/g/Math.max(.5,Math.cos(c.ac(o/2)))),u+=1*c.aa(Math.cos(f))/2,u+=c.ad(h-u,-0,0),u}function hi(h,e){const i=(e.roundZoom?Math.round:Math.floor)(h.zoom+c.aa(h.tileSize/e.tileSize));return Math.max(0,i)}function se(h,e){const i=h.getCameraFrustum(),s=h.getClippingPlane(),o=h.screenPointToMercatorCoordinate(h.getCameraPoint()),u=c.$.fromLngLat(h.center,h.elevation);o.z=u.z+Math.cos(h.pitchInRadians)*h.cameraToCenterDistance/h.worldSize;const f=h.getCoveringTilesDetailsProvider(),g=f.allowVariableZoom(h,e),y=hi(h,e),x=e.minzoom||0,T=e.maxzoom!==void 0?e.maxzoom:h.maxZoom,M=Math.min(Math.max(0,y),T),S=Math.pow(2,M),z=[S*o.x,S*o.y,0],R=[S*u.x,S*u.y,0],V=Math.hypot(u.x-o.x,u.y-o.y),j=Math.abs(u.z-o.z),N=Math.hypot(V,j),$=J=>({zoom:0,x:0,y:0,wrap:J,fullyVisible:!1}),W=[],X=[];if(h.renderWorldCopies&&f.allowWorldCopies())for(let J=1;J<=3;J++)W.push($(-J)),W.push($(J));for(W.push($(0));W.length>0;){const J=W.pop(),ie=J.x,Q=J.y;let de=J.fullyVisible;const fe={x:ie,y:Q,z:J.zoom},xe=f.getTileAABB(fe,J.wrap,h.elevation,e);if(!de){const Re=Lr(i,xe,s);if(Re===0)continue;de=Re===2}const we=f.distanceToTile2d(o.x,o.y,fe,xe);let ve=y;g&&(ve=(e.calculateTileZoom||mn)(h.zoom+c.aa(h.tileSize/e.tileSize),we,j,N,h.fov)),ve=(e.roundZoom?Math.round:Math.floor)(ve),ve=Math.max(0,ve);const Le=Math.min(ve,T);if(J.wrap=f.getWrap(u,fe,J.wrap),J.zoom>=Le){if(J.zoom<x)continue;const Re=M-J.zoom,Ce=z[0]-.5-(ie<<Re),it=z[1]-.5-(Q<<Re),ot=e.reparseOverscaled?Math.max(J.zoom,ve):J.zoom;X.push({tileID:new c.Y(J.zoom===T?ot:J.zoom,J.wrap,J.zoom,ie,Q),distanceSq:c.ab([R[0]-.5-ie,R[1]-.5-Q]),tileDistanceToCamera:Math.sqrt(Ce*Ce+it*it)})}else for(let Re=0;Re<4;Re++)W.push({zoom:J.zoom+1,x:(ie<<1)+Re%2,y:(Q<<1)+(Re>>1),wrap:J.wrap,fullyVisible:de})}return X.sort((J,ie)=>J.distanceSq-ie.distanceSq).map(J=>J.tileID)}class P extends c.E{constructor(e,i,s){super(),this.id=e,this.dispatcher=s,this.on("data",o=>this._dataHandler(o)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((o,u,f,g)=>{const y=new(nt(u.type))(o,u,f,g);if(y.id!==o)throw new Error(`Expected Source id to be ${o} instead of ${y.id}`);return y})(e,i,s,this),this._tiles={},this._cache=new ki(0,o=>this._unloadTile(o)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new Sr,this._didEmitContent=!1,this._updated=!1}onAdd(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._maxTileCacheZoomLevels=e?e._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(e)}onRemove(e){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(e)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const e in this._tiles){const i=this._tiles[e];if(i.state!=="loaded"&&i.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(e,i,s){return c._(this,void 0,void 0,function*(){try{yield this._source.loadTile(e),this._tileLoaded(e,i,s)}catch(o){e.state="errored",o.status!==404?this._source.fire(new c.k(o,{tile:e})):this.update(this.transform,this.terrain)}})}_unloadTile(e){this._source.unloadTile&&this._source.unloadTile(e)}_abortTile(e){this._source.abortTile&&this._source.abortTile(e),this._source.fire(new c.l("dataabort",{tile:e,coord:e.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const i in this._tiles){const s=this._tiles[i];s.upload(e),s.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(e=>e.tileID).sort(L).map(e=>e.key)}getRenderableIds(e){const i=[];for(const s in this._tiles)this._isIdRenderable(s,e)&&i.push(this._tiles[s]);return e?i.sort((s,o)=>{const u=s.tileID,f=o.tileID,g=new c.P(u.canonical.x,u.canonical.y)._rotate(-this.transform.bearingInRadians),y=new c.P(f.canonical.x,f.canonical.y)._rotate(-this.transform.bearingInRadians);return u.overscaledZ-f.overscaledZ||y.y-g.y||y.x-g.x}).map(s=>s.tileID.key):i.map(s=>s.tileID).sort(L).map(s=>s.key)}hasRenderableParent(e){const i=this.findLoadedParent(e,0);return!!i&&this._isIdRenderable(i.tileID.key)}_isIdRenderable(e,i){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(i||!this._tiles[e].holdingForFade())}reload(e){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const i in this._tiles)(e||this._tiles[i].state!=="errored")&&this._reloadTile(i,"reloading")}}_reloadTile(e,i){return c._(this,void 0,void 0,function*(){const s=this._tiles[e];s&&(s.state!=="loading"&&(s.state=i),yield this._loadTile(s,e,i))})}_tileLoaded(e,i,s){e.timeAdded=Pe.now(),s==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(i,e),this.getSource().type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),e.aborted||this._source.fire(new c.l("data",{dataType:"source",tile:e,coord:e.tileID}))}_backfillDEM(e){const i=this.getRenderableIds();for(let o=0;o<i.length;o++){const u=i[o];if(e.neighboringTiles&&e.neighboringTiles[u]){const f=this.getTileByID(u);s(e,f),s(f,e)}}function s(o,u){o.needsHillshadePrepare=!0,o.needsTerrainPrepare=!0;let f=u.tileID.canonical.x-o.tileID.canonical.x;const g=u.tileID.canonical.y-o.tileID.canonical.y,y=Math.pow(2,o.tileID.canonical.z),x=u.tileID.key;f===0&&g===0||Math.abs(g)>1||(Math.abs(f)>1&&(Math.abs(f+y)===1?f+=y:Math.abs(f-y)===1&&(f-=y)),u.dem&&o.dem&&(o.dem.backfillBorder(u.dem,f,g),o.neighboringTiles&&o.neighboringTiles[x]&&(o.neighboringTiles[x].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,i,s,o){for(const u in this._tiles){let f=this._tiles[u];if(o[u]||!f.hasData()||f.tileID.overscaledZ<=i||f.tileID.overscaledZ>s)continue;let g=f.tileID;for(;f&&f.tileID.overscaledZ>i+1;){const x=f.tileID.scaledTo(f.tileID.overscaledZ-1);f=this._tiles[x.key],f&&f.hasData()&&(g=x)}let y=g;for(;y.overscaledZ>i;)if(y=y.scaledTo(y.overscaledZ-1),e[y.key]||e[y.canonical.key]){o[g.key]=g;break}}}findLoadedParent(e,i){if(e.key in this._loadedParentTiles){const s=this._loadedParentTiles[e.key];return s&&s.tileID.overscaledZ>=i?s:null}for(let s=e.overscaledZ-1;s>=i;s--){const o=e.scaledTo(s),u=this._getLoadedTile(o);if(u)return u}}findLoadedSibling(e){return this._getLoadedTile(e)}_getLoadedTile(e){const i=this._tiles[e.key];return i&&i.hasData()?i:this._cache.getByKey(e.wrapped().key)}updateCacheSize(e){const i=Math.ceil(e.width/this._source.tileSize)+1,s=Math.ceil(e.height/this._source.tileSize)+1,o=Math.floor(i*s*(this._maxTileCacheZoomLevels===null?c.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),u=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,o):o;this._cache.setMaxSize(u)}handleWrapJump(e){const i=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,i){const s={};for(const o in this._tiles){const u=this._tiles[o];u.tileID=u.tileID.unwrapTo(u.tileID.wrap+i),s[u.tileID.key]=u}this._tiles=s;for(const o in this._timers)clearTimeout(this._timers[o]),delete this._timers[o];for(const o in this._tiles)this._setTileReloadTimer(o,this._tiles[o])}}_updateCoveredAndRetainedTiles(e,i,s,o,u,f){const g={},y={},x=Object.keys(e),T=Pe.now();for(const M of x){const S=e[M],z=this._tiles[M];if(!z||z.fadeEndTime!==0&&z.fadeEndTime<=T)continue;const R=this.findLoadedParent(S,i),V=this.findLoadedSibling(S),j=R||V||null;j&&(this._addTile(j.tileID),g[j.tileID.key]=j.tileID),y[M]=S}this._retainLoadedChildren(y,o,s,e);for(const M in g)e[M]||(this._coveredTiles[M]=!0,e[M]=g[M]);if(f){const M={},S={};for(const z of u)this._tiles[z.key].hasData()?M[z.key]=z:S[z.key]=z;for(const z in S){const R=S[z].children(this._source.maxzoom);this._tiles[R[0].key]&&this._tiles[R[1].key]&&this._tiles[R[2].key]&&this._tiles[R[3].key]&&(M[R[0].key]=e[R[0].key]=R[0],M[R[1].key]=e[R[1].key]=R[1],M[R[2].key]=e[R[2].key]=R[2],M[R[3].key]=e[R[3].key]=R[3],delete S[z])}for(const z in S){const R=S[z],V=this.findLoadedParent(R,this._source.minzoom),j=this.findLoadedSibling(R),N=V||j||null;if(N){M[N.tileID.key]=e[N.tileID.key]=N.tileID;for(const $ in M)M[$].isChildOf(N.tileID)&&delete M[$]}}for(const z in this._tiles)M[z]||(this._coveredTiles[z]=!0)}}update(e,i){if(!this._sourceLoaded||this._paused)return;let s;this.transform=e,this.terrain=i,this.updateCacheSize(e),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?s=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(T=>new c.Y(T.canonical.z,T.wrap,T.canonical.z,T.canonical.x,T.canonical.y)):(s=se(e,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:i,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(s=s.filter(T=>this._source.hasTile(T)))):s=[];const o=hi(e,this._source),u=Math.max(o-P.maxOverzooming,this._source.minzoom),f=Math.max(o+P.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const T={};for(const M of s)if(M.canonical.z>this._source.minzoom){const S=M.scaledTo(M.canonical.z-1);T[S.key]=S;const z=M.scaledTo(Math.max(this._source.minzoom,Math.min(M.canonical.z,5)));T[z.key]=z}s=s.concat(Object.values(T))}const g=s.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,g&&this.fire(new c.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const y=this._updateRetainedTiles(s,o);O(this._source.type)&&this._updateCoveredAndRetainedTiles(y,u,f,o,s,i);for(const T in y)this._tiles[T].clearFadeHold();const x=c.ae(this._tiles,y);for(const T of x){const M=this._tiles[T];M.hasSymbolBuckets&&!M.holdingForFade()?M.setHoldDuration(this.map._fadeDuration):M.hasSymbolBuckets&&!M.symbolFadeFinished()||this._removeTile(T)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(e)}_updateRetainedTiles(e,i){var s;const o={},u={},f=Math.max(i-P.maxOverzooming,this._source.minzoom),g=Math.max(i+P.maxUnderzooming,this._source.minzoom),y={};for(const x of e){const T=this._addTile(x);o[x.key]=x,T.hasData()||i<this._source.maxzoom&&(y[x.key]=x)}this._retainLoadedChildren(y,i,g,o);for(const x of e){let T=this._tiles[x.key];if(T.hasData())continue;if(i+1>this._source.maxzoom){const S=x.children(this._source.maxzoom)[0],z=this.getTile(S);if(z&&z.hasData()){o[S.key]=S;continue}}else{const S=x.children(this._source.maxzoom);if(o[S[0].key]&&o[S[1].key]&&o[S[2].key]&&o[S[3].key])continue}let M=T.wasRequested();for(let S=x.overscaledZ-1;S>=f;--S){const z=x.scaledTo(S);if(u[z.key])break;if(u[z.key]=!0,T=this.getTile(z),!T&&M&&(T=this._addTile(z)),T){const R=T.hasData();if((R||!(!((s=this.map)===null||s===void 0)&&s.cancelPendingTileRequestsWhileZooming)||M)&&(o[z.key]=z),M=T.wasRequested(),R)break}}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const i=[];let s,o=this._tiles[e].tileID;for(;o.overscaledZ>0;){if(o.key in this._loadedParentTiles){s=this._loadedParentTiles[o.key];break}i.push(o.key);const u=o.scaledTo(o.overscaledZ-1);if(s=this._getLoadedTile(u),s)break;o=u}for(const u of i)this._loadedParentTiles[u]=s}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const e in this._tiles){const i=this._tiles[e].tileID,s=this._getLoadedTile(i);this._loadedSiblingTiles[i.key]=s}}_addTile(e){let i=this._tiles[e.key];if(i)return i;i=this._cache.getAndRemove(e),i&&(this._setTileReloadTimer(e.key,i),i.tileID=e,this._state.initializeTileState(i,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,i)));const s=i;return i||(i=new Ii(e,this._source.tileSize*e.overscaleFactor()),this._loadTile(i,e.key,i.state)),i.uses++,this._tiles[e.key]=i,s||this._source.fire(new c.l("dataloading",{tile:i,coord:i.tileID,dataType:"source"})),i}_setTileReloadTimer(e,i){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const s=i.getExpiryTimeout();s&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},s))}_removeTile(e){const i=this._tiles[e];i&&(i.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),i.uses>0||(i.hasData()&&i.state!=="reloading"?this._cache.add(i.tileID,i,i.getExpiryTimeout()):(i.aborted=!0,this._abortTile(i),this._unloadTile(i))))}_dataHandler(e){const i=e.sourceDataType;e.dataType==="source"&&i==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&e.dataType==="source"&&i==="content"&&(this.reload(e.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(e);this._cache.reset()}tilesIn(e,i,s){const o=[],u=this.transform;if(!u)return o;const f=s?u.getCameraQueryGeometry(e):e,g=e.map(R=>u.screenPointToMercatorCoordinate(R,this.terrain)),y=f.map(R=>u.screenPointToMercatorCoordinate(R,this.terrain)),x=this.getIds();let T=1/0,M=1/0,S=-1/0,z=-1/0;for(const R of y)T=Math.min(T,R.x),M=Math.min(M,R.y),S=Math.max(S,R.x),z=Math.max(z,R.y);for(let R=0;R<x.length;R++){const V=this._tiles[x[R]];if(V.holdingForFade())continue;const j=V.tileID,N=Math.pow(2,u.zoom-V.tileID.overscaledZ),$=i*V.queryPadding*c.Z/V.tileSize/N,W=[j.getTilePoint(new c.$(T,M)),j.getTilePoint(new c.$(S,z))];if(W[0].x-$<c.Z&&W[0].y-$<c.Z&&W[1].x+$>=0&&W[1].y+$>=0){const X=g.map(ie=>j.getTilePoint(ie)),J=y.map(ie=>j.getTilePoint(ie));o.push({tile:V,tileID:j,queryGeometry:X,cameraQueryGeometry:J,scale:N})}}return o}getVisibleCoordinates(e){const i=this.getRenderableIds(e).map(s=>this._tiles[s].tileID);return this.transform&&this.transform.populateCache(i),i}hasTransition(){if(this._source.hasTransition())return!0;if(O(this._source.type)){const e=Pe.now();for(const i in this._tiles)if(this._tiles[i].fadeEndTime>=e)return!0}return!1}setFeatureState(e,i,s){this._state.updateState(e=e||"_geojsonTileLayer",i,s)}removeFeatureState(e,i,s){this._state.removeFeatureState(e=e||"_geojsonTileLayer",i,s)}getFeatureState(e,i){return this._state.getState(e=e||"_geojsonTileLayer",i)}setDependencies(e,i,s){const o=this._tiles[e];o&&o.setDependencies(i,s)}reloadTilesForDependencies(e,i){for(const s in this._tiles)this._tiles[s].hasDependency(e,i)&&this._reloadTile(s,"reloading");this._cache.filter(s=>!s.hasDependency(e,i))}}function L(h,e){const i=Math.abs(2*h.wrap)-+(h.wrap<0),s=Math.abs(2*e.wrap)-+(e.wrap<0);return h.overscaledZ-e.overscaledZ||s-i||e.canonical.y-h.canonical.y||e.canonical.x-h.canonical.x}function O(h){return h==="raster"||h==="image"||h==="video"}P.maxOverzooming=10,P.maxUnderzooming=3;class Z{constructor(e,i){this.reset(e,i)}reset(e,i){this.points=e||[],this._distances=[0];for(let s=1;s<this.points.length;s++)this._distances[s]=this._distances[s-1]+this.points[s].dist(this.points[s-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(i||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=c.ad(e,0,1);let i=1,s=this._distances[i];const o=e*this.paddedLength+this.padding;for(;s<o&&i<this._distances.length;)s=this._distances[++i];const u=i-1,f=this._distances[u],g=s-f,y=g>0?(o-f)/g:0;return this.points[u].mult(1-y).add(this.points[i].mult(y))}}function K(h,e){let i=!0;return h==="always"||h!=="never"&&e!=="never"||(i=!1),i}class ne{constructor(e,i,s){const o=this.boxCells=[],u=this.circleCells=[];this.xCellCount=Math.ceil(e/s),this.yCellCount=Math.ceil(i/s);for(let f=0;f<this.xCellCount*this.yCellCount;f++)o.push([]),u.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=i,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/i,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,i,s,o,u){this._forEachCell(i,s,o,u,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(i),this.bboxes.push(s),this.bboxes.push(o),this.bboxes.push(u)}insertCircle(e,i,s,o){this._forEachCell(i-o,s-o,i+o,s+o,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(i),this.circles.push(s),this.circles.push(o)}_insertBoxCell(e,i,s,o,u,f){this.boxCells[u].push(f)}_insertCircleCell(e,i,s,o,u,f){this.circleCells[u].push(f)}_query(e,i,s,o,u,f,g){if(s<0||e>this.width||o<0||i>this.height)return[];const y=[];if(e<=0&&i<=0&&this.width<=s&&this.height<=o){if(u)return[{key:null,x1:e,y1:i,x2:s,y2:o}];for(let x=0;x<this.boxKeys.length;x++)y.push({key:this.boxKeys[x],x1:this.bboxes[4*x],y1:this.bboxes[4*x+1],x2:this.bboxes[4*x+2],y2:this.bboxes[4*x+3]});for(let x=0;x<this.circleKeys.length;x++){const T=this.circles[3*x],M=this.circles[3*x+1],S=this.circles[3*x+2];y.push({key:this.circleKeys[x],x1:T-S,y1:M-S,x2:T+S,y2:M+S})}}else this._forEachCell(e,i,s,o,this._queryCell,y,{hitTest:u,overlapMode:f,seenUids:{box:{},circle:{}}},g);return y}query(e,i,s,o){return this._query(e,i,s,o,!1,null)}hitTest(e,i,s,o,u,f){return this._query(e,i,s,o,!0,u,f).length>0}hitTestCircle(e,i,s,o,u){const f=e-s,g=e+s,y=i-s,x=i+s;if(g<0||f>this.width||x<0||y>this.height)return!1;const T=[];return this._forEachCell(f,y,g,x,this._queryCellCircle,T,{hitTest:!0,overlapMode:o,circle:{x:e,y:i,radius:s},seenUids:{box:{},circle:{}}},u),T.length>0}_queryCell(e,i,s,o,u,f,g,y){const{seenUids:x,hitTest:T,overlapMode:M}=g,S=this.boxCells[u];if(S!==null){const R=this.bboxes;for(const V of S)if(!x.box[V]){x.box[V]=!0;const j=4*V,N=this.boxKeys[V];if(e<=R[j+2]&&i<=R[j+3]&&s>=R[j+0]&&o>=R[j+1]&&(!y||y(N))&&(!T||!K(M,N.overlapMode))&&(f.push({key:N,x1:R[j],y1:R[j+1],x2:R[j+2],y2:R[j+3]}),T))return!0}}const z=this.circleCells[u];if(z!==null){const R=this.circles;for(const V of z)if(!x.circle[V]){x.circle[V]=!0;const j=3*V,N=this.circleKeys[V];if(this._circleAndRectCollide(R[j],R[j+1],R[j+2],e,i,s,o)&&(!y||y(N))&&(!T||!K(M,N.overlapMode))){const $=R[j],W=R[j+1],X=R[j+2];if(f.push({key:N,x1:$-X,y1:W-X,x2:$+X,y2:W+X}),T)return!0}}}return!1}_queryCellCircle(e,i,s,o,u,f,g,y){const{circle:x,seenUids:T,overlapMode:M}=g,S=this.boxCells[u];if(S!==null){const R=this.bboxes;for(const V of S)if(!T.box[V]){T.box[V]=!0;const j=4*V,N=this.boxKeys[V];if(this._circleAndRectCollide(x.x,x.y,x.radius,R[j+0],R[j+1],R[j+2],R[j+3])&&(!y||y(N))&&!K(M,N.overlapMode))return f.push(!0),!0}}const z=this.circleCells[u];if(z!==null){const R=this.circles;for(const V of z)if(!T.circle[V]){T.circle[V]=!0;const j=3*V,N=this.circleKeys[V];if(this._circlesCollide(R[j],R[j+1],R[j+2],x.x,x.y,x.radius)&&(!y||y(N))&&!K(M,N.overlapMode))return f.push(!0),!0}}}_forEachCell(e,i,s,o,u,f,g,y){const x=this._convertToXCellCoord(e),T=this._convertToYCellCoord(i),M=this._convertToXCellCoord(s),S=this._convertToYCellCoord(o);for(let z=x;z<=M;z++)for(let R=T;R<=S;R++)if(u.call(this,e,i,s,o,this.xCellCount*R+z,f,g,y))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,i,s,o,u,f){const g=o-e,y=u-i,x=s+f;return x*x>g*g+y*y}_circleAndRectCollide(e,i,s,o,u,f,g){const y=(f-o)/2,x=Math.abs(e-(o+y));if(x>y+s)return!1;const T=(g-u)/2,M=Math.abs(i-(u+T));if(M>T+s)return!1;if(x<=y||M<=T)return!0;const S=x-y,z=M-T;return S*S+z*z<=s*s}}function ue(h,e,i){const s=c.K();if(!h){const{vecSouth:M,vecEast:S}=ye(e),z=He();z[0]=S[0],z[1]=S[1],z[2]=M[0],z[3]=M[1],o=z,(T=(f=(u=z)[0])*(x=u[3])-(y=u[2])*(g=u[1]))&&(o[0]=x*(T=1/T),o[1]=-g*T,o[2]=-y*T,o[3]=f*T),s[0]=z[0],s[1]=z[1],s[4]=z[2],s[5]=z[3]}var o,u,f,g,y,x,T;return c.M(s,s,[1/i,1/i,1]),s}function re(h,e,i,s){if(h){const o=c.K();if(!e){const{vecSouth:u,vecEast:f}=ye(i);o[0]=f[0],o[1]=f[1],o[4]=u[0],o[5]=u[1]}return c.M(o,o,[s,s,1]),o}return i.pixelsToClipSpaceMatrix}function ye(h){const e=Math.cos(h.rollInRadians),i=Math.sin(h.rollInRadians),s=Math.cos(h.pitchInRadians),o=Math.cos(h.bearingInRadians),u=Math.sin(h.bearingInRadians),f=c.aj();f[0]=-o*s*i-u*e,f[1]=-u*s*i+o*e;const g=c.ak(f);g<1e-9?c.al(f):c.am(f,f,1/g);const y=c.aj();y[0]=o*s*e-u*i,y[1]=u*s*e+o*i;const x=c.ak(y);return x<1e-9?c.al(y):c.am(y,y,1/x),{vecEast:y,vecSouth:f}}function me(h,e,i,s){let o;s?(o=[h,e,s(h,e),1],c.ao(o,o,i)):(o=[h,e,0,1],Ni(o,o,i));const u=o[3];return{point:new c.P(o[0]/u,o[1]/u),signedDistanceFromCamera:u,isOccluded:!1}}function le(h,e){return .5+h/e*.5}function Me(h,e){return h.x>=-e[0]&&h.x<=e[0]&&h.y>=-e[1]&&h.y<=e[1]}function ce(h,e,i,s,o,u,f,g,y,x,T,M,S){const z=i?h.textSizeData:h.iconSizeData,R=c.af(z,e.transform.zoom),V=[256/e.width*2+1,256/e.height*2+1],j=i?h.text.dynamicLayoutVertexArray:h.icon.dynamicLayoutVertexArray;j.clear();const N=h.lineVertexArray,$=i?h.text.placedSymbolArray:h.icon.placedSymbolArray,W=e.transform.width/e.transform.height;let X=!1;for(let J=0;J<$.length;J++){const ie=$.get(J);if(ie.hidden||ie.writingMode===c.ag.vertical&&!X){Bi(ie.numGlyphs,j);continue}X=!1;const Q=new c.P(ie.anchorX,ie.anchorY),de={getElevation:S,pitchedLabelPlaneMatrix:s,lineVertexArray:N,pitchWithMap:u,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:e.transform,tileAnchorPoint:Q,unwrappedTileID:y,width:x,height:T,translation:M},fe=It(ie.anchorX,ie.anchorY,de);if(!Me(fe.point,V)){Bi(ie.numGlyphs,j);continue}const xe=le(e.transform.cameraToCenterDistance,fe.signedDistanceFromCamera),we=c.ah(z,R,ie),ve=u?we*e.transform.getPitchedTextCorrection(ie.anchorX,ie.anchorY,y)/xe:we*xe,Le=_t({projectionContext:de,pitchedLabelPlaneMatrixInverse:o,symbol:ie,fontSize:ve,flip:!1,keepUpright:f,glyphOffsetArray:h.glyphOffsetArray,dynamicLayoutVertexArray:j,aspectRatio:W,rotateToLine:g});X=Le.useVertical,(Le.notEnoughRoom||X||Le.needsFlipping&&_t({projectionContext:de,pitchedLabelPlaneMatrixInverse:o,symbol:ie,fontSize:ve,flip:!0,keepUpright:f,glyphOffsetArray:h.glyphOffsetArray,dynamicLayoutVertexArray:j,aspectRatio:W,rotateToLine:g}).notEnoughRoom)&&Bi(ie.numGlyphs,j)}i?h.text.dynamicLayoutVertexBuffer.updateData(j):h.icon.dynamicLayoutVertexBuffer.updateData(j)}function Fe(h,e,i,s,o,u,f,g){const y=u.glyphStartIndex+u.numGlyphs,x=u.lineStartIndex,T=u.lineStartIndex+u.lineLength,M=e.getoffsetX(u.glyphStartIndex),S=e.getoffsetX(y-1),z=ct(h*M,i,s,o,u.segment,x,T,g,f);if(!z)return null;const R=ct(h*S,i,s,o,u.segment,x,T,g,f);return R?g.projectionCache.anyProjectionOccluded?null:{first:z,last:R}:null}function Ke(h,e,i,s){return h===c.ag.horizontal&&Math.abs(i.y-e.y)>Math.abs(i.x-e.x)*s?{useVertical:!0}:(h===c.ag.vertical?e.y<i.y:e.x>i.x)?{needsFlipping:!0}:null}function _t(h){const{projectionContext:e,pitchedLabelPlaneMatrixInverse:i,symbol:s,fontSize:o,flip:u,keepUpright:f,glyphOffsetArray:g,dynamicLayoutVertexArray:y,aspectRatio:x,rotateToLine:T}=h,M=o/24,S=s.lineOffsetX*M,z=s.lineOffsetY*M;let R;if(s.numGlyphs>1){const V=s.glyphStartIndex+s.numGlyphs,j=s.lineStartIndex,N=s.lineStartIndex+s.lineLength,$=Fe(M,g,S,z,u,s,T,e);if(!$)return{notEnoughRoom:!0};const W=We($.first.point.x,$.first.point.y,e,i),X=We($.last.point.x,$.last.point.y,e,i);if(f&&!u){const J=Ke(s.writingMode,W,X,x);if(J)return J}R=[$.first];for(let J=s.glyphStartIndex+1;J<V-1;J++)R.push(ct(M*g.getoffsetX(J),S,z,u,s.segment,j,N,e,T));R.push($.last)}else{if(f&&!u){const j=Je(e.tileAnchorPoint.x,e.tileAnchorPoint.y,e).point,N=s.lineStartIndex+s.segment+1,$=new c.P(e.lineVertexArray.getx(N),e.lineVertexArray.gety(N)),W=Je($.x,$.y,e),X=W.signedDistanceFromCamera>0?W.point:ut(e.tileAnchorPoint,$,j,1,e),J=We(j.x,j.y,e,i),ie=We(X.x,X.y,e,i),Q=Ke(s.writingMode,J,ie,x);if(Q)return Q}const V=ct(M*g.getoffsetX(s.glyphStartIndex),S,z,u,s.segment,s.lineStartIndex,s.lineStartIndex+s.lineLength,e,T);if(!V||e.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};R=[V]}for(const V of R)c.an(y,V.point,V.angle);return{}}function ut(h,e,i,s,o){const u=h.add(h.sub(e)._unit()),f=Je(u.x,u.y,o).point,g=i.sub(f);return i.add(g._mult(s/g.mag()))}function be(h,e,i){const s=e.projectionCache;if(s.projections[h])return s.projections[h];const o=new c.P(e.lineVertexArray.getx(h),e.lineVertexArray.gety(h)),u=Je(o.x,o.y,e);if(u.signedDistanceFromCamera>0)return s.projections[h]=u.point,s.anyProjectionOccluded=s.anyProjectionOccluded||u.isOccluded,u.point;const f=h-i.direction;return ut(i.distanceFromAnchor===0?e.tileAnchorPoint:new c.P(e.lineVertexArray.getx(f),e.lineVertexArray.gety(f)),o,i.previousVertex,i.absOffsetX-i.distanceFromAnchor+1,e)}function Je(h,e,i){const s=h+i.translation[0],o=e+i.translation[1];let u;return i.pitchWithMap?(u=me(s,o,i.pitchedLabelPlaneMatrix,i.getElevation),u.isOccluded=!1):(u=i.transform.projectTileCoordinates(s,o,i.unwrappedTileID,i.getElevation),u.point.x=(.5*u.point.x+.5)*i.width,u.point.y=(.5*-u.point.y+.5)*i.height),u}function We(h,e,i,s){if(i.pitchWithMap){const o=[h,e,0,1];return c.ao(o,o,s),i.transform.projectTileCoordinates(o[0]/o[3],o[1]/o[3],i.unwrappedTileID,i.getElevation).point}return{x:h/i.width*2-1,y:e/i.height*2-1}}function It(h,e,i){return i.transform.projectTileCoordinates(h,e,i.unwrappedTileID,i.getElevation)}function yt(h,e,i){return h._unit()._perp()._mult(e*i)}function Et(h,e,i,s,o,u,f,g,y){if(g.projectionCache.offsets[h])return g.projectionCache.offsets[h];const x=i.add(e);if(h+y.direction<s||h+y.direction>=o)return g.projectionCache.offsets[h]=x,x;const T=be(h+y.direction,g,y),M=yt(T.sub(i),f,y.direction),S=i.add(M),z=T.add(M);return g.projectionCache.offsets[h]=c.ap(u,x,S,z)||x,g.projectionCache.offsets[h]}function ct(h,e,i,s,o,u,f,g,y){const x=s?h-e:h+e;let T=x>0?1:-1,M=0;s&&(T*=-1,M=Math.PI),T<0&&(M+=Math.PI);let S,z=T>0?u+o:u+o+1;g.projectionCache.cachedAnchorPoint?S=g.projectionCache.cachedAnchorPoint:(S=Je(g.tileAnchorPoint.x,g.tileAnchorPoint.y,g).point,g.projectionCache.cachedAnchorPoint=S);let R,V,j=S,N=S,$=0,W=0;const X=Math.abs(x),J=[];let ie;for(;$+W<=X;){if(z+=T,z<u||z>=f)return null;$+=W,N=j,V=R;const fe={absOffsetX:X,direction:T,distanceFromAnchor:$,previousVertex:N};if(j=be(z,g,fe),i===0)J.push(N),ie=j.sub(N);else{let xe;const we=j.sub(N);xe=we.mag()===0?yt(be(z+T,g,fe).sub(j),i,T):yt(we,i,T),V||(V=N.add(xe)),R=Et(z,xe,j,u,f,V,i,g,fe),J.push(V),ie=R.sub(V)}W=ie.mag()}const Q=ie._mult((X-$)/W)._add(V||N),de=M+Math.atan2(j.y-N.y,j.x-N.x);return J.push(Q),{point:Q,angle:y?de:0,path:J}}const Ln=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Bi(h,e){for(let i=0;i<h;i++){const s=e.length;e.resize(s+4),e.float32.set(Ln,3*s)}}function Ni(h,e,i){const s=e[0],o=e[1];return h[0]=i[0]*s+i[4]*o+i[12],h[1]=i[1]*s+i[5]*o+i[13],h[3]=i[3]*s+i[7]*o+i[15],h}const pi=100;class hs{constructor(e,i=new ne(e.width+200,e.height+200,25),s=new ne(e.width+200,e.height+200,25)){this.transform=e,this.grid=i,this.ignoredGrid=s,this.pitchFactor=Math.cos(e.pitch*Math.PI/180)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+pi,this.screenBottomBoundary=e.height+pi,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(e,i,s,o,u,f,g,y,x,T,M,S){const z=this.projectAndGetPerspectiveRatio(e.anchorPointX+y[0],e.anchorPointY+y[1],u,T,S),R=s*z.perspectiveRatio;let V;if(f||g)V=this._projectCollisionBox(e,R,o,u,f,g,y,z,T,M,S);else{const ie=z.x+(M?M.x*R:0),Q=z.y+(M?M.y*R:0);V={allPointsOccluded:!1,box:[ie+e.x1*R,Q+e.y1*R,ie+e.x2*R,Q+e.y2*R]}}const[j,N,$,W]=V.box,X=f?V.allPointsOccluded:z.isOccluded;let J=X;return J||(J=z.perspectiveRatio<this.perspectiveRatioCutoff),J||(J=!this.isInsideGrid(j,N,$,W)),J||i!=="always"&&this.grid.hitTest(j,N,$,W,i,x)?{box:[j,N,$,W],placeable:!1,offscreen:!1,occluded:X}:{box:[j,N,$,W],placeable:!0,offscreen:this.isOffscreen(j,N,$,W),occluded:X}}placeCollisionCircles(e,i,s,o,u,f,g,y,x,T,M,S,z,R){const V=[],j=new c.P(i.anchorX,i.anchorY),N=this.getPerspectiveRatio(j.x,j.y,f,R),$=(x?u*this.transform.getPitchedTextCorrection(i.anchorX,i.anchorY,f)/N:u*N)/c.au,W={getElevation:R,pitchedLabelPlaneMatrix:g,lineVertexArray:s,pitchWithMap:x,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:j,unwrappedTileID:f,width:this.transform.width,height:this.transform.height,translation:z},X=Fe($,o,i.lineOffsetX*$,i.lineOffsetY*$,!1,i,!1,W);let J=!1,ie=!1,Q=!0;if(X){const de=.5*M*N+S,fe=new c.P(-100,-100),xe=new c.P(this.screenRightBoundary,this.screenBottomBoundary),we=new Z,ve=X.first,Le=X.last;let Re=[];for(let ot=ve.path.length-1;ot>=1;ot--)Re.push(ve.path[ot]);for(let ot=1;ot<Le.path.length;ot++)Re.push(Le.path[ot]);const Ce=2.5*de;if(x){const ot=this.projectPathToScreenSpace(Re,W);Re=ot.some(Ht=>Ht.signedDistanceFromCamera<=0)?[]:ot.map(Ht=>Ht.point)}let it=[];if(Re.length>0){const ot=Re[0].clone(),Ht=Re[0].clone();for(let ui=1;ui<Re.length;ui++)ot.x=Math.min(ot.x,Re[ui].x),ot.y=Math.min(ot.y,Re[ui].y),Ht.x=Math.max(Ht.x,Re[ui].x),Ht.y=Math.max(Ht.y,Re[ui].y);it=ot.x>=fe.x&&Ht.x<=xe.x&&ot.y>=fe.y&&Ht.y<=xe.y?[Re]:Ht.x<fe.x||ot.x>xe.x||Ht.y<fe.y||ot.y>xe.y?[]:c.aq([Re],fe.x,fe.y,xe.x,xe.y)}for(const ot of it){we.reset(ot,.25*de);let Ht=0;Ht=we.length<=.5*de?1:Math.ceil(we.paddedLength/Ce)+1;for(let ui=0;ui<Ht;ui++){const ri=ui/Math.max(Ht-1,1),yi=we.lerp(ri),fi=yi.x+pi,Xt=yi.y+pi;V.push(fi,Xt,de,0);const ni=fi-de,Ki=Xt-de,Yi=fi+de,Zi=Xt+de;if(Q=Q&&this.isOffscreen(ni,Ki,Yi,Zi),ie=ie||this.isInsideGrid(ni,Ki,Yi,Zi),e!=="always"&&this.grid.hitTestCircle(fi,Xt,de,e,T)&&(J=!0,!y))return{circles:[],offscreen:!1,collisionDetected:J}}}}return{circles:!y&&J||!ie||N<this.perspectiveRatioCutoff?[]:V,offscreen:Q,collisionDetected:J}}projectPathToScreenSpace(e,i){const s=function(o,u){const f=c.K();return c.ai(f,u.pitchedLabelPlaneMatrix),o.map(g=>{const y=me(g.x,g.y,f,u.getElevation),x=u.transform.projectTileCoordinates(y.point.x,y.point.y,u.unwrappedTileID,u.getElevation);return x.point.x=(.5*x.point.x+.5)*u.width,x.point.y=(.5*-x.point.y+.5)*u.height,x})}(e,i);return function(o){let u=0,f=0,g=0,y=0;for(let x=0;x<o.length;x++)o[x].isOccluded?(g=x+1,y=0):(y++,y>f&&(f=y,u=g));return o.slice(u,u+f)}(s)}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const i=[];let s=1/0,o=1/0,u=-1/0,f=-1/0;for(const T of e){const M=new c.P(T.x+pi,T.y+pi);s=Math.min(s,M.x),o=Math.min(o,M.y),u=Math.max(u,M.x),f=Math.max(f,M.y),i.push(M)}const g=this.grid.query(s,o,u,f).concat(this.ignoredGrid.query(s,o,u,f)),y={},x={};for(const T of g){const M=T.key;if(y[M.bucketInstanceId]===void 0&&(y[M.bucketInstanceId]={}),y[M.bucketInstanceId][M.featureIndex])continue;const S=[new c.P(T.x1,T.y1),new c.P(T.x2,T.y1),new c.P(T.x2,T.y2),new c.P(T.x1,T.y2)];c.ar(i,S)&&(y[M.bucketInstanceId][M.featureIndex]=!0,x[M.bucketInstanceId]===void 0&&(x[M.bucketInstanceId]=[]),x[M.bucketInstanceId].push(M.featureIndex))}return x}insertCollisionBox(e,i,s,o,u,f){(s?this.ignoredGrid:this.grid).insert({bucketInstanceId:o,featureIndex:u,collisionGroupID:f,overlapMode:i},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,i,s,o,u,f){const g=s?this.ignoredGrid:this.grid,y={bucketInstanceId:o,featureIndex:u,collisionGroupID:f,overlapMode:i};for(let x=0;x<e.length;x+=4)g.insertCircle(y,e[x],e[x+1],e[x+2])}projectAndGetPerspectiveRatio(e,i,s,o,u){if(u){let f;o?(f=[e,i,o(e,i),1],c.ao(f,f,u)):(f=[e,i,0,1],Ni(f,f,u));const g=f[3];return{x:(f[0]/g+1)/2*this.transform.width+pi,y:(-f[1]/g+1)/2*this.transform.height+pi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/g*.5,isOccluded:!1,signedDistanceFromCamera:g}}{const f=this.transform.projectTileCoordinates(e,i,s,o);return{x:(f.point.x+1)/2*this.transform.width+pi,y:(1-f.point.y)/2*this.transform.height+pi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/f.signedDistanceFromCamera*.5,isOccluded:f.isOccluded,signedDistanceFromCamera:f.signedDistanceFromCamera}}}getPerspectiveRatio(e,i,s,o){const u=this.transform.projectTileCoordinates(e,i,s,o);return .5+this.transform.cameraToCenterDistance/u.signedDistanceFromCamera*.5}isOffscreen(e,i,s,o){return s<pi||e>=this.screenRightBoundary||o<pi||i>this.screenBottomBoundary}isInsideGrid(e,i,s,o){return s>=0&&e<this.gridRightBoundary&&o>=0&&i<this.gridBottomBoundary}getViewportMatrix(){const e=c.as([]);return c.L(e,e,[-100,-100,0]),e}_projectCollisionBox(e,i,s,o,u,f,g,y,x,T,M){let S=1,z=0,R=0,V=1;const j=e.anchorPointX+g[0],N=e.anchorPointY+g[1];if(f&&!u){const Re=this.projectAndGetPerspectiveRatio(j+1,N,o,x,M),Ce=Re.x-y.x,it=Math.atan((Re.y-y.y)/Ce)+(Ce<0?Math.PI:0),ot=Math.sin(it),Ht=Math.cos(it);S=Ht,z=ot,R=-ot,V=Ht}else if(!f&&u){const Re=ye(this.transform);S=Re.vecEast[0],z=Re.vecEast[1],R=Re.vecSouth[0],V=Re.vecSouth[1]}let $=y.x,W=y.y,X=i;u&&($=j,W=N,X=Math.pow(2,-(this.transform.zoom-s.overscaledZ)),X*=this.transform.getPitchedTextCorrection(j,N,o),T||(X*=c.ad(.5+y.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),T&&($+=S*T.x*X+R*T.y*X,W+=z*T.x*X+V*T.y*X);const J=e.x1*X,ie=e.x2*X,Q=(J+ie)/2,de=e.y1*X,fe=e.y2*X,xe=(de+fe)/2,we=[{offsetX:J,offsetY:de},{offsetX:Q,offsetY:de},{offsetX:ie,offsetY:de},{offsetX:ie,offsetY:xe},{offsetX:ie,offsetY:fe},{offsetX:Q,offsetY:fe},{offsetX:J,offsetY:fe},{offsetX:J,offsetY:xe}];let ve=[];for(const{offsetX:Re,offsetY:Ce}of we)ve.push(new c.P($+S*Re+R*Ce,W+z*Re+V*Ce));let Le=!1;if(u){const Re=ve.map(Ce=>this.projectAndGetPerspectiveRatio(Ce.x,Ce.y,o,x,M));Le=Re.some(Ce=>!Ce.isOccluded),ve=Re.map(Ce=>new c.P(Ce.x,Ce.y))}else Le=!0;return{box:c.at(ve),allPointsOccluded:!Le}}}class yr{constructor(e,i,s,o){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?i:-i))):o&&s?1:0,this.placed=s}isHidden(){return this.opacity===0&&!this.placed}}class si{constructor(e,i,s,o,u){this.text=new yr(e?e.text:null,i,s,u),this.icon=new yr(e?e.icon:null,i,o,u)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Ul{constructor(e,i,s){this.text=e,this.icon=i,this.skipFade=s}}class za{constructor(e,i,s,o,u){this.bucketInstanceId=e,this.featureIndex=i,this.sourceLayerIndex=s,this.bucketIndex=o,this.tileID=u}}class bo{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const i=++this.maxGroupID;this.collisionGroups[e]={ID:i,predicate:s=>s.collisionGroupID===i}}return this.collisionGroups[e]}}function Pn(h,e,i,s,o){const{horizontalAlign:u,verticalAlign:f}=c.aA(h);return new c.P(-(u-.5)*e+s[0]*o,-(f-.5)*i+s[1]*o)}class aa{constructor(e,i,s,o,u){this.transform=e.clone(),this.terrain=i,this.collisionIndex=new hs(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=s,this.retainedQueryData={},this.collisionGroups=new bo(o),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=u,u&&(u.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(e){const i=this.terrain;return i?(s,o)=>i.getElevation(e,s,o):null}getBucketParts(e,i,s,o){const u=s.getBucket(i),f=s.latestFeatureIndex;if(!u||!f||i.id!==u.layerIds[0])return;const g=s.collisionBoxArray,y=u.layers[0].layout,x=u.layers[0].paint,T=Math.pow(2,this.transform.zoom-s.tileID.overscaledZ),M=s.tileSize/c.Z,S=s.tileID.toUnwrapped(),z=y.get("text-rotation-alignment")==="map",R=c.av(s,1,this.transform.zoom),V=c.aw(this.collisionIndex.transform,s,x.get("text-translate"),x.get("text-translate-anchor")),j=c.aw(this.collisionIndex.transform,s,x.get("icon-translate"),x.get("icon-translate-anchor")),N=ue(z,this.transform,R);this.retainedQueryData[u.bucketInstanceId]=new za(u.bucketInstanceId,f,u.sourceLayerIndex,u.index,s.tileID);const $={bucket:u,layout:y,translationText:V,translationIcon:j,unwrappedTileID:S,pitchedLabelPlaneMatrix:N,scale:T,textPixelRatio:M,holdingForFade:s.holdingForFade(),collisionBoxArray:g,partiallyEvaluatedTextSize:c.af(u.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(u.sourceID)};if(o)for(const W of u.sortKeyRanges){const{sortKey:X,symbolInstanceStart:J,symbolInstanceEnd:ie}=W;e.push({sortKey:X,symbolInstanceStart:J,symbolInstanceEnd:ie,parameters:$})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:u.symbolInstances.length,parameters:$})}attemptAnchorPlacement(e,i,s,o,u,f,g,y,x,T,M,S,z,R,V,j,N,$,W,X){const J=c.ax[e.textAnchor],ie=[e.textOffset0,e.textOffset1],Q=Pn(J,s,o,ie,u),de=this.collisionIndex.placeCollisionBox(i,S,y,x,T,g,f,j,M.predicate,W,Q,X);if((!$||this.collisionIndex.placeCollisionBox($,S,y,x,T,g,f,N,M.predicate,W,Q,X).placeable)&&de.placeable){let fe;if(this.prevPlacement&&this.prevPlacement.variableOffsets[z.crossTileID]&&this.prevPlacement.placements[z.crossTileID]&&this.prevPlacement.placements[z.crossTileID].text&&(fe=this.prevPlacement.variableOffsets[z.crossTileID].anchor),z.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[z.crossTileID]={textOffset:ie,width:s,height:o,anchor:J,textBoxScale:u,prevAnchor:fe},this.markUsedJustification(R,J,z,V),R.allowVerticalPlacement&&(this.markUsedOrientation(R,V,z),this.placedOrientations[z.crossTileID]=V),{shift:Q,placedGlyphBoxes:de}}}placeLayerBucketPart(e,i,s){const{bucket:o,layout:u,translationText:f,translationIcon:g,unwrappedTileID:y,pitchedLabelPlaneMatrix:x,textPixelRatio:T,holdingForFade:M,collisionBoxArray:S,partiallyEvaluatedTextSize:z,collisionGroup:R}=e.parameters,V=u.get("text-optional"),j=u.get("icon-optional"),N=c.ay(u,"text-overlap","text-allow-overlap"),$=N==="always",W=c.ay(u,"icon-overlap","icon-allow-overlap"),X=W==="always",J=u.get("text-rotation-alignment")==="map",ie=u.get("text-pitch-alignment")==="map",Q=u.get("icon-text-fit")!=="none",de=u.get("symbol-z-order")==="viewport-y",fe=$&&(X||!o.hasIconData()||j),xe=X&&($||!o.hasTextData()||V);!o.collisionArrays&&S&&o.deserializeCollisionBoxes(S);const we=this.retainedQueryData[o.bucketInstanceId].tileID,ve=this._getTerrainElevationFunc(we),Le=this.transform.getFastPathSimpleProjectionMatrix(we),Re=(Ce,it,ot)=>{var Ht,ui;if(i[Ce.crossTileID])return;if(M)return void(this.placements[Ce.crossTileID]=new Ul(!1,!1,!1));let ri=!1,yi=!1,fi=!0,Xt=null,ni={box:null,placeable:!1,offscreen:null,occluded:!1},Ki={placeable:!1},Yi=null,Zi=null,nr=null,kn=0,yn=0,hn=0;it.textFeatureIndex?kn=it.textFeatureIndex:Ce.useRuntimeCollisionCircles&&(kn=Ce.featureIndex),it.verticalTextFeatureIndex&&(yn=it.verticalTextFeatureIndex);const $r=it.textBox;if($r){const Gr=di=>{let oi=c.ag.horizontal;if(o.allowVerticalPlacement&&!di&&this.prevPlacement){const Ui=this.prevPlacement.placedOrientations[Ce.crossTileID];Ui&&(this.placedOrientations[Ce.crossTileID]=Ui,oi=Ui,this.markUsedOrientation(o,oi,Ce))}return oi},un=(di,oi)=>{if(o.allowVerticalPlacement&&Ce.numVerticalGlyphVertices>0&&it.verticalTextBox){for(const Ui of o.writingModes)if(Ui===c.ag.vertical?(ni=oi(),Ki=ni):ni=di(),ni&&ni.placeable)break}else ni=di()},Jr=Ce.textAnchorOffsetStartIndex,dn=Ce.textAnchorOffsetEndIndex;if(dn===Jr){const di=(oi,Ui)=>{const $i=this.collisionIndex.placeCollisionBox(oi,N,T,we,y,ie,J,f,R.predicate,ve,void 0,Le);return $i&&$i.placeable&&(this.markUsedOrientation(o,Ui,Ce),this.placedOrientations[Ce.crossTileID]=Ui),$i};un(()=>di($r,c.ag.horizontal),()=>{const oi=it.verticalTextBox;return o.allowVerticalPlacement&&Ce.numVerticalGlyphVertices>0&&oi?di(oi,c.ag.vertical):{box:null,offscreen:null}}),Gr(ni&&ni.placeable)}else{let di=c.ax[(ui=(Ht=this.prevPlacement)===null||Ht===void 0?void 0:Ht.variableOffsets[Ce.crossTileID])===null||ui===void 0?void 0:ui.anchor];const oi=($i,Qn,zh)=>{const Dc=$i.x2-$i.x1,bl=$i.y2-$i.y1,Rc=Ce.textBoxScale,ea=Q&&W==="never"?Qn:null;let Ar=null,wl=N==="never"?1:2,Lc="never";di&&wl++;for(let eo=0;eo<wl;eo++){for(let to=Jr;to<dn;to++){const Fc=o.textAnchorOffsets.get(to);if(di&&Fc.textAnchor!==di)continue;const io=this.attemptAnchorPlacement(Fc,$i,Dc,bl,Rc,J,ie,T,we,y,R,Lc,Ce,o,zh,f,g,ea,ve);if(io&&(Ar=io.placedGlyphBoxes,Ar&&Ar.placeable))return ri=!0,Xt=io.shift,Ar}di?di=null:Lc=N}return s&&!Ar&&(Ar={box:this.collisionIndex.placeCollisionBox($r,"always",T,we,y,ie,J,f,R.predicate,ve,void 0,Le).box,offscreen:!1,placeable:!1,occluded:!1}),Ar};un(()=>oi($r,it.iconBox,c.ag.horizontal),()=>{const $i=it.verticalTextBox;return o.allowVerticalPlacement&&(!ni||!ni.placeable)&&Ce.numVerticalGlyphVertices>0&&$i?oi($i,it.verticalIconBox,c.ag.vertical):{box:null,occluded:!0,offscreen:null}}),ni&&(ri=ni.placeable,fi=ni.offscreen);const Ui=Gr(ni&&ni.placeable);if(!ri&&this.prevPlacement){const $i=this.prevPlacement.variableOffsets[Ce.crossTileID];$i&&(this.variableOffsets[Ce.crossTileID]=$i,this.markUsedJustification(o,$i.anchor,Ce,Ui))}}}if(Yi=ni,ri=Yi&&Yi.placeable,fi=Yi&&Yi.offscreen,Ce.useRuntimeCollisionCircles){const Gr=o.text.placedSymbolArray.get(Ce.centerJustifiedTextSymbolIndex),un=c.ah(o.textSizeData,z,Gr),Jr=u.get("text-padding");Zi=this.collisionIndex.placeCollisionCircles(N,Gr,o.lineVertexArray,o.glyphOffsetArray,un,y,x,s,ie,R.predicate,Ce.collisionCircleDiameter,Jr,f,ve),Zi.circles.length&&Zi.collisionDetected&&!s&&c.w("Collisions detected, but collision boxes are not shown"),ri=$||Zi.circles.length>0&&!Zi.collisionDetected,fi=fi&&Zi.offscreen}if(it.iconFeatureIndex&&(hn=it.iconFeatureIndex),it.iconBox){const Gr=un=>this.collisionIndex.placeCollisionBox(un,W,T,we,y,ie,J,g,R.predicate,ve,Q&&Xt?Xt:void 0,Le);Ki&&Ki.placeable&&it.verticalIconBox?(nr=Gr(it.verticalIconBox),yi=nr.placeable):(nr=Gr(it.iconBox),yi=nr.placeable),fi=fi&&nr.offscreen}const Yn=V||Ce.numHorizontalGlyphVertices===0&&Ce.numVerticalGlyphVertices===0,Ja=j||Ce.numIconVertices===0;Yn||Ja?Ja?Yn||(yi=yi&&ri):ri=yi&&ri:yi=ri=yi&&ri;const Jn=yi&&nr.placeable;if(ri&&Yi.placeable&&this.collisionIndex.insertCollisionBox(Yi.box,N,u.get("text-ignore-placement"),o.bucketInstanceId,Ki&&Ki.placeable&&yn?yn:kn,R.ID),Jn&&this.collisionIndex.insertCollisionBox(nr.box,W,u.get("icon-ignore-placement"),o.bucketInstanceId,hn,R.ID),Zi&&ri&&this.collisionIndex.insertCollisionCircles(Zi.circles,N,u.get("text-ignore-placement"),o.bucketInstanceId,kn,R.ID),s&&this.storeCollisionData(o.bucketInstanceId,ot,it,Yi,nr,Zi),Ce.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(o.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Ce.crossTileID]=new Ul((ri||fe)&&!(Yi!=null&&Yi.occluded),(yi||xe)&&!(nr!=null&&nr.occluded),fi||o.justReloaded),i[Ce.crossTileID]=!0};if(de){if(e.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Ce=o.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let it=Ce.length-1;it>=0;--it){const ot=Ce[it];Re(o.symbolInstances.get(ot),o.collisionArrays[ot],ot)}}else for(let Ce=e.symbolInstanceStart;Ce<e.symbolInstanceEnd;Ce++)Re(o.symbolInstances.get(Ce),o.collisionArrays[Ce],Ce);o.justReloaded=!1}storeCollisionData(e,i,s,o,u,f){if(s.textBox||s.iconBox){let g,y;this.collisionBoxArrays.has(e)?g=this.collisionBoxArrays.get(e):(g=new Map,this.collisionBoxArrays.set(e,g)),g.has(i)?y=g.get(i):(y={text:null,icon:null},g.set(i,y)),s.textBox&&(y.text=o.box),s.iconBox&&(y.icon=u.box)}if(f){let g=this.collisionCircleArrays[e];g===void 0&&(g=this.collisionCircleArrays[e]=[]);for(let y=0;y<f.circles.length;y+=4)g.push(f.circles[y+0]-pi),g.push(f.circles[y+1]-pi),g.push(f.circles[y+2]),g.push(f.collisionDetected?1:0)}}markUsedJustification(e,i,s,o){let u;u=o===c.ag.vertical?s.verticalPlacedTextSymbolIndex:{left:s.leftJustifiedTextSymbolIndex,center:s.centerJustifiedTextSymbolIndex,right:s.rightJustifiedTextSymbolIndex}[c.az(i)];const f=[s.leftJustifiedTextSymbolIndex,s.centerJustifiedTextSymbolIndex,s.rightJustifiedTextSymbolIndex,s.verticalPlacedTextSymbolIndex];for(const g of f)g>=0&&(e.text.placedSymbolArray.get(g).crossTileID=u>=0&&g!==u?0:s.crossTileID)}markUsedOrientation(e,i,s){const o=i===c.ag.horizontal||i===c.ag.horizontalOnly?i:0,u=i===c.ag.vertical?i:0,f=[s.leftJustifiedTextSymbolIndex,s.centerJustifiedTextSymbolIndex,s.rightJustifiedTextSymbolIndex];for(const g of f)e.text.placedSymbolArray.get(g).placedOrientation=o;s.verticalPlacedTextSymbolIndex&&(e.text.placedSymbolArray.get(s.verticalPlacedTextSymbolIndex).placedOrientation=u)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const i=this.prevPlacement;let s=!1;this.prevZoomAdjustment=i?i.zoomAdjustment(this.transform.zoom):0;const o=i?i.symbolFadeChange(e):1,u=i?i.opacities:{},f=i?i.variableOffsets:{},g=i?i.placedOrientations:{};for(const y in this.placements){const x=this.placements[y],T=u[y];T?(this.opacities[y]=new si(T,o,x.text,x.icon),s=s||x.text!==T.text.placed||x.icon!==T.icon.placed):(this.opacities[y]=new si(null,o,x.text,x.icon,x.skipFade),s=s||x.text||x.icon)}for(const y in u){const x=u[y];if(!this.opacities[y]){const T=new si(x,o,!1,!1);T.isHidden()||(this.opacities[y]=T,s=s||x.text.placed||x.icon.placed)}}for(const y in f)this.variableOffsets[y]||!this.opacities[y]||this.opacities[y].isHidden()||(this.variableOffsets[y]=f[y]);for(const y in g)this.placedOrientations[y]||!this.opacities[y]||this.opacities[y].isHidden()||(this.placedOrientations[y]=g[y]);if(i&&i.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");s?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=i?i.lastPlacementChangeTime:e)}updateLayerOpacities(e,i){const s={};for(const o of i){const u=o.getBucket(e);u&&o.latestFeatureIndex&&e.id===u.layerIds[0]&&this.updateBucketOpacities(u,o.tileID,s,o.collisionBoxArray)}}updateBucketOpacities(e,i,s,o){e.hasTextData()&&(e.text.opacityVertexArray.clear(),e.text.hasVisibleVertices=!1),e.hasIconData()&&(e.icon.opacityVertexArray.clear(),e.icon.hasVisibleVertices=!1),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const u=e.layers[0],f=u.layout,g=new si(null,0,!1,!1,!0),y=f.get("text-allow-overlap"),x=f.get("icon-allow-overlap"),T=u._unevaluatedLayout.hasValue("text-variable-anchor")||u._unevaluatedLayout.hasValue("text-variable-anchor-offset"),M=f.get("text-rotation-alignment")==="map",S=f.get("text-pitch-alignment")==="map",z=f.get("icon-text-fit")!=="none",R=new si(null,0,y&&(x||!e.hasIconData()||f.get("icon-optional")),x&&(y||!e.hasTextData()||f.get("text-optional")),!0);!e.collisionArrays&&o&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(o);const V=(N,$,W)=>{for(let X=0;X<$/4;X++)N.opacityVertexArray.emplaceBack(W);N.hasVisibleVertices=N.hasVisibleVertices||W!==oa},j=this.collisionBoxArrays.get(e.bucketInstanceId);for(let N=0;N<e.symbolInstances.length;N++){const $=e.symbolInstances.get(N),{numHorizontalGlyphVertices:W,numVerticalGlyphVertices:X,crossTileID:J}=$;let ie=this.opacities[J];s[J]?ie=g:ie||(ie=R,this.opacities[J]=ie),s[J]=!0;const Q=$.numIconVertices>0,de=this.placedOrientations[$.crossTileID],fe=de===c.ag.vertical,xe=de===c.ag.horizontal||de===c.ag.horizontalOnly;if(W>0||X>0){const ve=To(ie.text);V(e.text,W,fe?oa:ve),V(e.text,X,xe?oa:ve);const Le=ie.text.isHidden();[$.rightJustifiedTextSymbolIndex,$.centerJustifiedTextSymbolIndex,$.leftJustifiedTextSymbolIndex].forEach(it=>{it>=0&&(e.text.placedSymbolArray.get(it).hidden=Le||fe?1:0)}),$.verticalPlacedTextSymbolIndex>=0&&(e.text.placedSymbolArray.get($.verticalPlacedTextSymbolIndex).hidden=Le||xe?1:0);const Re=this.variableOffsets[$.crossTileID];Re&&this.markUsedJustification(e,Re.anchor,$,de);const Ce=this.placedOrientations[$.crossTileID];Ce&&(this.markUsedJustification(e,"left",$,Ce),this.markUsedOrientation(e,Ce,$))}if(Q){const ve=To(ie.icon),Le=!(z&&$.verticalPlacedIconSymbolIndex&&fe);$.placedIconSymbolIndex>=0&&(V(e.icon,$.numIconVertices,Le?ve:oa),e.icon.placedSymbolArray.get($.placedIconSymbolIndex).hidden=ie.icon.isHidden()),$.verticalPlacedIconSymbolIndex>=0&&(V(e.icon,$.numVerticalIconVertices,Le?oa:ve),e.icon.placedSymbolArray.get($.verticalPlacedIconSymbolIndex).hidden=ie.icon.isHidden())}const we=j&&j.has(N)?j.get(N):{text:null,icon:null};if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const ve=e.collisionArrays[N];if(ve){let Le=new c.P(0,0);if(ve.textBox||ve.verticalTextBox){let Re=!0;if(T){const Ce=this.variableOffsets[J];Ce?(Le=Pn(Ce.anchor,Ce.width,Ce.height,Ce.textOffset,Ce.textBoxScale),M&&Le._rotate(S?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Re=!1}if(ve.textBox||ve.verticalTextBox){let Ce;ve.textBox&&(Ce=fe),ve.verticalTextBox&&(Ce=xe),wo(e.textCollisionBox.collisionVertexArray,ie.text.placed,!Re||Ce,we.text,Le.x,Le.y)}}if(ve.iconBox||ve.verticalIconBox){const Re=!!(!xe&&ve.verticalIconBox);let Ce;ve.iconBox&&(Ce=Re),ve.verticalIconBox&&(Ce=!Re),wo(e.iconCollisionBox.collisionVertexArray,ie.icon.placed,Ce,we.icon,z?Le.x:0,z?Le.y:0)}}}}if(e.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.text.opacityVertexArray.length!==e.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${e.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${e.text.layoutVertexArray.length}) / 4`);if(e.icon.opacityVertexArray.length!==e.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${e.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${e.icon.layoutVertexArray.length}) / 4`);e.bucketInstanceId in this.collisionCircleArrays&&(e.collisionCircleArray=this.collisionCircleArrays[e.bucketInstanceId],delete this.collisionCircleArrays[e.bucketInstanceId])}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,i){const s=this.zoomAtLastRecencyCheck===i?1-this.zoomAdjustment(i):1;return this.zoomAtLastRecencyCheck=i,this.commitTime+this.fadeDuration*s>e}setStale(){this.stale=!0}}function wo(h,e,i,s,o,u){s&&s.length!==0||(s=[0,0,0,0]);const f=s[0]-pi,g=s[1]-pi,y=s[2]-pi,x=s[3]-pi;h.emplaceBack(e?1:0,i?1:0,o||0,u||0,f,g),h.emplaceBack(e?1:0,i?1:0,o||0,u||0,y,g),h.emplaceBack(e?1:0,i?1:0,o||0,u||0,y,x),h.emplaceBack(e?1:0,i?1:0,o||0,u||0,f,x)}const $l=Math.pow(2,25),Gl=Math.pow(2,24),sa=Math.pow(2,17),ql=Math.pow(2,16),lh=Math.pow(2,9),ch=Math.pow(2,8),hh=Math.pow(2,1);function To(h){if(h.opacity===0&&!h.placed)return 0;if(h.opacity===1&&h.placed)return 4294967295;const e=h.placed?1:0,i=Math.floor(127*h.opacity);return i*$l+e*Gl+i*sa+e*ql+i*lh+e*ch+i*hh+e}const oa=0;class Po{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&!e.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(e,i,s,o,u){const f=this._bucketParts;for(;this._currentTileIndex<e.length;)if(i.getBucketParts(f,o,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,u())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,f.sort((g,y)=>g.sortKey-y.sortKey));this._currentPartIndex<f.length;)if(i.placeLayerBucketPart(f[this._currentPartIndex],this._seenCrossTileIDs,s),this._currentPartIndex++,u())return!0;return!1}}class Mo{constructor(e,i,s,o,u,f,g,y){this.placement=new aa(e,i,f,g,y),this._currentPlacementIndex=s.length-1,this._forceFullPlacement=o,this._showCollisionBoxes=u,this._done=!1}isDone(){return this._done}continuePlacement(e,i,s){const o=Pe.now(),u=()=>!this._forceFullPlacement&&Pe.now()-o>2;for(;this._currentPlacementIndex>=0;){const f=i[e[this._currentPlacementIndex]],g=this.placement.collisionIndex.transform.zoom;if(f.type==="symbol"&&(!f.minzoom||f.minzoom<=g)&&(!f.maxzoom||f.maxzoom>g)){if(this._inProgressLayer||(this._inProgressLayer=new Po(f)),this._inProgressLayer.continuePlacement(s[f.source],this.placement,this._showCollisionBoxes,f,u))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const la=512/c.Z/2;class So{constructor(e,i,s){this.tileID=e,this.bucketInstanceId=s,this._symbolsByKey={};const o=new Map;for(let u=0;u<i.length;u++){const f=i.get(u),g=f.key,y=o.get(g);y?y.push(f):o.set(g,[f])}for(const[u,f]of o){const g={positions:f.map(y=>({x:Math.floor(y.anchorX*la),y:Math.floor(y.anchorY*la)})),crossTileIDs:f.map(y=>y.crossTileID)};if(g.positions.length>128){const y=new c.aB(g.positions.length,16,Uint16Array);for(const{x,y:T}of g.positions)y.add(x,T);y.finish(),delete g.positions,g.index=y}this._symbolsByKey[u]=g}}getScaledCoordinates(e,i){const{x:s,y:o,z:u}=this.tileID.canonical,{x:f,y:g,z:y}=i.canonical,x=la/Math.pow(2,y-u),T=(g*c.Z+e.anchorY)*x,M=o*c.Z*la;return{x:Math.floor((f*c.Z+e.anchorX)*x-s*c.Z*la),y:Math.floor(T-M)}}findMatches(e,i,s){const o=this.tileID.canonical.z<i.canonical.z?1:Math.pow(2,this.tileID.canonical.z-i.canonical.z);for(let u=0;u<e.length;u++){const f=e.get(u);if(f.crossTileID)continue;const g=this._symbolsByKey[f.key];if(!g)continue;const y=this.getScaledCoordinates(f,i);if(g.index){const x=g.index.range(y.x-o,y.y-o,y.x+o,y.y+o).sort();for(const T of x){const M=g.crossTileIDs[T];if(!s[M]){s[M]=!0,f.crossTileID=M;break}}}else if(g.positions)for(let x=0;x<g.positions.length;x++){const T=g.positions[x],M=g.crossTileIDs[x];if(Math.abs(T.x-y.x)<=o&&Math.abs(T.y-y.y)<=o&&!s[M]){s[M]=!0,f.crossTileID=M;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:e})=>e)}}class Co{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class us{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const i=Math.round((e-this.lng)/360);if(i!==0)for(const s in this.indexes){const o=this.indexes[s],u={};for(const f in o){const g=o[f];g.tileID=g.tileID.unwrapTo(g.tileID.wrap+i),u[g.tileID.key]=g}this.indexes[s]=u}this.lng=e}addBucket(e,i,s){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===i.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let u=0;u<i.symbolInstances.length;u++)i.symbolInstances.get(u).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});const o=this.usedCrossTileIDs[e.overscaledZ];for(const u in this.indexes){const f=this.indexes[u];if(Number(u)>e.overscaledZ)for(const g in f){const y=f[g];y.tileID.isChildOf(e)&&y.findMatches(i.symbolInstances,e,o)}else{const g=f[e.scaledTo(Number(u)).key];g&&g.findMatches(i.symbolInstances,e,o)}}for(let u=0;u<i.symbolInstances.length;u++){const f=i.symbolInstances.get(u);f.crossTileID||(f.crossTileID=s.generate(),o[f.crossTileID]=!0)}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new So(e,i.symbolInstances,i.bucketInstanceId),!0}removeBucketCrossTileIDs(e,i){for(const s of i.getCrossTileIDsLists())for(const o of s)delete this.usedCrossTileIDs[e][o]}removeStaleBuckets(e){let i=!1;for(const s in this.indexes){const o=this.indexes[s];for(const u in o)e[o[u].bucketInstanceId]||(this.removeBucketCrossTileIDs(s,o[u]),delete o[u],i=!0)}return i}}class Io{constructor(){this.layerIndexes={},this.crossTileIDs=new Co,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,i,s){let o=this.layerIndexes[e.id];o===void 0&&(o=this.layerIndexes[e.id]=new us);let u=!1;const f={};o.handleWrapJump(s);for(const g of i){const y=g.getBucket(e);y&&e.id===y.layerIds[0]&&(y.bucketInstanceId||(y.bucketInstanceId=++this.maxBucketInstanceId),o.addBucket(g.tileID,y,this.crossTileIDs)&&(u=!0),f[y.bucketInstanceId]=!0)}return o.removeStaleBuckets(f)&&(u=!0),u}pruneUnusedLayers(e){const i={};e.forEach(s=>{i[s]=!0});for(const s in this.layerIndexes)i[s]||delete this.layerIndexes[s]}}var Fn="void main() {fragColor=vec4(1.0);}";const Xr={prelude:Ut(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Ut("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Ut("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Ut(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Ut(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Ut(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Ut(Fn,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Ut(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Ut(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Ut("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Ut("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Ut("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Ut(Fn,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Ut(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Ut(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Ut(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Ut(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Ut(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Ut(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Ut(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));fragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Ut(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Ut(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Ut(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Ut(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Ut(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Ut(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Ut(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Ut(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Ut(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Ut("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Ut("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Ut("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Ut("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Ut(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Ut("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Ut(h,e){const i=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,s=e.match(/in ([\w]+) ([\w]+)/g),o=h.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),u=e.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),f=u?u.concat(o):o,g={};return{fragmentSource:h=h.replace(i,(y,x,T,M,S)=>(g[S]=!0,x==="define"?`
#ifndef HAS_UNIFORM_u_${S}
in ${T} ${M} ${S};
#else
uniform ${T} ${M} u_${S};
#endif
`:`
#ifdef HAS_UNIFORM_u_${S}
    ${T} ${M} ${S} = u_${S};
#endif
`)),vertexSource:e=e.replace(i,(y,x,T,M,S)=>{const z=M==="float"?"vec2":"vec4",R=S.match(/color/)?"color":z;return g[S]?x==="define"?`
#ifndef HAS_UNIFORM_u_${S}
uniform lowp float u_${S}_t;
in ${T} ${z} a_${S};
out ${T} ${M} ${S};
#else
uniform ${T} ${M} u_${S};
#endif
`:R==="vec4"?`
#ifndef HAS_UNIFORM_u_${S}
    ${S} = a_${S};
#else
    ${T} ${M} ${S} = u_${S};
#endif
`:`
#ifndef HAS_UNIFORM_u_${S}
    ${S} = unpack_mix_${R}(a_${S}, u_${S}_t);
#else
    ${T} ${M} ${S} = u_${S};
#endif
`:x==="define"?`
#ifndef HAS_UNIFORM_u_${S}
uniform lowp float u_${S}_t;
in ${T} ${z} a_${S};
#else
uniform ${T} ${M} u_${S};
#endif
`:R==="vec4"?`
#ifndef HAS_UNIFORM_u_${S}
    ${T} ${M} ${S} = a_${S};
#else
    ${T} ${M} ${S} = u_${S};
#endif
`:`
#ifndef HAS_UNIFORM_u_${S}
    ${T} ${M} ${S} = unpack_mix_${R}(a_${S}, u_${S}_t);
#else
    ${T} ${M} ${S} = u_${S};
#endif
`}),staticAttributes:s,staticUniforms:f}}class Cr{constructor(e,i,s){this.vertexBuffer=e,this.indexBuffer=i,this.segments=s}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Fr=c.aC([{name:"a_pos",type:"Int16",components:2}]);const $t="#define PROJECTION_MERCATOR",ds="mercator";class Eo{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return ds}get shaderDefine(){return $t}get shaderPreludeCode(){return Xr.projectionMercator}get vertexShaderPreludeCode(){return Xr.projectionMercator.vertexSource}get subdivisionGranularity(){return c.aD.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(e){}getMeshFromTileID(e,i,s,o,u){if(this._cachedMesh)return this._cachedMesh;const f=new c.aE;f.emplaceBack(0,0),f.emplaceBack(c.Z,0),f.emplaceBack(0,c.Z),f.emplaceBack(c.Z,c.Z);const g=e.createVertexBuffer(f,Fr.members),y=c.aF.simpleSegment(0,0,4,2),x=new c.aG;x.emplaceBack(1,0,2),x.emplaceBack(1,2,3);const T=e.createIndexBuffer(x);return this._cachedMesh=new Cr(g,T,y),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(e){}}function Br(h,e){const i=c.ad(e.lat,-85.051129,c.aI);return new c.P(c.U(e.lng)*h,c.S(i)*h)}function rr(h,e){return new c.$(e.x/h,e.y/h).toLngLat()}function Wi(h){return h.cameraToCenterDistance*Math.min(.85*Math.tan(c.ac(90-h.pitch)),Math.tan(c.ac(89.25-h.pitch)))}function Pi(h,e){const i=h.canonical,s=e/c.aH(i.z),o=i.x+Math.pow(2,i.z)*h.wrap,u=c.as(new Float64Array(16));return c.L(u,u,[o*s,i.y*s,0]),c.M(u,u,[s/c.Z,s/c.Z,1]),u}function Ao(h,e,i,s,o){const u=c.$.fromLngLat(h,e),f=o*c.aJ(1,h.lat),g=f*Math.cos(c.ac(i)),y=Math.sqrt(f*f-g*g),x=y*Math.sin(c.ac(-s)),T=y*Math.cos(c.ac(-s));return new c.$(u.x+x,u.y+T,u.z+g)}class Xi{constructor(e=0,i=0,s=0,o=0){if(isNaN(e)||e<0||isNaN(i)||i<0||isNaN(s)||s<0||isNaN(o)||o<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=i,this.left=s,this.right=o}interpolate(e,i,s){return i.top!=null&&e.top!=null&&(this.top=c.B.number(e.top,i.top,s)),i.bottom!=null&&e.bottom!=null&&(this.bottom=c.B.number(e.bottom,i.bottom,s)),i.left!=null&&e.left!=null&&(this.left=c.B.number(e.left,i.left,s)),i.right!=null&&e.right!=null&&(this.right=c.B.number(e.right,i.right,s)),this}getCenter(e,i){const s=c.ad((this.left+e-this.right)/2,0,e),o=c.ad((this.top+i-this.bottom)/2,0,i);return new c.P(s,o)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new Xi(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function mr(h,e){if(!h.renderWorldCopies||h.lngRange)return;const i=e.lng-h.center.lng;e.lng+=i>180?-360:i<-180?360:0}function vr(h){return Math.max(0,Math.floor(h))}class ps{constructor(e,i,s,o,u,f){this._callbacks=e,this._tileSize=512,this._renderWorldCopies=f===void 0||!!f,this._minZoom=i||0,this._maxZoom=s||22,this._minPitch=o??0,this._maxPitch=u??60,this.setMaxBounds(),this._width=0,this._height=0,this._center=new c.Q(0,0),this._elevation=0,this._zoom=0,this._tileZoom=vr(this._zoom),this._scale=c.aH(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new Xi,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(e,i,s){this._latRange=e.latRange,this._lngRange=e.lngRange,this._width=e.width,this._height=e.height,this._center=e.center,this._elevation=e.elevation,this._minElevationForCurrentTile=e.minElevationForCurrentTile,this._zoom=e.zoom,this._tileZoom=vr(this._zoom),this._scale=c.aH(this._zoom),this._bearingInRadians=e.bearingInRadians,this._fovInRadians=e.fovInRadians,this._pitchInRadians=e.pitchInRadians,this._rollInRadians=e.rollInRadians,this._unmodified=e.unmodified,this._edgeInsets=new Xi(e.padding.top,e.padding.bottom,e.padding.left,e.padding.right),this._minZoom=e.minZoom,this._maxZoom=e.maxZoom,this._minPitch=e.minPitch,this._maxPitch=e.maxPitch,this._renderWorldCopies=e.renderWorldCopies,this._cameraToCenterDistance=e.cameraToCenterDistance,this._nearZ=e.nearZ,this._farZ=e.farZ,this._autoCalculateNearFarZ=!s&&e.autoCalculateNearFarZ,i&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(e){this._minElevationForCurrentTile=e}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(e){this._minZoom!==e&&(this._minZoom=e,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(e){this._minPitch!==e&&(this._minPitch=e,this.setPitch(Math.max(this.pitch,e)))}get maxPitch(){return this._maxPitch}setMaxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.setPitch(Math.min(this.pitch,e)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new c.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(e){const i=c.aK(e,-180,180)*Math.PI/180;var s,o,u,f,g,y,x,T,M;this._bearingInRadians!==i&&(this._unmodified=!1,this._bearingInRadians=i,this._calcMatrices(),this._rotationMatrix=He(),s=this._rotationMatrix,u=-this._bearingInRadians,f=(o=this._rotationMatrix)[0],g=o[1],y=o[2],x=o[3],T=Math.sin(u),M=Math.cos(u),s[0]=f*M+y*T,s[1]=g*M+x*T,s[2]=f*-T+y*M,s[3]=g*-T+x*M)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(e){const i=c.ad(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==i&&(this._unmodified=!1,this._pitchInRadians=i,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(e){const i=e/180*Math.PI;this._rollInRadians!==i&&(this._unmodified=!1,this._rollInRadians=i,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return c.aL(this._fovInRadians)}setFov(e){e=c.ad(e,.1,150),this.fov!==e&&(this._unmodified=!1,this._fovInRadians=c.ac(e),this._calcMatrices())}get zoom(){return this._zoom}setZoom(e){const i=this.getConstrained(this._center,e).zoom;this._zoom!==i&&(this._unmodified=!1,this._zoom=i,this._tileZoom=Math.max(0,Math.floor(i)),this._scale=c.aH(i),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(e){e!==this._elevation&&(this._elevation=e,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(e,i){this._autoCalculateNearFarZ=!1,this._nearZ=e,this._farZ=i,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,i,s){this._unmodified=!1,this._edgeInsets.interpolate(e,i,s),this._constrain(),this._calcMatrices()}resize(e,i,s=!0){this._width=e,this._height=i,s&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new ci([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(e){e?(this._lngRange=[e.getWest(),e.getEast()],this._latRange=[e.getSouth(),e.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-85.051129,c.aI])}getConstrained(e,i){return this._callbacks.getConstrained(e,i)}getCameraQueryGeometry(e,i){if(i.length===1)return[i[0],e];{let s=e.x,o=e.y,u=e.x,f=e.y;for(const g of i)s=Math.min(s,g.x),o=Math.min(o,g.y),u=Math.max(u,g.x),f=Math.max(f,g.y);return[new c.P(s,o),new c.P(u,o),new c.P(u,f),new c.P(s,f),new c.P(s,o)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const e=this._unmodified,{center:i,zoom:s}=this.getConstrained(this.center,this.zoom);this.setCenter(i),this.setZoom(s),this._unmodified=e,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let e=c.as(new Float64Array(16));c.M(e,e,[this._width/2,-this._height/2,1]),c.L(e,e,[1,-1,0]),this._clipSpaceToPixelsMatrix=e,e=c.as(new Float64Array(16)),c.M(e,e,[1,-1,1]),c.L(e,e,[-1,-1,0]),c.M(e,e,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=e,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(e,i,s,o){const u=s!==void 0?s:this.bearing,f=o=o!==void 0?o:this.pitch,g=c.$.fromLngLat(e,i),y=-Math.cos(c.ac(f)),x=Math.sin(c.ac(f)),T=x*Math.sin(c.ac(u)),M=-x*Math.cos(c.ac(u));let S=this.elevation;const z=i-S;let R;y*z>=0||Math.abs(y)<.1?(R=1e4,S=i+R*y):R=-z/y;let V,j,N=c.aM(1,g.y),$=0;do{if($+=1,$>10)break;j=R/N,V=new c.$(g.x+T*j,g.y+M*j),N=1/V.meterInMercatorCoordinateUnits()}while(Math.abs(R-j*N)>1e-12);return{center:V.toLngLat(),elevation:S,zoom:c.aa(this.height/2/Math.tan(this.fovInRadians/2)/j/this.tileSize)}}recalculateZoomAndCenter(e){if(this.elevation-e==0)return;const i=c.aJ(1,this.center.lat)*this.worldSize,s=this.cameraToCenterDistance/i,o=c.$.fromLngLat(this.center,this.elevation),u=Ao(this.center,this.elevation,this.pitch,this.bearing,s);this._elevation=e;const f=this.calculateCenterFromCameraLngLatAlt(u.toLngLat(),c.aM(u.z,o.y),this.bearing,this.pitch);this._elevation=f.elevation,this._center=f.center,this.setZoom(f.zoom)}getCameraPoint(){const e=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new c.P(e*Math.sin(this.rollInRadians),e*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const e=c.aJ(1,this.center.lat)*this.worldSize;return Ao(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/e).toLngLat()}getMercatorTileCoordinates(e){if(!e)return[0,0,1,1];const i=e.canonical.z>=0?1<<e.canonical.z:Math.pow(2,e.canonical.z);return[e.canonical.x/i,e.canonical.y/i,1/i/c.Z,1/i/c.Z]}}class Kr{constructor(e,i){this.min=e,this.max=i,this.center=c.aN([],c.aO([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=c.aP(this.min),o=c.aP(this.max);for(let u=0;u<i.length;u++)s[u]=i[u]?this.min[u]:this.center[u],o[u]=i[u]?this.center[u]:this.max[u];return o[2]=this.max[2],new Kr(s,o)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}intersectsFrustum(e){let i=!0;for(let s=0;s<e.planes.length;s++){const o=this.intersectsPlane(e.planes[s]);if(o===0)return 0;o===1&&(i=!1)}return i?2:e.aabb.min[0]>this.max[0]||e.aabb.min[1]>this.max[1]||e.aabb.min[2]>this.max[2]||e.aabb.max[0]<this.min[0]||e.aabb.max[1]<this.min[1]||e.aabb.max[2]<this.min[2]?0:1}intersectsPlane(e){let i=e[3],s=e[3];for(let o=0;o<3;o++)e[o]>0?(i+=e[o]*this.min[o],s+=e[o]*this.max[o]):(s+=e[o]*this.min[o],i+=e[o]*this.max[o]);return i>=0?2:s<0?0:1}}class Oi{distanceToTile2d(e,i,s,o){const u=o.distanceX([e,i]),f=o.distanceY([e,i]);return Math.hypot(u,f)}getWrap(e,i,s){return s}getTileAABB(e,i,s,o){var u,f;let g=s,y=s;if(o.terrain){const T=new c.Y(e.z,i,e.z,e.x,e.y),M=o.terrain.getMinMaxElevation(T);g=(u=M.minElevation)!==null&&u!==void 0?u:s,y=(f=M.maxElevation)!==null&&f!==void 0?f:s}const x=1<<e.z;return new Kr([i+e.x/x,e.y/x,g],[i+(e.x+1)/x,(e.y+1)/x,y])}allowVariableZoom(e,i){const s=e.fov*(Math.abs(Math.cos(e.rollInRadians))*e.height+Math.abs(Math.sin(e.rollInRadians))*e.width)/e.height,o=c.ad(78.5-s/2,0,60);return!!i.terrain||e.pitch>o}allowWorldCopies(){return!0}recalculateCache(){}}class Mn{constructor(e,i,s){this.points=e,this.planes=i,this.aabb=s}static fromInvProjectionMatrix(e,i=1,s=0){const o=Math.pow(2,s),u=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(x=>{const T=1/(x=c.ao([],x,e))[3]/i*o;return c.aQ(x,x,[T,T,1/x[3],T])}),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(x=>{const T=c.aR([],u[x[0]],u[x[1]]),M=c.aR([],u[x[2]],u[x[1]]),S=c.aS([],c.aT([],T,M)),z=-c.aU(S,u[x[1]]);return S.concat(z)}),g=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],y=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const x of u)for(let T=0;T<3;T++)g[T]=Math.min(g[T],x[T]),y[T]=Math.max(y[T],x[T]);return new Mn(u,f,new Kr(g,y))}}class Or{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(e){this._helper.setMinZoom(e)}setMaxZoom(e){this._helper.setMaxZoom(e)}setMinPitch(e){this._helper.setMinPitch(e)}setMaxPitch(e){this._helper.setMaxPitch(e)}setRenderWorldCopies(e){this._helper.setRenderWorldCopies(e)}setBearing(e){this._helper.setBearing(e)}setPitch(e){this._helper.setPitch(e)}setRoll(e){this._helper.setRoll(e)}setFov(e){this._helper.setFov(e)}setZoom(e){this._helper.setZoom(e)}setCenter(e){this._helper.setCenter(e)}setElevation(e){this._helper.setElevation(e)}setMinElevationForCurrentTile(e){this._helper.setMinElevationForCurrentTile(e)}setPadding(e){this._helper.setPadding(e)}interpolatePadding(e,i,s){return this._helper.interpolatePadding(e,i,s)}isPaddingEqual(e){return this._helper.isPaddingEqual(e)}resize(e,i,s=!0){this._helper.resize(e,i,s)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(e){this._helper.setMaxBounds(e)}overrideNearFarZ(e,i){this._helper.overrideNearFarZ(e,i)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(e){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),e)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(e,i){}constructor(e,i,s,o,u){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new ps({calcMatrices:()=>{this._calcMatrices()},getConstrained:(f,g)=>this.getConstrained(f,g)},e,i,s,o,u),this._coveringTilesDetailsProvider=new Oi}clone(){const e=new Or;return e.apply(this),e}apply(e,i,s){this._helper.apply(e,i,s)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(e){const i=[new c.aV(0,e)];if(this._helper._renderWorldCopies){const s=this.screenPointToMercatorCoordinate(new c.P(0,0)),o=this.screenPointToMercatorCoordinate(new c.P(this._helper._width,0)),u=this.screenPointToMercatorCoordinate(new c.P(this._helper._width,this._helper._height)),f=this.screenPointToMercatorCoordinate(new c.P(0,this._helper._height)),g=Math.floor(Math.min(s.x,o.x,u.x,f.x)),y=Math.floor(Math.max(s.x,o.x,u.x,f.x)),x=1;for(let T=g-x;T<=y+x;T++)T!==0&&i.push(new c.aV(T,e))}return i}getCameraFrustum(){return Mn.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(e){const i=this.screenPointToLocation(this.centerPoint,e),s=e?e.getElevationForLngLatZoom(i,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(s)}setLocationAtPoint(e,i){const s=c.aJ(this.elevation,this.center.lat),o=this.screenPointToMercatorCoordinateAtZ(i,s),u=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,s),f=c.$.fromLngLat(e),g=new c.$(f.x-(o.x-u.x),f.y-(o.y-u.y));this.setCenter(g==null?void 0:g.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(e,i){return i?this.coordinatePoint(c.$.fromLngLat(e),i.getElevationForLngLatZoom(e,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(c.$.fromLngLat(e))}screenPointToLocation(e,i){var s;return(s=this.screenPointToMercatorCoordinate(e,i))===null||s===void 0?void 0:s.toLngLat()}screenPointToMercatorCoordinate(e,i){if(i){const s=i.pointCoordinate(e);if(s!=null)return s}return this.screenPointToMercatorCoordinateAtZ(e)}screenPointToMercatorCoordinateAtZ(e,i){const s=i||0,o=[e.x,e.y,0,1],u=[e.x,e.y,1,1];c.ao(o,o,this._pixelMatrixInverse),c.ao(u,u,this._pixelMatrixInverse);const f=o[3],g=u[3],y=o[1]/f,x=u[1]/g,T=o[2]/f,M=u[2]/g,S=T===M?0:(s-T)/(M-T);return new c.$(c.B.number(o[0]/f,u[0]/g,S)/this.worldSize,c.B.number(y,x,S)/this.worldSize,s)}coordinatePoint(e,i=0,s=this._pixelMatrix){const o=[e.x*this.worldSize,e.y*this.worldSize,i,1];return c.ao(o,o,s),new c.P(o[0]/o[3],o[1]/o[3])}getBounds(){const e=Math.max(0,this._helper._height/2-Wi(this));return new ci().extend(this.screenPointToLocation(new c.P(0,e))).extend(this.screenPointToLocation(new c.P(this._helper._width,e))).extend(this.screenPointToLocation(new c.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new c.P(0,this._helper._height)))}isPointOnMapSurface(e,i){return i?i.pointCoordinate(e)!=null:e.y>this.height/2-Wi(this)}calculatePosMatrix(e,i=!1,s){var o;const u=(o=e.key)!==null&&o!==void 0?o:c.aW(e.wrap,e.canonical.z,e.canonical.z,e.canonical.x,e.canonical.y),f=i?this._alignedPosMatrixCache:this._posMatrixCache;if(f.has(u)){const x=f.get(u);return s?x.f32:x.f64}const g=Pi(e,this.worldSize);c.N(g,i?this._alignedProjMatrix:this._viewProjMatrix,g);const y={f64:g,f32:new Float32Array(g)};return f.set(u,y),s?y.f32:y.f64}calculateFogMatrix(e){const i=e.key,s=this._fogMatrixCacheF32;if(s.has(i))return s.get(i);const o=Pi(e,this.worldSize);return c.N(o,this._fogMatrix,o),s.set(i,new Float32Array(o)),s.get(i)}getConstrained(e,i){i=c.ad(+i,this.minZoom,this.maxZoom);const s={center:new c.Q(e.lng,e.lat),zoom:i};let o=this._helper._lngRange;this._helper._renderWorldCopies||o!==null||(o=[-179.9999999999,180-1e-10]);const u=this.tileSize*c.aH(s.zoom);let f=0,g=u,y=0,x=u,T=0,M=0;const{x:S,y:z}=this.size;if(this._helper._latRange){const W=this._helper._latRange;f=c.S(W[1])*u,g=c.S(W[0])*u,g-f<z&&(T=z/(g-f))}o&&(y=c.aK(c.U(o[0])*u,0,u),x=c.aK(c.U(o[1])*u,0,u),x<y&&(x+=u),x-y<S&&(M=S/(x-y)));const{x:R,y:V}=Br(u,e);let j,N;const $=Math.max(M||0,T||0);if($){const W=new c.P(M?(x+y)/2:R,T?(g+f)/2:V);return s.center=rr(u,W).wrap(),s.zoom+=c.aa($),s}if(this._helper._latRange){const W=z/2;V-W<f&&(N=f+W),V+W>g&&(N=g-W)}if(o){const W=(y+x)/2;let X=R;this._helper._renderWorldCopies&&(X=c.aK(R,W-u/2,W+u/2));const J=S/2;X-J<y&&(j=y+J),X+J>x&&(j=x-J)}if(j!==void 0||N!==void 0){const W=new c.P(j??R,N??V);s.center=rr(u,W).wrap()}return s}calculateCenterFromCameraLngLatAlt(e,i,s,o){return this._helper.calculateCenterFromCameraLngLatAlt(e,i,s,o)}_calculateNearFarZIfNeeded(e,i,s){if(!this._helper.autoCalculateNearFarZ)return;const o=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),u=e-o*this._helper._pixelPerMeter/Math.cos(i),f=o<0?u:e,g=Math.PI/2+this.pitchInRadians,y=c.ac(this.fov)*(Math.abs(Math.cos(c.ac(this.roll)))*this.height+Math.abs(Math.sin(c.ac(this.roll)))*this.width)/this.height*(.5+s.y/this.height),x=Math.sin(y)*f/Math.sin(c.ad(Math.PI-g-y,.01,Math.PI-.01)),T=Wi(this),M=Math.atan(T/this._helper.cameraToCenterDistance),S=c.ac(.75),z=M>S?2*M*(.5+s.y/(2*T)):S,R=Math.sin(z)*f/Math.sin(c.ad(Math.PI-g-z,.01,Math.PI-.01)),V=Math.min(x,R);this._helper._farZ=1.01*(Math.cos(Math.PI/2-i)*V+f),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const e=this.centerOffset,i=Br(this.worldSize,this.center),s=i.x,o=i.y;this._helper._pixelPerMeter=c.aJ(1,this.center.lat)*this.worldSize;const u=c.ac(Math.min(this.pitch,89.25)),f=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(u));let g;this._calculateNearFarZIfNeeded(f,u,e),g=new Float64Array(16),c.aX(g,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),c.ai(this._invProjMatrix,g),g[8]=2*-e.x/this._helper._width,g[9]=2*e.y/this._helper._height,this._projectionMatrix=c.aY(g),c.M(g,g,[1,-1,1]),c.L(g,g,[0,0,-this._helper.cameraToCenterDistance]),c.aZ(g,g,-this.rollInRadians),c.a_(g,g,this.pitchInRadians),c.aZ(g,g,-this.bearingInRadians),c.L(g,g,[-s,-o,0]),this._mercatorMatrix=c.M([],g,[this.worldSize,this.worldSize,this.worldSize]),c.M(g,g,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=c.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,g),c.L(g,g,[0,0,-this.elevation]),this._viewProjMatrix=g,this._invViewProjMatrix=c.ai([],g);const y=[0,0,-1,1];c.ao(y,y,this._invViewProjMatrix),this._cameraPosition=[y[0]/y[3],y[1]/y[3],y[2]/y[3]],this._fogMatrix=new Float64Array(16),c.aX(this._fogMatrix,this.fovInRadians,this.width/this.height,f,this._helper._farZ),this._fogMatrix[8]=2*-e.x/this.width,this._fogMatrix[9]=2*e.y/this.height,c.M(this._fogMatrix,this._fogMatrix,[1,-1,1]),c.L(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),c.aZ(this._fogMatrix,this._fogMatrix,-this.rollInRadians),c.a_(this._fogMatrix,this._fogMatrix,this.pitchInRadians),c.aZ(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),c.L(this._fogMatrix,this._fogMatrix,[-s,-o,0]),c.M(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),c.L(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=c.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,g);const x=this._helper._width%2/2,T=this._helper._height%2/2,M=Math.cos(this.bearingInRadians),S=Math.sin(-this.bearingInRadians),z=s-Math.round(s)+M*x+S*T,R=o-Math.round(o)+M*T+S*x,V=new Float64Array(g);if(c.L(V,V,[z>.5?z-1:z,R>.5?R-1:R,0]),this._alignedProjMatrix=V,g=c.ai(new Float64Array(16),this._pixelMatrix),!g)throw new Error("failed to invert matrix");this._pixelMatrixInverse=g,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const e=this.screenPointToMercatorCoordinate(new c.P(0,0)),i=[e.x*this.worldSize,e.y*this.worldSize,0,1];return c.ao(i,i,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const e=c.aJ(1,this.center.lat)*this.worldSize;return Ao(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/e).toLngLat()}lngLatToCameraDepth(e,i){const s=c.$.fromLngLat(e),o=[s.x*this.worldSize,s.y*this.worldSize,i,1];return c.ao(o,o,this._viewProjMatrix),o[2]/o[3]}getProjectionData(e){const{overscaledTileID:i,aligned:s,applyTerrainMatrix:o}=e,u=this._helper.getMercatorTileCoordinates(i),f=i?this.calculatePosMatrix(i,s,!0):null;let g;return g=i&&i.terrainRttPosMatrix32f&&o?i.terrainRttPosMatrix32f:f||c.a$(),{mainMatrix:g,tileMercatorCoords:u,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:g}}isLocationOccluded(e){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(e,i,s){return 1}transformLightDirection(e){return c.aP(e)}getRayDirectionFromPixel(e){throw new Error("Not implemented.")}projectTileCoordinates(e,i,s,o){const u=this.calculatePosMatrix(s);let f;o?(f=[e,i,o(e,i),1],c.ao(f,f,u)):(f=[e,i,0,1],Ni(f,f,u));const g=f[3];return{point:new c.P(f[0]/g,f[1]/g),signedDistanceFromCamera:g,isOccluded:!1}}populateCache(e){for(const i of e)this.calculatePosMatrix(i)}getMatrixForModel(e,i){const s=c.$.fromLngLat(e,i),o=s.meterInMercatorCoordinateUnits(),u=c.b0();return c.L(u,u,[s.x,s.y,s.z]),c.aZ(u,u,Math.PI),c.a_(u,u,Math.PI/2),c.M(u,u,[-o,o,o]),u}getProjectionDataForCustomLayer(e=!0){const i=new c.Y(0,0,0,0,0),s=this.getProjectionData({overscaledTileID:i,applyGlobeMatrix:e}),o=Pi(i,this.worldSize);c.N(o,this._viewProjMatrix,o),s.tileMercatorCoords=[0,0,1,1];const u=[c.Z,c.Z,this.worldSize/this._helper.pixelsPerMeter],f=c.b1();return c.M(f,o,u),s.fallbackMatrix=f,s.mainMatrix=f,s}getFastPathSimpleProjectionMatrix(e){return this.calculatePosMatrix(e)}}function Da(){c.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function jr(h){if(h.useSlerp)if(h.k<1){const e=c.b2(h.startEulerAngles.roll,h.startEulerAngles.pitch,h.startEulerAngles.bearing),i=c.b2(h.endEulerAngles.roll,h.endEulerAngles.pitch,h.endEulerAngles.bearing),s=new Float64Array(4);c.b3(s,e,i,h.k);const o=c.b4(s);h.tr.setRoll(o.roll),h.tr.setPitch(o.pitch),h.tr.setBearing(o.bearing)}else h.tr.setRoll(h.endEulerAngles.roll),h.tr.setPitch(h.endEulerAngles.pitch),h.tr.setBearing(h.endEulerAngles.bearing);else h.tr.setRoll(c.B.number(h.startEulerAngles.roll,h.endEulerAngles.roll,h.k)),h.tr.setPitch(c.B.number(h.startEulerAngles.pitch,h.endEulerAngles.pitch,h.k)),h.tr.setBearing(c.B.number(h.startEulerAngles.bearing,h.endEulerAngles.bearing,h.k))}function ko(h,e,i,s,o){const u=o.padding,f=Br(o.worldSize,i.getNorthWest()),g=Br(o.worldSize,i.getNorthEast()),y=Br(o.worldSize,i.getSouthEast()),x=Br(o.worldSize,i.getSouthWest()),T=c.ac(-s),M=f.rotate(T),S=g.rotate(T),z=y.rotate(T),R=x.rotate(T),V=new c.P(Math.max(M.x,S.x,R.x,z.x),Math.max(M.y,S.y,R.y,z.y)),j=new c.P(Math.min(M.x,S.x,R.x,z.x),Math.min(M.y,S.y,R.y,z.y)),N=V.sub(j),$=(o.width-(u.left+u.right+e.left+e.right))/N.x,W=(o.height-(u.top+u.bottom+e.top+e.bottom))/N.y;if(W<0||$<0)return void Da();const X=Math.min(c.aa(o.scale*Math.min($,W)),h.maxZoom),J=c.P.convert(h.offset),ie=new c.P((e.left-e.right)/2,(e.top-e.bottom)/2).rotate(c.ac(s)),Q=J.add(ie).mult(o.scale/c.aH(X));return{center:rr(o.worldSize,f.add(y).div(2).sub(Q)),zoom:X,bearing:s}}class Yr{get useGlobeControls(){return!1}handlePanInertia(e,i){return{easingOffset:e,easingCenter:i.center}}handleMapControlsRollPitchBearingZoom(e,i){e.bearingDelta&&i.setBearing(i.bearing+e.bearingDelta),e.pitchDelta&&i.setPitch(i.pitch+e.pitchDelta),e.rollDelta&&i.setRoll(i.roll+e.rollDelta),e.zoomDelta&&i.setZoom(i.zoom+e.zoomDelta)}handleMapControlsPan(e,i,s){e.around.distSqr(i.centerPoint)<.01||i.setLocationAtPoint(s,e.around)}cameraForBoxAndBearing(e,i,s,o,u){return ko(e,i,s,o,u)}handleJumpToCenterZoom(e,i){e.zoom!==(i.zoom!==void 0?+i.zoom:e.zoom)&&e.setZoom(+i.zoom),i.center!==void 0&&e.setCenter(c.Q.convert(i.center))}handleEaseTo(e,i){const s=e.zoom,o=e.padding,u={roll:e.roll,pitch:e.pitch,bearing:e.bearing},f={roll:i.roll===void 0?e.roll:i.roll,pitch:i.pitch===void 0?e.pitch:i.pitch,bearing:i.bearing===void 0?e.bearing:i.bearing},g=i.zoom!==void 0,y=!e.isPaddingEqual(i.padding);let x=!1;const T=g?+i.zoom:e.zoom;let M=e.centerPoint.add(i.offsetAsPoint);const S=e.screenPointToLocation(M),{center:z,zoom:R}=e.getConstrained(c.Q.convert(i.center||S),T??s);mr(e,z);const V=Br(e.worldSize,S),j=Br(e.worldSize,z).sub(V),N=c.aH(R-s);return x=R!==s,{easeFunc:$=>{if(x&&e.setZoom(c.B.number(s,R,$)),c.b5(u,f)||jr({startEulerAngles:u,endEulerAngles:f,tr:e,k:$,useSlerp:u.roll!=f.roll}),y&&(e.interpolatePadding(o,i.padding,$),M=e.centerPoint.add(i.offsetAsPoint)),i.around)e.setLocationAtPoint(i.around,i.aroundPoint);else{const W=c.aH(e.zoom-s),X=R>s?Math.min(2,N):Math.max(.5,N),J=Math.pow(X,1-$),ie=rr(e.worldSize,V.add(j.mult($*J)).mult(W));e.setLocationAtPoint(e.renderWorldCopies?ie.wrap():ie,M)}},isZooming:x,elevationCenter:z}}handleFlyTo(e,i){const s=i.zoom!==void 0,o=e.zoom,u=e.getConstrained(c.Q.convert(i.center||i.locationAtOffset),s?+i.zoom:o),f=u.center,g=u.zoom;mr(e,f);const y=Br(e.worldSize,i.locationAtOffset),x=Br(e.worldSize,f).sub(y),T=x.mag(),M=c.aH(g-o);let S;if(i.minZoom!==void 0){const z=Math.min(+i.minZoom,o,g),R=e.getConstrained(f,z).zoom;S=c.aH(R-o)}return{easeFunc:(z,R,V,j)=>{e.setZoom(z===1?g:o+c.aa(R));const N=z===1?f:rr(e.worldSize,y.add(x.mult(V)).mult(R));e.setLocationAtPoint(e.renderWorldCopies?N.wrap():N,j)},scaleOfZoom:M,targetCenter:f,scaleOfMinZoom:S,pixelPathLength:T}}}class gi{constructor(e,i,s){this.blendFunction=e,this.blendColor=i,this.mask=s}}gi.Replace=[1,0],gi.disabled=new gi(gi.Replace,c.b6.transparent,[!1,!1,!1,!1]),gi.unblended=new gi(gi.Replace,c.b6.transparent,[!0,!0,!0,!0]),gi.alphaBlended=new gi([1,771],c.b6.transparent,[!0,!0,!0,!0]);const fs=2305;class Ot{constructor(e,i,s){this.enable=e,this.mode=i,this.frontFace=s}}Ot.disabled=new Ot(!1,1029,fs),Ot.backCCW=new Ot(!0,1029,fs),Ot.frontCCW=new Ot(!0,1028,fs);class Ct{constructor(e,i,s){this.func=e,this.mask=i,this.range=s}}Ct.ReadOnly=!1,Ct.ReadWrite=!0,Ct.disabled=new Ct(519,Ct.ReadOnly,[0,1]);const ca=7680;class Nt{constructor(e,i,s,o,u,f){this.test=e,this.ref=i,this.mask=s,this.fail=o,this.depthFail=u,this.pass=f}}Nt.disabled=new Nt({func:519,mask:0},0,0,ca,ca,ca);const Ra=new WeakMap;function Vr(h){var e;if(Ra.has(h))return Ra.get(h);{const i=(e=h.getParameter(h.VERSION))===null||e===void 0?void 0:e.startsWith("WebGL 2.0");return Ra.set(h,i),i}}class La{get awaitingQuery(){return!!this._readbackQueue}constructor(e){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=e;const i=e.context,s=i.gl;this._texFormat=s.RGBA,this._texType=s.UNSIGNED_BYTE;const o=new c.aE;o.emplaceBack(-1,-1),o.emplaceBack(2,-1),o.emplaceBack(-1,2);const u=new c.aG;u.emplaceBack(0,1,2),this._fullscreenTriangle=new Cr(i.createVertexBuffer(o,Fr.members),i.createIndexBuffer(u),c.aF.simpleSegment(0,0,o.length,u.length)),this._resultBuffer=new Uint8Array(4),i.activeTexture.set(s.TEXTURE1);const f=s.createTexture();s.bindTexture(s.TEXTURE_2D,f),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texImage2D(s.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=i.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(f),Vr(s)&&(this._pbo=s.createBuffer(),s.bindBuffer(s.PIXEL_PACK_BUFFER,this._pbo),s.bufferData(s.PIXEL_PACK_BUFFER,4,s.STREAM_READ),s.bindBuffer(s.PIXEL_PACK_BUFFER,null))}destroy(){const e=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),e.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(e,i){const s=this._updateCount;return this._readbackQueue?s>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():s>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(e,i),this._updateCount++,this._measuredError}_bindFramebuffer(){const e=this._cachedRenderContext.context,i=e.gl;e.activeTexture.set(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this._fbo.colorAttachment.get()),e.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(e,i){const s=this._cachedRenderContext.context,o=s.gl;if(this._bindFramebuffer(),s.viewport.set([0,0,this._texWidth,this._texHeight]),s.clear({color:c.b6.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(s,o.TRIANGLES,Ct.disabled,Nt.disabled,gi.unblended,Ot.disabled,((u,f)=>({u_input:u,u_output_expected:f}))(e,i),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&Vr(o)){o.bindBuffer(o.PIXEL_PACK_BUFFER,this._pbo),o.readBuffer(o.COLOR_ATTACHMENT0),o.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const u=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);o.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:u}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const e=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&Vr(e)){const i=e.clientWaitSync(this._readbackQueue.sync,0,0);if(i===e.WAIT_FAILED)return c.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(i===e.TIMEOUT_EXPIRED)return;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pbo),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),e.bindBuffer(e.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),e.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=La._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(e){let i=0;return i+=e[0]/256,i+=e[1]/65536,i+=e[2]/16777216,e[3]<127&&(i=-i),i/128}}const ms=c.Z/128;function Fa(h,e){const i=h.granularity!==void 0?Math.max(h.granularity,1):1,s=i+(h.generateBorders?2:0),o=i+(h.extendToNorthPole||h.generateBorders?1:0)+(h.extendToSouthPole||h.generateBorders?1:0),u=s+1,f=o+1,g=h.generateBorders?-1:0,y=h.generateBorders||h.extendToNorthPole?-1:0,x=i+(h.generateBorders?1:0),T=i+(h.generateBorders||h.extendToSouthPole?1:0),M=u*f,S=s*o*6,z=u*f>65536;if(z&&e==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const R=z||e==="32bit",V=new Int16Array(2*M);let j=0;for(let W=y;W<=T;W++)for(let X=g;X<=x;X++){let J=X/i*c.Z;X===-1&&(J=-64),X===i+1&&(J=c.Z+ms);let ie=W/i*c.Z;W===-1&&(ie=h.extendToNorthPole?c.b8:-64),W===i+1&&(ie=h.extendToSouthPole?c.b9:c.Z+ms),V[j++]=J,V[j++]=ie}const N=R?new Uint32Array(S):new Uint16Array(S);let $=0;for(let W=0;W<o;W++)for(let X=0;X<s;X++){const J=X+1+W*u,ie=X+(W+1)*u,Q=X+1+(W+1)*u;N[$++]=X+W*u,N[$++]=ie,N[$++]=J,N[$++]=J,N[$++]=ie,N[$++]=Q}return{vertices:V.buffer.slice(0),indices:N.buffer.slice(0),uses32bitIndices:R}}const ha=new c.aD({fill:new c.ba(128,2),line:new c.ba(512,0),tile:new c.ba(128,32),stencil:new c.ba(128,1),circle:3});class ua{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return Xr.projectionGlobe}get vertexShaderPreludeCode(){return Xr.projectionMercator.vertexSource}get subdivisionGranularity(){return ha}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(e){this._errorMeasurement||(this._errorMeasurement=new La(e));const i=c.S(this._errorQueryLatitudeDegrees),s=2*Math.atan(Math.exp(Math.PI-i*Math.PI*2))-.5*Math.PI,o=this._errorMeasurement.updateErrorLoop(i,s),u=Pe.now();o!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=o,this._errorMeasurementLastChangeTime=u);const f=Math.min(Math.max((u-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=c.bb(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,c.bc(f))}_getMeshKey(e){return`${e.granularity.toString(36)}_${e.generateBorders?"b":""}${e.extendToNorthPole?"n":""}${e.extendToSouthPole?"s":""}`}getMeshFromTileID(e,i,s,o,u){const f=(u==="stencil"?ha.stencil:ha.tile).getGranularityForZoomLevel(i.z);return this._getMesh(e,{granularity:f,generateBorders:s,extendToNorthPole:i.y===0&&o,extendToSouthPole:i.y===(1<<i.z)-1&&o})}_getMesh(e,i){const s=this._getMeshKey(i);if(s in this._tileMeshCache)return this._tileMeshCache[s];const o=function(u,f){const g=Fa(f,"16bit"),y=c.aE.deserialize({arrayBuffer:g.vertices,length:g.vertices.byteLength/2/2}),x=c.aG.deserialize({arrayBuffer:g.indices,length:g.indices.byteLength/2/3});return new Cr(u.createVertexBuffer(y,Fr.members),u.createIndexBuffer(x),c.aF.simpleSegment(0,0,y.length,x.length))}(e,i);return this._tileMeshCache[s]=o,o}recalculate(e){}hasTransition(){const e=Pe.now();let i=!1;return i=i||(e-this._errorMeasurementLastChangeTime)/1e3<.7,i=i||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,i}setErrorQueryLatitudeDegrees(e){this._errorQueryLatitudeDegrees=e}}const uh=new c.r({type:new c.D(c.v.projection.type)});class gs extends c.E{constructor(e){super(),this._transitionable=new c.T(uh),this.setProjection(e),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new c.C(0)),this._mercatorProjection=new Eo,this._verticalPerspectiveProjection=new ua}get transitionState(){const e=this.properties.get("type");if(typeof e=="string"&&e==="mercator")return 0;if(typeof e=="string"&&e==="vertical-perspective")return 1;if(e instanceof c.bd){if(e.from==="vertical-perspective"&&e.to==="mercator")return 1-e.transition;if(e.from==="mercator"&&e.to==="vertical-perspective")return e.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(e){this._mercatorProjection.updateGPUdependent(e),this._verticalPerspectiveProjection.updateGPUdependent(e)}getMeshFromTileID(e,i,s,o,u){return this.currentProjection.getMeshFromTileID(e,i,s,o,u)}setProjection(e){this._transitionable.setValue("type",(e==null?void 0:e.type)||"mercator")}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}setErrorQueryLatitudeDegrees(e){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(e),this._mercatorProjection.setErrorQueryLatitudeDegrees(e)}}function zo(h){const e=cr(h.worldSize,h.center.lat);return 2*Math.PI*e}function Ba(h,e,i,s,o){const u=1/(1<<o),f=e/c.Z*u+s*u,g=c.bf((h/c.Z*u+i*u)*Math.PI*2+Math.PI,2*Math.PI),y=2*Math.atan(Math.exp(Math.PI-f*Math.PI*2))-.5*Math.PI,x=Math.cos(y),T=new Float64Array(3);return T[0]=Math.sin(g)*x,T[1]=Math.sin(y),T[2]=Math.cos(g)*x,T}function lr(h){return function(e,i){const s=Math.cos(i),o=new Float64Array(3);return o[0]=Math.sin(e)*s,o[1]=Math.sin(i),o[2]=Math.cos(e)*s,o}(h.lng*Math.PI/180,h.lat*Math.PI/180)}function cr(h,e){return h/(2*Math.PI)/Math.cos(e*Math.PI/180)}function _s(h){const e=Math.asin(h[1])/Math.PI*180,i=Math.sqrt(h[0]*h[0]+h[2]*h[2]);if(i>1e-6){const s=h[0]/i,o=Math.acos(h[2]/i),u=(s>0?o:-o)/Math.PI*180;return new c.Q(c.aK(u,-180,180),e)}return new c.Q(0,e)}function Ir(h){return Math.cos(h*Math.PI/180)}function zi(h,e){const i=Ir(h),s=Ir(e);return c.aa(s/i)}function Do(h,e){const i=h.rotate(e.bearingInRadians),s=e.zoom+zi(e.center.lat,0),o=c.bb(1/Ir(e.center.lat),1/Ir(Math.min(Math.abs(e.center.lat),60)),c.be(s,7,3,0,1)),u=360/zo({worldSize:e.worldSize,center:{lat:e.center.lat}});return new c.Q(e.center.lng-i.x*u*o,c.ad(e.center.lat+i.y*u,-85.051129,c.aI))}function ys(h){const e=.5*h,i=Math.sin(e),s=Math.cos(e);return Math.log(i+s)-Math.log(s-i)}function Bn(h,e,i,s){const o=h.lat+i*s;if(Math.abs(i)>1){const u=(Math.sign(h.lat+i)!==Math.sign(h.lat)?-Math.abs(h.lat):Math.abs(h.lat))*Math.PI/180,f=Math.abs(h.lat+i)*Math.PI/180,g=ys(u+s*(f-u)),y=ys(u),x=ys(f);return new c.Q(h.lng+e*((g-y)/(x-y)),o)}return new c.Q(h.lng+e*s,o)}class dh{constructor(e){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._aabbFactory=e}recalculateCache(){if(!this._hadAnyChanges)return;const e=this._cachePrevious;this._cachePrevious=this._cache,this._cache=e,this._cache.clear(),this._hadAnyChanges=!1}getTileAABB(e,i,s,o){const u=`${e.z}_${e.x}_${e.y}`,f=this._cache.get(u);if(f)return f;const g=this._cachePrevious.get(u);if(g)return this._cache.set(u,g),g;const y=this._aabbFactory(e,i,s,o);return this._cache.set(u,y),this._hadAnyChanges=!0,y}}function vs(h,e,i){const s=h-e;return s<0?-s:Math.max(0,s-i)}function Ro(h,e,i,s,o){const u=h-i;let f;return f=u<0?Math.min(-u,1+u-o):u>1?Math.min(Math.max(u-o,0),1-u):0,Math.max(f,vs(e,s,o))}class ph{constructor(){this._aabbCache=new dh(this._computeTileAABB)}recalculateCache(){this._aabbCache.recalculateCache()}distanceToTile2d(e,i,s,o){const u=1<<s.z,f=1/u,g=s.x/u,y=s.y/u;let x=2;return x=Math.min(x,Ro(e,i,g,y,f)),x=Math.min(x,Ro(e,i,g+.5,-y-f,f)),x=Math.min(x,Ro(e,i,g+.5,2-y-f,f)),x}getWrap(e,i,s){const o=1<<i.z,u=1/o,f=i.x/o,g=vs(e.x,f,u),y=vs(e.x,f-1,u),x=vs(e.x,f+1,u),T=Math.min(g,y,x);return T===x?1:T===y?-1:0}allowVariableZoom(e,i){return hi(e,i)>4}allowWorldCopies(){return!1}getTileAABB(e,i,s,o){return this._aabbCache.getTileAABB(e,i,s,o)}_computeTileAABB(e,i,s,o){if(e.z<=0)return new Kr([-1,-1,-1],[1,1,1]);if(e.z===1)return new Kr([e.x===0?-1:0,e.y===0?0:-1,-1],[e.x===0?0:1,e.y===0?1:0,1]);{const u=[Ba(0,0,e.x,e.y,e.z),Ba(c.Z,0,e.x,e.y,e.z),Ba(c.Z,c.Z,e.x,e.y,e.z),Ba(0,c.Z,e.x,e.y,e.z)],f=[1,1,1],g=[-1,-1,-1];for(const y of u)for(let x=0;x<3;x++)f[x]=Math.min(f[x],y[x]),g[x]=Math.max(g[x],y[x]);if(e.y===0||e.y===(1<<e.z)-1){const y=[0,e.y===0?1:-1,0];for(let x=0;x<3;x++)f[x]=Math.min(f[x],y[x]),g[x]=Math.max(g[x],y[x])}return new Kr(f,g)}}}class xs{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(e){this._helper.setMinZoom(e)}setMaxZoom(e){this._helper.setMaxZoom(e)}setMinPitch(e){this._helper.setMinPitch(e)}setMaxPitch(e){this._helper.setMaxPitch(e)}setRenderWorldCopies(e){this._helper.setRenderWorldCopies(e)}setBearing(e){this._helper.setBearing(e)}setPitch(e){this._helper.setPitch(e)}setRoll(e){this._helper.setRoll(e)}setFov(e){this._helper.setFov(e)}setZoom(e){this._helper.setZoom(e)}setCenter(e){this._helper.setCenter(e)}setElevation(e){this._helper.setElevation(e)}setMinElevationForCurrentTile(e){this._helper.setMinElevationForCurrentTile(e)}setPadding(e){this._helper.setPadding(e)}interpolatePadding(e,i,s){return this._helper.interpolatePadding(e,i,s)}isPaddingEqual(e){return this._helper.isPaddingEqual(e)}resize(e,i){this._helper.resize(e,i)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(e){this._helper.setMaxBounds(e)}overrideNearFarZ(e,i){this._helper.overrideNearFarZ(e,i)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(e){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),e)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(e){}constructor(){this._cachedClippingPlane=c.bg(),this._projectionMatrix=c.b0(),this._globeViewProjMatrix32f=c.a$(),this._globeViewProjMatrixNoCorrection=c.b0(),this._globeViewProjMatrixNoCorrectionInverted=c.b0(),this._globeProjMatrixInverted=c.b0(),this._cameraPosition=c.bh(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new ps({calcMatrices:()=>{this._calcMatrices()},getConstrained:(e,i)=>this.getConstrained(e,i)}),this._coveringTilesDetailsProvider=new ph}clone(){const e=new xs;return e.apply(this),e}apply(e,i){this._globeLatitudeErrorCorrectionRadians=i||0,this._helper.apply(e)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const e=c.bh();return e[0]=this._cameraPosition[0],e[1]=this._cameraPosition[1],e[2]=this._cameraPosition[2],e}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(e){const{overscaledTileID:i,applyGlobeMatrix:s}=e,o=this._helper.getMercatorTileCoordinates(i);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:o,clippingPlane:this._cachedClippingPlane,projectionTransition:s?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(e){const i=this.pitchInRadians,s=this.cameraToCenterDistance/e,o=Math.sin(i)*s,u=Math.cos(i)*s+1,f=1/Math.sqrt(o*o+u*u)*1;let g=-o,y=u;const x=Math.sqrt(g*g+y*y);g/=x,y/=x;const T=[0,g,y];return c.bi(T,T,[0,0,0],-this.bearingInRadians),c.bj(T,T,[0,0,0],-1*this.center.lat*Math.PI/180),c.bk(T,T,[0,0,0],this.center.lng*Math.PI/180),c.aN(T,T,.25),[...T,.25*-f]}isLocationOccluded(e){return!this.isSurfacePointVisible(lr(e))}transformLightDirection(e){const i=this._helper._center.lng*Math.PI/180,s=this._helper._center.lat*Math.PI/180,o=Math.cos(s),u=[Math.sin(i)*o,Math.sin(s),Math.cos(i)*o],f=[u[2],0,-u[0]],g=[0,0,0];c.aT(g,f,u),c.aS(f,f),c.aS(g,g);const y=[0,0,0];return c.aS(y,[f[0]*e[0]+g[0]*e[1]+u[0]*e[2],f[1]*e[0]+g[1]*e[1]+u[1]*e[2],f[2]*e[0]+g[2]*e[1]+u[2]*e[2]]),y}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(e,i,s){const o=function(g,y,x){const T=1/(1<<x.z);return new c.$(g/c.Z*T+x.x*T,y/c.Z*T+x.y*T)}(e,i,s.canonical),u=(f=o.y,[c.bf(o.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-f*Math.PI*2))-.5*Math.PI]);var f;return this.getCircleRadiusCorrection()/Math.cos(u[1])}projectTileCoordinates(e,i,s,o){const u=s.canonical,f=Ba(e,i,u.x,u.y,u.z),g=1+(o?o(e,i):0)/c.bq,y=[f[0]*g,f[1]*g,f[2]*g,1];c.ao(y,y,this._globeViewProjMatrixNoCorrection);const x=this._cachedClippingPlane,T=x[0]*f[0]+x[1]*f[1]+x[2]*f[2]+x[3]<0;return{point:new c.P(y[0]/y[3],y[1]/y[3]),signedDistanceFromCamera:y[3],isOccluded:T}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const e=cr(this.worldSize,this.center.lat),i=c.b1(),s=c.b1();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*e),c.aX(i,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const o=this.centerOffset;i[8]=2*-o.x/this._helper._width,i[9]=2*o.y/this._helper._height,this._projectionMatrix=c.aY(i),this._globeProjMatrixInverted=c.b1(),c.ai(this._globeProjMatrixInverted,i),c.L(i,i,[0,0,-this.cameraToCenterDistance]),c.aZ(i,i,this.rollInRadians),c.a_(i,i,-this.pitchInRadians),c.aZ(i,i,this.bearingInRadians),c.L(i,i,[0,0,-e]);const u=c.bh();u[0]=e,u[1]=e,u[2]=e,c.a_(s,i,this.center.lat*Math.PI/180),c.bl(s,s,-this.center.lng*Math.PI/180),c.M(s,s,u),this._globeViewProjMatrixNoCorrection=s,c.a_(i,i,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),c.bl(i,i,-this.center.lng*Math.PI/180),c.M(i,i,u),this._globeViewProjMatrix32f=new Float32Array(i),this._globeViewProjMatrixNoCorrectionInverted=c.b1(),c.ai(this._globeViewProjMatrixNoCorrectionInverted,s);const f=c.bh();this._cameraPosition=c.bh(),this._cameraPosition[2]=this.cameraToCenterDistance/e,c.bi(this._cameraPosition,this._cameraPosition,f,-this.rollInRadians),c.bj(this._cameraPosition,this._cameraPosition,f,this.pitchInRadians),c.bi(this._cameraPosition,this._cameraPosition,f,-this.bearingInRadians),c.aO(this._cameraPosition,this._cameraPosition,[0,0,1]),c.bj(this._cameraPosition,this._cameraPosition,f,-this.center.lat*Math.PI/180),c.bk(this._cameraPosition,this._cameraPosition,f,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(e);const g=c.aY(this._globeViewProjMatrixNoCorrectionInverted);c.M(g,g,[1,1,-1]),this._cachedFrustum=Mn.fromInvProjectionMatrix(g)}calculateFogMatrix(e){c.w("calculateFogMatrix is not supported on globe projection.");const i=c.b1();return c.as(i),i}getVisibleUnwrappedCoordinates(e){return[new c.aV(0,e)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(e){e&&c.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(e,i){if(!this._globeViewProjMatrixNoCorrection)return 1;const s=lr(e);c.aN(s,s,1+i/c.bq);const o=c.bg();return c.ao(o,[s[0],s[1],s[2],1],this._globeViewProjMatrixNoCorrection),o[2]/o[3]}populateCache(e){}getBounds(){const e=.5*this.width,i=.5*this.height,s=[new c.P(0,0),new c.P(e,0),new c.P(this.width,0),new c.P(this.width,i),new c.P(this.width,this.height),new c.P(e,this.height),new c.P(0,this.height),new c.P(0,i)],o=[];for(const M of s)o.push(this.unprojectScreenPoint(M));let u=0,f=0,g=0,y=0;const x=this.center;for(const M of o){const S=c.bm(x.lng,M.lng),z=c.bm(x.lat,M.lat);S<f&&(f=S),S>u&&(u=S),z<y&&(y=z),z>g&&(g=z)}const T=[x.lng+f,x.lat+y,x.lng+u,x.lat+g];return this.isSurfacePointOnScreen([0,1,0])&&(T[3]=90,T[0]=-180,T[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(T[1]=-90,T[0]=-180,T[2]=180),new ci(T)}getConstrained(e,i){const s=c.ad(e.lat,-85.051129,c.aI),o=c.ad(+i,this.minZoom+zi(0,s),this.maxZoom);return{center:new c.Q(e.lng,s),zoom:o}}calculateCenterFromCameraLngLatAlt(e,i,s,o){return this._helper.calculateCenterFromCameraLngLatAlt(e,i,s,o)}setLocationAtPoint(e,i){const s=lr(this.unprojectScreenPoint(i)),o=lr(e),u=c.bh();c.bn(u);const f=c.bh();c.bk(f,s,u,-this.center.lng*Math.PI/180),c.bj(f,f,u,this.center.lat*Math.PI/180);const g=o[0]*o[0]+o[2]*o[2],y=f[0]*f[0];if(g<y)return;const x=Math.sqrt(g-y),T=-x,M=c.bo(o[0],o[2],f[0],x),S=c.bo(o[0],o[2],f[0],T),z=c.bh();c.bk(z,o,u,-M);const R=c.bo(z[1],z[2],f[1],f[2]),V=c.bh();c.bk(V,o,u,-S);const j=c.bo(V[1],V[2],f[1],f[2]),N=.5*Math.PI,$=R>=-N&&R<=N,W=j>=-N&&j<=N;let X,J;if($&&W){const fe=this.center.lng*Math.PI/180,xe=this.center.lat*Math.PI/180;c.br(M,fe)+c.br(R,xe)<c.br(S,fe)+c.br(j,xe)?(X=M,J=R):(X=S,J=j)}else if($)X=M,J=R;else{if(!W)return;X=S,J=j}const ie=X/Math.PI*180,Q=J/Math.PI*180,de=this.center.lat;this.setCenter(new c.Q(ie,c.ad(Q,-90,90))),this.setZoom(this.zoom+zi(de,this.center.lat))}locationToScreenPoint(e,i){const s=lr(e);if(i){const o=i.getElevationForLngLatZoom(e,this._helper._tileZoom);c.aN(s,s,1+o/c.bq)}return this._projectSurfacePointToScreen(s)}_projectSurfacePointToScreen(e){const i=c.bg();return c.ao(i,[...e,1],this._globeViewProjMatrixNoCorrection),i[0]/=i[3],i[1]/=i[3],new c.P((.5*i[0]+.5)*this.width,(.5*-i[1]+.5)*this.height)}screenPointToMercatorCoordinate(e,i){if(i){const s=i.pointCoordinate(e);if(s)return s}return c.$.fromLngLat(this.unprojectScreenPoint(e))}screenPointToLocation(e,i){var s;return(s=this.screenPointToMercatorCoordinate(e,i))===null||s===void 0?void 0:s.toLngLat()}isPointOnMapSurface(e,i){const s=this._cameraPosition,o=this.getRayDirectionFromPixel(e);return!!this.rayPlanetIntersection(s,o)}getRayDirectionFromPixel(e){const i=c.bg();i[0]=e.x/this.width*2-1,i[1]=-1*(e.y/this.height*2-1),i[2]=1,i[3]=1,c.ao(i,i,this._globeViewProjMatrixNoCorrectionInverted),i[0]/=i[3],i[1]/=i[3],i[2]/=i[3];const s=c.bh();s[0]=i[0]-this._cameraPosition[0],s[1]=i[1]-this._cameraPosition[1],s[2]=i[2]-this._cameraPosition[2];const o=c.bh();return c.aS(o,s),o}isSurfacePointVisible(e){const i=this._cachedClippingPlane;return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]>=0}isSurfacePointOnScreen(e){if(!this.isSurfacePointVisible(e))return!1;const i=c.bg();return c.ao(i,[...e,1],this._globeViewProjMatrixNoCorrection),i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[0]>-1&&i[0]<1&&i[1]>-1&&i[1]<1&&i[2]>-1&&i[2]<1}rayPlanetIntersection(e,i){const s=c.aU(e,i),o=c.bh(),u=c.bh();c.aN(u,i,s),c.aR(o,e,u);const f=1-c.aU(o,o);if(f<0)return null;const g=c.aU(e,e)-1,y=-s+(s<0?1:-1)*Math.sqrt(f),x=g/y,T=y;return{tMin:Math.min(x,T),tMax:Math.max(x,T)}}unprojectScreenPoint(e){const i=this._cameraPosition,s=this.getRayDirectionFromPixel(e),o=this.rayPlanetIntersection(i,s);if(o){const x=c.bh();c.aO(x,i,[s[0]*o.tMin,s[1]*o.tMin,s[2]*o.tMin]);const T=c.bh();return c.aS(T,x),_s(T)}const u=this._cachedClippingPlane[0]*s[0]+this._cachedClippingPlane[1]*s[1]+this._cachedClippingPlane[2]*s[2],f=-c.bp(this._cachedClippingPlane,i)/u,g=c.bh();if(f>0)c.aO(g,i,[s[0]*f,s[1]*f,s[2]*f]);else{const x=c.bh();c.aO(x,i,[2*s[0],2*s[1],2*s[2]]);const T=c.bp(this._cachedClippingPlane,x);c.aR(g,x,[this._cachedClippingPlane[0]*T,this._cachedClippingPlane[1]*T,this._cachedClippingPlane[2]*T])}const y=c.bh();return c.aS(y,g),_s(y)}getMatrixForModel(e,i){const s=c.Q.convert(e),o=1/c.bq,u=c.b0();return c.bl(u,u,s.lng/180*Math.PI),c.a_(u,u,-s.lat/180*Math.PI),c.L(u,u,[0,0,1+i/c.bq]),c.a_(u,u,.5*Math.PI),c.M(u,u,[o,o,o]),u}getProjectionDataForCustomLayer(e=!0){const i=this.getProjectionData({overscaledTileID:new c.Y(0,0,0,0,0),applyGlobeMatrix:e});return i.tileMercatorCoords=[0,0,1,1],i}getFastPathSimpleProjectionMatrix(e){}}class bs{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(e){this._helper.setMinZoom(e)}setMaxZoom(e){this._helper.setMaxZoom(e)}setMinPitch(e){this._helper.setMinPitch(e)}setMaxPitch(e){this._helper.setMaxPitch(e)}setRenderWorldCopies(e){this._helper.setRenderWorldCopies(e)}setBearing(e){this._helper.setBearing(e)}setPitch(e){this._helper.setPitch(e)}setRoll(e){this._helper.setRoll(e)}setFov(e){this._helper.setFov(e)}setZoom(e){this._helper.setZoom(e)}setCenter(e){this._helper.setCenter(e)}setElevation(e){this._helper.setElevation(e)}setMinElevationForCurrentTile(e){this._helper.setMinElevationForCurrentTile(e)}setPadding(e){this._helper.setPadding(e)}interpolatePadding(e,i,s){return this._helper.interpolatePadding(e,i,s)}isPaddingEqual(e){return this._helper.isPaddingEqual(e)}resize(e,i,s=!0){this._helper.resize(e,i,s)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(e){this._helper.setMaxBounds(e)}overrideNearFarZ(e,i){this._helper.overrideNearFarZ(e,i)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(e){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),e)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(e,i){this._globeness=e,this._globeLatitudeErrorCorrectionRadians=i,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().recalculateCache(),this._mercatorTransform.getCoveringTilesDetailsProvider().recalculateCache()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new ps({calcMatrices:()=>{this._calcMatrices()},getConstrained:(e,i)=>this.getConstrained(e,i)}),this._globeness=1,this._mercatorTransform=new Or,this._verticalPerspectiveTransform=new xs}clone(){const e=new bs;return e._globeness=this._globeness,e._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,e.apply(this),e}apply(e){this._helper.apply(e),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(e){const i=this._mercatorTransform.getProjectionData(e),s=this._verticalPerspectiveTransform.getProjectionData(e);return{mainMatrix:this.isGlobeRendering?s.mainMatrix:i.mainMatrix,clippingPlane:s.clippingPlane,tileMercatorCoords:s.tileMercatorCoords,projectionTransition:e.applyGlobeMatrix?this._globeness:0,fallbackMatrix:i.fallbackMatrix}}isLocationOccluded(e){return this.currentTransform.isLocationOccluded(e)}transformLightDirection(e){return this.currentTransform.transformLightDirection(e)}getPixelScale(){return c.bb(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return c.bb(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(e,i,s){const o=this._mercatorTransform.getPitchedTextCorrection(e,i,s),u=this._verticalPerspectiveTransform.getPitchedTextCorrection(e,i,s);return c.bb(o,u,this._globeness)}projectTileCoordinates(e,i,s,o){return this.currentTransform.projectTileCoordinates(e,i,s,o)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(e){return this.currentTransform.calculateFogMatrix(e)}getVisibleUnwrappedCoordinates(e){return this.currentTransform.getVisibleUnwrappedCoordinates(e)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(e){this._mercatorTransform.recalculateZoomAndCenter(e),this._verticalPerspectiveTransform.recalculateZoomAndCenter(e)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(e,i){return this.currentTransform.lngLatToCameraDepth(e,i)}populateCache(e){this._mercatorTransform.populateCache(e),this._verticalPerspectiveTransform.populateCache(e)}getBounds(){return this.currentTransform.getBounds()}getConstrained(e,i){return this.currentTransform.getConstrained(e,i)}calculateCenterFromCameraLngLatAlt(e,i,s,o){return this._helper.calculateCenterFromCameraLngLatAlt(e,i,s,o)}setLocationAtPoint(e,i){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(e,i),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(e,i),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(e,i){return this.currentTransform.locationToScreenPoint(e,i)}screenPointToMercatorCoordinate(e,i){return this.currentTransform.screenPointToMercatorCoordinate(e,i)}screenPointToLocation(e,i){return this.currentTransform.screenPointToLocation(e,i)}isPointOnMapSurface(e,i){return this.currentTransform.isPointOnMapSurface(e,i)}getRayDirectionFromPixel(e){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(e)}getMatrixForModel(e,i){return this.currentTransform.getMatrixForModel(e,i)}getProjectionDataForCustomLayer(e=!0){const i=this._mercatorTransform.getProjectionDataForCustomLayer(e);if(!this.isGlobeRendering)return i;const s=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(e);return s.fallbackMatrix=i.mainMatrix,s}getFastPathSimpleProjectionMatrix(e){return this.currentTransform.getFastPathSimpleProjectionMatrix(e)}}class xr{get useGlobeControls(){return!0}handlePanInertia(e,i){const s=Do(e,i);return Math.abs(s.lng-i.center.lng)>180&&(s.lng=i.center.lng+179.5*Math.sign(s.lng-i.center.lng)),{easingCenter:s,easingOffset:new c.P(0,0)}}handleMapControlsRollPitchBearingZoom(e,i){const s=e.around,o=i.screenPointToLocation(s);e.bearingDelta&&i.setBearing(i.bearing+e.bearingDelta),e.pitchDelta&&i.setPitch(i.pitch+e.pitchDelta),e.rollDelta&&i.setRoll(i.roll+e.rollDelta);const u=i.zoom;e.zoomDelta&&i.setZoom(i.zoom+e.zoomDelta);const f=i.zoom-u;if(f===0)return;const g=c.bm(i.center.lng,o.lng),y=g/(Math.abs(g/180)+1),x=c.bm(i.center.lat,o.lat),T=i.getRayDirectionFromPixel(s),M=i.cameraPosition,S=-1*c.aU(M,T),z=c.bh();c.aO(z,M,[T[0]*S,T[1]*S,T[2]*S]);const R=c.bs(z)-1,V=Math.exp(.5*-Math.max(R-.3,0)),j=cr(i.worldSize,i.center.lat)/Math.min(i.width,i.height),N=c.be(j,.9,.5,1,.25),$=(1-c.aH(-f))*Math.min(V,N),W=i.center.lat,X=i.zoom,J=new c.Q(i.center.lng+y*$,c.ad(i.center.lat+x*$,-85.051129,c.aI));i.setLocationAtPoint(o,s);const ie=i.center,Q=c.be(Math.abs(g),45,85,0,1),de=c.be(j,.75,.35,0,1),fe=Math.pow(Math.max(Q,de),.25),xe=c.bm(ie.lng,J.lng),we=c.bm(ie.lat,J.lat);i.setCenter(new c.Q(ie.lng+xe*fe,ie.lat+we*fe).wrap()),i.setZoom(X+zi(W,i.center.lat))}handleMapControlsPan(e,i,s){if(!e.panDelta)return;const o=i.center.lat,u=i.zoom;i.setCenter(Do(e.panDelta,i).wrap()),i.setZoom(u+zi(o,i.center.lat))}cameraForBoxAndBearing(e,i,s,o,u){const f=ko(e,i,s,o,u),g=i.left/u.width*2-1,y=(u.width-i.right)/u.width*2-1,x=i.top/u.height*-2+1,T=(u.height-i.bottom)/u.height*-2+1,M=c.bm(s.getWest(),s.getEast())<0,S=M?s.getEast():s.getWest(),z=M?s.getWest():s.getEast(),R=Math.max(s.getNorth(),s.getSouth()),V=Math.min(s.getNorth(),s.getSouth()),j=S+.5*c.bm(S,z),N=R+.5*c.bm(R,V),$=u.clone();$.setCenter(f.center),$.setBearing(f.bearing),$.setPitch(0),$.setRoll(0),$.setZoom(f.zoom);const W=$.modelViewProjectionMatrix,X=[lr(s.getNorthWest()),lr(s.getNorthEast()),lr(s.getSouthWest()),lr(s.getSouthEast()),lr(new c.Q(z,N)),lr(new c.Q(S,N)),lr(new c.Q(j,R)),lr(new c.Q(j,V))],J=lr(f.center);let ie=Number.POSITIVE_INFINITY;for(const Q of X)g<0&&(ie=xr.getLesserNonNegativeNonNull(ie,xr.solveVectorScale(Q,J,W,"x",g))),y>0&&(ie=xr.getLesserNonNegativeNonNull(ie,xr.solveVectorScale(Q,J,W,"x",y))),x>0&&(ie=xr.getLesserNonNegativeNonNull(ie,xr.solveVectorScale(Q,J,W,"y",x))),T<0&&(ie=xr.getLesserNonNegativeNonNull(ie,xr.solveVectorScale(Q,J,W,"y",T)));if(Number.isFinite(ie)&&ie!==0)return f.zoom=$.zoom+c.aa(ie),f;Da()}handleJumpToCenterZoom(e,i){const s=e.center.lat,o=e.getConstrained(i.center?c.Q.convert(i.center):e.center,e.zoom).center;e.setCenter(o.wrap());const u=i.zoom!==void 0?+i.zoom:e.zoom+zi(s,o.lat);e.zoom!==u&&e.setZoom(u)}handleEaseTo(e,i){const s=e.zoom,o=e.center,u=e.padding,f={roll:e.roll,pitch:e.pitch,bearing:e.bearing},g={roll:i.roll===void 0?e.roll:i.roll,pitch:i.pitch===void 0?e.pitch:i.pitch,bearing:i.bearing===void 0?e.bearing:i.bearing},y=i.zoom!==void 0,x=!e.isPaddingEqual(i.padding);let T=!1;const M=i.center?c.Q.convert(i.center):o,S=e.getConstrained(M,s).center;mr(e,S);const z=e.clone();z.setCenter(S),z.setZoom(y?+i.zoom:s+zi(o.lat,M.lat)),z.setBearing(i.bearing);const R=new c.P(c.ad(e.centerPoint.x+i.offsetAsPoint.x,0,e.width),c.ad(e.centerPoint.y+i.offsetAsPoint.y,0,e.height));z.setLocationAtPoint(S,R);const V=(i.offset&&i.offsetAsPoint.mag())>0?z.center:S,j=y?+i.zoom:s+zi(o.lat,V.lat),N=s+zi(o.lat,0),$=j+zi(V.lat,0),W=c.bm(o.lng,V.lng),X=c.bm(o.lat,V.lat),J=c.aH($-N);return T=j!==s,{easeFunc:ie=>{if(c.b5(f,g)||jr({startEulerAngles:f,endEulerAngles:g,tr:e,k:ie,useSlerp:f.roll!=g.roll}),x&&e.interpolatePadding(u,i.padding,ie),i.around)c.w("Easing around a point is not supported under globe projection."),e.setLocationAtPoint(i.around,i.aroundPoint);else{const Q=$>N?Math.min(2,J):Math.max(.5,J),de=Math.pow(Q,1-ie),fe=Bn(o,W,X,ie*de);e.setCenter(fe.wrap())}if(T){const Q=c.B.number(N,$,ie)+zi(0,e.center.lat);e.setZoom(Q)}},isZooming:T,elevationCenter:V}}handleFlyTo(e,i){const s=i.zoom!==void 0,o=e.center,u=e.zoom,f=e.padding,g=!e.isPaddingEqual(i.padding),y=e.getConstrained(c.Q.convert(i.center||i.locationAtOffset),u).center,x=s?+i.zoom:e.zoom+zi(e.center.lat,y.lat),T=e.clone();T.setCenter(y),T.setZoom(x),T.setBearing(i.bearing);const M=new c.P(c.ad(e.centerPoint.x+i.offsetAsPoint.x,0,e.width),c.ad(e.centerPoint.y+i.offsetAsPoint.y,0,e.height));T.setLocationAtPoint(y,M);const S=T.center;mr(e,S);const z=function(X,J,ie){const Q=lr(J),de=lr(ie),fe=c.aU(Q,de),xe=Math.acos(fe),we=zo(X);return xe/(2*Math.PI)*we}(e,o,S),R=u+zi(o.lat,0),V=x+zi(S.lat,0),j=c.aH(V-R);let N;if(typeof i.minZoom=="number"){const X=+i.minZoom+zi(S.lat,0),J=Math.min(X,R,V)+zi(0,S.lat),ie=e.getConstrained(S,J).zoom+zi(S.lat,0);N=c.aH(ie-R)}const $=c.bm(o.lng,S.lng),W=c.bm(o.lat,S.lat);return{easeFunc:(X,J,ie,Q)=>{const de=Bn(o,$,W,ie);g&&e.interpolatePadding(f,i.padding,X);const fe=X===1?S:de;e.setCenter(fe.wrap());const xe=R+c.aa(J);e.setZoom(X===1?x:xe+zi(0,fe.lat))},scaleOfZoom:j,targetCenter:S,scaleOfMinZoom:N,pixelPathLength:z}}static solveVectorScale(e,i,s,o,u){const f=o==="x"?[s[0],s[4],s[8],s[12]]:[s[1],s[5],s[9],s[13]],g=[s[3],s[7],s[11],s[15]],y=e[0]*f[0]+e[1]*f[1]+e[2]*f[2],x=e[0]*g[0]+e[1]*g[1]+e[2]*g[2],T=i[0]*f[0]+i[1]*f[1]+i[2]*f[2],M=i[0]*g[0]+i[1]*g[1]+i[2]*g[2];return T+u*x===y+u*M||g[3]*(y-T)+f[3]*(M-x)+y*M==T*x?null:(T+f[3]-u*M-u*g[3])/(T-y-u*M+u*x)}static getLesserNonNegativeNonNull(e,i){return i!==null&&i>=0&&i<e?i:e}}class ws{constructor(e){this._globe=e,this._mercatorCameraHelper=new Yr,this._verticalPerspectiveCameraHelper=new xr}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(e,i){return this.currentHelper.handlePanInertia(e,i)}handleMapControlsRollPitchBearingZoom(e,i){return this.currentHelper.handleMapControlsRollPitchBearingZoom(e,i)}handleMapControlsPan(e,i,s){this.currentHelper.handleMapControlsPan(e,i,s)}cameraForBoxAndBearing(e,i,s,o,u){return this.currentHelper.cameraForBoxAndBearing(e,i,s,o,u)}handleJumpToCenterZoom(e,i){this.currentHelper.handleJumpToCenterZoom(e,i)}handleEaseTo(e,i){return this.currentHelper.handleEaseTo(e,i)}handleFlyTo(e,i){return this.currentHelper.handleFlyTo(e,i)}}const On=(h,e)=>c.x(h,e&&e.filter(i=>i.identifier!=="source.canvas")),Lo=c.bt();class Oa extends c.E{constructor(e,i={}){super(),this._rtlPluginLoaded=()=>{for(const s in this.sourceCaches){const o=this.sourceCaches[s].getSource().type;o!=="vector"&&o!=="geojson"||this.sourceCaches[s].reload()}},this.map=e,this.dispatcher=new St(lt(),e._getMapId()),this.dispatcher.registerMessageHandler("GG",(s,o)=>this.getGlyphs(s,o)),this.dispatcher.registerMessageHandler("GI",(s,o)=>this.getImages(s,o)),this.imageManager=new Bt,this.imageManager.setEventedParent(this),this.glyphManager=new gt(e._requestManager,i.localIdeographFontFamily),this.lineAtlas=new Qt(256,512),this.crossTileSymbolIndex=new Io,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new c.bu,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",c.bv()),zt().on(Oe,this._rtlPluginLoaded),this.on("data",s=>{if(s.dataType!=="source"||s.sourceDataType!=="metadata")return;const o=this.sourceCaches[s.sourceId];if(!o)return;const u=o.getSource();if(u&&u.vectorLayerIds)for(const f in this._layers){const g=this._layers[f];g.source===u.id&&this._validateLayer(g)}})}loadURL(e,i={},s){this.fire(new c.l("dataloading",{dataType:"style"})),i.validate=typeof i.validate!="boolean"||i.validate;const o=this.map._requestManager.transformRequest(e,"Style");this._loadStyleRequest=new AbortController;const u=this._loadStyleRequest;c.j(o,this._loadStyleRequest).then(f=>{this._loadStyleRequest=null,this._load(f.data,i,s)}).catch(f=>{this._loadStyleRequest=null,f&&!u.signal.aborted&&this.fire(new c.k(f))})}loadJSON(e,i={},s){this.fire(new c.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,Pe.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,i.validate=i.validate!==!1,this._load(e,i,s)}).catch(()=>{})}loadEmpty(){this.fire(new c.l("dataloading",{dataType:"style"})),this._load(Lo,{validate:!1})}_load(e,i,s){var o,u;const f=i.transformStyle?i.transformStyle(s,e):e;if(!i.validate||!On(this,c.y(f))){this._loaded=!0,this.stylesheet=f;for(const g in f.sources)this.addSource(g,f.sources[g],{validate:!1});f.sprite?this._loadSprite(f.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(f.glyphs),this._createLayers(),this.light=new ai(this.stylesheet.light),this._setProjectionInternal(((o=this.stylesheet.projection)===null||o===void 0?void 0:o.type)||"mercator"),this.sky=new Tt(this.stylesheet.sky),this.map.setTerrain((u=this.stylesheet.terrain)!==null&&u!==void 0?u:null),this.fire(new c.l("data",{dataType:"style"})),this.fire(new c.l("style.load"))}}_createLayers(){const e=c.bw(this.stylesheet.layers);this.dispatcher.broadcast("SL",e),this._order=e.map(i=>i.id),this._layers={},this._serializedLayers=null;for(const i of e){const s=c.bx(i);s.setEventedParent(this,{layer:{id:i.id}}),this._layers[i.id]=s}}_loadSprite(e,i=!1,s=void 0){let o;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(u,f,g,y){return c._(this,void 0,void 0,function*(){const x=tt(u),T=g>1?"@2x":"",M={},S={};for(const{id:z,url:R}of x){const V=f.transformRequest(Ue(R,T,".json"),"SpriteJSON");M[z]=c.j(V,y);const j=f.transformRequest(Ue(R,T,".png"),"SpriteImage");S[z]=Ze.getImage(j,y)}return yield Promise.all([...Object.values(M),...Object.values(S)]),function(z,R){return c._(this,void 0,void 0,function*(){const V={};for(const j in z){V[j]={};const N=Pe.getImageCanvasContext((yield R[j]).data),$=(yield z[j]).data;for(const W in $){const{width:X,height:J,x:ie,y:Q,sdf:de,pixelRatio:fe,stretchX:xe,stretchY:we,content:ve,textFitWidth:Le,textFitHeight:Re}=$[W];V[j][W]={data:null,pixelRatio:fe,sdf:de,stretchX:xe,stretchY:we,content:ve,textFitWidth:Le,textFitHeight:Re,spriteData:{width:X,height:J,x:ie,y:Q,context:N}}}}return V})}(M,S)})}(e,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(u=>{if(this._spriteRequest=null,u)for(const f in u){this._spritesImagesIds[f]=[];const g=this._spritesImagesIds[f]?this._spritesImagesIds[f].filter(y=>!(y in u)):[];for(const y of g)this.imageManager.removeImage(y),this._changedImages[y]=!0;for(const y in u[f]){const x=f==="default"?y:`${f}:${y}`;this._spritesImagesIds[f].push(x),x in this.imageManager.images?this.imageManager.updateImage(x,u[f][y],!1):this.imageManager.addImage(x,u[f][y]),i&&(this._changedImages[x]=!0)}}}).catch(u=>{this._spriteRequest=null,o=u,this.fire(new c.k(o))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),i&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new c.l("data",{dataType:"style"})),s&&s(o)})}_unloadSprite(){for(const e of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(e),this._changedImages[e]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new c.l("data",{dataType:"style"}))}_validateLayer(e){const i=this.sourceCaches[e.source];if(!i)return;const s=e.sourceLayer;if(!s)return;const o=i.getSource();(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(s)===-1)&&this.fire(new c.k(new Error(`Source layer "${s}" does not exist on source "${o.id}" as specified by style layer "${e.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const e in this.sourceCaches)if(!this.sourceCaches[e].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(e,i=!1){const s=this._serializedAllLayers();if(!e||e.length===0)return Object.values(i?c.by(s):s);const o=[];for(const u of e)if(s[u]){const f=i?c.by(s[u]):s[u];o.push(f)}return o}_serializedAllLayers(){let e=this._serializedLayers;if(e)return e;e=this._serializedLayers={};const i=Object.keys(this._layers);for(const s of i){const o=this._layers[s];o.type!=="custom"&&(e[s]=o.serialize())}return e}hasTransitions(){var e,i,s;if(!((e=this.light)===null||e===void 0)&&e.hasTransition()||!((i=this.sky)===null||i===void 0)&&i.hasTransition()||!((s=this.projection)===null||s===void 0)&&s.hasTransition())return!0;for(const o in this.sourceCaches)if(this.sourceCaches[o].hasTransition())return!0;for(const o in this._layers)if(this._layers[o].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(e){if(!this._loaded)return;const i=this._changed;if(i){const o=Object.keys(this._updatedLayers),u=Object.keys(this._removedLayers);(o.length||u.length)&&this._updateWorkerLayers(o,u);for(const f in this._updatedSources){const g=this._updatedSources[f];if(g==="reload")this._reloadSource(f);else{if(g!=="clear")throw new Error(`Invalid action ${g}`);this._clearSource(f)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const f in this._updatedPaintProps)this._layers[f].updateTransitions(e);this.light.updateTransitions(e),this.sky.updateTransitions(e),this._resetUpdates()}const s={};for(const o in this.sourceCaches){const u=this.sourceCaches[o];s[o]=u.used,u.used=!1}for(const o of this._order){const u=this._layers[o];u.recalculate(e,this._availableImages),!u.isHidden(e.zoom)&&u.source&&(this.sourceCaches[u.source].used=!0)}for(const o in s){const u=this.sourceCaches[o];!!s[o]!=!!u.used&&u.fire(new c.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:o}))}this.light.recalculate(e),this.sky.recalculate(e),this.projection.recalculate(e),this.z=e.zoom,i&&this.fire(new c.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const e=Object.keys(this._changedImages);if(e.length){for(const i in this.sourceCaches)this.sourceCaches[i].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const e in this.sourceCaches)this.sourceCaches[e].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(e,i){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(e,!1),removedIds:i})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(e,i={}){var s;this._checkLoaded();const o=this.serialize();if(e=i.transformStyle?i.transformStyle(o,e):e,((s=i.validate)===null||s===void 0||s)&&On(this,c.y(e)))return!1;(e=c.by(e)).layers=c.bw(e.layers);const u=c.bz(o,e),f=this._getOperationsToPerform(u);if(f.unimplemented.length>0)throw new Error(`Unimplemented: ${f.unimplemented.join(", ")}.`);if(f.operations.length===0)return!1;for(const g of f.operations)g();return this.stylesheet=e,this._serializedLayers=null,!0}_getOperationsToPerform(e){const i=[],s=[];for(const o of e)switch(o.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":i.push(()=>this.addLayer.apply(this,o.args));break;case"removeLayer":i.push(()=>this.removeLayer.apply(this,o.args));break;case"setPaintProperty":i.push(()=>this.setPaintProperty.apply(this,o.args));break;case"setLayoutProperty":i.push(()=>this.setLayoutProperty.apply(this,o.args));break;case"setFilter":i.push(()=>this.setFilter.apply(this,o.args));break;case"addSource":i.push(()=>this.addSource.apply(this,o.args));break;case"removeSource":i.push(()=>this.removeSource.apply(this,o.args));break;case"setLayerZoomRange":i.push(()=>this.setLayerZoomRange.apply(this,o.args));break;case"setLight":i.push(()=>this.setLight.apply(this,o.args));break;case"setGeoJSONSourceData":i.push(()=>this.setGeoJSONSourceData.apply(this,o.args));break;case"setGlyphs":i.push(()=>this.setGlyphs.apply(this,o.args));break;case"setSprite":i.push(()=>this.setSprite.apply(this,o.args));break;case"setTerrain":i.push(()=>this.map.setTerrain.apply(this,o.args));break;case"setSky":i.push(()=>this.setSky.apply(this,o.args));break;case"setProjection":this.setProjection.apply(this,o.args);break;case"setTransition":i.push(()=>{});break;default:s.push(o.command)}return{operations:i,unimplemented:s}}addImage(e,i){if(this.getImage(e))return this.fire(new c.k(new Error(`An image named "${e}" already exists.`)));this.imageManager.addImage(e,i),this._afterImageUpdated(e)}updateImage(e,i){this.imageManager.updateImage(e,i)}getImage(e){return this.imageManager.getImage(e)}removeImage(e){if(!this.getImage(e))return this.fire(new c.k(new Error(`An image named "${e}" does not exist.`)));this.imageManager.removeImage(e),this._afterImageUpdated(e)}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(),this._changedImages[e]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new c.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(e,i,s={}){if(this._checkLoaded(),this.sourceCaches[e]!==void 0)throw new Error(`Source "${e}" already exists.`);if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(c.y.source,`sources.${e}`,i,null,s))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const o=this.sourceCaches[e]=new P(e,i,this.dispatcher);o.style=this,o.setEventedParent(this,()=>({isSourceLoaded:o.loaded(),source:o.serialize(),sourceId:e})),o.onAdd(this.map),this._changed=!0}removeSource(e){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error("There is no source with this ID");for(const s in this._layers)if(this._layers[s].source===e)return this.fire(new c.k(new Error(`Source "${e}" cannot be removed while layer "${s}" is using it.`)));const i=this.sourceCaches[e];delete this.sourceCaches[e],delete this._updatedSources[e],i.fire(new c.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:e})),i.setEventedParent(null),i.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(e,i){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error(`There is no source with this ID=${e}`);const s=this.sourceCaches[e].getSource();if(s.type!=="geojson")throw new Error(`geojsonSource.type is ${s.type}, which is !== 'geojson`);s.setData(i),this._changed=!0}getSource(e){return this.sourceCaches[e]&&this.sourceCaches[e].getSource()}addLayer(e,i,s={}){this._checkLoaded();const o=e.id;if(this.getLayer(o))return void this.fire(new c.k(new Error(`Layer "${o}" already exists on this map.`)));let u;if(e.type==="custom"){if(On(this,c.bA(e)))return;u=c.bx(e)}else{if("source"in e&&typeof e.source=="object"&&(this.addSource(o,e.source),e=c.by(e),e=c.e(e,{source:o})),this._validate(c.y.layer,`layers.${o}`,e,{arrayIndex:-1},s))return;u=c.bx(e),this._validateLayer(u),u.setEventedParent(this,{layer:{id:o}})}const f=i?this._order.indexOf(i):this._order.length;if(i&&f===-1)this.fire(new c.k(new Error(`Cannot add layer "${o}" before non-existing layer "${i}".`)));else{if(this._order.splice(f,0,o),this._layerOrderChanged=!0,this._layers[o]=u,this._removedLayers[o]&&u.source&&u.type!=="custom"){const g=this._removedLayers[o];delete this._removedLayers[o],g.type!==u.type?this._updatedSources[u.source]="clear":(this._updatedSources[u.source]="reload",this.sourceCaches[u.source].pause())}this._updateLayer(u),u.onAdd&&u.onAdd(this.map)}}moveLayer(e,i){if(this._checkLoaded(),this._changed=!0,!this._layers[e])return void this.fire(new c.k(new Error(`The layer '${e}' does not exist in the map's style and cannot be moved.`)));if(e===i)return;const s=this._order.indexOf(e);this._order.splice(s,1);const o=i?this._order.indexOf(i):this._order.length;i&&o===-1?this.fire(new c.k(new Error(`Cannot move layer "${e}" before non-existing layer "${i}".`))):(this._order.splice(o,0,e),this._layerOrderChanged=!0)}removeLayer(e){this._checkLoaded();const i=this._layers[e];if(!i)return void this.fire(new c.k(new Error(`Cannot remove non-existing layer "${e}".`)));i.setEventedParent(null);const s=this._order.indexOf(e);this._order.splice(s,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[e]=i,delete this._layers[e],this._serializedLayers&&delete this._serializedLayers[e],delete this._updatedLayers[e],delete this._updatedPaintProps[e],i.onRemove&&i.onRemove(this.map)}getLayer(e){return this._layers[e]}getLayersOrder(){return[...this._order]}hasLayer(e){return e in this._layers}setLayerZoomRange(e,i,s){this._checkLoaded();const o=this.getLayer(e);o?o.minzoom===i&&o.maxzoom===s||(i!=null&&(o.minzoom=i),s!=null&&(o.maxzoom=s),this._updateLayer(o)):this.fire(new c.k(new Error(`Cannot set the zoom range of non-existing layer "${e}".`)))}setFilter(e,i,s={}){this._checkLoaded();const o=this.getLayer(e);if(o){if(!c.bB(o.filter,i))return i==null?(o.filter=void 0,void this._updateLayer(o)):void(this._validate(c.y.filter,`layers.${o.id}.filter`,i,null,s)||(o.filter=c.by(i),this._updateLayer(o)))}else this.fire(new c.k(new Error(`Cannot filter non-existing layer "${e}".`)))}getFilter(e){return c.by(this.getLayer(e).filter)}setLayoutProperty(e,i,s,o={}){this._checkLoaded();const u=this.getLayer(e);u?c.bB(u.getLayoutProperty(i),s)||(u.setLayoutProperty(i,s,o),this._updateLayer(u)):this.fire(new c.k(new Error(`Cannot style non-existing layer "${e}".`)))}getLayoutProperty(e,i){const s=this.getLayer(e);if(s)return s.getLayoutProperty(i);this.fire(new c.k(new Error(`Cannot get style of non-existing layer "${e}".`)))}setPaintProperty(e,i,s,o={}){this._checkLoaded();const u=this.getLayer(e);u?c.bB(u.getPaintProperty(i),s)||(u.setPaintProperty(i,s,o)&&this._updateLayer(u),this._changed=!0,this._updatedPaintProps[e]=!0,this._serializedLayers=null):this.fire(new c.k(new Error(`Cannot style non-existing layer "${e}".`)))}getPaintProperty(e,i){return this.getLayer(e).getPaintProperty(i)}setFeatureState(e,i){this._checkLoaded();const s=e.source,o=e.sourceLayer,u=this.sourceCaches[s];if(u===void 0)return void this.fire(new c.k(new Error(`The source '${s}' does not exist in the map's style.`)));const f=u.getSource().type;f==="geojson"&&o?this.fire(new c.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):f!=="vector"||o?(e.id===void 0&&this.fire(new c.k(new Error("The feature id parameter must be provided."))),u.setFeatureState(o,e.id,i)):this.fire(new c.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(e,i){this._checkLoaded();const s=e.source,o=this.sourceCaches[s];if(o===void 0)return void this.fire(new c.k(new Error(`The source '${s}' does not exist in the map's style.`)));const u=o.getSource().type,f=u==="vector"?e.sourceLayer:void 0;u!=="vector"||f?i&&typeof e.id!="string"&&typeof e.id!="number"?this.fire(new c.k(new Error("A feature id is required to remove its specific state property."))):o.removeFeatureState(f,e.id,i):this.fire(new c.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(e){this._checkLoaded();const i=e.source,s=e.sourceLayer,o=this.sourceCaches[i];if(o!==void 0)return o.getSource().type!=="vector"||s?(e.id===void 0&&this.fire(new c.k(new Error("The feature id parameter must be provided."))),o.getFeatureState(s,e.id)):void this.fire(new c.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new c.k(new Error(`The source '${i}' does not exist in the map's style.`)))}getTransition(){return c.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const e=c.bC(this.sourceCaches,u=>u.serialize()),i=this._serializeByIds(this._order,!0),s=this.map.getTerrain()||void 0,o=this.stylesheet;return c.bD({version:o.version,name:o.name,metadata:o.metadata,light:o.light,sky:o.sky,center:o.center,zoom:o.zoom,bearing:o.bearing,pitch:o.pitch,sprite:o.sprite,glyphs:o.glyphs,transition:o.transition,projection:o.projection,sources:e,layers:i,terrain:s},u=>u!==void 0)}_updateLayer(e){this._updatedLayers[e.id]=!0,e.source&&!this._updatedSources[e.source]&&this.sourceCaches[e.source].getSource().type!=="raster"&&(this._updatedSources[e.source]="reload",this.sourceCaches[e.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(e){const i=f=>this._layers[f].type==="fill-extrusion",s={},o=[];for(let f=this._order.length-1;f>=0;f--){const g=this._order[f];if(i(g)){s[g]=f;for(const y of e){const x=y[g];if(x)for(const T of x)o.push(T)}}}o.sort((f,g)=>g.intersectionZ-f.intersectionZ);const u=[];for(let f=this._order.length-1;f>=0;f--){const g=this._order[f];if(i(g))for(let y=o.length-1;y>=0;y--){const x=o[y].feature;if(s[x.layer.id]<f)break;u.push(x),o.pop()}else for(const y of e){const x=y[g];if(x)for(const T of x)u.push(T.feature)}}return u}queryRenderedFeatures(e,i,s){i&&i.filter&&this._validate(c.y.filter,"queryRenderedFeatures.filter",i.filter,null,i);const o={};if(i&&i.layers){if(!(Array.isArray(i.layers)||i.layers instanceof Set))return this.fire(new c.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const x of i.layers){const T=this._layers[x];if(!T)return this.fire(new c.k(new Error(`The layer '${x}' does not exist in the map's style and cannot be queried for features.`))),[];o[T.source]=!0}}const u=[];i.availableImages=this._availableImages;const f=this._serializedAllLayers(),g=i.layers instanceof Set?i.layers:Array.isArray(i.layers)?new Set(i.layers):null,y=Object.assign(Object.assign({},i),{layers:g});for(const x in this.sourceCaches)i.layers&&!o[x]||u.push(_r(this.sourceCaches[x],this._layers,f,e,y,s));return this.placement&&u.push(function(x,T,M,S,z,R,V){const j={},N=R.queryRenderedSymbols(S),$=[];for(const W of Object.keys(N).map(Number))$.push(V[W]);$.sort(xi);for(const W of $){const X=W.featureIndex.lookupSymbolFeatures(N[W.bucketInstanceId],T,W.bucketIndex,W.sourceLayerIndex,z.filter,z.layers,z.availableImages,x);for(const J in X){const ie=j[J]=j[J]||[],Q=X[J];Q.sort((de,fe)=>{const xe=W.featureSortOrder;if(xe){const we=xe.indexOf(de.featureIndex);return xe.indexOf(fe.featureIndex)-we}return fe.featureIndex-de.featureIndex});for(const de of Q)ie.push(de)}}return function(W,X,J){for(const ie in W)for(const Q of W[ie])li(Q,J[X[ie].source]);return W}(j,x,M)}(this._layers,f,this.sourceCaches,e,y,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(u)}querySourceFeatures(e,i){i&&i.filter&&this._validate(c.y.filter,"querySourceFeatures.filter",i.filter,null,i);const s=this.sourceCaches[e];return s?function(o,u){const f=o.getRenderableIds().map(x=>o.getTileByID(x)),g=[],y={};for(let x=0;x<f.length;x++){const T=f[x],M=T.tileID.canonical.key;y[M]||(y[M]=!0,T.querySourceFeatures(g,u))}return g}(s,i):[]}getLight(){return this.light.getLight()}setLight(e,i={}){this._checkLoaded();const s=this.light.getLight();let o=!1;for(const f in e)if(!c.bB(e[f],s[f])){o=!0;break}if(!o)return;const u={now:Pe.now(),transition:c.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(e,i),this.light.updateTransitions(u)}getProjection(){var e;return(e=this.stylesheet)===null||e===void 0?void 0:e.projection}setProjection(e){if(this._checkLoaded(),this.projection){if(this.projection.name===e.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=e,this._setProjectionInternal(e.type)}getSky(){var e;return(e=this.stylesheet)===null||e===void 0?void 0:e.sky}setSky(e,i={}){this._checkLoaded();const s=this.getSky();let o=!1;if(!e&&!s)return;if(e&&!s)o=!0;else if(!e&&s)o=!0;else for(const f in e)if(!c.bB(e[f],s[f])){o=!0;break}if(!o)return;const u={now:Pe.now(),transition:c.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=e,this.sky.setSky(e,i),this.sky.updateTransitions(u)}_setProjectionInternal(e){const i=function(s){if(Array.isArray(s)){const o=new gs({type:s});return{projection:o,transform:new bs,cameraHelper:new ws(o)}}switch(s){case"mercator":return{projection:new Eo,transform:new Or,cameraHelper:new Yr};case"globe":{const o=new gs({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:o,transform:new bs,cameraHelper:new ws(o)}}case"vertical-perspective":return{projection:new ua,transform:new xs,cameraHelper:new xr};default:return c.w(`Unknown projection name: ${s}. Falling back to mercator projection.`),{projection:new Eo,transform:new Or,cameraHelper:new Yr}}}(e);this.projection=i.projection,this.map.migrateProjection(i.transform,i.cameraHelper);for(const s in this.sourceCaches)this.sourceCaches[s].reload()}_validate(e,i,s,o,u={}){return(!u||u.validate!==!1)&&On(this,e.call(c.y,c.e({key:i,style:this.serialize(),value:s,styleSpec:c.v},o)))}_remove(e=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),zt().off(Oe,this._rtlPluginLoaded);for(const i in this._layers)this._layers[i].setEventedParent(null);for(const i in this.sourceCaches){const s=this.sourceCaches[i];s.setEventedParent(null),s.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),e&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(e)}_clearSource(e){this.sourceCaches[e].clearTiles()}_reloadSource(e){this.sourceCaches[e].resume(),this.sourceCaches[e].reload()}_updateSources(e){for(const i in this.sourceCaches)this.sourceCaches[i].update(e,this.map.terrain)}_generateCollisionBoxes(){for(const e in this.sourceCaches)this._reloadSource(e)}_updatePlacement(e,i,s,o,u=!1){let f=!1,g=!1;const y={};for(const x of this._order){const T=this._layers[x];if(T.type!=="symbol")continue;if(!y[T.source]){const S=this.sourceCaches[T.source];y[T.source]=S.getRenderableIds(!0).map(z=>S.getTileByID(z)).sort((z,R)=>R.tileID.overscaledZ-z.tileID.overscaledZ||(z.tileID.isLessThan(R.tileID)?-1:1))}const M=this.crossTileSymbolIndex.addLayer(T,y[T.source],e.center.lng);f=f||M}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((u=u||this._layerOrderChanged||s===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(Pe.now(),e.zoom))&&(this.pauseablePlacement=new Mo(e,this.map.terrain,this._order,u,i,s,o,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,y),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(Pe.now()),g=!0),f&&this.pauseablePlacement.placement.setStale()),g||f)for(const x of this._order){const T=this._layers[x];T.type==="symbol"&&this.placement.updateLayerOpacities(T,y[T.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(Pe.now())}_releaseSymbolFadeTiles(){for(const e in this.sourceCaches)this.sourceCaches[e].releaseSymbolFadeTiles()}getImages(e,i){return c._(this,void 0,void 0,function*(){const s=yield this.imageManager.getImages(i.icons);this._updateTilesForChangedImages();const o=this.sourceCaches[i.source];return o&&o.setDependencies(i.tileID.key,i.type,i.icons),s})}getGlyphs(e,i){return c._(this,void 0,void 0,function*(){const s=yield this.glyphManager.getGlyphs(i.stacks),o=this.sourceCaches[i.source];return o&&o.setDependencies(i.tileID.key,i.type,[""]),s})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(e,i={}){this._checkLoaded(),e&&this._validate(c.y.glyphs,"glyphs",e,null,i)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=e,this.glyphManager.entries={},this.glyphManager.setURL(e))}addSprite(e,i,s={},o){this._checkLoaded();const u=[{id:e,url:i}],f=[...tt(this.stylesheet.sprite),...u];this._validate(c.y.sprite,"sprite",f,null,s)||(this.stylesheet.sprite=f,this._loadSprite(u,!0,o))}removeSprite(e){this._checkLoaded();const i=tt(this.stylesheet.sprite);if(i.find(s=>s.id===e)){if(this._spritesImagesIds[e])for(const s of this._spritesImagesIds[e])this.imageManager.removeImage(s),this._changedImages[s]=!0;i.splice(i.findIndex(s=>s.id===e),1),this.stylesheet.sprite=i.length>0?i:void 0,delete this._spritesImagesIds[e],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new c.l("data",{dataType:"style"}))}else this.fire(new c.k(new Error(`Sprite "${e}" doesn't exists on this map.`)))}getSprite(){return tt(this.stylesheet.sprite)}setSprite(e,i={},s){this._checkLoaded(),e&&this._validate(c.y.sprite,"sprite",e,null,i)||(this.stylesheet.sprite=e,e?this._loadSprite(e,!0,s):(this._unloadSprite(),s&&s(null)))}}var sn=c.aC([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class fh{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(e,i,s,o,u,f,g,y,x){this.context=e;let T=this.boundPaintVertexBuffers.length!==o.length;for(let M=0;!T&&M<o.length;M++)this.boundPaintVertexBuffers[M]!==o[M]&&(T=!0);!this.vao||this.boundProgram!==i||this.boundLayoutVertexBuffer!==s||T||this.boundIndexBuffer!==u||this.boundVertexOffset!==f||this.boundDynamicVertexBuffer!==g||this.boundDynamicVertexBuffer2!==y||this.boundDynamicVertexBuffer3!==x?this.freshBind(i,s,o,u,f,g,y,x):(e.bindVertexArray.set(this.vao),g&&g.bind(),u&&u.dynamicDraw&&u.bind(),y&&y.bind(),x&&x.bind())}freshBind(e,i,s,o,u,f,g,y){const x=e.numAttributes,T=this.context,M=T.gl;this.vao&&this.destroy(),this.vao=T.createVertexArray(),T.bindVertexArray.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=i,this.boundPaintVertexBuffers=s,this.boundIndexBuffer=o,this.boundVertexOffset=u,this.boundDynamicVertexBuffer=f,this.boundDynamicVertexBuffer2=g,this.boundDynamicVertexBuffer3=y,i.enableAttributes(M,e);for(const S of s)S.enableAttributes(M,e);f&&f.enableAttributes(M,e),g&&g.enableAttributes(M,e),y&&y.enableAttributes(M,e),i.bind(),i.setVertexAttribPointers(M,e,u);for(const S of s)S.bind(),S.setVertexAttribPointers(M,e,u);f&&(f.bind(),f.setVertexAttribPointers(M,e,u)),o&&o.bind(),g&&(g.bind(),g.setVertexAttribPointers(M,e,u)),y&&(y.bind(),y.setVertexAttribPointers(M,e,u)),T.currentNumAttributes=x}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Fo=(h,e,i,s,o)=>({u_texture:0,u_ele_delta:h,u_fog_matrix:e,u_fog_color:i?i.properties.get("fog-color"):c.b6.white,u_fog_ground_blend:i?i.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:o?0:i?i.calculateFogBlendOpacity(s):0,u_horizon_color:i?i.properties.get("horizon-color"):c.b6.white,u_horizon_fog_blend:i?i.properties.get("horizon-fog-blend"):1,u_is_globe_mode:o?1:0}),ja={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Sn(h){const e=[];for(let i=0;i<h.length;i++){if(h[i]===null)continue;const s=h[i].split(" ");e.push(s.pop())}return e}class mh{constructor(e,i,s,o,u,f,g,y){const x=e.gl;this.program=x.createProgram();const T=Sn(i.staticAttributes),M=s?s.getBinderAttributes():[],S=T.concat(M),z=Xr.prelude.staticUniforms?Sn(Xr.prelude.staticUniforms):[],R=g.staticUniforms?Sn(g.staticUniforms):[],V=i.staticUniforms?Sn(i.staticUniforms):[],j=s?s.getBinderUniforms():[],N=z.concat(R).concat(V).concat(j),$=[];for(const fe of N)$.indexOf(fe)<0&&$.push(fe);const W=s?s.defines():[];Vr(x)&&W.unshift("#version 300 es"),u&&W.push("#define OVERDRAW_INSPECTOR;"),f&&W.push("#define TERRAIN3D;"),y&&W.push(y);let X=W.concat(Xr.prelude.fragmentSource,g.fragmentSource,i.fragmentSource).join(`
`),J=W.concat(Xr.prelude.vertexSource,g.vertexSource,i.vertexSource).join(`
`);Vr(x)||(X=function(fe){return fe.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(X),J=function(fe){return fe.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(J));const ie=x.createShader(x.FRAGMENT_SHADER);if(x.isContextLost())return void(this.failedToCreate=!0);if(x.shaderSource(ie,X),x.compileShader(ie),!x.getShaderParameter(ie,x.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${x.getShaderInfoLog(ie)}`);x.attachShader(this.program,ie);const Q=x.createShader(x.VERTEX_SHADER);if(x.isContextLost())return void(this.failedToCreate=!0);if(x.shaderSource(Q,J),x.compileShader(Q),!x.getShaderParameter(Q,x.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${x.getShaderInfoLog(Q)}`);x.attachShader(this.program,Q),this.attributes={};const de={};this.numAttributes=S.length;for(let fe=0;fe<this.numAttributes;fe++)S[fe]&&(x.bindAttribLocation(this.program,fe,S[fe]),this.attributes[S[fe]]=fe);if(x.linkProgram(this.program),!x.getProgramParameter(this.program,x.LINK_STATUS))throw new Error(`Program failed to link: ${x.getProgramInfoLog(this.program)}`);x.deleteShader(Q),x.deleteShader(ie);for(let fe=0;fe<$.length;fe++){const xe=$[fe];if(xe&&!de[xe]){const we=x.getUniformLocation(this.program,xe);we&&(de[xe]=we)}}this.fixedUniforms=o(e,de),this.terrainUniforms=((fe,xe)=>({u_depth:new c.bE(fe,xe.u_depth),u_terrain:new c.bE(fe,xe.u_terrain),u_terrain_dim:new c.b7(fe,xe.u_terrain_dim),u_terrain_matrix:new c.bG(fe,xe.u_terrain_matrix),u_terrain_unpack:new c.bH(fe,xe.u_terrain_unpack),u_terrain_exaggeration:new c.b7(fe,xe.u_terrain_exaggeration)}))(e,de),this.projectionUniforms=((fe,xe)=>({u_projection_matrix:new c.bG(fe,xe.u_projection_matrix),u_projection_tile_mercator_coords:new c.bH(fe,xe.u_projection_tile_mercator_coords),u_projection_clipping_plane:new c.bH(fe,xe.u_projection_clipping_plane),u_projection_transition:new c.b7(fe,xe.u_projection_transition),u_projection_fallback_matrix:new c.bG(fe,xe.u_projection_fallback_matrix)}))(e,de),this.binderUniforms=s?s.getUniforms(e,de):[]}draw(e,i,s,o,u,f,g,y,x,T,M,S,z,R,V,j,N,$,W){const X=e.gl;if(this.failedToCreate)return;if(e.program.set(this.program),e.setDepthMode(s),e.setStencilMode(o),e.setColorMode(u),e.setCullFace(f),y){e.activeTexture.set(X.TEXTURE2),X.bindTexture(X.TEXTURE_2D,y.depthTexture),e.activeTexture.set(X.TEXTURE3),X.bindTexture(X.TEXTURE_2D,y.texture);for(const ie in this.terrainUniforms)this.terrainUniforms[ie].set(y[ie])}if(x)for(const ie in x)this.projectionUniforms[ja[ie]].set(x[ie]);if(g)for(const ie in this.fixedUniforms)this.fixedUniforms[ie].set(g[ie]);j&&j.setUniforms(e,this.binderUniforms,R,{zoom:V});let J=0;switch(i){case X.LINES:J=2;break;case X.TRIANGLES:J=3;break;case X.LINE_STRIP:J=1}for(const ie of z.get()){const Q=ie.vaos||(ie.vaos={});(Q[T]||(Q[T]=new fh)).bind(e,this,M,j?j.getPaintVertexBuffers():[],S,ie.vertexOffset,N,$,W),X.drawElements(i,ie.primitiveLength*J,X.UNSIGNED_SHORT,ie.primitiveOffset*J*2)}}}function Va(h,e,i){const s=1/c.av(i,1,e.transform.tileZoom),o=Math.pow(2,i.tileID.overscaledZ),u=i.tileSize*Math.pow(2,e.transform.tileZoom)/o,f=u*(i.tileID.canonical.x+i.tileID.wrap*o),g=u*i.tileID.canonical.y;return{u_image:0,u_texsize:i.imageAtlasTexture.size,u_scale:[s,h.fromScale,h.toScale],u_fade:h.t,u_pixel_coord_upper:[f>>16,g>>16],u_pixel_coord_lower:[65535&f,65535&g]}}const Hl=(h,e,i,s)=>{const o=h.style.light,u=o.properties.get("position"),f=[u.x,u.y,u.z],g=c.bK();o.properties.get("anchor")==="viewport"&&c.bL(g,h.transform.bearingInRadians),c.bM(f,f,g);const y=h.transform.transformLightDirection(f),x=o.properties.get("color");return{u_lightpos:f,u_lightpos_globe:y,u_lightintensity:o.properties.get("intensity"),u_lightcolor:[x.r,x.g,x.b],u_vertical_gradient:+e,u_opacity:i,u_fill_translate:s}},da=(h,e,i,s,o,u,f)=>c.e(Hl(h,e,i,s),Va(u,h,f),{u_height_factor:-Math.pow(2,o.overscaledZ)/f.tileSize/8}),Wl=(h,e,i,s)=>c.e(Va(e,h,i),{u_fill_translate:s}),Xl=(h,e)=>({u_world:h,u_fill_translate:e}),gh=(h,e,i,s,o)=>c.e(Wl(h,e,i,o),{u_world:s}),Kl=(h,e,i,s,o)=>{const u=h.transform;let f,g,y=0;if(i.paint.get("circle-pitch-alignment")==="map"){const x=c.av(e,1,u.zoom);f=!0,g=[x,x],y=x/(c.Z*Math.pow(2,e.tileID.overscaledZ))*2*Math.PI*o}else f=!1,g=u.pixelsToGLUnits;return{u_camera_to_center_distance:u.cameraToCenterDistance,u_scale_with_map:+(i.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+f,u_device_pixel_ratio:h.pixelRatio,u_extrude_scale:g,u_globe_extrude_scale:y,u_translate:s}},Bo=h=>({u_pixel_extrude_scale:[1/h.width,1/h.height]}),Yl=h=>({u_viewport_size:[h.width,h.height]}),Oo=(h,e=1)=>({u_color:h,u_overlay:0,u_overlay_scale:e}),jo=(h,e,i,s)=>{const o=c.av(h,1,e)/(c.Z*Math.pow(2,h.tileID.overscaledZ))*2*Math.PI*s;return{u_extrude_scale:c.av(h,1,e),u_intensity:i,u_globe_extrude_scale:o}},Vo=(h,e,i,s)=>{const o=c.K();c.bN(o,0,h.width,h.height,0,0,1);const u=h.context.gl;return{u_matrix:o,u_world:[u.drawingBufferWidth,u.drawingBufferHeight],u_image:i,u_color_ramp:s,u_opacity:e.paint.get("heatmap-opacity")}},jn=(h,e,i)=>{const s=i.paint.get("hillshade-shadow-color"),o=i.paint.get("hillshade-highlight-color"),u=i.paint.get("hillshade-accent-color");let f=i.paint.get("hillshade-illumination-direction")*(Math.PI/180);return i.paint.get("hillshade-illumination-anchor")==="viewport"&&(f+=h.transform.bearingInRadians),{u_image:0,u_latrange:Ql(0,e.tileID),u_light:[i.paint.get("hillshade-exaggeration"),f],u_shadow:s,u_highlight:o,u_accent:u}},Jl=(h,e)=>{const i=e.stride,s=c.K();return c.bN(s,0,c.Z,-8192,0,0,1),c.L(s,s,[0,-8192,0]),{u_matrix:s,u_image:1,u_dimension:[i,i],u_zoom:h.overscaledZ,u_unpack:e.getUnpackVector()}};function Ql(h,e){const i=Math.pow(2,e.canonical.z),s=e.canonical.y;return[new c.$(0,s/i).toLngLat().lat,new c.$(0,(s+1)/i).toLngLat().lat]}const Vn=(h,e,i,s)=>{const o=h.transform;return{u_translation:No(h,e,i),u_ratio:s/c.av(e,1,o.zoom),u_device_pixel_ratio:h.pixelRatio,u_units_to_pixels:[1/o.pixelsToGLUnits[0],1/o.pixelsToGLUnits[1]]}},_h=(h,e,i,s,o)=>c.e(Vn(h,e,i,s),{u_image:0,u_image_height:o}),Ts=(h,e,i,s,o)=>{const u=h.transform,f=ec(e,u);return{u_translation:No(h,e,i),u_texsize:e.imageAtlasTexture.size,u_ratio:s/c.av(e,1,u.zoom),u_device_pixel_ratio:h.pixelRatio,u_image:0,u_scale:[f,o.fromScale,o.toScale],u_fade:o.t,u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]]}},yh=(h,e,i,s,o,u)=>{const f=h.lineAtlas,g=ec(e,h.transform),y=i.layout.get("line-cap")==="round",x=f.getDash(o.from,y),T=f.getDash(o.to,y),M=x.width*u.fromScale,S=T.width*u.toScale;return c.e(Vn(h,e,i,s),{u_patternscale_a:[g/M,-x.height/2],u_patternscale_b:[g/S,-T.height/2],u_sdfgamma:f.width/(256*Math.min(M,S)*h.pixelRatio)/2,u_image:0,u_tex_y_a:x.y,u_tex_y_b:T.y,u_mix:u.t})};function ec(h,e){return 1/c.av(h,1,e.tileZoom)}function No(h,e,i){return c.aw(h.transform,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const tc=(h,e,i,s,o)=>{return{u_tl_parent:h,u_scale_parent:e,u_buffer_scale:1,u_fade_t:i.mix,u_opacity:i.opacity*s.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:s.paint.get("raster-brightness-min"),u_brightness_high:s.paint.get("raster-brightness-max"),u_saturation_factor:(f=s.paint.get("raster-saturation"),f>0?1-1/(1.001-f):-f),u_contrast_factor:(u=s.paint.get("raster-contrast"),u>0?1/(1-u):1+u),u_spin_weights:ic(s.paint.get("raster-hue-rotate")),u_coords_top:[o[0].x,o[0].y,o[1].x,o[1].y],u_coords_bottom:[o[3].x,o[3].y,o[2].x,o[2].y]};var u,f};function ic(h){h*=Math.PI/180;const e=Math.sin(h),i=Math.cos(h);return[(2*i+1)/3,(-Math.sqrt(3)*e-i+1)/3,(Math.sqrt(3)*e-i+1)/3]}const Ps=(h,e,i,s,o,u,f,g,y,x,T,M,S)=>{const z=f.transform;return{u_is_size_zoom_constant:+(h==="constant"||h==="source"),u_is_size_feature_constant:+(h==="constant"||h==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:z.cameraToCenterDistance,u_pitch:z.pitch/360*2*Math.PI,u_rotate_symbol:+i,u_aspect_ratio:z.width/z.height,u_fade_change:f.options.fadeDuration?f.symbolFadeChange:1,u_label_plane_matrix:g,u_coord_matrix:y,u_is_text:+T,u_pitch_with_map:+s,u_is_along_line:o,u_is_variable_anchor:u,u_texsize:M,u_texture:0,u_translation:x,u_pitched_scale:S}},Zo=(h,e,i,s,o,u,f,g,y,x,T,M,S,z)=>{const R=f.transform;return c.e(Ps(h,e,i,s,o,u,f,g,y,x,T,M,z),{u_gamma_scale:s?Math.cos(R.pitch*Math.PI/180)*R.cameraToCenterDistance:1,u_device_pixel_ratio:f.pixelRatio,u_is_halo:1})},Ms=(h,e,i,s,o,u,f,g,y,x,T,M,S)=>c.e(Zo(h,e,i,s,o,u,f,g,y,x,!0,T,0,S),{u_texsize_icon:M,u_texture_icon:1}),gn=(h,e)=>({u_opacity:h,u_color:e}),Uo=(h,e,i,s,o)=>c.e(function(u,f,g,y){const x=g.imageManager.getPattern(u.from.toString()),T=g.imageManager.getPattern(u.to.toString()),{width:M,height:S}=g.imageManager.getPixelSize(),z=Math.pow(2,y.tileID.overscaledZ),R=y.tileSize*Math.pow(2,g.transform.tileZoom)/z,V=R*(y.tileID.canonical.x+y.tileID.wrap*z),j=R*y.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:x.tl,u_pattern_br_a:x.br,u_pattern_tl_b:T.tl,u_pattern_br_b:T.br,u_texsize:[M,S],u_mix:f.t,u_pattern_size_a:x.displaySize,u_pattern_size_b:T.displaySize,u_scale_a:f.fromScale,u_scale_b:f.toScale,u_tile_units_to_pixels:1/c.av(y,1,g.transform.tileZoom),u_pixel_coord_upper:[V>>16,j>>16],u_pixel_coord_lower:[65535&V,65535&j]}}(i,o,e,s),{u_opacity:h}),Ss=(h,e)=>{},$o={fillExtrusion:(h,e)=>({u_lightpos:new c.bI(h,e.u_lightpos),u_lightpos_globe:new c.bI(h,e.u_lightpos_globe),u_lightintensity:new c.b7(h,e.u_lightintensity),u_lightcolor:new c.bI(h,e.u_lightcolor),u_vertical_gradient:new c.b7(h,e.u_vertical_gradient),u_opacity:new c.b7(h,e.u_opacity),u_fill_translate:new c.bJ(h,e.u_fill_translate)}),fillExtrusionPattern:(h,e)=>({u_lightpos:new c.bI(h,e.u_lightpos),u_lightpos_globe:new c.bI(h,e.u_lightpos_globe),u_lightintensity:new c.b7(h,e.u_lightintensity),u_lightcolor:new c.bI(h,e.u_lightcolor),u_vertical_gradient:new c.b7(h,e.u_vertical_gradient),u_height_factor:new c.b7(h,e.u_height_factor),u_opacity:new c.b7(h,e.u_opacity),u_fill_translate:new c.bJ(h,e.u_fill_translate),u_image:new c.bE(h,e.u_image),u_texsize:new c.bJ(h,e.u_texsize),u_pixel_coord_upper:new c.bJ(h,e.u_pixel_coord_upper),u_pixel_coord_lower:new c.bJ(h,e.u_pixel_coord_lower),u_scale:new c.bI(h,e.u_scale),u_fade:new c.b7(h,e.u_fade)}),fill:(h,e)=>({u_fill_translate:new c.bJ(h,e.u_fill_translate)}),fillPattern:(h,e)=>({u_image:new c.bE(h,e.u_image),u_texsize:new c.bJ(h,e.u_texsize),u_pixel_coord_upper:new c.bJ(h,e.u_pixel_coord_upper),u_pixel_coord_lower:new c.bJ(h,e.u_pixel_coord_lower),u_scale:new c.bI(h,e.u_scale),u_fade:new c.b7(h,e.u_fade),u_fill_translate:new c.bJ(h,e.u_fill_translate)}),fillOutline:(h,e)=>({u_world:new c.bJ(h,e.u_world),u_fill_translate:new c.bJ(h,e.u_fill_translate)}),fillOutlinePattern:(h,e)=>({u_world:new c.bJ(h,e.u_world),u_image:new c.bE(h,e.u_image),u_texsize:new c.bJ(h,e.u_texsize),u_pixel_coord_upper:new c.bJ(h,e.u_pixel_coord_upper),u_pixel_coord_lower:new c.bJ(h,e.u_pixel_coord_lower),u_scale:new c.bI(h,e.u_scale),u_fade:new c.b7(h,e.u_fade),u_fill_translate:new c.bJ(h,e.u_fill_translate)}),circle:(h,e)=>({u_camera_to_center_distance:new c.b7(h,e.u_camera_to_center_distance),u_scale_with_map:new c.bE(h,e.u_scale_with_map),u_pitch_with_map:new c.bE(h,e.u_pitch_with_map),u_extrude_scale:new c.bJ(h,e.u_extrude_scale),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_globe_extrude_scale:new c.b7(h,e.u_globe_extrude_scale),u_translate:new c.bJ(h,e.u_translate)}),collisionBox:(h,e)=>({u_pixel_extrude_scale:new c.bJ(h,e.u_pixel_extrude_scale)}),collisionCircle:(h,e)=>({u_viewport_size:new c.bJ(h,e.u_viewport_size)}),debug:(h,e)=>({u_color:new c.bF(h,e.u_color),u_overlay:new c.bE(h,e.u_overlay),u_overlay_scale:new c.b7(h,e.u_overlay_scale)}),depth:Ss,clippingMask:Ss,heatmap:(h,e)=>({u_extrude_scale:new c.b7(h,e.u_extrude_scale),u_intensity:new c.b7(h,e.u_intensity),u_globe_extrude_scale:new c.b7(h,e.u_globe_extrude_scale)}),heatmapTexture:(h,e)=>({u_matrix:new c.bG(h,e.u_matrix),u_world:new c.bJ(h,e.u_world),u_image:new c.bE(h,e.u_image),u_color_ramp:new c.bE(h,e.u_color_ramp),u_opacity:new c.b7(h,e.u_opacity)}),hillshade:(h,e)=>({u_image:new c.bE(h,e.u_image),u_latrange:new c.bJ(h,e.u_latrange),u_light:new c.bJ(h,e.u_light),u_shadow:new c.bF(h,e.u_shadow),u_highlight:new c.bF(h,e.u_highlight),u_accent:new c.bF(h,e.u_accent)}),hillshadePrepare:(h,e)=>({u_matrix:new c.bG(h,e.u_matrix),u_image:new c.bE(h,e.u_image),u_dimension:new c.bJ(h,e.u_dimension),u_zoom:new c.b7(h,e.u_zoom),u_unpack:new c.bH(h,e.u_unpack)}),line:(h,e)=>({u_translation:new c.bJ(h,e.u_translation),u_ratio:new c.b7(h,e.u_ratio),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_units_to_pixels:new c.bJ(h,e.u_units_to_pixels)}),lineGradient:(h,e)=>({u_translation:new c.bJ(h,e.u_translation),u_ratio:new c.b7(h,e.u_ratio),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_units_to_pixels:new c.bJ(h,e.u_units_to_pixels),u_image:new c.bE(h,e.u_image),u_image_height:new c.b7(h,e.u_image_height)}),linePattern:(h,e)=>({u_translation:new c.bJ(h,e.u_translation),u_texsize:new c.bJ(h,e.u_texsize),u_ratio:new c.b7(h,e.u_ratio),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_image:new c.bE(h,e.u_image),u_units_to_pixels:new c.bJ(h,e.u_units_to_pixels),u_scale:new c.bI(h,e.u_scale),u_fade:new c.b7(h,e.u_fade)}),lineSDF:(h,e)=>({u_translation:new c.bJ(h,e.u_translation),u_ratio:new c.b7(h,e.u_ratio),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_units_to_pixels:new c.bJ(h,e.u_units_to_pixels),u_patternscale_a:new c.bJ(h,e.u_patternscale_a),u_patternscale_b:new c.bJ(h,e.u_patternscale_b),u_sdfgamma:new c.b7(h,e.u_sdfgamma),u_image:new c.bE(h,e.u_image),u_tex_y_a:new c.b7(h,e.u_tex_y_a),u_tex_y_b:new c.b7(h,e.u_tex_y_b),u_mix:new c.b7(h,e.u_mix)}),raster:(h,e)=>({u_tl_parent:new c.bJ(h,e.u_tl_parent),u_scale_parent:new c.b7(h,e.u_scale_parent),u_buffer_scale:new c.b7(h,e.u_buffer_scale),u_fade_t:new c.b7(h,e.u_fade_t),u_opacity:new c.b7(h,e.u_opacity),u_image0:new c.bE(h,e.u_image0),u_image1:new c.bE(h,e.u_image1),u_brightness_low:new c.b7(h,e.u_brightness_low),u_brightness_high:new c.b7(h,e.u_brightness_high),u_saturation_factor:new c.b7(h,e.u_saturation_factor),u_contrast_factor:new c.b7(h,e.u_contrast_factor),u_spin_weights:new c.bI(h,e.u_spin_weights),u_coords_top:new c.bH(h,e.u_coords_top),u_coords_bottom:new c.bH(h,e.u_coords_bottom)}),symbolIcon:(h,e)=>({u_is_size_zoom_constant:new c.bE(h,e.u_is_size_zoom_constant),u_is_size_feature_constant:new c.bE(h,e.u_is_size_feature_constant),u_size_t:new c.b7(h,e.u_size_t),u_size:new c.b7(h,e.u_size),u_camera_to_center_distance:new c.b7(h,e.u_camera_to_center_distance),u_pitch:new c.b7(h,e.u_pitch),u_rotate_symbol:new c.bE(h,e.u_rotate_symbol),u_aspect_ratio:new c.b7(h,e.u_aspect_ratio),u_fade_change:new c.b7(h,e.u_fade_change),u_label_plane_matrix:new c.bG(h,e.u_label_plane_matrix),u_coord_matrix:new c.bG(h,e.u_coord_matrix),u_is_text:new c.bE(h,e.u_is_text),u_pitch_with_map:new c.bE(h,e.u_pitch_with_map),u_is_along_line:new c.bE(h,e.u_is_along_line),u_is_variable_anchor:new c.bE(h,e.u_is_variable_anchor),u_texsize:new c.bJ(h,e.u_texsize),u_texture:new c.bE(h,e.u_texture),u_translation:new c.bJ(h,e.u_translation),u_pitched_scale:new c.b7(h,e.u_pitched_scale)}),symbolSDF:(h,e)=>({u_is_size_zoom_constant:new c.bE(h,e.u_is_size_zoom_constant),u_is_size_feature_constant:new c.bE(h,e.u_is_size_feature_constant),u_size_t:new c.b7(h,e.u_size_t),u_size:new c.b7(h,e.u_size),u_camera_to_center_distance:new c.b7(h,e.u_camera_to_center_distance),u_pitch:new c.b7(h,e.u_pitch),u_rotate_symbol:new c.bE(h,e.u_rotate_symbol),u_aspect_ratio:new c.b7(h,e.u_aspect_ratio),u_fade_change:new c.b7(h,e.u_fade_change),u_label_plane_matrix:new c.bG(h,e.u_label_plane_matrix),u_coord_matrix:new c.bG(h,e.u_coord_matrix),u_is_text:new c.bE(h,e.u_is_text),u_pitch_with_map:new c.bE(h,e.u_pitch_with_map),u_is_along_line:new c.bE(h,e.u_is_along_line),u_is_variable_anchor:new c.bE(h,e.u_is_variable_anchor),u_texsize:new c.bJ(h,e.u_texsize),u_texture:new c.bE(h,e.u_texture),u_gamma_scale:new c.b7(h,e.u_gamma_scale),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_is_halo:new c.bE(h,e.u_is_halo),u_translation:new c.bJ(h,e.u_translation),u_pitched_scale:new c.b7(h,e.u_pitched_scale)}),symbolTextAndIcon:(h,e)=>({u_is_size_zoom_constant:new c.bE(h,e.u_is_size_zoom_constant),u_is_size_feature_constant:new c.bE(h,e.u_is_size_feature_constant),u_size_t:new c.b7(h,e.u_size_t),u_size:new c.b7(h,e.u_size),u_camera_to_center_distance:new c.b7(h,e.u_camera_to_center_distance),u_pitch:new c.b7(h,e.u_pitch),u_rotate_symbol:new c.bE(h,e.u_rotate_symbol),u_aspect_ratio:new c.b7(h,e.u_aspect_ratio),u_fade_change:new c.b7(h,e.u_fade_change),u_label_plane_matrix:new c.bG(h,e.u_label_plane_matrix),u_coord_matrix:new c.bG(h,e.u_coord_matrix),u_is_text:new c.bE(h,e.u_is_text),u_pitch_with_map:new c.bE(h,e.u_pitch_with_map),u_is_along_line:new c.bE(h,e.u_is_along_line),u_is_variable_anchor:new c.bE(h,e.u_is_variable_anchor),u_texsize:new c.bJ(h,e.u_texsize),u_texsize_icon:new c.bJ(h,e.u_texsize_icon),u_texture:new c.bE(h,e.u_texture),u_texture_icon:new c.bE(h,e.u_texture_icon),u_gamma_scale:new c.b7(h,e.u_gamma_scale),u_device_pixel_ratio:new c.b7(h,e.u_device_pixel_ratio),u_is_halo:new c.bE(h,e.u_is_halo),u_translation:new c.bJ(h,e.u_translation),u_pitched_scale:new c.b7(h,e.u_pitched_scale)}),background:(h,e)=>({u_opacity:new c.b7(h,e.u_opacity),u_color:new c.bF(h,e.u_color)}),backgroundPattern:(h,e)=>({u_opacity:new c.b7(h,e.u_opacity),u_image:new c.bE(h,e.u_image),u_pattern_tl_a:new c.bJ(h,e.u_pattern_tl_a),u_pattern_br_a:new c.bJ(h,e.u_pattern_br_a),u_pattern_tl_b:new c.bJ(h,e.u_pattern_tl_b),u_pattern_br_b:new c.bJ(h,e.u_pattern_br_b),u_texsize:new c.bJ(h,e.u_texsize),u_mix:new c.b7(h,e.u_mix),u_pattern_size_a:new c.bJ(h,e.u_pattern_size_a),u_pattern_size_b:new c.bJ(h,e.u_pattern_size_b),u_scale_a:new c.b7(h,e.u_scale_a),u_scale_b:new c.b7(h,e.u_scale_b),u_pixel_coord_upper:new c.bJ(h,e.u_pixel_coord_upper),u_pixel_coord_lower:new c.bJ(h,e.u_pixel_coord_lower),u_tile_units_to_pixels:new c.b7(h,e.u_tile_units_to_pixels)}),terrain:(h,e)=>({u_texture:new c.bE(h,e.u_texture),u_ele_delta:new c.b7(h,e.u_ele_delta),u_fog_matrix:new c.bG(h,e.u_fog_matrix),u_fog_color:new c.bF(h,e.u_fog_color),u_fog_ground_blend:new c.b7(h,e.u_fog_ground_blend),u_fog_ground_blend_opacity:new c.b7(h,e.u_fog_ground_blend_opacity),u_horizon_color:new c.bF(h,e.u_horizon_color),u_horizon_fog_blend:new c.b7(h,e.u_horizon_fog_blend),u_is_globe_mode:new c.b7(h,e.u_is_globe_mode)}),terrainDepth:(h,e)=>({u_ele_delta:new c.b7(h,e.u_ele_delta)}),terrainCoords:(h,e)=>({u_texture:new c.bE(h,e.u_texture),u_terrain_coords_id:new c.b7(h,e.u_terrain_coords_id),u_ele_delta:new c.b7(h,e.u_ele_delta)}),projectionErrorMeasurement:(h,e)=>({u_input:new c.b7(h,e.u_input),u_output_expected:new c.b7(h,e.u_output_expected)}),atmosphere:(h,e)=>({u_sun_pos:new c.bI(h,e.u_sun_pos),u_atmosphere_blend:new c.b7(h,e.u_atmosphere_blend),u_globe_position:new c.bI(h,e.u_globe_position),u_globe_radius:new c.b7(h,e.u_globe_radius),u_inv_proj_matrix:new c.bG(h,e.u_inv_proj_matrix)}),sky:(h,e)=>({u_sky_color:new c.bF(h,e.u_sky_color),u_horizon_color:new c.bF(h,e.u_horizon_color),u_horizon:new c.bJ(h,e.u_horizon),u_horizon_normal:new c.bJ(h,e.u_horizon_normal),u_sky_horizon_blend:new c.b7(h,e.u_sky_horizon_blend),u_sky_blend:new c.b7(h,e.u_sky_blend)})};class rc{constructor(e,i,s){this.context=e;const o=e.gl;this.buffer=o.createBuffer(),this.dynamicDraw=!!s,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),o.bufferData(o.ELEMENT_ARRAY_BUFFER,i.arrayBuffer,this.dynamicDraw?o.DYNAMIC_DRAW:o.STATIC_DRAW),this.dynamicDraw||delete i.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){const i=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Go={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Nn{constructor(e,i,s,o){this.length=i.length,this.attributes=s,this.itemSize=i.bytesPerElement,this.dynamicDraw=o,this.context=e;const u=e.gl;this.buffer=u.createBuffer(),e.bindVertexBuffer.set(this.buffer),u.bufferData(u.ARRAY_BUFFER,i.arrayBuffer,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW),this.dynamicDraw||delete i.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){if(e.length!==this.length)throw new Error(`Length of new data is ${e.length}, which doesn't match current length of ${this.length}`);const i=this.context.gl;this.bind(),i.bufferSubData(i.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,i){for(let s=0;s<this.attributes.length;s++){const o=i.attributes[this.attributes[s].name];o!==void 0&&e.enableVertexAttribArray(o)}}setVertexAttribPointers(e,i,s){for(let o=0;o<this.attributes.length;o++){const u=this.attributes[o],f=i.attributes[u.name];f!==void 0&&e.vertexAttribPointer(f,u.components,e[Go[u.type]],!1,this.itemSize,u.offset+this.itemSize*(s||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class qt{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class vh extends qt{getDefault(){return c.b6.transparent}set(e){const i=this.current;(e.r!==i.r||e.g!==i.g||e.b!==i.b||e.a!==i.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class xh extends qt{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class bh extends qt{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class wh extends qt{getDefault(){return[!0,!0,!0,!0]}set(e){const i=this.current;(e[0]!==i[0]||e[1]!==i[1]||e[2]!==i[2]||e[3]!==i[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class nc extends qt{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class Th extends qt{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class ac extends qt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const i=this.current;(e.func!==i.func||e.ref!==i.ref||e.mask!==i.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class Cs extends qt{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const i=this.current;(e[0]!==i[0]||e[1]!==i[1]||e[2]!==i[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class Is extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;e?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),this.current=e,this.dirty=!1}}class Es extends qt{getDefault(){return[0,1]}set(e){const i=this.current;(e[0]!==i[0]||e[1]!==i[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class qo extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;e?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),this.current=e,this.dirty=!1}}class Zn extends qt{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class pa extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;e?i.enable(i.BLEND):i.disable(i.BLEND),this.current=e,this.dirty=!1}}class Nr extends qt{getDefault(){const e=this.gl;return[e.ONE,e.ZERO]}set(e){const i=this.current;(e[0]!==i[0]||e[1]!==i[1]||this.dirty)&&(this.gl.blendFunc(e[0],e[1]),this.current=e,this.dirty=!1)}}class sc extends qt{getDefault(){return c.b6.transparent}set(e){const i=this.current;(e.r!==i.r||e.g!==i.g||e.b!==i.b||e.a!==i.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class oc extends qt{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquation(e),this.current=e,this.dirty=!1)}}class Ho extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;e?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),this.current=e,this.dirty=!1}}class Un extends qt{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class As extends qt{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}class ks extends qt{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}}class Na extends qt{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class zs extends qt{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const i=this.current;(e[0]!==i[0]||e[1]!==i[1]||e[2]!==i[2]||e[3]!==i[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class lc extends qt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class fa extends qt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.bindRenderbuffer(i.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class ma extends qt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.bindTexture(i.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class cc extends qt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Wo extends qt{getDefault(){return null}set(e){const i=this.gl;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Gt extends qt{getDefault(){return null}set(e){var i;if(e===this.current&&!this.dirty)return;const s=this.gl;Vr(s)?s.bindVertexArray(e):(i=s.getExtension("OES_vertex_array_object"))===null||i===void 0||i.bindVertexArrayOES(e),this.current=e,this.dirty=!1}}class Ds extends qt{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Ph extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class hc extends qt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class $n extends qt{constructor(e,i){super(e),this.context=e,this.parent=i}getDefault(){return null}}class Mh extends $n{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Sh extends $n{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class uc extends $n{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e),this.current=e,this.dirty=!1}}const dc="Framebuffer is not complete";class Xo{constructor(e,i,s,o,u){this.context=e,this.width=i,this.height=s;const f=e.gl,g=this.framebuffer=f.createFramebuffer();if(this.colorAttachment=new Mh(e,g),o)this.depthAttachment=u?new uc(e,g):new Sh(e,g);else if(u)throw new Error("Stencil cannot be set without depth");if(f.checkFramebufferStatus(f.FRAMEBUFFER)!==f.FRAMEBUFFER_COMPLETE)throw new Error(dc)}destroy(){const e=this.context.gl,i=this.colorAttachment.get();if(i&&e.deleteTexture(i),this.depthAttachment){const s=this.depthAttachment.get();s&&e.deleteRenderbuffer(s)}e.deleteFramebuffer(this.framebuffer)}}class Rs{constructor(e){var i,s;if(this.gl=e,this.clearColor=new vh(this),this.clearDepth=new xh(this),this.clearStencil=new bh(this),this.colorMask=new wh(this),this.depthMask=new nc(this),this.stencilMask=new Th(this),this.stencilFunc=new ac(this),this.stencilOp=new Cs(this),this.stencilTest=new Is(this),this.depthRange=new Es(this),this.depthTest=new qo(this),this.depthFunc=new Zn(this),this.blend=new pa(this),this.blendFunc=new Nr(this),this.blendColor=new sc(this),this.blendEquation=new oc(this),this.cullFace=new Ho(this),this.cullFaceSide=new Un(this),this.frontFace=new As(this),this.program=new ks(this),this.activeTexture=new Na(this),this.viewport=new zs(this),this.bindFramebuffer=new lc(this),this.bindRenderbuffer=new fa(this),this.bindTexture=new ma(this),this.bindVertexBuffer=new cc(this),this.bindElementBuffer=new Wo(this),this.bindVertexArray=new Gt(this),this.pixelStoreUnpack=new Ds(this),this.pixelStoreUnpackPremultiplyAlpha=new Ph(this),this.pixelStoreUnpackFlipY=new hc(this),this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),Vr(e)){this.HALF_FLOAT=e.HALF_FLOAT;const o=e.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(i=e.RGBA16F)!==null&&i!==void 0?i:o==null?void 0:o.RGBA16F_EXT,this.RGB16F=(s=e.RGB16F)!==null&&s!==void 0?s:o==null?void 0:o.RGB16F_EXT,e.getExtension("EXT_color_buffer_float")}else{e.getExtension("EXT_color_buffer_half_float"),e.getExtension("OES_texture_half_float_linear");const o=e.getExtension("OES_texture_half_float");this.HALF_FLOAT=o==null?void 0:o.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,i){return new rc(this,e,i)}createVertexBuffer(e,i,s){return new Nn(this,e,i,s)}createRenderbuffer(e,i,s){const o=this.gl,u=o.createRenderbuffer();return this.bindRenderbuffer.set(u),o.renderbufferStorage(o.RENDERBUFFER,e,i,s),this.bindRenderbuffer.set(null),u}createFramebuffer(e,i,s,o){return new Xo(this,e,i,s,o)}clear({color:e,depth:i,stencil:s}){const o=this.gl;let u=0;e&&(u|=o.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),i!==void 0&&(u|=o.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(i),this.depthMask.set(!0)),s!==void 0&&(u|=o.STENCIL_BUFFER_BIT,this.clearStencil.set(s),this.stencilMask.set(255)),o.clear(u)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){c.bB(e.blendFunction,gi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor)),this.colorMask.set(e.mask)}createVertexArray(){var e;return Vr(this.gl)?this.gl.createVertexArray():(e=this.gl.getExtension("OES_vertex_array_object"))===null||e===void 0?void 0:e.createVertexArrayOES()}deleteVertexArray(e){var i;return Vr(this.gl)?this.gl.deleteVertexArray(e):(i=this.gl.getExtension("OES_vertex_array_object"))===null||i===void 0?void 0:i.deleteVertexArrayOES(e)}unbindVAO(){this.bindVertexArray.set(null)}}let Gn;function Ls(h,e,i,s,o){const u=h.context,f=h.transform,g=u.gl,y=h.useProgram("collisionBox"),x=[];let T=0,M=0;for(let N=0;N<s.length;N++){const $=s[N],W=e.getTile($).getBucket(i);if(!W)continue;const X=o?W.textCollisionBox:W.iconCollisionBox,J=W.collisionCircleArray;J.length>0&&(x.push({circleArray:J,circleOffset:M,coord:$}),T+=J.length/4,M=T),X&&y.draw(u,g.LINES,Ct.disabled,Nt.disabled,h.colorModeForRenderPass(),Ot.disabled,Bo(h.transform),h.style.map.terrain&&h.style.map.terrain.getTerrainData($),f.getProjectionData({overscaledTileID:$,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),i.id,X.layoutVertexBuffer,X.indexBuffer,X.segments,null,h.transform.zoom,null,null,X.collisionVertexBuffer)}if(!o||!x.length)return;const S=h.useProgram("collisionCircle"),z=new c.bO;z.resize(4*T),z._trim();let R=0;for(const N of x)for(let $=0;$<N.circleArray.length/4;$++){const W=4*$,X=N.circleArray[W+0],J=N.circleArray[W+1],ie=N.circleArray[W+2],Q=N.circleArray[W+3];z.emplace(R++,X,J,ie,Q,0),z.emplace(R++,X,J,ie,Q,1),z.emplace(R++,X,J,ie,Q,2),z.emplace(R++,X,J,ie,Q,3)}(!Gn||Gn.length<2*T)&&(Gn=function(N){const $=2*N,W=new c.bQ;W.resize($),W._trim();for(let X=0;X<$;X++){const J=6*X;W.uint16[J+0]=4*X+0,W.uint16[J+1]=4*X+1,W.uint16[J+2]=4*X+2,W.uint16[J+3]=4*X+2,W.uint16[J+4]=4*X+3,W.uint16[J+5]=4*X+0}return W}(T));const V=u.createIndexBuffer(Gn,!0),j=u.createVertexBuffer(z,c.bP.members,!0);for(const N of x){const $=Yl(h.transform);S.draw(u,g.TRIANGLES,Ct.disabled,Nt.disabled,h.colorModeForRenderPass(),Ot.disabled,$,h.style.map.terrain&&h.style.map.terrain.getTerrainData(N.coord),null,i.id,j,V,c.aF.simpleSegment(0,2*N.circleOffset,N.circleArray.length,N.circleArray.length/2),null,h.transform.zoom,null,null,null)}j.destroy(),V.destroy()}const Ko=c.as(new Float32Array(16));function pc(h,e,i,s,o,u){const{horizontalAlign:f,verticalAlign:g}=c.aA(h);return new c.P((-(f-.5)*e/o+s[0])*u,(-(g-.5)*i/o+s[1])*u)}function Fs(h,e,i,s,o,u){const f=e.tileAnchorPoint.add(new c.P(e.translation[0],e.translation[1]));if(e.pitchWithMap){let g=s.mult(u);i||(g=g.rotate(-o));const y=f.add(g);return me(y.x,y.y,e.pitchedLabelPlaneMatrix,e.getElevation).point}if(i){const g=Je(e.tileAnchorPoint.x+1,e.tileAnchorPoint.y,e).point.sub(h),y=Math.atan(g.y/g.x)+(g.x<0?Math.PI:0);return h.add(s.rotate(y))}return h.add(s)}function Bs(h,e,i,s,o,u,f,g,y,x,T,M){const S=h.text.placedSymbolArray,z=h.text.dynamicLayoutVertexArray,R=h.icon.dynamicLayoutVertexArray,V={};z.clear();for(let j=0;j<S.length;j++){const N=S.get(j),$=N.hidden||!N.crossTileID||h.allowVerticalPlacement&&!N.placedOrientation?null:s[N.crossTileID];if($){const W=new c.P(N.anchorX,N.anchorY),X={getElevation:M,width:o.width,height:o.height,pitchedLabelPlaneMatrix:u,pitchWithMap:i,transform:o,tileAnchorPoint:W,translation:x,unwrappedTileID:T},J=i?It(W.x,W.y,X):Je(W.x,W.y,X),ie=le(o.cameraToCenterDistance,J.signedDistanceFromCamera);let Q=c.ah(h.textSizeData,g,N)*ie/c.au;i&&(Q*=h.tilePixelRatio/f);const{width:de,height:fe,anchor:xe,textOffset:we,textBoxScale:ve}=$,Le=pc(xe,de,fe,we,ve,Q),Re=o.getPitchedTextCorrection(W.x+x[0],W.y+x[1],T),Ce=Fs(J.point,X,e,Le,-o.bearingInRadians,Re),it=h.allowVerticalPlacement&&N.placedOrientation===c.ag.vertical?Math.PI/2:0;for(let ot=0;ot<N.numGlyphs;ot++)c.an(z,Ce,it);y&&N.associatedIconIndex>=0&&(V[N.associatedIconIndex]={shiftedAnchor:Ce,angle:it})}else Bi(N.numGlyphs,z)}if(y){R.clear();const j=h.icon.placedSymbolArray;for(let N=0;N<j.length;N++){const $=j.get(N);if($.hidden)Bi($.numGlyphs,R);else{const W=V[N];if(W)for(let X=0;X<$.numGlyphs;X++)c.an(R,W.shiftedAnchor,W.angle);else Bi($.numGlyphs,R)}}h.icon.dynamicLayoutVertexBuffer.updateData(R)}h.text.dynamicLayoutVertexBuffer.updateData(z)}function Yo(h,e,i){return i.iconsInText&&e?"symbolTextAndIcon":h?"symbolSDF":"symbolIcon"}function fc(h,e,i,s,o,u,f,g,y,x,T,M,S){const z=h.context,R=z.gl,V=h.transform,j=g==="map",N=y==="map",$=g!=="viewport"&&i.layout.get("symbol-placement")!=="point",W=j&&!N&&!$,X=!i.layout.get("symbol-sort-key").isConstant();let J=!1;const ie=h.getDepthModeForSublayer(0,Ct.ReadOnly),Q=i._unevaluatedLayout.hasValue("text-variable-anchor")||i._unevaluatedLayout.hasValue("text-variable-anchor-offset"),de=[],fe=V.getCircleRadiusCorrection();for(const xe of s){const we=e.getTile(xe),ve=we.getBucket(i);if(!ve)continue;const Le=o?ve.text:ve.icon;if(!Le||!Le.segments.get().length||!Le.hasVisibleVertices)continue;const Re=Le.programConfigurations.get(i.id),Ce=o||ve.sdfIcons,it=o?ve.textSizeData:ve.iconSizeData,ot=N||V.pitch!==0,Ht=h.useProgram(Yo(Ce,o,ve),Re),ui=c.af(it,V.zoom),ri=h.style.map.terrain&&h.style.map.terrain.getTerrainData(xe);let yi,fi,Xt,ni,Ki=[0,0],Yi=null;if(o)fi=we.glyphAtlasTexture,Xt=R.LINEAR,yi=we.glyphAtlasTexture.size,ve.iconsInText&&(Ki=we.imageAtlasTexture.size,Yi=we.imageAtlasTexture,ni=ot||h.options.rotating||h.options.zooming||it.kind==="composite"||it.kind==="camera"?R.LINEAR:R.NEAREST);else{const di=i.layout.get("icon-size").constantOr(0)!==1||ve.iconsNeedLinear;fi=we.imageAtlasTexture,Xt=Ce||h.options.rotating||h.options.zooming||di||ot?R.LINEAR:R.NEAREST,yi=we.imageAtlasTexture.size}const Zi=c.av(we,1,h.transform.zoom),nr=ue(j,h.transform,Zi),kn=c.K();c.ai(kn,nr);const yn=re(N,j,h.transform,Zi),hn=c.aw(V,we,u,f),$r=V.getProjectionData({overscaledTileID:xe,applyGlobeMatrix:!S,applyTerrainMatrix:!0}),Yn=Q&&ve.hasTextData(),Ja=i.layout.get("icon-text-fit")!=="none"&&Yn&&ve.hasIconData();if($){const di=h.style.map.terrain?(Ui,$i)=>h.style.map.terrain.getElevation(xe,Ui,$i):null,oi=i.layout.get("text-rotation-alignment")==="map";ce(ve,h,o,nr,kn,N,x,oi,xe.toUnwrapped(),V.width,V.height,hn,di)}const Jn=o&&Q||Ja,Gr=$||Jn?Ko:N?nr:h.transform.clipSpaceToPixelsMatrix,un=Ce&&i.paint.get(o?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Jr;Jr=Ce?ve.iconsInText?Ms(it.kind,ui,W,N,$,Jn,h,Gr,yn,hn,yi,Ki,fe):Zo(it.kind,ui,W,N,$,Jn,h,Gr,yn,hn,o,yi,0,fe):Ps(it.kind,ui,W,N,$,Jn,h,Gr,yn,hn,o,yi,fe);const dn={program:Ht,buffers:Le,uniformValues:Jr,projectionData:$r,atlasTexture:fi,atlasTextureIcon:Yi,atlasInterpolation:Xt,atlasInterpolationIcon:ni,isSDF:Ce,hasHalo:un};if(X&&ve.canOverlap){J=!0;const di=Le.segments.get();for(const oi of di)de.push({segments:new c.aF([oi]),sortKey:oi.sortKey,state:dn,terrainData:ri})}else de.push({segments:Le.segments,sortKey:0,state:dn,terrainData:ri})}J&&de.sort((xe,we)=>xe.sortKey-we.sortKey);for(const xe of de){const we=xe.state;if(z.activeTexture.set(R.TEXTURE0),we.atlasTexture.bind(we.atlasInterpolation,R.CLAMP_TO_EDGE),we.atlasTextureIcon&&(z.activeTexture.set(R.TEXTURE1),we.atlasTextureIcon&&we.atlasTextureIcon.bind(we.atlasInterpolationIcon,R.CLAMP_TO_EDGE)),we.isSDF){const ve=we.uniformValues;we.hasHalo&&(ve.u_is_halo=1,Os(we.buffers,xe.segments,i,h,we.program,ie,T,M,ve,we.projectionData,xe.terrainData)),ve.u_is_halo=0}Os(we.buffers,xe.segments,i,h,we.program,ie,T,M,we.uniformValues,we.projectionData,xe.terrainData)}}function Os(h,e,i,s,o,u,f,g,y,x,T){const M=s.context;o.draw(M,M.gl.TRIANGLES,u,f,g,Ot.backCCW,y,T,x,i.id,h.layoutVertexBuffer,h.indexBuffer,e,i.paint,s.transform.zoom,h.programConfigurations.get(i.id),h.dynamicLayoutVertexBuffer,h.opacityVertexBuffer)}function Ch(h,e,i,s,o){const u=h.context,f=u.gl,g=Nt.disabled,y=new gi([f.ONE,f.ONE],c.b6.transparent,[!0,!0,!0,!0]),x=e.getBucket(i);if(!x)return;const T=s.key;let M=i.heatmapFbos.get(T);M||(M=Za(u,e.tileSize,e.tileSize),i.heatmapFbos.set(T,M)),u.bindFramebuffer.set(M.framebuffer),u.viewport.set([0,0,e.tileSize,e.tileSize]),u.clear({color:c.b6.transparent});const S=x.programConfigurations.get(i.id),z=h.useProgram("heatmap",S,!o),R=h.transform.getProjectionData({overscaledTileID:e.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),V=h.style.map.terrain.getTerrainData(s);z.draw(u,f.TRIANGLES,Ct.disabled,g,y,Ot.disabled,jo(e,h.transform.zoom,i.paint.get("heatmap-intensity"),1),V,R,i.id,x.layoutVertexBuffer,x.indexBuffer,x.segments,i.paint,h.transform.zoom,S)}function mc(h,e,i,s,o){const u=h.context,f=u.gl,g=h.transform;u.setColorMode(h.colorModeForRenderPass());const y=js(u,e),x=i.key,T=e.heatmapFbos.get(x);if(!T)return;u.activeTexture.set(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,T.colorAttachment.get()),u.activeTexture.set(f.TEXTURE1),y.bind(f.LINEAR,f.CLAMP_TO_EDGE);const M=g.getProjectionData({overscaledTileID:i,applyTerrainMatrix:o,applyGlobeMatrix:!s});h.useProgram("heatmapTexture").draw(u,f.TRIANGLES,Ct.disabled,Nt.disabled,h.colorModeForRenderPass(),Ot.disabled,Vo(h,e,0,1),null,M,e.id,h.rasterBoundsBuffer,h.quadTriangleIndexBuffer,h.rasterBoundsSegments,e.paint,g.zoom),T.destroy(),e.heatmapFbos.delete(x)}function Za(h,e,i){var s,o;const u=h.gl,f=u.createTexture();u.bindTexture(u.TEXTURE_2D,f),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR);const g=(s=h.HALF_FLOAT)!==null&&s!==void 0?s:u.UNSIGNED_BYTE,y=(o=h.RGBA16F)!==null&&o!==void 0?o:u.RGBA;u.texImage2D(u.TEXTURE_2D,0,y,e,i,0,u.RGBA,g,null);const x=h.createFramebuffer(e,i,!1,!1);return x.colorAttachment.set(f),x}function js(h,e){return e.colorRampTexture||(e.colorRampTexture=new xt(h,e.colorRamp,h.gl.RGBA)),e.colorRampTexture}function Jo(h,e,i,s,o){if(!i||!s||!s.imageAtlas)return;const u=s.imageAtlas.patternPositions;let f=u[i.to.toString()],g=u[i.from.toString()];if(!f&&g&&(f=g),!g&&f&&(g=f),!f||!g){const y=o.getPaintProperty(e);f=u[y],g=u[y]}f&&g&&h.setConstantPatternPositions(f,g)}function Qo(h,e,i,s,o,u,f,g){const y=h.context.gl,x="fill-pattern",T=i.paint.get(x),M=T&&T.constantOr(1),S=i.getCrossfadeParameters();let z,R,V,j,N;const $=h.transform,W=i.paint.get("fill-translate"),X=i.paint.get("fill-translate-anchor");f?(R=M&&!i.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",z=y.LINES):(R=M?"fillPattern":"fill",z=y.TRIANGLES);const J=T.constantOr(null);for(const ie of s){const Q=e.getTile(ie);if(M&&!Q.patternsLoaded())continue;const de=Q.getBucket(i);if(!de)continue;const fe=de.programConfigurations.get(i.id),xe=h.useProgram(R,fe),we=h.style.map.terrain&&h.style.map.terrain.getTerrainData(ie);M&&(h.context.activeTexture.set(y.TEXTURE0),Q.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),fe.updatePaintBuffers(S)),Jo(fe,x,J,Q,i);const ve=$.getProjectionData({overscaledTileID:ie,applyGlobeMatrix:!g,applyTerrainMatrix:!0}),Le=c.aw($,Q,W,X);if(f){j=de.indexBuffer2,N=de.segments2;const Ce=[y.drawingBufferWidth,y.drawingBufferHeight];V=R==="fillOutlinePattern"&&M?gh(h,S,Q,Ce,Le):Xl(Ce,Le)}else j=de.indexBuffer,N=de.segments,V=M?Wl(h,S,Q,Le):{u_fill_translate:Le};let Re;if(h.renderPass==="translucent"&&g){const[Ce]=h.getStencilConfigForOverlapAndUpdateStencilID(s);Re=Ce[ie.overscaledZ]}else Re=h.stencilModeForClipping(ie);xe.draw(h.context,z,o,Re,u,Ot.backCCW,V,we,ve,i.id,de.layoutVertexBuffer,j,N,i.paint,h.transform.zoom,fe)}}function ga(h,e,i,s,o,u,f,g){const y=h.context,x=y.gl,T="fill-extrusion-pattern",M=i.paint.get(T),S=M.constantOr(1),z=i.getCrossfadeParameters(),R=i.paint.get("fill-extrusion-opacity"),V=M.constantOr(null),j=h.transform;for(const N of s){const $=e.getTile(N),W=$.getBucket(i);if(!W)continue;const X=h.style.map.terrain&&h.style.map.terrain.getTerrainData(N),J=W.programConfigurations.get(i.id),ie=h.useProgram(S?"fillExtrusionPattern":"fillExtrusion",J);S&&(h.context.activeTexture.set(x.TEXTURE0),$.imageAtlasTexture.bind(x.LINEAR,x.CLAMP_TO_EDGE),J.updatePaintBuffers(z));const Q=j.getProjectionData({overscaledTileID:N,applyGlobeMatrix:!g,applyTerrainMatrix:!0});Jo(J,T,V,$,i);const de=c.aw(j,$,i.paint.get("fill-extrusion-translate"),i.paint.get("fill-extrusion-translate-anchor")),fe=i.paint.get("fill-extrusion-vertical-gradient"),xe=S?da(h,fe,R,de,N,z,$):Hl(h,fe,R,de);ie.draw(y,y.gl.TRIANGLES,o,u,f,Ot.backCCW,xe,X,Q,i.id,W.layoutVertexBuffer,W.indexBuffer,W.segments,i.paint,h.transform.zoom,J,h.style.map.terrain&&W.centroidVertexBuffer)}}function Ua(h,e,i,s,o,u,f,g,y){var x;const T=h.style.projection,M=h.context,S=h.transform,z=M.gl,R=h.useProgram("hillshade"),V=!h.options.moving;for(const j of s){const N=e.getTile(j),$=N.fbo;if(!$)continue;const W=T.getMeshFromTileID(M,j.canonical,g,!0,"raster"),X=(x=h.style.map.terrain)===null||x===void 0?void 0:x.getTerrainData(j);M.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_2D,$.colorAttachment.get());const J=S.getProjectionData({overscaledTileID:j,aligned:V,applyGlobeMatrix:!y,applyTerrainMatrix:!0});R.draw(M,z.TRIANGLES,u,o[j.overscaledZ],f,Ot.backCCW,jn(h,N,i),X,J,i.id,W.vertexBuffer,W.indexBuffer,W.segments)}}const el=[new c.P(0,0),new c.P(c.Z,0),new c.P(c.Z,c.Z),new c.P(0,c.Z)];function $a(h,e,i,s,o,u,f,g,y=!1,x=!1){const T=s[s.length-1].overscaledZ,M=h.context,S=M.gl,z=h.useProgram("raster"),R=h.transform,V=h.style.projection,j=h.colorModeForRenderPass(),N=!h.options.moving;for(const $ of s){const W=h.getDepthModeForSublayer($.overscaledZ-T,i.paint.get("raster-opacity")===1?Ct.ReadWrite:Ct.ReadOnly,S.LESS),X=e.getTile($);X.registerFadeDuration(i.paint.get("raster-fade-duration"));const J=e.findLoadedParent($,0),ie=e.findLoadedSibling($),Q=Ei(X,J||ie||null,e,i,h.transform,h.style.map.terrain);let de,fe;const xe=i.paint.get("raster-resampling")==="nearest"?S.NEAREST:S.LINEAR;M.activeTexture.set(S.TEXTURE0),X.texture.bind(xe,S.CLAMP_TO_EDGE,S.LINEAR_MIPMAP_NEAREST),M.activeTexture.set(S.TEXTURE1),J?(J.texture.bind(xe,S.CLAMP_TO_EDGE,S.LINEAR_MIPMAP_NEAREST),de=Math.pow(2,J.tileID.overscaledZ-X.tileID.overscaledZ),fe=[X.tileID.canonical.x*de%1,X.tileID.canonical.y*de%1]):X.texture.bind(xe,S.CLAMP_TO_EDGE,S.LINEAR_MIPMAP_NEAREST),X.texture.useMipmap&&M.extTextureFilterAnisotropic&&h.transform.pitch>20&&S.texParameterf(S.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax);const we=h.style.map.terrain&&h.style.map.terrain.getTerrainData($),ve=R.getProjectionData({overscaledTileID:$,aligned:N,applyGlobeMatrix:!x,applyTerrainMatrix:!0}),Le=tc(fe||[0,0],de||1,Q,i,g),Re=V.getMeshFromTileID(M,$.canonical,u,f,"raster");z.draw(M,S.TRIANGLES,W,o?o[$.overscaledZ]:Nt.disabled,j,y?Ot.frontCCW:Ot.backCCW,Le,we,ve,i.id,Re.vertexBuffer,Re.indexBuffer,Re.segments)}}function Ei(h,e,i,s,o,u){const f=s.paint.get("raster-fade-duration");if(!u&&f>0){const g=Pe.now(),y=(g-h.timeAdded)/f,x=e?(g-e.timeAdded)/f:-1,T=i.getSource(),M=hi(o,{tileSize:T.tileSize,roundZoom:T.roundZoom}),S=!e||Math.abs(e.tileID.overscaledZ-M)>Math.abs(h.tileID.overscaledZ-M),z=S&&h.refreshedUponExpiration?1:c.ad(S?y:1-x,0,1);return h.refreshedUponExpiration&&y>=1&&(h.refreshedUponExpiration=!1),e?{opacity:1,mix:1-z}:{opacity:z,mix:0}}return{opacity:1,mix:0}}const qn=new c.b6(1,0,0,1),Zr=new c.b6(0,1,0,1),tl=new c.b6(0,0,1,1),il=new c.b6(1,0,1,1),gc=new c.b6(0,1,1,1);function Hn(h,e,i,s){ya(h,0,e+i/2,h.transform.width,i,s)}function _a(h,e,i,s){ya(h,e-i/2,0,i,h.transform.height,s)}function ya(h,e,i,s,o,u){const f=h.context,g=f.gl;g.enable(g.SCISSOR_TEST),g.scissor(e*h.pixelRatio,i*h.pixelRatio,s*h.pixelRatio,o*h.pixelRatio),f.clear({color:u}),g.disable(g.SCISSOR_TEST)}function _c(h,e,i){const s=h.context,o=s.gl,u=h.useProgram("debug"),f=Ct.disabled,g=Nt.disabled,y=h.colorModeForRenderPass(),x="$debug",T=h.style.map.terrain&&h.style.map.terrain.getTerrainData(i);s.activeTexture.set(o.TEXTURE0);const M=e.getTileByID(i.key).latestRawTileData,S=Math.floor((M&&M.byteLength||0)/1024),z=e.getTile(i).tileSize,R=512/Math.min(z,512)*(i.overscaledZ/h.transform.zoom)*.5;let V=i.canonical.toString();i.overscaledZ!==i.canonical.z&&(V+=` => ${i.overscaledZ}`),function(N,$){N.initDebugOverlayCanvas();const W=N.debugOverlayCanvas,X=N.context.gl,J=N.debugOverlayCanvas.getContext("2d");J.clearRect(0,0,W.width,W.height),J.shadowColor="white",J.shadowBlur=2,J.lineWidth=1.5,J.strokeStyle="white",J.textBaseline="top",J.font="bold 36px Open Sans, sans-serif",J.fillText($,5,5),J.strokeText($,5,5),N.debugOverlayTexture.update(W),N.debugOverlayTexture.bind(X.LINEAR,X.CLAMP_TO_EDGE)}(h,`${V} ${S}kB`);const j=h.transform.getProjectionData({overscaledTileID:i,applyGlobeMatrix:!0,applyTerrainMatrix:!0});u.draw(s,o.TRIANGLES,f,g,gi.alphaBlended,Ot.disabled,Oo(c.b6.transparent,R),null,j,x,h.debugBuffer,h.quadTriangleIndexBuffer,h.debugSegments),u.draw(s,o.LINE_STRIP,f,g,y,Ot.disabled,Oo(c.b6.red),T,j,x,h.debugBuffer,h.tileBorderIndexBuffer,h.debugSegments)}function rl(h,e,i,s){const{isRenderingGlobe:o}=s,u=h.context,f=u.gl,g=h.transform,y=h.colorModeForRenderPass(),x=h.getDepthModeFor3D(),T=h.useProgram("terrain");u.bindFramebuffer.set(null),u.viewport.set([0,0,h.width,h.height]);for(const M of i){const S=e.getTerrainMesh(M.tileID),z=h.renderToTexture.getTexture(M),R=e.getTerrainData(M.tileID);u.activeTexture.set(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,z.texture);const V=e.getMeshFrameDelta(g.zoom),j=g.calculateFogMatrix(M.tileID.toUnwrapped()),N=Fo(V,j,h.style.sky,g.pitch,o),$=g.getProjectionData({overscaledTileID:M.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});T.draw(u,f.TRIANGLES,x,Nt.disabled,y,Ot.backCCW,N,R,$,"terrain",S.vertexBuffer,S.indexBuffer,S.segments)}}function nl(h,e){if(!e.mesh){const i=new c.aE;i.emplaceBack(-1,-1),i.emplaceBack(1,-1),i.emplaceBack(1,1),i.emplaceBack(-1,1);const s=new c.aG;s.emplaceBack(0,1,2),s.emplaceBack(0,2,3),e.mesh=new Cr(h.createVertexBuffer(i,Fr.members),h.createIndexBuffer(s),c.aF.simpleSegment(0,0,i.length,s.length))}return e.mesh}class yc{constructor(e,i){this.context=new Rs(e),this.transform=i,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:c.as(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=P.maxUnderzooming+P.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Io}resize(e,i,s){if(this.width=Math.floor(e*s),this.height=Math.floor(i*s),this.pixelRatio=s,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const o of this.style._order)this.style._layers[o].resize()}setup(){const e=this.context,i=new c.aE;i.emplaceBack(0,0),i.emplaceBack(c.Z,0),i.emplaceBack(0,c.Z),i.emplaceBack(c.Z,c.Z),this.tileExtentBuffer=e.createVertexBuffer(i,Fr.members),this.tileExtentSegments=c.aF.simpleSegment(0,0,4,2);const s=new c.aE;s.emplaceBack(0,0),s.emplaceBack(c.Z,0),s.emplaceBack(0,c.Z),s.emplaceBack(c.Z,c.Z),this.debugBuffer=e.createVertexBuffer(s,Fr.members),this.debugSegments=c.aF.simpleSegment(0,0,4,5);const o=new c.bV;o.emplaceBack(0,0,0,0),o.emplaceBack(c.Z,0,c.Z,0),o.emplaceBack(0,c.Z,0,c.Z),o.emplaceBack(c.Z,c.Z,c.Z,c.Z),this.rasterBoundsBuffer=e.createVertexBuffer(o,sn.members),this.rasterBoundsSegments=c.aF.simpleSegment(0,0,4,2);const u=new c.aE;u.emplaceBack(0,0),u.emplaceBack(c.Z,0),u.emplaceBack(0,c.Z),u.emplaceBack(c.Z,c.Z),this.rasterBoundsBufferPosOnly=e.createVertexBuffer(u,Fr.members),this.rasterBoundsSegmentsPosOnly=c.aF.simpleSegment(0,0,4,5);const f=new c.aE;f.emplaceBack(0,0),f.emplaceBack(1,0),f.emplaceBack(0,1),f.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(f,Fr.members),this.viewportSegments=c.aF.simpleSegment(0,0,4,2);const g=new c.bW;g.emplaceBack(0),g.emplaceBack(1),g.emplaceBack(3),g.emplaceBack(2),g.emplaceBack(0),this.tileBorderIndexBuffer=e.createIndexBuffer(g);const y=new c.aG;y.emplaceBack(1,0,2),y.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(y);const x=this.context.gl;this.stencilClearMode=new Nt({func:x.ALWAYS,mask:0},0,255,x.ZERO,x.ZERO,x.ZERO),this.tileExtentMesh=new Cr(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const e=this.context,i=e.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const s=c.K();c.bN(s,0,this.width,this.height,0,0,1),c.M(s,s,[i.drawingBufferWidth,i.drawingBufferHeight,0]);const o={mainMatrix:s,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:s};this.useProgram("clippingMask",null,!0).draw(e,i.TRIANGLES,Ct.disabled,this.stencilClearMode,gi.disabled,Ot.disabled,null,null,o,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(e,i,s){if(this.currentStencilSource===e.source||!e.isTileClipped()||!i||!i.length)return;this.currentStencilSource=e.source,this.nextStencilID+i.length>256&&this.clearStencil();const o=this.context;o.setColorMode(gi.disabled),o.setDepthMode(Ct.disabled);const u={};for(const f of i)u[f.key]=this.nextStencilID++;this._renderTileMasks(u,i,s,!0),this._renderTileMasks(u,i,s,!1),this._tileClippingMaskIDs=u}_renderTileMasks(e,i,s,o){const u=this.context,f=u.gl,g=this.style.projection,y=this.transform,x=this.useProgram("clippingMask");for(const T of i){const M=e[T.key],S=this.style.map.terrain&&this.style.map.terrain.getTerrainData(T),z=g.getMeshFromTileID(this.context,T.canonical,o,!0,"stencil"),R=y.getProjectionData({overscaledTileID:T,applyGlobeMatrix:!0,applyTerrainMatrix:!0});x.draw(u,f.TRIANGLES,Ct.disabled,new Nt({func:f.ALWAYS,mask:0},M,255,f.KEEP,f.KEEP,f.REPLACE),gi.disabled,s?Ot.disabled:Ot.backCCW,null,S,R,"$clipping",z.vertexBuffer,z.indexBuffer,z.segments)}}_renderTilesDepthBuffer(){const e=this.context,i=e.gl,s=this.style.projection,o=this.transform,u=this.useProgram("depth"),f=this.getDepthModeFor3D(),g=se(o,{tileSize:o.tileSize});for(const y of g){const x=this.style.map.terrain&&this.style.map.terrain.getTerrainData(y),T=s.getMeshFromTileID(this.context,y.canonical,!0,!0,"raster"),M=o.getProjectionData({overscaledTileID:y,applyGlobeMatrix:!0,applyTerrainMatrix:!0});u.draw(e,i.TRIANGLES,f,Nt.disabled,gi.disabled,Ot.backCCW,null,x,M,"$clipping",T.vertexBuffer,T.indexBuffer,T.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,i=this.context.gl;return new Nt({func:i.NOTEQUAL,mask:255},e,255,i.KEEP,i.KEEP,i.REPLACE)}stencilModeForClipping(e){const i=this.context.gl;return new Nt({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,i.KEEP,i.KEEP,i.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(e){const i=this.context.gl,s=e.sort((f,g)=>g.overscaledZ-f.overscaledZ),o=s[s.length-1].overscaledZ,u=s[0].overscaledZ-o+1;if(u>1){this.currentStencilSource=void 0,this.nextStencilID+u>256&&this.clearStencil();const f={};for(let g=0;g<u;g++)f[g+o]=new Nt({func:i.GEQUAL,mask:255},g+this.nextStencilID,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID+=u,[f,s]}return[{[o]:Nt.disabled},s]}stencilConfigForOverlapTwoPass(e){const i=this.context.gl,s=e.sort((f,g)=>g.overscaledZ-f.overscaledZ),o=s[s.length-1].overscaledZ,u=s[0].overscaledZ-o+1;if(this.clearStencil(),u>1){const f={},g={};for(let y=0;y<u;y++)f[y+o]=new Nt({func:i.GREATER,mask:255},u+1+y,255,i.KEEP,i.KEEP,i.REPLACE),g[y+o]=new Nt({func:i.GREATER,mask:255},1+y,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID=2*u+1,[f,g,s]}return this.nextStencilID=3,[{[o]:new Nt({func:i.GREATER,mask:255},2,255,i.KEEP,i.KEEP,i.REPLACE)},{[o]:new Nt({func:i.GREATER,mask:255},1,255,i.KEEP,i.KEEP,i.REPLACE)},s]}colorModeForRenderPass(){const e=this.context.gl;return this._showOverdrawInspector?new gi([e.CONSTANT_COLOR,e.ONE],new c.b6(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?gi.unblended:gi.alphaBlended}getDepthModeForSublayer(e,i,s){if(!this.opaquePassEnabledForLayer())return Ct.disabled;const o=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new Ct(s||this.context.gl.LEQUAL,i,[o,o])}getDepthModeFor3D(){return new Ct(this.context.gl.LEQUAL,Ct.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(e,i){var s,o;this.style=e,this.options=i,this.lineAtlas=e.lineAtlas,this.imageManager=e.imageManager,this.glyphManager=e.glyphManager,this.symbolFadeChange=e.placement.symbolFadeChange(Pe.now()),this.imageManager.beginFrame();const u=this.style._order,f=this.style.sourceCaches,g={},y={},x={},T={isRenderingToTexture:!1,isRenderingGlobe:((s=e.projection)===null||s===void 0?void 0:s.transitionState)>0};for(const S in f){const z=f[S];z.used&&z.prepare(this.context),g[S]=z.getVisibleCoordinates(!1),y[S]=g[S].slice().reverse(),x[S]=z.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let S=0;S<u.length;S++)if(this.style._layers[u[S]].is3D()){this.opaquePassCutoff=S;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const S of u){const z=this.style._layers[S];if(!z.hasOffscreenPass()||z.isHidden(this.transform.zoom))continue;const R=y[z.source];(z.type==="custom"||R.length)&&this.renderLayer(this,f[z.source],z,R,T)}if((o=this.style.projection)===null||o===void 0||o.updateGPUdependent({context:this.context,useProgram:S=>this.useProgram(S)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:i.showOverdrawInspector?c.b6.black:c.b6.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(S,z){const R=S.context,V=R.gl,j=((ie,Q,de)=>{const fe=Math.cos(Q.rollInRadians),xe=Math.sin(Q.rollInRadians),we=Wi(Q),ve=Q.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:ie.properties.get("sky-color"),u_horizon_color:ie.properties.get("horizon-color"),u_horizon:[(Q.width/2-we*xe)*de,(Q.height/2+we*fe)*de],u_horizon_normal:[-xe,fe],u_sky_horizon_blend:ie.properties.get("sky-horizon-blend")*Q.height/2*de,u_sky_blend:ve}})(z,S.style.map.transform,S.pixelRatio),N=new Ct(V.LEQUAL,Ct.ReadWrite,[0,1]),$=Nt.disabled,W=S.colorModeForRenderPass(),X=S.useProgram("sky"),J=nl(R,z);X.draw(R,V.TRIANGLES,N,$,W,Ot.disabled,j,null,void 0,"sky",J.vertexBuffer,J.indexBuffer,J.segments)}(this,this.style.sky),this._showOverdrawInspector=i.showOverdrawInspector,this.depthRangeFor3D=[0,1-(e._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=u.length-1;this.currentLayer>=0;this.currentLayer--){const S=this.style._layers[u[this.currentLayer]],z=f[S.source],R=g[S.source];this._renderTileClippingMasks(S,R,!1),this.renderLayer(this,z,S,R,T)}this.renderPass="translucent";let M=!1;for(this.currentLayer=0;this.currentLayer<u.length;this.currentLayer++){const S=this.style._layers[u[this.currentLayer]],z=f[S.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(S,T))continue;this.opaquePassEnabledForLayer()||M||(M=!0,T.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const R=(S.type==="symbol"?x:y)[S.source];this._renderTileClippingMasks(S,g[S.source],!1),this.renderLayer(this,z,S,R,T)}if(T.isRenderingGlobe&&function(S,z,R){const V=S.context,j=V.gl,N=S.useProgram("atmosphere"),$=new Ct(j.LEQUAL,Ct.ReadOnly,[0,1]),W=S.transform,X=function(ve,Le){const Re=ve.properties.get("position"),Ce=[-Re.x,-Re.y,-Re.z],it=c.as(new Float64Array(16));return ve.properties.get("anchor")==="map"&&(c.aZ(it,it,Le.rollInRadians),c.a_(it,it,-Le.pitchInRadians),c.aZ(it,it,Le.bearingInRadians),c.a_(it,it,Le.center.lat*Math.PI/180),c.bl(it,it,-Le.center.lng*Math.PI/180)),c.bU(Ce,Ce,it),Ce}(R,S.transform),J=W.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),ie=z.properties.get("atmosphere-blend")*J.projectionTransition;if(ie===0)return;const Q=cr(W.worldSize,W.center.lat),de=W.inverseProjectionMatrix,fe=new Float64Array(4);fe[3]=1,c.ao(fe,fe,W.modelViewProjectionMatrix),fe[0]/=fe[3],fe[1]/=fe[3],fe[2]/=fe[3],fe[3]=1,c.ao(fe,fe,de),fe[0]/=fe[3],fe[1]/=fe[3],fe[2]/=fe[3],fe[3]=1;const xe=((ve,Le,Re,Ce,it)=>({u_sun_pos:ve,u_atmosphere_blend:Le,u_globe_position:Re,u_globe_radius:Ce,u_inv_proj_matrix:it}))(X,ie,[fe[0],fe[1],fe[2]],Q,de),we=nl(V,z);N.draw(V,j.TRIANGLES,$,Nt.disabled,gi.alphaBlended,Ot.disabled,xe,null,null,"atmosphere",we.vertexBuffer,we.indexBuffer,we.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const S=function(z,R){let V=null;const j=Object.values(z._layers).flatMap(X=>X.source&&!X.isHidden(R)?[z.sourceCaches[X.source]]:[]),N=j.filter(X=>X.getSource().type==="vector"),$=j.filter(X=>X.getSource().type!=="vector"),W=X=>{(!V||V.getSource().maxzoom<X.getSource().maxzoom)&&(V=X)};return N.forEach(X=>W(X)),V||$.forEach(X=>W(X)),V}(this.style,this.transform.zoom);S&&function(z,R,V){for(let j=0;j<V.length;j++)_c(z,R,V[j])}(this,S,S.getVisibleCoordinates())}this.options.showPadding&&function(S){const z=S.transform.padding;Hn(S,S.transform.height-(z.top||0),3,qn),Hn(S,z.bottom||0,3,Zr),_a(S,z.left||0,3,tl),_a(S,S.transform.width-(z.right||0),3,il);const R=S.transform.centerPoint;(function(V,j,N,$){ya(V,j-1,N-10,2,20,$),ya(V,j-10,N-1,20,2,$)})(S,R.x,S.transform.height-R.y,gc)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(e){if(!this.style||!this.style.map||!this.style.map.terrain)return;const i=this.terrainFacilitator.matrix,s=this.transform.modelViewProjectionMatrix;let o=this.terrainFacilitator.dirty;o||(o=e?!c.bX(i,s):!c.bY(i,s)),o||(o=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),o&&(c.bZ(i,s),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(u,f){const g=u.context,y=g.gl,x=u.transform,T=gi.unblended,M=new Ct(y.LEQUAL,Ct.ReadWrite,[0,1]),S=f.sourceCache.getRenderableTiles(),z=u.useProgram("terrainDepth");g.bindFramebuffer.set(f.getFramebuffer("depth").framebuffer),g.viewport.set([0,0,u.width/devicePixelRatio,u.height/devicePixelRatio]),g.clear({color:c.b6.transparent,depth:1});for(const R of S){const V=f.getTerrainMesh(R.tileID),j=f.getTerrainData(R.tileID),N=x.getProjectionData({overscaledTileID:R.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),$={u_ele_delta:f.getMeshFrameDelta(x.zoom)};z.draw(g,y.TRIANGLES,M,Nt.disabled,T,Ot.backCCW,$,j,N,"terrain",V.vertexBuffer,V.indexBuffer,V.segments)}g.bindFramebuffer.set(null),g.viewport.set([0,0,u.width,u.height])}(this,this.style.map.terrain),function(u,f){const g=u.context,y=g.gl,x=u.transform,T=gi.unblended,M=new Ct(y.LEQUAL,Ct.ReadWrite,[0,1]),S=f.getCoordsTexture(),z=f.sourceCache.getRenderableTiles(),R=u.useProgram("terrainCoords");g.bindFramebuffer.set(f.getFramebuffer("coords").framebuffer),g.viewport.set([0,0,u.width/devicePixelRatio,u.height/devicePixelRatio]),g.clear({color:c.b6.transparent,depth:1}),f.coordsIndex=[];for(const V of z){const j=f.getTerrainMesh(V.tileID),N=f.getTerrainData(V.tileID);g.activeTexture.set(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,S.texture);const $={u_terrain_coords_id:(255-f.coordsIndex.length)/255,u_texture:0,u_ele_delta:f.getMeshFrameDelta(x.zoom)},W=x.getProjectionData({overscaledTileID:V.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});R.draw(g,y.TRIANGLES,M,Nt.disabled,T,Ot.backCCW,$,N,W,"terrain",j.vertexBuffer,j.indexBuffer,j.segments),f.coordsIndex.push(V.tileID.key)}g.bindFramebuffer.set(null),g.viewport.set([0,0,u.width,u.height])}(this,this.style.map.terrain))}renderLayer(e,i,s,o,u){s.isHidden(this.transform.zoom)||(s.type==="background"||s.type==="custom"||(o||[]).length)&&(this.id=s.id,c.b_(s)?function(f,g,y,x,T,M){if(f.renderPass!=="translucent")return;const{isRenderingToTexture:S}=M,z=Nt.disabled,R=f.colorModeForRenderPass();(y._unevaluatedLayout.hasValue("text-variable-anchor")||y._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(V,j,N,$,W,X,J,ie,Q){const de=j.transform,fe=j.style.map.terrain,xe=W==="map",we=X==="map";for(const ve of V){const Le=$.getTile(ve),Re=Le.getBucket(N);if(!Re||!Re.text||!Re.text.segments.get().length)continue;const Ce=c.af(Re.textSizeData,de.zoom),it=c.av(Le,1,j.transform.zoom),ot=ue(xe,j.transform,it),Ht=N.layout.get("icon-text-fit")!=="none"&&Re.hasIconData();if(Ce){const ui=Math.pow(2,de.zoom-Le.tileID.overscaledZ),ri=fe?(yi,fi)=>fe.getElevation(ve,yi,fi):null;Bs(Re,xe,we,Q,de,ot,ui,Ce,Ht,c.aw(de,Le,J,ie),ve.toUnwrapped(),ri)}}}(x,f,y,g,y.layout.get("text-rotation-alignment"),y.layout.get("text-pitch-alignment"),y.paint.get("text-translate"),y.paint.get("text-translate-anchor"),T),y.paint.get("icon-opacity").constantOr(1)!==0&&fc(f,g,y,x,!1,y.paint.get("icon-translate"),y.paint.get("icon-translate-anchor"),y.layout.get("icon-rotation-alignment"),y.layout.get("icon-pitch-alignment"),y.layout.get("icon-keep-upright"),z,R,S),y.paint.get("text-opacity").constantOr(1)!==0&&fc(f,g,y,x,!0,y.paint.get("text-translate"),y.paint.get("text-translate-anchor"),y.layout.get("text-rotation-alignment"),y.layout.get("text-pitch-alignment"),y.layout.get("text-keep-upright"),z,R,S),g.map.showCollisionBoxes&&(Ls(f,g,y,x,!0),Ls(f,g,y,x,!1))}(e,i,s,o,this.style.placement.variableOffsets,u):c.b$(s)?function(f,g,y,x,T){if(f.renderPass!=="translucent")return;const{isRenderingToTexture:M}=T,S=y.paint.get("circle-opacity"),z=y.paint.get("circle-stroke-width"),R=y.paint.get("circle-stroke-opacity"),V=!y.layout.get("circle-sort-key").isConstant();if(S.constantOr(1)===0&&(z.constantOr(1)===0||R.constantOr(1)===0))return;const j=f.context,N=j.gl,$=f.transform,W=f.getDepthModeForSublayer(0,Ct.ReadOnly),X=Nt.disabled,J=f.colorModeForRenderPass(),ie=[],Q=$.getCircleRadiusCorrection();for(let de=0;de<x.length;de++){const fe=x[de],xe=g.getTile(fe),we=xe.getBucket(y);if(!we)continue;const ve=y.paint.get("circle-translate"),Le=y.paint.get("circle-translate-anchor"),Re=c.aw($,xe,ve,Le),Ce=we.programConfigurations.get(y.id),it=f.useProgram("circle",Ce),ot=we.layoutVertexBuffer,Ht=we.indexBuffer,ui=f.style.map.terrain&&f.style.map.terrain.getTerrainData(fe),ri={programConfiguration:Ce,program:it,layoutVertexBuffer:ot,indexBuffer:Ht,uniformValues:Kl(f,xe,y,Re,Q),terrainData:ui,projectionData:$.getProjectionData({overscaledTileID:fe,applyGlobeMatrix:!M,applyTerrainMatrix:!0})};if(V){const yi=we.segments.get();for(const fi of yi)ie.push({segments:new c.aF([fi]),sortKey:fi.sortKey,state:ri})}else ie.push({segments:we.segments,sortKey:0,state:ri})}V&&ie.sort((de,fe)=>de.sortKey-fe.sortKey);for(const de of ie){const{programConfiguration:fe,program:xe,layoutVertexBuffer:we,indexBuffer:ve,uniformValues:Le,terrainData:Re,projectionData:Ce}=de.state;xe.draw(j,N.TRIANGLES,W,X,J,Ot.backCCW,Le,Re,Ce,y.id,we,ve,de.segments,y.paint,f.transform.zoom,fe)}}(e,i,s,o,u):c.c0(s)?function(f,g,y,x,T){if(y.paint.get("heatmap-opacity")===0)return;const M=f.context,{isRenderingToTexture:S,isRenderingGlobe:z}=T;if(f.style.map.terrain){for(const R of x){const V=g.getTile(R);g.hasRenderableParent(R)||(f.renderPass==="offscreen"?Ch(f,V,y,R,z):f.renderPass==="translucent"&&mc(f,y,R,S,z))}M.viewport.set([0,0,f.width,f.height])}else f.renderPass==="offscreen"?function(R,V,j,N){const $=R.context,W=$.gl,X=R.transform,J=Nt.disabled,ie=new gi([W.ONE,W.ONE],c.b6.transparent,[!0,!0,!0,!0]);(function(Q,de,fe){const xe=Q.gl;Q.activeTexture.set(xe.TEXTURE1),Q.viewport.set([0,0,de.width/4,de.height/4]);let we=fe.heatmapFbos.get(c.bR);we?(xe.bindTexture(xe.TEXTURE_2D,we.colorAttachment.get()),Q.bindFramebuffer.set(we.framebuffer)):(we=Za(Q,de.width/4,de.height/4),fe.heatmapFbos.set(c.bR,we))})($,R,j),$.clear({color:c.b6.transparent});for(let Q=0;Q<N.length;Q++){const de=N[Q];if(V.hasRenderableParent(de))continue;const fe=V.getTile(de),xe=fe.getBucket(j);if(!xe)continue;const we=xe.programConfigurations.get(j.id),ve=R.useProgram("heatmap",we),Le=X.getProjectionData({overscaledTileID:de,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Re=X.getCircleRadiusCorrection();ve.draw($,W.TRIANGLES,Ct.disabled,J,ie,Ot.backCCW,jo(fe,X.zoom,j.paint.get("heatmap-intensity"),Re),null,Le,j.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,j.paint,X.zoom,we)}$.viewport.set([0,0,R.width,R.height])}(f,g,y,x):f.renderPass==="translucent"&&function(R,V){const j=R.context,N=j.gl;j.setColorMode(R.colorModeForRenderPass());const $=V.heatmapFbos.get(c.bR);$&&(j.activeTexture.set(N.TEXTURE0),N.bindTexture(N.TEXTURE_2D,$.colorAttachment.get()),j.activeTexture.set(N.TEXTURE1),js(j,V).bind(N.LINEAR,N.CLAMP_TO_EDGE),R.useProgram("heatmapTexture").draw(j,N.TRIANGLES,Ct.disabled,Nt.disabled,R.colorModeForRenderPass(),Ot.disabled,Vo(R,V,0,1),null,null,V.id,R.viewportBuffer,R.quadTriangleIndexBuffer,R.viewportSegments,V.paint,R.transform.zoom))}(f,y)}(e,i,s,o,u):c.c1(s)?function(f,g,y,x,T){if(f.renderPass!=="translucent")return;const{isRenderingToTexture:M}=T,S=y.paint.get("line-opacity"),z=y.paint.get("line-width");if(S.constantOr(1)===0||z.constantOr(1)===0)return;const R=f.getDepthModeForSublayer(0,Ct.ReadOnly),V=f.colorModeForRenderPass(),j=y.paint.get("line-dasharray"),N=y.paint.get("line-pattern"),$=N.constantOr(1),W=y.paint.get("line-gradient"),X=y.getCrossfadeParameters(),J=$?"linePattern":j?"lineSDF":W?"lineGradient":"line",ie=f.context,Q=ie.gl,de=f.transform;let fe=!0;for(const xe of x){const we=g.getTile(xe);if($&&!we.patternsLoaded())continue;const ve=we.getBucket(y);if(!ve)continue;const Le=ve.programConfigurations.get(y.id),Re=f.context.program.get(),Ce=f.useProgram(J,Le),it=fe||Ce.program!==Re,ot=f.style.map.terrain&&f.style.map.terrain.getTerrainData(xe),Ht=N.constantOr(null);if(Ht&&we.imageAtlas){const Xt=we.imageAtlas,ni=Xt.patternPositions[Ht.to.toString()],Ki=Xt.patternPositions[Ht.from.toString()];ni&&Ki&&Le.setConstantPatternPositions(ni,Ki)}const ui=de.getProjectionData({overscaledTileID:xe,applyGlobeMatrix:!M,applyTerrainMatrix:!0}),ri=de.getPixelScale(),yi=$?Ts(f,we,y,ri,X):j?yh(f,we,y,ri,j,X):W?_h(f,we,y,ri,ve.lineClipsArray.length):Vn(f,we,y,ri);if($)ie.activeTexture.set(Q.TEXTURE0),we.imageAtlasTexture.bind(Q.LINEAR,Q.CLAMP_TO_EDGE),Le.updatePaintBuffers(X);else if(j&&(it||f.lineAtlas.dirty))ie.activeTexture.set(Q.TEXTURE0),f.lineAtlas.bind(ie);else if(W){const Xt=ve.gradients[y.id];let ni=Xt.texture;if(y.gradientVersion!==Xt.version){let Ki=256;if(y.stepInterpolant){const Yi=g.getSource().maxzoom,Zi=xe.canonical.z===Yi?Math.ceil(1<<f.transform.maxZoom-xe.canonical.z):1;Ki=c.ad(c.bS(ve.maxLineLength/c.Z*1024*Zi),256,ie.maxTextureSize)}Xt.gradient=c.bT({expression:y.gradientExpression(),evaluationKey:"lineProgress",resolution:Ki,image:Xt.gradient||void 0,clips:ve.lineClipsArray}),Xt.texture?Xt.texture.update(Xt.gradient):Xt.texture=new xt(ie,Xt.gradient,Q.RGBA),Xt.version=y.gradientVersion,ni=Xt.texture}ie.activeTexture.set(Q.TEXTURE0),ni.bind(y.stepInterpolant?Q.NEAREST:Q.LINEAR,Q.CLAMP_TO_EDGE)}let fi;if(M){const[Xt]=f.getStencilConfigForOverlapAndUpdateStencilID(x);fi=Xt[xe.overscaledZ]}else fi=f.stencilModeForClipping(xe);Ce.draw(ie,Q.TRIANGLES,R,fi,V,Ot.disabled,yi,ot,ui,y.id,ve.layoutVertexBuffer,ve.indexBuffer,ve.segments,y.paint,f.transform.zoom,Le,ve.layoutVertexBuffer2),fe=!1}}(e,i,s,o,u):c.c2(s)?function(f,g,y,x,T){const M=y.paint.get("fill-color"),S=y.paint.get("fill-opacity");if(S.constantOr(1)===0)return;const{isRenderingToTexture:z}=T,R=f.colorModeForRenderPass(),V=y.paint.get("fill-pattern"),j=f.opaquePassEnabledForLayer()&&!V.constantOr(1)&&M.constantOr(c.b6.transparent).a===1&&S.constantOr(0)===1?"opaque":"translucent";if(f.renderPass===j){const N=f.getDepthModeForSublayer(1,f.renderPass==="opaque"?Ct.ReadWrite:Ct.ReadOnly);Qo(f,g,y,x,N,R,!1,z)}if(f.renderPass==="translucent"&&y.paint.get("fill-antialias")){const N=f.getDepthModeForSublayer(y.getPaintProperty("fill-outline-color")?2:0,Ct.ReadOnly);Qo(f,g,y,x,N,R,!0,z)}}(e,i,s,o,u):c.c3(s)?function(f,g,y,x,T){const M=y.paint.get("fill-extrusion-opacity");if(M===0)return;const{isRenderingToTexture:S}=T;if(f.renderPass==="translucent"){const z=new Ct(f.context.gl.LEQUAL,Ct.ReadWrite,f.depthRangeFor3D);if(M!==1||y.paint.get("fill-extrusion-pattern").constantOr(1))ga(f,g,y,x,z,Nt.disabled,gi.disabled,S),ga(f,g,y,x,z,f.stencilModeFor3D(),f.colorModeForRenderPass(),S);else{const R=f.colorModeForRenderPass();ga(f,g,y,x,z,Nt.disabled,R,S)}}}(e,i,s,o,u):c.c4(s)?function(f,g,y,x,T){if(f.renderPass!=="offscreen"&&f.renderPass!=="translucent")return;const{isRenderingToTexture:M}=T,S=f.context,z=f.style.projection.useSubdivision,R=f.getDepthModeForSublayer(0,Ct.ReadOnly),V=f.colorModeForRenderPass();if(f.renderPass==="offscreen")(function(j,N,$,W,X,J,ie){const Q=j.context,de=Q.gl;for(const fe of $){const xe=N.getTile(fe),we=xe.dem;if(!we||!we.data||!xe.needsHillshadePrepare)continue;const ve=we.dim,Le=we.stride,Re=we.getPixels();if(Q.activeTexture.set(de.TEXTURE1),Q.pixelStoreUnpackPremultiplyAlpha.set(!1),xe.demTexture=xe.demTexture||j.getTileTexture(Le),xe.demTexture){const it=xe.demTexture;it.update(Re,{premultiply:!1}),it.bind(de.NEAREST,de.CLAMP_TO_EDGE)}else xe.demTexture=new xt(Q,Re,de.RGBA,{premultiply:!1}),xe.demTexture.bind(de.NEAREST,de.CLAMP_TO_EDGE);Q.activeTexture.set(de.TEXTURE0);let Ce=xe.fbo;if(!Ce){const it=new xt(Q,{width:ve,height:ve,data:null},de.RGBA);it.bind(de.LINEAR,de.CLAMP_TO_EDGE),Ce=xe.fbo=Q.createFramebuffer(ve,ve,!0,!1),Ce.colorAttachment.set(it.texture)}Q.bindFramebuffer.set(Ce.framebuffer),Q.viewport.set([0,0,ve,ve]),j.useProgram("hillshadePrepare").draw(Q,de.TRIANGLES,X,J,ie,Ot.disabled,Jl(xe.tileID,we),null,null,W.id,j.rasterBoundsBuffer,j.quadTriangleIndexBuffer,j.rasterBoundsSegments),xe.needsHillshadePrepare=!1}})(f,g,x,y,R,Nt.disabled,V),S.viewport.set([0,0,f.width,f.height]);else if(f.renderPass==="translucent")if(z){const[j,N,$]=f.stencilConfigForOverlapTwoPass(x);Ua(f,g,y,$,j,R,V,!1,M),Ua(f,g,y,$,N,R,V,!0,M)}else{const[j,N]=f.getStencilConfigForOverlapAndUpdateStencilID(x);Ua(f,g,y,N,j,R,V,!1,M)}}(e,i,s,o,u):c.c5(s)?function(f,g,y,x,T){if(f.renderPass!=="translucent"||y.paint.get("raster-opacity")===0||!x.length)return;const{isRenderingToTexture:M}=T,S=g.getSource(),z=f.style.projection.useSubdivision;if(S instanceof pr)$a(f,g,y,x,null,!1,!1,S.tileCoords,S.flippedWindingOrder,M);else if(z){const[R,V,j]=f.stencilConfigForOverlapTwoPass(x);$a(f,g,y,j,R,!1,!0,el,!1,M),$a(f,g,y,j,V,!0,!0,el,!1,M)}else{const[R,V]=f.getStencilConfigForOverlapAndUpdateStencilID(x);$a(f,g,y,V,R,!1,!0,el,!1,M)}}(e,i,s,o,u):c.c6(s)?function(f,g,y,x,T){const M=y.paint.get("background-color"),S=y.paint.get("background-opacity");if(S===0)return;const{isRenderingToTexture:z}=T,R=f.context,V=R.gl,j=f.style.projection,N=f.transform,$=N.tileSize,W=y.paint.get("background-pattern");if(f.isPatternMissing(W))return;const X=!W&&M.a===1&&S===1&&f.opaquePassEnabledForLayer()?"opaque":"translucent";if(f.renderPass!==X)return;const J=Nt.disabled,ie=f.getDepthModeForSublayer(0,X==="opaque"?Ct.ReadWrite:Ct.ReadOnly),Q=f.colorModeForRenderPass(),de=f.useProgram(W?"backgroundPattern":"background"),fe=x||se(N,{tileSize:$,terrain:f.style.map.terrain});W&&(R.activeTexture.set(V.TEXTURE0),f.imageManager.bind(f.context));const xe=y.getCrossfadeParameters();for(const we of fe){const ve=N.getProjectionData({overscaledTileID:we,applyGlobeMatrix:!z,applyTerrainMatrix:!0}),Le=W?Uo(S,f,W,{tileID:we,tileSize:$},xe):gn(S,M),Re=f.style.map.terrain&&f.style.map.terrain.getTerrainData(we),Ce=j.getMeshFromTileID(R,we.canonical,!1,!0,"raster");de.draw(R,V.TRIANGLES,ie,J,Q,Ot.backCCW,Le,Re,ve,y.id,Ce.vertexBuffer,Ce.indexBuffer,Ce.segments)}}(e,0,s,o,u):c.c7(s)&&function(f,g,y,x){const{isRenderingGlobe:T}=x,M=f.context,S=y.implementation,z=f.style.projection,R=f.transform,V=R.getProjectionDataForCustomLayer(T),j={farZ:R.farZ,nearZ:R.nearZ,fov:R.fov*Math.PI/180,modelViewProjectionMatrix:R.modelViewProjectionMatrix,projectionMatrix:R.projectionMatrix,shaderData:{variantName:z.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${z.shaderPreludeCode.vertexSource}`,define:z.shaderDefine},defaultProjectionData:V},N=S.renderingMode?S.renderingMode:"2d";if(f.renderPass==="offscreen"){const $=S.prerender;$&&(f.setCustomLayerDefaults(),M.setColorMode(f.colorModeForRenderPass()),$.call(S,M.gl,j),M.setDirty(),f.setBaseState())}else if(f.renderPass==="translucent"){f.setCustomLayerDefaults(),M.setColorMode(f.colorModeForRenderPass()),M.setStencilMode(Nt.disabled);const $=N==="3d"?f.getDepthModeFor3D():f.getDepthModeForSublayer(0,Ct.ReadOnly);M.setDepthMode($),S.render(M.gl,j),M.setDirty(),f.setBaseState(),M.bindFramebuffer.set(null)}}(e,0,s,u))}saveTileTexture(e){const i=this._tileTextures[e.size[0]];i?i.push(e):this._tileTextures[e.size[0]]=[e]}getTileTexture(e){const i=this._tileTextures[e];return i&&i.length>0?i.pop():null}isPatternMissing(e){if(!e)return!1;if(!e.from||!e.to)return!0;const i=this.imageManager.getPattern(e.from.toString()),s=this.imageManager.getPattern(e.to.toString());return!i||!s}useProgram(e,i,s=!1){this.cache=this.cache||{};const o=!!this.style.map.terrain,u=this.style.projection,f=e+(i?i.cacheKey:"")+`/${s?ds:u.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(o?"/terrain":"");return this.cache[f]||(this.cache[f]=new mh(this.context,Xr[e],i,$o[e],this._showOverdrawInspector,o,s?Xr.projectionMercator:u.shaderPreludeCode,s?$t:u.shaderDefine)),this.cache[f]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new xt(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:e,drawingBufferHeight:i}=this.context.gl;return this.width!==e||this.height!==i}}function al(h,e){let i,s=!1,o=null,u=null;const f=()=>{o=null,s&&(h.apply(u,i),o=setTimeout(f,e),s=!1)};return(...g)=>(s=!0,u=this,i=g,o||f(),o)}class Cn{constructor(e){this._getCurrentHash=()=>{const i=window.location.hash.replace("#","");if(this._hashName){let s;return i.split("&").map(o=>o.split("=")).forEach(o=>{o[0]===this._hashName&&(s=o)}),(s&&s[1]||"").split("/")}return i.split("/")},this._onHashChange=()=>{const i=this._getCurrentHash();if(!this._isValidHash(i))return!1;const s=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(i[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+i[2],+i[1]],zoom:+i[0],bearing:s,pitch:+(i[4]||0)}),!0},this._updateHashUnthrottled=()=>{const i=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,i)},this._removeHash=()=>{const i=this._getCurrentHash();if(i.length===0)return;const s=i.join("/");let o=s;o.split("&").length>0&&(o=o.split("&")[0]),this._hashName&&(o=`${this._hashName}=${s}`);let u=window.location.hash.replace(o,"");u.startsWith("#&")?u=u.slice(0,1)+u.slice(2):u==="#"&&(u="");let f=window.location.href.replace(/(#.+)?$/,u);f=f.replace("&&","&"),window.history.replaceState(window.history.state,null,f)},this._updateHash=al(this._updateHashUnthrottled,300),this._hashName=e&&encodeURIComponent(e)}addTo(e){return this._map=e,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(e){const i=this._map.getCenter(),s=Math.round(100*this._map.getZoom())/100,o=Math.ceil((s*Math.LN2+Math.log(512/360/.5))/Math.LN10),u=Math.pow(10,o),f=Math.round(i.lng*u)/u,g=Math.round(i.lat*u)/u,y=this._map.getBearing(),x=this._map.getPitch();let T="";if(T+=e?`/${f}/${g}/${s}`:`${s}/${g}/${f}`,(y||x)&&(T+="/"+Math.round(10*y)/10),x&&(T+=`/${Math.round(x)}`),this._hashName){const M=this._hashName;let S=!1;const z=window.location.hash.slice(1).split("&").map(R=>{const V=R.split("=")[0];return V===M?(S=!0,`${V}=${T}`):R}).filter(R=>R);return S||z.push(`${M}=${T}`),`#${z.join("&")}`}return`#${T}`}_isValidHash(e){if(e.length<3||e.some(isNaN))return!1;try{new c.Q(+e[2],+e[1])}catch{return!1}const i=+e[0],s=+(e[3]||0),o=+(e[4]||0);return i>=this._map.getMinZoom()&&i<=this._map.getMaxZoom()&&s>=-180&&s<=180&&o>=this._map.getMinPitch()&&o<=this._map.getMaxPitch()}}const va={linearity:.3,easing:c.c8(0,0,.3,1)},vc=c.e({deceleration:2500,maxSpeed:1400},va),xc=c.e({deceleration:20,maxSpeed:1400},va),bc=c.e({deceleration:1e3,maxSpeed:360},va),wc=c.e({deceleration:1e3,maxSpeed:90},va),Tc=c.e({deceleration:1e3,maxSpeed:360},va);class Pc{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:Pe.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,i=Pe.now();for(;e.length>0&&i-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const i={zoom:0,bearing:0,pitch:0,roll:0,pan:new c.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:u}of this._inertiaBuffer)i.zoom+=u.zoomDelta||0,i.bearing+=u.bearingDelta||0,i.pitch+=u.pitchDelta||0,i.roll+=u.rollDelta||0,u.panDelta&&i.pan._add(u.panDelta),u.around&&(i.around=u.around),u.pinchAround&&(i.pinchAround=u.pinchAround);const s=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,o={};if(i.pan.mag()){const u=xa(i.pan.mag(),s,c.e({},vc,e||{})),f=i.pan.mult(u.amount/i.pan.mag()),g=this._map.cameraHelper.handlePanInertia(f,this._map.transform);o.center=g.easingCenter,o.offset=g.easingOffset,In(o,u)}if(i.zoom){const u=xa(i.zoom,s,xc);o.zoom=this._map.transform.zoom+u.amount,In(o,u)}if(i.bearing){const u=xa(i.bearing,s,bc);o.bearing=this._map.transform.bearing+c.ad(u.amount,-179,179),In(o,u)}if(i.pitch){const u=xa(i.pitch,s,wc);o.pitch=this._map.transform.pitch+u.amount,In(o,u)}if(i.roll){const u=xa(i.roll,s,Tc);o.roll=this._map.transform.roll+c.ad(u.amount,-179,179),In(o,u)}if(o.zoom||o.bearing){const u=i.pinchAround===void 0?i.around:i.pinchAround;o.around=u?this._map.unproject(u):this._map.getCenter()}return this.clear(),c.e(o,{noMoveStart:!0})}}function In(h,e){(!h.duration||h.duration<e.duration)&&(h.duration=e.duration,h.easing=e.easing)}function xa(h,e,i){const{maxSpeed:s,linearity:o,deceleration:u}=i,f=c.ad(h*o/(e/1e3),-s,s),g=Math.abs(f)/(u*o);return{easing:i.easing,duration:1e3*g,amount:f*(g/2)}}class Mi extends c.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,s,o={}){const u=Y.mousePos(i.getCanvas(),s),f=i.unproject(u);super(e,c.e({point:u,lngLat:f,originalEvent:s},o)),this._defaultPrevented=!1,this.target=i}}class br extends c.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,s){const o=e==="touchend"?s.changedTouches:s.touches,u=Y.touchPos(i.getCanvasContainer(),o),f=u.map(y=>i.unproject(y)),g=u.reduce((y,x,T,M)=>y.add(x.div(M.length)),new c.P(0,0));super(e,{points:u,point:g,lngLats:f,lngLat:i.unproject(g),originalEvent:s}),this._defaultPrevented=!1}}class sl extends c.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,s){super(e,{originalEvent:s}),this._defaultPrevented=!1}}class on{constructor(e,i){this._map=e,this._clickTolerance=i.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new sl(e.type,this._map,e))}mousedown(e,i){return this._mousedownPos=i,this._firePreventable(new Mi(e.type,this._map,e))}mouseup(e){this._map.fire(new Mi(e.type,this._map,e))}click(e,i){this._mousedownPos&&this._mousedownPos.dist(i)>=this._clickTolerance||this._map.fire(new Mi(e.type,this._map,e))}dblclick(e){return this._firePreventable(new Mi(e.type,this._map,e))}mouseover(e){this._map.fire(new Mi(e.type,this._map,e))}mouseout(e){this._map.fire(new Mi(e.type,this._map,e))}touchstart(e){return this._firePreventable(new br(e.type,this._map,e))}touchmove(e){this._map.fire(new br(e.type,this._map,e))}touchend(e){this._map.fire(new br(e.type,this._map,e))}touchcancel(e){this._map.fire(new br(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ba{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(e){this._map.fire(new Mi(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Mi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._ignoreContextMenu||this._map.fire(new Mi(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ga{constructor(e){this._map=e}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(e){return this.transform.screenPointToLocation(c.P.convert(e),this._map.terrain)}}class Mc{constructor(e,i){this._map=e,this._tr=new Ga(e),this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=i.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,i){this.isEnabled()&&e.shiftKey&&e.button===0&&(Y.disableDrag(),this._startPos=this._lastPos=i,this._active=!0)}mousemoveWindow(e,i){if(!this._active)return;const s=i;if(this._lastPos.equals(s)||!this._box&&s.dist(this._startPos)<this._clickTolerance)return;const o=this._startPos;this._lastPos=s,this._box||(this._box=Y.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",e));const u=Math.min(o.x,s.x),f=Math.max(o.x,s.x),g=Math.min(o.y,s.y),y=Math.max(o.y,s.y);Y.setTransform(this._box,`translate(${u}px,${g}px)`),this._box.style.width=f-u+"px",this._box.style.height=y-g+"px"}mouseupWindow(e,i){if(!this._active||e.button!==0)return;const s=this._startPos,o=i;if(this.reset(),Y.suppressClick(),s.x!==o.x||s.y!==o.y)return this._map.fire(new c.l("boxzoomend",{originalEvent:e})),{cameraAnimation:u=>u.fitScreenCoordinates(s,o,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",e)}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(Y.remove(this._box),this._box=null),Y.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(e,i){return this._map.fire(new c.l(e,{originalEvent:i}))}}function ol(h,e){if(h.length!==e.length)throw new Error(`The number of touches and points are not equal - touches ${h.length}, points ${e.length}`);const i={};for(let s=0;s<h.length;s++)i[h[s].identifier]=e[s];return i}class Ih{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(e,i,s){(this.centroid||s.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=e.timeStamp),s.length===this.numTouches&&(this.centroid=function(o){const u=new c.P(0,0);for(const f of o)u._add(f);return u.div(o.length)}(i),this.touches=ol(s,i)))}touchmove(e,i,s){if(this.aborted||!this.centroid)return;const o=ol(s,i);for(const u in this.touches){const f=o[u];(!f||f.dist(this.touches[u])>30)&&(this.aborted=!0)}}touchend(e,i,s){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),s.length===0){const o=!this.aborted&&this.centroid;if(this.reset(),o)return o}}}class Vs{constructor(e){this.singleTap=new Ih(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(e,i,s){this.singleTap.touchstart(e,i,s)}touchmove(e,i,s){this.singleTap.touchmove(e,i,s)}touchend(e,i,s){const o=this.singleTap.touchend(e,i,s);if(o){const u=e.timeStamp-this.lastTime<500,f=!this.lastTap||this.lastTap.dist(o)<30;if(u&&f||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=o,this.count===this.numTaps)return this.reset(),o}}}class qa{constructor(e){this._tr=new Ga(e),this._zoomIn=new Vs({numTouches:1,numTaps:2}),this._zoomOut=new Vs({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,i,s){this._zoomIn.touchstart(e,i,s),this._zoomOut.touchstart(e,i,s)}touchmove(e,i,s){this._zoomIn.touchmove(e,i,s),this._zoomOut.touchmove(e,i,s)}touchend(e,i,s){const o=this._zoomIn.touchend(e,i,s),u=this._zoomOut.touchend(e,i,s),f=this._tr;return o?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:f.zoom+1,around:f.unproject(o)},{originalEvent:e})}):u?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:g=>g.easeTo({duration:300,zoom:f.zoom-1,around:f.unproject(u)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Er{constructor(e){this._enabled=!!e.enable,this._moveStateManager=e.moveStateManager,this._clickTolerance=e.clickTolerance||1,this._moveFunction=e.move,this._activateOnStart=!!e.activateOnStart,e.assignEvents(this),this.reset()}reset(e){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(e)}_move(...e){const i=this._moveFunction(...e);if(i.bearingDelta||i.pitchDelta||i.rollDelta||i.around||i.panDelta)return this._active=!0,i}dragStart(e,i){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(e)&&(this._moveStateManager.startMove(e),this._lastPoint=Array.isArray(i)?i[0]:i,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(e,i){if(!this.isEnabled())return;const s=this._lastPoint;if(!s)return;if(e.preventDefault(),!this._moveStateManager.isValidMoveEvent(e))return void this.reset(e);const o=Array.isArray(i)?i[0]:i;return!this._moved&&o.dist(s)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=o,this._move(s,o))}dragEnd(e){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(e)&&(this._moved&&Y.suppressClick(),this.reset(e))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const qe={0:1,2:2};class wa{constructor(e){this._correctEvent=e.checkCorrectEvent}startMove(e){const i=Y.mouseButton(e);this._eventButton=i}endMove(e){delete this._eventButton}isValidStartEvent(e){return this._correctEvent(e)}isValidMoveEvent(e){return!function(i,s){const o=qe[s];return i.buttons===void 0||(i.buttons&o)!==o}(e,this._eventButton)}isValidEndEvent(e){return Y.mouseButton(e)===this._eventButton}}class ll{constructor(){this._firstTouch=void 0}_isOneFingerTouch(e){return e.targetTouches.length===1}_isSameTouchEvent(e){return e.targetTouches[0].identifier===this._firstTouch}startMove(e){this._firstTouch=e.targetTouches[0].identifier}endMove(e){delete this._firstTouch}isValidStartEvent(e){return this._isOneFingerTouch(e)}isValidMoveEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}isValidEndEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}}class Sc{constructor(e=new wa({checkCorrectEvent:()=>!0}),i=new ll){this.mouseMoveStateManager=e,this.oneFingerTouchMoveStateManager=i}_executeRelevantHandler(e,i,s){return e instanceof MouseEvent?i(e):typeof TouchEvent<"u"&&e instanceof TouchEvent?s(e):void 0}startMove(e){this._executeRelevantHandler(e,i=>this.mouseMoveStateManager.startMove(i),i=>this.oneFingerTouchMoveStateManager.startMove(i))}endMove(e){this._executeRelevantHandler(e,i=>this.mouseMoveStateManager.endMove(i),i=>this.oneFingerTouchMoveStateManager.endMove(i))}isValidStartEvent(e){return this._executeRelevantHandler(e,i=>this.mouseMoveStateManager.isValidStartEvent(i),i=>this.oneFingerTouchMoveStateManager.isValidStartEvent(i))}isValidMoveEvent(e){return this._executeRelevantHandler(e,i=>this.mouseMoveStateManager.isValidMoveEvent(i),i=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(i))}isValidEndEvent(e){return this._executeRelevantHandler(e,i=>this.mouseMoveStateManager.isValidEndEvent(i),i=>this.oneFingerTouchMoveStateManager.isValidEndEvent(i))}}const En=h=>{h.mousedown=h.dragStart,h.mousemoveWindow=h.dragMove,h.mouseup=h.dragEnd,h.contextmenu=e=>{e.preventDefault()}};class Ha{constructor(e,i){this._clickTolerance=e.clickTolerance||1,this._map=i,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new c.P(0,0)}_shouldBePrevented(e){return e<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(e,i,s){return this._calculateTransform(e,i,s)}touchmove(e,i,s){if(this._active){if(!this._shouldBePrevented(s.length))return e.preventDefault(),this._calculateTransform(e,i,s);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",e)}}touchend(e,i,s){this._calculateTransform(e,i,s),this._active&&this._shouldBePrevented(s.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,i,s){s.length>0&&(this._active=!0);const o=ol(s,i),u=new c.P(0,0),f=new c.P(0,0);let g=0;for(const x in o){const T=o[x],M=this._touches[x];M&&(u._add(T),f._add(T.sub(M)),g++,o[x]=T)}if(this._touches=o,this._shouldBePrevented(g)||!f.mag())return;const y=f.div(g);return this._sum._add(y),this._sum.mag()<this._clickTolerance?void 0:{around:u.div(g),panDelta:y}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ns{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(e,i,s){this._firstTwoTouches||s.length<2||(this._firstTwoTouches=[s[0].identifier,s[1].identifier],this._start([i[0],i[1]]))}touchmove(e,i,s){if(!this._firstTwoTouches)return;e.preventDefault();const[o,u]=this._firstTwoTouches,f=At(s,i,o),g=At(s,i,u);if(!f||!g)return;const y=this._aroundCenter?null:f.add(g).div(2);return this._move([f,g],y,e)}touchend(e,i,s){if(!this._firstTwoTouches)return;const[o,u]=this._firstTwoTouches,f=At(s,i,o),g=At(s,i,u);f&&g||(this._active&&Y.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function At(h,e,i){for(let s=0;s<h.length;s++)if(h[s].identifier===i)return e[s]}function Zs(h,e){return Math.log(h/e)/Math.LN2}class Cc extends Ns{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,i){const s=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Zs(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Zs(this._distance,s),pinchAround:i}}}function Us(h,e){return 180*h.angleWith(e)/Math.PI}class Ic extends Ns{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,i,s){const o=this._vector;if(this._vector=e[0].sub(e[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Us(this._vector,o),pinchAround:i}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const i=25/(Math.PI*this._minDiameter)*360,s=Us(e,this._startVector);return Math.abs(s)<i}}function cl(h){return Math.abs(h.y)>Math.abs(h.x)}class hl extends Ns{constructor(e){super(),this._currentTouchCount=0,this._map=e}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(e,i,s){super.touchstart(e,i,s),this._currentTouchCount=s.length}_start(e){this._lastPoints=e,cl(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,i,s){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const o=e[0].sub(this._lastPoints[0]),u=e[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(o,u,s.timeStamp),this._valid?(this._lastPoints=e,this._active=!0,{pitchDelta:(o.y+u.y)/2*-.5}):void 0}gestureBeginsVertically(e,i,s){if(this._valid!==void 0)return this._valid;const o=e.mag()>=2,u=i.mag()>=2;if(!o&&!u)return;if(!o||!u)return this._firstMove===void 0&&(this._firstMove=s),s-this._firstMove<100&&void 0;const f=e.y>0==i.y>0;return cl(e)&&cl(i)&&f}}const ul={panStep:100,bearingStep:15,pitchStep:10};class dl{constructor(e){this._tr=new Ga(e);const i=ul;this._panStep=i.panStep,this._bearingStep=i.bearingStep,this._pitchStep=i.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let i=0,s=0,o=0,u=0,f=0;switch(e.keyCode){case 61:case 107:case 171:case 187:i=1;break;case 189:case 109:case 173:i=-1;break;case 37:e.shiftKey?s=-1:(e.preventDefault(),u=-1);break;case 39:e.shiftKey?s=1:(e.preventDefault(),u=1);break;case 38:e.shiftKey?o=1:(e.preventDefault(),f=-1);break;case 40:e.shiftKey?o=-1:(e.preventDefault(),f=1);break;default:return}return this._rotationDisabled&&(s=0,o=0),{cameraAnimation:g=>{const y=this._tr;g.easeTo({duration:300,easeId:"keyboardHandler",easing:Eh,zoom:i?Math.round(y.zoom)+i*(e.shiftKey?2:1):y.zoom,bearing:y.bearing+s*this._bearingStep,pitch:y.pitch+o*this._pitchStep,offset:[-u*this._panStep,-f*this._panStep],center:y.center},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Eh(h){return h*(2-h)}const pl=4.000244140625;class Ec{constructor(e,i){this._onTimeout=s=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(s)},this._map=e,this._tr=new Ga(e),this._triggerRenderFrame=i,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(e){return!!this._map.cooperativeGestures.isEnabled()&&!(e.ctrlKey||this._map.cooperativeGestures.isBypassed(e))}wheel(e){if(!this.isEnabled())return;if(this._shouldBePrevented(e))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",e);let i=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const s=Pe.now(),o=s-(this._lastWheelEventTime||0);this._lastWheelEventTime=s,i!==0&&i%pl==0?this._type="wheel":i!==0&&Math.abs(i)<4?this._type="trackpad":o>400?(this._type=null,this._lastValue=i,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(o*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),e.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=e,this._delta-=i,this._active||this._start(e)),e.preventDefault()}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const i=Y.mousePos(this._map.getCanvas(),e),s=this._tr;this._aroundPoint=this._aroundCenter?s.transform.locationToScreenPoint(c.Q.convert(s.center)):i,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const e=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const g=e.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=g),typeof this._targetZoom=="number"&&(this._targetZoom+=g)}if(this._delta!==0){const g=this._type==="wheel"&&Math.abs(this._delta)>pl?this._wheelZoomRate:this._defaultZoomRate;let y=2/(1+Math.exp(-Math.abs(this._delta*g)));this._delta<0&&y!==0&&(y=1/y);const x=typeof this._targetZoom!="number"?e.scale:c.aH(this._targetZoom);this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,c.aa(x*y))),this._type==="wheel"&&(this._startZoom=e.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const i=typeof this._targetZoom!="number"?e.zoom:this._targetZoom,s=this._startZoom,o=this._easing;let u,f=!1;if(this._type==="wheel"&&s&&o){const g=Pe.now()-this._lastWheelEventTime,y=Math.min((g+5)/200,1),x=o(y);u=c.B.number(s,i,x),y<1?this._frameId||(this._frameId=!0):f=!0}else u=i,f=!0;return this._active=!0,f&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=u,{noInertia:!0,needsRenderFrame:!f,zoomDelta:u-e.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let i=c.ca;if(this._prevEase){const s=this._prevEase,o=(Pe.now()-s.start)/s.duration,u=s.easing(o+.01)-s.easing(o),f=.27/Math.sqrt(u*u+1e-4)*.01,g=Math.sqrt(.0729-f*f);i=c.c8(f,g,.25,1)}return this._prevEase={start:Pe.now(),duration:e,easing:i},i}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Ac{constructor(e,i){this._clickZoom=e,this._tapZoom=i}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class An{constructor(e){this._tr=new Ga(e),this.reset()}reset(){this._active=!1}dblclick(e,i){return e.preventDefault(),{cameraAnimation:s=>{s.easeTo({duration:300,zoom:this._tr.zoom+(e.shiftKey?-1:1),around:this._tr.unproject(i)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class _i{constructor(){this._tap=new Vs({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(e,i,s){if(!this._swipePoint)if(this._tapTime){const o=i[0],u=e.timeStamp-this._tapTime<500,f=this._tapPoint.dist(o)<30;u&&f?s.length>0&&(this._swipePoint=o,this._swipeTouch=s[0].identifier):this.reset()}else this._tap.touchstart(e,i,s)}touchmove(e,i,s){if(this._tapTime){if(this._swipePoint){if(s[0].identifier!==this._swipeTouch)return;const o=i[0],u=o.y-this._swipePoint.y;return this._swipePoint=o,e.preventDefault(),this._active=!0,{zoomDelta:u/128}}}else this._tap.touchmove(e,i,s)}touchend(e,i,s){if(this._tapTime)this._swipePoint&&s.length===0&&this.reset();else{const o=this._tap.touchend(e,i,s);o&&(this._tapTime=e.timeStamp,this._tapPoint=o)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wa{constructor(e,i,s){this._el=e,this._mousePan=i,this._touchPan=s}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class $s{constructor(e,i,s,o){this._pitchWithRotate=e.pitchWithRotate,this._rollEnabled=e.rollEnabled,this._mouseRotate=i,this._mousePitch=s,this._mouseRoll=o}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class fl{constructor(e,i,s,o){this._el=e,this._touchZoom=i,this._touchRotate=s,this._tapDragZoom=o,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class ml{constructor(e,i){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=e,this._options=i,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const e=this._map.getCanvasContainer();e.classList.add("maplibregl-cooperative-gestures"),this._container=Y.create("div","maplibregl-cooperative-gesture-screen",e);let i=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(i=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const s=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),o=document.createElement("div");o.className="maplibregl-desktop-message",o.textContent=i,this._container.appendChild(o);const u=document.createElement("div");u.className="maplibregl-mobile-message",u.textContent=s,this._container.appendChild(u),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(Y.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(e){return e[this._bypassKey]}notifyGestureBlocked(e,i){this._enabled&&(this._map.fire(new c.l("cooperativegestureprevented",{gestureType:e,originalEvent:i})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Xa=h=>h.zoom||h.drag||h.roll||h.pitch||h.rotate;class Ah extends c.l{}function Ur(h){return h.panDelta&&h.panDelta.mag()||h.zoomDelta||h.bearingDelta||h.pitchDelta||h.rollDelta}class Gs{constructor(e,i){this.handleWindowEvent=o=>{this.handleEvent(o,`${o.type}Window`)},this.handleEvent=(o,u)=>{if(o.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const f=o.type==="renderFrame"?void 0:o,g={needsRenderFrame:!1},y={},x={},T=o.touches,M=T?this._getMapTouches(T):void 0,S=M?Y.touchPos(this._map.getCanvas(),M):Y.mousePos(this._map.getCanvas(),o);for(const{handlerName:V,handler:j,allowed:N}of this._handlers){if(!j.isEnabled())continue;let $;this._blockedByActive(x,N,V)?j.reset():j[u||o.type]&&($=j[u||o.type](o,S,M),this.mergeHandlerResult(g,y,$,V,f),$&&$.needsRenderFrame&&this._triggerRenderFrame()),($||j.isActive())&&(x[V]=j)}const z={};for(const V in this._previousActiveHandlers)x[V]||(z[V]=f);this._previousActiveHandlers=x,(Object.keys(z).length||Ur(g))&&(this._changes.push([g,y,z]),this._triggerRenderFrame()),(Object.keys(x).length||Ur(g))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:R}=g;R&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],R(this._map))},this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Pc(e),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(i);const s=this._el;this._listeners=[[s,"touchstart",{passive:!0}],[s,"touchmove",{passive:!1}],[s,"touchend",void 0],[s,"touchcancel",void 0],[s,"mousedown",void 0],[s,"mousemove",void 0],[s,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[s,"mouseover",void 0],[s,"mouseout",void 0],[s,"dblclick",void 0],[s,"click",void 0],[s,"keydown",{capture:!1}],[s,"keyup",void 0],[s,"wheel",{passive:!1}],[s,"contextmenu",void 0],[window,"blur",void 0]];for(const[o,u,f]of this._listeners)Y.addEventListener(o,u,o===document?this.handleWindowEvent:this.handleEvent,f)}destroy(){for(const[e,i,s]of this._listeners)Y.removeEventListener(e,i,e===document?this.handleWindowEvent:this.handleEvent,s)}_addDefaultHandlers(e){const i=this._map,s=i.getCanvasContainer();this._add("mapEvent",new on(i,e));const o=i.boxZoom=new Mc(i,e);this._add("boxZoom",o),e.interactive&&e.boxZoom&&o.enable();const u=i.cooperativeGestures=new ml(i,e.cooperativeGestures);this._add("cooperativeGestures",u),e.cooperativeGestures&&u.enable();const f=new qa(i),g=new An(i);i.doubleClickZoom=new Ac(g,f),this._add("tapZoom",f),this._add("clickZoom",g),e.interactive&&e.doubleClickZoom&&i.doubleClickZoom.enable();const y=new _i;this._add("tapDragZoom",y);const x=i.touchPitch=new hl(i);this._add("touchPitch",x),e.interactive&&e.touchPitch&&i.touchPitch.enable(e.touchPitch);const T=()=>i.project(i.getCenter()),M=function({enable:X,clickTolerance:J,aroundCenter:ie=!0,minPixelCenterThreshold:Q=100,rotateDegreesPerPixelMoved:de=.8},fe){const xe=new wa({checkCorrectEvent:we=>Y.mouseButton(we)===0&&we.ctrlKey||Y.mouseButton(we)===2&&!we.ctrlKey});return new Er({clickTolerance:J,move:(we,ve)=>{const Le=fe();if(ie&&Math.abs(Le.y-we.y)>Q)return{bearingDelta:c.c9(new c.P(we.x,ve.y),ve,Le)};let Re=(ve.x-we.x)*de;return ie&&ve.y<Le.y&&(Re=-Re),{bearingDelta:Re}},moveStateManager:xe,enable:X,assignEvents:En})}(e,T),S=function({enable:X,clickTolerance:J,pitchDegreesPerPixelMoved:ie=-.5}){const Q=new wa({checkCorrectEvent:de=>Y.mouseButton(de)===0&&de.ctrlKey||Y.mouseButton(de)===2});return new Er({clickTolerance:J,move:(de,fe)=>({pitchDelta:(fe.y-de.y)*ie}),moveStateManager:Q,enable:X,assignEvents:En})}(e),z=function({enable:X,clickTolerance:J,rollDegreesPerPixelMoved:ie=.3},Q){const de=new wa({checkCorrectEvent:fe=>Y.mouseButton(fe)===2&&fe.ctrlKey});return new Er({clickTolerance:J,move:(fe,xe)=>{const we=Q();let ve=(xe.x-fe.x)*ie;return xe.y<we.y&&(ve=-ve),{rollDelta:ve}},moveStateManager:de,enable:X,assignEvents:En})}(e,T);i.dragRotate=new $s(e,M,S,z),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",S,["mouseRotate","mouseRoll"]),this._add("mouseRoll",z,["mousePitch"]),e.interactive&&e.dragRotate&&i.dragRotate.enable();const R=function({enable:X,clickTolerance:J}){const ie=new wa({checkCorrectEvent:Q=>Y.mouseButton(Q)===0&&!Q.ctrlKey});return new Er({clickTolerance:J,move:(Q,de)=>({around:de,panDelta:de.sub(Q)}),activateOnStart:!0,moveStateManager:ie,enable:X,assignEvents:En})}(e),V=new Ha(e,i);i.dragPan=new Wa(s,R,V),this._add("mousePan",R),this._add("touchPan",V,["touchZoom","touchRotate"]),e.interactive&&e.dragPan&&i.dragPan.enable(e.dragPan);const j=new Ic,N=new Cc;i.touchZoomRotate=new fl(s,N,j,y),this._add("touchRotate",j,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),e.interactive&&e.touchZoomRotate&&i.touchZoomRotate.enable(e.touchZoomRotate);const $=i.scrollZoom=new Ec(i,()=>this._triggerRenderFrame());this._add("scrollZoom",$,["mousePan"]),e.interactive&&e.scrollZoom&&i.scrollZoom.enable(e.scrollZoom);const W=i.keyboard=new dl(i);this._add("keyboard",W),e.interactive&&e.keyboard&&i.keyboard.enable(),this._add("blockableMapEvent",new ba(i))}_add(e,i,s){this._handlers.push({handlerName:e,handler:i,allowed:s}),this._handlersById[e]=i}stop(e){if(!this._updatingCamera){for(const{handler:i}of this._handlers)i.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[]}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xa(this._eventsInProgress)||this.isZooming()}_blockedByActive(e,i,s){for(const o in e)if(o!==s&&(!i||i.indexOf(o)<0))return!0;return!1}_getMapTouches(e){const i=[];for(const s of e)this._el.contains(s.target)&&i.push(s);return i}mergeHandlerResult(e,i,s,o,u){if(!s)return;c.e(e,s);const f={handlerName:o,originalEvent:s.originalEvent||u};s.zoomDelta!==void 0&&(i.zoom=f),s.panDelta!==void 0&&(i.drag=f),s.rollDelta!==void 0&&(i.roll=f),s.pitchDelta!==void 0&&(i.pitch=f),s.bearingDelta!==void 0&&(i.rotate=f)}_applyChanges(){const e={},i={},s={};for(const[o,u,f]of this._changes)o.panDelta&&(e.panDelta=(e.panDelta||new c.P(0,0))._add(o.panDelta)),o.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+o.zoomDelta),o.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+o.bearingDelta),o.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+o.pitchDelta),o.rollDelta&&(e.rollDelta=(e.rollDelta||0)+o.rollDelta),o.around!==void 0&&(e.around=o.around),o.pinchAround!==void 0&&(e.pinchAround=o.pinchAround),o.noInertia&&(e.noInertia=o.noInertia),c.e(i,u),c.e(s,f);this._updateMapTransform(e,i,s),this._changes=[]}_updateMapTransform(e,i,s){const o=this._map,u=o._getTransformForUpdate(),f=o.terrain;if(!(Ur(e)||f&&this._terrainMovement))return this._fireEvents(i,s,!0);o._stop(!0);let{panDelta:g,zoomDelta:y,bearingDelta:x,pitchDelta:T,rollDelta:M,around:S,pinchAround:z}=e;z!==void 0&&(S=z),S=S||o.transform.centerPoint,f&&!u.isPointOnMapSurface(S)&&(S=u.centerPoint);const R={panDelta:g,zoomDelta:y,rollDelta:M,pitchDelta:T,bearingDelta:x,around:S};this._map.cameraHelper.useGlobeControls&&!u.isPointOnMapSurface(S)&&(S=u.centerPoint);const V=S.distSqr(u.centerPoint)<.01?u.center:u.screenPointToLocation(g?S.sub(g):S);f?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(R,u),this._terrainMovement||!i.drag&&!i.zoom?i.drag&&this._terrainMovement?u.setCenter(u.screenPointToLocation(u.centerPoint.sub(g))):this._map.cameraHelper.handleMapControlsPan(R,u,V):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(R,u,V))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(R,u),this._map.cameraHelper.handleMapControlsPan(R,u,V)),o._applyUpdatedTransform(u),this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(i,s,!0)}_fireEvents(e,i,s){const o=Xa(this._eventsInProgress),u=Xa(e),f={};for(const M in e){const{originalEvent:S}=e[M];this._eventsInProgress[M]||(f[`${M}start`]=S),this._eventsInProgress[M]=e[M]}!o&&u&&this._fireEvent("movestart",u.originalEvent);for(const M in f)this._fireEvent(M,f[M]);u&&this._fireEvent("move",u.originalEvent);for(const M in e){const{originalEvent:S}=e[M];this._fireEvent(M,S)}const g={};let y;for(const M in this._eventsInProgress){const{handlerName:S,originalEvent:z}=this._eventsInProgress[M];this._handlersById[S].isActive()||(delete this._eventsInProgress[M],y=i[S]||z,g[`${M}end`]=y)}for(const M in g)this._fireEvent(M,g[M]);const x=Xa(this._eventsInProgress),T=(o||u)&&!x;if(T&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const M=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&M.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(M)}if(s&&T){this._updatingCamera=!0;const M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),S=z=>z!==0&&-this._bearingSnap<z&&z<this._bearingSnap;!M||!M.essential&&Pe.prefersReducedMotion?(this._map.fire(new c.l("moveend",{originalEvent:y})),S(this._map.getBearing())&&this._map.resetNorth()):(S(M.bearing||this._map.getBearing())&&(M.bearing=0),M.freezeElevation=!0,this._map.easeTo(M,{originalEvent:y})),this._updatingCamera=!1}}_fireEvent(e,i){this._map.fire(new c.l(e,i?{originalEvent:i}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{delete this._frameId,this.handleEvent(new Ah("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class at extends c.E{constructor(e,i,s){super(),this._renderFrameCallback=()=>{const o=Math.min((Pe.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(o)),o<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=s.bearingSnap,this.cameraHelper=i,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(e,i){e.apply(this.transform),this.transform=e,this.cameraHelper=i}getCenter(){return new c.Q(this.transform.center.lng,this.transform.center.lat)}setCenter(e,i){return this.jumpTo({center:e},i)}getCenterElevation(){return this.transform.elevation}setCenterElevation(e,i){return this.jumpTo({elevation:e},i),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(e){this._centerClampedToGround=e}panBy(e,i,s){return e=c.P.convert(e).mult(-1),this.panTo(this.transform.center,c.e({offset:e},i),s)}panTo(e,i,s){return this.easeTo(c.e({center:e},i),s)}getZoom(){return this.transform.zoom}setZoom(e,i){return this.jumpTo({zoom:e},i),this}zoomTo(e,i,s){return this.easeTo(c.e({zoom:e},i),s)}zoomIn(e,i){return this.zoomTo(this.getZoom()+1,e,i),this}zoomOut(e,i){return this.zoomTo(this.getZoom()-1,e,i),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(e,i){return e!=this.transform.fov&&(this.transform.setFov(e),this.fire(new c.l("movestart",i)).fire(new c.l("move",i)).fire(new c.l("moveend",i))),this}getBearing(){return this.transform.bearing}setBearing(e,i){return this.jumpTo({bearing:e},i),this}getPadding(){return this.transform.padding}setPadding(e,i){return this.jumpTo({padding:e},i),this}rotateTo(e,i,s){return this.easeTo(c.e({bearing:e},i),s)}resetNorth(e,i){return this.rotateTo(0,c.e({duration:1e3},e),i),this}resetNorthPitch(e,i){return this.easeTo(c.e({bearing:0,pitch:0,roll:0,duration:1e3},e),i),this}snapToNorth(e,i){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,i):this}getPitch(){return this.transform.pitch}setPitch(e,i){return this.jumpTo({pitch:e},i),this}getRoll(){return this.transform.roll}setRoll(e,i){return this.jumpTo({roll:e},i),this}cameraForBounds(e,i){e=ci.convert(e).adjustAntiMeridian();const s=i&&i.bearing||0;return this._cameraForBoxAndBearing(e.getNorthWest(),e.getSouthEast(),s,i)}_cameraForBoxAndBearing(e,i,s,o){const u={top:0,bottom:0,right:0,left:0};if(typeof(o=c.e({padding:u,offset:[0,0],maxZoom:this.transform.maxZoom},o)).padding=="number"){const x=o.padding;o.padding={top:x,bottom:x,right:x,left:x}}const f=c.e(u,o.padding);o.padding=f;const g=this.transform,y=new ci(e,i);return this.cameraHelper.cameraForBoxAndBearing(o,f,y,s,g)}fitBounds(e,i,s){return this._fitInternal(this.cameraForBounds(e,i),i,s)}fitScreenCoordinates(e,i,s,o,u){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(c.P.convert(e)),this.transform.screenPointToLocation(c.P.convert(i)),s,o),o,u)}_fitInternal(e,i,s){return e?(delete(i=c.e(e,i)).padding,i.linear?this.easeTo(i,s):this.flyTo(i,s)):this}jumpTo(e,i){this.stop();const s=this._getTransformForUpdate();let o=!1,u=!1,f=!1;const g=s.zoom;this.cameraHelper.handleJumpToCenterZoom(s,e);const y=s.zoom!==g;return"elevation"in e&&s.elevation!==+e.elevation&&s.setElevation(+e.elevation),"bearing"in e&&s.bearing!==+e.bearing&&(o=!0,s.setBearing(+e.bearing)),"pitch"in e&&s.pitch!==+e.pitch&&(u=!0,s.setPitch(+e.pitch)),"roll"in e&&s.roll!==+e.roll&&(f=!0,s.setRoll(+e.roll)),e.padding==null||s.isPaddingEqual(e.padding)||s.setPadding(e.padding),this._applyUpdatedTransform(s),this.fire(new c.l("movestart",i)).fire(new c.l("move",i)),y&&this.fire(new c.l("zoomstart",i)).fire(new c.l("zoom",i)).fire(new c.l("zoomend",i)),o&&this.fire(new c.l("rotatestart",i)).fire(new c.l("rotate",i)).fire(new c.l("rotateend",i)),u&&this.fire(new c.l("pitchstart",i)).fire(new c.l("pitch",i)).fire(new c.l("pitchend",i)),f&&this.fire(new c.l("rollstart",i)).fire(new c.l("roll",i)).fire(new c.l("rollend",i)),this.fire(new c.l("moveend",i))}calculateCameraOptionsFromTo(e,i,s,o=0){const u=c.$.fromLngLat(e,i),f=c.$.fromLngLat(s,o),g=f.x-u.x,y=f.y-u.y,x=f.z-u.z,T=Math.hypot(g,y,x);if(T===0)throw new Error("Can't calculate camera options with same From and To");const M=Math.hypot(g,y),S=c.aa(this.transform.cameraToCenterDistance/T/this.transform.tileSize),z=180*Math.atan2(g,-y)/Math.PI;let R=180*Math.acos(M/T)/Math.PI;return R=x<0?90-R:90+R,{center:f.toLngLat(),elevation:o,zoom:S,pitch:R,bearing:z}}calculateCameraOptionsFromCameraLngLatAltRotation(e,i,s,o,u){const f=this.transform.calculateCenterFromCameraLngLatAlt(e,i,s,o);return{center:f.center,elevation:f.elevation,zoom:f.zoom,bearing:s,pitch:o,roll:u}}easeTo(e,i){this._stop(!1,e.easeId),((e=c.e({offset:[0,0],duration:500,easing:c.ca},e)).animate===!1||!e.essential&&Pe.prefersReducedMotion)&&(e.duration=0);const s=this._getTransformForUpdate(),o=this.getBearing(),u=s.pitch,f=s.roll,g="bearing"in e?this._normalizeBearing(e.bearing,o):o,y="pitch"in e?+e.pitch:u,x="roll"in e?this._normalizeBearing(e.roll,f):f,T="padding"in e?e.padding:s.padding,M=c.P.convert(e.offset);let S,z;e.around&&(S=c.Q.convert(e.around),z=s.locationToScreenPoint(S));const R={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},V=this.cameraHelper.handleEaseTo(s,{bearing:g,pitch:y,roll:x,padding:T,around:S,aroundPoint:z,offsetAsPoint:M,offset:e.offset,zoom:e.zoom,center:e.center});return this._rotating=this._rotating||o!==g,this._pitching=this._pitching||y!==u,this._rolling=this._rolling||x!==f,this._padding=!s.isPaddingEqual(T),this._zooming=this._zooming||V.isZooming,this._easeId=e.easeId,this._prepareEase(i,e.noMoveStart,R),this.terrain&&this._prepareElevation(V.elevationCenter),this._ease(j=>{V.easeFunc(j),this.terrain&&!e.freezeElevation&&this._updateElevation(j),this._applyUpdatedTransform(s),this._fireMoveEvents(i)},j=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(i,j)},e),this}_prepareEase(e,i,s={}){this._moving=!0,i||s.moving||this.fire(new c.l("movestart",e)),this._zooming&&!s.zooming&&this.fire(new c.l("zoomstart",e)),this._rotating&&!s.rotating&&this.fire(new c.l("rotatestart",e)),this._pitching&&!s.pitching&&this.fire(new c.l("pitchstart",e)),this._rolling&&!s.rolling&&this.fire(new c.l("rollstart",e))}_prepareElevation(e){this._elevationCenter=e,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(e,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(e){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const i=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(e<1&&i!==this._elevationTarget){const s=this._elevationTarget-this._elevationStart;this._elevationStart+=e*(s-(i-(s*e+this._elevationStart))/(1-e)),this._elevationTarget=i}this.transform.setElevation(c.B.number(this._elevationStart,this._elevationTarget,e))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(e){if(!this.terrain&&e.elevation>=0&&e.pitch<=90)return{};const i=e.getCameraLngLat(),s=e.getCameraAltitude(),o=this.terrain?this.terrain.getElevationForLngLatZoom(i,e.zoom):0;if(s<o){const u=this.calculateCameraOptionsFromTo(i,o,e.center,e.elevation);return{pitch:u.pitch,zoom:u.zoom}}return{}}_applyUpdatedTransform(e){const i=[];if(i.push(o=>this._elevateCameraIfInsideTerrain(o)),this.transformCameraUpdate&&i.push(o=>this.transformCameraUpdate(o)),!i.length)return;const s=e.clone();for(const o of i){const u=s.clone(),{center:f,zoom:g,roll:y,pitch:x,bearing:T,elevation:M}=o(u);f&&u.setCenter(f),M!==void 0&&u.setElevation(M),g!==void 0&&u.setZoom(g),y!==void 0&&u.setRoll(y),x!==void 0&&u.setPitch(x),T!==void 0&&u.setBearing(T),s.apply(u)}this.transform.apply(s)}_fireMoveEvents(e){this.fire(new c.l("move",e)),this._zooming&&this.fire(new c.l("zoom",e)),this._rotating&&this.fire(new c.l("rotate",e)),this._pitching&&this.fire(new c.l("pitch",e)),this._rolling&&this.fire(new c.l("roll",e))}_afterEase(e,i){if(this._easeId&&i&&this._easeId===i)return;delete this._easeId;const s=this._zooming,o=this._rotating,u=this._pitching,f=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,s&&this.fire(new c.l("zoomend",e)),o&&this.fire(new c.l("rotateend",e)),u&&this.fire(new c.l("pitchend",e)),f&&this.fire(new c.l("rollend",e)),this.fire(new c.l("moveend",e))}flyTo(e,i){if(!e.essential&&Pe.prefersReducedMotion){const ve=c.O(e,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo(ve,i)}this.stop(),e=c.e({offset:[0,0],speed:1.2,curve:1.42,easing:c.ca},e);const s=this._getTransformForUpdate(),o=s.bearing,u=s.pitch,f=s.roll,g=s.padding,y="bearing"in e?this._normalizeBearing(e.bearing,o):o,x="pitch"in e?+e.pitch:u,T="roll"in e?this._normalizeBearing(e.roll,f):f,M="padding"in e?e.padding:s.padding,S=c.P.convert(e.offset);let z=s.centerPoint.add(S);const R=s.screenPointToLocation(z),V=this.cameraHelper.handleFlyTo(s,{bearing:y,pitch:x,roll:T,padding:M,locationAtOffset:R,offsetAsPoint:S,center:e.center,minZoom:e.minZoom,zoom:e.zoom});let j=e.curve;const N=Math.max(s.width,s.height),$=N/V.scaleOfZoom,W=V.pixelPathLength;typeof V.scaleOfMinZoom=="number"&&(j=Math.sqrt(N/V.scaleOfMinZoom/W*2));const X=j*j;function J(ve){const Le=($*$-N*N+(ve?-1:1)*X*X*W*W)/(2*(ve?$:N)*X*W);return Math.log(Math.sqrt(Le*Le+1)-Le)}function ie(ve){return(Math.exp(ve)-Math.exp(-ve))/2}function Q(ve){return(Math.exp(ve)+Math.exp(-ve))/2}const de=J(!1);let fe=function(ve){return Q(de)/Q(de+j*ve)},xe=function(ve){return N*((Q(de)*(ie(Le=de+j*ve)/Q(Le))-ie(de))/X)/W;var Le},we=(J(!0)-de)/j;if(Math.abs(W)<2e-6||!isFinite(we)){if(Math.abs(N-$)<1e-6)return this.easeTo(e,i);const ve=$<N?-1:1;we=Math.abs(Math.log($/N))/j,xe=()=>0,fe=Le=>Math.exp(ve*j*Le)}return e.duration="duration"in e?+e.duration:1e3*we/("screenSpeed"in e?+e.screenSpeed/j:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0),this._zooming=!0,this._rotating=o!==y,this._pitching=x!==u,this._rolling=T!==f,this._padding=!s.isPaddingEqual(M),this._prepareEase(i,!1),this.terrain&&this._prepareElevation(V.targetCenter),this._ease(ve=>{const Le=ve*we,Re=1/fe(Le),Ce=xe(Le);this._rotating&&s.setBearing(c.B.number(o,y,ve)),this._pitching&&s.setPitch(c.B.number(u,x,ve)),this._rolling&&s.setRoll(c.B.number(f,T,ve)),this._padding&&(s.interpolatePadding(g,M,ve),z=s.centerPoint.add(S)),V.easeFunc(ve,Re,Ce,z),this.terrain&&!e.freezeElevation&&this._updateElevation(ve),this._applyUpdatedTransform(s),this._fireMoveEvents(i)},()=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(i)},e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(e,i){var s;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const o=this._onEaseEnd;delete this._onEaseEnd,o.call(this,i)}return e||(s=this.handlers)===null||s===void 0||s.stop(!1),this}_ease(e,i,s){s.animate===!1||s.duration===0?(e(1),i()):(this._easeStart=Pe.now(),this._easeOptions=s,this._onEaseFrame=e,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(e,i){e=c.aK(e,-180,180);const s=Math.abs(e-i);return Math.abs(e-360-i)<s&&(e-=360),Math.abs(e+360-i)<s&&(e+=360),e}queryTerrainElevation(e){return this.terrain?this.terrain.getElevationForLngLatZoom(c.Q.convert(e),this.transform.tileZoom):null}}const mt={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class Ka{constructor(e=mt){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=i=>{!i||i.sourceDataType!=="metadata"&&i.sourceDataType!=="visibility"&&i.dataType!=="style"&&i.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=e}getDefaultPosition(){return"bottom-right"}onAdd(e){return this._map=e,this._compact=this.options.compact,this._container=Y.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=Y.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=Y.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){Y.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._sanitizedAttributionHTML=void 0}_setElementTitle(e,i){const s=this._map._getUIString(`AttributionControl.${i}`);e.title=s,e.setAttribute("aria-label",s)}_updateAttributions(){if(!this._map.style)return;let e=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=e.concat(this.options.customAttribution.map(o=>typeof o!="string"?"":o)):typeof this.options.customAttribution=="string"&&e.push(this.options.customAttribution)),this._map.style.stylesheet){const o=this._map.style.stylesheet;this.styleOwner=o.owner,this.styleId=o.id}const i=this._map.style.sourceCaches;for(const o in i){const u=i[o];if(u.used||u.usedForTerrain){const f=u.getSource();f.attribution&&e.indexOf(f.attribution)<0&&e.push(f.attribution)}}e=e.filter(o=>String(o).trim()),e.sort((o,u)=>o.length-u.length),e=e.filter((o,u)=>{for(let f=u+1;f<e.length;f++)if(e[f].indexOf(o)>=0)return!1;return!0});const s=e.join(" | ");s!==this._sanitizedAttributionHTML&&(this._sanitizedAttributionHTML=Y.sanitize(s),e.length?(this._innerContainer.innerHTML=this._sanitizedAttributionHTML,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class qs{constructor(e={}){this._updateCompact=()=>{const i=this._container.children;if(i.length){const s=i[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&s.classList.add("maplibregl-compact"):s.classList.remove("maplibregl-compact")}},this.options=e}getDefaultPosition(){return"bottom-left"}onAdd(e){this._map=e,this._compact=this.options&&this.options.compact,this._container=Y.create("div","maplibregl-ctrl");const i=Y.create("a","maplibregl-ctrl-logo");return i.target="_blank",i.rel="noopener nofollow",i.href="https://maplibre.org/",i.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),i.setAttribute("rel","noopener nofollow"),this._container.appendChild(i),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){Y.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class gl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const i=++this._id;return this._queue.push({callback:e,id:i,cancelled:!1}),i}remove(e){const i=this._currentlyRunning,s=i?this._queue.concat(i):this._queue;for(const o of s)if(o.id===e)return void(o.cancelled=!0)}run(e=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const i=this._currentlyRunning=this._queue;this._queue=[];for(const s of i)if(!s.cancelled&&(s.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var wr=c.aC([{name:"a_pos3d",type:"Int16",components:3}]);class kc extends c.E{constructor(e){super(),this._lastTilesetChange=Pe.now(),this.sourceCache=e,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=e._source.tileSize*2**this.deltaZoom,e.usedForTerrain=!0,e.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(e,i){this.sourceCache.update(e,i),this._renderableTilesKeys=[];const s={};for(const o of se(e,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:i,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))s[o.key]=!0,this._renderableTilesKeys.push(o.key),this._tiles[o.key]||(o.terrainRttPosMatrix32f=new Float64Array(16),c.bN(o.terrainRttPosMatrix32f,0,c.Z,c.Z,0,0,1),this._tiles[o.key]=new Ii(o,this.tileSize),this._lastTilesetChange=Pe.now());for(const o in this._tiles)s[o]||delete this._tiles[o]}freeRtt(e){for(const i in this._tiles){const s=this._tiles[i];(!e||s.tileID.equals(e)||s.tileID.isChildOf(e)||e.isChildOf(s.tileID))&&(s.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(e=>this.getTileByID(e))}getTileByID(e){return this._tiles[e]}getTerrainCoords(e){const i={};for(const s of this._renderableTilesKeys){const o=this._tiles[s].tileID,u=e.clone(),f=c.b1();if(o.canonical.equals(e.canonical))c.bN(f,0,c.Z,c.Z,0,0,1);else if(o.canonical.isChildOf(e.canonical)){const g=o.canonical.z-e.canonical.z,y=o.canonical.x-(o.canonical.x>>g<<g),x=o.canonical.y-(o.canonical.y>>g<<g),T=c.Z>>g;c.bN(f,0,T,T,0,0,1),c.L(f,f,[-y*T,-x*T,0])}else{if(!e.canonical.isChildOf(o.canonical))continue;{const g=e.canonical.z-o.canonical.z,y=e.canonical.x-(e.canonical.x>>g<<g),x=e.canonical.y-(e.canonical.y>>g<<g),T=c.Z>>g;c.bN(f,0,c.Z,c.Z,0,0,1),c.L(f,f,[y*T,x*T,0]),c.M(f,f,[1/2**g,1/2**g,0])}}u.terrainRttPosMatrix32f=new Float32Array(f),i[s]=u}return i}getSourceTile(e,i){const s=this.sourceCache._source;let o=e.overscaledZ-this.deltaZoom;if(o>s.maxzoom&&(o=s.maxzoom),o<s.minzoom)return null;this._sourceTileCache[e.key]||(this._sourceTileCache[e.key]=e.scaledTo(o).key);let u=this.sourceCache.getTileByID(this._sourceTileCache[e.key]);if((!u||!u.dem)&&i)for(;o>=s.minzoom&&(!u||!u.dem);)u=this.sourceCache.getTileByID(e.scaledTo(o--).key);return u}anyTilesAfterTime(e=Date.now()){return this._lastTilesetChange>=e}}class ln{constructor(e,i,s){this._meshCache={},this.painter=e,this.sourceCache=new kc(i),this.options=s,this.exaggeration=typeof s.exaggeration=="number"?s.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(e,i,s,o=c.Z){var u;if(!(i>=0&&i<o&&s>=0&&s<o))return 0;const f=this.getTerrainData(e),g=(u=f.tile)===null||u===void 0?void 0:u.dem;if(!g)return 0;const y=c.cb([],[i/o*c.Z,s/o*c.Z],f.u_terrain_matrix),x=[y[0]*g.dim,y[1]*g.dim],T=Math.floor(x[0]),M=Math.floor(x[1]),S=x[0]-T,z=x[1]-M;return g.get(T,M)*(1-S)*(1-z)+g.get(T+1,M)*S*(1-z)+g.get(T,M+1)*(1-S)*z+g.get(T+1,M+1)*S*z}getElevationForLngLatZoom(e,i){if(!c.cc(i,e.wrap()))return 0;const{tileID:s,mercatorX:o,mercatorY:u}=this._getOverscaledTileIDFromLngLatZoom(e,i);return this.getElevation(s,o%c.Z,u%c.Z,c.Z)}getElevation(e,i,s,o=c.Z){return this.getDEMElevation(e,i,s,o)*this.exaggeration}getTerrainData(e){if(!this._emptyDemTexture){const o=this.painter.context,u=new c.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new xt(o,u,o.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new xt(o,new c.R({width:1,height:1}),o.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(o.gl.NEAREST,o.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=c.as([])}const i=this.sourceCache.getSourceTile(e,!0);if(i&&i.dem&&(!i.demTexture||i.needsTerrainPrepare)){const o=this.painter.context;i.demTexture=this.painter.getTileTexture(i.dem.stride),i.demTexture?i.demTexture.update(i.dem.getPixels(),{premultiply:!1}):i.demTexture=new xt(o,i.dem.getPixels(),o.gl.RGBA,{premultiply:!1}),i.demTexture.bind(o.gl.NEAREST,o.gl.CLAMP_TO_EDGE),i.needsTerrainPrepare=!1}const s=i&&i+i.tileID.key+e.key;if(s&&!this._demMatrixCache[s]){const o=this.sourceCache.sourceCache._source.maxzoom;let u=e.canonical.z-i.tileID.canonical.z;e.overscaledZ>e.canonical.z&&(e.canonical.z>=o?u=e.canonical.z-o:c.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const f=e.canonical.x-(e.canonical.x>>u<<u),g=e.canonical.y-(e.canonical.y>>u<<u),y=c.cd(new Float64Array(16),[1/(c.Z<<u),1/(c.Z<<u),0]);c.L(y,y,[f*c.Z,g*c.Z,0]),this._demMatrixCache[e.key]={matrix:y,coord:e}}return{u_depth:2,u_terrain:3,u_terrain_dim:i&&i.dem&&i.dem.dim||1,u_terrain_matrix:s?this._demMatrixCache[e.key].matrix:this._emptyDemMatrix,u_terrain_unpack:i&&i.dem&&i.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(i&&i.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:i}}getFramebuffer(e){const i=this.painter,s=i.width/devicePixelRatio,o=i.height/devicePixelRatio;return!this._fbo||this._fbo.width===s&&this._fbo.height===o||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new xt(i.context,{width:s,height:o,data:null},i.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(i.context.gl.NEAREST,i.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new xt(i.context,{width:s,height:o,data:null},i.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(i.context.gl.NEAREST,i.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=i.context.createFramebuffer(s,o,!0,!1),this._fbo.depthAttachment.set(i.context.createRenderbuffer(i.context.gl.DEPTH_COMPONENT16,s,o))),this._fbo.colorAttachment.set(e==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const e=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const i=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let u=0,f=0;u<this._coordsTextureSize;u++)for(let g=0;g<this._coordsTextureSize;g++,f+=4)i[f+0]=255&g,i[f+1]=255&u,i[f+2]=g>>8<<4|u>>8,i[f+3]=0;const s=new c.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(i.buffer)),o=new xt(e,s,e.gl.RGBA,{premultiply:!1});return o.bind(e.gl.NEAREST,e.gl.CLAMP_TO_EDGE),this._coordsTexture=o,o}pointCoordinate(e){this.painter.maybeDrawDepthAndCoords(!0);const i=new Uint8Array(4),s=this.painter.context,o=s.gl,u=Math.round(e.x*this.painter.pixelRatio/devicePixelRatio),f=Math.round(e.y*this.painter.pixelRatio/devicePixelRatio),g=Math.round(this.painter.height/devicePixelRatio);s.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),o.readPixels(u,g-f-1,1,1,o.RGBA,o.UNSIGNED_BYTE,i),s.bindFramebuffer.set(null);const y=i[0]+(i[2]>>4<<8),x=i[1]+((15&i[2])<<8),T=this.coordsIndex[255-i[3]],M=T&&this.sourceCache.getTileByID(T);if(!M)return null;const S=this._coordsTextureSize,z=(1<<M.tileID.canonical.z)*S;return new c.$((M.tileID.canonical.x*S+y)/z+M.tileID.wrap,(M.tileID.canonical.y*S+x)/z,this.getElevation(M.tileID,y,x,S))}depthAtPoint(e){const i=new Uint8Array(4),s=this.painter.context,o=s.gl;return s.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),o.readPixels(e.x,this.painter.height/devicePixelRatio-e.y-1,1,1,o.RGBA,o.UNSIGNED_BYTE,i),s.bindFramebuffer.set(null),(i[0]/16777216+i[1]/65536+i[2]/256+i[3])/256}getTerrainMesh(e){var i;const s=((i=this.painter.style.projection)===null||i===void 0?void 0:i.transitionState)>0,o=s&&e.canonical.y===0,u=s&&e.canonical.y===(1<<e.canonical.z)-1,f=`m_${o?"n":""}_${u?"s":""}`;if(this._meshCache[f])return this._meshCache[f];const g=this.painter.context,y=new c.ce,x=new c.aG,T=this.meshSize,M=c.Z/T,S=T*T;for(let Q=0;Q<=T;Q++)for(let de=0;de<=T;de++)y.emplaceBack(de*M,Q*M,0);for(let Q=0;Q<S;Q+=T+1)for(let de=0;de<T;de++)x.emplaceBack(de+Q,T+de+Q+1,T+de+Q+2),x.emplaceBack(de+Q,T+de+Q+2,de+Q+1);const z=y.length,R=z+(T+1),V=(T+1)*T,j=o?c.b8:0,N=o?0:1,$=u?c.b9:c.Z,W=u?0:1;for(let Q=0;Q<=T;Q++)y.emplaceBack(Q*M,j,N);for(let Q=0;Q<=T;Q++)y.emplaceBack(Q*M,$,W);for(let Q=0;Q<T;Q++)x.emplaceBack(V+Q,R+Q,R+Q+1),x.emplaceBack(V+Q,R+Q+1,V+Q+1),x.emplaceBack(0+Q,z+Q+1,z+Q),x.emplaceBack(0+Q,0+Q+1,z+Q+1);const X=y.length,J=X+2*(T+1);for(const Q of[0,1])for(let de=0;de<=T;de++)for(const fe of[0,1])y.emplaceBack(Q*c.Z,de*M,fe);for(let Q=0;Q<2*T;Q+=2)x.emplaceBack(X+Q,X+Q+1,X+Q+3),x.emplaceBack(X+Q,X+Q+3,X+Q+2),x.emplaceBack(J+Q,J+Q+3,J+Q+1),x.emplaceBack(J+Q,J+Q+2,J+Q+3);const ie=new Cr(g.createVertexBuffer(y,wr.members),g.createIndexBuffer(x),c.aF.simpleSegment(0,0,y.length,x.length));return this._meshCache[f]=ie,ie}getMeshFrameDelta(e){return 2*Math.PI*c.bq/Math.pow(2,Math.max(e,0))/5}getMinTileElevationForLngLatZoom(e,i){var s;const{tileID:o}=this._getOverscaledTileIDFromLngLatZoom(e,i);return(s=this.getMinMaxElevation(o).minElevation)!==null&&s!==void 0?s:0}getMinMaxElevation(e){const i=this.getTerrainData(e).tile,s={minElevation:null,maxElevation:null};return i&&i.dem&&(s.minElevation=i.dem.min*this.exaggeration,s.maxElevation=i.dem.max*this.exaggeration),s}_getOverscaledTileIDFromLngLatZoom(e,i){const s=c.$.fromLngLat(e.wrap()),o=(1<<i)*c.Z,u=s.x*o,f=s.y*o,g=Math.floor(u/c.Z),y=Math.floor(f/c.Z);return{tileID:new c.Y(i,0,i,g,y),mercatorX:u,mercatorY:f}}}class kh{constructor(e,i,s){this._context=e,this._size=i,this._tileSize=s,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const e of this._objects)e.texture.destroy(),e.fbo.destroy()}_createObject(e){const i=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),s=new xt(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return s.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),i.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),i.colorAttachment.set(s.texture),{id:e,fbo:i,texture:s,stamp:-1,inUse:!1}}getObjectForId(e){return this._objects[e]}useObject(e){e.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(i=>e.id!==i),this._recentlyUsed.push(e.id)}stampObject(e){e.stamp=++this._stamp}getOrCreateFreeObject(){for(const i of this._recentlyUsed)if(!this._objects[i].inUse)return this._objects[i];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const e=this._createObject(this._objects.length);return this._objects.push(e),e}freeObject(e){e.inUse=!1}freeAllObjects(){for(const e of this._objects)this.freeObject(e)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(e=>!e.inUse)===!1}}const cn={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class Si{constructor(e,i){this.painter=e,this.terrain=i,this.pool=new kh(e.context,30,i.sourceCache.tileSize*i.qualityFactor)}destruct(){this.pool.destruct()}getTexture(e){return this.pool.getObjectForId(e.rtt[this._stacks.length-1].id).texture}prepareForRender(e,i){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=e._order.filter(s=>!e._layers[s].isHidden(i)),this._coordsAscending={};for(const s in e.sourceCaches){this._coordsAscending[s]={};const o=e.sourceCaches[s].getVisibleCoordinates();for(const u of o){const f=this.terrain.sourceCache.getTerrainCoords(u);for(const g in f)this._coordsAscending[s][g]||(this._coordsAscending[s][g]=[]),this._coordsAscending[s][g].push(f[g])}}this._coordsAscendingStr={};for(const s of e._order){const o=e._layers[s],u=o.source;if(cn[o.type]&&!this._coordsAscendingStr[u]){this._coordsAscendingStr[u]={};for(const f in this._coordsAscending[u])this._coordsAscendingStr[u][f]=this._coordsAscending[u][f].map(g=>g.key).sort().join()}}for(const s of this._renderableTiles)for(const o in this._coordsAscendingStr){const u=this._coordsAscendingStr[o][s.tileID.key];u&&u!==s.rttCoords[o]&&(s.rtt=[])}}renderLayer(e,i){if(e.isHidden(this.painter.transform.zoom))return!1;const s=Object.assign(Object.assign({},i),{isRenderingToTexture:!0}),o=e.type,u=this.painter,f=this._renderableLayerIds[this._renderableLayerIds.length-1]===e.id;if(cn[o]&&(this._prevType&&cn[this._prevType]||this._stacks.push([]),this._prevType=o,this._stacks[this._stacks.length-1].push(e.id),!f))return!0;if(cn[this._prevType]||cn[o]&&f){this._prevType=o;const g=this._stacks.length-1,y=this._stacks[g]||[];for(const x of this._renderableTiles){if(this.pool.isFull()&&(rl(this.painter,this.terrain,this._rttTiles,s),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(x),x.rtt[g]){const M=this.pool.getObjectForId(x.rtt[g].id);if(M.stamp===x.rtt[g].stamp){this.pool.useObject(M);continue}}const T=this.pool.getOrCreateFreeObject();this.pool.useObject(T),this.pool.stampObject(T),x.rtt[g]={id:T.id,stamp:T.stamp},u.context.bindFramebuffer.set(T.fbo.framebuffer),u.context.clear({color:c.b6.transparent,stencil:0}),u.currentStencilSource=void 0;for(let M=0;M<y.length;M++){const S=u.style._layers[y[M]],z=S.source?this._coordsAscending[S.source][x.tileID.key]:[x.tileID];u.context.viewport.set([0,0,T.fbo.width,T.fbo.height]),u._renderTileClippingMasks(S,z,!0),u.renderLayer(u,u.style.sourceCaches[S.source],S,z,s),S.source&&(x.rttCoords[S.source]=this._coordsAscendingStr[S.source][x.tileID.key])}}return rl(this.painter,this.terrain,this._rttTiles,s),this._rttTiles=[],this.pool.freeAllObjects(),cn[o]}return!1}}const Di={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},zc=ke,Ta={hash:!1,interactive:!0,bearingSnap:7,attributionControl:mt,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:c.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},Hs={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class _l{constructor(e,i,s=!1){this.mousedown=u=>{this.startMove(u,Y.mousePos(this.element,u)),Y.addEventListener(window,"mousemove",this.mousemove),Y.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=u=>{this.move(u,Y.mousePos(this.element,u))},this.mouseup=u=>{this._rotatePitchHanlder.dragEnd(u),this.offTemp()},this.touchstart=u=>{u.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Y.touchPos(this.element,u.targetTouches)[0],this.startMove(u,this._startPos),Y.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),Y.addEventListener(window,"touchend",this.touchend))},this.touchmove=u=>{u.targetTouches.length!==1?this.reset():(this._lastPos=Y.touchPos(this.element,u.targetTouches)[0],this.move(u,this._lastPos))},this.touchend=u=>{u.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=i;const o=new Sc;this._rotatePitchHanlder=new Er({clickTolerance:3,move:(u,f)=>{const g=i.getBoundingClientRect(),y=new c.P((g.bottom-g.top)/2,(g.right-g.left)/2);return{bearingDelta:c.c9(new c.P(u.x,f.y),f,y),pitchDelta:s?-.5*(f.y-u.y):void 0}},moveStateManager:o,enable:!0,assignEvents:()=>{}}),this.map=e,Y.addEventListener(i,"mousedown",this.mousedown),Y.addEventListener(i,"touchstart",this.touchstart,{passive:!1}),Y.addEventListener(i,"touchcancel",this.reset)}startMove(e,i){this._rotatePitchHanlder.dragStart(e,i),Y.disableDrag()}move(e,i){const s=this.map,{bearingDelta:o,pitchDelta:u}=this._rotatePitchHanlder.dragMove(e,i)||{};o&&s.setBearing(s.getBearing()+o),u&&s.setPitch(s.getPitch()+u)}off(){const e=this.element;Y.removeEventListener(e,"mousedown",this.mousedown),Y.removeEventListener(e,"touchstart",this.touchstart,{passive:!1}),Y.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Y.removeEventListener(window,"touchend",this.touchend),Y.removeEventListener(e,"touchcancel",this.reset),this.offTemp()}offTemp(){Y.enableDrag(),Y.removeEventListener(window,"mousemove",this.mousemove),Y.removeEventListener(window,"mouseup",this.mouseup),Y.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Y.removeEventListener(window,"touchend",this.touchend)}}let _n;function Ws(h,e,i){const s=new c.Q(h.lng,h.lat);if(h=new c.Q(h.lng,h.lat),e){const o=new c.Q(h.lng-360,h.lat),u=new c.Q(h.lng+360,h.lat),f=i.locationToScreenPoint(h).distSqr(e);i.locationToScreenPoint(o).distSqr(e)<f?h=o:i.locationToScreenPoint(u).distSqr(e)<f&&(h=u)}for(;Math.abs(h.lng-i.center.lng)>180;){const o=i.locationToScreenPoint(h);if(o.x>=0&&o.y>=0&&o.x<=i.width&&o.y<=i.height)break;h.lng>i.center.lng?h.lng-=360:h.lng+=360}return h.lng!==s.lng&&i.isPointOnMapSurface(i.locationToScreenPoint(h))?h:s}const Wn={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Xs(h,e,i){const s=h.classList;for(const o in Wn)s.remove(`maplibregl-${i}-anchor-${o}`);s.add(`maplibregl-${i}-anchor-${e}`)}class Ya extends c.E{constructor(e){if(super(),this._onKeyPress=i=>{const s=i.code,o=i.charCode||i.keyCode;s!=="Space"&&s!=="Enter"&&o!==32&&o!==13||this.togglePopup()},this._onMapClick=i=>{const s=i.originalEvent.target,o=this._element;this._popup&&(s===o||o.contains(s))&&this.togglePopup()},this._update=i=>{var s;if(!this._map)return;const o=this._map.loaded()&&!this._map.isMoving();((i==null?void 0:i.type)==="terrain"||(i==null?void 0:i.type)==="render"&&!o)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Ws(this._lngLat,this._flatPos,this._map.transform):(s=this._lngLat)===null||s===void 0?void 0:s.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let u="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?u=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(u=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let f="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?f="rotateX(0deg)":this._pitchAlignment==="map"&&(f=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||i&&i.type!=="moveend"||(this._pos=this._pos.round()),Y.setTransform(this._element,`${Wn[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${f} ${u}`),Pe.frameAsync(new AbortController).then(()=>{this._updateOpacity(i&&i.type==="moveend")}).catch(()=>{})},this._onMove=i=>{if(!this._isDragging){const s=this._clickTolerance||this._map._clickTolerance;this._isDragging=i.point.dist(this._pointerdownPos)>=s}this._isDragging&&(this._pos=i.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new c.l("dragstart"))),this.fire(new c.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new c.l("dragend")),this._state="inactive"},this._addDragHandler=i=>{this._element.contains(i.originalEvent.target)&&(i.preventDefault(),this._positionDelta=i.point.sub(this._pos).add(this._offset),this._pointerdownPos=i.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._subpixelPositioning=e&&e.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&e.pitchAlignment!=="auto"?e.pitchAlignment:this._rotationAlignment,this.setOpacity(e==null?void 0:e.opacity,e==null?void 0:e.opacityWhenCovered),e&&e.element)this._element=e.element,this._offset=c.P.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=Y.create("div");const i=Y.createNS("http://www.w3.org/2000/svg","svg"),s=41,o=27;i.setAttributeNS(null,"display","block"),i.setAttributeNS(null,"height",`${s}px`),i.setAttributeNS(null,"width",`${o}px`),i.setAttributeNS(null,"viewBox",`0 0 ${o} ${s}`);const u=Y.createNS("http://www.w3.org/2000/svg","g");u.setAttributeNS(null,"stroke","none"),u.setAttributeNS(null,"stroke-width","1"),u.setAttributeNS(null,"fill","none"),u.setAttributeNS(null,"fill-rule","evenodd");const f=Y.createNS("http://www.w3.org/2000/svg","g");f.setAttributeNS(null,"fill-rule","nonzero");const g=Y.createNS("http://www.w3.org/2000/svg","g");g.setAttributeNS(null,"transform","translate(3.0, 29.0)"),g.setAttributeNS(null,"fill","#000000");const y=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const N of y){const $=Y.createNS("http://www.w3.org/2000/svg","ellipse");$.setAttributeNS(null,"opacity","0.04"),$.setAttributeNS(null,"cx","10.5"),$.setAttributeNS(null,"cy","5.80029008"),$.setAttributeNS(null,"rx",N.rx),$.setAttributeNS(null,"ry",N.ry),g.appendChild($)}const x=Y.createNS("http://www.w3.org/2000/svg","g");x.setAttributeNS(null,"fill",this._color);const T=Y.createNS("http://www.w3.org/2000/svg","path");T.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),x.appendChild(T);const M=Y.createNS("http://www.w3.org/2000/svg","g");M.setAttributeNS(null,"opacity","0.25"),M.setAttributeNS(null,"fill","#000000");const S=Y.createNS("http://www.w3.org/2000/svg","path");S.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),M.appendChild(S);const z=Y.createNS("http://www.w3.org/2000/svg","g");z.setAttributeNS(null,"transform","translate(6.0, 7.0)"),z.setAttributeNS(null,"fill","#FFFFFF");const R=Y.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"transform","translate(8.0, 8.0)");const V=Y.createNS("http://www.w3.org/2000/svg","circle");V.setAttributeNS(null,"fill","#000000"),V.setAttributeNS(null,"opacity","0.25"),V.setAttributeNS(null,"cx","5.5"),V.setAttributeNS(null,"cy","5.5"),V.setAttributeNS(null,"r","5.4999962");const j=Y.createNS("http://www.w3.org/2000/svg","circle");j.setAttributeNS(null,"fill","#FFFFFF"),j.setAttributeNS(null,"cx","5.5"),j.setAttributeNS(null,"cy","5.5"),j.setAttributeNS(null,"r","5.4999962"),R.appendChild(V),R.appendChild(j),f.appendChild(g),f.appendChild(x),f.appendChild(M),f.appendChild(z),f.appendChild(R),i.appendChild(f),i.setAttributeNS(null,"height",s*this._scale+"px"),i.setAttributeNS(null,"width",o*this._scale+"px"),this._element.appendChild(i),this._offset=c.P.convert(e&&e.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",i=>{i.preventDefault()}),this._element.addEventListener("mousedown",i=>{i.preventDefault()}),Xs(this._element,this._anchor,"marker"),e&&e.className)for(const i of e.className.split(" "))this._element.classList.add(i);this._popup=null}addTo(e){return this.remove(),this._map=e,this._element.setAttribute("aria-label",e._getUIString("Marker.Title")),e.getCanvasContainer().appendChild(this._element),e.on("move",this._update),e.on("moveend",this._update),e.on("terrain",this._update),e.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),Y.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=c.Q.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const o=Math.abs(13.5)/Math.SQRT2;e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[o,-1*(38.1-13.5+o)],"bottom-right":[-o,-1*(38.1-13.5+o)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(e){return this._subpixelPositioning=e,this}getPopup(){return this._popup}togglePopup(){const e=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:e?(e.isOpen()?e.remove():(e.setLngLat(this._lngLat),e.addTo(this._map)),this):this}_updateOpacity(e=!1){var i,s;if(!(!((i=this._map)===null||i===void 0)&&i.terrain)){const M=this._map.transform.isLocationOccluded(this._lngLat)?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==M&&(this._element.style.opacity=M))}if(e)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const o=this._map,u=o.terrain.depthAtPoint(this._pos),f=o.terrain.getElevationForLngLatZoom(this._lngLat,o.transform.tileZoom);if(o.transform.lngLatToCameraDepth(this._lngLat,f)-u<.006)return void(this._element.style.opacity=this._opacity);const g=-this._offset.y/o.transform.pixelsPerMeter,y=Math.sin(o.getPitch()*Math.PI/180)*g,x=o.terrain.depthAtPoint(new c.P(this._pos.x,this._pos.y-this._offset.y)),T=o.transform.lngLatToCameraDepth(this._lngLat,f+y)-x>.006;!((s=this._popup)===null||s===void 0)&&s.isOpen()&&T&&this._popup.remove(),this._element.style.opacity=T?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(e){return this._offset=c.P.convert(e),this._update(),this}addClassName(e){this._element.classList.add(e)}removeClassName(e){this._element.classList.remove(e)}toggleClassName(e){return this._element.classList.toggle(e)}setDraggable(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e&&e!=="auto"?e:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(e,i){return(this._opacity===void 0||e===void 0&&i===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),e!==void 0&&(this._opacity=e),i!==void 0&&(this._opacityWhenCovered=i),this._map&&this._updateOpacity(!0),this}}const yl={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Pa=0,Xn=!1;const vl={maxWidth:100,unit:"metric"};function Ks(h,e,i){const s=i&&i.maxWidth||100,o=h._container.clientHeight/2,u=h._container.clientWidth/2,f=h.unproject([u-s/2,o]),g=h.unproject([u+s/2,o]),y=Math.round(h.project(g).x-h.project(f).x),x=Math.min(s,y,h._container.clientWidth),T=f.distanceTo(g);if(i&&i.unit==="imperial"){const M=3.2808*T;M>5280?Kn(e,x,M/5280,h._getUIString("ScaleControl.Miles")):Kn(e,x,M,h._getUIString("ScaleControl.Feet"))}else i&&i.unit==="nautical"?Kn(e,x,T/1852,h._getUIString("ScaleControl.NauticalMiles")):T>=1e3?Kn(e,x,T/1e3,h._getUIString("ScaleControl.Kilometers")):Kn(e,x,T,h._getUIString("ScaleControl.Meters"))}function Kn(h,e,i,s){const o=function(u){const f=Math.pow(10,`${Math.floor(u)}`.length-1);let g=u/f;return g=g>=10?10:g>=5?5:g>=3?3:g>=2?2:g>=1?1:function(y){const x=Math.pow(10,Math.ceil(-Math.log(y)/Math.LN10));return Math.round(y*x)/x}(g),f*g}(i);h.style.width=e*(o/i)+"px",h.innerHTML=`${o}&nbsp;${s}`}const Ys={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},xl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Js(h){if(h){if(typeof h=="number"){const e=Math.round(Math.abs(h)/Math.SQRT2);return{center:new c.P(0,0),top:new c.P(0,h),"top-left":new c.P(e,e),"top-right":new c.P(-e,e),bottom:new c.P(0,-h),"bottom-left":new c.P(e,-e),"bottom-right":new c.P(-e,-e),left:new c.P(h,0),right:new c.P(-h,0)}}if(h instanceof c.P||Array.isArray(h)){const e=c.P.convert(h);return{center:e,top:e,"top-left":e,"top-right":e,bottom:e,"bottom-left":e,"bottom-right":e,left:e,right:e}}return{center:c.P.convert(h.center||[0,0]),top:c.P.convert(h.top||[0,0]),"top-left":c.P.convert(h["top-left"]||[0,0]),"top-right":c.P.convert(h["top-right"]||[0,0]),bottom:c.P.convert(h.bottom||[0,0]),"bottom-left":c.P.convert(h["bottom-left"]||[0,0]),"bottom-right":c.P.convert(h["bottom-right"]||[0,0]),left:c.P.convert(h.left||[0,0]),right:c.P.convert(h.right||[0,0])}}return Js(new c.P(0,0))}const Qs=ke;I.AJAXError=c.ci,I.Event=c.l,I.Evented=c.E,I.LngLat=c.Q,I.MercatorCoordinate=c.$,I.Point=c.P,I.addProtocol=c.cj,I.config=c.a,I.removeProtocol=c.ck,I.AttributionControl=Ka,I.BoxZoomHandler=Mc,I.CanvasSource=Wr,I.CooperativeGesturesHandler=ml,I.DoubleClickZoomHandler=Ac,I.DragPanHandler=Wa,I.DragRotateHandler=$s,I.EdgeInsets=Xi,I.FullscreenControl=class extends c.E{constructor(h={}){super(),this._onFullscreenChange=()=>{var e;let i=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((e=i==null?void 0:i.shadowRoot)===null||e===void 0)&&e.fullscreenElement;)i=i.shadowRoot.fullscreenElement;i===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,h&&h.container&&(h.container instanceof HTMLElement?this._container=h.container:c.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(h){return this._map=h,this._container||(this._container=this._map.getContainer()),this._controlContainer=Y.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){Y.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const h=this._fullscreenButton=Y.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);Y.create("span","maplibregl-ctrl-icon",h).setAttribute("aria-hidden","true"),h.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const h=this._getTitle();this._fullscreenButton.setAttribute("aria-label",h),this._fullscreenButton.title=h}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new c.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new c.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},I.GeoJSONSource=Rr,I.GeolocateControl=class extends c.E{constructor(h){super(),this._onSuccess=e=>{if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new c.l("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(e),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(e),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new c.l("geolocate",e)),this._finish()}},this._updateCamera=e=>{const i=new c.Q(e.coords.longitude,e.coords.latitude),s=e.coords.accuracy,o=this._map.getBearing(),u=c.e({bearing:o},this.options.fitBoundsOptions),f=ci.fromLngLat(i,s);this._map.fitBounds(f,u,{geolocateSource:!0})},this._updateMarker=e=>{if(e){const i=new c.Q(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=e=>{if(this._map){if(this.options.trackUserLocation)if(e.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=i,this._geolocateButton.setAttribute("aria-label",i),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(e.code===3&&Xn)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new c.l("error",e)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=Y.create("button","maplibregl-ctrl-geolocate",this._container),Y.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=e=>{if(this._map){if(e===!1){c.w("Geolocation support is not available so the GeolocateControl will be disabled.");const i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=i,this._geolocateButton.setAttribute("aria-label",i)}else{const i=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=i,this._geolocateButton.setAttribute("aria-label",i)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Y.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Ya({element:this._dotElement}),this._circleElement=Y.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ya({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",i=>{i.geolocateSource||this._watchState!=="ACTIVE_LOCK"||i.originalEvent&&i.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new c.l("trackuserlocationend")),this.fire(new c.l("userlocationlostfocus")))})}},this.options=c.e({},yl,h)}onAdd(h){return this._map=h,this._container=Y.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return c._(this,arguments,void 0,function*(e=!1){if(_n!==void 0&&!e)return _n;if(window.navigator.permissions===void 0)return _n=!!window.navigator.geolocation,_n;try{_n=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{_n=!!window.navigator.geolocation}return _n})}().then(e=>this._finishSetupUI(e)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),Y.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Pa=0,Xn=!1}_isOutOfMapMaxBounds(h){const e=this._map.getMaxBounds(),i=h.coords;return e&&(i.longitude<e.getWest()||i.longitude>e.getEast()||i.latitude<e.getSouth()||i.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const h=this._map.getBounds(),e=h.getSouthEast(),i=h.getNorthEast(),s=e.distanceTo(i),o=Math.ceil(this._accuracy/(s/this._map._container.clientHeight)*2);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}trigger(){if(!this._setup)return c.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new c.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Pa--,Xn=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new c.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new c.l("trackuserlocationstart")),this.fire(new c.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let h;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Pa++,Pa>1?(h={maximumAge:6e5,timeout:0},Xn=!0):(h=this.options.positionOptions,Xn=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,h)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},I.GlobeControl=class{constructor(){this._toggleProjection=()=>{var h;const e=(h=this._map.getProjection())===null||h===void 0?void 0:h.type;this._map.setProjection(e!=="mercator"&&e?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var h;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((h=this._map.getProjection())===null||h===void 0?void 0:h.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(h){return this._map=h,this._container=Y.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=Y.create("button","maplibregl-ctrl-globe",this._container),Y.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){Y.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},I.Hash=Cn,I.ImageSource=pr,I.KeyboardHandler=dl,I.LngLatBounds=ci,I.LogoControl=qs,I.Map=class extends at{constructor(h){var e,i;c.cf.mark(c.cg.create);const s=Object.assign(Object.assign(Object.assign({},Ta),h),{canvasContextAttributes:Object.assign(Object.assign({},Ta.canvasContextAttributes),h.canvasContextAttributes)});if(s.minZoom!=null&&s.maxZoom!=null&&s.minZoom>s.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(s.minPitch!=null&&s.maxPitch!=null&&s.minPitch>s.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(s.minPitch!=null&&s.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(s.maxPitch!=null&&s.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const o=new Or,u=new Yr;if(s.minZoom!==void 0&&o.setMinZoom(s.minZoom),s.maxZoom!==void 0&&o.setMaxZoom(s.maxZoom),s.minPitch!==void 0&&o.setMinPitch(s.minPitch),s.maxPitch!==void 0&&o.setMaxPitch(s.maxPitch),s.renderWorldCopies!==void 0&&o.setRenderWorldCopies(s.renderWorldCopies),super(o,u,{bearingSnap:s.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new gl,this._controls=[],this._mapId=c.a3(),this._contextLost=g=>{g.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new c.l("webglcontextlost",{originalEvent:g}))},this._contextRestored=g=>{this._setupPainter(),this.resize(),this._update(),this.fire(new c.l("webglcontextrestored",{originalEvent:g}))},this._onMapScroll=g=>{if(g.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=s.interactive,this._maxTileCacheSize=s.maxTileCacheSize,this._maxTileCacheZoomLevels=s.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},s.canvasContextAttributes),this._trackResize=s.trackResize===!0,this._bearingSnap=s.bearingSnap,this._centerClampedToGround=s.centerClampedToGround,this._refreshExpiredTiles=s.refreshExpiredTiles===!0,this._fadeDuration=s.fadeDuration,this._crossSourceCollisions=s.crossSourceCollisions===!0,this._collectResourceTiming=s.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Di),s.locale),this._clickTolerance=s.clickTolerance,this._overridePixelRatio=s.pixelRatio,this._maxCanvasSize=s.maxCanvasSize,this.transformCameraUpdate=s.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=s.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=Ze.addThrottleControl(()=>this.isMoving()),this._requestManager=new wt(s.transformRequest),typeof s.container=="string"){if(this._container=document.getElementById(s.container),!this._container)throw new Error(`Container '${s.container}' not found.`)}else{if(!(s.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=s.container}if(s.maxBounds&&this.setMaxBounds(s.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let g=!1;const y=al(x=>{this._trackResize&&!this._removed&&(this.resize(x),this.redraw())},50);this._resizeObserver=new ResizeObserver(x=>{g?y(x):g=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Gs(this,s),this._hash=s.hash&&new Cn(typeof s.hash=="string"&&s.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:s.center,elevation:s.elevation,zoom:s.zoom,bearing:s.bearing,pitch:s.pitch,roll:s.roll}),s.bounds&&(this.resize(),this.fitBounds(s.bounds,c.e({},s.fitBoundsOptions,{duration:0}))));const f=typeof s.style=="string"||((i=(e=s.style)===null||e===void 0?void 0:e.projection)===null||i===void 0?void 0:i.type)!=="globe";this.resize(null,f),this._localIdeographFontFamily=s.localIdeographFontFamily,this._validateStyle=s.validateStyle,s.style&&this.setStyle(s.style,{localIdeographFontFamily:s.localIdeographFontFamily}),s.attributionControl&&this.addControl(new Ka(typeof s.attributionControl=="boolean"?void 0:s.attributionControl)),s.maplibreLogo&&this.addControl(new qs,s.logoPosition),this.on("style.load",()=>{if(f||this._resizeTransform(),this.transform.unmodified){const g=c.O(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(g)}}),this.on("data",g=>{this._update(g.dataType==="style"),this.fire(new c.l(`${g.dataType}data`,g))}),this.on("dataloading",g=>{this.fire(new c.l(`${g.dataType}dataloading`,g))}),this.on("dataabort",g=>{this.fire(new c.l("sourcedataabort",g))})}_getMapId(){return this._mapId}addControl(h,e){if(e===void 0&&(e=h.getDefaultPosition?h.getDefaultPosition():"top-right"),!h||!h.onAdd)return this.fire(new c.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const i=h.onAdd(this);this._controls.push(h);const s=this._controlPositions[e];return e.indexOf("bottom")!==-1?s.insertBefore(i,s.firstChild):s.appendChild(i),this}removeControl(h){if(!h||!h.onRemove)return this.fire(new c.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const e=this._controls.indexOf(h);return e>-1&&this._controls.splice(e,1),h.onRemove(this),this}hasControl(h){return this._controls.indexOf(h)>-1}calculateCameraOptionsFromTo(h,e,i,s){return s==null&&this.terrain&&(s=this.terrain.getElevationForLngLatZoom(i,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(h,e,i,s)}resize(h,e=!0){const[i,s]=this._containerDimensions(),o=this._getClampedPixelRatio(i,s);if(this._resizeCanvas(i,s,o),this.painter.resize(i,s,o),this.painter.overLimit()){const f=this.painter.context.gl;this._maxCanvasSize=[f.drawingBufferWidth,f.drawingBufferHeight];const g=this._getClampedPixelRatio(i,s);this._resizeCanvas(i,s,g),this.painter.resize(i,s,g)}this._resizeTransform(e);const u=!this._moving;return u&&(this.stop(),this.fire(new c.l("movestart",h)).fire(new c.l("move",h))),this.fire(new c.l("resize",h)),u&&this.fire(new c.l("moveend",h)),this}_resizeTransform(h=!0){var e;const[i,s]=this._containerDimensions();this.transform.resize(i,s,h),(e=this._requestedCameraState)===null||e===void 0||e.resize(i,s,h)}_getClampedPixelRatio(h,e){const{0:i,1:s}=this._maxCanvasSize,o=this.getPixelRatio(),u=h*o,f=e*o;return Math.min(u>i?i/u:1,f>s?s/f:1)*o}getPixelRatio(){var h;return(h=this._overridePixelRatio)!==null&&h!==void 0?h:devicePixelRatio}setPixelRatio(h){this._overridePixelRatio=h,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(h){return this.transform.setMaxBounds(ci.convert(h)),this._update()}setMinZoom(h){if((h=h??-2)>=-2&&h<=this.transform.maxZoom)return this.transform.setMinZoom(h),this._update(),this.getZoom()<h&&this.setZoom(h),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(h){if((h=h??22)>=this.transform.minZoom)return this.transform.setMaxZoom(h),this._update(),this.getZoom()>h&&this.setZoom(h),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(h){if((h=h??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(h>=0&&h<=this.transform.maxPitch)return this.transform.setMinPitch(h),this._update(),this.getPitch()<h&&this.setPitch(h),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(h){if((h=h??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(h>=this.transform.minPitch)return this.transform.setMaxPitch(h),this._update(),this.getPitch()>h&&this.setPitch(h),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(h){return this.transform.setRenderWorldCopies(h),this._update()}project(h){return this.transform.locationToScreenPoint(c.Q.convert(h),this.style&&this.terrain)}unproject(h){return this.transform.screenPointToLocation(c.P.convert(h),this.terrain)}isMoving(){var h;return this._moving||((h=this.handlers)===null||h===void 0?void 0:h.isMoving())}isZooming(){var h;return this._zooming||((h=this.handlers)===null||h===void 0?void 0:h.isZooming())}isRotating(){var h;return this._rotating||((h=this.handlers)===null||h===void 0?void 0:h.isRotating())}_createDelegatedListener(h,e,i){if(h==="mouseenter"||h==="mouseover"){let s=!1;return{layers:e,listener:i,delegates:{mousemove:u=>{const f=e.filter(y=>this.getLayer(y)),g=f.length!==0?this.queryRenderedFeatures(u.point,{layers:f}):[];g.length?s||(s=!0,i.call(this,new Mi(h,this,u.originalEvent,{features:g}))):s=!1},mouseout:()=>{s=!1}}}}if(h==="mouseleave"||h==="mouseout"){let s=!1;return{layers:e,listener:i,delegates:{mousemove:f=>{const g=e.filter(y=>this.getLayer(y));(g.length!==0?this.queryRenderedFeatures(f.point,{layers:g}):[]).length?s=!0:s&&(s=!1,i.call(this,new Mi(h,this,f.originalEvent)))},mouseout:f=>{s&&(s=!1,i.call(this,new Mi(h,this,f.originalEvent)))}}}}{const s=o=>{const u=e.filter(g=>this.getLayer(g)),f=u.length!==0?this.queryRenderedFeatures(o.point,{layers:u}):[];f.length&&(o.features=f,i.call(this,o),delete o.features)};return{layers:e,listener:i,delegates:{[h]:s}}}}_saveDelegatedListener(h,e){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[h]=this._delegatedListeners[h]||[],this._delegatedListeners[h].push(e)}_removeDelegatedListener(h,e,i){if(!this._delegatedListeners||!this._delegatedListeners[h])return;const s=this._delegatedListeners[h];for(let o=0;o<s.length;o++){const u=s[o];if(u.listener===i&&u.layers.length===e.length&&u.layers.every(f=>e.includes(f))){for(const f in u.delegates)this.off(f,u.delegates[f]);return void s.splice(o,1)}}}on(h,e,i){if(i===void 0)return super.on(h,e);const s=typeof e=="string"?[e]:e,o=this._createDelegatedListener(h,s,i);this._saveDelegatedListener(h,o);for(const u in o.delegates)this.on(u,o.delegates[u]);return{unsubscribe:()=>{this._removeDelegatedListener(h,s,i)}}}once(h,e,i){if(i===void 0)return super.once(h,e);const s=typeof e=="string"?[e]:e,o=this._createDelegatedListener(h,s,i);for(const u in o.delegates){const f=o.delegates[u];o.delegates[u]=(...g)=>{this._removeDelegatedListener(h,s,i),f(...g)}}this._saveDelegatedListener(h,o);for(const u in o.delegates)this.once(u,o.delegates[u]);return this}off(h,e,i){return i===void 0?super.off(h,e):(this._removeDelegatedListener(h,typeof e=="string"?[e]:e,i),this)}queryRenderedFeatures(h,e){if(!this.style)return[];let i;const s=h instanceof c.P||Array.isArray(h),o=s?h:[[0,0],[this.transform.width,this.transform.height]];if(e=e||(s?{}:h)||{},o instanceof c.P||typeof o[0]=="number")i=[c.P.convert(o)];else{const u=c.P.convert(o[0]),f=c.P.convert(o[1]);i=[u,new c.P(f.x,u.y),f,new c.P(u.x,f.y),u]}return this.style.queryRenderedFeatures(i,e,this.transform)}querySourceFeatures(h,e){return this.style.querySourceFeatures(h,e)}setStyle(h,e){return(e=c.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},e)).diff!==!1&&e.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&h?(this._diffStyle(h,e),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._updateStyle(h,e))}setTransformRequest(h){return this._requestManager.setTransformRequest(h),this}_getUIString(h){const e=this._locale[h];if(e==null)throw new Error(`Missing UI string '${h}'`);return e}_updateStyle(h,e){var i,s;if(e.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(h,e));const o=this.style&&e.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!h)),h?(this.style=new Oa(this,e||{}),this.style.setEventedParent(this,{style:this.style}),typeof h=="string"?this.style.loadURL(h,e,o):this.style.loadJSON(h,e,o),this):((s=(i=this.style)===null||i===void 0?void 0:i.projection)===null||s===void 0||s.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Oa(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(h,e){if(typeof h=="string"){const i=this._requestManager.transformRequest(h,"Style");c.j(i,new AbortController).then(s=>{this._updateDiff(s.data,e)}).catch(s=>{s&&this.fire(new c.k(s))})}else typeof h=="object"&&this._updateDiff(h,e)}_updateDiff(h,e){try{this.style.setState(h,e)&&this._update(!0)}catch(i){c.w(`Unable to perform style diff: ${i.message||i.error||i}.  Rebuilding the style from scratch.`),this._updateStyle(h,e)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():c.w("There is no style added to the map.")}addSource(h,e){return this._lazyInitEmptyStyle(),this.style.addSource(h,e),this._update(!0)}isSourceLoaded(h){const e=this.style&&this.style.sourceCaches[h];if(e!==void 0)return e.loaded();this.fire(new c.k(new Error(`There is no source with ID '${h}'`)))}setTerrain(h){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),h){const e=this.style.sourceCaches[h.source];if(!e)throw new Error(`cannot load terrain, because there exists no source with ID: ${h.source}`);this.terrain===null&&e.reload();for(const i in this.style._layers){const s=this.style._layers[i];s.type==="hillshade"&&s.source===h.source&&c.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new ln(this.painter,e,h),this.painter.renderToTexture=new Si(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=i=>{i.dataType==="style"?this.terrain.sourceCache.freeRtt():i.dataType==="source"&&i.tile&&(i.sourceId!==h.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),this.terrain.sourceCache.freeRtt(i.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new c.l("terrain",{terrain:h})),this}getTerrain(){var h,e;return(e=(h=this.terrain)===null||h===void 0?void 0:h.options)!==null&&e!==void 0?e:null}areTilesLoaded(){const h=this.style&&this.style.sourceCaches;for(const e in h){const i=h[e]._tiles;for(const s in i){const o=i[s];if(o.state!=="loaded"&&o.state!=="errored")return!1}}return!0}removeSource(h){return this.style.removeSource(h),this._update(!0)}getSource(h){return this.style.getSource(h)}addImage(h,e,i={}){const{pixelRatio:s=1,sdf:o=!1,stretchX:u,stretchY:f,content:g,textFitWidth:y,textFitHeight:x}=i;if(this._lazyInitEmptyStyle(),!(e instanceof HTMLImageElement||c.b(e))){if(e.width===void 0||e.height===void 0)return this.fire(new c.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:T,height:M,data:S}=e,z=e;return this.style.addImage(h,{data:new c.R({width:T,height:M},new Uint8Array(S)),pixelRatio:s,stretchX:u,stretchY:f,content:g,textFitWidth:y,textFitHeight:x,sdf:o,version:0,userImage:z}),z.onAdd&&z.onAdd(this,h),this}}{const{width:T,height:M,data:S}=Pe.getImageData(e);this.style.addImage(h,{data:new c.R({width:T,height:M},S),pixelRatio:s,stretchX:u,stretchY:f,content:g,textFitWidth:y,textFitHeight:x,sdf:o,version:0})}}updateImage(h,e){const i=this.style.getImage(h);if(!i)return this.fire(new c.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const s=e instanceof HTMLImageElement||c.b(e)?Pe.getImageData(e):e,{width:o,height:u,data:f}=s;if(o===void 0||u===void 0)return this.fire(new c.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(o!==i.data.width||u!==i.data.height)return this.fire(new c.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const g=!(e instanceof HTMLImageElement||c.b(e));return i.data.replace(f,g),this.style.updateImage(h,i),this}getImage(h){return this.style.getImage(h)}hasImage(h){return h?!!this.style.getImage(h):(this.fire(new c.k(new Error("Missing required image id"))),!1)}removeImage(h){this.style.removeImage(h)}loadImage(h){return Ze.getImage(this._requestManager.transformRequest(h,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(h,e){return this._lazyInitEmptyStyle(),this.style.addLayer(h,e),this._update(!0)}moveLayer(h,e){return this.style.moveLayer(h,e),this._update(!0)}removeLayer(h){return this.style.removeLayer(h),this._update(!0)}getLayer(h){return this.style.getLayer(h)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(h,e,i){return this.style.setLayerZoomRange(h,e,i),this._update(!0)}setFilter(h,e,i={}){return this.style.setFilter(h,e,i),this._update(!0)}getFilter(h){return this.style.getFilter(h)}setPaintProperty(h,e,i,s={}){return this.style.setPaintProperty(h,e,i,s),this._update(!0)}getPaintProperty(h,e){return this.style.getPaintProperty(h,e)}setLayoutProperty(h,e,i,s={}){return this.style.setLayoutProperty(h,e,i,s),this._update(!0)}getLayoutProperty(h,e){return this.style.getLayoutProperty(h,e)}setGlyphs(h,e={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(h,e),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(h,e,i={}){return this._lazyInitEmptyStyle(),this.style.addSprite(h,e,i,s=>{s||this._update(!0)}),this}removeSprite(h){return this._lazyInitEmptyStyle(),this.style.removeSprite(h),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(h,e={}){return this._lazyInitEmptyStyle(),this.style.setSprite(h,e,i=>{i||this._update(!0)}),this}setLight(h,e={}){return this._lazyInitEmptyStyle(),this.style.setLight(h,e),this._update(!0)}getLight(){return this.style.getLight()}setSky(h,e={}){return this._lazyInitEmptyStyle(),this.style.setSky(h,e),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(h,e){return this.style.setFeatureState(h,e),this._update()}removeFeatureState(h,e){return this.style.removeFeatureState(h,e),this._update()}getFeatureState(h){return this.style.getFeatureState(h)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let h=0,e=0;return this._container&&(h=this._container.clientWidth||400,e=this._container.clientHeight||300),[h,e]}_setupContainer(){const h=this._container;h.classList.add("maplibregl-map");const e=this._canvasContainer=Y.create("div","maplibregl-canvas-container",h);this._interactive&&e.classList.add("maplibregl-interactive"),this._canvas=Y.create("canvas","maplibregl-canvas",e),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const i=this._containerDimensions(),s=this._getClampedPixelRatio(i[0],i[1]);this._resizeCanvas(i[0],i[1],s);const o=this._controlContainer=Y.create("div","maplibregl-control-container",h),u=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(f=>{u[f]=Y.create("div",`maplibregl-ctrl-${f} `,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(h,e,i){this._canvas.width=Math.floor(i*h),this._canvas.height=Math.floor(i*e),this._canvas.style.width=`${h}px`,this._canvas.style.height=`${e}px`}_setupPainter(){const h=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let e=null;this._canvas.addEventListener("webglcontextcreationerror",s=>{e={requestedAttributes:h},s&&(e.statusMessage=s.statusMessage,e.type=s.type)},{once:!0});let i=null;if(i=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,h):this._canvas.getContext("webgl2",h)||this._canvas.getContext("webgl",h),!i){const s="Failed to initialize WebGL";throw e?(e.message=s,new Error(JSON.stringify(e))):new Error(s)}this.painter=new yc(i,this.transform),Be.testSupport(i)}migrateProjection(h,e){super.migrateProjection(h,e),this.painter.transform=h,this.fire(new c.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(h){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||h,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(h){return this._update(),this._renderTaskQueue.add(h)}_cancelRenderFrame(h){this._renderTaskQueue.remove(h)}_render(h){var e,i,s,o,u;const f=this._idleTriggered?this._fadeDuration:0,g=((e=this.style.projection)===null||e===void 0?void 0:e.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(h),this._removed)return;let y=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const M=this.transform.zoom,S=Pe.now();this.style.zoomHistory.update(M,S);const z=new c.C(M,{now:S,fadeDuration:f,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),R=z.crossFadingFactor();R===1&&R===this._crossFadingFactor||(y=!0,this._crossFadingFactor=R),this.style.update(z)}const x=((i=this.style.projection)===null||i===void 0?void 0:i.transitionState)>0!==g;(s=this.style.projection)===null||s===void 0||s.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((o=this.style.projection)===null||o===void 0?void 0:o.transitionState,(u=this.style.projection)===null||u===void 0?void 0:u.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||x)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,f,this._crossSourceCollisions,x),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:f,showPadding:this.showPadding}),this.fire(new c.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,c.cf.mark(c.cg.load),this.fire(new c.l("load"))),this.style&&(this.style.hasTransitions()||y)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const T=this._sourcesDirty||this._styleDirty||this._placementDirty;return T||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new c.l("idle")),!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,c.cf.mark(c.cg.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var h;this._hash&&this._hash.remove();for(const i of this._controls)i.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Ze.removeThrottleControl(this._imageQueueHandle),(h=this._resizeObserver)===null||h===void 0||h.disconnect();const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e!=null&&e.loseContext&&e.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),Y.remove(this._canvasContainer),Y.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),c.cf.clearMetrics(),this._removed=!0,this.fire(new c.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,Pe.frame(this._frameRequest,h=>{c.cf.frame(h),this._frameRequest=null;try{this._render(h)}catch(e){if(!c.ch(e)&&!function(i){return i.message===dc}(e))throw e}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(h){this._showTileBoundaries!==h&&(this._showTileBoundaries=h,this._update())}get showPadding(){return!!this._showPadding}set showPadding(h){this._showPadding!==h&&(this._showPadding=h,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(h){this._showCollisionBoxes!==h&&(this._showCollisionBoxes=h,h?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(h){this._showOverdrawInspector!==h&&(this._showOverdrawInspector=h,this._update())}get repaint(){return!!this._repaint}set repaint(h){this._repaint!==h&&(this._repaint=h,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(h){this._vertices=h,this._update()}get version(){return zc}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(h){return this._lazyInitEmptyStyle(),this.style.setProjection(h),this._update(!0)}},I.MapMouseEvent=Mi,I.MapTouchEvent=br,I.MapWheelEvent=sl,I.Marker=Ya,I.NavigationControl=class{constructor(h){this._updateZoomButtons=()=>{const e=this._map.getZoom(),i=e===this._map.getMaxZoom(),s=e===this._map.getMinZoom();this._zoomInButton.disabled=i,this._zoomOutButton.disabled=s,this._zoomInButton.setAttribute("aria-disabled",i.toString()),this._zoomOutButton.setAttribute("aria-disabled",s.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(e,i)=>{const s=this._map._getUIString(`NavigationControl.${i}`);e.title=s,e.setAttribute("aria-label",s)},this.options=c.e({},Hs,h),this._container=Y.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",e=>this._map.zoomIn({},{originalEvent:e})),Y.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",e=>this._map.zoomOut({},{originalEvent:e})),Y.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e})}),this._compassIcon=Y.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(h){return this._map=h,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new _l(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){Y.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(h,e){const i=Y.create("button",h,this._container);return i.type="button",i.addEventListener("click",e),i}},I.Popup=class extends c.E{constructor(h){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:void 0)},this.remove=()=>(this._content&&Y.remove(this._content),this._container&&(Y.remove(this._container),delete this._container),this._closeButton&&this._closeButton.removeEventListener("click",this._onClose),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new c.l("close"))),this),this._onMouseUp=e=>{this._update(e.point)},this._onMouseMove=e=>{this._update(e.point)},this._onDrag=e=>{this._update(e.point)},this._update=e=>{var i;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=Y.create("div","maplibregl-popup",this._map.getContainer()),this._tip=Y.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const g of this.options.className.split(" "))this._container.classList.add(g);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Ws(this._lngLat,this._flatPos,this._map.transform):(i=this._lngLat)===null||i===void 0?void 0:i.wrap(),this._trackPointer&&!e)return;const s=this._flatPos=this._pos=this._trackPointer&&e?e:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&e?e:this._map.transform.locationToScreenPoint(this._lngLat));let o=this.options.anchor;const u=Js(this.options.offset);if(!o){const g=this._container.offsetWidth,y=this._container.offsetHeight;let x;x=s.y+u.bottom.y<y?["top"]:s.y>this._map.transform.height-y?["bottom"]:[],s.x<g/2?x.push("left"):s.x>this._map.transform.width-g/2&&x.push("right"),o=x.length===0?"bottom":x.join("-")}let f=s.add(u[o]);this.options.subpixelPositioning||(f=f.round()),Y.setTransform(this._container,`${Wn[o]} translate(${f.x}px,${f.y}px)`),Xs(this._container,o,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=c.e(Object.create(Ys),h)}addTo(h){return this._map&&this.remove(),this._map=h,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new c.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(h){return this._lngLat=c.Q.convert(h),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(h){return this.setDOMContent(document.createTextNode(h))}setHTML(h){const e=document.createDocumentFragment(),i=document.createElement("body");let s;for(i.innerHTML=h;s=i.firstChild,s;)e.appendChild(s);return this.setDOMContent(e)}getMaxWidth(){var h;return(h=this._container)===null||h===void 0?void 0:h.style.maxWidth}setMaxWidth(h){return this.options.maxWidth=h,this._update(),this}setDOMContent(h){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=Y.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(h),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(h){return this._container&&this._container.classList.add(h),this}removeClassName(h){return this._container&&this._container.classList.remove(h),this}setOffset(h){return this.options.offset=h,this._update(),this}toggleClassName(h){if(this._container)return this._container.classList.toggle(h)}setSubpixelPositioning(h){this.options.subpixelPositioning=h}_createCloseButton(){this.options.closeButton&&(this._closeButton=Y.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const h=this._container.querySelector(xl);h&&h.focus()}},I.RasterDEMTileSource=Hr,I.RasterTileSource=ir,I.ScaleControl=class{constructor(h){this._onMove=()=>{Ks(this._map,this._container,this.options)},this.setUnit=e=>{this.options.unit=e,Ks(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},vl),h)}getDefaultPosition(){return"bottom-left"}onAdd(h){return this._map=h,this._container=Y.create("div","maplibregl-ctrl maplibregl-ctrl-scale",h.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){Y.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},I.ScrollZoomHandler=Ec,I.Style=Oa,I.TerrainControl=class{constructor(h){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=h}onAdd(h){return this._map=h,this._container=Y.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=Y.create("button","maplibregl-ctrl-terrain",this._container),Y.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){Y.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},I.TwoFingersTouchPitchHandler=hl,I.TwoFingersTouchRotateHandler=Ic,I.TwoFingersTouchZoomHandler=Cc,I.TwoFingersTouchZoomRotateHandler=fl,I.VectorTileSource=qr,I.VideoSource=fr,I.addSourceType=(h,e)=>c._(void 0,void 0,void 0,function*(){if(nt(h))throw new Error(`A source type called "${h}" already exists.`);((i,s)=>{Ve[i]=s})(h,e)}),I.clearPrewarmedResources=function(){const h=Wt;h&&(h.isPreloaded()&&h.numActive()===1?(h.release(Ti),Wt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},I.createTileMesh=Fa,I.getMaxParallelImageRequests=function(){return c.a.MAX_PARALLEL_IMAGE_REQUESTS},I.getRTLTextPluginStatus=function(){return zt().getRTLTextPluginStatus()},I.getVersion=function(){return Qs},I.getWorkerCount=function(){return ei.workerCount},I.getWorkerUrl=function(){return c.a.WORKER_URL},I.importScriptInWorkers=function(h){return Zt().broadcast("IS",h)},I.prewarm=function(){lt().acquire(Ti)},I.setMaxParallelImageRequests=function(h){c.a.MAX_PARALLEL_IMAGE_REQUESTS=h},I.setRTLTextPlugin=function(h,e){return zt().setRTLTextPlugin(h,e)},I.setWorkerCount=function(h){ei.workerCount=h},I.setWorkerUrl=function(h){c.a.WORKER_URL=h}});var Ae=oe;return Ae})}(ih)),ih.exports}var wg=bg();const vo=vg(wg);function Hp(H){return H=="federal"?"fed":"ont-ed"}function Wp(H){if(H&&H.features.length>0){const ae=H.features[0].properties;let oe=[];return ae.lib_pct!==null&&oe.push(fn[0]),ae.cons1_pct!==null&&oe.push(fn[1]),ae.cons2_pct!==null&&oe.push(fn[2]),ae.ndp_pct!==null&&oe.push(fn[3]),oe}}function Tg(H){if(H&&H.features.length>0){const ae=H.features[0].properties;let oe=[];return ae.pct_imm!==null&&oe.push({name:"Percent immigrants",propertyTag:"pct_imm"}),ae.pct_vm!==null&&oe.push({name:"Percent visible minorities",propertyTag:"pct_vm"}),ae.avg_hou_inc!==null&&oe.push({name:"Average household income",propertyTag:"avg_hou_inc"}),oe}}var Pg=Ip('<rect y="25" stroke="#FFFFFF" stroke-width="1"></rect>'),Mg=Ip('<text class="legend-label svelte-12xnfa5" y="55" text-anchor="start"> </text>'),Sg=ii('<div class="legend svelte-12xnfa5"><svg><text class="legend-title svelte-12xnfa5" x="0" y="18"> </text><!><!></svg></div>');function Cp(H,ae){ls(ae,!0);let oe=th(ae,"title",3,""),he=th(ae,"colors",19,()=>[]),Ee=th(ae,"labels",19,()=>[]);const Ae=350,I=70,c=15;let ke=Pr(()=>Ae/he().length),He=Pr(()=>Array.from({length:he().length},($e,pt)=>pt*te(ke))),je=Pr(()=>Array.from({length:Ee().length},($e,pt)=>pt*te(ke)));var Qe=Sg(),Pe=Xe(Qe);Tn(Pe,"width",Ae),Tn(Pe,"height",I);var Y=Xe(Pe),Be=Xe(Y,!0);Ne(Y);var st=vt(Y);na(st,17,he,ka,($e,pt,jt)=>{var Ze=Pg();Tn(Ze,"height",c),wi(()=>{Tn(Ze,"x",te(He)[jt]),Tn(Ze,"width",te(ke)),Tn(Ze,"fill",te(pt))}),Ft($e,Ze)});var et=vt(st);na(et,17,Ee,ka,($e,pt,jt)=>{var Ze=Mg(),wt=Xe(Ze,!0);Ne(Ze),wi(()=>{Tn(Ze,"x",te(je)[jt]),vi(wt,te(pt))}),Ft($e,Ze)}),Ne(Pe),Ne(Qe),wi(()=>vi(Be,oe())),Ft(H,Qe),cs()}const Cg="FeatureCollection",Ig="municipality-place-labels",Eg={type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}},Ag=[{type:"Feature",properties:{name:"Vaughan"},geometry:{type:"Point",coordinates:[-79.5648,43.8365]}},{type:"Feature",properties:{name:"Markham"},geometry:{type:"Point",coordinates:[-79.295,43.8811]}},{type:"Feature",properties:{name:"Oshawa"},geometry:{type:"Point",coordinates:[-78.8733,43.9387]}},{type:"Feature",properties:{name:"Mississauga"},geometry:{type:"Point",coordinates:[-79.6614,43.5976]}},{type:"Feature",properties:{name:"Aurora"},geometry:{type:"Point",coordinates:[-79.4473,43.996]}},{type:"Feature",properties:{name:"Richmond Hill"},geometry:{type:"Point",coordinates:[-79.4275,43.9031]}},{type:"Feature",properties:{name:"Brampton"},geometry:{type:"Point",coordinates:[-79.7521,43.7153]}},{type:"Feature",properties:{name:"King"},geometry:{type:"Point",coordinates:[-79.6091,43.9757]}},{type:"Feature",properties:{name:"Newmarket"},geometry:{type:"Point",coordinates:[-79.4611,44.0495]}},{type:"Feature",properties:{name:"Oakville"},geometry:{type:"Point",coordinates:[-79.7186,43.453]}},{type:"Feature",properties:{name:"Burlington"},geometry:{type:"Point",coordinates:[-79.8402,43.3786]}},{type:"Feature",properties:{name:"Pickering"},geometry:{type:"Point",coordinates:[-79.1132,43.909]}},{type:"Feature",properties:{name:"Ajax"},geometry:{type:"Point",coordinates:[-79.0246,43.8639]}},{type:"Feature",properties:{name:"Whitby"},geometry:{type:"Point",coordinates:[-78.9604,43.9222]}},{type:"Feature",properties:{name:"Clarington"},geometry:{type:"Point",coordinates:[-78.653,43.9712]}},{type:"Feature",properties:{name:"Scugog"},geometry:{type:"Point",coordinates:[-78.9211,44.1215]}},{type:"Feature",properties:{name:"Uxbridge"},geometry:{type:"Point",coordinates:[-79.1881,44.117]}},{type:"Feature",properties:{name:"Georgina"},geometry:{type:"Point",coordinates:[-79.3574,44.3318]}},{type:"Feature",properties:{name:"East Gwillimbury"},geometry:{type:"Point",coordinates:[-79.4077,44.1395]}},{type:"Feature",properties:{name:"Milton"},geometry:{type:"Point",coordinates:[-79.9456,43.5188]}},{type:"Feature",properties:{name:"Halton Hills"},geometry:{type:"Point",coordinates:[-79.9417,43.6238]}},{type:"Feature",properties:{name:"Whitchurch-Stouffville"},geometry:{type:"Point",coordinates:[-79.3234,44.0126]}},{type:"Feature",properties:{name:"Scarborough"},geometry:{type:"Point",coordinates:[-79.2358,43.7768]}},{type:"Feature",properties:{name:"Etobicoke"},geometry:{type:"Point",coordinates:[-79.5532,43.67]}},{type:"Feature",properties:{name:"York"},geometry:{type:"Point",coordinates:[-79.4776,43.685]}},{type:"Feature",properties:{name:"North York"},geometry:{type:"Point",coordinates:[-79.4304,43.7518]}},{type:"Feature",properties:{name:"East York"},geometry:{type:"Point",coordinates:[-79.337,43.7006]}},{type:"Feature",properties:{name:"Toronto"},geometry:{type:"Point",coordinates:[-79.3868,43.6617]}},{type:"Feature",properties:{name:"Caledon"},geometry:{type:"Point",coordinates:[-79.9023,43.849]}},{type:"Feature",properties:{name:"Orangeville"},geometry:{type:"Point",coordinates:[-80.1098,43.9154]}}],kg={type:Cg,name:Ig,crs:Eg,features:Ag};function zg(H,ae,oe,he,Ee){Pt(ae,Jt(H.target.value)),Pt(oe,Jt(te(ae)==="federal"?zp:sh)),Pt(he,Jt(te(oe)[te(oe).length-1])),Ee()}function Dg(H,ae,oe){Pt(ae,Jt(parseInt(H.target.value))),oe()}function Rg(H,ae,oe){Pt(ae,Jt(H.target.value)),oe()}function Lg(H,ae,oe){Pt(ae,Jt(H.target.value)),oe()}var Fg=ii("<option> </option>"),Bg=ii("<option> </option>"),Og=ii("<option> </option>"),jg=ii("<p><b> </b></p>"),Vg=ii("<p><i>Hover or click on a riding</i></p>"),Ng=ii("<p> <b> </b></p>"),Zg=ii("<p> <b>N/A</b></p>"),Ug=ii("<p> <b>N/A</b></p>"),$g=ii("<p> <b> </b></p>"),Gg=ii("<p> <b> </b></p>"),qg=ii("<p> <b> </b></p>"),Hg=ii("<p> <b>N/A</b></p>"),Wg=ii("<p> <b>N/A</b></p>"),Xg=ii("<p> <b>N/A</b></p>"),Kg=ii(`<div class="container"><div class="sentence-controls"><p>View data for the <select class="inline-select"></select> <select class="inline-select"><option>federal</option><option>Ontario</option></select> election.
            Show maps for vote share for the <select class="inline-select"></select> compared to census data for <select class="inline-select"></select>.</p></div></div> <div class="map-container svelte-1y15h0l"><div class="map-section svelte-1y15h0l"><!> <div id="map1" class="map svelte-1y15h0l"></div></div> <div class="map-section svelte-1y15h0l"><!> <div id="map2" class="map svelte-1y15h0l"></div></div></div> <div class="container"><div class="info-row"><!></div> <div class="info-row"><!></div> <div class="info-row"><!></div></div>`,1);function Yg(H,ae){ls(ae,!0);let oe,he;const Ee={style:{version:8,sources:{},glyphs:"https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf",layers:[{id:"background",type:"background",paint:{"background-color":"#fcfcfc"}}]},center:[-79.386,43.702],zoom:9,maxZoom:11,minZoom:8,maxBounds:[[-81,42.5],[-78,45]],bearing:-17.2,dragRotate:!1,pitchWithRotate:!1,touchZoomRotate:!0,attributionControl:!1,scrollZoom:!1},Ae={showCompass:!0,visualizePitch:!1},I={maxWidth:100,unit:"metric"};let c=Ai("ontario"),ke=Pr(()=>Hp(te(c))),He=Ai(2025),je=Ai(Jt(sh)),Qe=Ai(null),Pe=Pr(()=>Wp(te(Qe))),Y=Ai("cons1"),Be=Pr(()=>()=>{var Ve;return(Ve=fn.find(nt=>nt.tag===te(Y)))==null?void 0:Ve.name}),st=Pr(()=>Tg(te(Qe))),et=Ai("pct_imm"),$e=Ai(null),pt=Ai(null),jt=Pr(()=>te(et)==="pct_imm"?Bt(0,60,7):te(et)==="pct_vm"?Bt(0,90,7):te(Qe)?Rt():[]);const Ze=Bt(0,60,7);let wt=!1;function tt(Ve,nt){Ve.on("move",()=>{wt||(wt=!0,nt.jumpTo({center:Ve.getCenter(),zoom:Ve.getZoom()}),wt=!1)})}function Ue(Ve,nt=null){Ve.addSource("labels-source",{type:"geojson",data:kg}),Ve.addLayer({id:"labels-layer",type:"symbol",source:"labels-source",layout:{"text-field":["get","name"],"text-size":12,"text-offset":[0,0],"text-anchor":"top","text-allow-overlap":!1,"text-font":["TradeGothic LT Bold"]},paint:{"text-color":"#1E3765","text-halo-color":"#FFFFFF","text-halo-width":1,"text-opacity":.7}}),nt&&nt()}function xt(){const Ve=`/gta-immigration/data/elections/${te(ke)}_stats_${te(He)}.geojson`;fetch(Ve).then(nt=>nt.json()).then(nt=>{nt.features=nt.features.map((Oe,ft)=>(Oe.id||(Oe.id=ft),Oe)),Pt(Qe,Jt(nt)),Dt(),oe&&oe.getLayer("labels-layer")&&bt(),he&&he.getLayer("labels-layer")&&kt()})}function Dt(){te(Qe)&&te(Qe).features.length>0&&(te(Pe).some(Ve=>Ve.tag===te(Y))||Pt(Y,Jt(te(Pe).length>0?te(Pe)[0].tag:null)),te(st).some(Ve=>Ve.propertyTag===te(et))||Pt(et,Jt(te(st).length>0?te(st)[0].propertyTag:null)))}function Bt(Ve,nt,Oe){const ft=(nt-Ve)/(Oe-1);return Array.from({length:Oe},(Yt,zt)=>zt===Oe-1?`${Ve+zt*ft}%+`:`${Ve+zt*ft}%`)}function Rt(){const Ve=te(Qe).features.map(Yt=>Yt.properties.avg_hou_inc),nt=Math.min(...Ve),ft=(Math.max(...Ve)-nt)/6;return Array.from({length:7},(Yt,zt)=>zt===6?`$${Math.round((nt+zt*ft)/1e3)}K`:`$${Math.round((nt+zt*ft)/1e3)}K`)}function bt(){oe.getLayer("party-vote-share-boundary")&&oe.removeLayer("party-vote-share-boundary"),oe.getLayer("party-vote-share")&&oe.removeLayer("party-vote-share"),oe.getSource("party-vote-share")&&oe.removeSource("party-vote-share"),oe.addSource("party-vote-share",{type:"geojson",data:te(Qe)});const Ve=fn.find(nt=>nt.tag===te(Y)).propertyTag;oe.addLayer({id:"party-vote-share",type:"fill",source:"party-vote-share",paint:{"fill-color":["step",["get",Ve],Aa[te(Y)][0],10,Aa[te(Y)][1],20,Aa[te(Y)][2],30,Aa[te(Y)][3],40,Aa[te(Y)][4],50,Aa[te(Y)][5],60,Aa[te(Y)][6]],"fill-opacity":1}},"labels-layer"),oe.addLayer({id:"party-vote-share-boundary",type:"line",source:"party-vote-share",paint:{"line-color":"#fff","line-width":["case",["boolean",["feature-state","hover"],!1],3,.5]}},"labels-layer")}function kt(){he.getLayer("census-variable-boundary")&&he.removeLayer("census-variable-boundary"),he.getLayer("census-variable")&&he.removeLayer("census-variable"),he.getSource("census-variable")&&he.removeSource("census-variable"),he.addSource("census-variable",{type:"geojson",data:te(Qe)});let Ve;if(te(et)==="pct_imm")Ve=["step",["get",te(et)],Vi.pct_imm[0],10,Vi.pct_imm[1],20,Vi.pct_imm[2],30,Vi.pct_imm[3],40,Vi.pct_imm[4],50,Vi.pct_imm[5],60,Vi.pct_imm[6]];else if(te(et)==="pct_vm")Ve=["step",["get",te(et)],Vi.pct_vm[0],15,Vi.pct_vm[1],30,Vi.pct_vm[2],45,Vi.pct_vm[3],60,Vi.pct_vm[4],75,Vi.pct_vm[5],90,Vi.pct_vm[6]];else if(te(et)==="avg_hou_inc"){const nt=te(Qe).features.map(zt=>zt.properties.avg_hou_inc),Oe=Math.min(...nt),ft=Math.max(...nt),Yt=(ft-Oe)/6;Ve=["interpolate",["linear"],["get",te(et)],Oe,Vi.avg_hou_inc[0],Oe+Yt,Vi.avg_hou_inc[1],Oe+2*Yt,Vi.avg_hou_inc[2],Oe+3*Yt,Vi.avg_hou_inc[3],Oe+4*Yt,Vi.avg_hou_inc[4],Oe+5*Yt,Vi.avg_hou_inc[5],ft,Vi.avg_hou_inc[6]]}he.addLayer({id:"census-variable",type:"fill",source:"census-variable",paint:{"fill-color":Ve,"fill-opacity":.9}},"labels-layer"),he.addLayer({id:"census-variable-boundary",type:"line",source:"census-variable",paint:{"line-color":"#ffffff","line-width":["case",["boolean",["feature-state","hover"],!1],3,.5]}},"labels-layer")}function gt(Ve,nt){const ft=(Ve===oe?["party-vote-share"]:["census-variable"]).filter(zt=>Ve.getLayer(zt));if(ft.length===0)return;const Yt=Ve.queryRenderedFeatures(nt.point,{layers:ft});if(te($e)!==null&&(oe.getLayer("party-vote-share")&&oe.setFeatureState({source:"party-vote-share",id:te($e)},{hover:!1}),he.getLayer("census-variable")&&he.setFeatureState({source:"census-variable",id:te($e)},{hover:!1})),Yt.length>0){const zt=Yt[0];Pt($e,Jt(zt.id)),Pt(pt,Jt(zt.properties)),te(pt).name=zt.properties.geoname||"Unknown Riding",oe.getLayer("party-vote-share")&&oe.setFeatureState({source:"party-vote-share",id:te($e)},{hover:!0}),he.getLayer("census-variable")&&he.setFeatureState({source:"census-variable",id:te($e)},{hover:!0})}else Pt($e,null),Pt(pt,null)}os(()=>{te(Qe)&&(bt(),kt(),oe.on("mousemove",Ve=>gt(oe,Ve)),oe.on("mouseleave",()=>{te($e)!==null&&(oe.getLayer("party-vote-share")&&oe.setFeatureState({source:"party-vote-share",id:te($e)},{hover:!1}),he.getLayer("census-variable")&&he.setFeatureState({source:"census-variable",id:te($e)},{hover:!1}),Pt($e,null),Pt(pt,null))}),oe.on("click",Ve=>gt(oe,Ve)),he.on("mousemove",Ve=>gt(he,Ve)),he.on("mouseleave",()=>{te($e)!==null&&(oe.getLayer("party-vote-share")&&oe.setFeatureState({source:"party-vote-share",id:te($e)},{hover:!1}),he.getLayer("census-variable")&&he.setFeatureState({source:"census-variable",id:te($e)},{hover:!1}),Pt($e,null),Pt(pt,null))}),he.on("click",Ve=>gt(he,Ve)))}),Cu(()=>{oe=new vo.Map({container:"map1",...Ee}),oe.addControl(new vo.NavigationControl(Ae),"top-right"),oe.addControl(new vo.ScaleControl(I),"bottom-left"),he=new vo.Map({container:"map2",...Ee}),he.addControl(new vo.NavigationControl(Ae),"top-right"),he.addControl(new vo.ScaleControl(I),"bottom-left"),tt(oe,he),tt(he,oe),oe.on("load",()=>{Ue(oe,xt)}),he.on("load",()=>{Ue(he)})});var Vt=Kg(),Mt=ia(Vt),ai=Xe(Mt),Li=Xe(ai),Tt=vt(Xe(Li));Tt.__change=[Dg,He,xt],na(Tt,21,()=>te(je),ka,(Ve,nt)=>{var Oe=Fg(),ft={},Yt=Xe(Oe,!0);Ne(Oe),wi(()=>{ft!==(ft=te(nt))&&(Oe.value=(Oe.__value=te(nt))==null?"":te(nt)),ra(Oe,te(nt)===te(He)),vi(Yt,te(nt))}),Ft(Ve,Oe)}),Ne(Tt);var Qt=vt(Tt,2);Qt.__change=[zg,c,je,He,xt];var Ti=Xe(Qt);Ti.value=(Ti.__value="federal")==null?"":"federal";var ei=vt(Ti);ei.value=(ei.__value="ontario")==null?"":"ontario",Ne(Qt);var Kt=vt(Qt,2);Kt.__change=[Rg,Y,bt],na(Kt,21,()=>te(Pe),ka,(Ve,nt)=>{var Oe=Bg(),ft={},Yt=Xe(Oe,!0);Ne(Oe),wi(()=>{ft!==(ft=te(nt).tag)&&(Oe.value=(Oe.__value=te(nt).tag)==null?"":te(nt).tag),ra(Oe,te(nt).tag===te(Y)),vi(Yt,te(nt).name)}),Ft(Ve,Oe)}),Ne(Kt);var Wt=vt(Kt,2);Wt.__change=[Lg,et,kt],na(Wt,21,()=>te(st),ka,(Ve,nt)=>{var Oe=Og(),ft={},Yt=Xe(Oe,!0);Ne(Oe),wi(zt=>{ft!==(ft=te(nt).propertyTag)&&(Oe.value=(Oe.__value=te(nt).propertyTag)==null?"":te(nt).propertyTag),ra(Oe,te(nt).propertyTag===te(et)),vi(Yt,zt)},[()=>te(nt).name.toLowerCase()]),Ft(Ve,Oe)}),Ne(Wt),dr(),Ne(Li),Ne(ai),Ne(Mt);var Ge=vt(Mt,2),lt=Xe(Ge),St=Xe(lt);const Zt=Pr(()=>te(Be)());Cp(St,{get title(){return`% voted for ${te(Zt)??""}`},get colors(){return Aa[te(Y)]},labels:Ze}),dr(2),Ne(lt);var ti=vt(lt,2),_r=Xe(ti);const xi=Pr(()=>te(et)==="pct_imm"?"% Immigrants":te(et)==="pct_vm"?"% Visible minority":te(et)==="avg_hou_inc"?"Average household income":null);Cp(_r,{get title(){return te(xi)},get colors(){return Vi[te(et)]},get labels(){return te(jt)}}),dr(2),Ne(ti),Ne(Ge);var li=vt(Ge,2),Fi=Xe(li),ci=Xe(Fi);{var Mr=Ve=>{var nt=jg(),Oe=Xe(nt),ft=Xe(Oe,!0);Ne(Oe),Ne(nt),wi(()=>vi(ft,te(pt).name)),Ft(Ve,nt)},qr=Ve=>{var nt=Vg();Ft(Ve,nt)};an(ci,Ve=>{te(pt)?Ve(Mr):Ve(qr,!1)})}Ne(Fi);var ir=vt(Fi,2),Hr=Xe(ir);{var Rr=Ve=>{var nt=ns(),Oe=ia(nt);{var ft=zt=>{var Ii=ns();const ki=Pr(()=>fn.find(hi=>hi.tag===te(Y)));var Sr=ia(Ii);{var Lr=hi=>{var se=Ng(),P=Xe(se),L=vt(P),O=Xe(L);Ne(L),Ne(se),wi((Z,K)=>{vi(P,`${Z??""} vote share = `),vi(O,`${K??""}%`)},[()=>te(Be)(),()=>te(pt)[te(ki).propertyTag].toFixed(1)]),Ft(hi,se)},mn=hi=>{var se=Zg(),P=Xe(se);dr(),Ne(se),wi(L=>vi(P,`${L??""} vote share = `),[()=>te(Be)()]),Ft(hi,se)};an(Sr,hi=>{te(pt)[te(ki).propertyTag]!==void 0?hi(Lr):hi(mn,!1)})}Ft(zt,Ii)},Yt=zt=>{var Ii=Ug(),ki=Xe(Ii);dr(),Ne(Ii),wi(Sr=>vi(ki,`${Sr??""} vote share = `),[()=>te(Be)()]),Ft(zt,Ii)};an(Oe,zt=>{te(pt)?zt(ft):zt(Yt,!1)})}Ft(Ve,nt)};an(Hr,Ve=>{fn&&Ve(Rr)})}Ne(ir);var pr=vt(ir,2),fr=Xe(pr);{var Wr=Ve=>{var nt=ns(),Oe=ia(nt);{var ft=zt=>{var Ii=ns();const ki=Pr(()=>te(st).find(hi=>hi.propertyTag===te(et)));var Sr=ia(Ii);{var Lr=hi=>{var se=ns();const P=Pr(()=>te(pt)[te(et)]);var L=ia(se);{var O=K=>{var ne=$g(),ue=Xe(ne),re=vt(ue),ye=Xe(re);Ne(re),Ne(ne),wi(me=>{vi(ue,`${te(ki).name??""} = `),vi(ye,`${me??""}%`)},[()=>te(P).toFixed(1)]),Ft(K,ne)},Z=K=>{var ne=ns(),ue=ia(ne);{var re=me=>{var le=Gg(),Me=Xe(le),ce=vt(Me),Fe=Xe(ce);Ne(ce),Ne(le),wi(Ke=>{vi(Me,`${te(ki).name??""} = `),vi(Fe,`$${Ke??""}K`)},[()=>Math.round(te(P)/1e3)]),Ft(me,le)},ye=me=>{var le=ns(),Me=ia(le);{var ce=Ke=>{var _t=qg(),ut=Xe(_t),be=vt(ut),Je=Xe(be);Ne(be),Ne(_t),wi(We=>{vi(ut,`${te(ki).name??""} = `),vi(Je,`${We??""}%`)},[()=>te(P).toFixed(1)]),Ft(Ke,_t)},Fe=Ke=>{var _t=Hg(),ut=Xe(_t);dr(),Ne(_t),wi(()=>vi(ut,`${te(ki).name??""} = `)),Ft(Ke,_t)};an(Me,Ke=>{te(et)==="pct_vm"?Ke(ce):Ke(Fe,!1)},!0)}Ft(me,le)};an(ue,me=>{te(et)==="avg_hou_inc"?me(re):me(ye,!1)},!0)}Ft(K,ne)};an(L,K=>{te(et)==="pct_imm"?K(O):K(Z,!1)})}Ft(hi,se)},mn=hi=>{var se=Wg(),P=Xe(se);dr(),Ne(se),wi(()=>vi(P,`${te(ki).name??""} = `)),Ft(hi,se)};an(Sr,hi=>{te(pt)[te(et)]!==void 0?hi(Lr):hi(mn,!1)})}Ft(zt,Ii)},Yt=zt=>{var Ii=Xg();const ki=Pr(()=>te(st).find(Lr=>Lr.propertyTag===te(et)));var Sr=Xe(Ii);dr(),Ne(Ii),wi(()=>vi(Sr,`${te(ki).name??""} = `)),Ft(zt,Ii)};an(Oe,zt=>{te(pt)?zt(ft):zt(Yt,!1)})}Ft(Ve,nt)};an(fr,Ve=>{te(st)&&Ve(Wr)})}Ne(pr),Ne(li),wi(()=>{ra(Ti,te(c)==="federal"),ra(ei,te(c)==="ontario")}),ss(Tt,()=>te(He),Ve=>Pt(He,Ve)),ss(Qt,()=>te(c),Ve=>Pt(c,Ve)),ss(Kt,()=>te(Y),Ve=>Pt(Y,Ve)),ss(Wt,()=>te(et),Ve=>Pt(et,Ve)),Ft(H,Vt),cs()}ah(["change"]);function Jg(H,ae,oe,he,Ee,Ae){Pt(ae,Jt(H.target.value)),Pt(oe,Jt(te(ae)==="federal"?zp:sh)),Pt(he,Jt(te(oe)[te(oe).length-1])),Ee(),Ae()}function Qg(H,ae,oe,he){Pt(ae,Jt(parseInt(H.target.value))),oe(),he()}function e_(H,ae,oe,he){Pt(ae,Jt(H.target.value)),oe(),he()}var t_=ii("<option> </option>"),i_=ii("<option> </option>"),r_=ii("<p><b> </b></p>"),n_=ii("<p><i>Hover/click on a point</i></p>"),a_=ii("<p>Vote share = <b> </b></p>"),s_=ii("<p>Vote share = <b>N/A</b></p>"),o_=ii("<p>Percent immigrants = <b> </b></p>"),l_=ii("<p>Percent immigrants = <b>N/A</b></p>"),c_=ii('<div style="margin-bottom: 0px; margin-top: -25px;"><div class="sentence-controls"><p>View the correlation between percent immigrants and party vote share for the <select class="inline-select"></select> in the <select class="inline-select"></select> <select class="inline-select"><option>federal</option><option>Ontario</option></select> election.</p></div> <div id="scatter-display" class="svelte-12ft76x"></div> <div><div class="info-row" style="border-top: solid 1px #f0f0f0;"><!></div> <div class="info-row"><!></div> <div class="info-row"><!></div></div></div>');function h_(H,ae){ls(ae,!0);let oe=Ai("ontario"),he=Pr(()=>Hp(te(oe))),Ee=Ai(Jt(sh)),Ae=Ai(2025),I=Ai(null),c=Pr(()=>Wp(te(I))),ke=Ai("cons1"),He=Ai(0),je=Ai(null),Qe=Ai(400);function Pe(){const Ge=`/gta-immigration/data/elections/${te(he)}_stats_${te(Ae)}.geojson`;fetch(Ge).then(lt=>lt.json()).then(lt=>{Pt(I,Jt(lt)),Y(),Be()})}function Y(){te(I)&&te(I).features.length>0&&(te(c).some(Ge=>Ge.tag===te(ke))||Pt(ke,Jt(te(c).length>0?te(c)[0].tag:null)))}function Be(){oh("/gta-immigration/data/elections_analysis/ed_corrs.csv").then(Ge=>{const lt=`corr_pct_imm_${te(ke)}`,St=Ge.find(Zt=>Zt.year===te(Ae).toString()&&Zt.region===te(oe));St&&St[lt]?Pt(He,Jt(parseFloat(St[lt]))):Pt(He,0),pt()}).catch(Ge=>{console.error("Error loading CSV file:",Ge),Pt(He,0)})}function st(){Pt(je,null)}function et(Ge){Ge.attr("r",5).attr("stroke","#000000").attr("stroke-width",0).attr("fill",Rn[te(ke)])}function $e(Ge){Ge.attr("r",6).attr("stroke","#000000").attr("stroke-width",2)}function pt(){if(!te(I))return;const Ge=fn.find(Oe=>Oe.tag===te(ke)).propertyTag,lt=te(I).features.map(Oe=>({x:Oe.properties.pct_imm,y:Oe.properties[Ge],geoname:Oe.properties.geoname})),St=pn("#scatter-display");St.html("");const Zt={top:20,right:20,bottom:60,left:60},ti=Math.min(700,St.node().getBoundingClientRect().width),_r=ti-Zt.left-Zt.right,xi=450-Zt.top-Zt.bottom,li=St.append("svg").attr("width",ti).attr("height",500).attr("viewBox",`0 0 ${ti} 500`).attr("preserveAspectRatio","xMinYMin meet"),Fi=li.append("g").attr("transform",`translate(${Zt.left},${Zt.top})`),ci=rh().domain([0,70]).range([0,_r]),Mr=rh().domain([0,80]).range([xi,0]),qr=Oe=>Oe.attr("transform",`translate(0,${xi})`).call(Iu(ci).ticks(7)).call(ft=>ft.select(".domain").remove()).call(ft=>ft.selectAll(".tick line").clone().attr("y2",-370).attr("stroke","#D0D1C9").attr("stroke-width",1).attr("stroke-opacity",.1)).call(ft=>ft.selectAll(".tick line").attr("stroke","#000000")).call(ft=>ft.selectAll(".tick text").attr("fill","#000000")).append("text").attr("x",_r/2-14).attr("y",40).attr("fill","#000000").attr("text-anchor","middle").text("Percentage of immigrants (%)").style("font-size","13px").style("font-family","RobotoRegular"),ir=Oe=>Oe.attr("transform","translate(0,0)").call(Eu(Mr).ticks(8)).call(ft=>ft.select(".domain").remove()).call(ft=>ft.selectAll(".tick line").clone().attr("x2",_r).attr("stroke","#ccc").attr("stroke-width",1).attr("stroke-opacity",.1)).call(ft=>ft.selectAll(".tick line").attr("stroke","#000000")).call(ft=>ft.selectAll(".tick text").attr("fill","#000000")).append("text").attr("x",-370/2).attr("y",-40).attr("fill","#000000").attr("text-anchor","middle").attr("transform","rotate(-90)").text("Party vote share (%)").style("font-size","13px").style("font-family","RobotoRegular");Fi.append("g").call(qr),Fi.append("g").call(ir),Fi.append("g").attr("stroke","#000000").attr("stroke-width",0).selectAll(".scatter-correlation-dot").data(lt).join("circle").attr("class","scatter-correlation-dot").attr("cx",Oe=>ci(Oe.x)).attr("cy",Oe=>Mr(Oe.y)).attr("r",5).attr("fill",Rn[te(ke)]).on("mouseover",(Oe,ft)=>{Oe.stopPropagation(),Pt(je,Jt(ft)),pn("#scatter-display").selectAll("circle").each(function(){et(pn(this))}),$e(pn(Oe.target))}).on("mouseout",(Oe,ft)=>{Oe.stopPropagation(),te(je)&&te(je).geoname===ft.geoname&&Oe.target.__data__===te(je)&&(Pt(je,null),et(pn(Oe.target)))}).on("click",(Oe,ft)=>{Oe.stopPropagation(),Pt(je,Jt(ft)),pn("#scatter-display").selectAll("circle").each(function(){et(pn(this))}),$e(pn(Oe.target))}),li.on("click",Oe=>{Oe.target.classList.contains("scatter-correlation-dot")||(Pt(je,null),pn("#scatter-display").selectAll("circle").each(function(){et(pn(this))}))});const Rr=Au().x(Oe=>ci(Oe.x)).y(Oe=>Mr(Oe.y)),pr=_p(lt,Oe=>Oe.x),fr=_p(lt,Oe=>Oe.y),Wr=te(He)*(yp(lt,Oe=>Oe.y)/yp(lt,Oe=>Oe.x)),Ve=fr-Wr*pr,nt=[{x:0,y:Ve},{x:70,y:Ve+Wr*70}];Fi.append("path").datum(nt).attr("fill","none").attr("stroke","#000000").attr("stroke-width",1.5).attr("stroke-dasharray","8,2").attr("d",Rr)}os(()=>{te(Qe),pt()}),Cu(()=>{Pe()});var jt=c_(),Ze=Xe(jt),wt=Xe(Ze),tt=vt(Xe(wt));tt.__change=[e_,ke,st,Be],na(tt,21,()=>te(c),ka,(Ge,lt)=>{var St=t_(),Zt={},ti=Xe(St,!0);Ne(St),wi(()=>{Zt!==(Zt=te(lt).tag)&&(St.value=(St.__value=te(lt).tag)==null?"":te(lt).tag),ra(St,te(lt).tag===te(ke)),vi(ti,te(lt).name)}),Ft(Ge,St)}),Ne(tt);var Ue=vt(tt,2);Ue.__change=[Qg,Ae,st,Pe],na(Ue,21,()=>te(Ee),ka,(Ge,lt)=>{var St=i_(),Zt={},ti=Xe(St,!0);Ne(St),wi(()=>{Zt!==(Zt=te(lt))&&(St.value=(St.__value=te(lt))==null?"":te(lt)),ra(St,te(lt)===te(Ae)),vi(ti,te(lt))}),Ft(Ge,St)}),Ne(Ue);var xt=vt(Ue,2);xt.__change=[Jg,oe,Ee,Ae,st,Pe];var Dt=Xe(xt);Dt.value=(Dt.__value="federal")==null?"":"federal";var Bt=vt(Dt);Bt.value=(Bt.__value="ontario")==null?"":"ontario",Ne(xt),dr(),Ne(wt),Ne(Ze);var Rt=vt(Ze,2),bt=vt(Rt,2),kt=Xe(bt),gt=Xe(kt);{var Vt=Ge=>{var lt=r_(),St=Xe(lt),Zt=Xe(St,!0);Ne(St),Ne(lt),wi(()=>vi(Zt,te(je).geoname)),Ft(Ge,lt)},Mt=Ge=>{var lt=n_();Ft(Ge,lt)};an(gt,Ge=>{te(je)?Ge(Vt):Ge(Mt,!1)})}Ne(kt);var ai=vt(kt,2),Li=Xe(ai);{var Tt=Ge=>{var lt=a_(),St=vt(Xe(lt)),Zt=Xe(St);Ne(St),Ne(lt),wi(ti=>vi(Zt,`${ti??""}%`),[()=>te(je).y.toFixed(1)]),Ft(Ge,lt)},Qt=Ge=>{var lt=s_();Ft(Ge,lt)};an(Li,Ge=>{te(je)?Ge(Tt):Ge(Qt,!1)})}Ne(ai);var Ti=vt(ai,2),ei=Xe(Ti);{var Kt=Ge=>{var lt=o_(),St=vt(Xe(lt)),Zt=Xe(St);Ne(St),Ne(lt),wi(ti=>vi(Zt,`${ti??""}%`),[()=>te(je).x.toFixed(1)]),Ft(Ge,lt)},Wt=Ge=>{var lt=l_();Ft(Ge,lt)};an(ei,Ge=>{te(je)?Ge(Kt):Ge(Wt,!1)})}Ne(Ti),Ne(bt),Ne(jt),wi(()=>{ra(Dt,te(oe)==="federal"),ra(Bt,te(oe)==="ontario")}),ss(tt,()=>te(ke),Ge=>Pt(ke,Ge)),ss(Ue,()=>te(Ae),Ge=>Pt(Ae,Ge)),ss(xt,()=>te(oe),Ge=>Pt(oe,Ge)),Dp(Rt,"clientWidth",Ge=>Pt(Qe,Ge)),Ft(H,jt),cs()}ah(["change"]);function u_(H,ae){Pt(ae,Jt(H.target.value))}var d_=ii('<div style="margin-bottom: -20px; margin-top: -25px;"><div class="sentence-controls"><p>The plot below traces the correlation between party vote share and percentage of immigrants in each riding, for all <select class="inline-select"><option>federal</option><option selected>Ontario</option></select> elections. The closer to +1, the more likely a party is to receive votes in ridings with more immigrants.</p></div> <svg id="correlation-line-graph" height="400" class="svelte-eyvz4j"></svg></div>');function p_(H,ae){ls(ae,!0);const oe=fn.filter(st=>st.name!=="Reform/Alliance");let he=Ai("ontario"),Ee=Ai(Jt({Liberals:[],Conservatives:[],"New Democrats":[]})),Ae=Ai(0);os(()=>{Pt(Ae,Jt(window.innerWidth));const st=()=>Pt(Ae,Jt(window.innerWidth));return window.addEventListener("resize",st),()=>{window.removeEventListener("resize",st)}});function I(){oh("/gta-immigration/data/elections_analysis/ed_corrs.csv").then(st=>{const et=st.filter($e=>$e.region===te(he));Pt(Ee,Jt({Liberals:et.map($e=>[parseInt($e.year),parseFloat($e.corr_pct_imm_lib)]),Conservatives:et.map($e=>[parseInt($e.year),parseFloat($e.corr_pct_imm_cons1)]),"New Democrats":et.map($e=>[parseInt($e.year),parseFloat($e.corr_pct_imm_ndp)])}))}).catch(st=>{console.error("Error loading or processing CSV data:",st)})}function c(st,et){let $e,pt,jt="start";return et==="ontario"?st==="Liberals"?($e=5,pt=-5):st==="New Democrats"?($e=5,pt=0):st==="Conservatives"&&($e=5,pt=10):st==="Liberals"?($e=-20,pt=-5):st==="New Democrats"?($e=5,pt=-5):st==="Conservatives"&&($e=5,pt=10),{dx:$e,dy:pt,textAnchor:jt}}function ke(){const st=pn("#correlation-line-graph");st.selectAll("*").remove();const et=st.node().parentElement.getBoundingClientRect().width||700,$e={top:20,right:et<=700?40:30,bottom:50,left:60},pt=Math.min(et,700)-$e.left-$e.right,jt=400-$e.top-$e.bottom;st.attr("width",pt+$e.left+$e.right).attr("height",jt+$e.top+$e.bottom);const Ze=st.append("g").attr("transform",`translate(${$e.left},${$e.top})`),wt=[];Object.values(te(Ee)).forEach(gt=>{gt.forEach(Vt=>{wt.includes(Vt[0])||wt.push(Vt[0])})}),wt.sort();const tt=Up().domain(wt).range([0,pt]),Ue=rh().domain([-.98,.98]).range([jt,0]);Ze.selectAll(".x-grid-line").data(wt).enter().append("line").attr("class","x-grid-line").attr("x1",gt=>tt(gt)).attr("x2",gt=>tt(gt)).attr("y1",0).attr("y2",jt).attr("stroke","#d3d3d3").attr("stroke-width",.5),Ze.selectAll(".y-grid-line").data([-.75,-.5,-.25,0,.25,.5,.75]).enter().append("line").attr("class","y-grid-line").attr("x1",0).attr("x2",pt).attr("y1",gt=>Ue(gt)).attr("y2",gt=>Ue(gt)).attr("stroke","#d3d3d3").attr("stroke-width",.5);const xt=Ze.append("g").attr("transform",`translate(0,${jt})`).call(Iu(tt).tickFormat(Rp("d")).tickSize(0));xt.select(".domain").remove(),et<=700&&xt.selectAll(".tick").append("line").attr("class","x-tick-line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",6).attr("stroke","#d3d3d3").attr("stroke-width",.5),xt.selectAll("text").style("font-size","11px").style("font-family","RobotoRegular").style("text-anchor",et<=700?"end":"middle").attr("dx",et<=700?"-0.5em":"0").attr("dy",et<=700?"1.2em":"0.71em").attr("transform",et<=700?"rotate(-45)":"rotate(0)"),Ze.append("g").attr("transform","translate(-5,0)").call(Eu(Ue).tickValues([-.75,-.5,-.25,0,.25,.5,.75]).tickFormat(gt=>gt.toFixed(2)).tickSize(0)).select(".domain").remove().selectAll("text").attr("fill","#666").style("font-size","11px").style("font-family","RobotoRegular"),Ze.append("text").attr("transform","rotate(-90)").attr("y",-50).attr("x",-330/2).attr("dy","0.71em").attr("text-anchor","middle").style("font-size","13px").style("font-family","RobotoRegular").text("Correlation"),Ze.append("line").attr("x1",0).attr("x2",pt).attr("y1",Ue(0)).attr("y2",Ue(0)).attr("stroke","#D0D1C9").attr("stroke-width",2),st.append("defs").append("marker").attr("id","arrowhead").attr("viewBox","0 -5 10 10").attr("refX",5).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill","black");const Bt=te(Ae)<=700?10:20,Rt=15,bt=8;Ze.append("line").attr("x1",Bt).attr("x2",Bt).attr("y1",Ue(.2)).attr("y2",Ue(.95)).attr("stroke","black").attr("stroke-width",1).attr("marker-end","url(#arrowhead)"),Ze.append("text").attr("x",Bt+bt).attr("y",Ue(.85)).attr("dy","0").style("font-size","14px").style("font-family","RobotoRegular").text("More votes where"),Ze.append("text").attr("x",Bt+bt).attr("y",Ue(.85)).attr("dy",Rt+"px").style("font-size","14px").style("font-family","RobotoRegular").text("immigrants live"),Ze.append("line").attr("x1",Bt).attr("x2",Bt).attr("y1",Ue(-.2)).attr("y2",Ue(-.9)).attr("stroke","black").attr("stroke-width",1).attr("marker-end","url(#arrowhead)"),Ze.append("text").attr("x",Bt+bt).attr("y",Ue(-.82)).attr("dy","0").style("font-size","14px").style("font-family","RobotoRegular").text("Fewer votes where"),Ze.append("text").attr("x",Bt+bt).attr("y",Ue(-.82)).attr("dy",Rt+"px").style("font-size","14px").style("font-family","RobotoRegular").text("immigrants live");const kt=Au().x(gt=>tt(gt[0])).y(gt=>Ue(gt[1])).curve(Gp);oe.forEach(gt=>{const Vt=te(Ee)[gt.name];if(!Vt||Vt.length===0)return;Ze.append("path").datum(Vt).attr("fill","none").attr("stroke",Rn[gt.tag]).attr("stroke-width",1.5).attr("d",kt),Ze.selectAll(`.timeline-correlation-dot-${gt.tag}`).data(Vt).enter().append("circle").attr("class",`timeline-correlation-dot-${gt.tag}`).attr("r",3.5).attr("cx",ai=>tt(ai[0])).attr("cy",ai=>Ue(ai[1])).attr("fill",Rn[gt.tag]);const Mt=te(he)==="ontario"?9:12;if(Vt.length>Mt){const ai=Vt[Mt],Li=tt(ai[0]),Tt=Ue(ai[1]),{dx:Qt,dy:Ti,textAnchor:ei}=c(gt.name,te(he));Ze.append("text").attr("x",Li).attr("y",Tt).attr("dx",Qt).attr("dy",Ti).attr("text-anchor",ei).style("font-size","14px").style("font-family","RobotoRegular").style("fill",Rn[gt.tag]).style("stroke","white").style("stroke-width","4px").text(gt.name),Ze.append("text").attr("x",Li).attr("y",Tt).attr("dx",Qt).attr("dy",Ti).attr("text-anchor",ei).style("font-size","14px").style("font-family","RobotoRegular").style("fill",Rn[gt.tag]).text(gt.name)}})}os(()=>{te(Ee),te(Ae),ke()}),os(()=>{te(he),I()});var He=d_(),je=Xe(He),Qe=Xe(je),Pe=vt(Xe(Qe));Pe.__change=[u_,he];var Y=Xe(Pe);Y.value=(Y.__value="federal")==null?"":"federal";var Be=vt(Y);Be.value=(Be.__value="ontario")==null?"":"ontario",Ne(Pe),dr(),Ne(Qe),Ne(je),dr(2),Ne(He),Ft(H,He),cs()}ah(["change"]);function f_(H,ae){Pt(ae,Jt(H.target.value))}function m_(H,ae){Pt(ae,Jt(H.target.value))}var g_=ii('<div style="margin-bottom: -20px; margin-top: -25px;"><div class="sentence-controls"><p>Show how the major parties perform in the top 5 most immigrant ridings over time for <select class="inline-select"><option>federal</option><option selected>Ontario</option></select> elections, compared to their performance in the <select class="inline-select"><option>GTA</option><option selected>full</option></select> </p></div> <svg id="vote-share-graph" height="400" class="svelte-1c1gea3"></svg></div>');function __(H,ae){ls(ae,!0);const oe=fn.filter(Ze=>Ze.name!=="Reform/Alliance");let he=Ai("ontario"),Ee=Ai("full"),Ae=Ai(Jt({Liberals:[],Conservatives:[],"New Democrats":[]})),I=Ai(400);function c(Ze,wt){let tt,Ue,xt="start";return wt==="ontario"?Ze==="Liberals"||Ze==="New Democrats"?(tt=5,Ue=5):Ze==="Conservatives"&&(tt=5,Ue=10):Ze==="Liberals"?(tt=5,Ue=10):Ze==="New Democrats"?(tt=5,Ue=-5):Ze==="Conservatives"&&(tt=5,Ue=10),{dx:tt,dy:Ue,textAnchor:xt}}function ke(){oh("/gta-immigration/data/elections_analysis/ed_top_5_imm_results.csv").then(wt=>{const tt={Liberals:[],Conservatives:[],"New Democrats":[]};oe.forEach(Ue=>{const xt=wt.filter(Rt=>Rt.region===te(he)&&Rt.party===Ue.tag),Dt=[];new Set(xt.map(Rt=>Rt.year)).forEach(Rt=>{xt.filter(kt=>kt.year===Rt).forEach(kt=>{const gt=parseFloat(kt.top_5_imm_pct),Vt=te(Ee)==="gta"?parseFloat(kt.gta_pct):parseFloat(kt.full_pct);!isNaN(gt)&&!isNaN(Vt)&&Dt.push([parseFloat(Rt),gt,Vt])})}),tt[Ue.name]=Dt}),Pt(Ae,Jt(tt))}).catch(wt=>{console.error("Error parsing CSV:",wt)})}function He(){const Ze=pn("#vote-share-graph");Ze.selectAll("*").remove();const wt=Ze.node().parentElement.getBoundingClientRect().width||700,tt={top:20,right:wt<=700?40:30,bottom:50,left:60},Ue=Math.min(wt,700)-tt.left-tt.right,xt=400-tt.top-tt.bottom;Ze.attr("width",Ue+tt.left+tt.right).attr("height",xt+tt.top+tt.bottom);const Dt=Ze.append("g").attr("transform",`translate(${tt.left},${tt.top})`),Bt=[];Object.values(te(Ae)).forEach(Tt=>{Tt.forEach(Qt=>{Bt.includes(Qt[0])||Bt.push(Qt[0])})}),Bt.sort();const Rt=Up().domain(Bt).range([0,Ue]),bt=rh().domain([-30,33]).range([xt,0]);Dt.selectAll(".x-grid-line").data(Bt).enter().append("line").attr("class","x-grid-line").attr("x1",Tt=>Rt(Tt)).attr("x2",Tt=>Rt(Tt)).attr("y1",0).attr("y2",xt).attr("stroke","#d3d3d3").attr("stroke-width",.5),Dt.selectAll(".y-grid-line").data(Bp(-30,31,10)).enter().append("line").attr("class","y-grid-line").attr("x1",0).attr("x2",Ue).attr("y1",Tt=>bt(Tt)).attr("y2",Tt=>bt(Tt)).attr("stroke","#d3d3d3").attr("stroke-width",.5);const kt=Dt.append("g").attr("transform",`translate(0,${xt})`).call(Iu(Rt).tickFormat(Rp("d")).tickSize(0));kt.select(".domain").remove(),wt<=700&&kt.selectAll(".tick").append("line").attr("class","x-tick-line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",6).attr("stroke","#d3d3d3").attr("stroke-width",.5),kt.selectAll("text").style("font-size","11px").style("font-family","RobotoRegular").style("text-anchor",wt<=700?"end":"middle").attr("dx",wt<=700?"-0.5em":"0").attr("dy",wt<=700?"1.2em":"0.71em").attr("transform",wt<=700?"rotate(-45)":"rotate(0)"),Dt.append("g").attr("transform","translate(-5,0)").call(Eu(bt).ticks(6).tickFormat(Tt=>Tt+"%").tickSize(0)).select(".domain").remove().selectAll("text").attr("fill","#666").style("font-size","11px").style("font-family","RobotoRegular"),Dt.append("text").attr("transform","rotate(-90)").attr("y",-50).attr("x",-330/2).attr("dy","0.71em").attr("text-anchor","middle").style("font-size","13px").style("font-family","RobotoRegular").text("Vote share difference"),Dt.append("line").attr("x1",0).attr("x2",Ue).attr("y1",bt(0)).attr("y2",bt(0)).attr("stroke","#D0D1C9").attr("stroke-width",2),Ze.append("defs").append("marker").attr("id","arrowhead").attr("viewBox","0 -5 10 10").attr("refX",5).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill","black");const Vt=te(I)<=700?10:20,Mt=15,ai=8;Dt.append("line").attr("x1",Vt).attr("x2",Vt).attr("y1",bt(5)).attr("y2",bt(30)).attr("stroke","black").attr("stroke-width",1).attr("marker-end","url(#arrowhead)"),Dt.append("text").attr("x",Vt+ai).attr("y",bt(28)).attr("dy","0").style("font-size","14px").style("font-family","RobotoRegular").text("Overperforming in"),Dt.append("text").attr("x",Vt+ai).attr("y",bt(28)).attr("dy",Mt+"px").style("font-size","14px").style("font-family","RobotoRegular").text("high-immigrant ridings"),Dt.append("line").attr("x1",Vt).attr("x2",Vt).attr("y1",bt(-5)).attr("y2",bt(-27)).attr("stroke","black").attr("stroke-width",1).attr("marker-end","url(#arrowhead)"),Dt.append("text").attr("x",Vt+ai).attr("y",bt(-24)).attr("dy","0").style("font-size","14px").style("font-family","RobotoRegular").text("Underperforming in"),Dt.append("text").attr("x",Vt+ai).attr("y",bt(-24)).attr("dy",Mt+"px").style("font-size","14px").style("font-family","RobotoRegular").text("high-immigrant ridings");const Li=Au().x(Tt=>Rt(Tt[0])).y(Tt=>bt(Tt[1]-Tt[2])).curve(Gp);oe.forEach(Tt=>{const Qt=te(Ae)[Tt.name];if(!Qt||Qt.length===0)return;Dt.append("path").datum(Qt).attr("fill","none").attr("stroke",Rn[Tt.tag]).attr("stroke-width",1.5).attr("stroke-dasharray","5,1").attr("d",Li),Dt.selectAll(`vote-share-compare-dot-${Tt.tag}`).data(Qt).enter().append("circle").attr("class",`vote-share-compare-dot-${Tt.tag}`).attr("r",3.5).attr("cx",ei=>Rt(ei[0])).attr("cy",ei=>bt(ei[1]-ei[2])).attr("fill",Rn[Tt.tag]);const Ti=(te(he)==="ontario",9);if(Qt.length>Ti){const ei=Qt[Ti],Kt=Rt(ei[0]),Wt=bt(ei[1]-ei[2]),{dx:Ge,dy:lt,textAnchor:St}=c(Tt.name,te(he));Dt.append("text").attr("x",Kt).attr("y",Wt).attr("dx",Ge).attr("dy",lt).attr("text-anchor",St).style("font-size","14px").style("font-family","RobotoRegular").style("fill",Rn[Tt.tag]).style("stroke","white").style("stroke-width","4px").text(Tt.name),Dt.append("text").attr("x",Kt).attr("y",Wt).attr("dx",Ge).attr("dy",lt).attr("text-anchor",St).style("font-size","14px").style("font-family","RobotoRegular").style("fill",Rn[Tt.tag]).text(Tt.name)}})}os(()=>{te(Ae),te(I),He()}),os(()=>{te(he),te(Ee),ke()});var je=g_(),Qe=Xe(je),Pe=Xe(Qe),Y=vt(Xe(Pe));Y.__change=[f_,he];var Be=Xe(Y);Be.value=(Be.__value="federal")==null?"":"federal";var st=vt(Be);st.value=(st.__value="ontario")==null?"":"ontario",Ne(Y);var et=vt(Y,2);et.__change=[m_,Ee];var $e=Xe(et);$e.value=($e.__value="gta")==null?"":"gta";var pt=vt($e);pt.value=(pt.__value="full")==null?"":"full",Ne(et);var jt=vt(et);Ne(Pe),Ne(Qe),dr(2),Ne(je),wi(()=>vi(jt,` ${(te(Ee)==="gta"?"alone":"election")??""}.`)),Dp(je,"clientWidth",Ze=>Pt(I,Ze)),Ft(H,je),cs()}ah(["change"]);var y_=ii('<span class="footnote-ref-wrapper svelte-1di2uw2"><a class="footnote-ref svelte-1di2uw2"> </a></span>');function xo(H,ae){let oe=th(ae,"id",8),he=`footnote-${oe()}`,Ee=`footnote-ref-${oe()}`;var Ae=y_(),I=Xe(Ae);Tn(I,"id",Ee),Tn(I,"href",`#${he}`);var c=Xe(I,!0);Ne(I),Ne(Ae),wi(()=>vi(c,oe())),Ap("click",I,Fp(()=>{const ke=document.getElementById(he);ke&&ke.scrollIntoView({behavior:"auto",block:"start"})})),Ft(H,Ae)}var v_=ii('<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"> <meta name="description" content=""> <meta name="author" content="Aniket Kali, Serene Tan, &amp; Jeff Allen"> <meta property="og:title" content="Changes in immigrant voting patterns in the Greater Toronto Area"> <meta property="og:description" content="Immigrants in the GTA have had many political shifts across time and geography"> <meta property="og:type" content="website"> <meta property="og:url" content="https://schoolofcities.github.io/gta-immigration/political-shifts"> <meta property="og:image" content="https://schoolofcities.github.io/gta-immigration/web-card-political-shifts.png"> <meta property="og:locale" content="en_CA"> <meta name="twitter:site" content="https://schoolofcities.github.io/gta-immigration/political-shifts"> <meta name="twitter:creator" content="@UofTCities"> <meta name="twitter:title" content="Changes in immigrant voting patterns in the Greater Toronto Area"> <meta name="twitter:description" content="Immigrants in the GTA have had many political shifts across time and geography"> <meta name="twitter:image" content="https://schoolofcities.github.io/gta-immigration/web-card-political-shifts.png">',1),x_=ii('<div class="footnote-item svelte-bso480"><sup class="svelte-bso480"> </sup> <p style="display:inline"><!></p> <a class="backlink svelte-bso480">↩</a></div>'),b_=ii(`<main><!> <div class="title"><div style="display: flex; width: 100%;"><div style="flex: 1; height: 10px; background-color: #EBA00F;"></div> <div style="flex: 1; height: 10px; background-color: #DC4633; margin-top: -5px;"></div> <div style="flex: 1; height: 10px; background-color: #F1C500; margin-top: 0px;"></div> <div style="flex: 1; height: 10px; background-color: #007FA3; margin-top: -5px;"></div> <div style="flex: 1; height: 10px; background-color: #00A189;"></div></div> <h1>Changes in immigrant voting patterns in the Greater Toronto Area</h1> <p><a href="https://www.linkedin.com/in/aniket-k-8a8b9921b/" target="_blank">Aniket Kali</a>, <a href="https://www.linkedin.com/in/serene-tan-530239113" target="_blank">Serene Tan</a>, <a href="https://jamaps.github.io/" target="_blank">Jeff Allen</a> |
            April 2025</p></div> <div class="text"><p><em>NOTE: We wrote and published this article prior to the 2025 federal election. We've since added the data for that election, which shows a shift to the right in immigrant-heavy ridings – consistent with trends we found. For simplicity, we've kept the article text as it was, but the data is available for you to explore.</em></p> <p>Immigrant-heavy ridings across the Greater Toronto Area (GTA) have swung from being decisively against to decisively for the provincial Conservatives over these last 30 years. It's part of the trend we're seeing across North America where <a href="https://www.ft.com/content/a7607626-5491-48bd-aa56-5a10cbeeb768" target="_blank">immigrants</a> and <a href="https://theconversation.com/why-are-so-many-second-generation-south-asian-and-chinese-canadians-planning-to-vote-conservative-253820" target="_blank">minorities</a> are swinging to the political right; and it's also a story of how one of the GTA's largest constituencies is much more dynamic than we often realize.</p></div> <!> <div class="text"><p>Since the late twentieth century, researchers have noted the changing demographics in Canada's suburbs, particularly in terms of ethnicity and immigrant status.<!> In the Greater Toronto Area, the share of immigrants in the inner suburbs (Etobicoke, North York, Scarborough) has grown since the 1970s, and in the outer suburbs (Halton, Peel, York, and Durham) since the 1990s, while declining in the inner city region (City of Toronto) at the same time.<!> Additionally, since <a href="https://www.justice.gc.ca/eng/rp-pr/csj-sjc/jsp-sjp/rp02_8-dr02_8/p3.html" target="_blank">immigration reform in 1967</a> – which abolished race and nationality quotas in favour of a point-based system – immigrants have increasingly been visible minorities.<!></p> <p>How has this changing composition played out in the political and electoral landscape of the GTA?</p></div> <div class="text"><h2>Does party vote share correspond to where immigrants live?</h2> <p>In 2018, the provincial Conservatives pulled off a historic feat: immigrant-heavy ridings were more likely than not to vote for them. Neither the provincial nor federal Conservatives had pulled this off in the time we reviewed in this study – looking at census data since 1961 – and certainly not since the official end of race-based immigration quotas in 1967.</p></div> <div class="container"><!></div> <div class="text"><p>The fact is that as immigrants have begun to grow as a political constituency, political parties have made a concerted effort to win them over for about the past 40 years.<!> In ridings dominated by specific immigrant and ethnic groups, it can be a political strategy to actively target messages at ethno-religious communities, run candidates who represent specific ethnic groups, and use ethnic media outlets to reach groups of people through their collective identities.</p> <p>These efforts are a competition, and we see that in how different parties have risen and fallen in their popularity in immigrant-heavy ridings.</p> <h4>Federal</h4> <p>In 1971, the federal Liberals, under Prime Minister Pierre Elliott Trudeau, announced multiculturalism as official Canadian policy. While the federal Liberals had always performed well in immigrant-heavy ridings, their popularity rose steeply from the 1972 election onwards, to reach all-time highs for four decades before starting to fall in the 2010s.</p> <p>While the Liberals still reigned supreme federally, the federal Conservatives became much more competitive in immigrant-heavy ridings beginning in the early 2000s. This may coincide with federal Conservative leader and Prime Minister Stephen Harper's <a href="https://www.cicnews.com/2006/05/primeminister-stephen-harper-reaching-canadian-immigrants-0597.html#gs.l52rih" target="_blank">immigrant-friendly policies</a>.</p> <p>More recently, in a study funded by the School of Cities<!>, Professor Emine Fidan Elcioglu found many second generation immigrants had started voting Conservative as a way of assimilating – following years of outreach by the federal Conservatives into suburban and minority communities.</p> <p>The left-leaning New Democrats have, in contrast, seen a steep fall in popularity since 2004. The party has yet to recover and continues to decline in immigrant-heavy ridings.</p> <h4>Provincial</h4> <p>While Conservatives at both levels have seen rising support in recent decades in the ridings where immigrants live, there's one major difference: since 2018, Ontario's Conservatives have become the party of immigrants in the GTA. Unlike their federal counterpart, who has made gains but is still outcompeted by the Liberals, they have ranked or tied for first place in immigrant-heavy ridings in each election since.</p> <p>This is a remarkable shift from decades past, when more immigrants meant fewer votes for the Conservatives – reaching an all-time low as recently as 1995.</p> <p>Equally unlike the federal level, it was Ontario's New Democrats who were most popular in immigrant-heavy ridings throughout the 1970s and 80s, largely during the leaderships of Stephen Lewis and Bob Rae. They would be overshadowed by the provincial Liberals in 1987 (who, in turn, would dominate until 2018), but remained competitive in immigrant-heavy ridings until the early 2000s. Since then, they've seen a decline similar to their federal counterpart.</p> <p>Nonetheless, all the trends we see are in the big picture, and there are exceptions. The plots below show the fine details of the relationship between percent immigrants and party vote share for individual GTA ridings in each election: points further to the right indicate a higher percentage of immigrants in the riding, and points higher on the plot indicate a larger party vote share.</p></div> <div class="container"><!></div> <div class="text"><h2>How do different ridings compare geographically?</h2> <p>Toronto's suburbs have become the heart of immigration in the region - in Scarborough since the 1980s, and then later in Brampton, Markham, and Mississauga. By looking at how voting patterns have changed in these regions, we can understand these trends in detail.</p> <p>The maps below show (by riding) party vote share on the left, and census data on the right. Moving through the years, we can see the changes in where immigrants are and how that has played out geographically in their voting patterns.</p></div> <!> <div class="text"><p>The federal Liberals have seen their greatest successes in Scarborough, Mississauga, and North Etobicoke – corresponding to the shift of immigrants into Toronto's inner, and then outer, suburbs from the 1980s onward. This shift suggests the development of suburban immigrant strongholds – perhaps a result of the Liberals’ welcoming immigration policies since the 1970s.</p> <p>In contrast, the heyday of the provincial New Democrats in the 1970s and 80s was quite geographically contained. They were popular in immigrant-heavy ridings along the western edge of inner-city Toronto – around the Humber River, from Parkdale to Davenport to Black Creek – where they succeeded with certain kinds of immigrants. But they failed to make inroads into more typically non-white suburban immigrant communities. Save fleeting success in Brampton in the 2010s, they've had little luck.</p> <p>And it's in these suburban, non-white, and immigrant-heavy ridings that the provincial Conservatives have seen their greatest successes. Some of the biggest gains in 2018 were in Markham and North Scarborough, which they've maintained since. These ridings are home to mostly East Asian visible minorities, who the provincial Conservatives made a <a href="https://briarpatchmagazine.com/articles/view/organizing-the-suburbs" target="_blank">concerted effort to</a> access through ethnic churches, media, and socially conservative issues</p><p>Moreover, while they failed to sweep Brampton and North Mississauga in 2018, both elections since – in 2022 and 2025 – saw the Conservatives flip these ridings and continue to grow their margins. This suggests growing inroads with South Asian visible minorities, who dominate the region.</p></div> <div class="text"><h2>Do parties over-perform in the most immigrant-heavy ridings?</h2> <p>Correlation and geography shed a lot of light on what is happening, and where. How much better or worse do parties perform in the most immigrant-heavy ridings, compared to elsewhere? Basically, when most people in a riding are immigrants, do we see the same trends and political preferences?</p></div> <div class="container"><!></div> <div class="text"><p>More or less, the answer is yes – we see the same broad trends. The federal Liberals still have the greatest leads, the provincial New Democrats still made inroads in the 1970s and 1980s before declining in recent years, and the rise of the Conservatives in the last decade - especially at the provincial level - is without dispute.</p> <p>But it's between the cracks of these big conclusions that we get the nuances of what is happening, when, and how much. Even by 2014, ahead of their breakthrough, provincial Conservatives had begun doing better in immigrant-heavy ridings compared to the rest of the GTA, indicating that a foundation had already been laid.</p> <p>Likewise, the federal Liberals not only continue to win over immigrants but in the most immigrant-heavy ridings, have consistently done better than their national vote share by 20% or 30% – showing just how deep immigrant loyalties lie – while the New Democrats’ decline may trace back as far as the 1980s.</p> <p>It also tells us what we don't know. We've looked at immigrants as a whole, but not at how different kinds of immigrants – varying by ethnicity, class, geography, and so on – participate (or do not or cannot participate electorally, either through turnout or voting restrictions).</p> <p>At about half of the population of the region, and a quarter of the country, immigrants are a major political constituency and a key part of the path to power for political parties. They form and lose loyalties to different parties at different times, and while these changes may feel like sudden shocks in the moment, by taking a step back we see competing long-term trends and political battles playing out over many years – just like any other group, immigrants are not a monolith.</p></div> <div class="text"><br> <br> <div class="footnotes"><h3>Data & Methods</h3> <p>We obtained federal election results from <a href="https://github.com/Lucas-Czarnecki/Canadian-Federal-Elections/tree/main" target="_blank">Lucas Czarnecki's database</a>, sourced from Canada's Library of Parliament (LoP), and Ontario election results from <a href="https://www.elections.on.ca/en/resource-centre/elections-results.html" target="_blank">Elections Ontario</a>.</p> <p>For consistency, we focused on the three major parties in Anglo-Canada – the <a href="https://en.wikipedia.org/wiki/Liberal_Party_of_Canada" target="_blank">Liberals</a>, <a href="https://en.wikipedia.org/wiki/New_Democratic_Party" target="_blank">New Democrats</a>, and Conservatives – while grouping all other parties under "Other". The label "Conservatives" refers to the dominant center-right/right-wing party in each context: the <a href="https://en.wikipedia.org/wiki/Progressive_Conservative_Party_of_Ontario" target="_blank">Progressive Conservatives in Ontario</a>, the <a href="https://en.wikipedia.org/wiki/Progressive_Conservative_Party_of_Canada" target="_blank">federal Progressive Conservatives</a> (until 2004), and the <a href="https://en.wikipedia.org/wiki/Conservative_Party_of_Canada" target="_blank">Conservative Party of Canada</a> (from 2004 onward). The only exception was including the <a href="https://en.wikipedia.org/wiki/Reform_Party_of_Canada" target="_blank">Reform</a>/<a href="https://en.wikipedia.org/wiki/Canadian_Alliance" target="_blank">Alliance</a> parties in the three federal elections they contested (1993, 1997, and 2000).<!></p> <p>Census data was drawn from <a href="https://observatory.uwo.ca/unicen/index.html" target="_blank">UNI-CEN</a>, where we used census tract-level statistics starting in 1961. Immigration data is available from 1961 onward, household income from 1971 onward, and visible minority demographics from 2001 onward.</p> <p>Because historical electoral ridings lack direct census data, we estimated statistics using areal interpolation. We calculated relevant statistics by aggregating all census tracts fully or partially within each riding (using these <a href="https://github.com/schoolofcities/gta-immigration/blob/main/analysis/get_ed_ct_coverage_gta.ipynb" target="_blank">two</a> <a href="https://github.com/schoolofcities/gta-immigration/blob/main/analysis/get_ed_ct_stats_gta.ipynb" target="_blank">scripts</a>), weighting partial overlaps by their proportional area.</p> <p>The maps displayed and used for interpolation came from <a href="https://observatory.uwo.ca/unicen/index.html" target="_blank">UNI-CEN</a> (federal ridings and census tracts) and <a href="http://election-atlas.ca" target="_blank">election-atlas.ca</a> (Ontario ridings). We included only ridings where at least 75% of the area was covered by census tracts and 50% fell within the Greater Toronto Area.</p> <p>The final dataset is <a href="https://github.com/schoolofcities/gta-immigration/tree/main/static/data/elections" target="_blank">available here</a>, and all code for this project is in the <a href="https://github.com/schoolofcities/gta-immigration/tree/main" target="_blank">GitHub repository</a>.</p></div></div> <div class="text"><div class="footnotes"><h3>Footnotes</h3> <!></div></div></main>`);function L_(H,ae){ls(ae,!1);function oe(Kt){return Kt.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(?!\*)(.+?)\*/g,"<em>$1</em>").replace(/\[([^\]]+)]\(([^)]+)\)/g,'<a href="$2">$1</a>')}let he=[];function Ee(Kt){const Wt=he.length+1,Ge=oe(Kt);return he.push({id:Wt,text:Ge}),Wt}const Ae=[`See, for example, Brian K. Ray, Greg Halseth, and Benjamin Johnson, "The Changing 'Face' of the Suburbs: Issues of Ethnicity and Residential Change in Suburban Vancouver", *International Journal of Urban and Regional Research* 21, no. 1 (1997), 75-99, [https://doi.org/10.1111/1468-2427.00059](https://doi.org/10.1111/1468-2427.00059); Harald Bauder and Bob Sharpe, "Residential segregation of visible minorities in Canada's gateway cities", *The Canadian Geographer* 46, no. 3 (2002), 204-222, [https://doi.org/10.1111/j.1541-0064.2002.tb00741.x](https://doi.org/10.1111/j.1541-0064.2002.tb00741.x); Robert Murdie and Carlos Teixeira, "Towards a Comfortable Neighbourhood and Appropriate Housing: Immigrant Experiences in Toronto", ed. Paul Anisef and Michael Lanphier (eds.) *The World in a City* (University of Toronto Press, 2003); Virpal Kataure and Margaret Walton-Roberts "The housing preferences and location choices of second-generation South Asians living in ethnic enclaves", *South Asian Diaspora* 5, no. 1 (2013), 57-76, [https://doi.org/10.1080/19438192.2013.722385](https://doi.org/10.1080/19438192.2013.722385); Shuguang Wang and Jason Zhong, "Delineating Ethnoburbs in Metropolitan Toronto", CERIS Working Paper No. 100 (2013); Mireille Vézina and René Houle, "Settlement patterns and social integration of the population with an immigrant background in the Montréal, Toronto and Vancouver metropolitan areas", Statistics Canada Ethnicity, Language and Immigration Thematic Series (2017), Catalogue no. 89-657-X2016002`,'Lucia Lo, Amer Shalaby, and Baha Alshalalfah, "Relationship between Immigrant Settlement Patterns and Transit Use in the Greater Toronto Area", *Journal of Urban Planning and Development*, 137, no. 4 (2011), 470-476, [https://doi.org/10.1061/(ASCE)UP.1943-5444.0000080](https://shorturl.at/4t0DV)','Triadafilos Triadafilopoulos, "Dismantling White Canada: Race, Rights, and the Origins of the Points System", in *Wanted and Welcome? Policies for Highly Skilled Immigrants in Comparative Perspective*, ed. Triadafilos Triadafilopoulos (Springer, 2013), 15-37',`See Erin Tolley, "Political Players or Partisan Pawns? Immigrants, Minorities, and Conservatives in Canada", in *The Blueprint: Conservative parties and their impact on Canadian politics*, ed. J.P. Lewis and Joanna Everitt (University of Toronto Press, 2017), 101; and Zack Taylor, "The Political Geography of Immigration: Party Competition for Immigrants' Votes in Canada, 1997–2019", *American Review of Canadian Studies* 51 no. 1(2021), 18-40, [https://doi.org/10.1080/02722011.2021.1874732](https://doi.org/10.1080/02722011.2021.1874732); Tolley, 2017`,'Fidan Elcioglu, "I Began to Think More Like a Canadian: How Second-Generation South Asian and Chinese Canadians Confront Racism by Becoming Conservative Voters," *Ethnic and Racial Studies* (2025): 1–20, [https://doi.org/10.1080/01419870.2025.2474628](https://doi.org/10.1080/01419870.2025.2474628)'];qm();var I=b_();Gm(Kt=>{var Wt=v_();Nm.title="Changes in immigrant voting patterns in the Greater Toronto Area | School of Cities",dr(26),Ft(Kt,Wt)});var c=Xe(I);$m(c,{});var ke=vt(c,6);yg(ke,{});var He=vt(ke,2),je=Xe(He),Qe=vt(Xe(je));const Pe=_o(()=>Ee(Ae[0]));xo(Qe,{get id(){return te(Pe)}});var Y=vt(Qe,2);const Be=_o(()=>Ee(Ae[1]));xo(Y,{get id(){return te(Be)}});var st=vt(Y,4);const et=_o(()=>Ee(Ae[2]));xo(st,{get id(){return te(et)}}),Ne(je),dr(2),Ne(He);var $e=vt(He,4),pt=Xe($e);p_(pt,{}),Ne($e);var jt=vt($e,2),Ze=Xe(jt),wt=vt(Xe(Ze));const tt=_o(()=>Ee(Ae[3]));xo(wt,{get id(){return te(tt)}}),dr(),Ne(Ze);var Ue=vt(Ze,10),xt=vt(Xe(Ue));const Dt=_o(()=>Ee(Ae[4]));xo(xt,{get id(){return te(Dt)}}),dr(),Ne(Ue),dr(12),Ne(jt);var Bt=vt(jt,2),Rt=Xe(Bt);h_(Rt,{}),Ne(Bt);var bt=vt(Bt,4);Yg(bt,{});var kt=vt(bt,6),gt=Xe(kt);__(gt,{}),Ne(kt);var Vt=vt(kt,4),Mt=vt(Xe(Vt),4),ai=vt(Xe(Mt),4),Li=vt(Xe(ai),15);const Tt=_o(()=>Ee("They would go on to merge with the federal Progressive Conservative party to form the Conservative Party of Canada in 2003."));xo(Li,{get id(){return te(Tt)}}),Ne(ai),dr(8),Ne(Mt),Ne(Vt);var Qt=vt(Vt,2),Ti=Xe(Qt),ei=vt(Xe(Ti),2);na(ei,1,()=>he,Kt=>Kt.id,(Kt,Wt)=>{var Ge=x_(),lt=Xe(Ge),St=Xe(lt,!0);Ne(lt);var Zt=vt(lt,2),ti=Xe(Zt);Km(ti,()=>te(Wt).text),Ne(Zt);var _r=vt(Zt,2);Ne(Ge),wi(()=>{Tn(Ge,"id",`footnote-${te(Wt).id}`),vi(St,te(Wt).id),Tn(_r,"href",`#footnote-ref-${te(Wt).id}`)}),Ap("click",_r,Fp(()=>{const xi=document.getElementById(`footnote-ref-${te(Wt).id}`),li=-100;if(xi){const Fi=xi.getBoundingClientRect().top+window.pageYOffset+li;window.scrollTo({top:Fi,behavior:"auto"})}})),Ft(Kt,Ge)}),Ne(Ti),Ne(Qt),Ne(I),Ft(H,I),cs()}export{L_ as component,R_ as universal};
